<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MapStruct 使用手册（更新中） | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MapStruct 是一个代码生成器，它基于约定而非配置的方法，极大地简化了 Java Bean 之间的转换。">
<meta property="og:type" content="article">
<meta property="og:title" content="MapStruct 使用手册（更新中）">
<meta property="og:url" content="https://mofan212.github.io/posts/MapStruct-User-Manual/index.html">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="MapStruct 是一个代码生成器，它基于约定而非配置的方法，极大地简化了 Java Bean 之间的转换。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/82.png">
<meta property="article:published_time" content="2021-02-15T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-03T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="MapStruct">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/82.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MapStruct 使用手册（更新中）",
  "url": "https://mofan212.github.io/posts/MapStruct-User-Manual/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/82.png",
  "datePublished": "2021-02-15T16:00:00.000Z",
  "dateModified": "2023-03-03T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/MapStruct-User-Manual/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://fastly.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MapStruct 使用手册（更新中）',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://cdn.staticfile.net/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css" /><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://fastly.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">156</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a><a class="nav-page-title" href="/"><span class="site-name">MapStruct 使用手册（更新中）</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">MapStruct 使用手册（更新中）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-02-15T16:00:00.000Z" title="发表于 2021-02-16 00:00:00">2021-02-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-03T16:00:00.000Z" title="更新于 2023-03-04 00:00:00">2023-03-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">21.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>87分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2023-03-04 00:00:00&quot;}" hidden></div><p>封面来源：本文封面来源于 MapStruct 官网，如有侵权，请联系删除。</p>
<p>源码仓库：<a target="_blank" rel="noopener" href="https://github.com/mofan212/mapstruct-demo">mofan212/mapstruct-demo</a></p>
<h1 id="0-阅读前言"><a class="header-anchor" href="#0-阅读前言"></a>0. 阅读前言</h1>
<p>本文内容基于 MapStruct 官方文档进行翻译并拓展，力求保证文章准确性，但博主英语水平堪忧，在某些处理上仍有很多不足，还望各位看官不吝赐教。</p>
<p><mark>翻译工作极其耗时，本文禁止转载！</mark> 🙏</p>
<blockquote>
<p>官网与推荐</p>
</blockquote>
<p>MapStruct 官网：<a target="_blank" rel="noopener" href="https://mapstruct.org/">MapStruct</a></p>
<p>MapStruct 官方文档：<a target="_blank" rel="noopener" href="https://mapstruct.org/documentation/reference-guide/">Reference Guide</a></p>
<p>不错的 MapStruct 博客系列：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/DDgougou/articles/12848625.html">属性映射工具——MapStruct（一）</a></p>
<h1 id="1-MapStruct-概述"><a class="header-anchor" href="#1-MapStruct-概述"></a>1. MapStruct 概述</h1>
<h2 id="1-1-什么是-MapStruct"><a class="header-anchor" href="#1-1-什么是-MapStruct"></a>1.1 什么是 MapStruct</h2>
<p>MapStruct 是一个Java注释处理器，用于生成类型安全的、高性能的、无依赖的 Bean 映射类。</p>
<p>在实际开发中经常会将各种对象相互转换，比如 DTO 转 BO，DTO 转 VO 等等，最简单的做法就是 <code>new</code> 对象，然后对属性值进行一个个地 GET/SET，但这样既繁琐又无聊。</p>
<p>如果有一个专门用来解决转换问题的工具就很棒了，MapStruct 就是这样的一个属性映射工具，只需要定义一个 Mapper 接口，MapStruct 就会自动实现这个映射接口，避免了复杂繁琐的映射实现。</p>
<blockquote>
<p>补充与拓展</p>
</blockquote>
<p>关于 Java 中的各种 O，可以参考下面这两篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq784515681/article/details/83088089">java中各种O的含义(PO，DO，VO，TO，QO，BO，DAO，DTO，POJO)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wzdnwyyu/p/11163058.html">浅析DTO、VO、DO、PO的概念</a></p>
<h2 id="1-2-MapStruct-配置选项"><a class="header-anchor" href="#1-2-MapStruct-配置选项"></a>1.2 MapStruct 配置选项</h2>
<p>MapStruct 代码生成器可以使用注释处理器选项进行配置。</p>
<p>在直接调用 javac 时，这些选项以 <code>-Akey = value</code> 的形式传递给编译器。 通过 Maven 使用 MapStruct 时，任何处理器选项都可以在 Maven 处理器插件的配置中使用 <code>compilerArgs</code> 传递，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- due to problem in maven-compiler-plugin, for verbose mode add showWarnings --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">showWarnings</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWarnings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span></span><br><span class="line">                -Amapstruct.suppressGeneratorTimestamp=true</span><br><span class="line">            <span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span></span><br><span class="line">                -Amapstruct.suppressGeneratorVersionInfoComment=true</span><br><span class="line">            <span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span></span><br><span class="line">                -Amapstruct.verbose=true</span><br><span class="line">            <span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>关于存在的选项，可以参看官方文档 <a target="_blank" rel="noopener" href="https://mapstruct.org/documentation/stable/reference/html/#configuration-options">Configuration options</a>，本文会在使用到的地方再具体讲解。</p>
<h1 id="2-定义映射器"><a class="header-anchor" href="#2-定义映射器"></a>2. 定义映射器</h1>
<h2 id="2-1-Hello-MapStruct"><a class="header-anchor" href="#2-1-Hello-MapStruct"></a>2.1 Hello MapStruct</h2>
<p>创建一个 Maven 项目，在 <code>pom.xml</code> 文件中添加以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">org.mapstruct.version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">org.mapstruct.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span> <span class="comment">&lt;!-- depending on your project --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span> <span class="comment">&lt;!-- depending on your project --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--使用 Lombok 后，这里也要添加--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- other annotation processors --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><mark>注意：</mark> Maven 插件要使用 3.6.0 版本及以上、Lombok 使用 1.16.16 版本及以上。不然就会出现以下错误：</p>
<pre>
java: No property named "numberOfSeats" exists in source parameter(s). Did you mean "null"?
</pre>
<p>如果 Lombok 版本为 1.18.16 及以上，请再添加上：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok-mapstruct-binding<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<p>创建一个 <code>Car</code> 实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String make;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numberOfSeats;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再创建一个 <code>CarDto</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CarDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String make;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> seatCount;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还需要创建一个接口，用于对实体进行转换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CarMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(CarMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 Car 转换成 CarDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> car Car 实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>    对应的 DTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;numberOfSeats&quot;, target = &quot;seatCount&quot;)</span></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后创建测试类测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CarMapperTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldMapCarToDto</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// given</span></span><br><span class="line">        <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>( <span class="string">&quot;Morris&quot;</span>, <span class="number">5</span>,  <span class="string">&quot;Sedan&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// when</span></span><br><span class="line">        <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> CarMapper.INSTANCE.carToCarDto(car);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// then</span></span><br><span class="line">        assertNotNull(carDto);</span><br><span class="line">        assertEquals(<span class="string">&quot;Morris&quot;</span>, carDto.getMake());</span><br><span class="line">        assertEquals(<span class="number">5</span>, carDto.getSeatCount());</span><br><span class="line">        assertEquals(<span class="string">&quot;Sedan&quot;</span>, carDto.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法，测试通过！ 🎉</p>
<blockquote>
<p>为什么写一个接口后就能够帮我们实现实体的转换呢？</p>
</blockquote>
<p>其实 Java 实体映射工具有两种：</p>
<p>1、在运行期，使用反射调用 Setter/Getter 方法或者是直接对成员变量赋值，这种方式通过 <code>invoke()</code> 执行赋值。一般会使用 Beanutil、Javassist 等开源库进行实现，代表产品有 Dozer 和 ModelMaper。</p>
<p>2、在编译期，动态生成含有逐一赋值的 <code>class</code> 文件 ，在运行时直接调用该 <code>class</code> 文件，这类的代表有 MapStruct、Selma、Orika。</p>
<p>如果不使用任何类库，手动实现实体的转换，可以使用反射（对应第一种方式），也可以对调用每个属性的 Get/Set 方法进行赋值（对应第二种方式）。</p>
<p>还是有点懵？</p>
<p>查看刚刚项目的 target 目录，可以看到：</p>
<p><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E7%94%9F%E6%88%90%E7%9A%84CarMapperImpl%E5%AE%9E%E7%8E%B0%E7%B1%BB.png" alt="生成的CarMapperImpl实现类"></p>
<p>自动生成了 <code>CarMapperImpl</code> 实现类，其内部仍然使用的是逐一复制的方式，只不过不用手动去写了。</p>
<p>正因如此，原实体和目标实体最好都编写各属性对应的 Getter 和 Setter 方法，以及它们各自的无参构造器。除此之外，别瞎使用 Lombok 中的 <code>@Accessors</code> 注解。</p>
<p>由于这个 class 文件是在编译期生成的，相比使用反射来实现实体映射，这种方式的效率更高。</p>
<p>更多 Bean 映射工具的性能对比，可以参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/javaguide/p/11861749.html">5种常见Bean映射工具的性能比对</a></p>
<p><mark>注意：</mark> 由于这些实现类会在编译期生成并存放在 target 目录中，因此当更改实体信息或映射逻辑时，需要重新编译或删除 target 目录再执行程序，否则更改可能不会生效。</p>
<blockquote>
<p>注解介绍</p>
</blockquote>
<p>在上述 Demo 中，使用到两个注解：</p>
<p><code>@Mapper</code>：作用于接口上，告诉 MapStruct 需要编译期生成哪个接口的实现类。</p>
<p>在生成的实现类中，当原实体的属性与其目标实体对应的属性名称 <strong>相同</strong> 时，就直接被 <strong>隐式映射</strong>。如果名称不一样，就需要使用到 <code>@Mapping</code> 注解。</p>
<p><code>@Mapping</code>：常作用于方法上，用于原实体与目标实体属性名称不相同时指定映射关系。</p>
<h2 id="2-2-关闭隐式映射"><a class="header-anchor" href="#2-2-关闭隐式映射"></a>2.2 关闭隐式映射</h2>
<p>MapStruct 存在默认的隐式映射，也可以关闭它，只需在接口对应的方法上添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BeanMapping(ignoreByDefault = true)</span></span><br></pre></td></tr></table></figure>
<p>还是针对最开始的 Demo，在接口中的唯一方法上添加这个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BeanMapping(ignoreByDefault = true)</span></span><br><span class="line"><span class="meta">@Mapping(source = &quot;numberOfSeats&quot;, target = &quot;seatCount&quot;)</span></span><br><span class="line"><span class="meta">@Mapping(source = &quot;make&quot;, target = &quot;make&quot;)</span></span><br><span class="line">CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br></pre></td></tr></table></figure>
<p>在修改一下测试方法，查看打印结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBeanMapping</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>( <span class="string">&quot;Morris&quot;</span>, <span class="number">5</span>,  <span class="string">&quot;Sedan&quot;</span>);</span><br><span class="line">    <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> CarMapper.INSTANCE.carToCarDto(car);</span><br><span class="line">    System.out.println(carDto.getMake());</span><br><span class="line">    System.out.println(carDto.getSeatCount());</span><br><span class="line">    System.out.println(carDto.getType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
Morris
5
null
</pre>
<p>由于没有使用 <code>@Mapping</code> 注解为 <code>type</code> 指定映射关系，因此 <code>type</code> 的属性值是 <code>null</code>。</p>
<p>但一般来说，没人会闲着没事把隐式映射关闭。🤨</p>
<h2 id="2-3-Mapping-注解"><a class="header-anchor" href="#2-3-Mapping-注解"></a>2.3 @Mapping 注解</h2>
<p><code>@Mapping</code> 注解常作用于方法上，其实它也可以作用于注解之上，允许 <code>@Mapping</code> 用于其他（用户自定义的）注释以实现重用。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>新建 <code>UserInfo</code> 实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line">    <span class="keyword">private</span> String dept;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再新建 <code>StudentDto</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String department;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要实现 <code>UserInfo</code> 向 <code>StudentDto</code> 转换。</p>
<p>再创建一个 <code>FromUserInfo</code> 注解，在这个注解之上使用 <code>@Mapping</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="meta">@Mapping(target = &quot;id&quot;, ignore = true)</span></span><br><span class="line"><span class="meta">@Mapping(target = &quot;createTime&quot;, expression = &quot;java(new java.util.Date())&quot;)</span></span><br><span class="line"><span class="meta">@Mapping(source = &quot;dept&quot;, target = &quot;department&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FromUserInfo &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建 <code>UserInfoMapper</code> 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserInfoMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">UserInfoMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(UserInfoMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换为 StudentDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo userInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> StudentDto 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@FromUserInfo</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;pwd&quot;, target = &quot;password&quot;)</span></span><br><span class="line">    StudentDto <span class="title function_">toStudent</span><span class="params">(UserInfo userInfo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后来个测试类测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoMapperTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToStudent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;mofan&quot;</span>, <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">                <span class="comment">// 2020-11-02 21:54:29</span></span><br><span class="line">                <span class="string">&quot;开发部&quot;</span>, <span class="number">19</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1604325269401L</span>));</span><br><span class="line">        <span class="type">StudentDto</span> <span class="variable">studentDto</span> <span class="operator">=</span> UserInfoMapper.INSTANCE.toStudent(userInfo);</span><br><span class="line"></span><br><span class="line">        System.out.println(studentDto.getId());</span><br><span class="line">        System.out.println(studentDto.getUsername());</span><br><span class="line">        System.out.println(studentDto.getPassword());</span><br><span class="line">        System.out.println(studentDto.getDepartment());</span><br><span class="line">        System.out.println(studentDto.getAge());</span><br><span class="line">        System.out.println(studentDto.getCreateTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试类后，控制台输出：</p>
<pre>
null
mofan
123456
开发部
19
Tue Feb 02 18:33:11 CST 2021
</pre>
<blockquote>
<p><code>@Mapping</code> 属性讲解</p>
</blockquote>
<p>上述案例中又使用了 <code>@Mapping</code> 注解的两个属性：<code>ignore</code> 和 <code>expression</code>。</p>
<p>在实体转换时，如果不想让某个属性值从源实体赋值到新实体，可以使用 <code>@Mapping</code> 注解的 <code>target</code> 指定新实体中不想被赋值的属性，同时将 <code>ignore</code> 设置为 <code>true</code>。</p>
<p><code>expression</code> 的含义就是表达式，使用这个属性，可以为新实体中某个属性指定成表达式设置的值。表达式格式为：<code>java(&lt;EXPRESSION&gt;)</code>，其实就是一句 Java 代码。比如想让 username 字段设置为 <strong>默烦</strong>，可以这些写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapping(target = &quot;username&quot;, expression = &quot;java(\&quot;默烦\&quot;)&quot;)</span></span><br></pre></td></tr></table></figure>
<p><mark>需要注意的是：</mark> <code>source</code> 属性和 <code>expression</code> 属性不能同时存在。使用 <code>expression</code> 时，其值的 Java 代码所使用的类最好使用全类名，但如果这个 Java 代码会抛异常就不要使用 <code>expression</code> 了，而是需要自定义方法并在 <code>qualifyByName</code> 中引用。</p>
<p>像上述案例中，<code>createTime</code> 的值是指 <code>2020-11-02 21:54:29</code>，为其指定表达式后，原本的值发生了改变。</p>
<p>如果仔细观察，还能发现 MapStruct 会对数据进行自动转换。比如在原实体中的 age 属性是 <code>Integer</code> 类型的，而 目标实体中的 age 属性是 <code>String</code> 类型的，即便如此，仍然能够映射成功。 👍</p>
<blockquote>
<p>@Mapping 其他属性</p>
</blockquote>
<p><code>@Mapping</code> 注解还有其他的属性：</p>
<ol>
<li>dateFormat：原属性是 <code>Date</code>，转化为 <code>String</code></li>
<li>numberFormat：数值类型与 <code>String</code> 类型之间的转化</li>
<li>constant：不管源属性值，直接将目标属性设置为指定的常量</li>
<li>qualifiedByName：根据自定义的方法进行赋值</li>
<li>defaultValue：默认值。如果原属性值为 <code>null</code>，那么设置目标属性值为指定的默认值</li>
</ol>
<blockquote>
<p>这种方式有什么用？</p>
</blockquote>
<p>如果有若干个 DTO 都由同一实体转换而来，这些 DTO 有些属性名称是相同的，但有些又不一样，那么我们就可以编写一个注解，在这个注解上使用 <code>@Mapping</code> 注解，以减少重复代码。</p>
<p>使用 <code>@Mapping</code> 注解作用与其他注解上并使用其他注解时，可以让若干个 DTO 都具备相同的特性。在官网上称这种观点为 “duck-typing”（鸭子类型），当一个东西叫声像鸭子，走路像鸭子，还会游泳，那么它很有可能就是鸭子 🦆。简单来说就是特性决定了类型，而不是类型决定了特性。鸭子类型在动态语言中经常使用，比如 Python，这使得 Python 不像 Java 那样专门去弄一大堆的设计模式。🤪</p>
<p>好了，说远了，回到 MapStruct 上。</p>
<p>但是官网又说，这个功能尚不成熟，用户应当谨慎使用，尤其是在不确定何时始终存在属性时：</p>
<pre>
the method on which the problem occurs is displayed, as well as the concerned values in the @Mapping annotation. However, the composition aspect is not visible.
</pre>
<h2 id="2-4-默认方法与抽象类"><a class="header-anchor" href="#2-4-默认方法与抽象类"></a>2.4 默认方法与抽象类</h2>
<p>在 JDK 8 及其更高的版本中，接口中也可以有方法的实现，但是这些方法必须被 <code>static</code> 或 <code>default</code> 关键词修饰。</p>
<p>使用 MapStruct 可以实现简单类型的映射，但是没办法完成一些带有逻辑的映射。比如在原实体中有一个名为 <code>age</code> 的属性，在映射到新实体时，想让 <code>age</code> 的值加一，这对于 MapStruct 来说是无法做到的。</p>
<p>此时可以在接口中定义默认方法，只要参数是原实体类型，返回值是新实体类型，那么使用 MapStruct 生成接口的实现类时将调用这个默认方法。</p>
<p><strong>除此之外，还可以使用抽象类来定义映射器，而不仅仅是接口。</strong> 在这种情况下，MapStruct 会生成抽象类的子类，并实现所有的抽象方法。而对于非抽象方法来说，只要参数和返回值类型匹配，MapStruct 也会子类中调用这些方法。与声明默认方法相比，使用抽象类来定义映射器可以在映射器类中声明额外的字段。</p>
<h2 id="2-5-多个源参数"><a class="header-anchor" href="#2-5-多个源参数"></a>2.5 多个源参数</h2>
<p><strong>MapStruct 支持带有多个源参数的映射方法。</strong> 比如，可以将实体 A 中的部分属性值和实体 B 中的部分属性值映射到同一 DTO 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddressMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Mapping(source = &quot;person.description&quot;, target = &quot;description&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;address.houseNo&quot;, target = &quot;houseNumber&quot;)</span></span><br><span class="line">    DeliveryAddressDto <span class="title function_">personAndAddressToDeliveryAddressDto</span><span class="params">(Person person, Address address)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与单参数映射方法一样，属性是按名称映射的。</p>
<p>如果多个源参数中定义了具有相同名称的属性，那么必须使用 <code>@Mapping</code> 注释来指定要从哪个源参数中的同名属性映射到目标实体，否则就会报错。对于仅在给定源参数中出现一次的属性，由于 <strong>隐式映射</strong> 的关系，因此可以选择性地指定名称。</p>
<p><mark>注意：</mark> 具有多个源参数的映射方法将在 <strong>所有</strong> 源参数为空的情况下才返回 <code>null</code>。否则，目标实体将被实例化，同时将所有来自所提供参数的属性值映射到目标实体中。</p>
<p><strong>MapStruct 还支持直接引用源参数。</strong> 比如源参数中有一个 <code>Integer</code> 类型的参数，可以直接将这个参数映射到目标实体中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddressMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Mapping(source = &quot;person.description&quot;, target = &quot;description&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;hn&quot;, target = &quot;houseNumber&quot;)</span></span><br><span class="line">    DeliveryAddressDto <span class="title function_">personAndAddressToDeliveryAddressDto</span><span class="params">(Person person, Integer hn)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-多个嵌套属性映射"><a class="header-anchor" href="#2-6-多个嵌套属性映射"></a>2.6 多个嵌套属性映射</h2>
<p>如果在实体 A 中存在某一属性 B，其类型是一个实体，现在想将实体 A 中的 B 对象映射到某一不含任何复杂对象类型属性的 DTO 中，那么需要取出属性 B 的各个属性进行一一映射。</p>
<p>如果实体 A 存在多个复杂对象类型的属性，依次进行映射会十分繁琐。</p>
<p>MapStruct 支持使用 <code>.</code> 作为 <code>@Mapping</code> 注释中 <code>target</code> 的属性值。这告诉 MapStruct 将原实体中所有复杂对象类型的属性中的所有属性映射到目标实体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CustomerMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Mapping(target = &quot;name&quot;, source = &quot;record.name&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;.&quot;, source = &quot;record&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;.&quot;, source = &quot;account&quot;)</span></span><br><span class="line">    Customer <span class="title function_">customerDtoToCustomer</span><span class="params">(CustomerDto customerDto)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码将 <code>customerDto</code> 对象中的 <code>record</code> 对象和 <code>account</code> 对象的各个属性都映射到目标实体中，但由于 <code>record</code> 和 <code>account</code> 都有 <code>name</code> 属性，因此需要显式指定以消除歧义。</p>
<h2 id="2-7-更新存在的实例"><a class="header-anchor" href="#2-7-更新存在的实例"></a>2.7 更新存在的实例</h2>
<p>在某些情况下，可能并不需要创建一个新的目标实体，而是更新一个现有的实例，这个时候就需要用到 <code>@MappingTarget</code> 注解。</p>
<p>简单来说：一个原实体 A 的属性数量比目标实体 B 少，因此将 A 映射为 B 时，B 中有些属性值会是空。B 中的这些属性是存在于实体 C 中的，那么可以使用 C 来更新 B。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>原实体 <code>UserInfo</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line">    <span class="keyword">private</span> String dept;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目标对象 <code>TeacherDto</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeacherDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String department;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer sex;</span><br><span class="line">    <span class="keyword">private</span> String idCardNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一实体 <code>PersonInfo</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">    <span class="keyword">private</span> String idCardNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换接口中的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换为 TeacherDto --&gt; 缺少部分属性值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userInfo userInfo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> TeacherDto 实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapping(source = &quot;pwd&quot;, target = &quot;password&quot;)</span></span><br><span class="line"><span class="meta">@Mapping(source = &quot;dept&quot;, target = &quot;department&quot;)</span></span><br><span class="line">TeacherDto <span class="title function_">toTeacherDto</span><span class="params">(UserInfo userInfo)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新 TeacherDto 实例 --&gt; 补充缺少的属性值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> personInfo personInfo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> teacherDto teacherDto</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapping(source = &quot;gender&quot;, target = &quot;sex&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">updateTeacherDto</span><span class="params">(PersonInfo personInfo, <span class="meta">@MappingTarget</span> TeacherDto teacherDto)</span>;</span><br></pre></td></tr></table></figure>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToTeacherDto</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;mofan&quot;</span>, <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">            <span class="comment">// 2020-11-02 21:54:29</span></span><br><span class="line">            <span class="string">&quot;开发部&quot;</span>, <span class="number">19</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1604325269401L</span>));</span><br><span class="line">    <span class="type">TeacherDto</span> <span class="variable">teacherDto</span> <span class="operator">=</span> UserInfoMapper.INSTANCE.toTeacherDto(userInfo);</span><br><span class="line">    assertEquals(<span class="string">&quot;123456&quot;</span>, teacherDto.getPassword());</span><br><span class="line">    assertNull(teacherDto.getFirstName());</span><br><span class="line"></span><br><span class="line">    <span class="type">PersonInfo</span> <span class="variable">personInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PersonInfo</span>();</span><br><span class="line">    personInfo.setFirstName(<span class="string">&quot;默&quot;</span>);</span><br><span class="line">    personInfo.setLastName(<span class="string">&quot;烦&quot;</span>);</span><br><span class="line">    personInfo.setGender(<span class="number">1</span>);</span><br><span class="line">    personInfo.setIdCardNum(<span class="string">&quot;123456788914725896&quot;</span>);</span><br><span class="line">    UserInfoMapper.INSTANCE.updateTeacherDto(personInfo, teacherDto);</span><br><span class="line">    assertEquals(<span class="string">&quot;默&quot;</span>, teacherDto.getFirstName());</span><br><span class="line">    assertEquals(<span class="number">1</span>, teacherDto.getSex().intValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在更新实例时，如果存在字段名不一样的情况，仍然可以使用 <code>@Mapping</code> 注解进行指定。</p>
<p>在更新对象的方法中，除了使用 <code>void</code> 作为返回值外，还可以使用目标参数类型作为返回值，这表示在更新目标参数后又返回它。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapping(source = &quot;gender&quot;, target = &quot;sex&quot;)</span></span><br><span class="line">TeacherDto <span class="title function_">updateTeacherDto</span><span class="params">(PersonInfo personInfo, <span class="meta">@MappingTarget</span> TeacherDto teacherDto)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="2-8-反向映射"><a class="header-anchor" href="#2-8-反向映射"></a>2.8 反向映射</h2>
<p>上述实例中，都是用实体转换为 DTO，那么怎么将 DTO 转换回实体呢？</p>
<p>当然可以使用 <code>@Mapping</code> 注解一一指定，但这样也太麻烦了，有没有什么简单的方法呢？</p>
<p>MapStruct 提供了一个名为 <code>@InheritInverseConfiguration</code> 的注解用于反向映射。该注解只有一个属性<code>name</code>，表示原映射名，即原映射方法名。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>新实体 <code>PeopleInfo</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PeopleInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Double weight;</span><br><span class="line">    <span class="keyword">private</span> String bloodType;</span><br><span class="line">    <span class="keyword">private</span> GenderEnum gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打工人 <code>WorkerDto</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkerDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String createTime;</span><br><span class="line">    <span class="keyword">private</span> String weight;</span><br><span class="line">    <span class="keyword">private</span> String bloodType;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个用于转换实体的接口 <code>PeopleInfoMapper</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PeopleInfoMapper</span> &#123;</span><br><span class="line">    <span class="type">PeopleInfoMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(PeopleInfoMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 PeopleInfo 转换为 WorkerDto</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> peopleInfo peopleInfo实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> WorkerDto</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mappings(&#123;</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;name&quot;, defaultValue = &quot;默烦&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;age&quot;, expression = &quot;java(java.lang.Integer.valueOf(peopleInfo.getAge()) + 1)&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;createTime&quot;, dateFormat = &quot;yyyy-MM-dd&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;weight&quot;, numberFormat = &quot;0.00&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;bloodType&quot;, constant = &quot;A 型血&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(source = &quot;gender&quot;, target = &quot;gender&quot;, qualifiedByName = &quot;getGenderEnumCode&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    WorkerDto <span class="title function_">toWorkerDto</span><span class="params">(PeopleInfo peopleInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 DTO 转换为实体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workerDto workerDto 实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> PeopleInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@InheritInverseConfiguration(name = &quot;toWorkerDto&quot;)</span></span><br><span class="line">    <span class="meta">@Mappings(&#123;</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;age&quot;, expression = &quot;java(java.lang.String.valueOf(workerDto.getAge()))&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;bloodType&quot;, constant = &quot;B 型血&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;gender&quot;, qualifiedByName = &quot;getGenderEnum&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    PeopleInfo <span class="title function_">fromPersonInfo</span><span class="params">(WorkerDto workerDto)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据枚举值的代码获取枚举值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code 枚举值对应的代码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 枚举值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Named(&quot;getGenderEnum&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> GenderEnum <span class="title function_">getGenderEnum</span><span class="params">(Integer code)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (GenderEnum value : GenderEnum.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value.getCode().equals(code)) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据性别枚举值获取对应的代码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> genderEnum 枚举值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 枚举值对应的代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Named(&quot;getGenderEnumCode&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> Integer <span class="title function_">getGenderEnumCode</span><span class="params">(GenderEnum genderEnum)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (genderEnum == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> genderEnum.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写一手测试方法： 😎</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInheritInverseConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">PeopleInfo</span> <span class="variable">peopleInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PeopleInfo</span>();</span><br><span class="line">    peopleInfo.setId(<span class="number">233L</span>);</span><br><span class="line">    <span class="comment">// 缺少 name 属性值</span></span><br><span class="line">    peopleInfo.setAge(<span class="string">&quot;18&quot;</span>);</span><br><span class="line">    peopleInfo.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1604325269401L</span>));</span><br><span class="line">    peopleInfo.setWeight(<span class="number">122.2345</span>);</span><br><span class="line">    peopleInfo.setBloodType(<span class="string">&quot;AB 型血&quot;</span>);</span><br><span class="line">    peopleInfo.setGender(GenderEnum.MAN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// to workerDto</span></span><br><span class="line">    <span class="type">WorkerDto</span> <span class="variable">workerDto</span> <span class="operator">=</span> PeopleInfoMapper.INSTANCE.toWorkerDto(peopleInfo);</span><br><span class="line">    assertEquals(<span class="string">&quot;默烦&quot;</span>, workerDto.getName());</span><br><span class="line">    assertEquals(<span class="number">1</span>, workerDto.getGender().intValue());</span><br><span class="line">    assertEquals(<span class="number">19</span>, workerDto.getAge().intValue());</span><br><span class="line">    System.out.println(workerDto.getCreateTime());</span><br><span class="line">    System.out.println(workerDto.getWeight());</span><br><span class="line">    System.out.println(workerDto.getBloodType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// from PeopleInfo</span></span><br><span class="line">    <span class="type">PeopleInfo</span> <span class="variable">person</span> <span class="operator">=</span> PeopleInfoMapper.INSTANCE.fromPersonInfo(workerDto);</span><br><span class="line">    assertEquals(<span class="string">&quot;B 型血&quot;</span>, person.getBloodType());</span><br><span class="line">    assertEquals(<span class="string">&quot;19&quot;</span>, person.getAge());</span><br><span class="line">    assertEquals(GenderEnum.MAN, person.getGender());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过，控制台打印：</p>
<pre>
2020-11-02
122.23
A 型血
</pre>
<blockquote>
<p>总结</p>
</blockquote>
<p>由于 age 的转化中使用了 <code>expression</code>、bloodType 转化的过程中使用了 <code>constant</code>，这两个属性对应的 <code>@Mapping</code> 注释都没有指定 <code>source</code>。所以在使用 <code>@InheritInverseConfiguration</code> 注解进行反向映射时，需要使用 <code>@Mapping</code> 对这两个属性进行单独的映射，不然就会报错。</p>
<p>在 <code>PeopleInfo</code> 中 gender 属性类型是 <code>GenderEnum</code> 枚举类型，而 <code>WorkerDto</code>  中的 gender 属性是 <code>Integer</code> 类型的，因此在进行属性映射时，需要指定映射方式，这里涉及到 <code>@Named</code> 注解和 <code>@Mapping</code> 注解中 <code>qualifiedByName </code> 属性的使用。</p>
<h2 id="2-9-直接使用字段映射"><a class="header-anchor" href="#2-9-直接使用字段映射"></a>2.9 直接使用字段映射</h2>
<p>在前面的案例中，实现与实体之间的映射时都需要实体中有 Getter 和 Setter 方法，但 MapStruct 也支持没有 Getter 和 Setter 的公共字段映射。如果 MapStruct 为属性找不到合适的 Getter 和 Setter 方法，它会把字段作为读 / 写访问器。</p>
<p>如果一个字段被 <code>public</code> 或 <code>public final</code> 修饰，那么它会被认为是一个读访问器。如果一个字段被 <code>static</code> 修饰，它不会被认为是一个读访问器。</p>
<p>当一个字段 <strong>仅仅只</strong> 被 <code>public</code> 修饰时，它才会被认为是一个写访问器。如果一个字段被 <code>final</code> 或 <code>static</code> 修饰，它不会被认为是一个写访问器。</p>
<p>比如，这样两个实体是能够被相互映射的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerDto</span> &#123;</span><br><span class="line">    <span class="comment">// 注意这些字段是被 public 修饰的</span></span><br><span class="line">    <span class="keyword">public</span> Long id;</span><br><span class="line">    <span class="keyword">public</span> String customerName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>name</code> 属性和 <code>customerName</code> 属性名称不一样，在进行映射时，需要使用 <code>@Mapping</code> 指定规则。</p>
<h2 id="2-10-使用构建器"><a class="header-anchor" href="#2-10-使用构建器"></a>2.10 使用构建器</h2>
<p>在 MapStruct 中，支持通过构建器对不可变类型进行映射。</p>
<p>当进行映射时，MapStruct 会检查被映射的类中是否有构建器。这是通过 BuilderProvider 完成的，如果这个类存在构建器，那么该构建器将被用于映射。</p>
<p><code>BuilderProvider</code> 的默认实现假设如下：</p>
<ul>
<li>
<p>该类型拥有返回 <code>Builder</code> 对象的公共无参静态方法（该方法称为 <strong>构建器创建方法</strong>）。比如 <code>Person</code> 类中有一个公共静态方法，它返回 <code>PersonBuilder</code>。</p>
</li>
<li>
<p><code>Builder</code> 类型有一个公共无参方法（该方法称为 <strong>构建方法</strong>），它返回正在构建的对象类型。比如 <code>PersonBuilder</code> 中有一个 <code>build()</code> 方法，该方法的返回值类型是 <code>Person</code>。</p>
</li>
<li>
<p>在有多个 <strong>构建方法</strong> 的情况下，MapStruct 会寻找一个叫做 <code>build()</code> 的方法，如果存在这样的方法，将使用这个方法，否则编译错误。</p>
</li>
<li>
<p>可以在 <code>@BeanMapping</code>、<code>@Mapper</code> 或 <code>@MapperConfig</code> 等注解中使用 <code>@Builder</code> 来定义特定的 <strong>构建方法</strong>。</p>
</li>
<li>
<p>如果有多个 <strong>构建器创建方法</strong> 满足上述条件，<code>DefaultBuilderProvider</code> 会抛出 <code>MoreThanOneBuilderCreationMethodException</code> 异常。如果发生 <code>MoreThanOneBuilderCreationMethodException</code>，MapStruct 将在编译期间写入警告，并且不使用任何生成器。</p>
</li>
</ul>
<p>如果在被映射的类中存在上述的方法和构建器，为了完成映射，MapStruct 会调用构建器的构建方法并生成代码。</p>
<p>还可以通过 MapStruct 的 <code>@Builder</code> 的 <code>disableBuilder</code> 属性来禁用构建器检测。MapStruct 将在构建器被禁用的情况下回到常规的 Getter / Setter 来生成代码。还可以在 Maven 处理器插件的配置中使用 <code>&lt;compilerArgs&gt;</code> 添加 <code>&lt;arg&gt;-Amapstruct.disableBuilders=true&lt;/arg&gt;</code> 来禁用构建器的检测。</p>
<p>对象工厂也被认为是构建器。例如，如果 <code>PersonBuilder</code> 中存在一个对象工厂，MapStruct 将使用对象工厂而不是 <strong>构建器创建方法</strong>。</p>
<p>构建器的检测会影响 <code>@BeforeMapping</code> 和 <code>@AfterMapping</code> 注解的行为，这在后文会介绍。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>原实体 <code>Animal</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目标实体与构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DogDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">DogDto</span> <span class="params">(DogDto.Builder builder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = builder.type;</span><br><span class="line">        <span class="built_in">this</span>.name = builder.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建器创建方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 构建器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DogDto.Builder <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DogDto</span>.Builder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String type;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">type</span> <span class="params">(String type)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.type = type;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 构建方法</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 被构建的对象</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> DogDto <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DogDto</span>(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AnimalMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">AnimalMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(AnimalMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 Animal 转换为 DogDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> animal Animal 实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> DogDto 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DogDto <span class="title function_">toDogDto</span><span class="params">(Animal animal)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnimalMapperTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToDogDto</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line">        animal.setName(<span class="string">&quot;小黑&quot;</span>);</span><br><span class="line">        animal.setType(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">DogDto</span> <span class="variable">dogDto</span> <span class="operator">=</span> AnimalMapper.INSTANCE.toDogDto(animal);</span><br><span class="line">        assertEquals(<span class="string">&quot;小黑&quot;</span>, dogDto.getName());</span><br><span class="line">        assertEquals(<span class="string">&quot;dog&quot;</span>, dogDto.getTYPE());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过。查看 target 目录，可以看到生成的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnimalMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">AnimalMapper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AnimalMapperImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DogDto <span class="title function_">toDogDto</span><span class="params">(Animal animal)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (animal == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Builder</span> <span class="variable">dogDto</span> <span class="operator">=</span> DogDto.builder();</span><br><span class="line">            dogDto.type(animal.getType());</span><br><span class="line">            dogDto.name(animal.getName());</span><br><span class="line">            <span class="keyword">return</span> dogDto.create();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>总结</p>
</blockquote>
<p>这其实使用了一种设计模式 —— 构建者模式，或者说建造者模式。</p>
<p>在《Effective Java》一书中有提到，<strong>一个类的构造函数参数个数有多个时，而且这些参数有些是可选的参数</strong>，要考虑使用构建器，即使用构建者模式。</p>
<p>但上述代码中并没有体现可选参数的概念，要想体现也很简单，只需要在构建器中编写编写一个构造方法，构造方法的参数就是需要必填的参数。</p>
<p>每次使用构建者模式都会书写许多样板代码，Lombok 提供了一个 <code>@Builder</code> 注解，使用这个注解可以很快地实现构建者模式。使用 <code>@Builder</code> 生成的构造方法是共有的，不符合构建者模式的思想，因此还需要指定构造方法的访问修饰符。比如指定成 <code>protected</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(access = AccessLevel.PROTECTED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DogDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 DogDto 修改成以上形式后，运行测试方法也是可以通过的。 👊</p>
<h2 id="2-11-使用构造函数"><a class="header-anchor" href="#2-11-使用构造函数"></a>2.11 使用构造函数</h2>
<p>在前文中，对象映射使用 Getter / Setter 完成。MapStruct 也支持使用构造方法来映射目标类型。</p>
<p>在进行映射时，MapStruct 会检查被映射的实体中是否存在构建器。如果没有构建器，MapStruct 会寻找一个可访问的构造方法。</p>
<blockquote>
<p>构造方法的选择</p>
</blockquote>
<p>当有多个构造函数时，MapStruct 按照以下优先级进行选择：</p>
<ol>
<li>被 <code>@Default</code> （该注解可以来自任何包！😲）注释所标注的公共构造方法（最高优先级）；</li>
<li>如果 <strong>只有一个公共</strong> 的构造方法，那么它将被用于构造对象，而其他非公共的构造方法会被忽略；</li>
<li>如果存在一个无参构造方法，那么它将被用于构造对象，而其他构造方法会被忽略；</li>
<li>如果有多个符合条件的构造方法，会因为构造方法指代不清而造成编译错误。在这个时候，可以使用 <code>@Default</code> 注解来指定用于构造对象的构造方法。</li>
</ol>
<p>官网给出的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vehicle</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">Vehicle</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// MapStruct will use this constructor, because it is a single public constructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Vehicle</span><span class="params">(String color)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="comment">// MapStruct will use this constructor, because it is a parameterless empty constructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Car</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Car</span><span class="params">(String make, String color)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Truck</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Truck</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// MapStruct will use this constructor, because it is annotated with @Default</span></span><br><span class="line">    <span class="meta">@Default</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Truck</span><span class="params">(String make, String color)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Van</span> &#123;</span><br><span class="line">    <span class="comment">// There will be a compilation error when using this class because MapStruct cannot pick a constructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Van</span><span class="params">(String make)</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Van</span><span class="params">(String make, String color)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在使用构造方法时，将使用构造方法的参数名并与目标属性进行匹配。当构造函数被 <code>@ConstructorProperties</code> （该注解也可以来自任何包，只不过通常使用 <code>java.beans.ConstructorProperties</code>）标注时，该注解将被用来获取参数的名称。</p>
<p>当目标实体中存在对象工厂方法或用 <code>@ObjectFactory</code> 标记的方法时，这些方法将优于目标中任何构造方法。在这种情况下，目标实体中的构造方法不会被使用。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>自己编写的 <code>@Default</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.CONSTRUCTOR)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Default &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个 <code>Book</code> 实体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String bookName;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再创建一个 <code>NovelDto</code>，后续会将 <code>Book</code> 对象转换为 <code>NovelDto</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NovelDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bookName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Default</span></span><br><span class="line">    <span class="comment">// @ConstructorProperties 注解指定来源对象的属性名</span></span><br><span class="line">    <span class="meta">@java</span>.beans.ConstructorProperties(&#123;<span class="string">&quot;bookName&quot;</span>, <span class="string">&quot;price&quot;</span>, <span class="string">&quot;author&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NovelDto</span><span class="params">(String book, Double price, String author)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bookName = book;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">        <span class="built_in">this</span>.author = <span class="string">&quot;author&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NovelDto</span><span class="params">(String bookName, Double price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bookName = bookName;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个用于实体映射的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookMapper</span> &#123;</span><br><span class="line">    <span class="type">BookMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(BookMapper.class);</span><br><span class="line">    NovelDto <span class="title function_">toNovelDto</span><span class="params">(Book book)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToNovel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">    book.setBookName(<span class="string">&quot;Effective Java&quot;</span>);</span><br><span class="line">    book.setPrice(<span class="number">78.0</span>);</span><br><span class="line">    <span class="type">NovelDto</span> <span class="variable">novelDto</span> <span class="operator">=</span> BookMapper.INSTANCE.toNovelDto(book);</span><br><span class="line"></span><br><span class="line">    assertEquals(<span class="string">&quot;Effective Java&quot;</span>, novelDto.getBookName());</span><br><span class="line">    assertEquals(<span class="string">&quot;author&quot;</span>, novelDto.getAuthor());</span><br><span class="line">    assertEquals(<span class="number">78.0</span>, novelDto.getPrice(), <span class="number">0.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过！</p>
<p>查看生成的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> NovelDto <span class="title function_">toNovelDto</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (book == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bookName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Double</span> <span class="variable">price</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">author</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        bookName = book.getBookName();</span><br><span class="line">        price = book.getPrice();</span><br><span class="line">        author = book.getAuthor();</span><br><span class="line">        <span class="type">NovelDto</span> <span class="variable">novelDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NovelDto</span>(bookName, price, author);</span><br><span class="line">        <span class="keyword">return</span> novelDto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>总结</p>
</blockquote>
<p>通过生成代码来看，使用到了原目标实体的 Getter 方法，用到了目标实体的构造方法，因此在编码时需要保证存在这些方法 <strong>才能使用构造函数进行映射</strong>。</p>
<p>使用 MapStruct 将 <code>Book</code> 实体转换成 <code>NovelDto</code> 时，在 <code>NovelDto</code> 中没有 Setter 方法，但存在多个构造方法，最终会选取合适的构造方法进行映射。</p>
<p>在 <code>NovelDto</code> 实体类中存在两个构造方法，且都是公共有参构造方法，因此需要使用 <code>@Default</code> 进行指明要使用哪个构造方法进行映射，如果不指明就会在编译阶段报错。</p>
<p>但是在 MapStruct 中并没有提供 <code>@Default</code> 注解，那怎么办？🤔</p>
<p>根据官方文档 <a target="_blank" rel="noopener" href="https://mapstruct.org/documentation/stable/reference/html/#non-shipped-annotations">14.1. Non-shipped annotations</a> 的说话，只要使用任意一个能够作用在构造方法且名为 <code>@Default</code> 的注解就行，也就是任意第三方的、能作用于构造方法上的 <code>@Default</code> 注解都能够被 MapStruct 识别，并将注解标记的构造方法作为映射的构造方法。那问题来了，在没有引入第三方依赖，且当前项目中没有符合条件的 <code>@Default</code> 注解咋办？</p>
<p>自己写一个就行，MapStruct 也能识别。具体参见上述提供的代码。😁</p>
<p>使用目标实体的构造方法时，会使用该构造方法的参数名并与 <mark>来源实体</mark> 的属性进行匹配。<strong>务必保证这些名称是一样的，否则无法映射成功。</strong> 当然，也不是说名称不一样就不能映射，这时候可以使用 <code>@ConstructorProperties</code> 注解，使用这个注解指定构造方法的第几个参数对应来源对象的哪个 Getter 方法，从而完成参数名与属性的匹配。</p>
<p>那如果目标实体的属性名和原实体的属性名不一致怎么办？这就需要用到前面说的 <code>@Mapping</code> 注解了。😏</p>
<p><strong>备注：</strong> 这一块或许比较难理解，建议使用上述代码进行小改然后一一理解。😔</p>
<h2 id="2-12-将-Map-映射到对象"><a class="header-anchor" href="#2-12-将-Map-映射到对象"></a>2.12 将 Map 映射到对象</h2>
<p>在某些情况下，可能需要将 <code>Map&lt;String, Object&gt;</code> 映射到某个对象，MapStruct 也是支持这种需求的，此时 <code>@Mapping</code> 中的 <code>source</code> 属性值为 <code>Map</code> 中的 key（把 <code>Map</code> 当成一个没有特定类型的对象）。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CustomerMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Mapping(target = &quot;name&quot;, source = &quot;customerName&quot;)</span></span><br><span class="line">    Customer <span class="title function_">toCustomer</span><span class="params">(Map&lt;String, String&gt; map)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">CustomerMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">toCustomer</span><span class="params">(Map&lt;String, String&gt; map)</span> &#123;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">        <span class="keyword">if</span> ( map.containsKey( <span class="string">&quot;customerName&quot;</span> ) ) &#123;</span><br><span class="line">            customer.setName( map.get( <span class="string">&quot;customerName&quot;</span> ) );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当使用 raw map（没有指定泛型的 <code>Map</code>） 或没有字符串作为键的 <code>Map</code> 时，将生成警告。如果 <code>Map</code> 本身直接映射到其他目标属性，则不会生成警告。</p>
<h1 id="3-获取映射器"><a class="header-anchor" href="#3-获取映射器"></a>3. 获取映射器</h1>
<h2 id="3-1-映射器工厂"><a class="header-anchor" href="#3-1-映射器工厂"></a>3.1 映射器工厂</h2>
<p>当没有使用依赖注入框架（比如 Spring）时，可以使用 <code>org.mapstruct.factory.Mappers</code> 类来获取一个映射器（Mapper）实例。</p>
<p><strong>使用方法：</strong> 调用该类的 <code>Mappers#getMapper()</code> 方法，传入要返回的 Mapper 接口类型。</p>
<p>通常来说，习惯于将映射器实例命名为 <code>INSTANCE</code>。</p>
<p>在前文中，大部分都是使用接口来定义映射器，而在抽象类中应该这样定义映射器，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">CarMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(CarMapper.class);</span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种模式使得客户端可以非常容易地使用映射器对象，而不需要重复实例化新的实例。</p>
<p>MapStruct 生成的映射器是无状态和线程安全的，在多线程环境下可以放心使用。</p>
<h2 id="3-2-使用依赖注入"><a class="header-anchor" href="#3-2-使用依赖注入"></a>3.2 使用依赖注入</h2>
<p>在实际项目中，一般都会使用依赖注入框架（比如：Spring），这个时候就需要通过依赖注入而不是通过 <code>Mappers#getMapper()</code> 来获取映射器对象。可以通过 <code>@Mapper</code> 的 <code>componentModel</code> 属性或使用配置选项中描述的 <a target="_blank" rel="noopener" href="https://mapstruct.org/documentation/stable/reference/html/#configuration-options">Configuration options</a> 指定生成的映射器类应基于的组件模型。</p>
<p>目前，MapStruct 支持 CDI 和 Spring 。在这两种情况下，所需的注解将被添加到生成的映射器实现类中，以便使其同样受到依赖注入的影响。</p>
<p><code>@Mapper#componentModel</code> 属性或 <code>mapstruct.defaultComponentModel</code> 配置选项支持的值：</p>
<table>
<thead>
<tr>
<th style="text-align:center">值</th>
<th style="text-align:center">注入方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>default</code></td>
<td style="text-align:center">默认方式，映射器不使用组件模型，使用 <code>Mappers.getMapper(Class)</code> 来进行获取映射器实例</td>
</tr>
<tr>
<td style="text-align:center"><code>cdi</code></td>
<td style="text-align:center">生成的映射器是一个应用程序范围的 CDI Bean，使用 <code>@Inject</code> 注入</td>
</tr>
<tr>
<td style="text-align:center"><code>spring</code></td>
<td style="text-align:center">生成的映射器是一个单例的 Spring Bean，使用 <code>@Autowired</code> 注入</td>
</tr>
<tr>
<td style="text-align:center"><code>jsr330</code></td>
<td style="text-align:center">生成的映射器中被 <code>@Named</code> 注解标记，使用 <code>@Inject</code> 注入</td>
</tr>
<tr>
<td style="text-align:center"><code>jakarta</code></td>
<td style="text-align:center">生成的映射器中被 <code>@Named</code> 注解标记，使用 <code>jakarta.inject.@Inject</code> 注入（since 1.5.0.Final）</td>
</tr>
</tbody>
</table>
<p>从 MapStruct 1.5.0.Final 开始，这些值在 <code>org.mapstruct.MappingConstants.ComponentModel</code> 类中以常量的形式存在。</p>
<p>当 <code>mapstruct.defaultComponentModel</code> 配置选项和 <code>@Mapper#componentModel</code> 同时指定了值，以 <code>@Mapper</code> 注解的为准。</p>
<p>使用其他映射器类的映射器将使用配置的组件模型获得这些映射器。比如，映射器 A 是一个 Spring Bean，映射器 A 中注入了映射器 B，那么映射器 B 也必须是一个可注入的 Spring Bean。</p>
<h2 id="3-3-注入策略"><a class="header-anchor" href="#3-3-注入策略"></a>3.3 注入策略</h2>
<p>使用依赖注入时，可以指定注入策略。</p>
<p>可以通过 <code>@Mapper</code> 和 <code>@MapperConfig</code> 注解的 <code>injectionStrategy</code> 属性或 <code>mapstruct.defaultInjectionStrategy</code> 来指定注入策略。注入策略有两种：构造方法和属性注入， 默认是属性注入。</p>
<p>针对 <code>@Mapper</code> 的 <code>injectionStrategy</code> 属性来说，其值是一个枚举：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">InjectionStrategy</span> &#123;</span><br><span class="line">    <span class="comment">/** Annotations are written on the field **/</span></span><br><span class="line">    FIELD,</span><br><span class="line">    <span class="comment">/** Annotations are written on the constructor **/</span></span><br><span class="line">    CONSTRUCTOR</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用属性注入时，依赖关系将被注入到字段中。</li>
<li>使用构造函数注入时，将生成构造函数，依赖关系将通过构造函数注入。</li>
</ol>
<p>如果 MapStruct 检测到 <strong>需要使用</strong> <code>@Mapper#uses</code> 属性的实例进行映射，则生成的映射器将注入在 <code>uses</code> 属性中定义的类。注意 <strong>需要使用</strong> 几个字，如果参与映射字段不需要使用指定类型对应的实例进行映射，那么生成的映射器不会注入 <code>uses</code> 属性中定义的类。</p>
<p>对于抽象类或装饰器应使用属性注入，因为它们不能被实例化。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>使用最开始的 <code>Car</code> 和 <code>CarDto</code> 两个实体进行测试，省略实体代码。</p>
<p>导入 Spring 所需要的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写一个 <code>SpringConfig</code> 配置类，主要用于扫描包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;indi.mofan.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写映射器，使用 Spring 的依赖注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper(componentModel = &quot;spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarInjectMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;numberOfSeats&quot;, target = &quot;seatCount&quot;)</span></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试类与测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DependencyInjectionTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CarInjectMapper carInjectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldMapCarToDto</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>(<span class="string">&quot;Morris&quot;</span>, <span class="number">5</span>, <span class="string">&quot;Sedan&quot;</span>);</span><br><span class="line">        <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> carInjectMapper.carToCarDto(car);</span><br><span class="line">        assertEquals(<span class="string">&quot;Morris&quot;</span>, carDto.getMake());</span><br><span class="line">        assertEquals(<span class="number">5</span>, carDto.getSeatCount());</span><br><span class="line">        assertEquals(<span class="string">&quot;Sedan&quot;</span>, carDto.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看生成的实现类 <code>CarInjectMapperImpl</code>，可以看到这个类被 Spring 的 <code>@Component</code> 注解标记。</p>
<h1 id="4-数据类型转换"><a class="header-anchor" href="#4-数据类型转换"></a>4. 数据类型转换</h1>
<p>在许多情况下，MapStruct 会自动处理类型转换。</p>
<p>例如，一个属性在源 Bean 中是 <code>int</code> 类型，但在目标 Bean 中是 <code>String</code> 类型，通过生成的代码可以看到分别调用 <code>String.valueOf(int)</code> 和 <code>Integer.parseInt(String)</code> 两个方法进行了类型的转换。</p>
<p>又比如在 <code>Car</code> 类型中有一个 <code>Person</code> 类型的 <code>driver</code> 属性，当对 <code>Car</code> 进行映射时，应当把 <code>driver</code> 映射为 <code>PersonDto</code> 类型。</p>
<h2 id="4-1-隐式类型转换"><a class="header-anchor" href="#4-1-隐式类型转换"></a>4.1 隐式类型转换</h2>
<p>在此列举一些常见的自动类型转换：</p>
<ul>
<li>Java 基本数据类型和其对应的包装类之间。把包装类转换成基本数据类型时，会执行 <code>null</code> 值检查。</li>
<li>Java 基本数据类型和封装类型之间。例如 <code>int</code> 和 <code>long</code> 之间或 <code>byte</code> 和 <code>Integer</code> 之间。</li>
</ul>
<p><mark>注意：</mark> 从精度较大类型的数据转换为精度较小的数据时，可能会造成值或精度缺失（例如从 <code>long</code> 转换为 <code>int</code>）。<code>@Mapper</code> 和 <code>@MapperConfig</code> 注解有一个属性 <code>typeConversionPolicy</code> 来控制警告或错误，其默认值为 <code>ReportingPolicy.IGNORE</code>。</p>
<ul>
<li>基本数据类型及其包装类和 <code>String</code> 之间。可以在 <code>@Mapping</code> 的 <code>numberFormat</code> 属性中指定 <code>java.text.DecimalFormat</code> 能理解的格式化字符串对数值格式化。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;price&quot;, numberFormat = &quot;$#.00&quot;)</span></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IterableMapping(numberFormat = &quot;$#.00&quot;)</span></span><br><span class="line">    List&lt;String&gt; <span class="title function_">prices</span><span class="params">(List&lt;Integer&gt; prices)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>enum</code> 和 <code>String</code> 之间。</p>
</li>
<li>
<p>大数类型（<code>java.math.BigInteger</code>，<code>java.math.BigDecimal</code>）和基本数据类型（及其包装类）以及 <code>String</code> 之间。同样可以使用 <code>@Mapping</code> 的 <code>numberFormat </code> 属性对数值格式化。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;power&quot;, numberFormat = &quot;#.##E0&quot;)</span></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>JAXBElement&lt;T&gt;</code> 和 <code>T</code> 之间，<code>List&lt;JAXBElement&lt;T&gt;&gt;</code> 和 <code>List&lt;T&gt;</code> 之间。</li>
<li><code>java.util.Calendar</code> 或 <code>java.util.Date</code> 和 JAXB 的 <code>XMLGregorianCalendar</code> 之间。</li>
<li><code>java.util.Date</code> 日期类型或 <code>XMLGregorianCalendar</code> 和 <code>String</code> 之间。可以在 <code>@Mapping</code> 的 <code>dateFormat</code> 属性中指定 <code>java.text.SimpleDateFormat</code> 能理解的格式化字符串对日期字符串格式化。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;manufacturingDate&quot;, dateFormat = &quot;dd.MM.yyyy&quot;)</span></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IterableMapping(dateFormat = &quot;dd.MM.yyyy&quot;)</span></span><br><span class="line">    List&lt;String&gt; <span class="title function_">stringListToDateList</span><span class="params">(List&lt;Date&gt; dates)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Jodas 中的日期时间类型（<code>DateTime</code>、<code>LocalDateTime</code>、<code>LocalDate</code>、<code>LocalTime</code>）和 <code>String</code> 之间。可以使用 <code>@Mapping</code> 的 <code>dateFormat</code> 属性对数值进行格式化。</p>
</li>
<li>
<p>Jodas 的 <code>DateTime</code> 类型和 <code>javax.xml.datatype.XMLGregorianCalendar</code>、<code>java.util.Calendar</code> 之间。</p>
</li>
<li>
<p>Jodas 的 <code>LocalDateTime</code>、<code>LocalDate</code> 和 <code>javax.xml.datatype.XMLGregorianCalendar</code>、<code>java.util.Date</code> 之间。</p>
</li>
<li>
<p><code>java.time.LocalDate</code>、<code>java.time.LocalDateTime</code> 和 <code>javax.xml.datatype.XMLGregorianCalendar</code> 之间。</p>
</li>
<li>
<p>Java 8 日期时间类型（<code>ZonedDateTime</code>、<code>LocalDateTime</code>、<code>LocalDate</code>、<code>LocalTime</code>）和 <code>String</code> 之间。可以使用 <code>@Mapping</code> 的 <code>dateFormat</code> 属性对数值进行格式化。</p>
</li>
<li>
<p>Java 8 日期类型（<code>Instant</code>、<code>Duration</code>、<code>Period</code>）和 <code>String</code> 之间。</p>
</li>
<li>
<p>Java 8 的 <code>ZonedDateTime</code> 类型和 <code>Date</code> 之间，当从给定的 <code>Date</code> 转换成 <code>ZonedDateTime</code> 时，使用系统默认时区。</p>
</li>
<li>
<p>Java 8 的 <code>LocalDateTime</code> 类型和 <code>Date</code> 之间，使用 UTC 作为时区。</p>
</li>
<li>
<p>Java 8 的 <code>LocalDate</code> 类型和 <code>java.util.Date</code>、<code>java.sql.Date</code> 之间，使用 UTC 作为时区。</p>
</li>
<li>
<p>Java 8 的 <code>Instant</code> 类型和 <code>Date</code> 之间。</p>
</li>
<li>
<p>Java 8 的 <code>ZonedDateTime</code> 类型和 <code>Calendar</code> 之间。</p>
</li>
<li>
<p><code>java.sql.Date</code>、<code>java.sql.Time</code>、<code>java.sql.Timestamp</code> 和 <code>java.util.Date</code> 之间。</p>
</li>
<li>
<p>当从一个字符串转换时，如果省略 <code>@Mapping</code> 注解的 <code>dateFormat</code>，会使用默认的格式和符号来转换，但 <code>XmlGregorianCalendar</code> 是个例外，将根据 <a target="_blank" rel="noopener" href="http://www.w3.org/TR/xmlschema-2/#dateTime">XML Schema 1.0 Part 2, Section 3.2.7-14.1, Lexical Representation</a></p>
</li>
<li>
<p><code>java.util.Currency</code> 和 <code>String</code> 之间。当从一个字符串转换时，其值应符合 ISO-4217 规范，否则会抛出 <code>IllegalArgumentException</code> 异常。</p>
</li>
<li>
<p><code>java.util.UUID</code> 和 <code>String</code> 之间。当从一个字符串转换时，其值应该是一个有效的 UUID，否则会抛出 <code>IllegalArgumentException</code> 异常。</p>
</li>
<li>
<p><code>String</code> 和 <code>StringBuilder</code> 之间。</p>
</li>
<li>
<p><code>java.net.URL</code> 和 <code>String</code> 之间。当从一个字符串转换时，其值应该是一个有效的 URL，否则会抛出 <code>MalformedURLException</code> 异常。</p>
</li>
</ul>
<h2 id="4-2-映射对象引用"><a class="header-anchor" href="#4-2-映射对象引用"></a>4.2 映射对象引用</h2>
<p>通常，一个对象不仅具有基本数据类型的属性，还引用其他对象。比如，一个 <code>Cage</code> 实体内部含有 <code>Animal</code> 类型的属性，表示笼子里关着的动物。</p>
<p>在这种情况下，也只需为引用的对象类型定义一个映射方法。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>创建一个新的 <code>Cage</code> 实体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String size;</span><br><span class="line">    <span class="keyword">private</span> Animal animal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将映射成的 <code>CageDto</code> 实体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CageDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String size;</span><br><span class="line">    <span class="keyword">private</span> DogDto dog;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用于实体映射的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CageMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CageMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(CageMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;animal&quot;, target = &quot;dog&quot;)</span></span><br><span class="line">    CageDto <span class="title function_">toCageDto</span><span class="params">(Cage cage)</span>;</span><br><span class="line"></span><br><span class="line">    DogDto <span class="title function_">toDogDto</span><span class="params">(Animal animal)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToCageDto</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Cage</span> <span class="variable">cage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cage</span>();</span><br><span class="line">    <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>(<span class="string">&quot;小黑&quot;</span>, <span class="string">&quot;Dog&quot;</span>);</span><br><span class="line">    cage.setAnimal(animal);</span><br><span class="line">    cage.setName(<span class="string">&quot;小黑的家&quot;</span>);</span><br><span class="line">    cage.setSize(<span class="string">&quot;70*50*60&quot;</span>);</span><br><span class="line">    <span class="type">CageDto</span> <span class="variable">cageDto</span> <span class="operator">=</span> CageMapper.INSTANCE.toCageDto(cage);</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;小黑的家&quot;</span>, cageDto.getName());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;70*50*60&quot;</span>, cageDto.getSize());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;小黑&quot;</span>, cageDto.getDog().getName());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;Dog&quot;</span>, cageDto.getDog().getType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过。</p>
<p>查看生成的实现类 <code>CageMapperImpl</code> 接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CageMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">CageMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CageDto <span class="title function_">toCageDto</span><span class="params">(Cage cage)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( cage == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">CageDto</span> <span class="variable">cageDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CageDto</span>();</span><br><span class="line"></span><br><span class="line">        cageDto.setDog( toDogDto( cage.getAnimal() ) );</span><br><span class="line">        cageDto.setName( cage.getName() );</span><br><span class="line">        cageDto.setSize( cage.getSize() );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cageDto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DogDto <span class="title function_">toDogDto</span><span class="params">(Animal animal)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( animal == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">DogDtoBuilder</span> <span class="variable">dogDto</span> <span class="operator">=</span> DogDto.builder();</span><br><span class="line"></span><br><span class="line">        dogDto.name( animal.getName() );</span><br><span class="line">        dogDto.type( animal.getType() );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dogDto.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>MapStruct 对源对象与目标对象属性的映射规则</p>
</blockquote>
<ol>
<li>
<p>如果源属性和目标属性类型相同，值将直接从源复制到目标。如果属性是一个集合（如 <code>List</code>），集合的副本（新建一个集合，然后把源数据一个个地塞进去）将被设置到目标属性中。</p>
</li>
<li>
<p>如果源属性和目标属性类型不同，将在当前类检查是否存在将源属性的类型作为参数类型，将目标属性的类型作为返回类型的另一种映射方法。如果存在这样的方法，它将在生成的实现方法中被调用。</p>
</li>
<li>
<p>如果不存在这样的方法，MapStruct 将查看源属性类型和目标属性类型是否存在内置转换。如果存在，生成的代码将采用这种转换。</p>
</li>
<li>
<p>如果不存在这样的方法，MapStruct 将采用复杂的转换：</p>
<ul>
<li>映射方法，通过映射方法映射结果，比如：<code>target = method1(method2(source))</code></li>
<li>内置转换，通过映射方法映射结果，比如：<code>target = method(conversion(source))</code></li>
<li>映射方法，通过内置转换映射结果，比如：<code>target = conversion(method(source))</code></li>
</ul>
</li>
<li>
<p>如果没有找到这样的方法，MapStruct 将尝试生成一个自动的 <code>sub-mapping</code> 方法，使用方法进行源属性和目标属性之间的映射。</p>
</li>
<li>
<p>如果 MapStruct 无法创建基于名称的映射方法，则会在编译时引发错误，显示不可映射的属性及其路径。</p>
</li>
</ol>
<p>可以在以下四个注解上设置 <code>mappingControl</code>（映射控件），优先级依次增加：</p>
<ul>
<li>@MapperConfig</li>
<li>@Mapper</li>
<li>@BeanMapping</li>
<li>@Mapping</li>
</ul>
<p>比如 <code>@Mapper(mappingControl = NoComplexMapping.class)</code> 的优先级高于 <code>@MapperConfig(mappingControl = DeepClone.class)</code>。</p>
<p><code>@IterableMapping</code> 和 <code>@MapMapping</code> 的工作原理与 <code>@Mapping</code> 类似。</p>
<p>映射控件是在 MapStruct 1.4 中引入的实验性功能。</p>
<p>映射控件的类型由枚举 <code>org.mapstruct.control.MappingControl.Use</code> 表示：</p>
<ul>
<li>BUILT_IN_CONVERSION</li>
<li>COMPLEX_MAPPING</li>
<li>DIRECT</li>
<li>MAPPING_METHOD</li>
</ul>
<p>枚举 <code>Use</code> 的存在使得用户可以对 MapStruct 的映射细节进行控制，当缺失某种枚举时，表示关闭对应的映射方式，默认情况下 <code>mappingControl = MappingControl.class</code>，表示启用所有映射选项。</p>
<blockquote>
<p>属性间应用拓展</p>
</blockquote>
<ol>
<li>如果不想让 MapStruct 生成自动的 <code>sub-mapping</code> 方法，可以使用：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(disableSubMappingMethodsGeneration = true)</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>用户可以通过元注解来控制映射。提供了一些方便的注解，比如 <code>@DeepClone</code> 只允许直接映射。使用该注解后，如果源类型和目标类型相同，MapStruct 将对源类型进行深拷贝。<code>sub-mappings-methods</code> 必须被允许（默认情况下）。</li>
<li>在自动的 <code>sub-mapping</code> 方法生成过程中，共享配置将不会被考虑在内。</li>
<li>目标对象的构造函数属性也被视为目标属性。</li>
</ol>
<h2 id="4-3-控制嵌套对象映射"><a class="header-anchor" href="#4-3-控制嵌套对象映射"></a>4.3 控制嵌套对象映射</h2>
<p>MapStruct 会使用源属性名和目标属性名生成映射方法，但不幸的是，这两个名称通常不会相等。在这这种情况下，需要使用 <code>@Mapping</code> 注解来指定属性之间的映射。</p>
<p>比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FishTankMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Mapping(target = &quot;fish.kind&quot;, source = &quot;fish.type&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;fish.name&quot;, ignore = true)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;ornament&quot;, source = &quot;interior.ornament&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;material.materialType&quot;, source = &quot;material&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;quality.report.organisation.name&quot;, </span></span><br><span class="line"><span class="meta">             source = &quot;quality.report.organisationName&quot;)</span></span><br><span class="line">    FishTankDto <span class="title function_">map</span><span class="params">( FishTank source )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FishTankMapperWithDocument</span> &#123;</span><br><span class="line">    <span class="meta">@Mapping(target = &quot;fish.kind&quot;, source = &quot;fish.type&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;fish.name&quot;, expression = &quot;java(\&quot;Jaws\&quot;)&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;plant&quot;, ignore = true )</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;ornament&quot;, ignore = true )</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;material&quot;, ignore = true)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;quality.document&quot;, source = &quot;quality.report&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;quality.document.organisation.name&quot;, constant = &quot;NoIdeaInc&quot; )</span></span><br><span class="line">    FishTankWithNestedDocumentDto <span class="title function_">map</span><span class="params">( FishTank source )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MapStruct 将对源对象中的每个嵌套属性执行 <code>null</code> 检查。</p>
<p>MapStruct 鼓励用户编写明确的 <strong>嵌套属性映射方法</strong>，而不是通过 <code>@Mapping</code> 配置来解决一切，这样还可以实现代码复用，更加优雅~ 👊</p>
<p>在某些情况下，用于生成嵌套方法的 <code>ReportingPolicy</code> 可能是 <code>IGNORE</code>，这意味着 MapStruct 不会显示嵌套映射中未映射的目标属性。</p>
<h2 id="4-4-执行自定义映射方法"><a class="header-anchor" href="#4-4-执行自定义映射方法"></a>4.4  执行自定义映射方法</h2>
<p>有时映射并不简单，有些字段可能需要自定义逻辑。</p>
<p>比如将 <code>FishTank</code> 中的 <code>length</code>、<code>width</code> 和 <code>height</code> 属性映射到 <code>FishTankWithVolumeDto</code> 中的 <code>volume</code> 属性，这个映射也不是一个简单的映射，需要计算鱼缸 <code>FishTank</code> 的体积，然后输出描述信息。</p>
<p>参与转换的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FishTank</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Fish fish;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> width;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VolumeDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> volume;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FishTankWithVolumeDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> FishDto fish;</span><br><span class="line">    <span class="keyword">private</span> VolumeDto volume;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fish</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FishDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String kind;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用于实体映射的抽象类（换一种方法，不要接口）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FishTankMapperWithVolume</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">FishTankMapperWithVolume</span> <span class="variable">INSTANCE</span></span><br><span class="line">            <span class="operator">=</span> Mappers.getMapper(FishTankMapperWithVolume.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;将 FishTank 转换为 FishTankWithVolumeDto&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;<span class="doctag">@Mapping</span>&lt;/code&gt; 注解的 source 属性值是 map() 方法的参数,</span></span><br><span class="line"><span class="comment">     * 而不是 FishTank 中的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source FishTank实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FishTankWithVolumeDto 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;fish.kind&quot;, source = &quot;source.fish.type&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;volume&quot;, source = &quot;source&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> FishTankWithVolumeDto <span class="title function_">map</span><span class="params">(FishTank source)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> VolumeDto <span class="title function_">mapVolume</span><span class="params">(FishTank source)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">volume</span> <span class="operator">=</span> source.getLength() * source.getWidth() * source.getHeight();</span><br><span class="line">        <span class="type">String</span> <span class="variable">desc</span> <span class="operator">=</span> volume &lt; <span class="number">100</span> ? <span class="string">&quot;Small&quot;</span> : <span class="string">&quot;Large&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">VolumeDto</span>(volume, desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Mapping</code> 注解的 source 属性值是 <code>map()</code> 方法的参数 <code>source</code>，而不是 <code>FishTank</code> 中名为 <code>source</code> 的属性。</p>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FishTankMapperWithVolumeTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToFishTankWithVolumeDto</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FishTank</span> <span class="variable">fishTank</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FishTank</span>();</span><br><span class="line">        fishTank.setLength(<span class="number">70</span>);</span><br><span class="line">        fishTank.setWidth(<span class="number">50</span>);</span><br><span class="line">        fishTank.setHeight(<span class="number">60</span>);</span><br><span class="line">        <span class="type">Fish</span> <span class="variable">fish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Fish</span>();</span><br><span class="line">        fish.setType(<span class="string">&quot;Carp&quot;</span>);</span><br><span class="line">        fishTank.setFish(fish);</span><br><span class="line">        <span class="type">FishTankWithVolumeDto</span> <span class="variable">dto</span> <span class="operator">=</span> FishTankMapperWithVolume.INSTANCE.map(fishTank);</span><br><span class="line">        Assert.assertEquals(<span class="number">210000</span>, dto.getVolume().getVolume());</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;Large&quot;</span>, dto.getVolume().getDescription());</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;Carp&quot;</span>, dto.getFish().getKind());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过。</p>
<p>查看生成的实现类 <code>FishTankMapperWithVolumeImpl</code> 接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FishTankMapperWithVolumeImpl</span> <span class="keyword">extends</span> <span class="title class_">FishTankMapperWithVolume</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FishTankWithVolumeDto <span class="title function_">map</span><span class="params">(FishTank source)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( source == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">FishTankWithVolumeDto</span> <span class="variable">fishTankWithVolumeDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FishTankWithVolumeDto</span>();</span><br><span class="line"></span><br><span class="line">        fishTankWithVolumeDto.setFish( fishToFishDto( source.getFish() ) );</span><br><span class="line">        fishTankWithVolumeDto.setVolume( mapVolume( source ) );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fishTankWithVolumeDto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> FishDto <span class="title function_">fishToFishDto</span><span class="params">(Fish fish)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( fish == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">FishDto</span> <span class="variable">fishDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FishDto</span>();</span><br><span class="line"></span><br><span class="line">        fishDto.setKind( fish.getType() );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fishDto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5-调用其他映射器"><a class="header-anchor" href="#4-5-调用其他映射器"></a>4.5  调用其他映射器</h2>
<p>MapStruct 还可以调用其他类中定义的映射方法，这些映射方法可以是 MapStruct 生成的也可以是手动编写的。这对于在多个类中编写映射代码，或者想提供无法由 MapStruct 生成的自定义映射逻辑，是非常有用的。</p>
<p>调用其他映射器时，只需在 <code>@Mapper#uses</code> 配置想使用的映射器类即可，可以指定多个。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>假设有一属性 <code>manufacturingDate</code> 在源实体中的类型为 <code>Date</code>，而在目标实体中类型为 <code>String</code>，在转换过程中，对日期值按需求进行格式化，这时候就需要使用自己编写的映射器进行映射处理。</p>
<p>源实体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Date manufacturingDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目标实体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CarDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String manufacturingDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义的映射方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan 2021/2/9</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">asString</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> date != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>)</span><br><span class="line">                .format(date) : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">asDate</span><span class="params">(String date)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> date != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>)</span><br><span class="line">                    .parse(date) : <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于需要使用自定义的映射方法，因此需要在 <code>@Mapper#uses</code> 上指定映射方法所在的类。</p>
<p>映射器接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(uses = DateMapper.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CarMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(CarMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 Car 转换成 CarDto，不忽略 Date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> car Car 实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>    对应的 DTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CarDto <span class="title function_">carToCarDtoUseDate</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUseDate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 时间戳表示的时间为 2021-02-09 00:00:00</span></span><br><span class="line">    <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1612800000000L</span>));</span><br><span class="line">    <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> CarMapper.INSTANCE.carToCarDtoUseDate(car);</span><br><span class="line">    assertEquals(<span class="string">&quot;2021-02-09&quot;</span>, carDto.getManufacturingDate());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过。</p>
<p>查看生成的实现类 <code>CarMapperImpl</code> 接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CarMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">DateMapper</span> <span class="variable">dateMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CarMapperImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CarDto <span class="title function_">carToCarDtoUseDate</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (car == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CarDto</span>();</span><br><span class="line">            carDto.setManufacturingDate(<span class="built_in">this</span>.dateMapper</span><br><span class="line">                                        .asString(car.getManufacturingDate()));</span><br><span class="line">            <span class="keyword">return</span> carDto;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在为实现 <code>carToCarDto()</code> 方法生成代码时，MapStruct 将寻找一个将 <code>Date</code> 对象映射为 <code>String</code> 的方法，最终在 <code>DateMapper</code> 类中找到它，使用其中的 <code>asString()</code> 方法来映射不同类型的 <code>manufacturingDate</code> 属性。</p>
<blockquote>
<p>总结思考</p>
</blockquote>
<p>生成的映射器使用为其配置的组件模型（使用 <code>@Mapper#componentModel</code> 配置组件模型）获取引用的映射器。</p>
<p>在示例代码生成的映射器实现类中，使用了 <code>new</code> 关键词 <strong>调用无参构造方法</strong> 创建了一个包含自定义映射方法的对象。</p>
<p>因此，<strong>默认情况下，</strong> 在自定义映射方法的所在类中，一定要含有公共无参构造方法，以便能够被实例化。</p>
<p>在使用了依赖注入时，自定义映射方法的所在类也要是一个可注入的 Bean。比如使用了 Spring 框架时，需要让自定义映射方法的所在类也被 Spring 管理。</p>
<h2 id="4-6-将目标类型传递给自定义映射器"><a class="header-anchor" href="#4-6-将目标类型传递给自定义映射器"></a>4.6 将目标类型传递给自定义映射器</h2>
<p>使用 <code>@Mapper#uses()</code> 将自定义映射器与生成的映射器挂钩时，可以在自定义映射方法中定义 <code>Class</code> 类型（或其超类）的附加参数，以便针对特定的目标对象类型执行常规映射任务。该属性必须使用 <code>@TargetType</code> 进行标注，以便 MapStruct 生成与目标对象中属性对应类型一致的 <code>Class</code> 实例。</p>
<p>例如，<code>CarDto</code> 中有一个 <code>Reference</code> 类型的 <code>owner</code> 属性，它包含了 <code>Person</code> 实体的主键。现在可以创建通用的自定义映射器，将任何 <code>Reference</code> 对象解析为其对应的、由 JPA 管理的实体实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApplicationScoped</span> <span class="comment">// CDI component model</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReferenceMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BaseEntity</span>&gt; T <span class="title function_">resolve</span><span class="params">(Reference reference, </span></span><br><span class="line"><span class="params">                                            <span class="meta">@TargetType</span> Class&lt;T&gt; entityClass)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reference != <span class="literal">null</span> ? </span><br><span class="line">            entityManager.find(entityClass, reference.getPk()) : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Reference <span class="title function_">toReference</span><span class="params">(BaseEntity entity)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> entity != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">Reference</span>( entity.getPk() ) : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper(componentModel = &quot;cdi&quot;, uses = ReferenceMapper.class )</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line">    Car <span class="title function_">carDtoToCar</span><span class="params">(CarDto carDto)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GENERATED CODE</span></span><br><span class="line"><span class="meta">@ApplicationScoped</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CarMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> ReferenceMapper referenceMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">carDtoToCar</span><span class="params">(CarDto carDto)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( carDto == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>();</span><br><span class="line"></span><br><span class="line">        car.setOwner( referenceMapper.resolve( carDto.getOwner(), Owner.class ) );</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-7-传递上下文或状态对象给自定义方法"><a class="header-anchor" href="#4-7-传递上下文或状态对象给自定义方法"></a>4.7 传递上下文或状态对象给自定义方法</h2>
<p>可以通过生成的映射方法将额外上下文或状态信息传递给具有 <code>@Context</code> 参数的自定义方法。</p>
<p>这样的参数会传递给其他映射方法、适用的情况下的 <code>@ObjectFactory</code> 方法或 <code>@BeforeMapping</code>、<code>@AfterMapping</code> 方法，因此可以在自定义代码中使用。</p>
<p>在 <code>@ObjectFactory</code> 方法中搜索被 <code>@Context</code> 标记的参数，如果适用，将根据提供的上下文参数值调用这些方法。</p>
<p>还会在 <code>@BeforeMapping</code>、<code>@AfterMapping</code> 方法中搜索被 <code>@Context</code> 标记的参数，如果适用，将根据提供的上下文参数值调用这些方法。</p>
<p>注意：在调用传入上下文参数的映射方法之前，不会进行 <strong>空检查</strong>。在这种情况下，调用方需要确保没有传入 <code>null</code>。</p>
<p>为了在生成的代码中能够调用含有 <code>@Context</code> 参数的自定义方法，正在生成的映射方法的声明中也需要包含这些（或子类）<code>@Context</code> 参数。生成的代码中不会为缺少的 <code>@Context</code> 参数创建新的实例，也不会传递一个空值代替。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>使用 <code>@Context</code> 参数将数据传递给我们自定义的属性映射方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> CarDto <span class="title function_">toCar</span><span class="params">(Car car, <span class="meta">@Context</span> Locale translationLocale)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> OwnerManualDto <span class="title function_">translateOwnerManual</span><span class="params">(OwnerManual ownerManual, </span></span><br><span class="line"><span class="params">                                              <span class="meta">@Context</span> Locale locale)</span> &#123;</span><br><span class="line">    <span class="comment">// manually implemented logic to translate the OwnerManual with the given Locale</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GENERATED CODE</span></span><br><span class="line"><span class="keyword">public</span> CarDto <span class="title function_">toCar</span><span class="params">(Car car, Locale translationLocale)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( car == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CarDto</span>();</span><br><span class="line"></span><br><span class="line">    carDto.setOwnerManual( translateOwnerManual( car.getOwnerManual(), translationLocale );</span><br><span class="line">    <span class="comment">// more generated mapping code</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> carDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-8-映射方法的解析"><a class="header-anchor" href="#4-8-映射方法的解析"></a>4.8 映射方法的解析</h2>
<p>将属性从一种类型映射到另一种类型时，MapStruct 寻找将源类型映射到目标类型的最明确的方法。该方法可以是在同一个映射器接口中声明的，也可以是通过 <code>@Mapper#uses()</code> 注册的另一个映射器中声明的。这同样适用于工厂方法。</p>
<p>寻找映射方法或工厂方法的算法与 Java 的方法解析算法很类似，尤其是具有更明确源类型的方法都将被优先获取（假如有两个方法，一个方法映射寻找的源类型，另一个映射相同的父类型）。如果有多个详细程度相当的方法时，则会引发错误。</p>
<p>在使用 JAXB 时，比如将 <code>String</code> 转换为对应的 <code>JAXBElement&lt;String&gt;</code> 时，MapStruct 在寻找映射方法时将考虑 <code>@XmlElementDecl</code> 注解的 <code>scope</code> 和 <code>name</code> 属性值，这将确保创建的 <code>JAXBElement</code> 实例具有正确的 <code>QNAME</code> 值。</p>
<h2 id="4-9-基于限定符的映射方法选择"><a class="header-anchor" href="#4-9-基于限定符的映射方法选择"></a>4.9 基于限定符的映射方法选择</h2>
<p>在很多情况下需要具有相同方法签名（除了名称）但具有不同行为的映射方法。</p>
<p>MapStruct 提供 <code>@Qualifier</code>（org.mapstruct.Qualifier）注解来处理这种情况。一个“qualifier”（可译为“限定符”）可以是用户自定义的一个注解，这个注解作用在一个能被使用的映射器中的映射方法上，这个映射方法可以在对象属性映射、iterable 映射或 map 映射中被引用。一个方法和映射器上可以有多个限定符。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>假设有一个手写的映射器 <code>Titles</code>，其内部有多个参数类型是 <code>String</code>，返回值类型也是 <code>String</code> 的自定义映射方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Titles</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateTitleEG</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateTitleGE</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 Mapper 接口中需要使用到前文中手写的映射器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(uses = Titles.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MovieMapper</span> &#123;</span><br><span class="line">    GermanRelease <span class="title function_">toGerman</span><span class="params">(OriginalRelease movies)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样是有问题的，因为在手写的映射器中有多个符合条件的映射方法，MapStruct 无法区分。</p>
<p>这个时候需要使用到 <code>@Qualifier</code> 注解。</p>
<p>编写一个注解，这个注解作用于 <strong>手写的映射器</strong> 上，将 <code>@Qualifier</code> 作为元注解使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mapstruct.Qualifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TitleTranslator &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于存在多个符合条件的自定义映射方法，这些映射方法也需要使用“限定符”，再编写一些注解，这些注解作用于 <strong>自定义映射方法</strong> 上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mapstruct.Qualifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnglishToGerman &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mapstruct.Qualifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GermanToEnglish &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在手写的映射器及其内部自定义映射方法上使用这些注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TitleTranslator</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Titles</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnglishToGerman</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateTitleEG</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GermanToEnglish</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateTitleGE</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终，Mapper 会变成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(uses = Titles.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MovieMapper</span> &#123;</span><br><span class="line">     <span class="meta">@Mapping(target = &quot;title&quot;, </span></span><br><span class="line"><span class="meta">              qualifiedBy = &#123;TitleTranslator.class, EnglishToGerman.class&#125;)</span></span><br><span class="line">     GermanRelease <span class="title function_">toGerman</span><span class="params">( OriginalRelease movies )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><mark>注意：</mark></p>
<ol>
<li>编写的注解的生命周期必须是 <code>@Retention(RetentionPolicy.CLASS)</code> 的，这表示注解被编译器编译进 class 文件，但运行时会忽略。</li>
<li>用限定符标记的类或方法将不再适用于没有使用 <code>qualifiedBy</code> 属性的映射逻辑。</li>
<li>同样的机制也存在于 Bean 映射上，<code>@BeanMapping#qualifiedBy</code> 将选择用指定限定符标记的工厂方法。</li>
</ol>
<blockquote>
<p>使用 <code>@Named</code> 注解选择映射方法</p>
</blockquote>
<p>在大多数情况下，声明一个新注解来完成映射方法的选择有些大材小用。对于这些情况，MapStruct 提供了 <code>@Named</code> 的注解，使用这个注解也可以达到 <code>@Qualifier</code> 的效果。👍</p>
<p><code>@Named</code> 注解是预定义的限定符（它也被 <code>@Qualifier</code> 注解标记），<code>@Named</code> 可用于命名映射器，或者更直接地通过其 <code>value</code> 值命名映射方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention( RetentionPolicy.CLASS )</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Named &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在手写的映射器及其内部自定义映射方法上使用 <code>@Named</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Named(&quot;TitleTranslator&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Titles</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;EnglishToGerman&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateTitleEG</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;GermanToEnglish&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateTitleGE</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 Mapper 接口中不再使用 <code>@Mapping#qualifiedBy</code>，而是使用 <code>@Mapping#qualifiedByName</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper( uses = Titles.class )</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MovieMapper</span> &#123;</span><br><span class="line">     <span class="meta">@Mapping(target = &quot;title&quot;, qualifiedByName = &#123;&quot;TitleTranslator&quot;, &quot;EnglishToGerman&quot;&#125;)</span></span><br><span class="line">     GermanRelease <span class="title function_">toGerman</span><span class="params">( OriginalRelease movies )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>@Named</code> 需要定义一个限定名称并使用，而使用 <code>@Qualifier</code> 则比较麻烦，需要自定义注解。虽然两者都能达到相同的效果，但使用 <code>@Named</code> 时应当更加小心，因为在使用 <code>@Named</code> 注解时，IDE 并不会提示名称是否书写正确，也不会在重构限定符名称时像重构自定义注解的名称那样巧妙地重构代码中所有使用到的地方。</p>
<h2 id="4-10-结合限定符与默认值"><a class="header-anchor" href="#4-10-结合限定符与默认值"></a>4.10 结合限定符与默认值</h2>
<p>请注意，<code>@Mapping#defaultValue</code> 本质上是一个 <code>String</code>，需要转换为 <code>@Mapping#target</code>。使用 <code>@Mapping#qualifiedByName</code> 或 <code>@Mapping#qualifiedBy</code> 时将强制 MapStruct 使用指定的方法。如果想要 <code>@Mapping#defaultValue</code> 有不同的行为，请提供一个适当的映射方法。这个方法需要将 <code>String</code> 转换成 <code>@Mapping#target</code> 想要的类型，同时还要被限定符标记，以便 <code>@Mapping#qualifiedByName</code> 或 <code>@Mapping#qualifiedBy</code> 能够找到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MovieMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;category&quot;, </span></span><br><span class="line"><span class="meta">             qualifiedByName = &quot;CategoryToString&quot;,</span></span><br><span class="line"><span class="meta">             defaultValue = &quot;DEFAULT&quot;)</span></span><br><span class="line">    GermanRelease <span class="title function_">toGerman</span><span class="params">(OriginalRelease movies)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;CategoryToString&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">defaultValueForQualifier</span><span class="params">(Category cat)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述示例 <code>cat</code> 来源中的 <code>category</code> 如果是 <code>null</code>，<code>CategoryToString( Enum.valueOf( Category.class, &quot;DEFAULT&quot; ) )</code> 方法将被调用，其返回结果被设置给目标的 <code>category</code> 字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MovieMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;category&quot;, </span></span><br><span class="line"><span class="meta">             qualifiedByName = &quot;CategoryToString&quot;, </span></span><br><span class="line"><span class="meta">             defaultValue = &quot;Unknown&quot;)</span></span><br><span class="line">    GermanRelease <span class="title function_">toGerman</span><span class="params">(OriginalRelease movies)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;CategoryToString&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">defaultValueForQualifier</span><span class="params">(Category cat)</span> &#123;</span><br><span class="line">        <span class="comment">// some mapping logic</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;CategoryToString&quot;)</span></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">defaultValueForQualifier</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述示例 <code>cat</code> 来源中的 <code>category</code> 如果是 <code>null</code>，<code>defaultValueForQualifier( &quot;Unknown&quot; )</code> 方法将被调用（参数为 <code>String</code> 的方法），其返回结果被设置给目标的 <code>category</code> 字段。</p>
<p>如果上面提到的方法不起作用，可以使用 <code>defaultExpression</code> 来设置默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MovieMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mapping(target = &quot;category&quot;, </span></span><br><span class="line"><span class="meta">             qualifiedByName = &quot;CategoryToString&quot;, </span></span><br><span class="line"><span class="meta">             defaultExpression = &quot;java(\&quot;Unknown\&quot;)&quot;)</span></span><br><span class="line">    GermanRelease <span class="title function_">toGerman</span><span class="params">( OriginalRelease movies )</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-映射集合"><a class="header-anchor" href="#5-映射集合"></a>5. 映射集合</h1>
<h2 id="5-1-映射-Set-与-List"><a class="header-anchor" href="#5-1-映射-Set-与-List"></a>5.1 映射 Set 与 List</h2>
<p>MapStruct 也支持 Java 中各种集合类型（比如 Set、List）的映射，包括 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/tutorial/collections/intro/index.html">Java Collection Framework</a> 中各种 <mark>可迭代</mark> 类型，其使用与映射对象类型一样。🐮</p>
<p>生成的代码中将包含一个循环，在循环中遍历源集合，转换每个元素并将它们放入目标集合中。</p>
<p>如果在给定的映射器或它使用的映射器中找到集合中元素类型的映射方法，则调用此方法执行元素转换。再或者，如果存在源元素类型和目标元素类型的隐式转换，则调用那个隐式转换。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; <span class="title function_">integerSetToStringSet</span><span class="params">(Set&lt;Integer&gt; integers)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;CarDto&gt; <span class="title function_">carsToCarDtos</span><span class="params">(List&lt;Car&gt; cars)</span>;</span><br><span class="line"></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重写的 <code>integerSetToStringSet()</code> 方法为每个元素执行从 <code>Integer</code> 到 <code>String</code> 的转换，而生成的 <code>carsToCarDtos()</code> 方法为每个包含的元素调用 <code>carToCarDto()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">integerSetToStringSet</span><span class="params">(Set&lt;Integer&gt; integers)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( integers == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( Integer integer : integers ) &#123;</span><br><span class="line">        set.add( String.valueOf( integer ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CarDto&gt; <span class="title function_">carsToCarDtos</span><span class="params">(List&lt;Car&gt; cars)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cars == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;CarDto&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;CarDto&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( Car car : cars ) &#123;</span><br><span class="line">        list.add( carToCarDto( car ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当映射集合类型的属性时，MapStruct 将查找具有匹配的参数和返回类型的集合映射方法。</p>
<p>例如从 <code>Car#passengers</code>（<code>List&lt;Person&gt;</code> 类型）到 <code>CarDto#passengers</code>（<code>List&lt;PersonDto&gt;</code> 类型）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GENERATED CODE</span></span><br><span class="line">carDto.setPassengers( personsToPersonDtos( car.getPassengers() ) );</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>一些框架和库只暴露了 JavaBeans 的 Getter，而不暴露集合类型属性的 Setter。使用 JAXB 从 XML 生成的类型默认遵循这种模式。在这种情况下，用于映射这种属性的生成代码将调用其 Getter 并添加所有映射元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE</span></span><br><span class="line">carDto.getPassengers().addAll( personsToPersonDtos( car.getPassengers() ) );</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><mark>注意：</mark> 不允许使用可迭代的源和不可迭代的目标来声明映射方法（或者相反），否则会报错。</p>
<h2 id="5-2-映射-Map"><a class="header-anchor" href="#5-2-映射-Map"></a>5.2 映射 Map</h2>
<p>MapStruct 也支持映射 Map。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SourceTargetMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MapMapping(valueDateFormat = &quot;dd.MM.yyyy&quot;)</span></span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">longDateMapToStringStringMap</span><span class="params">(Map&lt;Long, Date&gt; source)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与 【5.1 映射 Set 与 List】类似，在生成的代码将遍历源 Map，转换每个 key 和 value（通过隐式转换或调用另一个映射方法），并将它们放入目标 Map 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;Long, Date&gt; <span class="title function_">stringStringMapToLongDateMap</span><span class="params">(Map&lt;String, String&gt; source)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (source == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;Long, Date&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Long, Date&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : source.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">key</span> <span class="operator">=</span> Long.parseLong(entry.getKey());</span><br><span class="line">        Date value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            value = <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;dd.MM.yyyy&quot;</span> ).parse( entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(ParseException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-集合映射策略"><a class="header-anchor" href="#5-3-集合映射策略"></a>5.3 集合映射策略</h2>
<p>参考博文：<a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_32787481/article/details/110927957">MapStruct文档（五）——集合映射</a></p>
<p>在 <code>@Mapper</code> 注解中有一个属性 <code>CollectionMappingStrategy</code>，表示集合映射策略，这个属性是个枚举类型，它有四个枚举值：</p>
<ul>
<li>
<p><code>ACCESSOR_ONLY</code></p>
</li>
<li>
<p><code>SETTER_PREFERRED</code></p>
</li>
<li>
<p><code>ADDER_PREFERRED</code></p>
</li>
<li>
<p><code>TARGET_IMMUTABLE</code></p>
</li>
</ul>
<p>目标对象中的 set、get 和 add 等方法的存在在不同场景下有不同的情况。下表介绍了目标对象在不同的集合映射策略下对 set、get 和 add 方法的应用：</p>
<table>
<thead>
<tr>
<th style="text-align:center">值</th>
<th style="text-align:center">只有 set 方法</th>
<th style="text-align:center">只有 add 方法</th>
<th style="text-align:center">set、add 方法都有</th>
<th style="text-align:center">set、add 方法都没有</th>
<th style="text-align:center">已经存在的集合对象</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ACCESSOR_ONLY</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">先 get 获取集合再a ddAll</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">先 get 获取集合再 addAll</td>
<td style="text-align:center">先 get 获取集合再 addAll</td>
</tr>
<tr>
<td style="text-align:center">SETTER_PREFERRED</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">add 集合的一项</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">先 get 获取集合再 addAll</td>
<td style="text-align:center">先 get 获取集合再 addAll</td>
</tr>
<tr>
<td style="text-align:center">ADDER_PREFERRED</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">add 集合的一项</td>
<td style="text-align:center">add 集合的一项</td>
<td style="text-align:center">先 get 获取集合再 addAll</td>
<td style="text-align:center">先 get 获取集合再 addAll</td>
</tr>
<tr>
<td style="text-align:center">TARGET_IMMUTABLE</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">异常</td>
<td style="text-align:center">直接 set 集合</td>
<td style="text-align:center">异常</td>
<td style="text-align:center">直接 set 集合</td>
</tr>
</tbody>
</table>
<p>在生成 JPA 实体的情况下，通常使用 <code>adder</code> 方法将单个元素（实体）添加到集合中。在父级（执行 <code>adder</code> 方法的实体）与子级（集合中的元素，这些元素也是实体）之间通过调用 <code>adder</code> 方法来建立父子关系。为了找到合适的 <code>adder</code>，MapStruct 将尝试在集合的泛型参数类型和候选的 <code>adder</code> 的单个参数之间进行匹配。当有更多的候选项时，复数形式的 Setter/Getter 名称将转换为单数，并用于匹配。</p>
<p>不应该显式地使用 <code>DEFAULT</code> 选项。它用于区分用户希望显式地重写 <code>@MapperConfig</code> 中的默认值与 <code>@Mapper</code> 中 MapStruct 的隐式选择。<code>DEFAULT</code> 选项与 <code>ACCESSOR_ONLY</code> 同义。</p>
<p>当使用 <code>adder</code> 方法和 JPA 实体时，MapStruct 假设目标集合是使用该集合类型对应的某种实现（比如 List 与 ArrayList）来初始化的。可以使用工厂创建带有已被初始化的集合的新目标实体，而不是 MapStruct 通过构造方法来创建目标实体。</p>
<h2 id="5-4-集合映射的实现类"><a class="header-anchor" href="#5-4-集合映射的实现类"></a>5.4 集合映射的实现类</h2>
<p>当迭代器映射方法或 Map 映射方法使用一个接口类型作为返回类型时，它的一个实现类型将在生成的代码中被实例化。具体接口类型与对应的实现类型如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Interface type</th>
<th style="text-align:center">Implementation type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>Iterable</code></td>
<td style="text-align:center"><code>ArrayList</code></td>
</tr>
<tr>
<td style="text-align:center"><code>Collection</code></td>
<td style="text-align:center"><code>ArrayList</code></td>
</tr>
<tr>
<td style="text-align:center"><code>List</code></td>
<td style="text-align:center"><code>ArrayList</code></td>
</tr>
<tr>
<td style="text-align:center"><code>Set</code></td>
<td style="text-align:center"><code>LinkedHashSet</code></td>
</tr>
<tr>
<td style="text-align:center"><code>SortedSet</code></td>
<td style="text-align:center"><code>TreeSet</code></td>
</tr>
<tr>
<td style="text-align:center"><code>NavigableSet</code></td>
<td style="text-align:center"><code>TreeSet</code></td>
</tr>
<tr>
<td style="text-align:center"><code>Map</code></td>
<td style="text-align:center"><code>LinkedHashMap</code></td>
</tr>
<tr>
<td style="text-align:center"><code>SortedMap</code></td>
<td style="text-align:center"><code>TreeMap</code></td>
</tr>
<tr>
<td style="text-align:center"><code>NavigableMap</code></td>
<td style="text-align:center"><code>TreeMap</code></td>
</tr>
<tr>
<td style="text-align:center"><code>ConcurrentMap</code></td>
<td style="text-align:center"><code>ConcurrentHashMap</code></td>
</tr>
<tr>
<td style="text-align:center"><code>ConcurrentNavigableMap</code></td>
<td style="text-align:center"><code>ConcurrentSkipListMap</code></td>
</tr>
</tbody>
</table>
<h1 id="6-映射-Stream"><a class="header-anchor" href="#6-映射-Stream"></a>6. 映射 Stream</h1>
<p><code>java.util.Stream</code> 的映射和集合的映射是类似的，即通过在映射器接口中定义具有所需源和目标类型的映射方法。</p>
<p>生成的代码将包含从所提供的迭代器或数组来创建一个 <code>Stream</code>，或者将所提供的 <code>Stream</code> 收集到一个迭代器或数组中。如果存在源元素类型和目标元素类型的映射方法或隐式转换，那么这种转换将在 <code>Stream#map()</code> 中完成。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; <span class="title function_">integerStreamToStringSet</span><span class="params">(Stream&lt;Integer&gt; integers)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;CarDto&gt; <span class="title function_">carsToCarDtos</span><span class="params">(Stream&lt;Car&gt; cars)</span>;</span><br><span class="line"></span><br><span class="line">    CarDto <span class="title function_">carToCarDto</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的 <code>integerStreamToStringSet()</code> 方法的实现为每个元素执行从 Integer 到 String 的转换，而生成的 <code>carsToCarDtos()</code> 方法的实现为每个包含的元素执行 <code>carToCarDto()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GENERATED CODE</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">integerStreamToStringSet</span><span class="params">(Stream&lt;Integer&gt; integers)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (integers == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> integers.map(integer -&gt; String.valueOf(integer))</span><br><span class="line">        .collect(Collectors.toCollection(HashSet&lt;String&gt;::<span class="keyword">new</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CarDto&gt; <span class="title function_">carsToCarDtos</span><span class="params">(Stream&lt;Car&gt; cars)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cars == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cars.map(car -&gt; carToCarDto(car))</span><br><span class="line">        .collect(Collectors.toCollection(ArrayList&lt;CarDto&gt;::<span class="keyword">new</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><mark>注意：</mark> 如果进行了从 <code>Stream</code> 到迭代器或数组的映射，那么所传递的 <code>Stream</code> 将被消费，并且不能再消费它。因为 Java 中的 <code>Stream</code> 只允许被消费（使用）一次。</p>
<p>在进行 Stream 到迭代器的映射时，迭代器的具体实现类型与【5.4 集合映射的实现类】中一致。</p>
<h1 id="7-映射值"><a class="header-anchor" href="#7-映射值"></a>7. 映射值</h1>
<h2 id="7-1-映射枚举"><a class="header-anchor" href="#7-1-映射枚举"></a>7.1 映射枚举</h2>
<p>MapStruct 支持将一种 Java 枚举类型映射到另一种 Java 枚举类型的方法的生成。</p>
<p>默认情况下，源枚举中的每个枚举项都会被映射到目标枚举类型中同名的枚举项。</p>
<p>如果需要，可以使用 <code>@ValueMapping</code> 注解（而非 <code>@Mapping</code>）将源枚举中的某个枚举项映射到另一个名称的枚举项。源枚举中的多个枚举项可以映射到目标枚举中的同一枚举项。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">OrderMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper( OrderMapper.class );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ValueMappings(&#123;</span></span><br><span class="line"><span class="meta">        @ValueMapping(source = &quot;EXTRA&quot;, target = &quot;SPECIAL&quot;),</span></span><br><span class="line"><span class="meta">        @ValueMapping(source = &quot;STANDARD&quot;, target = &quot;DEFAULT&quot;),</span></span><br><span class="line"><span class="meta">        @ValueMapping(source = &quot;NORMAL&quot;, target = &quot;DEFAULT&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    ExternalOrderType <span class="title function_">orderTypeToExternalOrderType</span><span class="params">(OrderType orderType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExternalOrderType <span class="title function_">orderTypeToExternalOrderType</span><span class="params">(OrderType orderType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (orderType == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExternalOrderType externalOrderType_;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (orderType) &#123;</span><br><span class="line">            <span class="keyword">case</span> EXTRA: </span><br><span class="line">                externalOrderType_ = ExternalOrderType.SPECIAL;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STANDARD: </span><br><span class="line">                externalOrderType_ = ExternalOrderType.DEFAULT;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NORMAL: </span><br><span class="line">                externalOrderType_ = ExternalOrderType.DEFAULT;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETAIL: </span><br><span class="line">                externalOrderType_ = ExternalOrderType.RETAIL;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> B2B: </span><br><span class="line">                externalOrderType_ = ExternalOrderType.B2B;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>( <span class="string">&quot;Unexpected enum constant: &quot;</span> + orderType );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> externalOrderType_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，如果源枚举类型的枚举项在目标枚举中没有同名的枚举项，并且也未通过 <code>@ValueMapping</code> 映射到其他枚举值，那么 MapStruct 将产生错误。这确保了所有枚举项都以一种安全且可预测的方式进行映射。如果由于某种原因出现了无法识别的源枚举项，生成的映射方法将抛出 IllegalStateException。</p>
<p>MapStruct 还具有将任何剩余（未指定的）的映射映射到默认映射的机制。这只能在同一组值映射中使用一次，并且仅适用于源。它有两种策略：<code>&lt;ANY_REMAINING&gt;</code> 和 <code>&lt;ANY_UNMAPPED&gt;</code>。<strong>它们不能同时使用。</strong> 比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ValueMapping( source = MappingConstants.ANY_REMAINING, target = &quot;SPECIAL&quot; )</span></span><br><span class="line">ExternalOrderType <span class="title function_">orderTypeToExternalOrderType</span><span class="params">(OrderType orderType)</span>;</span><br></pre></td></tr></table></figure>
<p><code>&lt;ANY_REMAINING&gt;</code>：只能用在 <code>source</code> 上。表示源枚举中除了同名自动映射和显式指定的映射外，其余所有枚举项都映射到指定的目标枚举项上（相当于 <code>switch</code> 中的 <code>default</code>）。</p>
<p><code>&lt;ANY_UNMAPPED&gt;</code>：只能用在 <code>source</code> 上，不能和 <code>&lt;ANY_REMAINING&gt;</code> 同时使用，会将源枚举中除 <strong>显式</strong> 指定的映射外（此时同名自动映射将失效）的其他剩余枚举项映射到目标枚举项上。也就是说，没有经过 <code>@ValueMapping</code> 注解 <strong>显式</strong> 指定的枚举项都会映射到目标枚举项上。</p>
<p>MapStruct 可以通过 <code>&lt;NULL&gt;</code> 处理来源的 <code>null</code> 值和目标的 <code>null</code> 值。设置在 source 上表示源枚举是 <code>null</code> 时，被映射到指定的目标枚举；设置在 target 上表示给定的来源枚举项映射到 <code>null</code>。</p>
<p>这三个值在 <code>MappingConstants</code> 类中以常量的形式存在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MappingConstants</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">MappingConstants</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NULL</span> <span class="operator">=</span> <span class="string">&quot;&lt;NULL&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANY_REMAINING</span> <span class="operator">=</span> <span class="string">&quot;&lt;ANY_REMAINING&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANY_UNMAPPED</span> <span class="operator">=</span> <span class="string">&quot;&lt;ANY_UNMAPPED&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@InheritInverseConfiguration</code> 和 <code>@InheritConfiguration</code> 可以与 <code>@ValueMappings</code> 组合使用。这种情况下，<code>&lt;ANY_REMAINING&gt;</code> 和 <code>&lt;ANY_UNMAPPED&gt;</code> 会被忽略。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SpecialOrderMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SpecialOrderMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SpecialOrderMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ValueMappings(&#123;</span></span><br><span class="line"><span class="meta">        @ValueMapping(source = MappingConstants.NULL, target = &quot;DEFAULT&quot;),</span></span><br><span class="line"><span class="meta">        @ValueMapping(source = &quot;STANDARD&quot;, target = MappingConstants.NULL),</span></span><br><span class="line"><span class="meta">        @ValueMapping(source = MappingConstants.ANY_REMAINING, target = &quot;SPECIAL&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    ExternalOrderType <span class="title function_">orderTypeToExternalOrderType</span><span class="params">(OrderType orderType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpecialOrderMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">SpecialOrderMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExternalOrderType <span class="title function_">orderTypeToExternalOrderType</span><span class="params">(OrderType orderType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( orderType == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> ExternalOrderType.DEFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExternalOrderType externalOrderType_;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ( orderType ) &#123;</span><br><span class="line">            <span class="keyword">case</span> STANDARD: externalOrderType_ = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETAIL: externalOrderType_ = ExternalOrderType.RETAIL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> B2B: externalOrderType_ = ExternalOrderType.B2B;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: externalOrderType_ = ExternalOrderType.SPECIAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> externalOrderType_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>&lt;ANY_UNMAPPED&gt;</code> 时，MapStruct 将不会自动映射 <code>RETAIL</code> 和 <code>B2B</code>。</p>
<p><strong>不建议</strong> 使用 <code>@Mapping</code> 注解将枚举映射到枚举。使用 <code>@Mapping</code> 注解来映射枚举的方式将在未来的 MapStruct 版本中删除。</p>
<h2 id="7-2-枚举与字符串的相互映射"><a class="header-anchor" href="#7-2-枚举与字符串的相互映射"></a>7.2 枚举与字符串的相互映射</h2>
<p>MapStruct 支持枚举与字符串间的相互映射，这与枚举与枚举之间的映射很类似，但也存在着部分差异。</p>
<blockquote>
<p>枚举映射到字符串</p>
</blockquote>
<ol>
<li>相同：在未显式定义映射方式的情况下，每个源枚举项被映射为具有相同名称的 <code>String</code> 值。</li>
<li>相同：<code>&lt;ANY_UNMAPPED&gt;</code> 在处理定义的映射后停止，并继续执行 switch 中 default 子句值。</li>
<li>差异：<strong>不支持</strong> <code>&lt;ANY_REMAINING&gt;</code> ，使用这个值将导致错误。它的作用前提是源枚举项和目标枚举项之间存在名称相似性，而这对于 <code>String</code> 类型没有意义。</li>
<li>差异：鉴于 <code>1.</code> 和 <code>3.</code> 因此永远不会有未映射的值。</li>
</ol>
<blockquote>
<p>字符串映射到枚举</p>
</blockquote>
<ol>
<li>相同：在未显式定义映射方式的情况下，给定的 <code>String</code> 将被映射到与目标枚举项名称匹配的值。</li>
<li>相同：<code>&lt;ANY_UNMAPPED&gt;</code> 在处理定义的映射后停止，并继续执行 switch 中 default 子句值。</li>
<li>相同：<code>&lt;ANY_REMAINING&gt;</code> 将为每个目标枚举项创建一个映射，然后继续执行 switch 中 default 子句值。</li>
<li>差异：需要提供 switch 中 default 子句才能得出确定的结果（枚举值集有限，<code>String</code> 选项不限）。不指定 <code>&lt;ANY_REMAINING&gt;</code> 或 <code>&lt;ANY_UNMAPPED&gt;</code> 将出现警告。</li>
</ol>
<blockquote>
<p>具体使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ExternalOrderType</span> &#123;</span><br><span class="line">    DEFAULT,</span><br><span class="line"></span><br><span class="line">    RETAIL,</span><br><span class="line"></span><br><span class="line">    B2B,</span><br><span class="line"></span><br><span class="line">    SPECIAL,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EnumStringMapper</span> &#123;</span><br><span class="line">    <span class="type">EnumStringMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(EnumStringMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ValueMappings(&#123;</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = MappingConstants.NULL, target = &quot;DEFAULT&quot;),</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = &quot;RETAIL&quot;, target = MappingConstants.NULL),</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = MappingConstants.ANY_UNMAPPED, target = &quot;SPECIAL&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    String <span class="title function_">enumToString</span><span class="params">(ExternalOrderType type)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ValueMappings(&#123;</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = MappingConstants.NULL, target = &quot;DEFAULT&quot;),</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = &quot;STANDARD&quot;, target = MappingConstants.NULL),</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = MappingConstants.ANY_UNMAPPED, target = &quot;SPECIAL&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    ExternalOrderType <span class="title function_">stringToEnumWithUnmapped</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ValueMappings(&#123;</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = MappingConstants.NULL, target = &quot;DEFAULT&quot;),</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = &quot;STANDARD&quot;, target = MappingConstants.NULL),</span></span><br><span class="line"><span class="meta">            @ValueMapping(source = MappingConstants.ANY_REMAINING, target = &quot;SPECIAL&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    ExternalOrderType <span class="title function_">stringToEnumWithRemaining</span><span class="params">(String str)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnumStringMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">EnumStringMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">enumToString</span><span class="params">(ExternalOrderType type)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( type == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;DEFAULT&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String string;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ( type ) &#123;</span><br><span class="line">            <span class="keyword">case</span> RETAIL: string = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: string = <span class="string">&quot;SPECIAL&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> string;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExternalOrderType <span class="title function_">stringToEnumWithUnmapped</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( str == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> ExternalOrderType.DEFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExternalOrderType externalOrderType;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ( str ) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;STANDARD&quot;</span>: externalOrderType = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: externalOrderType = ExternalOrderType.SPECIAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> externalOrderType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExternalOrderType <span class="title function_">stringToEnumWithRemaining</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( str == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> ExternalOrderType.DEFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExternalOrderType externalOrderType;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ( str ) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;STANDARD&quot;</span>: externalOrderType = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;DEFAULT&quot;</span>: externalOrderType = ExternalOrderType.DEFAULT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;RETAIL&quot;</span>: externalOrderType = ExternalOrderType.RETAIL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;B2B&quot;</span>: externalOrderType = ExternalOrderType.B2B;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;SPECIAL&quot;</span>: externalOrderType = ExternalOrderType.SPECIAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: externalOrderType = ExternalOrderType.SPECIAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> externalOrderType;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-3-自定义名称转换"><a class="header-anchor" href="#7-3-自定义名称转换"></a>7.3 自定义名称转换</h2>
<p>在未使用 <code>@ValueMapping</code> 的情况下，源枚举中的每个枚举项将 <strong>默认</strong> 映射到目标枚举中具有相同名称的枚举项。</p>
<p>但在某些情况下，源枚举需要在进行映射之前进行转换。比如目标枚举相比源枚举增加了统一的后缀呢，这时候将无法进行同名自动映射。</p>
<p>使用 <code>@ValueMapping</code> 依次指定映射规则固然可以，但相对繁琐。MapStruct 提供了一个名为 <code>@EnumMapping</code> 的注解来解决这个问题。</p>
<blockquote>
<p>具体使用</p>
</blockquote>
<p>假设有如下两个枚举：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">CheeseType</span> &#123;</span><br><span class="line">    BRIE,</span><br><span class="line">    ROQUEFORT</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">CheeseTypeSuffixed</span> &#123;</span><br><span class="line">    BRIE_TYPE,</span><br><span class="line">    ROQUEFORT_TYPE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以这样定义 Mapper 接口实现两个枚举类之间的转换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CheeseMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CheeseMapper</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper( CheeseMapper.class );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumMapping(nameTransformationStrategy = &quot;suffix&quot;, configuration = &quot;_TYPE&quot;)</span></span><br><span class="line">    CheeseTypeSuffixed <span class="title function_">map</span><span class="params">(CheeseType cheese)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InheritInverseConfiguration</span> <span class="comment">// 用于反向映射</span></span><br><span class="line">    CheeseType <span class="title function_">map</span><span class="params">(CheeseTypeSuffix cheese)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终生成的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheeseSuffixMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">CheeseSuffixMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CheeseTypeSuffixed <span class="title function_">map</span><span class="params">(CheeseType cheese)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cheese == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CheeseTypeSuffixed cheeseTypeSuffixed;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (cheese) &#123;</span><br><span class="line">            <span class="keyword">case</span> BRIE: </span><br><span class="line">                cheeseTypeSuffixed = CheeseTypeSuffixed.BRIE_TYPE;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ROQUEFORT: </span><br><span class="line">                cheeseTypeSuffixed = CheeseTypeSuffixed.ROQUEFORT_TYPE;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unexpected enum constant: &quot;</span> + cheese);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cheeseTypeSuffixed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CheeseType <span class="title function_">map</span><span class="params">(CheeseTypeSuffixed cheese)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cheese == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CheeseType cheeseType;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (cheese) &#123;</span><br><span class="line">            <span class="keyword">case</span> BRIE_TYPE: </span><br><span class="line">                cheeseType = CheeseType.BRIE;</span><br><span class="line">           		<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ROQUEFORT_TYPE: </span><br><span class="line">                cheeseType = CheeseType.ROQUEFORT;</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unexpected enum constant: &quot;</span> + cheese);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cheeseType;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MapStruct 提供了以下四种开箱即用的枚举名称转换策略：</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">suffix</td>
<td style="text-align:center">为源枚举添加后缀</td>
</tr>
<tr>
<td style="text-align:center">stripSuffix</td>
<td style="text-align:center">从源枚举中删除后缀</td>
</tr>
<tr>
<td style="text-align:center">prefix</td>
<td style="text-align:center">为源枚举添加前缀</td>
</tr>
<tr>
<td style="text-align:center">stripPrefix</td>
<td style="text-align:center">从源枚举中删除前缀</td>
</tr>
</tbody>
</table>
<p>在 MapStruct 1.5.0.Final 中新增转换策略 <code>case</code>，这种策略将为源枚举进行大小写转换，支持的方式有：</p>
<ul>
<li><code>upper</code>：将源枚举转换为大写</li>
<li><code>lower</code>：将源枚举转换为大写</li>
<li><code>capital</code>：将源枚举中每个单词的首字母大写，其余字母小写，每个单词之间以下划线分割</li>
</ul>
<p>也可以注册自定义策略，这会在后文中讲到。</p>
<h1 id="8-Spring-拓展"><a class="header-anchor" href="#8-Spring-拓展"></a>8. Spring 拓展</h1>
<p>官方文档：<a target="_blank" rel="noopener" href="https://mapstruct.org/documentation/spring-extensions/reference/html/">MapStruct Spring Extensions 1.0.0 Reference Guide</a></p>
<p>MapStruct Spring Extensions 是一个 Java 注释处理器，它扩展了著名的 MapStruct 项目并带有 Spring 框架特性。</p>
<p>在 Spring 有一个名为 <code>Converter</code>，重写该接口的 <code>convert()</code> 方法后，可以将某个对象转换成另一个对象，这与 MapStruct 的功能不谋而合。使用 MapStruct Spring Extensions 后，在编译期间将生成一个适配器，该适配器允许标准 MapStruct 映射器使用 Spring 的 <code>ConversionService</code>。</p>
<p>这使开发人员能够在其 <code>uses</code> 属性中仅使用 <code>ConversionService</code> 来定义 MapStruct 映射器，而不必单独导入每个 Mapper，从而使得各个 Mapper 之间解耦。</p>
<p><mark>注意：</mark> MapStruct Spring Extensions 至少要在 MapStruct 1.4.0.Final 的版本上运行！</p>
<h2 id="8-1-所选依赖信息"><a class="header-anchor" href="#8-1-所选依赖信息"></a>8.1 所选依赖信息</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    别用最新版，1.5.x 由 JDK11 编译    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">org.mapstruct.version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">org.mapstruct.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">org.mapstruct.extensions.spring.version</span>&gt;</span>0.1.1<span class="tag">&lt;/<span class="name">org.mapstruct.extensions.spring.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    就用这版本，否则可能出现 No property named “XXX“ exists in source parameter(s) 的错误    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lomnok.version</span>&gt;</span>1.18.12<span class="tag">&lt;/<span class="name">lomnok.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lomnok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct.extensions.spring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-spring-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.extensions.spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span> <span class="comment">&lt;!-- depending on your project --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span> <span class="comment">&lt;!-- depending on your project --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct.extensions.spring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-spring-extensions<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.extensions.spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--使用 Lombok 后，这里也要添加--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lomnok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- other annotation processors --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="8-2-映射器作为转换器"><a class="header-anchor" href="#8-2-映射器作为转换器"></a>8.2 映射器作为转换器</h2>
<p>新建 MapStruct 映射器接口，继承 Spring 的 <code>Converter</code> 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> indi.mofan.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper(componentModel = &quot;spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CarConverter</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>&lt;Car, CarDto&gt; &#123;</span><br><span class="line">    <span class="meta">@Mappings(&#123;</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;seatCount&quot;, source = &quot;numberOfSeats&quot;),</span></span><br><span class="line"><span class="meta">            @Mapping(target = &quot;manufacturingDate&quot;, source = &quot;manufacturingDate&quot;, dateFormat = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    CarDto <span class="title function_">convert</span><span class="params">(Car car)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为这个映射器编写一一段测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/26 21:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringExtensionsTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConversionService conversionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleUse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">manufacturingDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>(<span class="string">&quot;Morris&quot;</span>, <span class="number">5</span>,  <span class="string">&quot;Sedan&quot;</span>, manufacturingDate);</span><br><span class="line">        <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> conversionService.convert(car, CarDto.class);</span><br><span class="line">        Assert.assertNotNull(carDto);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;Morris&quot;</span>, carDto.getMake());</span><br><span class="line">        Assert.assertEquals(<span class="number">5</span>, carDto.getSeatCount());</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;Sedan&quot;</span>, carDto.getType());</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> format.format(manufacturingDate);</span><br><span class="line">        Assert.assertEquals(date, carDto.getManufacturingDate());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试代码后，测试并没有通过，提示 Spring 容器中不存在 <code>ConversionService</code> 的 Bean。</p>
<p>尝试在 Spring 配置类 <code>SpringConfig</code> 中添加 <code>ConversionService</code> 类型的 Bean 后，再次运行，依旧测试失败，提示不存在目标转换器。</p>
<p>因此还需要将定义的转换器注入到 <code>ConversionService</code> 类型的 Bean 中，最终 Spring 配置类中的信息如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;indi.mofan.mapper&quot;, &quot;indi.mofan.converter&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S, T&gt; DefaultConversionService <span class="title function_">conversionService</span><span class="params">(List&lt;Converter&lt;S, T&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="type">DefaultConversionService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConversionService</span>();</span><br><span class="line">        converters.forEach(service::addConverter);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>@ComponentScan</code> 注解扫描的 <code>indi.mofan.converter</code> 包为转换器所在的包。</p>
<p>最后再次运行测试方法后，测试通过。</p>
<h2 id="8-3-ConversionServiceAdapter"><a class="header-anchor" href="#8-3-ConversionServiceAdapter"></a>8.3 ConversionServiceAdapter</h2>
<p>使用 MapStruct Spring Extensions 后，会生成一个包含所有转换方法的适配器类 —— <code>ConversionServiceAdapter</code>。</p>
<p>当一个 Mapper 调用另一个 Mapper 时，需要在调用 Mapper 的 <code>@Mapper#uses</code> 属性中指定被调用的 Mapper 信息，这会造成两个 Mapper 之间的耦合。</p>
<p>利用生成的适配器类，现在只需要在 <code>@Mapper#uses</code> 指定 <code>ConversionServiceAdapter</code> 即可，而不是具体的 Mapper。</p>
<blockquote>
<p>代码示例</p>
</blockquote>
<p>被调用的 Mapper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(componentModel = &quot;spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AnimalConverter</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>&lt;Animal, DogDto&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    DogDto <span class="title function_">convert</span><span class="params">(Animal source)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的 Mapper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mapstruct.extensions.spring.converter.ConversionServiceAdapter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/27 0:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Mapper(componentModel = &quot;spring&quot;, uses = ConversionServiceAdapter.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CageConverter</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>&lt;Cage, CageDto&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;animal&quot;, target = &quot;dog&quot;)</span></span><br><span class="line">    CageDto <span class="title function_">convert</span><span class="params">(Cage source)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认生成的 <code>ConversionServiceAdapter</code> 在 <code>org.mapstruct.extensions.spring.converter</code> 包下，在未编译前，这些代码可能报错，不用担心，大胆运行！</p>
<p>还要在 Spring 的配置类中让 Spring 扫描 <code>ConversionServiceAdapter</code> 所在的包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;indi.mofan.mapper&quot;, &quot;indi.mofan.converter&quot;, &quot;org.mapstruct.extensions.spring.converter&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">	<span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUseAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Cage</span> <span class="variable">cage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cage</span>();</span><br><span class="line">    <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>(<span class="string">&quot;小黑&quot;</span>, <span class="string">&quot;Dog&quot;</span>);</span><br><span class="line">    cage.setAnimal(animal);</span><br><span class="line">    cage.setName(<span class="string">&quot;小黑的家&quot;</span>);</span><br><span class="line">    cage.setSize(<span class="string">&quot;70*50*60&quot;</span>);</span><br><span class="line">    <span class="type">CageDto</span> <span class="variable">cageDto</span> <span class="operator">=</span> conversionService.convert(cage, CageDto.class);</span><br><span class="line">    Assert.assertNotNull(cageDto);</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;小黑的家&quot;</span>, cageDto.getName());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;70*50*60&quot;</span>, cageDto.getSize());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;小黑&quot;</span>, cageDto.getDog().getName());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;Dog&quot;</span>, cageDto.getDog().getType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试方法后，测试通过！</p>
<h2 id="8-4-自定义名称"><a class="header-anchor" href="#8-4-自定义名称"></a>8.4 自定义名称</h2>
<p>默认情况下，生成的适配器名为 <code>ConversionServiceAdapter</code>，在 <code>org.mapstruct.extensions.spring.converter</code> 包下。</p>
<p>如果想要自定义名称和包名，可以使用 <code>@SpringMapperConfig</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringMapperConfig(</span></span><br><span class="line"><span class="meta">    conversionServiceAdapterPackage = &quot;indi.mofan.adapter&quot;,</span></span><br><span class="line"><span class="meta">    conversionServiceAdapterClassName = &quot;MyAdapter&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MapperSpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指定生成的适配器名为 <code>MyAdapter</code>，所在包路径为 <code>indi.mofan.adapter</code>。这样 Spring 在扫描包时就不用再扫描 <code>org.mapstruct.extensions.spring.converter</code>，直接扫描 <code>indi.mofan</code> 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;indi.mofan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">	<span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>@SpringMapperConfig</code> 注解如果没有特别指定 <code>conversionServiceAdapterPackage</code>，那么适配器类将生成在 <code>@SpringMapperConfig</code> 所标记的类的相同路径下。</p>
<h2 id="8-5-指定-ConversionService-Bean-的名称"><a class="header-anchor" href="#8-5-指定-ConversionService-Bean-的名称"></a>8.5 指定 ConversionService Bean 的名称</h2>
<p>当 Spring 容器中存在多个 <code>ConversionService</code> 类型的 Bean 时，需要指定 MapStruct Spring Extensions 所用的 <code>ConversionService</code> 类型的 Bean 的名称。</p>
<p>可以使用 <code>@SpringMapperConfig</code> 注解的 <code>conversionServiceBeanName</code> 属性进行指定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringMapperConfig(</span></span><br><span class="line"><span class="meta">    conversionServiceAdapterPackage = &quot;indi.mofan.adapter&quot;,</span></span><br><span class="line"><span class="meta">    conversionServiceAdapterClassName = &quot;MyAdapter&quot;,</span></span><br><span class="line"><span class="meta">    conversionServiceBeanName = &quot;myConversionService&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MapperSpringConfig</span> &#123;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>Spring 配置类中注入 <code>ConversionService</code> 类型的 Bean 的方法名发生变化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> &lt;S, T&gt; DefaultConversionService <span class="title function_">myConversionService</span><span class="params">(List&lt;Converter&lt;S, T&gt;&gt; converters)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Bean</code> 注解通过所标记的方法名称来指定 Bean 的名称。</p>
<p>而在依赖注入 <code>ConversionService</code> 的地方，需要使用 <code>@Qualifier</code> 注解指定 Bean 的名称，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;myConversionService&quot;)</span></span><br><span class="line"><span class="keyword">private</span> ConversionService conversionService;</span><br></pre></td></tr></table></figure>
<h2 id="8-6-外置转换"><a class="header-anchor" href="#8-6-外置转换"></a>8.6 外置转换</h2>
<p>Spring 提供了许多的内置转换，比如将 <code>String</code> 类型转换成 <code>Locale</code> 类型，将 <code>Object</code> 类型转换成 <code>Optional</code> 类型。为了使 MapStruct 在运行过程中也能使用这些转换器，可以在 <code>@SpringMapperConfig</code> 注解的 <code>externalConversions</code> 属性中指定使用的外置转换。</p>
<p>在与 Spring 的整合过程中，映射器的 <code>@Mapper</code> 注解都要指定 <code>componentModel</code> 为 <code>spring</code>，如果还有调用 Mapper 的情况，还需要指定 <code>uses</code> 为生成的适配器类型。当配置更多时，重复的 <code>@Mapper</code> 看着十分恶心，此时可以使用 <code>@MapperConfig</code> 注解来共享配置，而后在 <code>@Mapper</code> 注解中指定 <code>config</code> 属性值为 <code>@MapperConfig</code> 标记的类即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperConfig(componentModel = &quot;spring&quot;, uses = MyAdapter.class)</span></span><br><span class="line"><span class="meta">@SpringMapperConfig(</span></span><br><span class="line"><span class="meta">        conversionServiceAdapterPackage = &quot;indi.mofan.adapter&quot;,</span></span><br><span class="line"><span class="meta">        conversionServiceAdapterClassName = &quot;MyAdapter&quot;,</span></span><br><span class="line"><span class="meta">        conversionServiceBeanName = &quot;myConversionService&quot;,</span></span><br><span class="line"><span class="meta">        externalConversions = &#123;@ExternalConversion(</span></span><br><span class="line"><span class="meta">                sourceType = CarDto.class,</span></span><br><span class="line"><span class="meta">                targetType = Optional.class</span></span><br><span class="line"><span class="meta">        )&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MapperSpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新定义的转换器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper(config = MapperSpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OptionalConverter</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>&lt;NestedDto, OptionalDto&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;carDto&quot;, target = &quot;optional&quot;)</span></span><br><span class="line">    OptionalDto <span class="title function_">convert</span><span class="params">(NestedDto source)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExternalConversions</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CarDto</span>();</span><br><span class="line">    carDto.setMake(<span class="string">&quot;Morris&quot;</span>);</span><br><span class="line">    <span class="type">NestedDto</span> <span class="variable">nestedDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NestedDto</span>();</span><br><span class="line">    nestedDto.setCarDto(carDto);</span><br><span class="line"></span><br><span class="line">    <span class="type">OptionalDto</span> <span class="variable">convert</span> <span class="operator">=</span> conversionService.convert(nestedDto, OptionalDto.class);</span><br><span class="line">    Assert.assertNotNull(convert);</span><br><span class="line">    Optional&lt;CarDto&gt; optional = convert.getOptional();</span><br><span class="line">    Assert.assertNotNull(optional);</span><br><span class="line">    Assert.assertTrue(optional.isPresent());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;Morris&quot;</span>, optional.map(CarDto::getMake).orElse(<span class="string">&quot;&quot;</span>));</span><br><span class="line">    Assert.assertNull(optional.map(CarDto::getType).orElse(<span class="literal">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-7-转换-List"><a class="header-anchor" href="#8-7-转换-List"></a>8.7 转换 List</h2>
<p>完成了单个对象的转换，但对于是列表的来源数据，除了可以使用循环、Stream 等操作外，可以编写一个工具类完成转换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringExtensionHelper</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONVERSION_SERVICE_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;myConversionService&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConversionService <span class="title function_">getConversionService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> context.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">convert</span><span class="params">(Object source, Class&lt;T&gt; targetType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getConversionService().convert(source, targetType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">convert</span><span class="params">(Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getConversionService().convert(source, sourceType, targetType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, R&gt; List&lt;R&gt; <span class="title function_">convertList</span><span class="params">(List&lt;T&gt; source, Class&lt;R&gt; targetClass)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(source)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (List&lt;R&gt;) convert(</span><br><span class="line">                source,</span><br><span class="line">                TypeDescriptor.collection(List.class, TypeDescriptor.valueOf(source.get(<span class="number">0</span>).getClass())),</span><br><span class="line">                TypeDescriptor.collection(List.class, TypeDescriptor.valueOf(targetClass))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        SpringExtensionHelper.context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConvertList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>();</span><br><span class="line">    car.setMake(<span class="string">&quot;Morris&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;CarDto&gt; carDtoList = SpringExtensionHelper.convertList(Collections.singletonList(car), CarDto.class);</span><br><span class="line">    Assert.assertEquals(<span class="number">1</span>, carDtoList.size());</span><br><span class="line">    <span class="type">CarDto</span> <span class="variable">carDto</span> <span class="operator">=</span> carDtoList.get(<span class="number">0</span>);</span><br><span class="line">    Assert.assertNotNull(carDto);</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;Morris&quot;</span>, carDto.getMake());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="9-结语"><a class="header-anchor" href="#9-结语"></a>9. 结语</h1>
<p>博主精力有限（好吧，就是懒狗 🐶），暂时就翻译这么多，以上内容足以满足日常所需，更高级的特性待使用到再进行补充。</p>
<p>待完善的内容：</p>
<ul>
<li>对象工厂</li>
<li>高级映射选项</li>
<li>重用映射配置</li>
<li>自定义映射</li>
<li>使用 MapStruct SPI</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/MapStruct-User-Manual/">https://mofan212.github.io/posts/MapStruct-User-Manual/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MapStruct/">MapStruct</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/82.png" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://fastly.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">156</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a><a class="social-icon" href="https://www.travellings.cn/go.html" target="_blank" title="开往"><i class="fas fa-subway"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a target="_blank" rel="noopener" href="https://mofan212.gitee.io/mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E9%98%85%E8%AF%BB%E5%89%8D%E8%A8%80"><span class="toc-text">0. 阅读前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-MapStruct-%E6%A6%82%E8%BF%B0"><span class="toc-text">1. MapStruct 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF-MapStruct"><span class="toc-text">1.1 什么是 MapStruct</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-MapStruct-%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-text">1.2 MapStruct 配置选项</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%AE%9A%E4%B9%89%E6%98%A0%E5%B0%84%E5%99%A8"><span class="toc-text">2. 定义映射器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Hello-MapStruct"><span class="toc-text">2.1 Hello MapStruct</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%85%B3%E9%97%AD%E9%9A%90%E5%BC%8F%E6%98%A0%E5%B0%84"><span class="toc-text">2.2 关闭隐式映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Mapping-%E6%B3%A8%E8%A7%A3"><span class="toc-text">2.3 @Mapping 注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E9%BB%98%E8%AE%A4%E6%96%B9%E6%B3%95%E4%B8%8E%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-text">2.4 默认方法与抽象类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%A4%9A%E4%B8%AA%E6%BA%90%E5%8F%82%E6%95%B0"><span class="toc-text">2.5 多个源参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%A4%9A%E4%B8%AA%E5%B5%8C%E5%A5%97%E5%B1%9E%E6%80%A7%E6%98%A0%E5%B0%84"><span class="toc-text">2.6 多个嵌套属性映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E6%9B%B4%E6%96%B0%E5%AD%98%E5%9C%A8%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="toc-text">2.7 更新存在的实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-%E5%8F%8D%E5%90%91%E6%98%A0%E5%B0%84"><span class="toc-text">2.8 反向映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84"><span class="toc-text">2.9 直接使用字段映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-10-%E4%BD%BF%E7%94%A8%E6%9E%84%E5%BB%BA%E5%99%A8"><span class="toc-text">2.10 使用构建器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-11-%E4%BD%BF%E7%94%A8%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">2.11 使用构造函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-12-%E5%B0%86-Map-%E6%98%A0%E5%B0%84%E5%88%B0%E5%AF%B9%E8%B1%A1"><span class="toc-text">2.12 将 Map 映射到对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96%E6%98%A0%E5%B0%84%E5%99%A8"><span class="toc-text">3. 获取映射器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%98%A0%E5%B0%84%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-text">3.1 映射器工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-text">3.2 使用依赖注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%B3%A8%E5%85%A5%E7%AD%96%E7%95%A5"><span class="toc-text">3.3 注入策略</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-text">4. 数据类型转换</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%9A%90%E5%BC%8F%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-text">4.1 隐式类型转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%98%A0%E5%B0%84%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8"><span class="toc-text">4.2 映射对象引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%8E%A7%E5%88%B6%E5%B5%8C%E5%A5%97%E5%AF%B9%E8%B1%A1%E6%98%A0%E5%B0%84"><span class="toc-text">4.3 控制嵌套对象映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%89%A7%E8%A1%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E6%98%A0%E5%B0%84%E6%96%B9%E6%B3%95"><span class="toc-text">4.4  执行自定义映射方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E8%B0%83%E7%94%A8%E5%85%B6%E4%BB%96%E6%98%A0%E5%B0%84%E5%99%A8"><span class="toc-text">4.5  调用其他映射器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%B0%86%E7%9B%AE%E6%A0%87%E7%B1%BB%E5%9E%8B%E4%BC%A0%E9%80%92%E7%BB%99%E8%87%AA%E5%AE%9A%E4%B9%89%E6%98%A0%E5%B0%84%E5%99%A8"><span class="toc-text">4.6 将目标类型传递给自定义映射器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-%E4%BC%A0%E9%80%92%E4%B8%8A%E4%B8%8B%E6%96%87%E6%88%96%E7%8A%B6%E6%80%81%E5%AF%B9%E8%B1%A1%E7%BB%99%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95"><span class="toc-text">4.7 传递上下文或状态对象给自定义方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-%E6%98%A0%E5%B0%84%E6%96%B9%E6%B3%95%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-text">4.8 映射方法的解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-%E5%9F%BA%E4%BA%8E%E9%99%90%E5%AE%9A%E7%AC%A6%E7%9A%84%E6%98%A0%E5%B0%84%E6%96%B9%E6%B3%95%E9%80%89%E6%8B%A9"><span class="toc-text">4.9 基于限定符的映射方法选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10-%E7%BB%93%E5%90%88%E9%99%90%E5%AE%9A%E7%AC%A6%E4%B8%8E%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-text">4.10 结合限定符与默认值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%98%A0%E5%B0%84%E9%9B%86%E5%90%88"><span class="toc-text">5. 映射集合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%98%A0%E5%B0%84-Set-%E4%B8%8E-List"><span class="toc-text">5.1 映射 Set 与 List</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%98%A0%E5%B0%84-Map"><span class="toc-text">5.2 映射 Map</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E9%9B%86%E5%90%88%E6%98%A0%E5%B0%84%E7%AD%96%E7%95%A5"><span class="toc-text">5.3 集合映射策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E9%9B%86%E5%90%88%E6%98%A0%E5%B0%84%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-text">5.4 集合映射的实现类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%98%A0%E5%B0%84-Stream"><span class="toc-text">6. 映射 Stream</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E6%98%A0%E5%B0%84%E5%80%BC"><span class="toc-text">7. 映射值</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E6%98%A0%E5%B0%84%E6%9E%9A%E4%B8%BE"><span class="toc-text">7.1 映射枚举</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E6%9E%9A%E4%B8%BE%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E7%9B%B8%E4%BA%92%E6%98%A0%E5%B0%84"><span class="toc-text">7.2 枚举与字符串的相互映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8D%E7%A7%B0%E8%BD%AC%E6%8D%A2"><span class="toc-text">7.3 自定义名称转换</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Spring-%E6%8B%93%E5%B1%95"><span class="toc-text">8. Spring 拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E6%89%80%E9%80%89%E4%BE%9D%E8%B5%96%E4%BF%A1%E6%81%AF"><span class="toc-text">8.1 所选依赖信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E6%98%A0%E5%B0%84%E5%99%A8%E4%BD%9C%E4%B8%BA%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-text">8.2 映射器作为转换器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-ConversionServiceAdapter"><span class="toc-text">8.3 ConversionServiceAdapter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8D%E7%A7%B0"><span class="toc-text">8.4 自定义名称</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-%E6%8C%87%E5%AE%9A-ConversionService-Bean-%E7%9A%84%E5%90%8D%E7%A7%B0"><span class="toc-text">8.5 指定 ConversionService Bean 的名称</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-%E5%A4%96%E7%BD%AE%E8%BD%AC%E6%8D%A2"><span class="toc-text">8.6 外置转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-7-%E8%BD%AC%E6%8D%A2-List"><span class="toc-text">8.7 转换 List</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E7%BB%93%E8%AF%AD"><span class="toc-text">9. 结语</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Goodbye-2024-Hello-2025/" title="再见甲辰，你好乙巳"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/156.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="再见甲辰，你好乙巳"/></a><div class="content"><a class="title" href="/posts/Goodbye-2024-Hello-2025/" title="再见甲辰，你好乙巳">再见甲辰，你好乙巳</a><time datetime="2025-01-29T16:00:00.000Z" title="更新于 2025-01-30 00:00:00">2025-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/DataStructure-Union-Find/" title="高级数据结构之并查集"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/50.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="高级数据结构之并查集"/></a><div class="content"><a class="title" href="/posts/DataStructure-Union-Find/" title="高级数据结构之并查集">高级数据结构之并查集</a><time datetime="2025-01-01T16:00:00.000Z" title="更新于 2025-01-02 00:00:00">2025-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/FreeMarker-Template-Author's-Guide/" title="FreeMarker 模板开发"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/68.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="FreeMarker 模板开发"/></a><div class="content"><a class="title" href="/posts/FreeMarker-Template-Author's-Guide/" title="FreeMarker 模板开发">FreeMarker 模板开发</a><time datetime="2024-12-26T16:00:00.000Z" title="更新于 2024-12-27 00:00:00">2024-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/How-To-Install-Rust-On-Windows/" title="如何在 Windows 下安装 Rust"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/155.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="如何在 Windows 下安装 Rust"/></a><div class="content"><a class="title" href="/posts/How-To-Install-Rust-On-Windows/" title="如何在 Windows 下安装 Rust">如何在 Windows 下安装 Rust</a><time datetime="2024-11-22T16:00:00.000Z" title="更新于 2024-11-23 00:00:00">2024-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Algorithm-Shortest-Path/" title="【算法】图的最短路径"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/53.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【算法】图的最短路径"/></a><div class="content"><a class="title" href="/posts/Algorithm-Shortest-Path/" title="【算法】图的最短路径">【算法】图的最短路径</a><time datetime="2024-10-27T16:00:00.000Z" title="更新于 2024-10-28 00:00:00">2024-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/154.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Spring 配置类的解析"/></a><div class="content"><a class="title" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析">Spring 配置类的解析</a><time datetime="2024-10-25T16:00:00.000Z" title="更新于 2024-10-26 00:00:00">2024-10-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 默烦</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://fastly.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://fastly.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://npm.elemecdn.com/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://fastly.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script defer="defer" id="ribbon" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://fastly.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>