<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹ | Mofan</title><meta name="author" content="é»˜çƒ¦,cy.mofan@foxmail.com"><meta name="copyright" content="é»˜çƒ¦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="2023 å¹´å›½åº†å·¨çŒ®ï¼šä»æºç å±‚é¢å‰–æ SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹">
<meta property="og:url" content="https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="2023 å¹´å›½åº†å·¨çŒ®ï¼šä»æºç å±‚é¢å‰–æ SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg">
<meta property="article:published_time" content="2023-10-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-01T16:00:00.000Z">
<meta property="article:author" content="é»˜çƒ¦">
<meta property="article:tag" content="Spring-Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹",
  "url": "https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg",
  "datePublished": "2023-10-02T16:00:00.000Z",
  "dateModified": "2025-03-01T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "é»˜çƒ¦",
      "url": "https://mofan212.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":150,"languages":{"author":"ä½œè€…: é»˜çƒ¦","link":"é“¾æ¥: ","source":"æ¥æº: Mofan","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"å·²åˆ‡æ¢ä¸ºç¹ä½“ä¸­æ–‡","cht_to_chs":"å·²åˆ‡æ¢ä¸ºç®€ä½“ä¸­æ–‡","day_to_night":"å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://testingcf.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css" /><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://testingcf.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> æ–‡ç« </span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> è®¡åˆ’</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> ç»´æŠ¤</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> å…³äºæœ¬ç«™</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> å…³äºæˆ‘</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> èµåŠ©</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> é‡Œç¨‹ç¢‘</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> å¼€å¾€</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> æ–‡ç« </span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> è®¡åˆ’</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> ç»´æŠ¤</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> å…³äºæœ¬ç«™</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> å…³äºæˆ‘</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> èµåŠ©</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> é‡Œç¨‹ç¢‘</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> å¼€å¾€</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-10-02T16:00:00.000Z" title="å‘è¡¨äº 2023-10-03 00:00:00">2023-10-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-03-01T16:00:00.000Z" title="æ›´æ–°äº 2025-03-02 00:00:00">2025-03-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/Spring-Boot/">Spring-Boot</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">æ€»å­—æ•°:</span><span class="word-count">24.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>104åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;è·ç¦»æœ¬æ–‡ä¸Šæ¬¡æ›´æ–°å·²ç»è¿‡å»&quot;,&quot;messageNext&quot;:&quot;å¤©ï¼Œè¯·æ³¨æ„æ—¶æ•ˆæ€§ã€‚&quot;,&quot;postUpdate&quot;:&quot;2025-03-02 00:00:00&quot;}" hidden></div><p>å°é¢ç”»å¸ˆï¼šT5-èŒ¨èˆï¼ˆå¾®åšï¼‰â€ƒ â€ƒâ€ƒâ€ƒå°é¢IDï¼š108988374</p>
<p>æœ¬æ–‡æ¶‰åŠçš„ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/mofan212/springboot-study/tree/master/extension-point-summary">springboot-study/extension-point-summary</a></p>
<p>å‚è€ƒé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/fox9916/article/details/128522598">Springbootæ‰©å±•ç‚¹</a></p>
<blockquote>
<p>æœ¬æ–‡åŸºäº SpringBoot 3.1.x å’Œ JDK17</p>
</blockquote>
<h1 id="0-å‰è¨€"><a class="header-anchor" href="#0-å‰è¨€"></a>0. å‰è¨€</h1>
<p>Spring çš„æ ¸å¿ƒæ˜¯å®¹å™¨ï¼ŒSpringBoot åˆ™æ˜¯å¯¹ Spring çš„åˆä¸€å±‚å°è£…ï¼Œä¸€ä¸ªæ³¨è§£ã€ä¸€ä¸ªæ–¹æ³•å°†å¤æ‚åŠŸèƒ½å…¨éƒ¨éšè—ï¼Œå®ç°å¼€ç®±å³ç”¨ï¼Œä½†å¦‚æœéœ€è¦å¯¹æŸäº›åŠŸèƒ½è¿›è¡Œå®šåˆ¶ï¼Œå°±éœ€è¦åˆ©ç”¨ SpringBoot é¢„ç•™çš„æ‹“å±•ç‚¹æ¥å®ç°ã€‚</p>
<p>å­¦ä¹  SpringBoot çš„ç®€å•ä½¿ç”¨å¹¶ä¸éš¾ï¼Œå­¦ä¹  SpringBoot å¦‚ä½•å°†å¤æ‚åŠŸèƒ½è¿›è¡Œç®€åŒ–ã€é¢„ç•™çš„æ‹“å±•ç‚¹å¦‚ä½•ä½¿ç”¨æ‰æ˜¯é‡ä¸­ä¹‹é‡ã€‚</p>
<h1 id="1-åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹åŒ–å™¨"><a class="header-anchor" href="#1-åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹åŒ–å™¨"></a>1. åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹åŒ–å™¨</h1>
<h2 id="1-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#1-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>1.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹åŒ–å™¨ï¼Œå³ï¼š<code>ApplicationContextInitializer</code>ï¼Œå®ƒå¹¶éç”± SpringBoot æä¾›ï¼Œè€Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationContextInitializer</span>&lt;C <span class="keyword">extends</span> <span class="title class_">ConfigurableApplicationContext</span>&gt; &#123;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(C applicationContext)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œæ‰€æœ‰å®ç° <code>ApplicationContextInitializer</code> æ¥å£çš„ç±»éƒ½ä¼šè¢«å®ä¾‹åŒ–ï¼›åœ¨ Spring å®¹å™¨ <code>refresh</code> å‰ï¼Œ<code>ApplicationContextInitializer</code> æ‰€æœ‰å®ç°ç±»çš„ <code>initialize()</code> æ–¹æ³•éƒ½ä¼šè¢«ä¾æ¬¡è°ƒç”¨ï¼Œè°ƒç”¨é¡ºåºå¯ä½¿ç”¨ Spring æä¾›çš„ <code>Ordered</code> æ¥å£ã€<code>@Order</code> æ¥å£ç­‰æ–¹å¼è¿›è¡ŒæŒ‡å®šã€‚</p>
<p><strong><code>ApplicationContextInitializer</code> æ¥å£å¸¸ç”¨äºéœ€è¦å¯¹åº”ç”¨ä¸Šä¸‹æ–‡è¿›è¡Œåˆå§‹åŒ–çš„çš„ Web åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯”å¦‚åœ¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œè¿è¡Œç¯å¢ƒå±æ€§æˆ–æ¿€æ´»é…ç½®æ–‡ä»¶ã€‚</strong></p>
<h2 id="1-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#1-2-ä½¿ç”¨æ–¹å¼"></a>1.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>ApplicationContextInitializer</code> æ¥å£ï¼Œé‡å†™ <code>initialize()</code> æ–¹æ³•ã€‚</p>
<p>ç”±äº <code>initialize()</code> æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ç‚¹åœ¨ Spring å®¹å™¨æœªåˆå§‹åŒ–å®Œæˆå‰ï¼Œå› æ­¤å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼Œå¹¶ä»¥æ­¤æ¥æ‰§è¡Œé‡å†™çš„ <code>initialize()</code> æ–¹æ³•æ˜¯è¡Œä¸é€šçš„ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ SpringBoot çš„è‡ªåŠ¨è£…é…æœºåˆ¶ã€è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯æˆ–æ‰‹åŠ¨æ·»åŠ åˆå§‹åŒ–å™¨æ¥æ·»åŠ åˆå§‹åŒ–å™¨ã€‚</p>
<p>ç¼–å†™ <code>ApplicationContextInitializer</code> çš„ä¸‰ä¸ªå®ç°ç±»ï¼Œåœ¨å®ç°ç±»ä¸­å¢åŠ ç³»ç»Ÿå˜é‡ï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span>=<span class="string">ONE</span></span><br><span class="line"><span class="attr">2</span>=<span class="string">TWO</span></span><br><span class="line"><span class="attr">3</span>=<span class="string">THREE</span></span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FirstApplicationContextInitializer</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextInitializer</span>&lt;ConfigurableApplicationContext&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">        putProperty(context, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;ONE&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åˆ©ç”¨ SpringBoot çš„è‡ªåŠ¨è£…é…æœºåˆ¶</p>
</blockquote>
<p>åˆ›å»º <code>META-INF/spring.factories</code> æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æ·»åŠ  <code>ApplicationContextInitializer</code> çš„å®ç°ç±»ä¿¡æ¯ï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.context.ApplicationContextInitializer</span> = <span class="string">\</span></span><br><span class="line"><span class="string">  indi.mofan.summary.a01.A01ExtensionPoint.FirstApplicationContextInitializer</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯</p>
</blockquote>
<p>åˆ›å»º <code>application.properties</code> é…ç½®æ–‡ä»¶ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ä»¥ <code>context.initializer.classes</code> ä¸º Keyï¼Œæ·»åŠ  <code>ApplicationContextInitializer</code> çš„å®ç°ç±»ä¿¡æ¯ï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">context.initializer.classes</span>=<span class="string">indi.mofan.summary.a01.A01ExtensionPoint.SecondApplicationContextInitializer</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰‹åŠ¨æ·»åŠ åˆå§‹åŒ–å™¨</p>
</blockquote>
<p>åˆ›å»º <code>SpringApplication</code> å¯¹è±¡ï¼Œè°ƒç”¨å…¶ <code>addInitializers()</code> æ–¹æ³•æ‰‹åŠ¨æ·»åŠ åˆå§‹åŒ–å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/5/21 16:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A01ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(A01ExtensionPoint.class);</span><br><span class="line">        application.addInitializers(<span class="keyword">new</span> <span class="title class_">ThirdApplicationContextInitializer</span>());</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> application.run(args);</span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> context.getEnvironment();</span><br><span class="line">        System.out.println(environment.getProperty(<span class="string">&quot;1&quot;</span>)); <span class="comment">// ONE</span></span><br><span class="line">        System.out.println(environment.getProperty(<span class="string">&quot;2&quot;</span>)); <span class="comment">// TWO</span></span><br><span class="line">        System.out.println(environment.getProperty(<span class="string">&quot;3&quot;</span>)); <span class="comment">// THREE</span></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-3-å®ä¾‹åŒ–ä¸æ‰§è¡Œ"><a class="header-anchor" href="#1-3-å®ä¾‹åŒ–ä¸æ‰§è¡Œ"></a>1.3 å®ä¾‹åŒ–ä¸æ‰§è¡Œ</h2>
<blockquote>
<p>å®ä¾‹åŒ–</p>
</blockquote>
<p>åœ¨ SpringBoot ä¸­ï¼Œæ„é€  <code>SpringApplication</code> å¯¹è±¡æ—¶ä¼šè°ƒç”¨ <code>setInitializers()</code> æ–¹æ³•æ·»åŠ æ‰€æœ‰ <code>ApplicationContextInitializer</code> å®ä¾‹ã€‚è§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">        getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–æ—¶æœº</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰§è¡Œ</p>
</blockquote>
<p>è°ƒç”¨ <code>SpringApplication</code> å¯¹è±¡çš„ <code>run()</code> æ–¹æ³•æ—¶ï¼Œåœ¨æ‰§è¡Œ <code>refreshContext()</code> æ–¹æ³•å‰è°ƒç”¨ <code>prepareContext()</code> æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨ <code>applyInitializers()</code> æ–¹æ³•æ‰§è¡Œä¸Šä¸€æ­¥æ·»åŠ çš„æ‰€æœ‰ <code>ApplicationContextInitializer</code> å®ä¾‹çš„ <code>initialize()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.boot.SpringApplication#prepareContext()</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(DefaultBootstrapContext bootstrapContext, </span></span><br><span class="line"><span class="params">                            ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">                            ConfigurableEnvironment environment, </span></span><br><span class="line"><span class="params">                            SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">                            ApplicationArguments applicationArguments, </span></span><br><span class="line"><span class="params">                            Banner printedBanner)</span> &#123;</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    addAotGeneratedInitializerIfNecessary(<span class="built_in">this</span>.initializers);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ—¶æœº</span></span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-å†…ç½®å®ç°"><a class="header-anchor" href="#1-4-å†…ç½®å®ç°"></a>1.4 å†…ç½®å®ç°</h2>
<blockquote>
<p><code>DelegatingApplicationContextInitializer</code></p>
</blockquote>
<p>å®ä¾‹åŒ– <code>ApplicationContextInitializer</code> æ—¶ï¼Œæ˜¯é€šè¿‡ <code>SpringFactoriesLoader.loadFactoryNames()</code> æ–¹æ³•è·å– <code>META-INF/spring.factories</code> æ–‡ä»¶ä¸­çš„å®ç°ç±»ä¿¡æ¯ï¼Œè€Œé…ç½®æ–‡ä»¶ä¸­çš„å®ç°ç±»ä¿¡æ¯æ˜¯é€šè¿‡ <code>DelegatingApplicationContextInitializer</code> å¾—åˆ°çš„ã€‚</p>
<p>è¯¥å®ç°ç±»ä¿¡æ¯è¢« SpringBoot é»˜è®¤æ·»åŠ åˆ° <code>META-INF/spring.factories</code> æ–‡ä»¶ä¸­ï¼Œå› æ­¤èƒ½å¤Ÿç›´æ¥è·å–åˆ°å…¶å®ä¾‹ã€‚</p>
<p>è€Œååœ¨æ‰§è¡Œ <code>DelegatingApplicationContextInitializer</code> çš„ <code>initialize()</code> æ–¹æ³•æ—¶ï¼Œè·å–é…ç½®æ–‡ä»¶ä¸­çš„ <code>ApplicationContextInitializer</code> å®ç°ç±»ä¿¡æ¯ï¼Œæ„é€ å®ƒä»¬çš„å®ä¾‹å¹¶æ‰§è¡Œ <code>initialize()</code> æ–¹æ³•ã€‚</p>
<blockquote>
<p><code>ContextIdApplicationContextInitializer</code></p>
</blockquote>
<p>è¯¥å®ç°ç±»ç”¨äºè®¾ç½®åº”ç”¨ä¸Šä¸‹æ–‡ IDï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­æœªæ˜¾ç¤ºæŒ‡å®š <code>spring.application.name</code> çš„å€¼ï¼Œé‚£ä¹ˆé»˜è®¤çš„åº”ç”¨ä¸Šä¸‹æ–‡ ID ä¸º <code>application</code>ã€‚</p>
<blockquote>
<p>å…¶ä»–å†…ç½®å®ç°</p>
</blockquote>
<ul>
<li>
<p><code>ConfigurationWarningsApplicationContextInitializer</code>ï¼šæ·»åŠ åç½®å¤„ç†å™¨ <code>ConfigurationWarningsPostProcessor</code> åˆ° Spring å®¹å™¨ä¸­ï¼Œç”¨äºæ‰“å°æ·»åŠ  Bean æ—¶äº§ç”Ÿçš„è­¦å‘Šä¿¡æ¯ï¼›</p>
</li>
<li>
<p><code>ServerPortInfoApplicationContextInitializer</code>ï¼šè¯¥å®ç°ç±»ä¹Ÿå®ç°äº† <code>ApplicationListener</code> æ¥å£ï¼Œå…¶ <code>initialize()</code> æ–¹æ³•å°±æ˜¯å°†è‡ªèº«æ·»åŠ åˆ° Spring å®¹å™¨ä¸­ï¼Œç”¨äºç›‘å¬ <code>WebServerInitializedEvent</code>ï¼›</p>
</li>
<li>
<p>è¿˜æœ‰ä¸€äº›å…¶ä»–å†…ç½®å®ç°ï¼Œå…¶åŠŸèƒ½è¦ä¹ˆæ˜¯æ·»åŠ åç½®å¤„ç†å™¨ã€è¦ä¹ˆæ˜¯æ·»åŠ ç›‘å¬å™¨ï¼Œä½œç”¨éƒ½å¤§å·®ä¸å·®ã€‚</p>
</li>
</ul>
<h1 id="2-Bean-å·¥å‚åç½®å¤„ç†å™¨"><a class="header-anchor" href="#2-Bean-å·¥å‚åç½®å¤„ç†å™¨"></a>2. Bean å·¥å‚åç½®å¤„ç†å™¨</h1>
<h2 id="2-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#2-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>2.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>Bean å·¥å‚åç½®å¤„ç†å™¨ï¼Œå³ï¼š<code>BeanFactoryPostProcessor</code>ï¼Œå®ƒä¹Ÿå¹¶é SpringBoot æä¾›ï¼Œè€Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Spring ç”Ÿå‘½å‘¨æœŸå†…ï¼Œ<code>BeanFactoryPostProcessor</code> å®ä¾‹çš„ <code>postProcessBeanFactory()</code> æ–¹æ³• <strong>åªä¼š</strong> æ‰§è¡Œä¸€æ¬¡ï¼›åœ¨å®¹å™¨è¯»å–åˆ°æ‰€æœ‰çš„ <code>BeanDefinition</code> åï¼Œä½† Bean å°šæœªåˆå§‹åŒ–å‰ï¼Œè¯»å– <code>BeanDefinition</code> ä¿¡æ¯ï¼Œå¯¹å…¶ä¸­çš„å±æ€§è¿›è¡Œä¿®æ”¹æˆ–æ·»åŠ ã€‚</p>
<p><strong><code>BeanFactoryPostProcessor</code> æ¥å£å¸¸ç”¨äºä¿®æ”¹åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ç³»ç»Ÿç®¡ç†å‘˜çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ç»‘å®šçš„ Bean å±æ€§ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨è¯»å–é…ç½®æ–‡ä»¶ä¸­åŠ å¯†çš„æ•æ„Ÿä¿¡æ¯æ—¶ï¼Œå¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œè§£å¯†ã€‚</strong></p>
<h2 id="2-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#2-2-ä½¿ç”¨æ–¹å¼"></a>2.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>BeanFactoryPostProcessor</code> æ¥å£ï¼Œé‡å†™ <code>postProcessBeanFactory()</code> æ–¹æ³•ï¼Œå¹¶ <strong>å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ã€‚</strong></p>
<p><code>postProcessBeanFactory()</code> æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºå®åœ¨ Spring å®¹å™¨è¯»å–åˆ°æ‰€æœ‰ <code>BeanDefinition</code> åï¼Œå› æ­¤å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†å³å¯åœ¨å¯¹åº”æ—¶æœºæ‰§è¡Œ <code>postProcessBeanFactory()</code> æ–¹æ³•ã€‚</p>
<p>æ¯”å¦‚å®¹å™¨ä¸­å·²ç»å­˜åœ¨åä¸º <code>dog</code> çš„ Beanï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Component(&quot;dog&quot;)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;æ—ºè´¢&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨éœ€è¦ä¿®æ”¹è¯¥ Bean çš„ <code>name</code> ä¿¡æ¯ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ° <code>BeanFactoryPostProcessor</code> æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">ScannedGenericBeanDefinition</span> <span class="variable">definition</span> <span class="operator">=</span> (ScannedGenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;dog&quot;</span>);</span><br><span class="line">        <span class="type">MutablePropertyValues</span> <span class="variable">properties</span> <span class="operator">=</span> definition.getPropertyValues();</span><br><span class="line">        properties.add(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å°é»‘&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A02ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A02ExtensionPoint.class, args);</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> context.getBean(Dog.class);</span><br><span class="line">        System.out.println(dog.getName());</span><br><span class="line">        System.out.println(dog.getAge());</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
å°é»‘
2
</pre>
<h2 id="2-3-æ‰§è¡Œå…¥å£"><a class="header-anchor" href="#2-3-æ‰§è¡Œå…¥å£"></a>2.3 æ‰§è¡Œå…¥å£</h2>
<p>è¿˜æ˜¯ä»è°ƒç”¨ <code>SpringApplication</code> å¯¹è±¡çš„ <code>run()</code> æ–¹æ³•å…¥æ‰‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">        prepareContext(bootstrapContext, context, environment, </span><br><span class="line">                       listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">// åœ¨è¿™ä¸ªæ–¹æ³•é‡Œæ‰§è¡Œ</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.registerShutdownHook) &#123;</span><br><span class="line">        shutdownHook.registerApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»§ç»­è°ƒç”¨ refresh() æ–¹æ³•</span></span><br><span class="line">    refresh(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> &#123;   </span><br><span class="line">    <span class="comment">// è°ƒç”¨ applicationContext çš„ refresh() æ–¹æ³•</span></span><br><span class="line">    applicationContext.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ConfigurableApplicationContext</code> æœ‰ä¸‰ç§å®ç°ç±»ï¼Œä½†ç›´æ¥çš„å®ç°ç±»åªæœ‰ <code>AbstractApplicationContext</code> ä¸€ç§ï¼Œå¦å¤–ä¸¤ç§å®ç°ç±»åˆä¼šç»§æ‰¿ <code>AbstractApplicationContext</code>ï¼Œå› æ­¤é‡ç‚¹åˆ†æ <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•ã€‚</p>
<p><mark><code>AbstractApplicationContext#refresh()</code> æ–¹æ³•å¾ˆé‡è¦ï¼Œåç»­è¿˜ä¼šè®²åˆ°ã€‚</mark></p>
<p>åœ¨ <code>refresh()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>invokeBeanFactoryPostProcessors()</code> æ–¹æ³•ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®Œæˆå¯¹æ‰€æœ‰ <code>BeanFactoryPostProcessor</code> å®ä¾‹çš„ <code>postProcessBeanFactory()</code> æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<p><code>invokeBeanFactoryPostProcessors()</code> æ–¹æ³•åªæ˜¯ä¸€ä¸ªå…¥å£ï¼ŒçœŸæ­£çš„å®ç°æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é™¤äº†æ¥æ”¶ <code>ConfigurableListableBeanFactory</code> å¯¹è±¡å¤–ï¼Œè¿˜æ¥æ”¶äº† <code>BeanFactoryPostProcessor</code> å®ä¾‹åˆ—è¡¨ã€‚</p>
<h2 id="2-4-ç¬¬äºŒä¸ªå‚æ•°çš„æ¥æº"><a class="header-anchor" href="#2-4-ç¬¬äºŒä¸ªå‚æ•°çš„æ¥æº"></a>2.4 ç¬¬äºŒä¸ªå‚æ•°çš„æ¥æº</h2>
<p><code>BeanFactoryPostProcessor</code> å®ä¾‹åˆ—è¡¨æ˜¯ä»å“ªæ¥çš„å‘¢ï¼Ÿ</p>
<p><code>BeanFactoryPostProcessor</code> å®ä¾‹ä¸åº”è¯¥ç›´æ¥ä» BeanFactory ä¸­è·å–å—ï¼Ÿè¿™é‡Œä¼ å…¥çš„åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ä¼ å…¥çš„ <code>BeanFactoryPostProcessor</code> å®ä¾‹åˆ—è¡¨æ˜¯ <code>AbstractApplicationContext</code> ä¸­çš„ä¸€ä¸ªæˆå‘˜å˜é‡ <code>beanFactoryPostProcessors</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>æä¾›äº†é€šè¿‡ <code>addBeanFactoryPostProcessor()</code> æ–¹æ³•ä½œä¸ºä¿®æ”¹çš„æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBeanFactoryPostProcessor</span><span class="params">(BeanFactoryPostProcessor postProcessor)</span> &#123;</span><br><span class="line">   Assert.notNull(postProcessor, <span class="string">&quot;BeanFactoryPostProcessor must not be null&quot;</span>);</span><br><span class="line">   <span class="built_in">this</span>.beanFactoryPostProcessors.add(postProcessor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨è¯¥æ–¹æ³•çš„åœ°æ–¹å…±æœ‰ä¸¤å¤„ï¼š</p>
<ul>
<li><code>org.springframework.boot.SpringApplication#prepareContext()</code></li>
<li><code>org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer#initialize()</code></li>
</ul>
<p>å‰è€…ä¼šåœ¨ <code>SpringApplication#run()</code> æ–¹æ³•ä¸­ã€åœ¨ <code>refreshContext()</code> æ–¹æ³•è°ƒç”¨å‰è¢«è°ƒç”¨ï¼Œå› æ­¤åœ¨æ‰§è¡Œ <code>refresh()</code> æ–¹æ³•æ—¶èƒ½å¤Ÿæ‹¿åˆ°æ·»åŠ çš„ <code>BeanFactoryPostProcessor</code> å®ä¾‹ï¼›åè€…çš„ <code>ConfigurationWarningsApplicationContextInitializer</code> æ˜¯å…ˆå‰ä»‹ç»çš„ <code>ApplicationContextInitializer</code> çš„ä¸€ä¸ªå®ç°ç±»ï¼Œå…¶ <code>initialize()</code> æ–¹æ³•ä¼šåœ¨ <code>prepareContext()</code> æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œä¹Ÿèƒ½å¤Ÿåœ¨åç»­æ‰§è¡Œæ—¶æ‹¿åˆ°è¢«æ·»åŠ çš„ <code>BeanFactoryPostProcessor</code> å®ä¾‹ã€‚</p>
<h2 id="2-5-æ‰§è¡Œçš„é€»è¾‘"><a class="header-anchor" href="#2-5-æ‰§è¡Œçš„é€»è¾‘"></a>2.5 æ‰§è¡Œçš„é€»è¾‘</h2>
<p>åˆå›åˆ° <code>PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> æ–¹æ³•ï¼Œæºç é‡Œå…ˆæ˜¯ä¸€å¤§æ®µæ³¨é‡Šï¼Œç®€å•æ¥è¯´å°±æ˜¯ <strong>ä¸è¦çé‡æ„è¿™ä¸ªæ–¹æ³•æ¥å‡å°‘å¤šä¸ªå¾ªç¯å’Œå¤šä¸ªåˆ—è¡¨çš„ä½¿ç”¨</strong>ï¼Œå› ä¸ºé‚£æ˜¯æ•…æ„ä¸ºä¹‹çš„ï¼Œå…·ä½“æ¥è¯´æ˜¯ä¸èƒ½é€šè¿‡è°ƒç”¨ <code>getBean()</code> æ–¹æ³•è·å–æŸäº› <code>BeanFactoryPostProcessor</code>ï¼Œè¿™ä¼šåˆ°å¯¼è‡´ <code>BeanFactoryPostProcessor</code> æå‰è¢«å®ä¾‹åŒ–ï¼Œæˆ–è€…ä»¥é”™è¯¯çš„é¡ºåºåœ¨ ApplicationContext ä¸­æ³¨å†Œ <code>BeanFactoryPostProcessor</code>ï¼Œæœ€åç”šè‡³è¿˜ç»™å‡ºäº†ã€Œ<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22">è€»è¾±å¢™</a>ã€ï¼Œé‡Œé¢è¿‡æ»¤å‡ºæ‰€æœ‰è¢«æ‹’ç»çš„ç›¸å…³ PRã€‚ğŸ˜‚</p>
<p>æºç ä¸­å……æ»¡äº†æ³¨é‡Šï¼Œåƒæäº†å·¥ä½œä¸­å†™æ»¡æ³¨é‡Šä¸è®©åŒäº‹ä¹±åŠ¨çš„æ ·å­ã€‚ğŸ¤£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">    ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¦–å…ˆæ‰§è¡Œ BeanDefinitionRegistryPostProcessorsï¼Œå¦‚æœæœ‰ã€‚</span></span><br><span class="line">    <span class="comment">// processedBeans é‡Œå­˜å‚¨äº†å·²ç»å¤„ç†è¿‡çš„ Bean çš„ name</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ beanFactory æ˜¯å¦æ˜¯ BeanDefinitionRegistryï¼Œ</span></span><br><span class="line">    <span class="comment">// é€šå¸¸æ˜¯ DefaultListableBeanFactoryï¼Œå› æ­¤æ»¡è¶³æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessor æ˜¯ BeanFactoryPostProcessor çš„å­ç±»</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹ç›´æ¥ä¼ å…¥çš„ BeanFactoryPostProcessor è¿›è¡Œåˆ†ç±»å¹¶æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;</span><br><span class="line">                <span class="comment">// ç›´æ¥æ‰§è¡Œ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸åˆå§‹åŒ– FactoryBeansï¼Œéœ€è¦ä¿è¯æ‰€æœ‰å¸¸è§„ Bean æœªè¢«åˆå§‹åŒ–ï¼Œä»¥ä¾¿è®©</span></span><br><span class="line">        <span class="comment">// BeanFactoryPostProcessor å¤„ç†ä»–ä»¬ã€‚å°† BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        <span class="comment">// åˆ†æˆä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯å®ç°äº† PriorityOrderedã€å®ç°äº† Ordered å’Œå…¶ä»–çš„ã€‚</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œåˆ†ç±»çš„æ˜¯ BeanFactory ä¸­çš„ BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é¦–å…ˆæ‰§è¡Œå®ç°äº† PriorityOrdered çš„ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ’ä¸ªåº</span></span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        <span class="comment">// æ”¾åˆ°å­˜æ”¾ BeanDefinitionRegistryPostProcessor çš„æ€»é›†åˆé‡Œ</span></span><br><span class="line">        <span class="comment">// é‡Œé¢ä¸ä»…æœ‰ BeanFactory ä¸­çš„ï¼Œè¿˜æœ‰ç›´æ¥ä¼ å…¥çš„</span></span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        <span class="comment">// æ¸…ç©ºä¸‹ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨</span></span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥ä¸‹æ¥æ‰§è¡Œå®ç°äº† Ordered çš„ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰é¢åœ¨æ‰§è¡Œ BeanDefinitionRegistryPostProcessorsã€æˆ–è€…åç»­æ‰§è¡Œå…¶ä»–çš„</span></span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessors æ—¶ï¼Œå¯èƒ½ä¼šä¸€äº›æ·»åŠ  </span></span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessors çš„ BeanDefinitionï¼Œå› æ­¤è¦ä¸æ–­æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// BeanDefinitionRegistryPostProcessorsï¼Œç›´åˆ°ä¸å†å‡ºç°å…¶ä»–å¤„ç†å™¨ä¸ºæ­¢</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="literal">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰é¢å·²ç»æŠŠ BeanDefinitionRegistryPostProcessors æ‰§è¡Œäº†</span></span><br><span class="line">        <span class="comment">// æ¥ä¸‹æ¥æ‰§è¡Œæ¯ä¸ª BeanFactoryPostProcessorï¼Œä¹Ÿæ˜¯å…ˆæ‰§è¡Œ BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨åœ¨ä¸Šä¸‹æ–‡å®ä¾‹ä¸­æ³¨å†Œçš„ BeanFactoryPostProcessorï¼Œä¹Ÿå°±æ˜¯ç›´æ¥ä¼ è¿›æ¥çš„</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œä¹Ÿä¸åˆå§‹åŒ– FactoryBeansï¼Œè¦ä¿è¯æ‰€æœ‰çš„å¸¸è§„ Bean æœªè¢«åˆå§‹åŒ–ï¼Œä»¥ä¾¿è®© BeanFactoryPostProcessor å¤„ç†ä»–ä»¬</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">        beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥åŒæ ·æ˜¯åˆ†ç±»ï¼Œå°† BeanFactoryPostProcessors åˆ†æˆä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯å®ç°äº† PriorityOrderedã€</span></span><br><span class="line">    <span class="comment">// å®ç°äº† Ordered å’Œå…¶ä»–çš„ã€‚</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// åœ¨å‰é¢å¤„ç†è¿‡çš„ï¼Œç›´æ¥è·³è¿‡</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œæ²¡æœ‰ç›´æ¥é€šè¿‡ getBean() è·å–ï¼Œå› ä¸º getBean() ä¼šå¯¼è‡´ Bean æå‰åˆå§‹åŒ–</span></span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¦–å…ˆæ‰§è¡Œå®ç°äº† PriorityOrdered çš„ BeanFactoryPostProcessors</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥æ‰§è¡Œå®ç°äº† Ordered çš„ BeanFactoryPostProcessors</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åæ‰§è¡Œå…¶ä»–çš„ BeanFactoryPostProcessors</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤åˆå¹¶çš„ BeanDefinitionï¼Œå› ä¸ºåç½®å¤„ç†å™¨ä¸­å¯èƒ½å·²ç»ä¿®æ”¹äº†åŸå§‹å…ƒæ•°æ®ï¼Œ</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚æ›¿æ¢ value ä¸­çš„å ä½ç¬¦</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> æ–¹æ³•ä¸ä»…å¤„ç†äº† <code>BeanFactoryPostProcessor</code>ï¼Œè¿˜å¤„ç†äº† <code>BeanDefinitionRegistryPostProcessor</code>ï¼Œåè€…è¢«ç§°ä¸ºã€ŒBean å®šä¹‰æ³¨å†Œè¡¨åç½®å¤„ç†å™¨ã€ï¼Œæ˜¯ä¸€ç§å®¹å™¨çº§çš„åç½®å¤„ç†å™¨ï¼Œé‚£å®ƒåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h1 id="3-Bean-å®šä¹‰æ³¨å†Œè¡¨åç½®å¤„ç†å™¨"><a class="header-anchor" href="#3-Bean-å®šä¹‰æ³¨å†Œè¡¨åç½®å¤„ç†å™¨"></a>3. Bean å®šä¹‰æ³¨å†Œè¡¨åç½®å¤„ç†å™¨</h1>
<h2 id="3-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#3-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>3.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>Bean å®šä¹‰æ³¨å†Œè¡¨åç½®å¤„ç†å™¨ï¼Œå³ï¼š<code>BeanDefinitionRegistryPostProcessor</code>ï¼Œå®ƒåŒæ ·å¹¶é SpringBoot æä¾›ï¼Œä¹Ÿæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯å®¹å™¨çº§åˆ«çš„åç½®å¤„ç†å™¨ï¼Œå°†åœ¨ Spring å®¹å™¨åˆå§‹åŒ–åã€<code>refresh</code> å‰ï¼ˆå³ Bean è¢«æŠ½è±¡æˆ <code>BeanDefinition</code> åã€æœªå®ä¾‹åŒ–å‰ï¼‰æ‰§è¡Œã€‚</p>
<p>æä¾›äº† <code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>BeanDefinitionRegistry</code> èƒ½å¤Ÿå¯¹ BeanDefinition è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚</p>
<p>è¯¥æ¥å£ç»§æ‰¿äº† <code>BeanFactoryPostProcessor</code> æ¥å£ï¼Œæ˜¯å®ƒçš„ä¸€ä¸ªæ‹“å±•ï¼Œé€šè¿‡å‰æ–‡çš„ä»‹ç»å¯çŸ¥å®ƒä»¬éƒ½æ˜¯åœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­è¢«æ‰§è¡Œçš„ï¼Œåªä¸è¿‡ <code>BeanDefinitionRegistryPostProcessor</code> è¾ƒ <code>BeanFactoryPostProcessor</code> <strong>æ›´å…ˆ</strong> æ‰§è¡Œï¼Œå› æ­¤ <strong>å¯ä»¥ä½¿ç”¨ <code>BeanDefinitionRegistryPostProcessor</code> å¯ä»¥ç”¨æ¥æ³¨å†Œ <code>BeanFactoryPostProcessor</code> çš„ BeanDefinition</strong>ã€‚</p>
<h2 id="3-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#3-2-ä½¿ç”¨æ–¹å¼"></a>3.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£ï¼Œé‡å†™ <code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•ï¼Œå¹¶ <strong>å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ã€‚</strong></p>
<p>æ¯”å¦‚å­˜åœ¨ <code>Cat</code> ç±»ï¼Œå®ƒå¹¶æœªäº¤ç”± Spring ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™å®ç°ç±»ï¼Œå®ç° <code>BeanDefinitionRegistryPostProcessor</code> æ¥å£ï¼Œå°è¯•æ³¨å†Œ <code>Cat</code> ç±»å‹çš„ BeanDefinitionï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry beanDefinitionRegistry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>();</span><br><span class="line">        beanDefinition.setBeanClass(Cat.class);</span><br><span class="line">        <span class="type">PropertyValue</span> <span class="variable">name</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyValue</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;å¤§æ©˜&quot;</span>);</span><br><span class="line">        <span class="type">PropertyValue</span> <span class="variable">age</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyValue</span>(<span class="string">&quot;age&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">MutablePropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>(Arrays.asList(name, age));</span><br><span class="line">        beanDefinition.setPropertyValues(propertyValues);</span><br><span class="line">        <span class="comment">// æ‰‹åŠ¨æ³¨å†Œ</span></span><br><span class="line">        beanDefinitionRegistry.registerBeanDefinition(<span class="string">&quot;cat&quot;</span>, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> (RootBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;cat&quot;</span>);</span><br><span class="line">        <span class="type">MutablePropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> beanDefinition.getPropertyValues();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŸå§‹å¹´é¾„æ˜¯: &quot;</span> + propertyValues.get(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">        <span class="comment">// æ·»åŠ åä¸º age çš„ propertyï¼Œä½†å·²ç»å­˜åœ¨åŒåçš„ propertyï¼Œä¼šä»¥æ–°åŠ çš„ä¸ºå‡†</span></span><br><span class="line">        propertyValues.add(<span class="string">&quot;age&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨é‡å†™çš„ <code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•ä¸­æ‰‹åŠ¨æ³¨å†Œ <code>Cat</code> ç±»å‹ã€åä¸º <code>cat</code> çš„ BeanDefinitionï¼Œå¹¶æ·»åŠ äº†åä¸º <code>age</code> çš„ propertyï¼›åœ¨é‡å†™çš„ <code>postProcessBeanFactory()</code> æ–¹æ³•ä¸­è·å–åä¸º <code>cat</code> çš„ BeanDefinitionï¼Œç„¶åæ·»åŠ åŒåçš„ propertyï¼Œæ–°å€¼å°†è¦†ç›–æ—§å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A03ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A03ExtensionPoint.class, args);</span><br><span class="line">        <span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> context.getBean(Cat.class);</span><br><span class="line">        System.out.println(cat.getName());</span><br><span class="line">        System.out.println(cat.getAge());</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
åŸå§‹å¹´é¾„æ˜¯: 1
å¤§æ©˜
2
</pre>
<h2 id="3-3-ç›¸å…³çš„å‡ ä¸ªç±»"><a class="header-anchor" href="#3-3-ç›¸å…³çš„å‡ ä¸ªç±»"></a>3.3 ç›¸å…³çš„å‡ ä¸ªç±»</h2>
<p><code>BeanDefinition</code> æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><code>postProcessBeanDefinitionRegistry()</code> æ–¹æ³•çš„å…¥å‚ <code>BeanDefinitionRegistry</code> æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><code>postProcessBeanFactory()</code> æ–¹æ³•çš„å…¥å‚ <code>ConfigurableListableBeanFactory</code> åˆæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç†è§£è¿™äº›ç±»çš„å«ä¹‰æœ‰åŠ©äºæ›´å¥½åœ°ç†è§£ Spring æ‹“å±•ç‚¹ã€‚</p>
<blockquote>
<p><code>BeanDefinition</code></p>
</blockquote>
<p><code>BeanDefinition</code> æ„ä¸ºã€ŒBean å®šä¹‰ã€ï¼Œæ˜¯ç”¨æ¥å®šä¹‰ Bean çš„ã€‚</p>
<p>Spring å®¹å™¨ä¸­ Bean çš„æ¥æºæœ‰å¤šç§ï¼ŒBean çš„ç±»å‹åˆæœ‰å¤šç§ï¼Œå¦‚ä½•å°†è¿™äº›ä¸åŒæ¥æºã€ä¸åŒç±»å‹çš„ Bean ä½¿ç”¨åŒä¸€ç§æ–¹å¼æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­å°±æˆäº†ä¸ªé—®é¢˜ã€‚</p>
<p>å®šä¹‰ <code>BeanDefinition</code> ç±»ï¼Œå®ƒå°†ä¸åŒçš„ Bean ä¿¡æ¯è¿›è¡ŒæŠ½è±¡æˆ <code>BeanDefinition</code> å¯¹è±¡ï¼Œåœ¨ä¸åŒæ—¶æœºæ ¹æ® <code>BeanDefinition</code> å¯¹è±¡å¯¹ Bean è¿›è¡Œå®ä¾‹åŒ–ã€‚</p>
<blockquote>
<p><code>BeanDefinitionRegistry</code></p>
</blockquote>
<p><code>BeanDefinitionRegistry</code> æ„ä¸ºã€ŒBean å®šä¹‰æ³¨å†Œå™¨ã€ï¼Œæ˜¯ç”¨æ¥æ³¨å†Œ <code>BeanDefinition</code> çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title class_">AliasRegistry</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ³¨å†Œ BeanDefinition</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span><br><span class="line">         <span class="keyword">throws</span> BeanDefinitionStoreException;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ é™¤ BeanDefinition</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">removeBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å– BeanDefinition</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   BeanDefinition <span class="title function_">getBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ¤æ–­æŒ‡å®šåç§°çš„ BeanDefinition æ˜¯å¦å·²ç»è¢«æ³¨å†Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">containsBeanDefinition</span><span class="params">(String beanName)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å–æ‰€æœ‰ BeanDefinition çš„åç§°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   String[] getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ³¨å†Œçš„ BeanDefinition çš„æ•°é‡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="type">int</span> <span class="title function_">getBeanDefinitionCount</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç¡®å®šç»™å®šçš„ Bean åç§°æ˜¯å¦å·²åœ¨æ³¨å†Œå™¨ä¸­ä½¿ç”¨ï¼Œå³æ˜¯å¦æœ‰æœ¬åœ° Bean æˆ–åˆ«ååœ¨æ­¤åç§°ä¸‹æ³¨å†Œã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isBeanNameInUse</span><span class="params">(String beanName)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AliasRegistry</code> ç”¨äºç®¡ç†åˆ«åï¼Œä½œä¸º <code>BeanDefinitionRegistry</code> çš„çˆ¶ç±»ã€‚</p>
<blockquote>
<p><code>ConfigurableListableBeanFactory</code></p>
</blockquote>
<p><code>ConfigurableListableBeanFactory</code> æ„ä¸ºã€Œå¯é…ç½®çš„åˆ—è¡¨ Bean å·¥å‚ã€ã€‚æ‰€è°“ Spring å®¹å™¨ï¼ŒæŒ‡çš„å°±æ˜¯ <code>BeanFactory</code>ï¼Œå®ƒæä¾›äº†å¤šç§é‡è½½çš„ <code>getBean()</code> æ–¹æ³•ç”¨äºè·å– Beanï¼Œè€Œ <code>ConfigurableListableBeanFactory</code> æ˜¯ <code>BeanFactory</code> çš„ä¸€ä¸ªå­æ¥å£ï¼Œå¯ä»¥è®¤ä¸ºå®ƒå°±æ˜¯ Spring å®¹å™¨ã€‚</p>
<p>åœ¨ Spring ä¸­ï¼Œå…¶é»˜è®¤å®ç°æ˜¯ <code>DefaultListableBeanFactory</code>ï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/DefaultListableBeanFactory%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="DefaultListableBeanFactoryçš„ç±»å›¾"></p>
<p>å®ƒç»§æ‰¿äº†å¾ˆå¤šæ¥å£ï¼ŒåŒ…æ‹¬ <code>ConfigurableListableBeanFactory</code>ã€<code>BeanDefinitionRegistry</code> ç­‰ç­‰ã€‚</p>
<h2 id="3-4-å®ä¾‹åŒ–ä¸æ‰§è¡Œ"><a class="header-anchor" href="#3-4-å®ä¾‹åŒ–ä¸æ‰§è¡Œ"></a>3.4 å®ä¾‹åŒ–ä¸æ‰§è¡Œ</h2>
<p>å‚è€ƒã€2.3 å®ä¾‹åŒ–ä¸æ‰§è¡Œã€‘å³å¯ã€‚</p>
<h2 id="3-5-å†…ç½®å®ç°"><a class="header-anchor" href="#3-5-å†…ç½®å®ç°"></a>3.5 å†…ç½®å®ç°</h2>
<p><code>BeanDefinitionRegistryPostProcessor</code> åœ¨ Spring å’Œ SpringBoot ä¸­æœ‰ä¼—å¤šå†…ç½®å®ç°ï¼Œå®ƒä»¬çš„å¤§è‡´é€»è¾‘éƒ½å·®ä¸å¤šï¼Œéƒ½æ˜¯æ³¨å†Œäº†ä¸€äº›ç‰¹æ®Šçš„ <code>BeanDefinition</code>ã€‚</p>
<p>åœ¨ Spring ä¸­æœ‰ä¸€ä¸ªåä¸º <code>ConfigurationClassPostProcessor</code> çš„å®ç°ç±»ï¼Œç”¨äºè§£æ <code>@Configuration</code> æ³¨è§£ï¼Œå¯ä»¥å‚è€ƒ <a href="../Configuration-Annotation/">@Configuration æ³¨è§£çš„é‚£äº›äº‹</a> ä¸€æ–‡ã€‚</p>
<h1 id="4-Bean-åç½®å¤„ç†å™¨"><a class="header-anchor" href="#4-Bean-åç½®å¤„ç†å™¨"></a>4. Bean åç½®å¤„ç†å™¨</h1>
<h2 id="4-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#4-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>4.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>Bean åç½®å¤„ç†å™¨ï¼Œå³ï¼š<code>BeanPostProcessor</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆå§‹åŒ–å‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">default</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆå§‹åŒ–åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">default</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ Bean çº§åˆ«çš„åç½®å¤„ç†å™¨ï¼Œåœ¨ Bean å®ä¾‹åŒ–åæ‰§è¡Œã€‚å•ä¾‹ Bean è¢«å®ä¾‹åŒ–åï¼Œæœ€ç»ˆä¼šè¢«ç¼“å­˜åˆ° <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#singletonObjects</code> ä¸­ï¼Œåœ¨å®ä¾‹åŒ–ä¹‹åä¼šè¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å±æ€§å¡«å……ã€è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ç­‰ï¼Œ<code>BeanPostProcessor</code> å°±æ˜¯å¯¹è¿™ä¸ªé˜¶æ®µè¿›è¡Œçš„æ‹“å±•ã€‚</p>
<p>æ³¨æ„å®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„åŒºåˆ«ï¼Œå®ä¾‹åŒ–æŒ‡çš„æ˜¯ <code>new</code> å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆå§‹åŒ–æŒ‡çš„æ˜¯ç»™ <code>new</code> å‡ºçš„å¯¹è±¡è¿›è¡Œå±æ€§å¡«å……ç­‰æ“ä½œã€‚</p>
<p><code>BeanPostProcessor</code> æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ <code>postProcessBeforeInitialization()</code> å’Œ <code>postProcessAfterInitialization()</code>ï¼Œå‰è€…å°†åœ¨ Bean å®ä¾‹åŒ–åã€åˆå§‹åŒ–å‰æ‰§è¡Œï¼Œåè€…å°†åœ¨åˆå§‹åŒ–åã€è‡ªå®šä¹‰åˆå§‹æ–¹æ³•åæ‰§è¡Œã€‚</p>
<p><code>BeanPostProcessor</code> ä¸å…ˆå‰çš„æ‰€æœ‰æ‹“å±•ç‚¹éƒ½ä¸åŒï¼Œå¹¶ä¸æ˜¯åªæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œæ˜¯ä¼šä½œç”¨äº Spring ç®¡ç†çš„æ¯ä¸ª Beanã€‚</p>
<h2 id="4-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#4-2-ä½¿ç”¨æ–¹å¼"></a>4.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>BeanPostProcessor</code> æ¥å£ï¼Œé‡å†™æŠ½è±¡æ–¹æ³•ï¼Œå¹¶ <strong>å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ã€‚</strong></p>
<p>æ¯”å¦‚å­˜åœ¨ <code>Fish</code> ç±»ï¼Œé‡‡ç”¨é…ç½®ç±»çš„æ–¹å¼å°†å…¶äº¤ç”± Spring ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Fish</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Double weight;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Fish</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. æ‰§è¡Œäº†æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. æ‰§è¡Œäº† afterPropertiesSet() æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4. æ‰§è¡Œäº† init() æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A04Configuration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(name = &quot;fish&quot;, initMethod = &quot;init&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Fish <span class="title function_">fish</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Fish</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™ <code>BeanPostProcessor</code> çš„å®ç°ç±»ï¼Œé‡å†™å…¶ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå½“é‡åˆ°åä¸º <code>fish</code> çš„ Bean æ—¶ï¼Œæ‰§è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;fish&quot;</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2. æ‰§è¡Œäº† postProcessBeforeInitialization() æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;fish&quot;</span>.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;5. æ‰§è¡Œäº† postProcessAfterInitialization() æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A04ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A04ExtensionPoint.class, args);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. æ‰§è¡Œäº†æ— å‚æ„é€ 
2. æ‰§è¡Œäº† postProcessBeforeInitialization() æ–¹æ³•
3. æ‰§è¡Œäº† afterPropertiesSet() æ–¹æ³•
4. æ‰§è¡Œäº† init() æ–¹æ³•
5. æ‰§è¡Œäº† postProcessAfterInitialization() æ–¹æ³•
</pre>
<h2 id="4-3-æ³¨å†Œä¸æ‰§è¡Œ"><a class="header-anchor" href="#4-3-æ³¨å†Œä¸æ‰§è¡Œ"></a>4.3 æ³¨å†Œä¸æ‰§è¡Œ</h2>
<p>å‰æ–‡ä¸­å·²ç»ä»‹ç»è¿‡ <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•äº†ï¼Œ<code>BeanPostProcessor</code> çš„æ³¨å†Œä¸æ‰§è¡Œä¹Ÿå°†å›´ç»•è¿™ä¸ªæ–¹æ³•ã€‚</p>
<blockquote>
<p>æ³¨å†Œ</p>
</blockquote>
<p>åœ¨ <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>registerBeanPostProcessors()</code> æ–¹æ³•ï¼Œè§åä¹‹æ„ï¼Œè¯¥æ–¹æ³•å®Œæˆäº† <code>BeanPostProcessor</code> çš„æ³¨å†Œã€‚</p>
<p>å®ƒåªæ˜¯ä¸€ä¸ªå…¥å£ï¼ŒçœŸæ­£çš„å®ç°æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, org.springframework.context.support.AbstractApplicationContext)</span><br></pre></td></tr></table></figure>
<p><code>PostProcessorRegistrationDelegate</code> å¾ˆç†Ÿæ‚‰ï¼Œ<code>BeanFactoryPostProcessor</code> ä¸ <code>BeanDefinitionRegistryPostProcessor</code> çš„æ‰§è¡Œä¹Ÿæ˜¯ä½¿ç”¨çš„è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•ã€‚</p>
<p><code>registerBeanPostProcessors()</code> ä¸å‰æ–‡ä»‹ç»çš„ <code>invokeBeanFactoryPostProcessors()</code> æ–¹æ³•å¾ˆç±»ä¼¼ï¼Œå†…éƒ¨å……æ»¡äº†æ³¨é‡Šï¼Œä¹Ÿå‘Šè¯‰æƒ³è¦æäº¤ PR çš„å¼€å‘è€…ä¸è¦çé‡æ„ã€‚ğŸ˜‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">        ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¦–å…ˆè·å–æ‰€æœ‰ BeanPostProcessor åœ¨ Spring å®¹å™¨ä¸­çš„åç§°</span></span><br><span class="line">    String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œ BeanPostProcessorCheckerï¼Œå½“ä¸€ä¸ª Bean åœ¨ BeanPostProcessor å®ä¾‹åŒ–è¿‡ç¨‹</span></span><br><span class="line">    <span class="comment">// ä¸­è¢«åˆ›å»ºæ—¶ï¼Œå³ä¸€ä¸ª Bean ä¸ç¬¦åˆæ‰€æœ‰ BeanPostProcessor çš„å¤„ç†æ¡ä»¶æ—¶ï¼Œä¼šè®°å½•ä¸€æ¡æ—¥å¿—</span></span><br><span class="line">    <span class="comment">// ç®€å•æ¥è¯´å°±æ˜¯æ³¨å†Œ BeanPostProcessorChecker ç”¨æ¥æ‰“å°æ—¥å¿—</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">beanProcessorTargetCount</span> <span class="operator">=</span> beanFactory.getBeanPostProcessorCount() + <span class="number">1</span> + postProcessorNames.length;</span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">BeanPostProcessorChecker</span>(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† BeanPostProcessor åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯å®ç°äº† PriorityOrderedã€å®ç°äº†</span></span><br><span class="line">    <span class="comment">// Ordered å’Œå…¶ä»–çš„</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// å­˜æ”¾ MergedBeanDefinitionPostProcessorï¼Œå®ƒæ˜¯ BeanPostProcessor çš„ä¸€ä¸ªå­ç±»</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            <span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">            priorityOrderedPostProcessors.add(pp);</span><br><span class="line">            <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">                internalPostProcessors.add(pp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¦–å…ˆæ³¨å†Œå®ç°äº† PriorityOrdered çš„ BeanPostProcessors</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥æ³¨å†Œå®ç°äº† Ordered çš„ BeanPostProcessors</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">        <span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        orderedPostProcessors.add(pp);</span><br><span class="line">        <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç„¶åæ‰§è¡Œæ‰€æœ‰å¸¸è§„çš„ BeanPostProcessors.</span></span><br><span class="line">    List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        <span class="type">BeanPostProcessor</span> <span class="variable">pp</span> <span class="operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        nonOrderedPostProcessors.add(pp);</span><br><span class="line">        <span class="keyword">if</span> (pp <span class="keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åï¼Œé‡æ–°æ³¨å†Œæ‰€æœ‰å†…éƒ¨ BeanPostProcessors</span></span><br><span class="line">    sortPostProcessors(internalPostProcessors, beanFactory);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°æ³¨å†Œåç½®å¤„ç†å™¨ï¼Œä»¥ä¾¿å°†å†…éƒ¨ Bean æ£€æµ‹ä¸º ApplicationListenersï¼Œ</span></span><br><span class="line">    <span class="comment">// å°†å…¶ç§»åˆ°å¤„ç†å™¨é“¾çš„æœ«ç«¯ï¼ˆç”¨äºæ‹¾å–ä»£ç†ç­‰ï¼‰ã€‚</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•æ¥è¯´å°±æ˜¯å…ˆè·å–å®¹å™¨ä¸­çš„æ‰€æœ‰ <code>BeanPostProcessor</code>ï¼Œç„¶åæŒ‰ç…§ä¼˜å…ˆçº§åˆ†æˆä¸‰ç±»å†ä¾æ¬¡æ³¨å†Œã€‚</p>
<p>æ³¨å†Œçš„é€»è¾‘é‡‡ç”¨ <code>registerBeanPostProcessors()</code> æ–¹æ³•å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBeanPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">    ConfigurableListableBeanFactory beanFactory, </span></span><br><span class="line"><span class="params">    List&lt;? extends BeanPostProcessor&gt; postProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> AbstractBeanFactory abstractBeanFactory) &#123;</span><br><span class="line">        <span class="comment">// Bulk addition is more efficient against our CopyOnWriteArrayList there</span></span><br><span class="line">        abstractBeanFactory.addBeanPostProcessors(postProcessors);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">            beanFactory.addBeanPostProcessor(postProcessor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>beanFactory</code> çš„ <code>addBeanPostProcessor()</code> æ–¹æ³•å®Œæˆ <code>BeanPostProcessor</code> çš„æ³¨å†Œï¼Œæœ€ç»ˆç”± <code>AbstractBeanFactory#addBeanPostProcessor()</code> å®ç°çœŸæ­£çš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;BeanPostProcessor&gt; beanPostProcessors = <span class="keyword">new</span> <span class="title class_">BeanPostProcessorCacheAwareList</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBeanPostProcessor</span><span class="params">(BeanPostProcessor beanPostProcessor)</span> &#123;</span><br><span class="line">   Assert.notNull(beanPostProcessor, <span class="string">&quot;BeanPostProcessor must not be null&quot;</span>);</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.beanPostProcessors) &#123;</span><br><span class="line">      <span class="comment">// Remove from old position, if any</span></span><br><span class="line">      <span class="built_in">this</span>.beanPostProcessors.remove(beanPostProcessor);</span><br><span class="line">      <span class="comment">// Add to end of list</span></span><br><span class="line">      <span class="built_in">this</span>.beanPostProcessors.add(beanPostProcessor);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰§è¡Œ</p>
</blockquote>
<p><code>BeanPostProcessor</code> å°†åœ¨ Bean å®ä¾‹åŒ–åï¼Œåˆå§‹åŒ–å‰åæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦æ‰¾åˆ° Bean å®ä¾‹åŒ–çš„ä½ç½®ï¼Œé‚£ <code>BeanPostProcessor</code> çš„æ‰§è¡Œæ—¶æœºä¹Ÿå°±åœ¨é‚£é™„è¿‘äº†ã€‚</p>
<p>åœ¨ <code>refresh()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>finishBeanFactoryInitialization()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">finishBeanFactoryInitialization(beanFactory);</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸Šçš„æ³¨é‡Šï¼šå®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„éæ‡’åŠ è½½å•ä¾‹ Beanã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•å°†å®Œæˆ Bean çš„å®ä¾‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„ conversion service</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">        beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¹‹å‰æ²¡æœ‰æ³¨å†Œä»»ä½• BeanFactoryPostProcessorï¼Œ</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚ PropertySourcesPlaceholderConfigurerï¼Œé‚£ä¹ˆæ³¨å†Œé»˜è®¤çš„</span></span><br><span class="line">    <span class="comment">// åµŒå…¥å€¼è§£æå™¨ç”¨äºæ³¨è§£å±æ€§å€¼çš„è§£æ</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">        beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°½æ—©åˆå§‹åŒ– LoadTimeWeaverAware ä»¥ä¾¿å°½æ—©æ³¨å†Œå®ƒä»¬çš„è½¬æ¢å™¨</span></span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢ä½¿ç”¨ä¸´æ—¶ ClassLoader è¿›è¡Œç±»å‹åŒ¹é…</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…è®¸ç¼“å­˜æ‰€æœ‰ BeanDefinition å…ƒæ•°æ®ï¼Œä¸æœŸå¾…è¿›ä¸€æ­¥æ›´æ”¹</span></span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„éæ‡’åŠ è½½å•ä¾‹ Bean</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶ï¼Œé‡ç‚¹æ˜¯æœ€åè°ƒç”¨ <code>beanFactory</code> çš„ <code>preInstantiateSingletons()</code> æ–¹æ³•ã€‚</p>
<p>å…¶é»˜è®¤å®ç°æ˜¯ <code>DefaultListableBeanFactory</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹ copy å‰¯æœ¬è¿›è¡Œéå†ï¼Œä»¥å…è®¸ init æ–¹æ³•åè¿‡æ¥æ³¨å†Œæ–°çš„ BeanDefinition</span></span><br><span class="line">    <span class="comment">// è™½ç„¶è¿™å¯èƒ½ä¸æ˜¯å¸¸è§„å·¥å‚å¯åŠ¨çš„ä¸€éƒ¨åˆ†ï¼Œä½†åœ¨å…¶ä»–æ–¹é¢è¿è¡Œè‰¯å¥½</span></span><br><span class="line">    List&lt;String&gt; beanNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹ Bean çš„åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">        <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> SmartFactoryBean&lt;?&gt; smartFactoryBean &amp;&amp; smartFactoryBean.isEagerInit()) &#123;</span><br><span class="line">                    getBean(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                getBean(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºæ‰€æœ‰é€‚ç”¨çš„ Bean è§¦å‘åç½®åˆå§‹åŒ–å›è°ƒ</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton smartSingleton) &#123;</span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">smartInitialize</span> <span class="operator">=</span> getApplicationStartup().start(<span class="string">&quot;spring.beans.smart-initialize&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;beanName&quot;</span>, beanName);</span><br><span class="line">            smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">            smartInitialize.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ä½“æ¥è¯´åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>è§¦å‘æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹ Bean çš„åˆå§‹åŒ–ï¼Œä½¿ç”¨ <code>getBean()</code> å®ç°</li>
<li>ä¸ºæ‰€æœ‰é€‚ç”¨çš„ Bean è§¦å‘åç½®åˆå§‹åŒ–å›è°ƒï¼Œå³è°ƒç”¨ <code>SmartInitializingSingleton</code> çš„ <code>afterSingletonsInstantiated()</code> æ–¹æ³•ï¼ˆè¿™ä¸ªæ‹“å±•ç‚¹åœ¨åç»­ä¼šè®²åˆ°ï¼‰</li>
</ol>
<p><code>getBean()</code> çš„æµç¨‹å¾ˆé•¿ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œ <strong>åç»­å¦å¼€ä¸€æ–‡è¯¦ç»†åˆ†æï¼Œ</strong> æ­¤å¤„ä»…ç€é‡åˆ†æè¦ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">   <span class="keyword">return</span> doGetBean(name, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨äº† <code>doGetBean()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è´¼é•¿ï¼Œé‡ç‚¹æ˜¯è°ƒç”¨çš„ <code>createBean()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(</span></span><br><span class="line"><span class="params">    String name, <span class="meta">@Nullable</span> Class&lt;T&gt; requiredType, </span></span><br><span class="line"><span class="params">    <span class="meta">@Nullable</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Bean å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                destroySingleton(beanName);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶é»˜è®¤å®ç°æ˜¯ <code>AbstractAutowireCapableBeanFactory#createBean()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">beanInstance</span> <span class="operator">=</span> doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹æ˜¯è°ƒç”¨çš„ <code>doCreateBean()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                              RootBeanDefinition mbd, </span></span><br><span class="line"><span class="params">                              <span class="meta">@Nullable</span> Object[] args)</span> <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the bean.</span></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ– Bean</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">    <span class="comment">// å…è®¸åç½®å¤„ç†å™¨ä¿®æ”¹åˆå¹¶çš„ BeanDefinition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">    <span class="comment">// å°½å¿«ç¼“å­˜å•ä¾‹ Beanï¼Œä»¥ä¾¿è§¦å‘ç”Ÿå‘½å‘¨æœŸæ¥å£ï¼ˆåƒ BeanFactoryAwareï¼‰æ—¶ä¹Ÿèƒ½è§£å†³å¾ªç¯ä¾èµ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Bean å®ä¾‹</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®Œæˆäº† Bean çš„å®ä¾‹å’Œåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ“ä½œç”± <code>initializeBean()</code> æ–¹æ³•å®Œæˆã€‚<code>BeanPostProcessor</code> ä¼šåœ¨ Bean åˆå§‹åŒ–å‰åæ‰§è¡Œï¼Œä¸å¦¨å¤§èƒ†çŒœæµ‹å°±æ˜¯åœ¨ <code>initializeBean()</code> æ–¹æ³•ä¸­å®Œæˆ <code>BeanPostProcessor</code> çš„æ‰§è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                                Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œä¸€äº› Aware æ–¹æ³• </span></span><br><span class="line">    invokeAwareMethods(beanName, bean);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">        <span class="comment">// åº”ç”¨ BeanPostProcessor çš„ postProcessBeforeInitialization() æ–¹æ³•</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">        invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            (mbd != <span class="literal">null</span> ? mbd.getResourceDescription() : <span class="literal">null</span>), beanName, ex.getMessage(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">        <span class="comment">// åº”ç”¨ BeanPostProcessor çš„ postProcessAfterInitialization</span></span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æºç åä¹Ÿæ˜¯éªŒè¯äº†çŒœæƒ³ï¼Œé€‰å– <code>applyBeanPostProcessorsBeforeInitialization()</code> æ–¹æ³•è¿›è¡Œè§£æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, </span></span><br><span class="line"><span class="params">                                                          String beanName)</span></span><br><span class="line">    <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">    <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">        <span class="keyword">if</span> (current == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        result = current;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘å¾ˆç®€å•ï¼Œè·å–æ‰€æœ‰ <code>BeanPostProcessor</code> åè¿›è¡Œéå†ï¼Œä¾æ¬¡æ‰§è¡Œå®ƒä»¬çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ã€‚é‚£ <code>BeanPostProcessor</code> æ˜¯æ€ä¹ˆè·å–çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;BeanPostProcessor&gt; <span class="title function_">getBeanPostProcessors</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">this</span>.beanPostProcessors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨çš„æ˜¯ <code>AbstractBeanFactory#getBeanPostProcessors()</code> æ–¹æ³•ï¼Œç›´æ¥è¿”å›æˆå‘˜å˜é‡ <code>beanPostProcessors</code> çš„å€¼ï¼Œè¿™é‡Œå’Œå‰æ–‡ä¸­æ³¨å†Œ <code>BeanPostProcessor</code> çš„é€»è¾‘ä¸²è”äº†èµ·æ¥ã€‚</p>
<h2 id="4-4-å†…ç½®å®ç°ä¸ä½¿ç”¨åœºæ™¯"><a class="header-anchor" href="#4-4-å†…ç½®å®ç°ä¸ä½¿ç”¨åœºæ™¯"></a>4.4 å†…ç½®å®ç°ä¸ä½¿ç”¨åœºæ™¯</h2>
<blockquote>
<p>å†…ç½®å®ç°ä¸¾ä¾‹</p>
</blockquote>
<p>SpringBoot è¿›è¡Œå‚æ•°æ ¡éªŒæ—¶ä¼šä½¿ç”¨åˆ° <code>BeanValidationPostProcessor</code>ï¼Œå®ƒä¹Ÿæ˜¯ <code>BeanPostProcessor</code> çš„ä¸€ç§å†…ç½®å®ç°ã€‚</p>
<blockquote>
<p>æ›´å¤šä½¿ç”¨åœºæ™¯</p>
</blockquote>
<p>æœ‰æ—¶å¯èƒ½ä¼šç¼–å†™ä¸€äº›è‡ªå®šä¹‰æ³¨è§£å°†å®ƒä»¬æ ‡è®°åˆ°ç›¸åº”çš„ç±»ä¸Šï¼Œå¸Œæœ›åœ¨å¯¹åº”çš„ Bean å®ä¾‹åŒ–åï¼Œæ ¹æ®æ ‡è®°çš„è‡ªå®šä¹‰æ³¨è§£æ‰§è¡Œç‰¹å®šçš„é€»è¾‘ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡å®ç° <code>BeanPostProcessor</code> å®Œæˆã€‚</p>
<h2 id="4-5-æ›´å¤šæ€è€ƒ"><a class="header-anchor" href="#4-5-æ›´å¤šæ€è€ƒ"></a>4.5 æ›´å¤šæ€è€ƒ</h2>
<p><code>BeanPostProcessor</code> èƒ½å¤Ÿåœ¨ Bean åˆå§‹åŒ–å‰åè¢«è°ƒç”¨ï¼Œé‚£å¦‚æœè¦åœ¨ Bean å®ä¾‹åŒ–å‰åè¿›è¡Œæ‹“å±•åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<h1 id="5-å®ä¾‹åŒ–æ„ŸçŸ¥-Bean-åç½®å¤„ç†å™¨"><a class="header-anchor" href="#5-å®ä¾‹åŒ–æ„ŸçŸ¥-Bean-åç½®å¤„ç†å™¨"></a>5. å®ä¾‹åŒ–æ„ŸçŸ¥ Bean åç½®å¤„ç†å™¨</h1>
<h2 id="5-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#5-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>5.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>å®ä¾‹åŒ–æ„ŸçŸ¥ Bean åç½®å¤„ç†å™¨ï¼Œå³ï¼š<code>InstantiationAwareBeanPostProcessor</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InstantiationAwareBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Bean å®ä¾‹åŒ–å‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">default</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Bean å®ä¾‹åŒ–åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å®ä¾‹åŒ–å®Œæˆåï¼Œå±æ€§æ³¨å…¥æ—¶ï¼ˆå‡†ç¡®åœ°è¯´æ˜¯å±æ€§æ³¨å…¥å‰ï¼‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">default</span> PropertyValues <span class="title function_">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span></span><br><span class="line">         <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> pvs;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>InstantiationAwareBeanPostProcessor</code> ç»§æ‰¿äº† <code>BeanPostProcessor</code>ï¼Œå¹¶é¢å¤–æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œèƒ½å¤Ÿåˆ†åˆ«åœ¨ Bean å®ä¾‹åŒ–å‰ã€å®ä¾‹åŒ–åã€å±æ€§æ³¨å…¥é˜¶æ®µè¿›è¡Œæ‹“å±•ã€‚</p>
<p><code>InstantiationAwareBeanPostProcessor</code> ä¸ <code>BeanPostProcessor</code> ç±»ä¼¼ï¼Œä¼šä½œç”¨äº Spring ç®¡ç†çš„æ¯ä¸ª Beanã€‚</p>
<h2 id="5-2-ä½¿ç”¨æ–¹æ³•"><a class="header-anchor" href="#5-2-ä½¿ç”¨æ–¹æ³•"></a>5.2 ä½¿ç”¨æ–¹æ³•</h2>
<p>å®ç° <code>InstantiationAwareBeanPostProcessor</code> æ¥å£ï¼Œé‡å†™æŠ½è±¡æ–¹æ³•ï¼Œå¹¶ <strong>å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ã€‚</strong></p>
<p>æ¯”å¦‚å­˜åœ¨ <code>Dependence</code> å’Œ <code>Example</code> ç±»ï¼Œå°†tå®ƒä»¬äº¤ç”± Spring ç®¡ç†ï¼Œå¹¶åœ¨ <code>Example</code> ä¸­æ³¨å…¥ <code>Dependence</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;example&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Dependence dependence;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDependence</span><span class="params">(Dependence dependence)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;6. Example æ³¨å…¥ dependence&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.dependence = dependence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStr</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;7. Example æ³¨å…¥ str&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.str = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Example</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. æ‰§è¡Œäº† Example çš„æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;9. æ‰§è¡Œäº† init() æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A05Configuration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;init&quot;, value = EXAMPLE_BEAN_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> Example <span class="title function_">example</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Dependence</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dependence</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. æ‰§è¡Œäº† Dependence çš„æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™ <code>InstantiationAwareBeanPostProcessor</code> çš„å®ç°ç±»ï¼Œé‡å†™å…¶ä¸­æ‰€æœ‰æŠ½è±¡æ–¹æ³•ï¼ˆåŒ…æ‹¬çˆ¶æ¥å£ <code>BeanPostProcessor</code> ä¸­çš„æ–¹æ³•ï¼‰ï¼Œå½“é‡åˆ°åä¸º <code>a05-example</code> çš„ Bean æ—¶ï¼Œæ‰§è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyInstantiationAwareBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">InstantiationAwareBeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2. æ‰§è¡Œäº† postProcessBeforeInstantiation() æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ˜¯å¦è¿”å›å…¶ä»– Bean å®ä¾‹ï¼Ÿå¯ä»¥è¿”å›ä»£ç†å¯¹è±¡ï¼Œé˜»æ­¢é»˜è®¤å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;4. æ‰§è¡Œäº† postProcessAfterInstantiation() æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ˜¯å¦éœ€è¦ä¾èµ–æ³¨å…¥ï¼Œå¦‚æœè¿”å› falseï¼Œåˆ™ä¸å†æ‰§è¡Œ postProcessProperties() æ–¹æ³•ï¼›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertyValues <span class="title function_">postProcessProperties</span><span class="params">(PropertyValues pvs, Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;5. æ‰§è¡Œäº† postProcessProperties() æ–¹æ³•&quot;</span>);</span><br><span class="line">            <span class="type">MutablePropertyValues</span> <span class="variable">propertyValues</span> <span class="operator">=</span> (MutablePropertyValues) pvs;</span><br><span class="line">            propertyValues.add(<span class="string">&quot;str&quot;</span>, <span class="string">&quot;str&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pvs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;8. æ‰§è¡Œäº† postProcessBeforeInitialization() æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;10. æ‰§è¡Œäº† postProcessAfterInitialization() æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A05ExtensionPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXAMPLE_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;a05-example&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A05ExtensionPoint.class, args);</span><br><span class="line">        Assert.isTrue(context.getBean(Example.class).getStr().equals(<span class="string">&quot;str&quot;</span>), <span class="string">&quot;&quot;</span>);</span><br><span class="line">        Assert.isTrue(context.getBean(Example.class).getDependence().equals(context.getBean(Dependence.class)), <span class="string">&quot;&quot;</span>);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. æ‰§è¡Œäº† Dependence çš„æ— å‚æ„é€ 
2. æ‰§è¡Œäº† postProcessBeforeInstantiation() æ–¹æ³•
3. æ‰§è¡Œäº† Example çš„æ— å‚æ„é€ 
4. æ‰§è¡Œäº† postProcessAfterInstantiation() æ–¹æ³•
5. æ‰§è¡Œäº† postProcessProperties() æ–¹æ³•
6. Example æ³¨å…¥ dependence
7. Example æ³¨å…¥ str
8. æ‰§è¡Œäº† postProcessBeforeInitialization() æ–¹æ³•
9. æ‰§è¡Œäº† init() æ–¹æ³•
10. æ‰§è¡Œäº† postProcessAfterInitialization() æ–¹æ³•
</pre>
<p><code>InstantiationAwareBeanPostProcessor</code> ä¹‹äº <code>BeanPostProcessor</code>ï¼Œå°±å¥½æ¯” <code>BeanDefinitionRegistryPostProcessor</code> ä¹‹äº <code>BeanFactoryPostProcessor</code>ï¼Œè¿™é‡Œçš„æ¯”è¾ƒä¸»è¦æ˜¯åœ¨æ‰§è¡Œæ—¶æœºä¸Šã€‚</p>
<p><code>InstantiationAwareBeanPostProcessor</code> å°†åœ¨ <code>BeanPostProcessor</code> å‰æ‰§è¡Œï¼Œå¯¹äºå¢åŠ çš„ä¸‰ä¸ªæ–¹æ³•æœ‰ï¼š</p>
<ul>
<li><code>postProcessBeforeInstantiation()</code>ï¼šè¯¥æ–¹æ³•å°†åœ¨ Bean å®ä¾‹åŒ–å‰è¢«æ‰§è¡Œã€‚è¯¥æ–¹æ³•æœ‰ <code>Object</code> ç±»å‹çš„è¿”å›å€¼ï¼Œå¯ä»¥è‡ªå®šä¹‰ Bean æ›¿æ¢åŸæœ‰çš„ Beanï¼ˆæ¯”å¦‚è¿›è¡Œäº†åŠ¨æ€ä»£ç†ï¼‰ï¼Œåœ¨æ›¿æ¢åŸæœ‰ Bean åï¼Œå°†æ‰§è¡Œ <code>postProcessAfterInstantiation()</code>ï¼Œå…¶ä»–æ‹“å±•ç‚¹å°†ä¸å†è§¦å‘ï¼›</li>
<li><code>postProcessAfterInstantiation()</code>ï¼šè¯¥æ–¹æ³•å°†åœ¨ Bean å®ä¾‹åŒ–åè¢«æ‰§è¡Œã€‚è¯¥æ–¹æ³•æœ‰ <code>boolean</code> ç±»å‹çš„è¿”å›å€¼ï¼Œå®ƒè¡¨ç¤ºæ˜¯å¦éœ€è¦ä¾èµ–æ³¨å…¥ï¼Œå¦‚æœè¿”å› <code>false</code>ï¼Œå°†ä¸å†æ‰§è¡Œ <code>InstantiationAwareBeanPostProcessor</code> å®ä¾‹ä¸­çš„å…¶ä»–ä»»ä½•æ‹“å±•æ–¹æ³•ï¼ˆåŒ…æ‹¬çˆ¶ç±» <code>BeanPostProcessor</code> ä¸­çš„æ–¹æ³•ï¼‰ï¼›</li>
<li><code>postProcessProperties()</code>ï¼šè¯¥æ–¹æ³•å°†åœ¨ Bean å®ä¾‹åŒ–åã€å±æ€§æ³¨å…¥å‰æ‰§è¡Œã€‚åœ¨æ­¤æ–¹æ³•ä¸­å¯ä»¥å¯¹æ³¨å…¥çš„å±æ€§å€¼è¿›è¡Œæ›´æ”¹ï¼Œæˆ–æ›¿æ¢åŸæ¥çš„å±æ€§å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ç›´æ¥è¿”å›ä¼ å…¥çš„ <code>PropertyValues</code>ï¼Œå¦‚æœè¿”å› <code>null</code> å°†è·³è¿‡åç»­çš„å±æ€§å¡«å……ã€‚</li>
</ul>
<h2 id="5-3-æ³¨å†Œ"><a class="header-anchor" href="#5-3-æ³¨å†Œ"></a>5.3 æ³¨å†Œ</h2>
<p><code>InstantiationAwareBeanPostProcessor</code> æ˜¯ <code>BeanPostProcessor</code> çš„å­æ¥å£ï¼Œå› æ­¤å®ƒçš„æ³¨å†Œæ–¹å¼ä¸ <code>BeanPostProcessor</code> çš„æ³¨å†Œæ–¹å¼ä¸€æ ·ï¼Œå‚è€ƒã€4.3 æ³¨å†Œä¸æ‰§è¡Œã€‘ã€‚</p>
<h2 id="5-4-æ‰§è¡Œ"><a class="header-anchor" href="#5-4-æ‰§è¡Œ"></a>5.4 æ‰§è¡Œ</h2>
<blockquote>
<p><code>postProcessBeforeInstantiation()</code></p>
</blockquote>
<p><code>InstantiationAwareBeanPostProcessor</code> çš„ç¬¬ä¸€ä¸ªæ–¹æ³• <code>postProcessBeforeInstantiation()</code> å°†åœ¨ Bean å®ä¾‹åŒ–å‰æ‰§è¡Œï¼Œç»“åˆä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œå¯ä»¥çŒœåˆ°è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œä¸ <code>refresh()</code> æ–¹æ³•ä¸­è°ƒç”¨çš„ <code>finishBeanFactoryInitialization()</code> æ–¹æ³•æœ‰å…³ã€‚</p>
<p>å¤§è‡´æµç¨‹ä¸ä¸Šä¸€èŠ‚ç±»ä¼¼ï¼Œè·Ÿéšç›¸åŒçš„æµç¨‹æ¥åˆ° <code>AbstractAutowireCapableBeanFactory#createBean()</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è®© BeanPostProcessors æœ‰æœºä¼šè¿”å›ä»£ç†è€Œä¸æ˜¯ç›®æ ‡ Bean å®ä¾‹</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">        <span class="comment">// å¦‚æœè¿”å›çš„å€¼ä¸ä¸º nullï¼Œç›´æ¥è¿”å›ï¼Œåç»­æ“ä½œä¸å†æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸Šä¸€èŠ‚ä¸­åˆ†æè¿‡çš„æ–¹æ³•</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">beanInstance</span> <span class="operator">=</span> doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº† <code>resolveBeforeInstantiation()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿåœ¨ Bean å®ä¾‹åŒ–å‰åšä¸€äº›æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">resolveBeforeInstantiation</span><span class="params">(String beanName, RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å¯¹åº”çš„ BeanDefinition è¿˜æœªæ‰§è¡Œè¿‡å®ä¾‹åŒ–å‰çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123;</span><br><span class="line">        <span class="comment">// ç¡®ä¿ Bean åœ¨è¿™ä¸€ç‚¹ä¸Šå¾—åˆ°äº†çœŸæ­£çš„è§£æ</span></span><br><span class="line">        <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="comment">// ç¡®å®šç»™å®šçš„ BeanDefinition çš„æ¨¡æ¿ç±»å‹</span></span><br><span class="line">            Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);</span><br><span class="line">            <span class="keyword">if</span> (targetType != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è·å–æ‰€æœ‰ InstantiationAwareBeanPostProcessorï¼Œä¸€ä¸€éå†æ‰§è¡Œå®ä¾‹åŒ–å‰çš„æ“ä½œ</span></span><br><span class="line">                bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);</span><br><span class="line">                <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸Šä¸€æ­¥è¿”å›çš„ä¸æ˜¯ nullï¼Œç›´æ¥æ‰§è¡Œå®ä¾‹åŒ–åçš„æ“ä½œ</span></span><br><span class="line">                    bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mbd.beforeInstantiationResolved = (bean != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ <code>postProcessBeforeInstantiation()</code> æ–¹æ³•è¿”å›é <code>null</code> çš„å€¼æ—¶ï¼Œä¼šç«‹å³æ‰§è¡Œ <code>postProcessAfterInstantiation()</code> æ–¹æ³•ï¼Œè€Œåœ¨ <code>AbstractAutowireCapableBeanFactory#createBean()</code> æ–¹æ³•ä¸­ï¼Œ<code>resolveBeforeInstantiation()</code> æ–¹æ³•è¿”å›çš„å€¼ä¸ä¸º <code>null</code> æ—¶ï¼Œå°†ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„ <code>doCreateBean()</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸å†æ‰§è¡Œå…¶ä»–æ‹“å±•ç‚¹ï¼ŒSpring å°† Bean å®ä¾‹åŒ–åŠå…¶ä»¥åçš„æ‰€æœ‰æ“ä½œéƒ½äº¤ç»™å®ç°è€…ã€‚</p>
<p><code>applyBeanPostProcessorsBeforeInstantiation()</code> æ–¹æ³•çš„å®ç°ä¹Ÿæœ‰ç‚¹æ„æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> &#123;</span><br><span class="line">   <span class="keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> bp.postProcessBeforeInstantiation(beanClass, beanName);</span><br><span class="line">      <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å– <code>InstantiationAwareBeanPostProcessor</code> çš„æ–¹å¼é€šè¿‡ <code>getBeanPostProcessorCache().instantiationAware</code> å®Œæˆï¼Œ<code>getBeanPostProcessorCache()</code> è¿”å›äº† <code>BeanPostProcessor</code> å®ä¾‹çš„ç¼“å­˜ï¼ˆè¿˜åˆ†äº†ç±»ï¼‰ï¼Œä»¥ä¾¿å¤šæ¬¡é‡å¤è·å– <code>BeanPostProcessor</code>ã€‚</p>
<blockquote>
<p><code>postProcessAfterInstantiation()</code> ä¸ <code>postProcessProperties()</code></p>
</blockquote>
<p>è¿™ä¸ªæ–¹æ³•å°†ä¼šåœ¨ Bean <strong>å®ä¾‹åŒ–ä¹‹å</strong> æ‰§è¡Œï¼Œå¤§èƒ†çŒœæµ‹å¾ˆæœ‰å¯èƒ½åœ¨ <code>doCreateBean()</code> æ–¹æ³•ä¸­æ‰§è¡Œï¼Œè¿™åœ¨å‰æ–‡å·²ç»åˆ†æè¿‡ä¸€éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                              RootBeanDefinition mbd, </span></span><br><span class="line"><span class="params">                              <span class="meta">@Nullable</span> Object[] args)</span> <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the bean.</span></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ– Bean</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">    <span class="comment">// å…è®¸åç½®å¤„ç†å™¨ä¿®æ”¹åˆå¹¶çš„ BeanDefinition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">    <span class="comment">// å°½å¿«ç¼“å­˜å•ä¾‹ Beanï¼Œä»¥ä¾¿è§¦å‘ç”Ÿå‘½å‘¨æœŸæ¥å£ï¼ˆåƒ BeanFactoryAwareï¼‰æ—¶ä¹Ÿèƒ½è§£å†³å¾ªç¯ä¾èµ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Bean å®ä¾‹</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰æ–‡åˆ†æçš„æ˜¯å…¶ä¸­çš„ <code>initializeBean()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®Œæˆäº† Bean çš„åˆå§‹åŒ–ã€‚</p>
<p>åœ¨è®¡ç®—æœºçš„è‹±è¯­è¡¨è¿°ä¸­ï¼Œ<code>populate</code> å¸¸è¢«ç¿»è¯‘ä¸ºã€Œå¡«å……ã€ï¼Œ<code>populateBean()</code> æ–¹æ³•å°†ä½¿ç”¨ <code>BeanDefinition</code> ä¸­çš„å±æ€§å€¼å¡«å…… <code>BeanWrapper</code> ä¸­çš„ Bean å®ä¾‹ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢« Bean å®ä¾‹è¿›è¡Œä¸€äº›æ“ä½œï¼Œç‚¹è¿›å»çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">populateBean</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                            RootBeanDefinition mbd, </span></span><br><span class="line"><span class="params">                            <span class="meta">@Nullable</span> BeanWrapper bw)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨è®¾ç½®å±æ€§å‰ï¼Œè®©ä»»ä½• InstantiationAwareBeanPostProcessors éƒ½æœ‰æœºä¼šä¿®æ”¹ Beanï¼Œ</span></span><br><span class="line">    <span class="comment">// è¿™æ ·ä½¿ç”¨åï¼Œå¯ä»¥ç”¨äºæ”¯æŒå­—æ®µæ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¿”å›çš„æ˜¯ falseï¼Œç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­é€»è¾‘</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pvs == <span class="literal">null</span>) &#123;</span><br><span class="line">            pvs = mbd.getPropertyValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰ InstantiationAwareBeanPostProcessorï¼Œä¸€ä¸€éå†æ‰§è¡Œå±æ€§æ³¨å…¥å‰çš„æ“ä½œ</span></span><br><span class="line">        <span class="keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;</span><br><span class="line">            <span class="type">PropertyValues</span> <span class="variable">pvsToUse</span> <span class="operator">=</span> bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);</span><br><span class="line">            <span class="comment">// å¦‚æœè¿”å› nullï¼Œç›´æ¥è¿”å›ï¼Œè·³è¿‡åç»­çš„å±æ€§å¡«å……</span></span><br><span class="line">            <span class="keyword">if</span> (pvsToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pvs = pvsToUse;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæ‰§è¡Œäº† <code>InstantiationAwareBeanPostProcessor</code> ä¸­çš„ç¬¬äºŒã€ç¬¬ä¸‰ä¸ªæ‹“å±•æ–¹æ³•ï¼Œè¿™äº›æ‹“å±•æ–¹æ³•è¿”å›ç‰¹æ®Šçš„è¿”å›å€¼æ—¶ï¼Œä¼šè·³è¿‡åç»­é€»è¾‘çš„æ‰§è¡Œã€‚</p>
<h2 id="5-5-å†…ç½®å®ç°"><a class="header-anchor" href="#5-5-å†…ç½®å®ç°"></a>5.5 å†…ç½®å®ç°</h2>
<p><code>InstantiationAwareBeanPostProcessor</code> çš„å®ç°ååˆ†æœ‰ç”¨ï¼Œåœ¨ Spring ä¸­ä¹Ÿä¸€ä¸ªåä¸º <code>AutowiredAnnotationBeanPostProcessor</code> çš„å®ç°ï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/AutowiredAnnotationBeanPostProcessor%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="AutowiredAnnotationBeanPostProcessorçš„ç±»å›¾"></p>
<p><code>AutowiredAnnotationBeanPostProcessor</code> ç”¨äºè§£æ Bean å±æ€§æ³¨å…¥çš„ç›¸å…³æ³¨è§£ï¼Œæ¯”å¦‚ <code>@Autowired</code> å’Œ <code>@Value</code> æ³¨è§£çš„è§£æã€‚</p>
<p>Bean ä¸­çš„å­—æ®µè¢« <code>@Autowired</code> æ³¨è§£æ ‡è®°åï¼Œå¯ä»¥å°† Spring å®¹å™¨ä¸­å¯¹åº”ç±»å‹çš„ Bean æ³¨å…¥åˆ°å½“å‰ Bean ä¸­ï¼Œå…¶å®ç°é€»è¾‘å°±åœ¨é‡å†™çš„ <code>postProcessProperties()</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PropertyValues <span class="title function_">postProcessProperties</span><span class="params">(PropertyValues pvs, </span></span><br><span class="line"><span class="params">                                            Object bean, String beanName)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ³¨å…¥å…ƒæ•°æ® </span></span><br><span class="line">    <span class="type">InjectionMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> findAutowiringMetadata(beanName, bean.getClass(), pvs);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®è§£æå‡ºçš„å…ƒæ•°æ®å®Œæˆæ³¨å…¥</span></span><br><span class="line">        metadata.inject(bean, beanName, pvs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanCreationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(beanName, <span class="string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pvs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AutowiredAnnotationBeanPostProcessor</code> å®ç°äº† <code>SmartInstantiationAwareBeanPostProcessor</code> æ¥å£ï¼Œåè€…åˆ™ç»§æ‰¿äº† <code>InstantiationAwareBeanPostProcessor</code>ï¼Œé‚£ <code>SmartInstantiationAwareBeanPostProcessor</code> åˆæ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿ</p>
<h1 id="6-æ™ºèƒ½å®ä¾‹åŒ–æ„ŸçŸ¥-Bean-åç½®å¤„ç†å™¨"><a class="header-anchor" href="#6-æ™ºèƒ½å®ä¾‹åŒ–æ„ŸçŸ¥-Bean-åç½®å¤„ç†å™¨"></a>6. æ™ºèƒ½å®ä¾‹åŒ–æ„ŸçŸ¥ Bean åç½®å¤„ç†å™¨</h1>
<h2 id="6-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#6-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>6.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>æ™ºèƒ½å®ä¾‹åŒ–æ„ŸçŸ¥ Bean åç½®å¤„ç†å™¨ï¼Œå³ï¼š<code>SmartInstantiationAwareBeanPostProcessor</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SmartInstantiationAwareBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">InstantiationAwareBeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é¢„æµ‹ä»è¯¥å¤„ç†å™¨çš„ postProcessBeforeInstantiation() å›è°ƒä¸­æœ€ç»ˆè¿”å›çš„ Bean ç±»å‹</span></span><br><span class="line"><span class="comment">    * é»˜è®¤è¿”å› nullã€‚å…·ä½“å®ç°åº”å°½é‡é¢„æµ‹å·²çŸ¥ã€å·²ç¼“å­˜çš„ Bean ç±»å‹ï¼Œè€Œæ— éœ€é¢å¤–çš„å¤„ç†æ­¥éª¤ã€‚</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Bean çš„ç±»å‹ï¼Œå¦‚æœæ— æ³•é¢„æµ‹å°±è¿”å› null</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">default</span> Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName) <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç¡®å®šä»è¯¥å¤„ç†å™¨çš„ postProcessBeforeInstantiation() å›è°ƒä¸­æœ€ç»ˆè¿”å›çš„ Bean ç±»å‹</span></span><br><span class="line"><span class="comment">    * é»˜è®¤å®ç°ä¼šæŒ‰åŸæ ·è¿”å›ç»™å®šçš„ Bean ç±»ã€‚å…·ä½“å®ç°åº”å…¨é¢è¯„ä¼°å…¶å¤„ç†æ­¥éª¤ï¼Œä»¥ä¾¿é¢„å…ˆåˆ›å»ºã€åˆ</span></span><br><span class="line"><span class="comment">    * å§‹åŒ–æ½œåœ¨çš„ä»£ç†ç±»ã€‚</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Bean çš„ç±»å‹ï¼Œæ°¸ä¸ä¸º null</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> 6.0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">default</span> Class&lt;?&gt; determineBeanType(Class&lt;?&gt; beanClass, String beanName) <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> beanClass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç¡®å®šåˆ›å»ºç»™å®š Bean æ—¶ä½¿ç”¨çš„å€™é€‰æ„é€ æ–¹æ³•ï¼Œé»˜è®¤å®ç°è¿”å› nullã€‚</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> å€™é€‰çš„æ„é€ å™¨ï¼Œå¦‚æœæ²¡ç‰¹æ®ŠæŒ‡å®šï¼Œåˆ™è¿”å› nullï¼Œé‡‡ç”¨é»˜è®¤æ„é€ å™¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">default</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName)</span><br><span class="line">         <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¿”å›ä¸€ä¸ªå¼•ç”¨ï¼Œä»¥ä¾¿å°½æ—©è®¿é—®æŒ‡å®šçš„ Beanï¼Œè¿™ä¸ªæ–¹æ³•é€šå¸¸ç”¨äºè§£å†³å¾ªç¯å¼•ç”¨ã€‚</span></span><br><span class="line"><span class="comment">    * æ­¤å›è°ƒä¸ºåç½®å¤„ç†å™¨æä¾›äº†æå‰æš´éœ² wrapper çš„æœºä¼šï¼Œå³åœ¨ç›®æ ‡ Bean å®ä¾‹å®Œå…¨åˆå§‹åŒ–ä¹‹å‰ã€‚</span></span><br><span class="line"><span class="comment">    * æš´éœ²çš„å¯¹è±¡åº”ç­‰åŒäº postProcessBeforeInitialization() æˆ– postProcessAfterInitialization()</span></span><br><span class="line"><span class="comment">    * æ‰€æš´éœ²çš„å¯¹è±¡ã€‚è¯·æ³¨æ„ï¼Œé™¤éåç½®å¤„ç†å™¨ä»ä¸Šè¿°å›è°ƒä¸­è¿”å›ä¸åŒçš„ wrapperï¼Œå¦åˆ™</span></span><br><span class="line"><span class="comment">    * æ­¤æ–¹æ³•è¿”å›çš„å¯¹è±¡å°†ç”¨ä½œ Bean å¼•ç”¨ã€‚</span></span><br><span class="line"><span class="comment">    * é»˜è®¤å®ç°æ˜¯æŒ‰åŸæ ·è¿”å›ç»™å®šçš„ Beanã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">default</span> Object <span class="title function_">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>SmartInstantiationAwareBeanPostProcessor</code> ç»§æ‰¿äº† <code>InstantiationAwareBeanPostProcessor</code>ï¼Œå¹¶é¢å¤–æä¾›äº†å››ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ <code>determineBeanType()</code> æ–¹æ³•æ˜¯åœ¨ Spring 6.0 ä¸­æ–°å¢çš„ã€‚</p>
<p>åœ¨ç±»æ³¨é‡Šä¸Šæœ‰ä¸€æ®µ NOTEï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼š<code>SmartInstantiationAwareBeanPostProcessor</code> æ¥å£æ˜¯ä¸€ä¸ªä¸“ç”¨æ¥å£ï¼Œä¸»è¦åœ¨æ¡†æ¶å†…éƒ¨ä½¿ç”¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ—¥å¸¸å¼€å‘ä¸­å®ç° <code>BeanPostProcessor</code> æ¥å£å³å¯ã€‚</p>
<h2 id="6-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#6-2-ä½¿ç”¨æ–¹å¼"></a>6.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å­˜åœ¨åä¸º <code>Student</code> çš„ç±»ï¼Œå®ƒä¾èµ–äº† <code>Teacher</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(value = STUDENT_BEAN_NAME)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;mofan&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Teacher teacher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student çš„æ— å‚æ•°æ„é€ æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student çš„æœ‰å‚æ•°æ„é€ æ–¹æ³•(name)è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(Teacher teacher)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.teacher = teacher;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student çš„æœ‰å‚æ•°æ„é€ æ–¹æ³•(teacher)è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, Teacher teacher)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.teacher = teacher;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student çš„æœ‰å‚æ•°æ„é€ æ–¹æ³•(name,teacher)è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTeacher</span><span class="params">(Teacher teacher)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----studentä¸­çš„setTeacheræ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.teacher = teacher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­˜åœ¨åä¸º <code>Teacher</code> çš„ç±»ï¼Œå®ƒå†…éƒ¨ä¾èµ–äº† <code>Student</code>ï¼Œæ„æˆäº†å¾ªç¯ä¾èµ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Mr.Chen&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Student student;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Teacher</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Teacher çš„æ— å‚æ•°æ„é€ æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStudent</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Teacher ä¸­çš„ setStudent æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.student = student;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç° <code>SmartInstantiationAwareBeanPostProcessor</code> æ¥å£ï¼Œé€‰æ‹©æ€§é‡å†™å…¶ä¸­çš„æ–¹æ³•ï¼Œå¹¶å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySmartInstantiationAwareBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">SmartInstantiationAwareBeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; predictBeanType(Class&lt;?&gt; beanClass, String beanName) <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (STUDENT_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;predictBeanType æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Student.class;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; determineBeanType(Class&lt;?&gt; beanClass, String beanName) <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (STUDENT_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;determineBeanType æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, String beanName) <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (STUDENT_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            <span class="comment">// å››ä¸ªæ„é€ æ–¹æ³•ï¼Œé€‰é»˜è®¤æ„é€ æ–¹æ³•</span></span><br><span class="line">            <span class="comment">// é€‰(name)æ—¶ä¼šæŠ¥é”™ï¼Œé€‰(teacher)æ—¶ä¼šæœ‰å¾ªç¯ä¾èµ–ï¼Œå¹¶ä¸”æ˜¯ Spring æ— æ³•è§£å†³çš„å¾ªç¯ä¾èµ–</span></span><br><span class="line">            <span class="comment">// é€‰(name, teacher)æ—¶ä¹Ÿä¼šæŠ¥é”™</span></span><br><span class="line">            System.out.println(<span class="string">&quot;determineCandidateConstructors æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constructor</span>[]&#123;beanClass.getConstructors()[<span class="number">0</span>]&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getEarlyBeanReference</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (STUDENT_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;getEarlyBeanReference æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (STUDENT_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;postProcessBeforeInstantiation æ–¹æ³•è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A06ExtensionPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STUDENT_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;a06-student&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A06ExtensionPoint.class);</span><br><span class="line">        <span class="type">Teacher</span> <span class="variable">teacher</span> <span class="operator">=</span> context.getBean(Teacher.class);</span><br><span class="line">        System.out.println(teacher.getClass().getName());</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> context.getBean(Student.class);</span><br><span class="line">        System.out.println(student.getClass().getName());</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
predictBeanType æ–¹æ³•è¢«æ‰§è¡Œ
postProcessBeforeInstantiation æ–¹æ³•è¢«æ‰§è¡Œ
determineCandidateConstructors æ–¹æ³•è¢«æ‰§è¡Œ
Student çš„æ— å‚æ•°æ„é€ æ–¹æ³•è¢«æ‰§è¡Œ
predictBeanType æ–¹æ³•è¢«æ‰§è¡Œ
Teacher çš„æ— å‚æ•°æ„é€ æ–¹æ³•è¢«æ‰§è¡Œ
predictBeanType æ–¹æ³•è¢«æ‰§è¡Œ
predictBeanType æ–¹æ³•è¢«æ‰§è¡Œ
getEarlyBeanReference æ–¹æ³•è¢«æ‰§è¡Œ
</pre>
<p>çœç•¥äº†è®¸å¤š <code>predictBeanType æ–¹æ³•è¢«æ‰§è¡Œ</code> çš„æ‰“å°ã€‚</p>
<h2 id="6-3-æ³¨å†Œ"><a class="header-anchor" href="#6-3-æ³¨å†Œ"></a>6.3 æ³¨å†Œ</h2>
<p><code>SmartInstantiationAwareBeanPostProcessor</code> æ˜¯ <code>BeanPostProcessor</code> çš„å­æ¥å£ï¼Œå› æ­¤å®ƒçš„æ³¨å†Œæ–¹å¼ä¸ <code>BeanPostProcessor</code> çš„æ³¨å†Œæ–¹å¼ä¸€æ ·ï¼Œå‚è€ƒã€4.3 æ³¨å†Œä¸æ‰§è¡Œã€‘ã€‚</p>
<h2 id="6-4-æ‰§è¡Œ"><a class="header-anchor" href="#6-4-æ‰§è¡Œ"></a>6.4 æ‰§è¡Œ</h2>
<p>æ­¤å¤„åªä»‹ç» <code>determineCandidateConstructors()</code> æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œè¯¥æ–¹æ³•ç”¨äºç¡®å®šå€™é€‰æ„é€ å™¨ï¼Œåœ¨å®ä¾‹åŒ– Bean ä½¿ç”¨ã€‚</p>
<p>åœ¨å‰æ–‡çš„ä»‹ç»ä¸­å¯çŸ¥ï¼Œåœ¨ <code>getBean()</code> æ–¹æ³•é‡Œä¼šå¯¹ Bean è¿›è¡Œå®ä¾‹åŒ–ã€‚è·Ÿéšå‰æ–‡çš„æ­¥éª¤ï¼Œæ¥åˆ° <code>AbstractAutowireCapableBeanFactory#doCreateBean()</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                              RootBeanDefinition mbd, </span></span><br><span class="line"><span class="params">                              <span class="meta">@Nullable</span> Object[] args)</span> <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the bean.</span></span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ– Bean</span></span><br><span class="line">    <span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        instanceWrapper = <span class="built_in">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> instanceWrapper.getWrappedInstance();</span><br><span class="line">    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">    <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">        mbd.resolvedTargetType = beanType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">    <span class="comment">// å…è®¸åç½®å¤„ç†å™¨ä¿®æ”¹åˆå¹¶çš„ BeanDefinition</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">    <span class="comment">// å°½å¿«ç¼“å­˜å•ä¾‹ Beanï¼Œä»¥ä¾¿è§¦å‘ç”Ÿå‘½å‘¨æœŸæ¥å£ï¼ˆåƒ BeanFactoryAwareï¼‰æ—¶ä¹Ÿèƒ½è§£å†³å¾ªç¯ä¾èµ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Bean å®ä¾‹</span></span><br><span class="line">    <span class="comment">// Initialize the bean instance.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå°±æ˜¯å®ä¾‹åŒ– Beanï¼Œå…¶ä¸­è°ƒç”¨äº† <code>createBeanInstance()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> BeanWrapper <span class="title function_">createBeanInstance</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                                         RootBeanDefinition mbd, </span></span><br><span class="line"><span class="params">                                         <span class="meta">@Nullable</span> Object[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Candidate constructors for autowiring?</span></span><br><span class="line">    <span class="comment">// Autowired ä½¿ç”¨çš„æ„é€ å™¨</span></span><br><span class="line">    Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">    <span class="keyword">if</span> (ctors != <span class="literal">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">        mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;</span><br><span class="line">        <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Preferred constructors for default construction?</span></span><br><span class="line">    <span class="comment">// é»˜è®¤æ„é€ çš„é¦–é€‰æ„é€ å™¨</span></span><br><span class="line">    ctors = mbd.getPreferredConstructors();</span><br><span class="line">    <span class="keyword">if</span> (ctors != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No special handling: simply use no-arg constructor.</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰ç‰¹æ®Šå¤„ç†ï¼šç®€å•ä½¿ç”¨æ— å‚æ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨äº† <code>determineConstructorsFromBeanPostProcessors()</code> æ–¹æ³•ï¼Œå¦‚æœå­˜åœ¨è¢« <code>@Autowired</code> æ³¨è§£æ ‡è®°çš„æ„é€ å™¨æ—¶ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ„é€ å™¨æ¥å®ä¾‹åŒ– Beanã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> Constructor&lt;?&gt;[] determineConstructorsFromBeanPostProcessors(<span class="meta">@Nullable</span> Class&lt;?&gt; beanClass, String beanName)</span><br><span class="line">      <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (beanClass != <span class="literal">null</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123;</span><br><span class="line">         Constructor&lt;?&gt;[] ctors = bp.determineCandidateConstructors(beanClass, beanName);</span><br><span class="line">         <span class="keyword">if</span> (ctors != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ctors;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯åœ¨æ­¤å¤„è°ƒç”¨äº† <code>determineCandidateConstructors()</code> æ–¹æ³•ã€‚</p>
<h2 id="6-5-å†…ç½®å®ç°"><a class="header-anchor" href="#6-5-å†…ç½®å®ç°"></a>6.5 å†…ç½®å®ç°</h2>
<p>ä»¥ <code>AutowiredAnnotationBeanPostProcessor</code> ä¸ºä¾‹ã€‚</p>
<blockquote>
<p><code>predictBeanType()</code></p>
</blockquote>
<p>åœ¨ <code>AutowiredAnnotationBeanPostProcessor</code> ä¸­å¹¶æœªé‡å†™ <code>predictBeanType()</code> æ–¹æ³•ã€‚</p>
<p>åœ¨ Spring AOP ä¸­ï¼Œ<code>AbstractAutoProxyCreator</code> é‡å†™äº† <code>predictBeanType()</code> æ–¹æ³•ï¼Œè¿™ä¸ AOP çš„å®ç°æœ‰å…³ï¼Œæ­¤å¤„ä¸å†æ·±ç©¶ï¼Œ <strong>åç»­å¦å¼€ä¸€æ–‡è¯¦ç»†åˆ†æ</strong>ã€‚</p>
<blockquote>
<p><code>determineBeanType()</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; determineBeanType(Class&lt;?&gt; beanClass, String beanName) <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¢« @Lookup æ³¨è§£æ ‡è®°çš„æ–¹æ³•</span></span><br><span class="line">    checkLookupMethods(beanClass, beanName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pick up subclass with fresh lookup method override from above</span></span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸Šè¿°å­ç±»é‡å†™ @Lookup æ ‡è®°çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.beanFactory <span class="keyword">instanceof</span> AbstractAutowireCapableBeanFactory aacBeanFactory) &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">mbd</span> <span class="operator">=</span> (RootBeanDefinition) <span class="built_in">this</span>.beanFactory.getMergedBeanDefinition(beanName);</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å·¥å‚æ–¹æ³•ï¼Œä½†æ˜¯åˆ¶å®šäº† Bean çš„ Class</span></span><br><span class="line">        <span class="keyword">if</span> (mbd.getFactoryMethodName() == <span class="literal">null</span> &amp;&amp; mbd.hasBeanClass()) &#123;</span><br><span class="line">            <span class="comment">// è·å–ç»™å®š Bean çš„å®é™… Class</span></span><br><span class="line">            <span class="keyword">return</span> aacBeanFactory.getInstantiationStrategy().getActualBeanClass(mbd, beanName, aacBeanFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> beanClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>determineCandidateConstructors()</code></p>
</blockquote>
<p>é‡å†™çš„ <code>determineCandidateConstructors()</code> æ–¹æ³•å¾ˆé•¿ï¼Œç®€å•æ¥è¯´å°±æ˜¯éå†ç±»ä¸­æ‰€æœ‰æ„é€ å™¨ï¼Œç„¶åé€‰å–å‡ºå€™é€‰æ„é€ å™¨ã€‚è¯¥æ–¹æ³•ä¸­æœ‰è¿™æ ·ä¸€æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, </span><br><span class="line">                                                       <span class="keyword">final</span> String beanName)</span><br><span class="line">    <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="keyword">for</span> (Constructor&lt;?&gt; candidate : rawCandidates) &#123;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">        <span class="comment">// è·å–æ„é€ å™¨ä¸Šä¸ Autowired æœ‰å…³çš„æ³¨è§£</span></span><br><span class="line">        MergedAnnotation&lt;?&gt; ann = findAutowiredAnnotation(candidate);</span><br><span class="line">        <span class="keyword">if</span> (ann == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†æ³¨è§£ä¿¡æ¯ä¸º null çš„æƒ…å†µ</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ann != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡èµ°åˆ°è¿™æ—¶ requiredConstructor ç­‰äº null</span></span><br><span class="line">            <span class="keyword">if</span> (requiredConstructor != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¿…éœ€çš„æ„é€ å™¨åªèƒ½æœ‰ä¸€ä¸ªï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ç¡®å®šè¢«æ ‡è®°çš„æ„é€ æ–¹æ³•æ˜¯å¦æ˜¯å¿…éœ€çš„</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">required</span> <span class="operator">=</span> determineRequiredStatus(ann);</span><br><span class="line">            <span class="keyword">if</span> (required) &#123;</span><br><span class="line">                <span class="comment">// åªèƒ½æœ‰ä¸€ä¸ªï¼Œå¤šä¸ªå°±æŠ›å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span> (!candidates.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ç¡®å®šå¿…éœ€çš„æ„é€ å™¨</span></span><br><span class="line">                requiredConstructor = candidate;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ·»åŠ åˆ°å€™é€‰é¡¹åˆ—è¡¨ä¸­</span></span><br><span class="line">            candidates.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (candidate.getParameterCount() == <span class="number">0</span>) &#123;</span><br><span class="line">            defaultConstructor = candidate;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="keyword">return</span> (candidateConstructors.length &gt; <span class="number">0</span> ? candidateConstructors : <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éå†æ„é€ å™¨æ—¶ï¼Œä½¿ç”¨ <code>findAutowiredAnnotation()</code> æ–¹æ³•æŸ¥çœ‹æ„é€ å™¨ä¸Šæ˜¯å¦æœ‰æŒ‡å®šæ³¨è§£ï¼Œå¦‚æœæœ‰æŒ‡å®šæ³¨è§£ï¼Œå¹¶ä¸”ä½¿ç”¨ <code>determineRequiredStatus()</code> æ–¹æ³•æ±‚å¾—æ³¨è§£æ ‡è®°çš„æ„é€ å™¨æ˜¯å¿…éœ€çš„ï¼Œé‚£ä¹ˆå½“å‰æ„é€ å™¨å°±æ˜¯å¿…éœ€çš„æ„é€ å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> MergedAnnotation&lt;?&gt; findAutowiredAnnotation(AccessibleObject ao) &#123;</span><br><span class="line">    <span class="type">MergedAnnotations</span> <span class="variable">annotations</span> <span class="operator">=</span> MergedAnnotations.from(ao);</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type : <span class="built_in">this</span>.autowiredAnnotationTypes) &#123;</span><br><span class="line">        MergedAnnotation&lt;?&gt; annotation = annotations.get(type);</span><br><span class="line">        <span class="keyword">if</span> (annotation.isPresent()) &#123;</span><br><span class="line">            <span class="keyword">return</span> annotation;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹æ„é€ å™¨è€Œè¨€ï¼Œéå† <code>this.autowiredAnnotationTypes</code> çš„å€¼ï¼ŒæŸ¥çœ‹æ„é€ å™¨æ˜¯å¦è¢«è¿™äº›æ³¨è§£æ ‡è®°ã€‚<code>this.autowiredAnnotationTypes</code> çš„å€¼åœ¨æ„é€  <code>AutowiredAnnotationBeanPostProcessor</code> å®ä¾‹æ—¶è¢«æŒ‡å®šï¼Œé»˜è®¤æœ‰ä»¥ä¸‹å››ä¸ªå€¼ï¼š</p>
<ul>
<li><code>@org.springframework.beans.factory.annotation.Autowired</code></li>
<li><code>@org.springframework.beans.factory.annotation.Value</code></li>
<li><code>@jakarta.inject.Inject</code></li>
<li><code>@javax.inject.Inject</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">determineRequiredStatus</span><span class="params">(MergedAnnotation&lt;?&gt; ann)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> (ann.getValue(<span class="built_in">this</span>.requiredParameterName).isEmpty() ||</span><br><span class="line">         <span class="built_in">this</span>.requiredParameterValue == ann.getBoolean(<span class="built_in">this</span>.requiredParameterName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­ç»™å®šæ³¨è§£æ˜¯å¦é…ç½®äº† <code>require</code>ã€‚æ¯”å¦‚ä»¥ <code>@Autowired</code> æ³¨è§£ï¼Œè¯¥æ³¨è§£æœ‰ <code>require</code> å±æ€§ï¼ŒåŒæ—¶è¯¥å±æ€§å€¼ä¸º <code>true</code> æ—¶ï¼Œ<code>determineRequiredStatus()</code> æ–¹æ³•è¿”å› <code>true</code>ï¼›ä»¥ <code>@Value</code> æ³¨è§£æ¥è¯´ï¼Œå®ƒä¸å« <code>require</code> æˆ– <code>optional</code> å±æ€§ï¼Œ<code>determineRequiredStatus()</code> æ–¹æ³•ä¹Ÿè¿”å› <code>true</code>ã€‚</p>
<blockquote>
<p><code>getEarlyBeanReference()</code></p>
</blockquote>
<p>åœ¨ <code>AutowiredAnnotationBeanPostProcessor</code> ä¸­å¹¶æœªé‡å†™ <code>getEarlyBeanReference()</code> æ–¹æ³•ã€‚</p>
<p>åœ¨ Spring AOP ä¸­ï¼Œ<code>AbstractAutoProxyCreator</code> é‡å†™äº† <code>predictBeanType()</code> æ–¹æ³•ï¼Œè¿™ä¸ AOP çš„å®ç°æœ‰å…³ï¼Œæ­¤å¤„ä¸å†æ·±ç©¶ï¼Œ <strong>åç»­å¦å¼€ä¸€æ–‡è¯¦ç»†åˆ†æ</strong>ã€‚</p>
<h1 id="7-åº”ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥"><a class="header-anchor" href="#7-åº”ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥"></a>7. åº”ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥</h1>
<h2 id="7-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#7-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>7.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>åº”ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼Œå³ï¼š<code>ApplicationContextAware</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationContextAware</span> <span class="keyword">extends</span> <span class="title class_">Aware</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å– ApplicationContextï¼Œè¿™é€šå¸¸ç”¨äºè®¾ç½®æŸä¸ª Bean ä¸­ ApplicationContext ç±»å‹çš„å­—æ®µå€¼</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ¥å£å®ç°äº† <code>Aware</code> æ¥å£ï¼Œæä¾›äº† <code>setApplicationContext()</code> æ–¹æ³•ï¼Œç”¨äºè·å– <code>ApplicationContext</code>ï¼Œé€šå¸¸ç”¨äºè®¾ç½®æŸä¸ª Bean ä¸­ <code>ApplicationContext</code> ç±»å‹çš„å­—æ®µå€¼ã€‚</p>
<p><code>Aware</code> æ¥å£æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼ŒSpring ä¸­æä¾›äº†ä¼—å¤šçš„ Aware æ¥å£ï¼Œè¿™äº›æ¥å£ä¸­éƒ½æœ‰ä»¥ <code>set</code> å¼€å¤´çš„æ–¹æ³•ï¼Œç”¨äºè·å–ç‰¹å®šçš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li><code>EnvironmentAware</code>ï¼šè·å– <code>Environment</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºè·å¾—ç³»ç»Ÿå†…æ‰€æœ‰çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ³¨å…¥çš„æ–¹å¼è·å–è¯¥å¯¹è±¡ï¼›</li>
<li><code>EmbeddedValueResolverAware</code>ï¼šè·å– <code>StringValueResolver</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºè·å– <code>String</code> ç±»å‹çš„ propertyï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>@Value</code> æ³¨è§£è·å– <code>String</code> ç±»å‹çš„ propertyï¼›</li>
<li><code>ResourceLoaderAware</code>ï¼šè·å– <code>ResourceLoader</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºè·å– <code>classpath</code> ä¸‹çš„æ‰€æœ‰èµ„æºï¼›</li>
<li><code>ApplicationEventPublisherAware</code>ï¼šè·å– <code>ApplicationEventPublisher</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºå‘é€äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ³¨å…¥çš„æ–¹å¼è·å–è¯¥å¯¹è±¡ï¼›</li>
<li><code>MessageSourceAware</code>ï¼šè·å– <code>MessageSource</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºè·å–å›½é™…åŒ–ä¿¡æ¯ï¼›</li>
<li><code>ApplicationStartupAware</code>ï¼šè·å– <code>ApplicationStartup</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºè·å– Spring å¯åŠ¨æœŸé—´å„ä¸ªæ­¥éª¤çš„ä¿¡æ¯ã€‚</li>
</ul>
<p><code>Aware</code> çš„å­æ¥å£å…¶å®æœ‰å¾ˆå¤šï¼Œé‚£ä¸ºä»€ä¹ˆåªåˆ—ä¸¾ä¸Šé¢é‚£äº›å‘¢ï¼Ÿ</p>
<p>å› ä¸º <strong>ä¸Šé¢è¿™äº› <code>Aware</code> æ¥å£éƒ½ç”± <code>ApplicationContextAwareProcessor</code> å¤„ç†ã€‚</strong></p>
<h2 id="7-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#7-2-ä½¿ç”¨æ–¹å¼"></a>7.2 ä½¿ç”¨æ–¹å¼</h2>
<p>ä»¥ <code>ApplicationContextAware</code> æ¥å£ä¸ºä¾‹ï¼Œå®ç° <code>ApplicationContextAware</code> æ¥å£ï¼Œé‡å†™ <code>setApplicationContext()</code> æ–¹æ³•ï¼Œå¹¶å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>ApplicationContext</code> å¯¹è±¡è¿˜å¯ä»¥é€šè¿‡æ³¨å…¥è·å–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * ç±»ä¼¼çš„æ¥å£è¿˜æœ‰ï¼š</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;EnvironmentAware&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;EmbeddedValueResolverAware&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;ResourceLoaderAware&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;ApplicationEventPublisherAware&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;MessageSourceAware&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;ApplicationStartupAware&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyApplicationContextAware</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">        System.out.println(<span class="string">&quot;2. Spring ä¸Šä¸‹æ–‡ ApplicationContext è¢«æ³¨å…¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyApplicationContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. ä½¿ç”¨ @Autowired æ³¨å…¥ ApplicationContext&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A07ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A07ExtensionPoint.class, args);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. ä½¿ç”¨ @Autowired æ³¨å…¥ ApplicationContext
2. Spring ä¸Šä¸‹æ–‡ ApplicationContext è¢«æ³¨å…¥
</pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç›¸æ¯”äºé€šè¿‡ <code>ApplicationContextAware</code> è·å– <code>ApplicationContext</code> å¯¹è±¡ï¼Œç›´æ¥æ³¨å…¥ <code>ApplicationContext</code> ä¼šæ›´æ—©æ‰§è¡Œã€‚</p>
<h2 id="7-3-æ³¨å†Œä¸æ‰§è¡Œ"><a class="header-anchor" href="#7-3-æ³¨å†Œä¸æ‰§è¡Œ"></a>7.3 æ³¨å†Œä¸æ‰§è¡Œ</h2>
<p>å¯ä»¥ä½¿ç”¨ <code>ApplicationContextAware</code> è·å– <code>ApplicationContext</code> å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ³¨å…¥ <code>ApplicationContext</code>ï¼Œå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<p><code>ApplicationContextAware</code> æ¥å£ç”± <code>ApplicationContextAwareProcessor</code> å¤„ç†ï¼Œåè€…å®ç°äº† <code>BeanPostProcessor</code> æ¥å£å¹¶é‡å†™ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ï¼Œåœ¨ Bean åˆå§‹åŒ–å‰å¤„ç†ç»§æ‰¿äº† <code>ApplicationContextAware</code> æ¥å£çš„ Beanï¼Œä½† <code>ApplicationContextAwareProcessor</code> å¹¶æœªè¢« <code>@Component</code> ç­‰æ³¨è§£æ ‡è®°ï¼Œé‚£å®ƒæ˜¯æ€ä¹ˆæ·»åŠ åˆ° Spring å®¹å™¨ä¸­çš„å‘¢ï¼Ÿ</p>
<p>è¿™äº›é—®é¢˜åœ¨ <a href="../Get-ApplicationContext/">è·å– ApplicationContext</a> ä¸€æ–‡ä¸­å¯ä»¥è·å¾—å‡†ç¡®ç­”æ¡ˆï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</p>
<h2 id="7-4-ä¸€ä¸ªé‡è¦çš„ç»†èŠ‚"><a class="header-anchor" href="#7-4-ä¸€ä¸ªé‡è¦çš„ç»†èŠ‚"></a>7.4 ä¸€ä¸ªé‡è¦çš„ç»†èŠ‚</h2>
<blockquote>
<p><code>ApplicationContextAwareProcessor</code> è¢«åŠ è½½çš„æ—¶æœº</p>
</blockquote>
<p><code>ApplicationContextAwareProcessor</code> å°†åœ¨å‡†å¤‡ BeanFactory æ—¶è¢«åŠ è½½ï¼Œä¹Ÿå°±åœ¨ <code>refresh()</code> æ–¹æ³•ä¸­çš„ <code>prepareBeanFactory()</code> æ–¹æ³•ä¸­è¢«åŠ è½½ï¼š</p>
<pre><code class="highlight mermaid">flowchart TD
1(&quot;SpringApplication#refresh()&quot;)
2(&quot;AbstractApplicationContext#refresh()&quot;)
3(&quot;AbstractApplicationContext#prepareBeanFactory()&quot;)

1 --&gt; 2 --&gt; 3</code></pre>
<p><strong>è¿™ä¸€æ­¥æ˜¯ååˆ†é å‰çš„ã€‚</strong></p>
<blockquote>
<p>å…¶ä»– <code>BeanPostProcessor</code> ç›¸æ¯”äº <code>ApplicationContextAwareProcessor</code> çš„æ³¨å†Œæ—¶æœº</p>
</blockquote>
<p><code>ApplicationContextAwareProcessor</code> å®ç°äº† <code>BeanPostProcessor</code> æ¥å£ï¼Œé‡å†™äº†å…¶ä¸­çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ï¼Œ <strong>ä¼šåœ¨ Bean å®ä¾‹åŒ–åã€åˆå§‹åŒ–å‰æ‰§è¡Œã€‚</strong></p>
<p>å›å¿† <code>BeanPostProcessor</code> çš„æ³¨å†Œæ—¶æœºï¼Œå®ƒæ˜¯åœ¨ <code>refresh()</code> æ–¹æ³•ä¸­çš„ <code>registerBeanPostProcessors()</code> æ–¹æ³•ä¸­è¢«æ³¨å†Œçš„ã€‚<code>refresh()</code> æ–¹æ³•ä¸­çš„éƒ¨åˆ†æµç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="highlight mermaid">flowchart TD
1(&quot;prepareRefresh()&quot;)
2(&quot;obtainFreshBeanFactory&quot;)
subgraph 3 [&quot;prepareBeanFactory()&quot;]
3.1(&quot;åŠ è½½ ApplicationContextAwareProcessor&quot;)
end
4(&quot;postProcessBeanFactory()&quot;)
subgraph 5 [&quot;invokeBeanFactoryPostProcessors()&quot;]
5.1(&quot;æ‰§è¡Œ BeanFactoryPostProcessor&quot;)
end
subgraph 6 [&quot;registerBeanPostProcessors()&quot;]
6.1(&quot;æ³¨å†Œ BeanPostProcessor&quot;)
end
7(&quot;...&quot;)

1 --&gt; 2 --&gt; 3 --&gt; 4 --&gt; 5 --&gt; 6 --&gt; 7</code></pre>
<p>åœ¨æ³¨å†Œå…¶ä»– <code>BeanPostProcessor</code> å‰ï¼Œå®¹å™¨ä¸­å·²ç»å­˜åœ¨äº† <code>ApplicationContextAwareProcessor</code> ç±»å‹çš„ <code>BeanPostProcessor</code>ã€‚</p>
<blockquote>
<p>ç›´æ¥æ³¨å…¥ <code>ApplicationContext</code> çš„å®ç°</p>
</blockquote>
<p>æ³¨å…¥ <code>ApplicationContext</code> æ—¶ä¼šä½¿ç”¨ <code>@Autowired</code> æˆ– <code>@Resource</code> æ³¨è§£ï¼Œå‰è€…ç”± <code>AutowiredAnnotationBeanPostProcessor</code> å®ç°ï¼Œåè€…ç”± <code>CommonAnnotationBeanPostProcessor</code> å®ç°ï¼Œå®ƒä»¬éƒ½æ˜¯ <code>BeanPostProcessor</code> çš„å®ç°ï¼Œ <strong>å®ƒä»¬å®ä¾‹åŒ–çš„æ—¶æœºæ˜¯åœ¨ <code>registerBeanPostProcessors()</code> æ–¹æ³•ä¸­ï¼Œç›¸æ¯”äº <code>ApplicationContextAwareProcessor</code> çš„å®ä¾‹åŒ–æ—¶æœºæ›´åŠ é åã€‚</strong></p>
<p>è¿™è¯´æ˜äº†ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p><mark>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæƒ³è¦åœ¨ <code>registerBeanPostProcessors()</code> æ–¹æ³•å‰åˆ›å»ºçš„ Bean ä¸­æ‹¿åˆ° <code>ApplicationContext</code> å®ä¾‹ï¼Œåªèƒ½é€šè¿‡å®ç° <code>ApplicationContextAware</code> æ¥å£å®Œæˆï¼Œè€Œä¸èƒ½é€šè¿‡æ³¨å…¥ <code>ApplicationContext</code> è·å–ï¼Œå› ä¸ºé‚£æ—¶è¿˜æ²¡åŠ è½½ç”¨äºè§£æç›¸å…³æ³¨è§£çš„ <code>BeanPostProcessor</code>ã€‚</mark></p>
<p>æ¯”å¦‚åœ¨ <code>BeanFactoryPostProcessor</code> çš„å®ç°ç±»ä¸­è·å– <code>ApplicationContext</code> å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyFirstBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        Assert.isNull(context, <span class="string">&quot;ä¾èµ–æ³¨å…¥çš„ ApplicationContext ä¸æ˜¯ null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySecondBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span>, ApplicationContextAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        Assert.notNull(context, <span class="string">&quot;ä½¿ç”¨ ApplicationContextAware æ³¨å…¥çš„ ApplicationContext ä¸º null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BeanFactoryPostProcessor</code> å°†åœ¨ <code>invokeBeanFactoryPostProcessors()</code> æ–¹æ³•ä¸­å®Œæˆå®ä¾‹åŒ–ä¸æ‰§è¡Œï¼Œå®ä¾‹åŒ–æ˜¯é€šè¿‡ <code>getBean()</code> æ–¹æ³•å®Œæˆçš„ï¼Œå¦‚æœå®¹å™¨ä¸­å­˜åœ¨æŒ‡å®šåç§°çš„ Beanï¼Œå°±ç›´æ¥è·å–ï¼Œå¦åˆ™å…ˆåˆ›å»ºå†è·å–ï¼Œè¿™åœ¨å‰æ–‡å·²ç»è¯´è¿‡äº†ã€‚</p>
<p>åœ¨é€šè¿‡ <code>getBean()</code> å®ä¾‹åŒ– <code>BeanFactoryPostProcessor</code> å‰ï¼Œä¼šè·å–å½“å‰å®¹å™¨ä¸­çš„æ‰€æœ‰ <code>BeanPostProcessor</code> å®ä¾‹ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ï¼Œæ­¤æ—¶å®¹å™¨ä¸­å­˜åœ¨ <code>ApplicationContextAwareProcessor</code> ç±»å‹çš„ <code>BeanPostProcessor</code>ï¼Œä½¿å¾—å®ç° <code>ApplicationContextAware</code> æ¥å£çš„ Bean èƒ½å¤Ÿæ‹¿åˆ° <code>ApplicationContext</code> å®ä¾‹ï¼Œè€Œåˆ©ç”¨æ³¨å…¥æ–¹å¼è·å–çš„ <code>ApplicationContext</code> å®ä¾‹ï¼Œç”±äºè¿˜æœªåŠ è½½ç›¸å…³çš„è§£æç±»ï¼Œå› æ­¤æ³¨å…¥æ˜¯æ— æ•ˆçš„ã€‚</p>
<h2 id="7-5-å¦ä¸€ä¸ª-Aware"><a class="header-anchor" href="#7-5-å¦ä¸€ä¸ª-Aware"></a>7.5 å¦ä¸€ä¸ª Aware</h2>
<p>é™¤äº†ä½¿ç”¨ <code>ApplicationContextAwareProcessor</code> å¤„ç†çš„ä¸€ä¼— <code>Aware</code> å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåä¸º <code>BeanNameAware</code> çš„æ¥å£ï¼Œå®ƒæä¾›äº†è·å–æŸä¸ª Bean çš„ name çš„èƒ½åŠ›ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanNameAware</span> <span class="keyword">extends</span> <span class="title class_">Aware</span> &#123;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä½¿ç”¨æ–¹å¼</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A14ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">                SpringApplication.run(A14ExtensionPoint.class);</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> context.getBean(MyBean.class);</span><br><span class="line">        Assert.isTrue(BEAN_NAME.equals(myBean.beanName), <span class="string">&quot;Bean çš„ name ä¸ç›¸ç­‰&quot;</span>);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;A Yi A Yi A&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> <span class="keyword">implements</span> <span class="title class_">BeanNameAware</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String beanName;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.beanName = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">        <span class="meta">@Bean(BEAN_NAME)</span></span><br><span class="line">        <span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰§è¡Œ</p>
</blockquote>
<p>å®ƒå°†åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰è¢«æ‰§è¡Œï¼Œåœ¨ <code>AbstractAutowireCapableBeanFactory#initializeBean()</code> æ–¹æ³•çš„é¦–è¡Œè°ƒç”¨äº† <code>invokeAwareMethods()</code> æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å®Œæˆäº† <code>BeanNameAware</code> ç­‰å¤šä¸ª <code>Aware</code> çš„æ‰§è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeAwareMethods</span><span class="params">(String beanName, Object bean)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware beanNameAware) &#123;</span><br><span class="line">            beanNameAware.setBeanName(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware beanClassLoaderAware) &#123;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">bcl</span> <span class="operator">=</span> getBeanClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (bcl != <span class="literal">null</span>) &#123;</span><br><span class="line">                beanClassLoaderAware.setBeanClassLoader(bcl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware beanFactoryAware) &#123;</span><br><span class="line">            beanFactoryAware.setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³äºåˆ° <code>initializeBean()</code> çš„å…·ä½“æµç¨‹ï¼Œå¯ä»¥å‚è€ƒå‰æ–‡ã€Bean åç½®å¤„ç†å™¨ã€‘çš„æ‰§è¡Œé€»è¾‘ã€‚</p>
<h1 id="8-PostConstruct"><a class="header-anchor" href="#8-PostConstruct"></a>8. @PostConstruct</h1>
<h2 id="8-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#8-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>8.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>è¯¥æ³¨è§£çš„å…¨é™å®šç±»åæ˜¯ <code>@javax.annotation.PostConstruct</code>ï¼Œå®ƒå¹¶é Spring æä¾›ï¼Œä½† Spring ä¸ºå…¶æä¾›äº†å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span> (RUNTIME)</span><br><span class="line"><span class="meta">@Target(METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PostConstruct &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ JDK8 ä¹‹å‰ï¼Œè¯¥æ³¨è§£å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼›JDK9 ä¹‹åå¼•å…¥æ¨¡å—ç³»ç»Ÿï¼Œå°†è¯¥æ³¨è§£å‰”é™¤äº† JDKï¼Œå› æ­¤éœ€è¦å¼•å…¥é¢å¤–çš„ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>@PostConstruct</code> åªèƒ½ä½œç”¨äºæ–¹æ³•ä¸Šï¼Œ <strong>åœ¨ä¾èµ–æ³¨å…¥å®Œæˆåï¼Œæ‰§è¡Œä¸€æ¬¡è¢« <code>@PostConstruct</code> æ³¨è§£æ ‡è®°çš„æ–¹æ³•ã€‚</strong></p>
<p><strong>åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œè¢« <code>@PostConstruct</code> æ³¨è§£æ ‡è®°çš„æ–¹æ³•åªèƒ½æœ‰ä¸€ä¸ªã€‚</strong></p>
<p>è¢« <code>@PostConstruct</code> æ³¨è§£æ ‡è®°çš„æ–¹æ³•å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>
<p>è¯¥æ–¹æ³•ä¸èƒ½æœ‰ä»»ä½•å‚æ•°ï¼Œé™¤éæ˜¯æ‹¦æˆªå™¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ä¸€ä¸ªç”±æ‹¦æˆªå™¨è§„èŒƒå®šä¹‰çš„ <code>InvocationContext</code> å¯¹è±¡ï¼›</p>
</li>
<li>
<p>åœ¨æ‹¦æˆªå™¨ç±»æˆ–æ‹¦æˆªå™¨ç±»çš„è¶…ç±»ä¸Šå®šä¹‰çš„æ–¹æ³•å¿…é¡»å…·æœ‰ä»¥ä¸‹ç­¾åä¹‹ä¸€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void &lt;METHOD&gt;(InvocationContext)</span><br><span class="line">Object &lt;METHOD&gt;(InvocationContext) throws Exception</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š<code>@PostConstruct</code> æ ‡è®°çš„æ‹¦æˆªæ–¹æ³•ä¸å¾—æŠ›å‡ºåº”ç”¨ç¨‹åºå¼‚å¸¸ï¼Œä½†å¦‚æœåœ¨åŒä¸€ä¸ªæ‹¦æˆªæ–¹æ³•ä¸­é™¤äº†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤–è¿˜å¯¹ä¸šåŠ¡æˆ–è¶…æ—¶æ–¹æ³•è¿›è¡Œäº†æ‹¦æˆªï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>throws</code> æŠ›å‡ºåŒ…æ‹¬ <code>java.lang.Exception</code> åœ¨å†…çš„å—æ£€å¼‚å¸¸ã€‚å¦‚æœ <code>@PostConstruct</code> æ ‡è®°çš„æ‹¦æˆªæ–¹æ³•æœ‰è¿”å›å€¼ï¼Œå®¹å™¨ä¼šå¿½ç•¥è¯¥å€¼ï¼›</p>
</li>
<li>
<p>åœ¨éæ‹¦æˆªå™¨ç±»ä¸Šå®šä¹‰çš„æ–¹æ³•å¿…é¡»å…·æœ‰ä»¥ä¸‹ç­¾åï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void &lt;METHOD&gt;()</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¢« <code>@PostConstruct</code> æ³¨è§£æ ‡è®°çš„æ–¹æ³•å¯ä»¥æ˜¯ <code>public</code>ã€<code>protected</code>ã€<code>package private</code> æˆ– <code>private</code>ï¼›</p>
</li>
<li>
<p>é™¤åº”ç”¨ç¨‹åºå®¢æˆ·ç«¯å¤–ï¼Œè¯¥æ–¹æ³•ä¸èƒ½æ˜¯é™æ€æ–¹æ³•ï¼›</p>
</li>
<li>
<p>è¯¥æ–¹æ³•ä¸èƒ½æ˜¯ <code>final</code> çš„ï¼›</p>
</li>
<li>
<p>å¦‚æœè¯¥æ–¹æ³•æŠ›å‡ºä¸€ä¸ªéå—æ£€å¼‚å¸¸ï¼Œåˆ™è¯¥ç±»ä¸ä¼šæŠ•å…¥ä½¿ç”¨ï¼Œé™¤éè¯¥å¼‚å¸¸è¢«æ‹¦æˆªå™¨å¤„ç†ã€‚</p>
</li>
</ul>
<h2 id="8-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#8-2-ä½¿ç”¨æ–¹å¼"></a>8.2 ä½¿ç”¨æ–¹å¼</h2>
<p>æ¯”å¦‚å­˜åœ¨ <code>A07Example</code> ç±»ï¼Œå°†å…¶äº¤ç”± Spring ç®¡ç†ï¼Œå†…éƒ¨ä¾èµ–äº† <code>A07Dependence</code> ç±»å‹çš„ Beanï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;a07Example&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A07Dependence</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">A07Dependence</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. æ‰§è¡Œäº† A07Dependence çš„æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(BEAN_NAME)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A07Example</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> A07Dependence dependence;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">A07Example</span><span class="params">(A07Dependence dependence)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2. æ‰§è¡Œäº† A07Example çš„æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDependence</span><span class="params">(A07Dependence dependence)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dependence = dependence;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. A07Example æ³¨å…¥ dependence&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5. æ‰§è¡Œäº† @PostConstruct æ ‡è®°çš„æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æä¾›ä¸€ä¸ª <code>BeanPostProcessor</code> çš„å®ç°ç±»ï¼Œç”¨äºç¡®å®šè¢« <code>@PostConstruct</code> æ³¨è§£æ ‡è®°çš„æ–¹æ³•æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;4. æ‰§è¡Œäº† postProcessBeforeInitialization æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;6. æ‰§è¡Œäº† postProcessAfterInitialization æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A08ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A08ExtensionPoint.class, args);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. æ‰§è¡Œäº† A07Dependence çš„æ— å‚æ„é€ 
2. æ‰§è¡Œäº† A07Example çš„æ— å‚æ„é€ 
3. A07Example æ³¨å…¥ dependence
4. æ‰§è¡Œäº† postProcessBeforeInitialization æ–¹æ³•
5. æ‰§è¡Œäº† @PostConstruct æ ‡è®°çš„æ–¹æ³•
6. æ‰§è¡Œäº† postProcessAfterInitialization æ–¹æ³•
</pre>
<p><code>A07Example</code> è¿˜å®ç°äº† <code>InitializingBean</code> æ¥å£ï¼Œè¿™ä¼šåœ¨ä¸‹ä¸€èŠ‚è®²åˆ°ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¢« <code>@PostConstruct</code> æ ‡è®°çš„æ–¹æ³•ä¼šåœ¨ä¾èµ–æ³¨å…¥åã€<code>postProcessBeforeInitialization()</code> æ–¹æ³•åã€<code>postProcessAfterInitialization()</code> æ–¹æ³•å‰æ‰§è¡Œã€‚</p>
<h2 id="8-3-æ‰§è¡Œ"><a class="header-anchor" href="#8-3-æ‰§è¡Œ"></a>8.3 æ‰§è¡Œ</h2>
<p>è¢« <code>@PostConstruct</code> æ ‡è®°çš„æ–¹æ³•æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„å‘¢ï¼Ÿ</p>
<p>å‰æ–‡çš„ä½¿ç”¨ç¤ºä¾‹å¯ä»¥ç¡®å®šå¤§è‡´èŒƒå›´ï¼Œå¦‚æœéœ€è¦ç¡®å®šå‡†ç¡®çš„æ—¶é—´ç‚¹ï¼Œæœ€å¥½çš„æ–¹å¼è¿˜æ˜¯åœ¨è¢« <code>@PostConstruct</code> æ ‡è®°çš„æ–¹æ³•é‡Œæ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œé€šè¿‡æ–¹æ³•è°ƒç”¨æ ˆè¿›è¡Œè¿½è¸ªï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/%E6%96%AD%E7%82%B9%E8%A2%AB@PostConstruct%E6%A0%87%E8%AE%B0%E7%9A%84%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88.png" alt="æ–­ç‚¹è¢«@PostConstructæ ‡è®°çš„æ–¹æ³•çš„è°ƒç”¨æ ˆ"></p>
<p>åœ¨è°ƒç”¨æ ˆä¸­å¯ä»¥çœ‹åˆ°ç†Ÿæ‚‰çš„ <code>AbstractAutowireCapableBeanFactory#doCreateBean()</code> æ–¹æ³•ï¼Œæœ€ç»ˆæ¥åˆ° <code>AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInitialization()</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, </span></span><br><span class="line"><span class="params">                                                          String beanName)</span></span><br><span class="line">    <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">    <span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">        <span class="keyword">if</span> (current == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        result = current;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å¾ˆç†Ÿæ‚‰ï¼Œåœ¨å‰æ–‡ä»‹ç» <code>BeanPostProcessor</code> ä¸­æ–¹æ³•çš„æ‰§è¡Œæ—¶æœºæ—¶è¿›è¡Œäº†è®²è§£ï¼Œéš¾é“è¯´ <code>@PostConstruct</code> æ³¨è§£ä¼šç”± <code>BeanPostProcessor</code> çš„ä¸€ä¸ªå®ç°ç±»è¿›è¡Œè§£æï¼Ÿ</p>
<p>å®šä½åˆ°é‚£ä¸€æ­¥ï¼ŒæŸ¥çœ‹éå†çš„ <code>processor</code> æ˜¯ä½•è®¸äººä¹Ÿï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/%E4%BD%BF%E7%94%A8CommonAnnotationBeanPostProcessor%E8%A7%A3%E6%9E%90@PostConstruct%E6%B3%A8%E8%A7%A3.png" alt="ä½¿ç”¨CommonAnnotationBeanPostProcessorè§£æ@PostConstructæ³¨è§£"></p>
<p>å¼•å‡ºäº†ä¸€ä¸ªæ–°ç±»ï¼š<code>CommonAnnotationBeanPostProcessor</code>ã€‚</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/CommonAnnotationBeanPostProcessor%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="CommonAnnotationBeanPostProcessorçš„ç±»å›¾"></p>
<p><code>CommonAnnotationBeanPostProcessor</code> å¹¶æœªç›´æ¥å®ç° <code>BeanPostProcessor</code> æ¥å£ï¼Œè€Œæ˜¯ç»§æ‰¿äº† <code>InitDestroyAnnotationBeanPostProcessor</code>ï¼Œåè€…å®ç°äº† <code>BeanPostProcessor</code> çš„å­æ¥å£ï¼Œé‡å†™çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ä¹Ÿåœ¨è¿™ä¸ªç±»ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">    <span class="type">LifecycleMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> findLifecycleMetadata(bean.getClass());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        metadata.invokeInitMethods(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// catch å¼‚å¸¸å¹¶å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å…±å°±ä¸¤éƒ¨ï¼š</p>
<ol>
<li>å…ˆæ‰¾åˆ°ç”Ÿå‘½å‘¨æœŸå…ƒæ•°æ®ï¼Œå³ï¼š<code>LifecycleMetadata</code>ï¼›</li>
<li>ç„¶åæ ¹æ® <code>LifecycleMetadata</code> æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ã€‚</li>
</ol>
<blockquote>
<p><code>InitDestroyAnnotationBeanPostProcessor#findLifecycleMetadata()</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LifecycleMetadata <span class="title function_">findLifecycleMetadata</span><span class="params">(Class&lt;?&gt; beanClass)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.lifecycleMetadataCache == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Happens after deserialization, during destruction...</span></span><br><span class="line">      <span class="keyword">return</span> buildLifecycleMetadata(beanClass);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Quick check on the concurrent map first, with minimal locking.</span></span><br><span class="line">   <span class="type">LifecycleMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> <span class="built_in">this</span>.lifecycleMetadataCache.get(beanClass);</span><br><span class="line">   <span class="keyword">if</span> (metadata == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>.lifecycleMetadataCache) &#123;</span><br><span class="line">         metadata = <span class="built_in">this</span>.lifecycleMetadataCache.get(beanClass);</span><br><span class="line">         <span class="keyword">if</span> (metadata == <span class="literal">null</span>) &#123;</span><br><span class="line">            metadata = buildLifecycleMetadata(beanClass);</span><br><span class="line">            <span class="built_in">this</span>.lifecycleMetadataCache.put(beanClass, metadata);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> metadata;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹æ˜¯å…¶ä¸­çš„ <code>buildLifecycleMetadata()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LifecycleMetadata <span class="title function_">buildLifecycleMetadata</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; beanClass)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!AnnotationUtils.isCandidateClass(beanClass, <span class="built_in">this</span>.initAnnotationTypes) &amp;&amp;</span><br><span class="line">        !AnnotationUtils.isCandidateClass(beanClass, <span class="built_in">this</span>.destroyAnnotationTypes)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.emptyLifecycleMetadata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åç»­æ— éæ˜¯é€šè¿‡åå°„è·å– beanClass ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼Œ</span></span><br><span class="line">    <span class="comment">// æ”¶é›†ç›®æ ‡æ–¹æ³•ååŒ…è£…æˆ LifecycleMetadataï¼Œç„¶åè¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹æ˜¯ <code>AnnotationUtils.isCandidateClass()</code> æ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸¤æ¬¡ï¼Œå¦‚æœéƒ½è¿”å› <code>false</code> åˆ™ç›´æ¥è¿”å› <code>emptyLifecycleMetadata</code>ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>initAnnotationTypes</code> å’Œ <code>destroyAnnotationTypes</code> åº”è¯¥æ˜¯ç›®æ ‡æ³¨è§£ç±»å‹ï¼Œé‚£å®ƒä»¬çš„å€¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt;&gt; initAnnotationTypes = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt;&gt; destroyAnnotationTypes = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>ä»¥ <code>initAnnotationTypes</code> ä¸ºä¾‹ï¼Œæä¾›äº† <code>addInitAnnotationType()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInitAnnotationType</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;? extends Annotation&gt; initAnnotationType)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (initAnnotationType != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.initAnnotationTypes.add(initAnnotationType);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•åœ¨ <code>CommonAnnotationBeanPostProcessor</code> çš„æ„é€ å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œåˆ©ç”¨ <code>loadAnnotationType()</code> åŠ è½½æŒ‡å®šå…¨é™å®šç±»åçš„æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CommonAnnotationBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">   setOrder(Ordered.LOWEST_PRECEDENCE - <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Jakarta EE 9 set of annotations in jakarta.annotation package</span></span><br><span class="line">   addInitAnnotationType(loadAnnotationType(<span class="string">&quot;jakarta.annotation.PostConstruct&quot;</span>));</span><br><span class="line">   addDestroyAnnotationType(loadAnnotationType(<span class="string">&quot;jakarta.annotation.PreDestroy&quot;</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Tolerate legacy JSR-250 annotations in javax.annotation package</span></span><br><span class="line">   addInitAnnotationType(loadAnnotationType(<span class="string">&quot;javax.annotation.PostConstruct&quot;</span>));</span><br><span class="line">   addDestroyAnnotationType(loadAnnotationType(<span class="string">&quot;javax.annotation.PreDestroy&quot;</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// java.naming module present on JDK 9+?</span></span><br><span class="line">   <span class="keyword">if</span> (jndiPresent) &#123;</span><br><span class="line">      <span class="built_in">this</span>.jndiFactory = <span class="keyword">new</span> <span class="title class_">SimpleJndiBeanFactory</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³äº <code>loadAnnotationType()</code> çš„å®ç°é€»è¾‘ï¼Œæ— éæ˜¯å¯¹ <code>Class.forName()</code> çš„åŒ…è£…ï¼Œè¿™ä¸æ˜¯é‡ç‚¹ã€‚</p>
<p>å†å›åˆ° <code>AnnotationUtils.isCandidateClass()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCandidateClass</span><span class="params">(Class&lt;?&gt; clazz, Collection&lt;Class&lt;? extends Annotation&gt;&gt; annotationTypes)</span> &#123;</span><br><span class="line">   <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; annotationType : annotationTypes) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isCandidateClass(clazz, annotationType)) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨è°ƒç”¨äº† <code>isCandidateClass()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCandidateClass</span><span class="params">(Class&lt;?&gt; clazz, <span class="meta">@Nullable</span> Class&lt;? extends Annotation&gt; annotationType)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> (annotationType != <span class="literal">null</span> &amp;&amp; isCandidateClass(clazz, annotationType.getName()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆè°ƒç”¨é‡è½½çš„ <code>isCandidateClass()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCandidateClass</span><span class="params">(Class&lt;?&gt; clazz, String annotationName)</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨è§£ä»¥ `java.` å¼€å¤´ï¼Œç›´æ¥è¿”å› true</span></span><br><span class="line">    <span class="keyword">if</span> (annotationName.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (AnnotationsScanner.hasPlainJavaAnnotationsOnly(clazz)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åè°ƒç”¨äº† <code>AnnotationsScanner.hasPlainJavaAnnotationsOnly()</code> æ–¹æ³•ï¼Œå¦‚æœå®ƒè¿”å› <code>true</code>ï¼Œæœ€ç»ˆè¿”å› <code>false</code>ï¼Œå¦åˆ™æœ€ç»ˆè¿”å› <code>true</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">hasPlainJavaAnnotationsOnly</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç›®æ ‡ç±»çš„å…¨é™å®šç±»åä»¥ `java.` å¼€å¤´ï¼Œæˆ–è€…æ˜¯ Ordered çš„å­ç±»ï¼Œå°±è¿”å› true</span></span><br><span class="line">    <span class="keyword">return</span> (type.getName().startsWith(<span class="string">&quot;java.&quot;</span>) || type == Ordered.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æäº†åŠå¤©ï¼Œå¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆæœ‰æ„æ€çš„ä¸œè¥¿â€¦ ğŸ˜…</p>
<blockquote>
<p><code>InitDestroyAnnotationBeanPostProcessor.LifecycleMetadata#invokeInitMethods()</code></p>
</blockquote>
<p>å›åˆ° <code>invokeInitMethods()</code> æ–¹æ³•ï¼Œçœ‹çœ‹æ˜¯æ€ä¹ˆæ‰§è¡Œç›®æ ‡æ–¹æ³•çš„ï¼Œå¤šåŠæ˜¯éå†æ¯ä¸ªç›®æ ‡æ–¹æ³•ç„¶ååˆ©ç”¨åå°„å»æ‰§è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(Object target, String beanName)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">   Collection&lt;LifecycleMethod&gt; checkedInitMethods = <span class="built_in">this</span>.checkedInitMethods;</span><br><span class="line">   Collection&lt;LifecycleMethod&gt; initMethodsToIterate =</span><br><span class="line">         (checkedInitMethods != <span class="literal">null</span> ? checkedInitMethods : <span class="built_in">this</span>.initMethods);</span><br><span class="line">   <span class="keyword">if</span> (!initMethodsToIterate.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (LifecycleMethod lifecycleMethod : initMethodsToIterate) &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">&quot;Invoking init method on bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;: &quot;</span> + lifecycleMethod.getMethod());</span><br><span class="line">         &#125;</span><br><span class="line">         lifecycleMethod.invoke(target);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆæ˜¯éå†ï¼Œç„¶åæ‰§è¡Œäº† <code>InitDestroyAnnotationBeanPostProcessor.LifecycleMethod#invoke()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">   ReflectionUtils.makeAccessible(<span class="built_in">this</span>.method);</span><br><span class="line">   <span class="built_in">this</span>.method.invoke(target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœä¸å…¶ç„¶ï¼Œå°è¯äº†å‰é¢çš„çŒœæƒ³ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>æ‰§è¡Œé€»è¾‘å¾ˆç®€å•ï¼Œæ¦‚æ‹¬åå°±ä¸¤æ­¥ï¼š</p>
<ol>
<li>éå†ç›®æ ‡ç±»ä¸­çš„æ¯ä¸ªæ–¹æ³•ï¼Œæ”¶é›†è¢«æŒ‡å®šæ³¨è§£æ ‡è®°çš„æ–¹æ³•ï¼›</li>
<li>åå°„æ‰§è¡Œè¢«æŒ‡å®šæ³¨è§£æ ‡è®°çš„æ–¹æ³•</li>
</ol>
<h1 id="9-åˆå§‹åŒ–-Bean"><a class="header-anchor" href="#9-åˆå§‹åŒ–-Bean"></a>9. åˆå§‹åŒ– Bean</h1>
<h2 id="9-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#9-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>9.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>åˆå§‹åŒ– Beanï¼Œå³ï¼š<code>InitializingBean</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å±æ€§æ³¨å…¥åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ä»…æœ‰ä¸€ä¸ªæ— å‚æ— è¿”å›å€¼çš„ <code>afterPropertiesSet()</code>ï¼Œæ ¹æ®æ–¹æ³•åç§°å¯çŸ¥ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆæœ‰å¯èƒ½åœ¨å±æ€§æ³¨å…¥åæ‰§è¡Œã€‚</p>
<h2 id="9-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#9-2-ä½¿ç”¨æ–¹å¼"></a>9.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>InitializingBean</code> æ¥å£å¹¶é‡å†™ <code>afterPropertiesSet()</code> æ–¹æ³•ï¼Œå°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼Œå¹¶ä¸”åœ¨ç±»ä¸­ä½¿ç”¨ <code>@PostConstruct</code> æ³¨è§£æ ‡è®°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXAMPLE_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;a08-example&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A08Dependence</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A08Example</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> A08Dependence dependence;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDependence</span><span class="params">(A08Dependence dependence)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dependence = dependence;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. A08Example æ³¨å…¥ dependence&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4. æ‰§è¡Œäº† afterPropertiesSet æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. æ‰§è¡Œäº† init æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5. æ‰§è¡Œäº† init-method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(value = EXAMPLE_BEAN_NAME, initMethod = &quot;initMethod&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> A08Example <span class="title function_">a08Example</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">A08Example</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·æä¾›ä¸€ä¸ª <code>BeanPostProcessor</code> çš„å®ç°ç±»ï¼Œç”¨äºç¡®å®š <code>afterPropertiesSet()</code> æ–¹æ³•æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2. æ‰§è¡Œäº† postProcessBeforeInitialization æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (EXAMPLE_BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;5. æ‰§è¡Œäº† postProcessAfterInitialization æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A09ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A09ExtensionPoint.class, args);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. A08Example æ³¨å…¥ dependence
2. æ‰§è¡Œäº† postProcessBeforeInitialization æ–¹æ³•
3. æ‰§è¡Œäº† init æ–¹æ³•
4. æ‰§è¡Œäº† afterPropertiesSet æ–¹æ³•
5. æ‰§è¡Œäº† init-method
6. æ‰§è¡Œäº† postProcessAfterInitialization æ–¹æ³•
</pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>afterPropertiesSet()</code> æ–¹æ³•åœ¨ <code>postProcessAfterInitialization()</code> æ–¹æ³•å‰æ‰§è¡Œï¼ŒåŒæ—¶è¿˜åœ¨ <code>init-method</code> æ–¹æ³•å‰æ‰§è¡Œã€‚</p>
<h2 id="9-3-æ‰§è¡Œ"><a class="header-anchor" href="#9-3-æ‰§è¡Œ"></a>9.3 æ‰§è¡Œ</h2>
<p>å‰æ–‡çš„ä½¿ç”¨ç¤ºä¾‹å¯ä»¥ç¡®å®šå¤§è‡´èŒƒå›´ï¼Œè¦ç¡®å®šå‡†ç¡®çš„èŒƒå›´ä¹Ÿå¯ä»¥åˆ©ç”¨æ–­ç‚¹æŸ¥çœ‹æ–¹æ³•è°ƒç”¨æ ˆï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/%E6%96%AD%E7%82%B9afterPropertiesSet%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88.png" alt="æ–­ç‚¹afterPropertiesSetæ–¹æ³•çš„è°ƒç”¨æ ˆ"></p>
<p>åˆè§ç†Ÿæ‚‰çš„ <code>doCreateBean()</code> æ–¹æ³•ï¼Œä¹‹åè¿›å…¥ <code>initializeBean()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">    invokeAwareMethods(beanName, bean);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> bean;</span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            (mbd != <span class="literal">null</span> ? mbd.getResourceDescription() : <span class="literal">null</span>), beanName, ex.getMessage(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œåè°ƒç”¨ <code>invokeInitMethods()</code> æ–¹æ³•ï¼Œæ ¹æ®è°ƒç”¨æ–¹æ³•æ ˆå¯çŸ¥ï¼Œåœ¨è°ƒç”¨ <code>invokeInitMethods()</code> æ–¹æ³•åï¼Œå°±æ‰§è¡Œäº†é‡å†™çš„ <code>afterPropertiesSet()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                                 Object bean, </span></span><br><span class="line"><span class="params">                                 <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çš„ Bean ä¹Ÿæ˜¯ InitializingBean å®ä¾‹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isInitializingBean</span> <span class="operator">=</span> (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line">    <span class="keyword">if</span> (isInitializingBean &amp;&amp; </span><br><span class="line">        <span class="comment">// ä¸å«åä¸º afterPropertiesSet çš„å¤–éƒ¨ç®¡ç†åˆå§‹æ–¹æ³•</span></span><br><span class="line">        (mbd == <span class="literal">null</span> || !mbd.hasAnyExternallyManagedInitMethod(<span class="string">&quot;afterPropertiesSet&quot;</span>))) &#123;</span><br><span class="line">        <span class="comment">// çœç•¥æ‰“å°æ—¥å¿—</span></span><br><span class="line">        <span class="comment">// æ‰§è¡Œ afterPropertiesSet æ–¹æ³•</span></span><br><span class="line">        ((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mbd != <span class="literal">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰åˆå§‹æ–¹æ³•å</span></span><br><span class="line">        String[] initMethodNames = mbd.getInitMethodNames();</span><br><span class="line">        <span class="keyword">if</span> (initMethodNames != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// éå†åˆå§‹åŒ–æ–¹æ³•å</span></span><br><span class="line">            <span class="keyword">for</span> (String initMethodName : initMethodNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">                    !(isInitializingBean &amp;&amp; <span class="string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">                    !mbd.hasAnyExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">                    <span class="comment">// åˆ©ç”¨åå°„æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹æ–¹æ³•</span></span><br><span class="line">                    invokeCustomInitMethod(beanName, bean, mbd, initMethodName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç¬¬ä¸€ä¸ª <code>if</code> åˆ¤æ–­ä¸­æ‰§è¡Œäº† <code>InitializingBean</code> çš„ <code>afterPropertiesSet()</code> æ–¹æ³•ã€‚</p>
<p>å¦‚æœå¯¹ä½¿ç”¨ç¤ºä¾‹çš„ <code>initMethod()</code> æ–¹æ³•è¿›è¡Œæ–­ç‚¹ï¼Œåˆ™ä¼šè¿›å…¥ç¬¬äºŒä¸ª <code>if</code> åˆ†æ”¯ï¼Œåœ¨å†…éƒ¨è°ƒç”¨ <code>invokeCustomInitMethod()</code> æ–¹æ³•åˆ©ç”¨åå°„æ‰§è¡Œ <code>initMethod()</code> æ–¹æ³•ã€‚</p>
<h2 id="9-4-å†…ç½®å®ç°"><a class="header-anchor" href="#9-4-å†…ç½®å®ç°"></a>9.4 å†…ç½®å®ç°</h2>
<p>åˆ©ç”¨ <code>InitializingBean</code> æ¥å£å¯ä»¥ä¿®æ”¹é»˜è®¤è®¾ç½®çš„å±æ€§å€¼ã€æ·»åŠ é¢å¤–çš„å±æ€§å€¼ï¼Œæˆ–è€…å¯¹æŸäº›å±æ€§å€¼è¿›è¡Œæ ¡éªŒï¼Œåœ¨ Spring MVC ä¸­æœ‰ä¸ªåä¸º <code>RequestMappingHandlerMapping</code> çš„ç±»ï¼Œç”¨äºå®ç° Controller ä¸ URL çš„æ˜ å°„ã€‚å®ƒä¹Ÿå®ç°äº† <code>InitializingBean</code> æ¥å£ï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/RequestMappingHandlerMapping%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="RequestMappingHandlerMappingçš„ç±»å›¾"></p>
<h1 id="10-æ™ºèƒ½åˆå§‹åŒ–å•ä¾‹"><a class="header-anchor" href="#10-æ™ºèƒ½åˆå§‹åŒ–å•ä¾‹"></a>10. æ™ºèƒ½åˆå§‹åŒ–å•ä¾‹</h1>
<h2 id="10-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#10-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>10.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>æ™ºèƒ½åˆå§‹åŒ–å•ä¾‹ï¼Œå³ï¼š<code>SmartInitializingSingleton</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SmartInitializingSingleton</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åœ¨å•ä¾‹ Bean é¢„å®ä¾‹åŒ–é˜¶æ®µç»“æŸåè°ƒç”¨ï¼Œä¿è¯å·²ç»åˆ›å»ºäº†æ‰€æœ‰å¸¸è§„çš„å•ä¾‹ Beanã€‚</span></span><br><span class="line"><span class="comment">    * åœ¨æ­¤æ–¹æ³•ä¸­è°ƒç”¨ `ListableBeanFactory.getBeansOfType()` æ–¹æ³•ä¸ä¼šåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­</span></span><br><span class="line"><span class="comment">    * è§¦å‘æ„å¤–çš„å‰¯ä½œç”¨ã€‚</span></span><br><span class="line"><span class="comment">    * æ³¨æ„ï¼šå¯¹äºæ‡’åŠ è½½çš„å•ä¾‹ Bean å’Œå¤šä¾‹ Beanï¼Œåœ¨ BeanFactory å¯åŠ¨åï¼Œä¸ä¼šè§¦å‘</span></span><br><span class="line"><span class="comment">    * æ­¤å›è°ƒã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œä»…ç”¨äºå…·æœ‰é¢„æœŸå¯åŠ¨å«ä¹‰çš„ Beanã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">afterSingletonsInstantiated</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ä»…æœ‰ä¸€ä¸ªæ— å‚æ— è¿”å›å€¼çš„ <code>afterSingletonsInstantiated()</code>ï¼Œæ ¹æ®æ–¹æ³•åç§°å¯çŸ¥ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆæœ‰å¯èƒ½åœ¨ Bean åˆå§‹åŒ–åæ‰§è¡Œã€‚</p>
<p><mark>æ³¨æ„ï¼š</mark> æ˜¯åœ¨æ‰€æœ‰å•ä¾‹ Bean åˆå§‹åŒ–å®Œæˆåæ‰§è¡Œï¼Œå¯¹æ‡’åŠ è½½å•ä¾‹ Bean å’Œå¤šä¾‹ Bean åˆ™æ²¡è¦æ±‚ã€‚</p>
<h2 id="10-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#10-2-ä½¿ç”¨æ–¹å¼"></a>10.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>SmartInitializingSingleton</code> æ¥å£ï¼Œé‡å†™ <code>afterSingletonsInstantiated()</code> æ–¹æ³•ï¼Œå¹¶å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;myBean&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(BEAN_NAME)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySmartInitializingSingleton</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, SmartInitializingSingleton &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. æ‰§è¡Œäº† afterPropertiesSet æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterSingletonsInstantiated</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. æ‰§è¡Œäº† afterSingletonsInstantiated æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·æä¾›ä¸€ä¸ª <code>BeanPostProcessor</code> çš„å®ç°ç±»ï¼Œåªé‡å†™ <code>postProcessAfterInitialization()</code> æ–¹æ³•ï¼Œç”¨äºç¡®å®š <code>afterSingletonsInstantiated()</code> æ–¹æ³•æ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (BEAN_NAME.equals(beanName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2. æ‰§è¡Œäº† postProcessAfterInitialization æ–¹æ³•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A10ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A10ExtensionPoint.class, args);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. æ‰§è¡Œäº† afterPropertiesSet æ–¹æ³•
2. æ‰§è¡Œäº† postProcessAfterInitialization æ–¹æ³•
3. æ‰§è¡Œäº† afterSingletonsInstantiated æ–¹æ³•
</pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>afterSingletonsInstantiated()</code> ä¼šåœ¨ <code>postProcessAfterInitialization()</code> æ–¹æ³•åæ‰§è¡Œï¼Œç¡®å®æ˜¯åœ¨ Bean åˆå§‹åŒ–å®Œæˆåæ‰§è¡Œã€‚</p>
<h2 id="10-3-æ‰§è¡Œ"><a class="header-anchor" href="#10-3-æ‰§è¡Œ"></a>10.3 æ‰§è¡Œ</h2>
<p>è‡³äºæ‰§è¡Œæ—¶æœºï¼Œå…¶å®åœ¨ã€4.3 æ³¨å†Œä¸æ‰§è¡Œã€‘ä¸­ä»‹ç» <code>BeanPostProcessor</code> çš„æ‰§è¡Œæ—¶æœºæ—¶å·²ç»ä»‹ç»è¿‡ã€‚</p>
<p>ç›®å‰å·²çŸ¥çš„æƒ…æŠ¥æ˜¯ä¼šåœ¨å•ä¾‹ Bean åˆå§‹åŒ–å®Œæˆåæ‰§è¡Œ <code>afterSingletonsInstantiated()</code> æ–¹æ³•ã€‚</p>
<p>ä»¥ <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•ä¸ºå…¥å£ï¼š</p>
<pre><code class="highlight mermaid">flowchart TD
1(&quot;AbstractApplicationContext#refresh()&quot;)
2(&quot;AbstractApplicationContext#finishBeanFactoryInitialization()&quot;)
3(&quot;DefaultListableBeanFactory#preInstantiateSingletons()&quot;)
1 --&gt; 2 --&gt; 3</code></pre>
<p>åœ¨ <code>preInstantiateSingletons()</code> æ–¹æ³•ä¸­æœ‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger initialization of all non-lazy singleton beans...</span></span><br><span class="line">    <span class="comment">// è§¦å‘æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹ Bean çš„åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton smartSingleton) &#123;</span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">smartInitialize</span> <span class="operator">=</span> getApplicationStartup().start(<span class="string">&quot;spring.beans.smart-initialize&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;beanName&quot;</span>, beanName);</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ afterSingletonsInstantiated() æ–¹æ³•</span></span><br><span class="line">            smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">            smartInitialize.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè¿‡ç¨‹å¾ˆç®€å•ï¼Œå‡ æ­¥å°±èµ°åˆ°äº† <code>afterSingletonsInstantiated()</code> çš„æ‰§è¡Œç‚¹ã€‚</p>
<h1 id="11-ä¸¤ä¸ªè¿è¡Œå™¨"><a class="header-anchor" href="#11-ä¸¤ä¸ªè¿è¡Œå™¨"></a>11. ä¸¤ä¸ªè¿è¡Œå™¨</h1>
<h2 id="11-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#11-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>11.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>æœ¬èŠ‚æ‹“å±•ç‚¹çš„åå­—å¹¶ä¸æ˜¯çœŸçš„å«ã€Œä¸¤ä¸ªè¿è¡Œå™¨ã€ï¼ŒğŸ˜‚ è€Œæ˜¯å°†åœ¨æœ¬èŠ‚ä»‹ç»ä¸¤ä¸ªæ‹“å±•ç‚¹ï¼Œå®ƒä»¬ä»¥ <code>Runner</code> ç»“å°¾ï¼Œç¿»è¯‘æˆè¿è¡Œå™¨ä¹Ÿæ²¡å•¥é—®é¢˜ã€‚</p>
<p>è¿™ä¸¤ä¸ªè¿è¡Œå™¨åˆ†åˆ«æ˜¯ <code>CommandLineRunner</code> å’Œ <code>ApplicationRunner</code>ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦åœ¨æœ¬èŠ‚ä¸€èµ·ä»‹ç»ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å¾ˆç±»ä¼¼ï¼Œæ‰§è¡Œæ—¶é—´ç‚¹ä¹Ÿå¾ˆé è¿‘ï¼Œå®ƒä»¬éƒ½æ‹¥æœ‰åä¸º <code>run()</code> çš„æ–¹æ³•ï¼Œåªæ˜¯å‚æ•°ä¸åŒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢ä»‹ç»çš„æ‹“å±•ç‚¹éƒ½æ˜¯åœ¨ Spring ä¸­æœ¬èº«å°±å­˜åœ¨çš„ï¼Œè€Œä¸æ˜¯ SpringBoot å•ç‹¬æä¾›çš„ï¼Œè€Œæœ¬èŠ‚çš„è¿™ä¸¤ä¸ªè¿è¡Œå™¨åˆ™æ˜¯ç”± SpringBoot æä¾›ã€‚</p>
<p><code>ApplicationRunner</code> ä¼šæ—©äº <code>CommandLineRunner</code> æ‰§è¡Œï¼Œå®ƒä»¬éƒ½å°†åœ¨ Spring å®¹å™¨ã€Web å®¹å™¨å¯åŠ¨åï¼Œæ­£å¼å¤„ç†ä¸šåŠ¡è¯·æ±‚å‰ï¼ˆå³é¡¹ç›®å¯åŠ¨çš„æœ€åä¸€æ­¥ï¼‰æ‰§è¡Œã€‚</p>
<p>è¿™ä¸¤ä¸ªæ¥å£å¯ç”¨äºæ­£å¼å¤„ç†ä¸šåŠ¡è¯·æ±‚å‰é¢„åŠ è½½çƒ­ç‚¹æ•°æ®ã€æ¸…é™¤ä¸´æ—¶æ–‡ä»¶ã€è¯»å–è‡ªå®šä¹‰é…ç½®ä¿¡æ¯ç­‰ã€‚</p>
<p>åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª <code>ApplicationRunner</code> æˆ– <code>CommandLineRunner</code>ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>Ordered</code> æ¥å£æˆ– <code>@Order</code> æ³¨è§£å¯¹è¿™äº›è¿è¡Œå™¨çš„æ‰§è¡Œé¡ºåºè¿›è¡Œæ’åºã€‚</p>
<h2 id="11-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#11-2-ä½¿ç”¨æ–¹å¼"></a>11.2 ä½¿ç”¨æ–¹å¼</h2>
<p>åˆ†åˆ«å®ç° <code>ApplicationRunner</code> å’Œ <code>CommandLineRunner</code> æ¥å£ï¼Œé‡å†™å…¶ä¸­çš„ <code>run()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COMMAND_LINE_BEAN</span> <span class="operator">=</span> <span class="string">&quot;command-line-bean&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APPLICATION_BEAN</span> <span class="operator">=</span> <span class="string">&quot;application-bean&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(COMMAND_LINE_BEAN)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyCommandLineRunner</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ CommandLineRunner&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(APPLICATION_BEAN)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyApplicationRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ ApplicationRunner&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡æä¾›ä¸€ä¸ª <code>BeanPostProcessor</code> çš„å®ç°ç±»ï¼Œåªé‡å†™ <code>postProcessAfterInitialization()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; BEAN_NAMES = Set.of(COMMAND_LINE_BEAN, APPLICATION_BEAN);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">if</span> (BEAN_NAMES.contains(beanName)) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;æ£€æµ‹åˆ°æŒ‡å®š Bean:[%s] çš„ postProcessAfterInitialization æ–¹æ³•%n&quot;</span>, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A11ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A11ExtensionPoint.class);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
æ£€æµ‹åˆ°æŒ‡å®š Bean:[application-bean] çš„ postProcessAfterInitialization æ–¹æ³•
æ£€æµ‹åˆ°æŒ‡å®š Bean:[command-line-bean] çš„ postProcessAfterInitialization æ–¹æ³•
æ‰§è¡Œ ApplicationRunner
æ‰§è¡Œ CommandLineRunner
</pre>
<p>æ ¹æ®ä½¿ç”¨ç¤ºä¾‹å¯çŸ¥ <code>ApplicationRunner</code> ç¡®å®ä¼šæ—©äº <code>CommandLineRunner</code> æ‰§è¡Œã€‚</p>
<h2 id="11-3-æ‰§è¡Œ"><a class="header-anchor" href="#11-3-æ‰§è¡Œ"></a>11.3 æ‰§è¡Œ</h2>
<p>å‰æ–‡ä¸­è®¸å¤šæ‹“å±•ç‚¹éƒ½ä¸ <code>refresh()</code> æ–¹æ³•æœ‰å…³ï¼Œ<code>refresh</code> ä¸€è¯å¯è¯‘ä¸ºã€Œåˆ·æ–°ã€ï¼Œè¡¨ç¤ºåˆ·æ–°ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯å°† Bean æ·»åŠ åˆ° Spring å®¹å™¨ï¼ˆSpring å®¹å™¨æ˜¯ Spring ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†ï¼‰ä¸­ã€‚ä»ä½¿ç”¨ç¤ºä¾‹å¯çŸ¥ï¼Œæœ¬èŠ‚çš„ä¸¤ä¸ªæ‹“å±•ç‚¹ä¼šåœ¨ Bean åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¸ä¼šåœ¨ <code>refresh()</code> æ–¹æ³•ä¸­æ‰§è¡Œã€‚</p>
<p>ä» Spring ä¸»å¯åŠ¨ç±»å‡ºå‘ï¼š</p>
<pre><code class="highlight mermaid">flowchart TD
1(&quot;SpringApplication#run(java.lang.Class&lt;?&gt;, java.lang.String...)&quot;)
2(&quot;SpringApplication#run(java.lang.Class&lt;?&gt;[], java.lang.String[])&quot;)
3(&quot;SpringApplication#run(java.lang.String...)&quot;)

1 --&gt; 2 --&gt; 3</code></pre>
<p>æ‰§è¡Œæ—¶æœºæ—¢ä¸åœ¨ <code>refreshContext()</code> ä¸­ï¼Œä¹Ÿä¸åœ¨ <code>afterRefresh()</code> ä¸­ï¼Œè€Œæ˜¯åœ¨æœ€åçš„ <code>callRunners()</code> ä¸­ï¼Œè¿™æ–¹æ³•åç§°ä¹Ÿå¾ˆæ˜ç¡®â€”â€”è°ƒç”¨è¿è¡Œå™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callRunners</span><span class="params">(ApplicationContext context, ApplicationArguments args)</span> &#123;</span><br><span class="line">    List&lt;Object&gt; runners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// ä»å®¹å™¨ä¸­è·å–ä¸¤ç§è¿è¡Œå™¨</span></span><br><span class="line">    runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());</span><br><span class="line">    runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());</span><br><span class="line">    <span class="comment">// å¯¹ä»–ä»¬æ’ä¸ªåº</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">    <span class="comment">// éå†å¹¶ä¸€ä¸€æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">for</span> (Object runner : <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(runners)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> ApplicationRunner applicationRunner) &#123;</span><br><span class="line">            callRunner(applicationRunner, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> CommandLineRunner commandLineRunner) &#123;</span><br><span class="line">            callRunner(commandLineRunner, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="12-å·¥å‚-Bean"><a class="header-anchor" href="#12-å·¥å‚-Bean"></a>12. å·¥å‚ Bean</h1>
<h2 id="12-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#12-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>12.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>å·¥å‚ Beanï¼Œå³ï¼š<code>FactoryBean</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">OBJECT_TYPE_ATTRIBUTE</span> <span class="operator">=</span> <span class="string">&quot;factoryBeanObjectType&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Class&lt;?&gt; getObjectType();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FactoryBean</code> å…¶å®å¹¶ä¸èƒ½è®¤ä¸ºæ˜¯æ‹“å±•ç‚¹ï¼Œå®ƒæ˜¯åˆ›å»ºå¤æ‚ Bean çš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>åœ¨ Spring ä¸­æœ‰ä¸€ä¸ªç±»ä¼¼çš„æ¥å£ï¼Œåä¸º <code>BeanFactory</code>ï¼Œæœ‰ä¸€é“å¸¸è§çš„é¢è¯•é¢˜ï¼š<code>BeanFactory</code> ä¸ <code>FactoryBean</code> æœ‰ä»€ä¹ˆå¼‚åŒï¼Ÿ</p>
<p>å®ƒä»¬ä¹‹é—´çš„å¼‚å€’æ˜¯å¾ˆå¤§ï¼Œè‡³äºåŒå°±åªæœ‰åå­—é•¿å¾—æ¯”è¾ƒç›¸ä¼¼äº†ã€‚<code>BeanFactory</code> è¯‘ä¸ºã€ŒBean å·¥å‚ã€ï¼Œå³ç”Ÿäº§å­˜å‚¨ Bean çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ Spring å®¹å™¨ï¼›<code>FactoryBean</code> è¯‘ä¸ºã€Œå·¥å‚ Beanã€ï¼Œæ˜¯åˆ›å»º Bean çš„ä¸€ç§æ–¹å¼ï¼Œå°±åƒè®¾è®¡æ¨¡å¼ä¸­çš„å·¥å‚æ¨¡å¼ä¸€æ ·ã€‚</p>
<p><code>FactoryBean</code> ä¸­æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>getObject()</code>ï¼šè·å– Bean å¯¹è±¡ï¼Œç”¨äºåˆ›å»ºä¸€äº›éš¾ä»¥ä½¿ç”¨å¸¸è§„æ–¹å¼åˆ›å»ºçš„ Beanï¼›</li>
<li><code>getObjectType()</code>ï¼šç”¨äºè·å–è¿”å› Bean çš„ç±»å‹ï¼›</li>
<li><code>isSingleton()</code>ï¼šåˆ›å»ºçš„ Bean æ˜¯å¦æ˜¯å•ä¾‹ Beanï¼Œé»˜è®¤ <code>true</code>ã€‚</li>
</ul>
<h2 id="12-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#12-2-ä½¿ç”¨æ–¹å¼"></a>12.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å‡è®¾å­˜åœ¨åä¸º <code>Owl</code> çš„ã€Œå¤æ‚ç±»ã€ï¼Œå°½ç®¡å¹¶ä¸å¤æ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Owl</span> &#123;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Owl</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œäº†æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Owl</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œäº†æœ‰å‚(name)æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™ <code>FactoryBean</code> çš„å®ç°ç±»ï¼Œé‡å†™å…¶ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå…¶ä¸­çš„ <code>getObject()</code> æ–¹æ³•è¿”å› <code>Owl</code> å®ä¾‹ï¼Œå¹¶å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OWL_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;owl&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(OWL_BEAN_NAME)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OwlFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Owl&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OwlFactoryBean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œäº† OwlFactoryBean çš„æ— å‚æ„é€ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Owl <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ getObject--start&quot;</span>);</span><br><span class="line">        <span class="type">Owl</span> <span class="variable">owl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Owl</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œ getObject--end&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> owl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Owl.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A12ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">            SpringApplication.run(A12ExtensionPoint.class);</span><br><span class="line">        <span class="comment">// é€šè¿‡ bean çš„ name è·å–</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(OWL_BEAN_NAME);</span><br><span class="line">        Assert.isInstanceOf(Owl.class, bean);</span><br><span class="line">        bean = context.getBean(BeanFactory.FACTORY_BEAN_PREFIX + OWL_BEAN_NAME);</span><br><span class="line">        Assert.isInstanceOf(OwlFactoryBean.class, bean);</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
æ‰§è¡Œäº† OwlFactoryBean çš„æ— å‚æ„é€ 
æ‰§è¡Œ getObject--start
æ‰§è¡Œäº†æ— å‚æ„é€ 
æ‰§è¡Œ getObject--end
</pre>
<p>ä»å®¹å™¨ä¸­æŒ‰ç…§åç§°è·å–ä¸ <code>OwlFactoryBean</code> åŒåçš„ Bean æ—¶ï¼Œå¾—åˆ°çš„ Bean çš„ç±»å‹å¹¶ä¸æ˜¯ <code>OwlFactoryBean</code>ï¼Œè€Œæ˜¯ <code>Owl</code> ç±»å‹çš„ï¼Œå¦‚æœè¦è·å–åŸå§‹ç±»å‹ï¼Œåˆ™éœ€è¦åœ¨åç§°å‰æ·»åŠ  <code>&amp;</code>ï¼ˆæœ‰ç‚¹ C è¯­è¨€çš„å‘³é“ï¼‰ã€‚</p>
<h2 id="12-3-æ³¨å†Œ"><a class="header-anchor" href="#12-3-æ³¨å†Œ"></a>12.3 æ³¨å†Œ</h2>
<p>åœ¨æ³¨å†Œ <code>FactoryBean</code> ç±»å‹çš„ Bean æ—¶ï¼ŒæŒ‰ç…§ç»™å®šçš„ Bean åç§°æˆ–è€…é»˜è®¤è§„åˆ™è¿›è¡Œæ³¨å†Œï¼Œåœ¨ Spring å®¹å™¨ä¸­åªä¼šå­˜åœ¨ <code>FactoryBean</code> ç±»å‹çš„ Beanï¼Œä¸ä¼šå­˜åœ¨ <code>getObjectType()</code> è¿”å›çš„ç±»å‹ã€ <code>getObject()</code> è¿”å›çš„å¯¹è±¡çš„ Beanã€‚</p>
<p>é€šè¿‡ <code>getBean()</code> æ–¹æ³•æŒ‰ç…§æ³¨å†Œçš„ <code>FactoryBean</code> ç±»å‹çš„ Bean çš„åç§°åœ¨ Spring å®¹å™¨ä¸­è·å– Bean æ—¶ï¼Œè·å–åˆ°çš„æ˜¯ <code>getObject()</code> è¿”å›çš„å¯¹è±¡ï¼Œèƒ½å¤Ÿè·å–åˆ°è¿™æ ·çš„å¯¹è±¡æ˜¯ <code>getBean()</code> æ–¹æ³•ä¸­çš„ç»†èŠ‚ï¼Œè€Œä¸æ˜¯åœ¨ Spring å®¹å™¨ä¸­çœŸå®å­˜åœ¨çš„ã€‚</p>
<h2 id="12-4-æ‰§è¡Œ"><a class="header-anchor" href="#12-4-æ‰§è¡Œ"></a>12.4 æ‰§è¡Œ</h2>
<p>åç§°çš„ç»†å¾®å·®åˆ«èƒ½å¤Ÿé€šè¿‡ <code>getBean()</code> æ–¹æ³•è·å–åˆ°ä¸åŒçš„ Bean å¯¹è±¡ï¼Œé‚£ä¹ˆå°±çœ‹çœ‹ <code>getBean()</code> ä¸­çš„ç»†èŠ‚å§ã€‚</p>
<pre><code class="highlight mermaid">flowchart TD
1(&quot;AbstractBeanFactory#getBean(java.lang.String)&quot;)
2(&quot;AbstractBeanFactory#doGetBean()&quot;)

1 --&gt; 2</code></pre>
<p>æ¥åˆ° <code>doGetBean()</code> æ–¹æ³•åï¼Œä¸ä¼šåƒå‰æ–‡åˆ†æçš„é‚£æ ·æ¥åˆ° <code>createBean()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(</span></span><br><span class="line"><span class="params">    String name, <span class="meta">@Nullable</span> Class&lt;T&gt; requiredType, </span></span><br><span class="line"><span class="params">    <span class="meta">@Nullable</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> transformedBeanName(name);</span><br><span class="line">    Object beanInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å•ä¾‹ç¼“å­˜æ€»æ˜¯å¦æœ‰æ‰‹åŠ¨åˆ›å»ºçš„å•ä¾‹ Bean</span></span><br><span class="line">    <span class="comment">// ä»¥ owl ä¸ºä¾‹ï¼Œè·å–åˆ°çš„æ˜¯ FactoryBean å¯¹è±¡</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">    <span class="keyword">if</span> (sharedInstance != <span class="literal">null</span> &amp;&amp; args == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ‰“å°äº†äº›æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç»™å®š Bean å®ä¾‹çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯ Bean å®ä¾‹æœ¬èº«ï¼Œä¹Ÿå¯ä»¥æ˜¯ FactoryBean åˆ›å»ºçš„å¯¹è±¡</span></span><br><span class="line">        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œæ˜¯ä¼šè¿›å…¥ <code>getObjectForBeanInstance()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">getObjectForBeanInstance</span><span class="params">(</span></span><br><span class="line"><span class="params">    Object beanInstance, String name, String beanName, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">currentlyCreatedBean</span> <span class="operator">=</span> <span class="built_in">this</span>.currentlyCreatedBean.get();</span><br><span class="line">    <span class="keyword">if</span> (currentlyCreatedBean != <span class="literal">null</span>) &#123;</span><br><span class="line">        registerDependentBean(beanName, currentlyCreatedBean);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.getObjectForBeanInstance(beanInstance, name, beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åè°ƒç”¨çˆ¶ç±»çš„ <code>getObjectForBeanInstance()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">getObjectForBeanInstance</span><span class="params">(</span></span><br><span class="line"><span class="params">    Object beanInstance, String name, </span></span><br><span class="line"><span class="params">    String beanName, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t let calling code try to dereference the factory if the bean isn&#x27;t a factory.</span></span><br><span class="line">    <span class="comment">// å¦‚æœ bean ä¸æ˜¯å·¥å‚ï¼Œåˆ™ä¸è¦è®©è°ƒç”¨ä»£ç å°è¯•å–æ¶ˆå¼•ç”¨å·¥å‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœ name ä»¥ &amp; å¼€å¤´</span></span><br><span class="line">    <span class="keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (beanInstance <span class="keyword">instanceof</span> NullBean) &#123;</span><br><span class="line">            <span class="keyword">return</span> beanInstance;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanIsNotAFactoryException</span>(beanName, beanInstance.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mbd != <span class="literal">null</span>) &#123;</span><br><span class="line">            mbd.isFactoryBean = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœ name ä»¥ &amp; å¼€å¤´ï¼Œç›´æ¥è¿”å› FactoryBean å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span></span><br><span class="line">    <span class="comment">// If it&#x27;s a FactoryBean, we use it to create a bean instance, unless the</span></span><br><span class="line">    <span class="comment">// caller actually wants a reference to the factory.</span></span><br><span class="line">    <span class="comment">// ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº† Bean å®ä¾‹ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæ™®é€šçš„ Bean æˆ– FactoryBean</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ FactoryBeanï¼Œå°±ç”¨å®ƒåˆ›å»ºä¸€ä¸ª Bean å®ä¾‹ï¼Œé™¤éè°ƒç”¨è€…å®é™…æƒ³è¦çš„æ˜¯å·¥å‚çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean&lt;?&gt; factoryBean)) &#123;</span><br><span class="line">        <span class="comment">// è·å–åˆ°çš„ Bean å®ä¾‹ä¸æ˜¯ FactoryBean ç±»å‹ï¼Œname ä¹Ÿä¸ä»¥ &amp; å¼€å¤´</span></span><br><span class="line">        <span class="comment">// è¯æ˜æ˜¯æ™®é€š Beanï¼Œé‚£ä¹ˆè¿”å›å³å¯</span></span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mbd != <span class="literal">null</span>) &#123;</span><br><span class="line">        mbd.isFactoryBean = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä»ç¼“å­˜ä¸­è·å– Bean</span></span><br><span class="line">        object = getCachedObjectForFactoryBean(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Return bean instance from factory.</span></span><br><span class="line">        <span class="comment">// ä» factory ä¸­è¿”å› bean å®ä¾‹</span></span><br><span class="line">        <span class="comment">// Caches object obtained from FactoryBean if it is a singleton.</span></span><br><span class="line">        <span class="comment">// å¦‚æœ FactoryBean æ˜¯å•ä¾‹ï¼Œåˆ™ç¼“å­˜ä» FactoryBean è·å–çš„å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (mbd == <span class="literal">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">synthetic</span> <span class="operator">=</span> (mbd != <span class="literal">null</span> &amp;&amp; mbd.isSynthetic());</span><br><span class="line">        <span class="comment">// ä» FactoryBean ä¸­è·å– Bean</span></span><br><span class="line">        object = getObjectFromFactoryBean(factoryBean, beanName, !synthetic);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åè°ƒç”¨ <code>getObjectFromFactoryBean()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, </span></span><br><span class="line"><span class="params">                                          String beanName, <span class="type">boolean</span> shouldPostProcess)</span> &#123;</span><br><span class="line">    <span class="comment">// FactoryBean è¿”å›çš„ Bean æ˜¯å•ä¾‹çš„ï¼ŒbeanName åœ¨ singletonObjects ä¸­å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</span><br><span class="line">        <span class="comment">// é”ä½ singletonObjects</span></span><br><span class="line">        <span class="keyword">synchronized</span> (getSingletonMutex()) &#123;</span><br><span class="line">            <span class="comment">// ä»ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> <span class="built_in">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è·å–ä¸åˆ°ï¼Œç›´æ¥é€šè¿‡ factory çš„ getObject() æ–¹æ³•è·å–å¯¹è±¡</span></span><br><span class="line">                object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">                <span class="comment">// Only post-process and store if not put there already during getObject() call above</span></span><br><span class="line">                <span class="comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span></span><br><span class="line">                <span class="comment">// å¦‚æœåœ¨ä¸Šé¢çš„ getObject() è°ƒç”¨æœŸé—´è¿˜æ²¡æœ‰æ”¾åœ¨é‚£é‡Œï¼Œåˆ™åªè¿›è¡ŒåæœŸå¤„ç†å’Œå­˜å‚¨</span></span><br><span class="line">                <span class="comment">// ï¼ˆä¾‹å¦‚ï¼Œå› ä¸ºè‡ªå®šä¹‰getBeanè°ƒç”¨è§¦å‘äº†å¾ªç¯å¼•ç”¨å¤„ç†ï¼‰</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">alreadyThere</span> <span class="operator">=</span> <span class="built_in">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (alreadyThere != <span class="literal">null</span>) &#123;</span><br><span class="line">                    object = alreadyThere;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// BeanDefinition ä¸æ˜¯åˆæˆçš„ï¼Œå°±è¦è¿›è¡Œåç½®å¤„ç†</span></span><br><span class="line">                    <span class="keyword">if</span> (shouldPostProcess) &#123;</span><br><span class="line">                        <span class="comment">// è·å–çš„å•ä¾‹æ˜¯å¦æ­£åœ¨åˆ›å»º</span></span><br><span class="line">                        <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                            <span class="comment">// Temporarily return non-post-processed object, not storing it yet..</span></span><br><span class="line">                            <span class="comment">// æš‚æ—¶è¿”å›æœªç»åå¤„ç†çš„å¯¹è±¡ï¼Œæš‚ä¸å­˜å‚¨</span></span><br><span class="line">                            <span class="keyword">return</span> object;</span><br><span class="line">                        &#125;</span><br><span class="line">                        beforeSingletonCreation(beanName);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// åç½®å¤„ç† Bean</span></span><br><span class="line">                            <span class="comment">// è°ƒç”¨ BeanPostProcessor çš„ postProcessAfterInitialization()</span></span><br><span class="line">                            object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(beanName,</span><br><span class="line">                                                            <span class="string">&quot;Post-processing of FactoryBean&#x27;s singleton object failed&quot;</span>, ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">finally</span> &#123;</span><br><span class="line">                            afterSingletonCreation(beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// ç»™å®šçš„ beanName åœ¨ singletonObjects ä¸­å­˜åœ¨</span></span><br><span class="line">                    <span class="keyword">if</span> (containsSingleton(beanName)) &#123;</span><br><span class="line">                        <span class="comment">// æ›´æ–° factoryBeanObjectCacheï¼Œä¸‹æ¬¡å°±ä¸ç”¨å†æ¬¡è·å–ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿</span></span><br><span class="line">                        <span class="comment">// è¿™æ ·çš„è¯èƒ½å¤Ÿä¿è¯å§‹ç»ˆè·å–åˆ°çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">                        <span class="built_in">this</span>.factoryBeanObjectCache.put(beanName, object);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸æ˜¯å•ä¾‹ï¼Œæˆ–è€… beanName åœ¨ singletonObjects ä¸­ä¸å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å†æ¬¡è°ƒç”¨ FactoryBean çš„ getObject() è·å– Bean</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">        <span class="keyword">if</span> (shouldPostProcess) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åŒæ ·è¿›è¡Œåç½®å¤„ç†</span></span><br><span class="line">                object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(beanName, <span class="string">&quot;Post-processing of FactoryBean&#x27;s object failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¦‚æ‹¬ä¸€ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæ˜¯å•ä¾‹çš„ï¼Œå…ˆå°è¯•ä» <code>factoryBeanObjectCache</code> ä¸­è·å–ï¼Œä¿è¯æ¯æ¬¡è·å–åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼›å¦‚æœåœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>getObject()</code> æ–¹æ³•æ‹¿åˆ° Beanï¼Œå¹¶è¿›è¡Œåç½®å¤„ç†ï¼Œæœ€åå­˜å‚¨åˆ° <code>factoryBeanObjectCache</code> ä¸­ï¼›</li>
<li>å¦‚æœä¸æ˜¯å•ä¾‹ã€æˆ–è€…åœ¨ <code>beanName</code> åœ¨ <code>singletonObjects</code> ä¸­ä¸å­˜åœ¨ï¼Œæ¯æ¬¡è°ƒç”¨ <code>getObject()</code> æ–¹æ³•æ‹¿åˆ°æ–°çš„ Beanï¼ŒåŒæ ·è¿›è¡Œåç½®å¤„ç†ã€‚</li>
</ul>
<h1 id="13-å¯é”€æ¯-Bean"><a class="header-anchor" href="#13-å¯é”€æ¯-Bean"></a>13. å¯é”€æ¯ Bean</h1>
<h2 id="13-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#13-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>13.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>å¯é”€æ¯ Beanï¼Œå³ï¼š<code>DisposableBean</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DisposableBean</span> &#123;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥å£å†…éƒ¨åªæœ‰ä¸€ä¸ªæ— å‚æ— è¿”å›å€¼çš„ <code>destroy()</code> æ–¹æ³•ï¼Œä¸º Spring Bean æä¾›äº†ä¸€ç§é‡Šæ”¾èµ„æºçš„æ–¹å¼ï¼Œèƒ½å¤Ÿåœ¨ Spring å®¹å™¨å…³é—­ï¼Œé”€æ¯æ‰€æœ‰ Bean æ—¶å›è°ƒã€‚</p>
<p><code>DisposableBean</code> æ¥å£ä¸ <code>InitializingBean</code> æ¥å£æœ‰äº›ç±»ä¼¼ï¼Œä½†è§¦å‘æ—¶æœºä¸åŒã€‚</p>
<h2 id="13-2-ä½¿ç”¨æ–¹å¼"><a class="header-anchor" href="#13-2-ä½¿ç”¨æ–¹å¼"></a>13.2 ä½¿ç”¨æ–¹å¼</h2>
<p>å®ç° <code>DisposableBean</code> æ¥å£å¹¶é‡å†™ <code>destroy()</code> æ–¹æ³•ï¼Œå°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼Œè¿˜æä¾› <code>ApplicationRunner</code> çš„å®ç°ç±»ï¼Œä½œä¸ºå¯¹æ¯”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;1. [%s]: æ‰§è¡Œäº† ApplicationRunner æ–¹æ³•\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A13DisposableBean</span> <span class="keyword">implements</span> <span class="title class_">DisposableBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;4. [%s]: æ‰§è¡Œäº† destroy æ–¹æ³•\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;3. [%s]: æ‰§è¡Œäº† @preDestroy æ–¹æ³•\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;5. [%s]: æ‰§è¡Œäº† destroy-method\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(destroyMethod = &quot;destroyMethod&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> A13DisposableBean <span class="title function_">a13DisposableBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">A13DisposableBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A13ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(A13ExtensionPoint.class);</span><br><span class="line">        System.out.printf(<span class="string">&quot;2. [%s]: main æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå‡†å¤‡å…³é—­å®¹å™¨\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        context.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å¯ä»¥ä¸ç›´æ¥å…³é—­å®¹å™¨ï¼Œè€Œæ˜¯é€šè¿‡ `System.exit(0)` å…³é—­ï¼Œæ­¤æ—¶ä¼šè§¦å‘ shutdown hooksï¼›</span></span><br><span class="line"><span class="comment">         * æˆ–è€…æ˜¯åœ¨ IDEA ä¸­ï¼Œæ‰‹åŠ¨åœæ­¢ç¨‹åºï¼Œä¹Ÿä¼šè§¦å‘ shutdown hooks</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentThreadName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. [main]: æ‰§è¡Œäº† ApplicationRunner æ–¹æ³•
2. [main]: main æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå‡†å¤‡å…³é—­å®¹å™¨
3. [main]: æ‰§è¡Œäº† @preDestroy æ–¹æ³•
4. [main]: æ‰§è¡Œäº† destroy æ–¹æ³•
5. [main]: æ‰§è¡Œäº† destroy-method
</pre>
<p>å¯¹äº Bean çš„åˆå§‹åŒ–æ¥è¯´ï¼Œæœ‰ä¸‰ä¸ªç±»ä¼¼çš„æ‹“å±•ç‚¹ï¼Œå¹¶ <strong>æŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œï¼š</strong></p>
<ul>
<li><code>@PostConstruct</code></li>
<li><code>InitializingBean#afterPropertiesSet()</code></li>
<li><code>@Bean</code> æ³¨è§£çš„ <code>initMethod</code> å±æ€§</li>
</ul>
<p>è€Œå¯¹äº Bean çš„é”€æ¯æ¥è¯´ï¼Œä¹Ÿæœ‰ä¸‰ä¸ªç±»ä¼¼çš„æ‹“å±•ç‚¹ï¼Œä¹Ÿ <strong>æŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œï¼š</strong></p>
<ul>
<li><code>@PreDestroy</code></li>
<li><code>DisposableBean#destroy()</code></li>
<li><code>@Bean</code> æ³¨è§£çš„ <code>destroyMethod</code> å±æ€§</li>
</ul>
<blockquote>
<p>è°ƒç”¨çš„çº¿ç¨‹</p>
</blockquote>
<p><code>destroy()</code> æ–¹æ³•ä¼šåœ¨ <code>main</code> çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚</p>
<p>å¦‚æœå»æ‰ <code>context.close()</code> æ–¹æ³•ï¼Œè€Œæ˜¯æ‰‹åŠ¨æˆ–è€…é€šè¿‡ <code>System.exit(0);</code> å…³é—­ç¨‹åºï¼Œ<strong>é”€æ¯æ–¹æ³•ä»¬</strong> åˆ™ä¼šåœ¨ <code>SpringApplicationShutdownHook</code> çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿ç”¨äº†å¤šçº¿ç¨‹æŠ€æœ¯ï¼Œå¼‚æ­¥æ‰§è¡Œé”€æ¯æ–¹æ³•ï¼Œè¿™æ¶‰åŠåˆ° <a href="../SpringBoot-Shutdown-Hook/">SpringBoot Shutdown Hook</a>ï¼Œ æœ¬èŠ‚ä¾æ—§ä»¥ <code>context.close()</code> æ–¹æ³•ä¸ºå…¥å£è¿›è¡Œæ¢ç´¢ã€‚</p>
<h2 id="13-3-æ‰§è¡Œ"><a class="header-anchor" href="#13-3-æ‰§è¡Œ"></a>13.3 æ‰§è¡Œ</h2>
<p>ä»¥ <code>context.close()</code> æ–¹æ³•ä¸ºå…¥å£ï¼Œæ¥åˆ° <code>AbstractApplicationContext#close()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      doClose();</span><br><span class="line">      <span class="comment">// If we registered a JVM shutdown hook, we don&#x27;t need it anymore now:</span></span><br><span class="line">      <span class="comment">// We&#x27;ve already explicitly closed the context.</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.shutdownHook != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().removeShutdownHook(<span class="built_in">this</span>.shutdownHook);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">            <span class="comment">// ignore - VM is already shutting down</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹åœ¨ <code>doClose()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Check whether an actual close attempt is necessary...</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦è¿›è¡Œå®é™…çš„å…³é—­å°è¯•</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.active.get() &amp;&amp; <span class="built_in">this</span>.closed.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Closing &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Publish shutdown event.</span></span><br><span class="line">            <span class="comment">// å‘å¸ƒ shutdown äº‹ä»¶</span></span><br><span class="line">            publishEvent(<span class="keyword">new</span> <span class="title class_">ContextClosedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span></span><br><span class="line">        <span class="comment">// åœæ­¢æ‰€æœ‰ Lifecycle Beanï¼Œä»¥é¿å…åœ¨å•ä¸ªé”€æ¯è¿‡ç¨‹ä¸­å‡ºç°å»¶è¿Ÿã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.lifecycleProcessor != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception thrown from LifecycleProcessor on context close&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Destroy all cached singletons in the context&#x27;s BeanFactory.</span></span><br><span class="line">        <span class="comment">// é”€æ¯æ‰€æœ‰åœ¨ä¸Šä¸‹æ–‡çš„ BeanFactory ç¼“å­˜çš„å•ä¾‹</span></span><br><span class="line">        destroyBeans();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Close the state of this context itself.</span></span><br><span class="line">        <span class="comment">// å…³é—­ä¸Šä¸‹æ–‡æœ¬èº«çš„çŠ¶æ€</span></span><br><span class="line">        closeBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Let subclasses do some final clean-up if they wish...</span></span><br><span class="line">        <span class="comment">// å¦‚æœå¯ä»¥ï¼Œè®©å­ç±»åšä¸€äº›æœ€åçš„æ¸…ç†</span></span><br><span class="line">        <span class="comment">// æ¯”å¦‚ ServletWebServerApplicationContext ä¼šå®ç°è¯¥å‹¾å­å‡½æ•°å…³é—­å†…åµŒçš„ WebServer(Tomcat)</span></span><br><span class="line">        onClose();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset common introspection caches to avoid class reference leaks.</span></span><br><span class="line">        <span class="comment">// é‡ç½®å¸¸ç”¨è‡ªçœç¼“å­˜ï¼Œé¿å…ç±»å¼•ç”¨æ³„æ¼</span></span><br><span class="line">        resetCommonCaches();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">        <span class="comment">// å°†æœ¬åœ°åº”ç”¨ç¨‹åºç›‘å¬å™¨é‡ç½®ä¸ºåˆ·æ–°å‰çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.earlyApplicationListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.applicationListeners.clear();</span><br><span class="line">            <span class="built_in">this</span>.applicationListeners.addAll(<span class="built_in">this</span>.earlyApplicationListeners);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Switch to inactive.</span></span><br><span class="line">        <span class="comment">// åˆ‡æ¢åˆ° inactive</span></span><br><span class="line">        <span class="built_in">this</span>.active.set(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„ <code>destroyBeans()</code> æ–¹æ³•ç”¨äºé”€æ¯ Spring å®¹å™¨ä¸­ç¼“å­˜çš„å•ä¾‹ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•å‰ä¼šæ‰§è¡Œä¸¤ä»¶åº”ç”¨å…³é—­å‰çš„æ“ä½œï¼Œå®ƒä»¬éƒ½ç±»ä¼¼ä¸€ç§é€šçŸ¥æœºåˆ¶ï¼Œä½†åœ¨ä½¿ç”¨åœºæ™¯ä¸Šä¹Ÿæœ‰åŒºåˆ«ï¼š</p>
<ul>
<li><code>ContextClosedEvent</code> æ˜¯åº”ç”¨çº§åˆ«çš„äº‹ä»¶ï¼Œç›‘å¬è¯¥äº‹ä»¶å¯ä»¥åšä¸€äº›å…¨å±€æ€§çš„è¡Œä¸ºï¼›</li>
<li><code>Lifecycle</code> æ˜¯ Bean çº§åˆ«çš„é€šçŸ¥ï¼Œæ›´é€‚ç”¨äºç‰¹å®š Bean çš„è¡Œä¸ºã€‚</li>
</ul>
<p>å›åˆ° <code>destroyBeans()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">destroyBeans</span><span class="params">()</span> &#123;</span><br><span class="line">   getBeanFactory().destroySingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¥åˆ° <code>destroySingletons()</code>ï¼Œæ–¹æ³•æœ‰ä¸¤ä¸ªå®ç°ï¼Œä¸»è¦çš„å®ç°æ˜¯ <code>DefaultSingletonBeanRegistry#destroySingletons()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroySingletons</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(<span class="string">&quot;Destroying singletons in &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="built_in">this</span>.singletonsCurrentlyInDestruction = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] disposableBeanNames;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.disposableBeans) &#123;</span><br><span class="line">        <span class="comment">// è·å–å·²ç»ç¼“å­˜çš„éœ€è¦è¢«é”€æ¯çš„ Bean çš„ name</span></span><br><span class="line">        disposableBeanNames = StringUtils.toStringArray(<span class="built_in">this</span>.disposableBeans.keySet());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> disposableBeanNames.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">// é€†åºéå†ï¼Œä¸€ä¸€é”€æ¯</span></span><br><span class="line">        destroySingleton(disposableBeanNames[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤å½“å‰ç±»ç”¨åˆ°çš„ä¸€äº›ç¼“å­˜</span></span><br><span class="line">    <span class="built_in">this</span>.containedBeanMap.clear();</span><br><span class="line">    <span class="built_in">this</span>.dependentBeanMap.clear();</span><br><span class="line">    <span class="built_in">this</span>.dependenciesForBeanMap.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤å•ä¾‹ç¼“å­˜</span></span><br><span class="line">    clearSingletonCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå‡ æ­¥æ¸…é™¤äº†å½“å‰ç±»ä¸­ç”¨åˆ°çš„ä¸€äº›ç¼“å­˜åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>containedBeanMap</code></li>
<li><code>dependentBeanMap</code></li>
<li><code>dependenciesForBeanMap</code></li>
</ul>
<blockquote>
<p>æ’æ’­ä¸€ä¸‹ï¼šå‡ ä¸ª <code>Map</code> çš„å«ä¹‰</p>
</blockquote>
<p>å¯¹äº <code>dependentBeanMap</code> ä¸ <code>dependenciesForBeanMap</code> æ¥è¯´ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Map between dependent bean names: bean name to Set of dependent bean names. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; dependentBeanMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Map between depending bean names: bean name to Set of bean names for the bean&#x27;s dependencies. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; dependenciesForBeanMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">64</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dependentBeanMap</code>ï¼šBean åç§°å’Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„ Bean çš„åç§°çš„æ˜ å°„å…³ç³»</li>
<li><code>dependenciesForBeanMap</code>ï¼šBean åç§°å’Œå®ƒä¾èµ–çš„ Bean çš„åç§°çš„æ˜ å°„å…³ç³»</li>
</ul>
<pre><code class="highlight mermaid">flowchart TD
1(&quot;A&quot;)
2(&quot;B&quot;)
3(&quot;C&quot;)
1 --&gt; 2
1 --&gt; 3</code></pre>
<p>åœ¨ä¸Šå›¾ä¸­ï¼ŒA ä¾èµ–äº† Bï¼ˆ<code>A --&gt; B</code>ï¼‰ï¼ŒA ä¾èµ–äº† Cï¼ˆ<code>A --&gt; C</code>ï¼‰ï¼Œåˆ™ï¼š</p>
<ul>
<li><code>dependentBeanMap</code>ï¼š<code>&lt;B, [A]&gt;</code> å’Œ <code>&lt;C, [A]&gt;</code></li>
<li><code>dependenciesForBeanMap</code>ï¼š<code>&lt;A, [B, C]&gt;</code></li>
</ul>
<p>è‡³äº <code>containedBeanMap</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Map between containing bean names: bean name to Set of bean names that the bean contains. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; containedBeanMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br></pre></td></tr></table></figure>
<p>å®ƒè¡¨ç¤º Bean åç§°ä¸å®ƒåŒ…å«çš„ Bean çš„åç§°çš„æ˜ å°„å…³ç³»ã€‚è¿™ä¼¼ä¹ä¸ <code>dependenciesForBeanMap</code> å¾ˆç±»ä¼¼ï¼Œä¹Ÿç¡®å®å¾ˆç±»ä¼¼ï¼Œä½†å®ƒæ˜¯åœ¨ XML é…ç½®ä¸­ä½¿ç”¨çš„ï¼Œåœ¨å½“å‰æµè¡ŒåŸºäºæ³¨è§£çš„ Spring é…ç½®çš„ç¯å¢ƒä¸‹ï¼Œå®ƒçš„ä½¿ç”¨åœºæ™¯è¶Šæ¥è¶Šå°ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Bar bar;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Foo</span><span class="params">(Bar bar)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bar = bar;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Foo</code> ç±»ä¸­ä¾èµ–äº† <code>Bar</code>ï¼Œé‚£ä¹ˆåŸºäº XML çš„é…ç½®æœ‰ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.demo.Foo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.example.demo.Bar&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸æ˜¯å°±ç›¸å½“äº <code>Foo</code> åŒ…å«äº† <code>Bar</code>ï¼Ÿè¿™ä»…ä¾›äº†è§£ï¼Œç°åœ¨å‡ ä¹æ²¡æœ‰ä½¿ç”¨åœºæ™¯ã€‚</p>
<blockquote>
<p>å†æ’æ’­ä¸‹ï¼š<code>disposableBeans</code> çš„åˆå§‹åŒ–</p>
</blockquote>
<p><code>disposableBeans</code> çš„åˆå§‹åŒ–æ˜¯åœ¨ç†Ÿæ‚‰çš„ <code>doCreateBean()</code> æ–¹æ³•ä¸­æœ€åå®Œæˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, </span></span><br><span class="line"><span class="params">                              RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the bean.</span></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the bean instance.</span></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register bean as disposable.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åœ¨è¿™è¿›è¡Œæ³¨å†Œï¼Œä¸å†æ·±å…¥åˆ†æ</span></span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å›åˆ°ä¸»çº¿</p>
</blockquote>
<p>æŸ¥çœ‹ <code>destroySingleton()</code> æ–¹æ³•ï¼Œå¦‚ä½•æ ¹æ® Bean çš„ name æ¥è¿›è¡Œé”€æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroySingleton</span><span class="params">(String beanName)</span> &#123;</span><br><span class="line">    <span class="comment">// Remove a registered singleton of the given name, if any.</span></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰ï¼Œåˆ é™¤å·²æ³¨å†Œçš„ç»™å®šåç§°çš„å•ä¾‹ Bean</span></span><br><span class="line">    removeSingleton(beanName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Destroy the corresponding DisposableBean instance.</span></span><br><span class="line">    <span class="comment">// é”€æ¯ç›¸åº”çš„ DisposableBean å®ä¾‹</span></span><br><span class="line">    DisposableBean disposableBean;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.disposableBeans) &#123;</span><br><span class="line">        disposableBean = <span class="built_in">this</span>.disposableBeans.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    destroyBean(beanName, disposableBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>removeSingleton()</code> æ–¹æ³•ä»å¤šä¸ª <code>Map</code> ä¸­ç§»é™¤å³å¯ï¼Œ<code>DisposableBean</code> å·²ç»è¢«ç¼“å­˜äº†ä¸€ä»½ï¼Œå…ˆåˆ é™¤å†é”€æ¯ä¹Ÿæ²¡å•¥é—®é¢˜ã€‚</p>
<p>é”€æ¯çš„ä¸»è¦é€»è¾‘åœ¨ <code>destroyBean()</code> ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">(String beanName, <span class="meta">@Nullable</span> DisposableBean bean)</span> &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆè§¦å‘ä¾èµ–äº†å½“å‰ Bean çš„ Bean çš„é”€æ¯ï¼ˆdependentBeanMapï¼‰</span></span><br><span class="line">    Set&lt;String&gt; dependencies;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.dependentBeanMap) &#123;</span><br><span class="line">        <span class="comment">// Within full synchronization in order to guarantee a disconnected Set</span></span><br><span class="line">        dependencies = <span class="built_in">this</span>.dependentBeanMap.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dependencies != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">        <span class="keyword">for</span> (String dependentBeanName : dependencies) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’é”€æ¯</span></span><br><span class="line">            destroySingleton(dependentBeanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç°åœ¨é”€æ¯è‡ªå·±</span></span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bean.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§¦å‘å½“å‰ Bean åŒ…å«çš„ Bean çš„é”€æ¯ï¼ˆcontainedBeanMapï¼‰</span></span><br><span class="line">    Set&lt;String&gt; containedBeans;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.containedBeanMap) &#123;</span><br><span class="line">        <span class="comment">// Within full synchronization in order to guarantee a disconnected Set</span></span><br><span class="line">        containedBeans = <span class="built_in">this</span>.containedBeanMap.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (containedBeans != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String containedBeanName : containedBeans) &#123;</span><br><span class="line">            <span class="comment">// åŒæ ·é€’å½’é”€æ¯</span></span><br><span class="line">            destroySingleton(containedBeanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove destroyed bean from other beans&#x27; dependencies.</span></span><br><span class="line">    <span class="comment">// å°†å·²é”€æ¯çš„ Bean ä»å…¶ä»– Bean çš„ä¾èµ–å…³ç³»ä¸­ç§»é™¤</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå°±æ˜¯ç§»é™¤å…¶ä»– Bean å¯¹å·²é”€æ¯ Bean çš„ä¾èµ–ï¼ˆdependentBeanMapï¼‰ </span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.dependentBeanMap) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String, Set&lt;String&gt;&gt;&gt; it = <span class="built_in">this</span>.dependentBeanMap.entrySet().iterator(); it.hasNext();) &#123;</span><br><span class="line">            Map.Entry&lt;String, Set&lt;String&gt;&gt; entry = it.next();</span><br><span class="line">            Set&lt;String&gt; dependenciesToClean = entry.getValue();</span><br><span class="line">            dependenciesToClean.remove(beanName);</span><br><span class="line">            <span class="keyword">if</span> (dependenciesToClean.isEmpty()) &#123;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove destroyed bean&#x27;s prepared dependency information.</span></span><br><span class="line">    <span class="comment">// åˆ é™¤å·²é”€æ¯ Bean çš„å‡†å¤‡å¥½çš„ä¾èµ–å…³ç³»ä¿¡æ¯ï¼ˆdependenciesForBeanMapï¼‰</span></span><br><span class="line">    <span class="built_in">this</span>.dependenciesForBeanMap.remove(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘åˆ†ä¸ºå‡ æ­¥ï¼š</p>
<ol>
<li>é¦–å…ˆåœ¨ <code>dependentBeanMap</code> ä¸­ç§»é™¤ <strong>ï¼ˆä¸€ä¸ªé€’å½’æ“ä½œï¼‰</strong> å…¶ä»– Bean å¯¹ç›®æ ‡ Bean çš„ä¾èµ–ï¼Œä¾èµ–çš„éƒ½æ²¡äº†ï¼Œé‚£å®ƒè‡ªå·±ä¹Ÿè¯¥è¢«é”€æ¯ï¼›</li>
<li><strong>æ‰§è¡Œç›®æ ‡ Bean çš„é”€æ¯ï¼ˆ<code>DisposableBean</code> çš„æ‰§è¡Œæ—¶æœºï¼‰ï¼›</strong></li>
<li>åœ¨ <code>containedBeanMap</code> ä¸­ç§»é™¤å½“å‰ Bean åŒ…å«çš„ Beanï¼›</li>
<li>ä»å…¶ä»– Bean çš„ä¾èµ–é¡¹ä¸­åˆ é™¤é”€æ¯çš„ç›®æ ‡ Beanï¼›</li>
<li>æœ€ç»ˆåˆ é™¤ç›®æ ‡ Bean å¯¹å…¶ä»– Bean çš„ä¾èµ–å…³ç³»ä¿¡æ¯ã€‚</li>
</ol>
<h1 id="14-æ™ºèƒ½ç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#14-æ™ºèƒ½ç”Ÿå‘½å‘¨æœŸ"></a>14. æ™ºèƒ½ç”Ÿå‘½å‘¨æœŸ</h1>
<h2 id="14-1-æ‹“å±•ç‚¹çš„ä½œç”¨"><a class="header-anchor" href="#14-1-æ‹“å±•ç‚¹çš„ä½œç”¨"></a>14.1 æ‹“å±•ç‚¹çš„ä½œç”¨</h2>
<p>æ™ºèƒ½ç”Ÿå‘½å‘¨æœŸï¼Œå³ï¼š<code>SmartLifecycle</code>ï¼Œå®ƒå¹¶é SpringBoot æä¾›ï¼Œæ˜¯åœ¨ Spring ä¸­å°±å­˜åœ¨çš„ï¼š</p>
<pre><code class="highlight mermaid">classDiagram
direction BT
class Lifecycle &#123;
&lt;&lt;Interface&gt;&gt;
  + stop() void
  + isRunning() boolean
  + start() void
&#125;
class Phased &#123;
&lt;&lt;Interface&gt;&gt;
  + getPhase() int
&#125;
class SmartLifecycle &#123;
&lt;&lt;Interface&gt;&gt;
  + getPhase() int
  + stop(Runnable) void
  + isAutoStartup() boolean
&#125;

SmartLifecycle  --&gt;  Lifecycle 
SmartLifecycle  --&gt;  Phased 
</code></pre>
<p>å®ƒç»§æ‰¿äº† <code>Lifecycle</code> æ¥å£å’Œ <code>Phased</code> æ¥å£ï¼Œä¸€å…±å®šä¹‰äº†å…­ä¸ªæ–¹æ³•ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ–¹æ³•</th>
<th style="text-align:center">ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>start()</code></td>
<td style="text-align:center">Spring åˆ·æ–°ä¸Šä¸‹æ–‡çš„æœ€åä¸€æ­¥ï¼ŒBean åˆå§‹åŒ–å®Œæˆåï¼Œæ‰§è¡Œè¯¥æ–¹æ³•</td>
</tr>
<tr>
<td style="text-align:center"><code>stop()</code></td>
<td style="text-align:center">Spring å®¹å™¨å…³é—­æ—¶ï¼Œæ‰§è¡Œ <code>Lifecycle</code> çš„ <code>stop()</code> æ–¹æ³•</td>
</tr>
<tr>
<td style="text-align:center"><code>isRunning()</code></td>
<td style="text-align:center">åˆ¤æ–­å½“å‰ç»„ä»¶æ˜¯å¦åœ¨è¿è¡Œ</td>
</tr>
<tr>
<td style="text-align:center"><code>getPhase()</code></td>
<td style="text-align:center">å­˜åœ¨å¤šä¸ªç»„ä»¶æ—¶çš„å›è°ƒé¡ºåºã€‚å€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ <code>start()</code> æ–¹æ³•ï¼Œè¶Šæ™šæ‰§è¡Œ <code>stop()</code> æ–¹æ³•</td>
</tr>
<tr>
<td style="text-align:center"><code>isAutoStartup()</code></td>
<td style="text-align:center">åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œ <code>start()</code> æ–¹æ³•ï¼Œè¿”å› <code>true</code> æ‰æ‰§è¡Œ</td>
</tr>
<tr>
<td style="text-align:center"><code>stop(Runnable callback)</code></td>
<td style="text-align:center">Spring å®¹å™¨å…³é—­æ—¶ï¼Œæ‰§è¡Œ <code>SmartLifecycle</code> çš„ <code>stop(Runnable callback)</code> æ–¹æ³•</td>
</tr>
</tbody>
</table>
<p>å¯¹äº <code>SmartLifecycle</code> æ¥è¯´ï¼Œåœ¨å®¹å™¨å…³é—­æ—¶ï¼Œ<strong>åªä¼š</strong> æ‰§è¡Œå®ƒçš„ <code>stop(Runnable callback)</code> æ–¹æ³•ï¼Œ<strong>ä¸ä¼š</strong> æ‰§è¡Œ <code>stop()</code> æ–¹æ³•ã€‚</p>
<p>å’Œ <code>DisposableBean</code> çš„ <code>destroy()</code> æ–¹æ³•ç±»ä¼¼ï¼Œä¸¤ä¸ª <code>stop()</code> æ–¹æ³•ä¹Ÿä¸ SpringBoot Shutdown Hook æœ‰å…³ã€‚</p>
<h2 id="14-2-Lifecycle"><a class="header-anchor" href="#14-2-Lifecycle"></a>14.2 Lifecycle</h2>
<p>å…ˆä» <code>Lifecycle</code> å…¥æ‰‹ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‡å†™å®ƒä»¬å¹¶å°†å®ç°ç±»äº¤ç”± Spring ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyLifecycle</span> <span class="keyword">implements</span> <span class="title class_">Lifecycle</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: lifecycle start\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: lifecycle stop\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.running;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentThreadName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥ä½¿ç”¨ <code>close()</code> æ–¹æ³•å…³é—­ Spring å®¹å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A15ExtensionPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">            SpringApplication.run(A15ExtensionPoint.class);</span><br><span class="line">        <span class="comment">// System.exit(0);</span></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[main]: lifecycle stop
</pre>
<p>åœ¨å®¹å™¨å¯åŠ¨æ—¶å¹¶æ²¡æœ‰æ‰§è¡Œ <code>start()</code> æ–¹æ³•ï¼Œä½†åœ¨å®¹å™¨å…³é—­æ—¶æ‰§è¡Œäº† <code>close()</code> æ–¹æ³•ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºåœ¨ SpringBoot åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰ <strong>æ˜¾å¼</strong> è°ƒç”¨ <code>AbstractApplicationContext#start()</code>ï¼Œè€Œæ˜¯è°ƒç”¨ <code>AbstractApplicationContext#finishRefresh()</code>ï¼Œä½†åœ¨åº”ç”¨é€€å‡ºï¼ˆSpring å®¹å™¨å…³é—­ï¼‰æ—¶ä¼šæ‰§è¡Œ <code>Lifecycle#isRunning()</code> æ–¹æ³•åˆ¤æ–­ç»„ä»¶æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¦‚æœè¿”å› <code>true</code> åˆ™ä¼šè°ƒç”¨ <code>Lifecycle#stop()</code> æ–¹æ³•ï¼Œè¿™äº›åœ¨åç»­æºç åˆ†æä¸­ä»‹ç»ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¦æ˜¾å¼è°ƒç”¨ <code>AbstractApplicationContext#start()</code> æ‰ä¼šæ‰§è¡Œ <code>Lifecycle</code> çš„ <code>start()</code> æ–¹æ³•ï¼Œä½† SpringBoot åœ¨å®¹å™¨å¯åŠ¨æ—¶å¹¶ä¸ä¼šæ˜¾å¼è°ƒç”¨ï¼Œé‚£ <code>start()</code> æ–¹æ³•å²‚ä¸æ˜¯å¾ˆå°´å°¬ï¼Ÿ</p>
<p>æ­¤æ—¶éœ€è¦ä¸€ä¸ªæ›´ã€Œæ™ºèƒ½ã€çš„ç±»ï¼Œä¹Ÿå°±æ˜¯ <code>SmartLifecycle</code>ã€‚</p>
<h2 id="14-3-SmartLifecycle"><a class="header-anchor" href="#14-3-SmartLifecycle"></a>14.3 SmartLifecycle</h2>
<p>å®ƒç»§æ‰¿äº† <code>Lifecycle</code> å’Œ <code>Phased</code>ï¼Œç›¸æ¯”äº <code>Lifecycle</code>ï¼Œ<code>SmartLifecycle</code> æä¾›äº†è‡ªåŠ¨æ‰§è¡Œ <code>start()</code> æ–¹æ³•çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å…·æœ‰æ‰§è¡Œç¼–æ’ï¼ˆå­˜åœ¨å¤šä¸ª <code>SmartLifecycle</code> æ—¶èƒ½å¤Ÿæ§åˆ¶å¯¹åº”æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼‰çš„èƒ½åŠ›ï¼š</p>
<ul>
<li>é‡å†™ <code>isAutoStartup()</code> æ–¹æ³•ï¼Œå¹¶è¿”å› <code>true</code>ï¼Œä½¿å¾—åœ¨å®¹å™¨åˆ·æ–°å®Œæˆå <strong>è‡ªåŠ¨</strong> æ‰§è¡Œ <code>start()</code> æ–¹æ³•ï¼›</li>
<li>é‡å†™ <code>getPhase()</code> æ–¹æ³•ï¼Œæ ¹æ®è¿”å›å€¼çš„å¤§å°ç¼–æ’å¤šä¸ª <code>SmartLifecycle</code> çš„æ‰§è¡Œé¡ºåºï¼Œå€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ <code>start()</code> æ–¹æ³•ï¼Œè¶Šé åæ‰§è¡Œ <code>stop()</code> æ–¹æ³•ï¼›</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FirstSmartLifecycle</span> <span class="keyword">implements</span> <span class="title class_">SmartLifecycle</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: first start\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é SmartLifecycle çš„å­ç±»æ‰æ‰§è¡Œ</span></span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: first stop\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.running;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">(Runnable callback)</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: first stop(Runnable)\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        <span class="comment">// æ˜¾å¼è°ƒç”¨ callback</span></span><br><span class="line">        callback.run();</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPhase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecondSmartLifecycle</span> <span class="keyword">implements</span> <span class="title class_">SmartLifecycle</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: second start\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: second stop\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.running;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">(Runnable callback)</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;[%s]: second stop(Runnable)\n&quot;</span>, getCurrentThreadName());</span><br><span class="line">        callback.run();</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPhase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[main]: first start
[main]: second start
[main]: second stop(Runnable)
[main]: first stop(Runnable)
</pre>
<p>å¯¹äº <code>SmartLifecycle</code> æ¥è¯´ï¼Œåœ¨å®¹å™¨å…³é—­æ—¶ä¸ä¼šæ‰§è¡Œçˆ¶ç±» <code>Lifecycle</code> çš„ <code>stop()</code> æ–¹æ³•ï¼Œè€Œæ˜¯æ‰§è¡Œè‡ªèº«æä¾›çš„ <code>stop(Runnable callback)</code> æ–¹æ³•ã€‚</p>
<h2 id="14-4-å®¹å™¨å¯åŠ¨æ—¶"><a class="header-anchor" href="#14-4-å®¹å™¨å¯åŠ¨æ—¶"></a>14.4 å®¹å™¨å¯åŠ¨æ—¶</h2>
<p>åœ¨ç†Ÿæ‚‰çš„ <code>AbstractApplicationContext#refresh()</code> æ–¹æ³•ä¸­ï¼Œæ‰€æœ‰å•ä¾‹ Bean éƒ½å®ä¾‹åŒ–å®Œæˆåï¼Œä¼šæ‰§è¡Œ <code>finishRefresh()</code> æ–¹æ³•ï¼Œæºç ä¸­çš„æ³¨é‡Šè¡¨æ˜è¿™æ˜¯ refresh çš„æœ€åä¸€æ­¥ï¼Œå‘å¸ƒç›¸å…³çš„äº‹ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">finishRefresh();</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥è¯¥æ–¹æ³•å†…éƒ¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span></span><br><span class="line">   clearResourceCaches();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Initialize lifecycle processor for this context.</span></span><br><span class="line">   initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Propagate refresh to lifecycle processor first.</span></span><br><span class="line">   getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Publish the final event.</span></span><br><span class="line">   publishEvent(<span class="keyword">new</span> <span class="title class_">ContextRefreshedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹æ”¾åœ¨ä¸­é—´çš„ä¸¤æ­¥ï¼Œå®ƒä»¬ä¸€ä¸ªç”¨äºåˆå§‹åŒ– <code>Lifecycle</code> å¤„ç†å™¨ï¼Œä¸€ä¸ªç”¨äºè°ƒç”¨ <code>Lifecycle</code> å¤„ç†å™¨çš„ <code>onRefresh()</code> æ–¹æ³•ã€‚</p>
<blockquote>
<p><code>initLifecycleProcessor()</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> LifecycleProcessor lifecycleProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LIFECYCLE_PROCESSOR_BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;lifecycleProcessor&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initLifecycleProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.lifecycleProcessor =</span><br><span class="line">            beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);</span><br><span class="line">        <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">DefaultLifecycleProcessor</span> <span class="variable">defaultProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultLifecycleProcessor</span>();</span><br><span class="line">        defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">        <span class="built_in">this</span>.lifecycleProcessor = defaultProcessor;</span><br><span class="line">        beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, <span class="built_in">this</span>.lifecycleProcessor);</span><br><span class="line">        <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•å†…éƒ¨é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆè·å– <code>BeanFactory</code>ï¼Œåˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨åä¸º <code>lifecycleProcessor</code> çš„ Beanï¼š</p>
<ul>
<li>å¦‚æœå­˜åœ¨ï¼Œå°±è·å–è¿™ä¸ª Beanï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™æˆå‘˜å˜é‡ <code>this.lifecycleProcessor</code>ï¼›</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œè‡ªè¡Œå®ä¾‹åŒ– <code>DefaultLifecycleProcessor</code>ï¼Œå°†å…¶èµ‹å€¼ç»™æˆå‘˜å˜é‡ <code>this.lifecycleProcessor</code>ï¼Œç„¶åå†æŠŠè¿™ä¸ªå¯¹è±¡æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚</li>
</ul>
<p>ç°åœ¨å·²ç»æ‹¿åˆ°äº† <code>LifecycleProcessor</code>ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨å®ƒçš„ <code>onRefresh()</code> æ–¹æ³•äº†ã€‚</p>
<blockquote>
<p><code>getLifecycleProcessor().onRefresh()</code></p>
</blockquote>
<p>æ¥åˆ° <code>DefaultLifecycleProcessor#onRefresh()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">   startBeans(<span class="literal">true</span>);</span><br><span class="line">   <span class="built_in">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†è¿›å…¥ <code>startBeans()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startBeans</span><span class="params">(<span class="type">boolean</span> autoStartupOnly)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ‰€æœ‰ Lifecycle ç±»å‹çš„ Beanï¼Œkey ä¸º Bean çš„ name</span></span><br><span class="line">    Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">    <span class="comment">// LifecycleGroup æ˜¯å¯¹ä¸€ç»„ Lifecycle çš„å°è£…ï¼Œå¯ä»¥çœ‹æˆæ˜¯ List&lt;Lifecycle&gt;</span></span><br><span class="line">    Map&lt;Integer, LifecycleGroup&gt; phases = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†è¿™äº› Bean</span></span><br><span class="line">    lifecycleBeans.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">        <span class="comment">// autoStartupOnly == true</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­ Bean æ˜¯å¦æ˜¯ SmartLifecycle ç±»å‹ï¼Œå¹¶ä¸”å…¶ isAutoStartup() æ–¹æ³•æ˜¯å¦è¿”å› true</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œåªé’ˆå¯¹ SmartLifecycle è¿›è¡Œäº†åˆ¤æ–­ï¼Œè¿™ä¹Ÿæ˜¯æ²¡æœ‰æ‰§è¡Œ Lifecycle#start() æ–¹æ³•çš„åŸå›  </span></span><br><span class="line">        <span class="keyword">if</span> (!autoStartupOnly || (bean <span class="keyword">instanceof</span> SmartLifecycle smartLifecycle &amp;&amp; smartLifecycle.isAutoStartup())) &#123;</span><br><span class="line">            <span class="comment">// è·å– phase å€¼ï¼ŒSmartLifecycle ç»§æ‰¿äº† Phasedï¼Œå®ç°ç±»å¯ä»¥è®¾ç½® phase å€¼</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">phase</span> <span class="operator">=</span> getPhase(bean);</span><br><span class="line">            <span class="comment">// å°†ç›¸åŒ phase å€¼çš„ Bean åˆ†åœ¨ä¸€ç»„</span></span><br><span class="line">            phases.computeIfAbsent(</span><br><span class="line">                phase,</span><br><span class="line">                p -&gt; <span class="keyword">new</span> <span class="title class_">LifecycleGroup</span>(phase, <span class="built_in">this</span>.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly)</span><br><span class="line">            ).add(beanName, bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!phases.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ¯ç»„ SmartLifecycle çš„ start æ–¹æ³•</span></span><br><span class="line">        phases.values().forEach(LifecycleGroup::start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–åˆ°æ‰€æœ‰ <code>Lifecycle</code> åï¼Œå¯¹å®ƒä»¬è¿›è¡Œè¿‡æ»¤å¹¶åˆ†ç»„ï¼Œç„¶åæ‰§è¡Œå®ƒä»¬çš„ <code>start()</code> æ–¹æ³•ã€‚æ‰§è¡Œé€»è¾‘ç”± <code>LifecycleGroup#start()</code> å®Œæˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// this.members å°±æ˜¯æ¯ç»„ Lifecycle</span></span><br><span class="line">    <span class="comment">// åªä¸è¿‡å°† Bean çš„ name å’Œ Bean å®ä¾‹åˆåŒ…æˆäº† LifecycleGroupMember å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.members.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Starting beans in phase &quot;</span> + <span class="built_in">this</span>.phase);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// LifecycleGroupMember å®ç°äº† Comparable æ¥å£ï¼ŒæŒ‰ phased å€¼å‡åºæ’åº</span></span><br><span class="line">    Collections.sort(<span class="built_in">this</span>.members);</span><br><span class="line">    <span class="keyword">for</span> (LifecycleGroupMember member : <span class="built_in">this</span>.members) &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ start() æ–¹æ³•</span></span><br><span class="line">        doStart(<span class="built_in">this</span>.lifecycleBeans, member.name, <span class="built_in">this</span>.autoStartupOnly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹æ¯ç»„ <code>Lifecycle</code> æŒ‰ <code>phased</code> å€¼å‡åºæ’åºï¼Œæ’åºå®Œæˆåä¾æ¬¡è°ƒç”¨ <code>doStart()</code> æ–¹æ³•ã€‚Spring ä¸­å–œæ¬¢å°†çœŸæ­£æ‰§è¡Œé€»è¾‘çš„æ–¹æ³•åä»¥ <code>do</code> å¼€å¤´ï¼Œå¯ä»¥æ–­å®šæ­¤å¤„çš„ <code>doStart()</code> æ–¹æ³•æ˜¯çœŸçš„ç”¨æ¥æ‰§è¡Œ <code>Lifecycle#start()</code> æ–¹æ³•çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doStart</span><span class="params">(Map&lt;String, ? extends Lifecycle&gt; lifecycleBeans, String beanName, <span class="type">boolean</span> autoStartupOnly)</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆä»é›†åˆä¸­ç§»é™¤è¦æ‰§è¡Œ start() æ–¹æ³•çš„ Lifecycle</span></span><br><span class="line">    <span class="type">Lifecycle</span> <span class="variable">bean</span> <span class="operator">=</span> lifecycleBeans.remove(beanName);</span><br><span class="line">    <span class="comment">// æˆåŠŸç§»é™¤ï¼Œå¹¶ä¸”ç§»é™¤çš„ä¸æ˜¯å½“å‰ DefaultLifecycleProcessor å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="literal">null</span> &amp;&amp; bean != <span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¾èµ–äº†å½“å‰ Bean çš„ Bean</span></span><br><span class="line">        String[] dependenciesForBean = getBeanFactory().getDependenciesForBean(beanName);</span><br><span class="line">        <span class="keyword">for</span> (String dependency : dependenciesForBean) &#123;</span><br><span class="line">            <span class="comment">// é€’å½’è°ƒç”¨ï¼Œä¼˜å…ˆæ‰§è¡Œä¾èµ–äº†å½“å‰ Bean çš„ Bean çš„ start() æ–¹æ³•</span></span><br><span class="line">            doStart(lifecycleBeans, dependency, autoStartupOnly);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Bean ä¸å¤„äºè¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (!bean.isRunning() &amp;&amp;</span><br><span class="line">            <span class="comment">// autoStartupOnly æ˜¯ falseï¼Œä½†ä¼ å…¥çš„ trueï¼Œè¿™ä¸ªæ¡ä»¶ä¸æ»¡è¶³</span></span><br><span class="line">            <span class="comment">// Bean ä¸æ˜¯ SmartLifecycle å®ä¾‹ï¼Œè¿™ä¹Ÿä¸æ»¡è¶³ï¼Œè¿™äº› Bean éƒ½æ˜¯ SmartLifecycle å®ä¾‹</span></span><br><span class="line">            <span class="comment">// SmartLifecycle çš„ isAutoStartup() æ–¹æ³•è¿”å› true</span></span><br><span class="line">            (!autoStartupOnly || !(bean <span class="keyword">instanceof</span> SmartLifecycle smartLifecycle) || smartLifecycle.isAutoStartup())) &#123;</span><br><span class="line">            <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨ start() æ–¹æ³•</span></span><br><span class="line">                bean.start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// æŠ›äº†ä¸ª ApplicationContextException</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆè·å– Bean çš„ä¾èµ–é¡¹ï¼Œé€’å½’è°ƒç”¨æ‰§è¡Œä¾èµ–é¡¹çš„ <code>start()</code> æ–¹æ³•ï¼Œä¹‹åæ‰æ‰§è¡Œ <code>start()</code> æ–¹æ³•ã€‚</p>
<h2 id="14-5-å®¹å™¨å…³é—­æ—¶"><a class="header-anchor" href="#14-5-å®¹å™¨å…³é—­æ—¶"></a>14.5 å®¹å™¨å…³é—­æ—¶</h2>
<p>åœ¨åˆ†æ <code>DisposableBean</code> çš„æ‰§è¡Œé€»è¾‘æ—¶ï¼Œè°ƒç”¨çš„ <code>AbstractApplicationContext#close()</code> æ–¹æ³•åˆä¼šè°ƒç”¨ <code>AbstractApplicationContext#doClose()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Check whether an actual close attempt is necessary...</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.active.get() &amp;&amp; <span class="built_in">this</span>.closed.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.lifecycleProcessor != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨ä¼šè°ƒç”¨ <code>this.lifecycleProcessor.onClose()</code>ï¼Œé€šè¿‡å‰æ–‡çš„åˆ†æå¯çŸ¥ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ <code>DefaultLifecycleProcessor</code> çš„ <code>onClose()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">   stopBeans();</span><br><span class="line">   <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†è¿›å…¥ <code>stopBeans()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopBeans</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">    Map&lt;Integer, LifecycleGroup&gt; phases = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    lifecycleBeans.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">shutdownPhase</span> <span class="operator">=</span> getPhase(bean);</span><br><span class="line">        <span class="type">LifecycleGroup</span> <span class="variable">group</span> <span class="operator">=</span> phases.get(shutdownPhase);</span><br><span class="line">        <span class="keyword">if</span> (group == <span class="literal">null</span>) &#123;</span><br><span class="line">            group = <span class="keyword">new</span> <span class="title class_">LifecycleGroup</span>(shutdownPhase, <span class="built_in">this</span>.timeoutPerShutdownPhase, lifecycleBeans, <span class="literal">false</span>);</span><br><span class="line">            phases.put(shutdownPhase, group);</span><br><span class="line">        &#125;</span><br><span class="line">        group.add(beanName, bean);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!phases.isEmpty()) &#123;</span><br><span class="line">        List&lt;Integer&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(phases.keySet());</span><br><span class="line">        keys.sort(Collections.reverseOrder());</span><br><span class="line">        <span class="keyword">for</span> (Integer key : keys) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œæ¯ç»„ LifecycleGroup çš„ stop() æ–¹æ³•</span></span><br><span class="line">            phases.get(key).stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå’Œå‰æ–‡çš„ <code>startBeans(boolean autoStartupOnly)</code> æ–¹æ³•å¾ˆç±»ä¼¼ï¼Œå¯¹å®¹å™¨ä¸­çš„æ‰€æœ‰ <code>Lifecycle</code> æŒ‰ <code>phased</code> å€¼è¿›è¡Œåˆ†ç»„ï¼Œé€†åºæ’åºåä¸€ä¸€æ‰§è¡Œã€‚</p>
<p>è¯´å¥é¢˜å¤–è¯ï¼š<code>stopBeans()</code> çš„å®ç°å…¶å®å¯ä»¥ <code>startBeans()</code> ä¿æŒä¸€è‡´ï¼Œå³å¼•å…¥ <code>TreeMap</code>ï¼Œæ›´ç®€å•åœ°ä½¿ç”¨ <code>Map#computeIfAbsent()</code> å®ç°åˆ†ç»„ï¼Œä½†æˆ‘å‘ç°è¿™ç‚¹å¹¶æƒ³å‘ Spring æäº¤ PR æ—¶ï¼Œå´å‘ç°åœ¨ 4 æœˆå·²ç»å­˜åœ¨è¢«åˆå¹¶çš„ç›¸å…³ <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/pull/30361">PR</a>ï¼Œå¯æƒœå‘ Spring æäº¤ PR çš„è®¡åˆ’æ³¡æ±¤äº†ã€‚æœ¬æ–‡ä½¿ç”¨çš„ Spring ç‰ˆæœ¬æ˜¯æ­¤æ—¶æœ€æ–°çš„ 6.0.12ï¼Œä¸çŸ¥é“ä¿®æ”¹ä¼šåœ¨å“ªä¸ªç‰ˆæœ¬ä¸Šç”Ÿæ•ˆå‘¢ï¼ŸğŸ‘»</p>
<p>å›åˆ°æ­£é¢˜ï¼Œç»§ç»­çœ‹ <code>LifecycleGroup#stop()</code> é‡Œçš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.members.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">    <span class="comment">// é€†åºæ’åºï¼ˆå·²ç»æ’åºï¼Œæ²¡æœ‰æ„ä¹‰ï¼‰</span></span><br><span class="line">    <span class="built_in">this</span>.members.sort(Collections.reverseOrder());</span><br><span class="line">    <span class="comment">// å¼•å…¥ CountDownLatchï¼Œæ•°é‡ç­‰äºå½“å‰ Lifecycle åˆ†ç»„ä¸­å…ƒç´ çš„æ•°é‡</span></span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="built_in">this</span>.smartMemberCount);</span><br><span class="line">    <span class="comment">// å†å¼•å…¥åŒæ­¥ Setï¼Œè¿™ç©æ„å…¶å®æ˜¯ç”¨æ¥è®°å½•æ—¥å¿—çš„ï¼Œä¸»è¦é€»è¾‘å’Œå®ƒå…³ç³»ä¸å¤§</span></span><br><span class="line">    Set&lt;String&gt; countDownBeanNames = Collections.synchronizedSet(<span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;());</span><br><span class="line">    <span class="comment">// åŒ…å«å½“å‰ Lifecycle åˆ†ç»„ä¸­æ‰€æœ‰ Bean çš„ name</span></span><br><span class="line">    Set&lt;String&gt; lifecycleBeanNames = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="built_in">this</span>.lifecycleBeans.keySet());</span><br><span class="line">    <span class="keyword">for</span> (LifecycleGroupMember member : <span class="built_in">this</span>.members) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lifecycleBeanNames.contains(member.name)) &#123;</span><br><span class="line">            doStop(<span class="built_in">this</span>.lifecycleBeans, member.name, latch, countDownBeanNames);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (member.bean <span class="keyword">instanceof</span> SmartLifecycle) &#123;</span><br><span class="line">            <span class="comment">// Already removed: must have been a dependent bean from another phase</span></span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é˜»å¡ä¸‹ï¼Œç›´åˆ°æ‰€æœ‰ Lifecycle éƒ½æ‰§è¡Œå®Œæˆ–è€…è¾¾åˆ°æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 30 ç§’</span></span><br><span class="line">        latch.await(<span class="built_in">this</span>.timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•å†…éƒ¨æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š</p>
<ol>
<li>å¼•å…¥ <code>CountDownLatch</code>ï¼›</li>
<li>å¼•å…¥ <code>lifecycleBeanNames</code>ï¼Œå¹¶åœ¨éå†æ¯ä¸ª <code>Lifecycle</code> æ—¶ï¼Œæ‰§è¡Œ <code>contains()</code> æ–¹æ³•ã€‚</li>
</ol>
<p>ä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œåœ¨å®ç° <code>SmartLifecycle</code> æ¥å£é‡å†™ <code>stop(Runnable callback)</code> æ–¹æ³•æ—¶ï¼Œå¯ä»¥å¼€ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå†…éƒ¨é€»è¾‘ï¼Œä½¿å¤šä¸ª <code>SmartLifecycle</code> çš„ <code>stop()</code> æ–¹æ³•å¹¶è¡Œæ‰§è¡Œã€‚</p>
<p>å½“å‰çº¿ç¨‹å¿…é¡»ç­‰å¾…æ‰€æœ‰æ‰§è¡Œ <code>stop()</code> æ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œå®Œæ‰ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå› æ­¤å¼•å…¥äº† <code>CountDownLatch</code>ã€‚</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ª Bean åˆ†åˆ«å« A å’Œ Bï¼ŒA ä¾èµ–äº† Bï¼Œä½† A çš„ <code>phased</code> å°äº Bï¼Œå› æ­¤ä¼šå…ˆæ‰§è¡Œ B çš„ <code>stop()</code> æ–¹æ³•ã€‚åœ¨æ‰§è¡Œäº† B çš„ <code>stop()</code> æ–¹æ³•æ—¶ï¼Œå‘ç° A ä¾èµ–äº†å®ƒï¼Œäºæ˜¯ä¼šæ›´å…ˆä¸€æ­¥æ‰§è¡Œ A çš„ <code>stop()</code> æ–¹æ³•ï¼Œä¹‹åå†æ‰§è¡Œ B çš„ <code>stop()</code> æ–¹æ³•ã€‚ç­‰åˆ° B çš„ <code>stop()</code> æ‰§è¡Œå®Œï¼ŒæŒ‰ç…§ <code>phased</code> çš„å¤§å°ï¼Œæ¥ä¸‹æ¥åº”è¯¥æ‰§è¡Œ A çš„ <code>stop()</code> æ–¹æ³•ï¼Œä½†ç”±äº A çš„ <code>stop()</code> æ–¹æ³•åœ¨å…ˆå‰å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œå†æ¥ä¸€éè‚¯å®šæ˜¯ä¸åˆé€‚çš„ï¼Œå› æ­¤å¼•å…¥ <code>lifecycleBeanNames</code> åˆ¤æ–­ A ä¸åœ¨è¯¥é›†åˆä¸­ï¼Œé‚£ä¹ˆç›´æ¥æ‰§è¡Œ <code>CountDownLatch#countDown()</code> å³å¯ã€‚è¿™é‡Œæ¶‰åŠåˆ° <code>doStop()</code> æ–¹æ³•çš„åˆ†æï¼Œå®ƒå†…éƒ¨æœ‰ä»€ä¹ˆå¥¥ç§˜å‘¢ï¼Ÿ</p>
<p>ä¸ <code>doStart()</code> æ–¹æ³•ç±»ä¼¼ï¼Œ<code>doStop()</code> ä¹Ÿæ˜¯ç”¨æ¥çœŸæ­£æ‰§è¡Œ <code>Lifecycle#stop()</code> çš„ï¼Œå…¶å¤„ç†é€»è¾‘ä¹Ÿå’Œ <code>doStart()</code> ç±»ä¼¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doStop</span><span class="params">(Map&lt;String, ? extends Lifecycle&gt; lifecycleBeans, <span class="keyword">final</span> String beanName,</span></span><br><span class="line"><span class="params">                    <span class="keyword">final</span> CountDownLatch latch, <span class="keyword">final</span> Set&lt;String&gt; countDownBeanNames)</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆä»é›†åˆä¸­ç§»é™¤è¦æ‰§è¡Œ stop() æ–¹æ³•çš„ Lifecycle</span></span><br><span class="line">    <span class="type">Lifecycle</span> <span class="variable">bean</span> <span class="operator">=</span> lifecycleBeans.remove(beanName);</span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å’Œ doStart() æ–¹æ³•ç±»ä¼¼ï¼Œå…ˆå¤„ç†ä¾èµ–äº†å½“å‰ Bean çš„ Bean</span></span><br><span class="line">        String[] dependentBeans = getBeanFactory().getDependentBeans(beanName);</span><br><span class="line">        <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">            doStop(lifecycleBeans, dependentBean, latch, countDownBeanNames);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœ Bean æ­£åœ¨è¿è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (bean.isRunning()) &#123;</span><br><span class="line">                <span class="comment">// Bean è¿˜æ˜¯ SmartLifecycle ç±»å‹</span></span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> SmartLifecycle smartLifecycle) &#123;</span><br><span class="line">                    <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">                    countDownBeanNames.add(beanName);</span><br><span class="line">                    <span class="comment">// æ‰§è¡Œ SmartLifecycle çš„ stop(Runnable) æ–¹æ³•</span></span><br><span class="line">                    smartLifecycle.stop(() -&gt; &#123;</span><br><span class="line">                        <span class="comment">// å†…éƒ¨è°ƒç”¨äº† CountDownLatch#countDown()</span></span><br><span class="line">                        latch.countDown();</span><br><span class="line">                        countDownBeanNames.remove(beanName);</span><br><span class="line">                        <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">                    <span class="comment">// ä¸æ˜¯ SmartLifecycle ç±»å‹ï¼Œç›´æ¥è°ƒç”¨ stop() æ–¹æ³•</span></span><br><span class="line">                    bean.stop();</span><br><span class="line">                    <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> SmartLifecycle) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t wait for beans that aren&#x27;t running...</span></span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// çœç•¥æ—¥å¿—çš„æ‰“å°</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œä½†æœ‰ä¸€ä¸ªé‡è¦çš„æ³¨æ„ç‚¹ï¼šå¦‚æœ Bean çš„ç±»å‹æ˜¯ <code>SmartLifecycle</code> æ—¶ï¼Œä¼ å…¥äº†ä¸€ä¸ª <code>Runnable</code>ï¼Œå¹¶ä¸” <strong>åœ¨ <code>Runnable</code> ä¸­æ‰§è¡Œäº† <code>CountDownLatch#countDown()</code></strong>ï¼Œè¿™è¦æ±‚ <mark>åœ¨é‡å†™ <code>stop(Runnable callback)</code> æ–¹æ³•æ—¶ä¸€å®šè¦åœ¨å†…éƒ¨è°ƒç”¨ <code>callback.run()</code></mark>ï¼Œå¦åˆ™ <code>CountDownLatch</code> çš„è®¡æ•°å‡ä¸ä¸‹å»ï¼Œå°±ä¼šåœ¨è¾¾åˆ°è®¾ç½®çš„è¶…æ—¶æ—¶é—´å‰ä¸€ç›´é˜»å¡çº¿ç¨‹ã€‚</p>
<h1 id="15-Spring-ç”Ÿå‘½å‘¨æœŸ"><a class="header-anchor" href="#15-Spring-ç”Ÿå‘½å‘¨æœŸ"></a>15. Spring ç”Ÿå‘½å‘¨æœŸ</h1>
<p>Spring çš„ç”Ÿå‘½å‘¨æœŸï¼Œå…¶å®æŒ‡çš„æ˜¯ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼ŒBean çš„ç”Ÿå‘½å‘¨æœŸæ¦‚æ‹¬èµ·æ¥å…±ä¸‰æ­¥ï¼š</p>
<ol>
<li>å°† Java ç±»æŠ½è±¡ä¸º <code>BeanDefinition</code> å¯¹è±¡ï¼›</li>
<li>æ ¹æ® <code>BeanDefinition</code> å¯¹è±¡å®Œæˆ Bean çš„å®ä¾‹åŒ–ã€åˆå§‹åŒ–å’Œå…¶ä»–æ‹“å±•æ“ä½œï¼›</li>
<li>ä½¿ç”¨ Spring ç®¡ç†çš„ Beanï¼Œç›´è‡³é”€æ¯ã€‚</li>
</ol>
<p>å‰æ–‡èŠ±äº†å¤§é‡ç¯‡å¹…ä»‹ç» SpringBoot çš„æ‹“å±•ç‚¹ï¼Œè€Œè¿™äº›æ‹“å±•ç‚¹æ˜¯è´¯ç©¿ Bean çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼ŒæŒ‰ç…§æ‰§è¡Œå…ˆåå¯ä»¥ç»˜åˆ¶å‡ºåŒ…å«å¤§å¤šæ•°æ‹“å±•ç‚¹çš„æ‰§è¡Œæµç¨‹å›¾ï¼š</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/SpringBoot%E6%8B%93%E5%B1%95%E7%82%B9%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="SpringBootæ‹“å±•ç‚¹æµç¨‹å›¾"></p>
<h1 id="16-æ€»ç»“"><a class="header-anchor" href="#16-æ€»ç»“"></a>16. æ€»ç»“</h1>
<p>æœ¬æ–‡ä»‹ç»äº† BeanFactory å‘¨å›´ã€Bean å®ä¾‹åŒ–å‘¨å›´ã€Bean åˆå§‹åŒ–å‘¨å›´å…±åå¤šä¸ªæ‹“å±•ç‚¹ï¼Œæ¯ä¸ªæ‹“å±•ç‚¹åˆ†ä¸ºä½œç”¨ã€ä½¿ç”¨æ–¹å¼ã€å®ä¾‹åŒ–ï¼ˆæ³¨å†Œï¼‰ã€æ‰§è¡Œã€å†…ç½®å®ç°ç­‰å°èŠ‚ï¼Œå¹¶ç»“åˆæºç è¿›è¡Œè®²è§£ï¼Œæœ€ç»ˆå°†è¿™äº›æ‹“å±•ç‚¹æ±‡æ€»æŒ‡å‘ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>è¡Œæ–‡è¿‡ç¨‹ä¸­ç•™ä¸‹äº†ä¸€äº›å‘ï¼š</p>
<ul>
<li><code>getBean()</code> æ–¹æ³•æºç åˆ†æ</li>
<li>AOP æºç åˆ†æ</li>
<li>Spring å¾ªç¯ä¾èµ–æºç åˆ†æ</li>
<li><a href="../SpringBoot-Shutdown-Hook">Spring Shutdown Hook</a></li>
</ul>
<p>è¿™äº›å†…å®¹æ…¢æ…¢æ¥å§ï¼Œä»Šå¹´åº”è¯¥èƒ½å¤Ÿæ•´å®Œï¼Ÿï¼ ğŸ¤”</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">é»˜çƒ¦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/">https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://mofan212.github.io" target="_blank">Mofan</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Boot/">Spring-Boot</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg" data-sites="wechat,qq,weibo,facebook,x"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>èµåŠ©</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Configuration-Annotation/" title="@Configuration æ³¨è§£çš„é‚£äº›äº‹"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/25.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">@Configuration æ³¨è§£çš„é‚£äº›äº‹</div></div><div class="info-2"><div class="info-item-1">ä»æºç å±‚é¢ä»‹ç» @Configuration æ³¨è§£çš„ Full æ¨¡å¼ä¸ Lite æ¨¡å¼ã€‚</div></div></div></a><a class="pagination-related" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/141.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">SpringBoot Shutdown Hook</div></div><div class="info-2"><div class="info-item-1">ä»‹ç»äº† System.exit() æ–¹æ³•çš„æºç ã€SpringBoot ä¼˜é›…åœæœºç­‰å†…å®¹ã€‚</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Spring-BeanDefinition/" title="BeanDefinition"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/153.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-11</div><div class="info-item-2">BeanDefinition</div></div><div class="info-2"><div class="info-item-1">Spring ä¸­ç»•ä¸å¼€çš„ä¸€ä¸ªç±» â€”â€” BeanDefinitionã€‚</div></div></div></a><a class="pagination-related" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/141.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="info-item-2">SpringBoot Shutdown Hook</div></div><div class="info-2"><div class="info-item-1">ä»‹ç»äº† System.exit() æ–¹æ³•çš„æºç ã€SpringBoot ä¼˜é›…åœæœºç­‰å†…å®¹ã€‚</div></div></div></a><a class="pagination-related" href="/posts/Spring-Forty-Nine-Lectures-MVC/" title="ã€Spring å››åä¹è®²ã€‘WebMVC"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/124.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-27</div><div class="info-item-2">ã€Spring å››åä¹è®²ã€‘WebMVC</div></div><div class="info-2"><div class="info-item-1">Spring å››åä¹è®²ä¸­ç¬¬å»¿è®²åˆ°ç¬¬å…å…­è®²ï¼ŒWebMVCã€‚</div></div></div></a><a class="pagination-related" href="/posts/Spring-Forty-Nine-Lectures-Sundry/" title="ã€Spring å››åä¹è®²ã€‘æ‚é¡¹"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/126.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-03</div><div class="info-item-2">ã€Spring å››åä¹è®²ã€‘æ‚é¡¹</div></div><div class="info-2"><div class="info-item-1">Spring å››åä¹è®²ä¸­ç¬¬åŒä¸‰è®²åˆ°ç¬¬åŒä¹è®²ï¼Œæ‚é¡¹ã€‚</div></div></div></a><a class="pagination-related" href="/posts/Get-ApplicationContext/" title="è·å– ApplicationContext"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/139.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-20</div><div class="info-item-2">è·å– ApplicationContext</div></div><div class="info-2"><div class="info-item-1">è·å– ApplicationContext æœ‰å“ªäº›æ–¹å¼ã€åˆæœ‰å“ªäº›åŒºåˆ«å‘¢ï¼Ÿ</div></div></div></a><a class="pagination-related" href="/posts/Spring-Forty-Nine-Lectures-Container-And-Bean/" title="ã€Spring å››åä¹è®²ã€‘å®¹å™¨ä¸ Bean"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/122.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-08</div><div class="info-item-2">ã€Spring å››åä¹è®²ã€‘å®¹å™¨ä¸ Bean</div></div><div class="info-2"><div class="info-item-1">Spring å››åä¹è®²ä¸­ç¬¬ä¸€è®²åˆ°ç¬¬å…«è®²ï¼Œå®¹å™¨ä¸ Beanã€‚</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">é»˜çƒ¦</div><div class="author-info-description">å½©ç¬”çš„æ‰“æ€ªå‡çº§ä¹‹è·¯...</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="é‚®ç®±"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æœ¬ç«™æ‰€æœ‰åšæ–‡å‡æ˜¯åšä¸»çš„å­¦ä¹ ç¬”è®°ä¸ä¸ªäººç†è§£ã€‚<strong><font style="color:red">é™¤ç‰¹åˆ«æ³¨æ˜å¤–ï¼Œ</font>å¦‚éœ€è½¬è½½ï¼Œè¯·åœ¨æ–‡ç« å¤´éƒ¨é†’ç›®å¤„é™„å¸¦åŸæ–‡é“¾æ¥å¹¶<a href="./mine/" style="color:#49B1F5;text-decoration:underline">å‘ŠçŸ¥æˆ‘</a></strong>ä½ å°†è½¬è½½ã€‚ğŸ˜Š</br><strong><font style="color:red">ä¸¥ç¦æœªéµå¾ªè§„èŒƒçš„è½¬è½½ã€‚</font></strong>ğŸ˜¡</br><strong>æ­»å»çš„è¯„è®ºç³»ç»Ÿå¤æ´»å•¦ï¼æ¬¢è¿åˆ°ç•™è¨€æ¿ç•…æ‰€æ¬²è¨€ï¼</strong>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´é«˜æ•ˆçš„<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> å“”å“©å“”å“©ç§ä¿¡ </a>æˆ–<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">é‚®ç®±</a>ã€‚ ğŸ˜‰</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0. å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8"><span class="toc-text">1. åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹åŒ–å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">1.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">1.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">1.3 å®ä¾‹åŒ–ä¸æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.4 å†…ç½®å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Bean-%E5%B7%A5%E5%8E%82%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">2. Bean å·¥å‚åç½®å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">2.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">2.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3"><span class="toc-text">2.3 æ‰§è¡Œå…¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="toc-text">2.4 ç¬¬äºŒä¸ªå‚æ•°çš„æ¥æº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E6%89%A7%E8%A1%8C%E7%9A%84%E9%80%BB%E8%BE%91"><span class="toc-text">2.5 æ‰§è¡Œçš„é€»è¾‘</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Bean-%E5%AE%9A%E4%B9%89%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">3. Bean å®šä¹‰æ³¨å†Œè¡¨åç½®å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">3.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">3.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%A0%E4%B8%AA%E7%B1%BB"><span class="toc-text">3.3 ç›¸å…³çš„å‡ ä¸ªç±»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">3.4 å®ä¾‹åŒ–ä¸æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.5 å†…ç½®å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Bean-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">4. Bean åç½®å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">4.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">4.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">4.3 æ³¨å†Œä¸æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">4.4 å†…ç½®å®ç°ä¸ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E6%9B%B4%E5%A4%9A%E6%80%9D%E8%80%83"><span class="toc-text">4.5 æ›´å¤šæ€è€ƒ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%84%9F%E7%9F%A5-Bean-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">5. å®ä¾‹åŒ–æ„ŸçŸ¥ Bean åç½®å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">5.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">5.2 ä½¿ç”¨æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%B3%A8%E5%86%8C"><span class="toc-text">5.3 æ³¨å†Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%89%A7%E8%A1%8C"><span class="toc-text">5.4 æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.5 å†…ç½®å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%99%BA%E8%83%BD%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%84%9F%E7%9F%A5-Bean-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">6. æ™ºèƒ½å®ä¾‹åŒ–æ„ŸçŸ¥ Bean åç½®å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">6.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">6.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%B3%A8%E5%86%8C"><span class="toc-text">6.3 æ³¨å†Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E6%89%A7%E8%A1%8C"><span class="toc-text">6.4 æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">6.5 å†…ç½®å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E6%84%9F%E7%9F%A5"><span class="toc-text">7. åº”ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">7.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">7.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">7.3 æ³¨å†Œä¸æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E4%B8%80%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">7.4 ä¸€ä¸ªé‡è¦çš„ç»†èŠ‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E5%8F%A6%E4%B8%80%E4%B8%AA-Aware"><span class="toc-text">7.5 å¦ä¸€ä¸ª Aware</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-PostConstruct"><span class="toc-text">8. @PostConstruct</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">8.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">8.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">8.3 æ‰§è¡Œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E5%88%9D%E5%A7%8B%E5%8C%96-Bean"><span class="toc-text">9. åˆå§‹åŒ– Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">9.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">9.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">9.3 æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">9.4 å†…ç½®å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%99%BA%E8%83%BD%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8D%95%E4%BE%8B"><span class="toc-text">10. æ™ºèƒ½åˆå§‹åŒ–å•ä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">10.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">10.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">10.3 æ‰§è¡Œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E4%B8%A4%E4%B8%AA%E8%BF%90%E8%A1%8C%E5%99%A8"><span class="toc-text">11. ä¸¤ä¸ªè¿è¡Œå™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">11.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">11.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">11.3 æ‰§è¡Œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E5%B7%A5%E5%8E%82-Bean"><span class="toc-text">12. å·¥å‚ Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">12.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">12.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3-%E6%B3%A8%E5%86%8C"><span class="toc-text">12.3 æ³¨å†Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-4-%E6%89%A7%E8%A1%8C"><span class="toc-text">12.4 æ‰§è¡Œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E5%8F%AF%E9%94%80%E6%AF%81-Bean"><span class="toc-text">13. å¯é”€æ¯ Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">13.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">13.2 ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">13.3 æ‰§è¡Œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-%E6%99%BA%E8%83%BD%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">14. æ™ºèƒ½ç”Ÿå‘½å‘¨æœŸ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">14.1 æ‹“å±•ç‚¹çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-Lifecycle"><span class="toc-text">14.2 Lifecycle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-3-SmartLifecycle"><span class="toc-text">14.3 SmartLifecycle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-4-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E6%97%B6"><span class="toc-text">14.4 å®¹å™¨å¯åŠ¨æ—¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-5-%E5%AE%B9%E5%99%A8%E5%85%B3%E9%97%AD%E6%97%B6"><span class="toc-text">14.5 å®¹å™¨å…³é—­æ—¶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-Spring-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">15. Spring ç”Ÿå‘½å‘¨æœŸ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16-%E6%80%BB%E7%BB%93"><span class="toc-text">16. æ€»ç»“</span></a></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>SpringBoot æºç å‰–æ</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/From-Callback-To-LambdaSafe/" title="ä»å›è°ƒåˆ° LambdaSafe"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/131.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="ä»å›è°ƒåˆ° LambdaSafe"></a><div class="content"><a class="title" href="/posts/From-Callback-To-LambdaSafe/" title="ä»å›è°ƒåˆ° LambdaSafe">ä»å›è°ƒåˆ° LambdaSafe</a><time datetime="2023-03-11T16:00:00.000Z" title="å‘è¡¨äº 2023-03-12 00:00:00">2023-03-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Get-ApplicationContext/" title="è·å– ApplicationContext"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/139.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="è·å– ApplicationContext"></a><div class="content"><a class="title" href="/posts/Get-ApplicationContext/" title="è·å– ApplicationContext">è·å– ApplicationContext</a><time datetime="2023-09-19T16:00:00.000Z" title="å‘è¡¨äº 2023-09-20 00:00:00">2023-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Configuration-Annotation/" title="@Configuration æ³¨è§£çš„é‚£äº›äº‹"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/25.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="@Configuration æ³¨è§£çš„é‚£äº›äº‹"></a><div class="content"><a class="title" href="/posts/Configuration-Annotation/" title="@Configuration æ³¨è§£çš„é‚£äº›äº‹">@Configuration æ³¨è§£çš„é‚£äº›äº‹</a><time datetime="2023-09-22T16:00:00.000Z" title="å‘è¡¨äº 2023-09-23 00:00:00">2023-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Common-Extension-Points-In-Spring-Boot/" title="SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹"></a><div class="content"><a class="title" href="/posts/Common-Extension-Points-In-Spring-Boot/" title="SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹">SpringBoot å¸¸ç”¨æ‹“å±•ç‚¹</a><time datetime="2023-10-02T16:00:00.000Z" title="å‘è¡¨äº 2023-10-03 00:00:00">2023-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/141.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="SpringBoot Shutdown Hook"></a><div class="content"><a class="title" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook">SpringBoot Shutdown Hook</a><time datetime="2023-10-14T16:00:00.000Z" title="å‘è¡¨äº 2023-10-15 00:00:00">2023-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Application-Event/" title="Spring çš„äº‹ä»¶ç›‘å¬æœºåˆ¶"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/151.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Spring çš„äº‹ä»¶ç›‘å¬æœºåˆ¶"></a><div class="content"><a class="title" href="/posts/Spring-Application-Event/" title="Spring çš„äº‹ä»¶ç›‘å¬æœºåˆ¶">Spring çš„äº‹ä»¶ç›‘å¬æœºåˆ¶</a><time datetime="2024-07-13T16:00:00.000Z" title="å‘è¡¨äº 2024-07-14 00:00:00">2024-07-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-BeanDefinition/" title="BeanDefinition"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/153.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="BeanDefinition"></a><div class="content"><a class="title" href="/posts/Spring-BeanDefinition/" title="BeanDefinition">BeanDefinition</a><time datetime="2024-08-10T16:00:00.000Z" title="å‘è¡¨äº 2024-08-11 00:00:00">2024-08-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring é…ç½®ç±»çš„è§£æ"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/154.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Spring é…ç½®ç±»çš„è§£æ"></a><div class="content"><a class="title" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring é…ç½®ç±»çš„è§£æ">Spring é…ç½®ç±»çš„è§£æ</a><time datetime="2024-10-25T16:00:00.000Z" title="å‘è¡¨äº 2024-10-26 00:00:00">2024-10-26</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Something-About-Blog/" title="åšå®¢æ­å»ºä¸ç»´æŠ¤"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/42.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="åšå®¢æ­å»ºä¸ç»´æŠ¤"/></a><div class="content"><a class="title" href="/posts/Something-About-Blog/" title="åšå®¢æ­å»ºä¸ç»´æŠ¤">åšå®¢æ­å»ºä¸ç»´æŠ¤</a><time datetime="2026-01-24T16:00:00.000Z" title="æ›´æ–°äº 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java å†…å­˜æ¨¡å‹"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java å†…å­˜æ¨¡å‹"/></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java å†…å­˜æ¨¡å‹">Java å†…å­˜æ¨¡å‹</a><time datetime="2026-01-02T16:00:00.000Z" title="æ›´æ–°äº 2026-01-03 00:00:00">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="å­—èŠ‚ç ä¸ç±»åŠ è½½"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="å­—èŠ‚ç ä¸ç±»åŠ è½½"/></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="å­—èŠ‚ç ä¸ç±»åŠ è½½">å­—èŠ‚ç ä¸ç±»åŠ è½½</a><time datetime="2026-01-01T16:00:00.000Z" title="æ›´æ–°äº 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Class-Resource-Loading-In-Java/" title="Java çš„ç±»èµ„æºåŠ è½½"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java çš„ç±»èµ„æºåŠ è½½"/></a><div class="content"><a class="title" href="/posts/Class-Resource-Loading-In-Java/" title="Java çš„ç±»èµ„æºåŠ è½½">Java çš„ç±»èµ„æºåŠ è½½</a><time datetime="2026-01-01T16:00:00.000Z" title="æ›´æ–°äº 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Annotation-And-Reflection/" title="æ³¨è§£ã€ç±»çš„åŠ è½½ã€åå°„"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/20.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="æ³¨è§£ã€ç±»çš„åŠ è½½ã€åå°„"/></a><div class="content"><a class="title" href="/posts/Annotation-And-Reflection/" title="æ³¨è§£ã€ç±»çš„åŠ è½½ã€åå°„">æ³¨è§£ã€ç±»çš„åŠ è½½ã€åå°„</a><time datetime="2026-01-01T16:00:00.000Z" title="æ›´æ–°äº 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ren-zhi-jue-xing/" title="è®¤çŸ¥è§‰é†’"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/172.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="è®¤çŸ¥è§‰é†’"/></a><div class="content"><a class="title" href="/posts/ren-zhi-jue-xing/" title="è®¤çŸ¥è§‰é†’">è®¤çŸ¥è§‰é†’</a><time datetime="2025-12-28T16:00:00.000Z" title="æ›´æ–°äº 2025-12-29 00:00:00">2025-12-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By é»˜çƒ¦</span><span class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://testingcf.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://gcore.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script src="/js/tip_portal.js"></script><script defer="defer" id="ribbon" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://testingcf.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: 'è¾“å…¥å…³é”®å­—è¿›è¡Œæœç´¢',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>