<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringBoot 常用拓展点 | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="2023 年国庆巨献：从源码层面剖析 SpringBoot 常用拓展点">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot 常用拓展点">
<meta property="og:url" content="https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="2023 年国庆巨献：从源码层面剖析 SpringBoot 常用拓展点">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg">
<meta property="article:published_time" content="2023-10-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-01T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="Spring-Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SpringBoot 常用拓展点",
  "url": "https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg",
  "datePublished": "2023-10-02T16:00:00.000Z",
  "dateModified": "2025-03-01T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://testingcf.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringBoot 常用拓展点',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css" /><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://testingcf.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SpringBoot 常用拓展点</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-02T16:00:00.000Z" title="发表于 2023-10-03 00:00:00">2023-10-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-01T16:00:00.000Z" title="更新于 2025-03-02 00:00:00">2025-03-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/Spring-Boot/">Spring-Boot</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">23.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>96分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2025-03-02 00:00:00&quot;}" hidden></div>
    <style>
      .highlight-tools {
        background: #262931 !important;
      }
    </style>
    <html><head></head><body><p>封面画师：T5-茨舞（微博）     封面ID：108988374</p>
<p>本文涉及的代码：<a target="_blank" rel="noopener" href="https://github.com/mofan212/springboot-study/tree/master/extension-point-summary">springboot-study/extension-point-summary</a></p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/fox9916/article/details/128522598">Springboot扩展点</a></p>
<blockquote>
<p>本文基于 SpringBoot 3.1.x 和 JDK17</p>
</blockquote>
<h1 id="0-前言"><a class="header-anchor" href="#0-前言"></a>0. 前言</h1>
<p>Spring 的核心是容器，SpringBoot 则是对 Spring 的又一层封装，一个注解、一个方法将复杂功能全部隐藏，实现开箱即用，但如果需要对某些功能进行定制，就需要利用 SpringBoot 预留的拓展点来实现。</p>
<p>学习 SpringBoot 的简单使用并不难，学习 SpringBoot 如何将复杂功能进行简化、预留的拓展点如何使用才是重中之重。</p>
<h1 id="1-应用上下文初始化器"><a class="header-anchor" href="#1-应用上下文初始化器"></a>1. 应用上下文初始化器</h1>
<h2 id="1-1-拓展点的作用"><a class="header-anchor" href="#1-1-拓展点的作用"></a>1.1 拓展点的作用</h2>
<p>应用上下文初始化器，即：<code>ApplicationContextInitializer</code>，它并非由 SpringBoot 提供，而是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">FunctionalInterface</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ApplicationContextInitializer</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">C</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> ConfigurableApplicationContext</span><span style="color:#ABB2BF">&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> initialize</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">C</span><span style="color:#E06C75;font-style:italic"> applicationContext</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 Spring 容器初始化时，所有实现 <code>ApplicationContextInitializer</code> 接口的类都会被实例化；在 Spring 容器 <code>refresh</code> 前，<code>ApplicationContextInitializer</code> 所有实现类的 <code>initialize()</code> 方法都会被依次调用，调用顺序可使用 Spring 提供的 <code>Ordered</code> 接口、<code>@Order</code> 接口等方式进行指定。</p>
<p><strong><code>ApplicationContextInitializer</code> 接口常用于需要对应用上下文进行初始化的的 Web 应用程序中，比如在上下文环境中注册运行环境属性或激活配置文件。</strong></p>
<h2 id="1-2-使用方式"><a class="header-anchor" href="#1-2-使用方式"></a>1.2 使用方式</h2>
<p>实现 <code>ApplicationContextInitializer</code> 接口，重写 <code>initialize()</code> 方法。</p>
<p>由于 <code>initialize()</code> 方法的执行时间点在 Spring 容器未初始化完成前，因此将实现类交由 Spring 管理，并以此来执行重写的 <code>initialize()</code> 方法是行不通的，此时可以使用 SpringBoot 的自动装配机制、读取配置文件信息或手动添加初始化器来添加初始化器。</p>
<p>编写 <code>ApplicationContextInitializer</code> 的三个实现类，在实现类中增加系统变量：</p>
<figure class="highlight properties line-numbers" data-language="PROPERTIES">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">1</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">ONE</span></span>
<span class="line"><span style="color:#C678DD">2</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">TWO</span></span>
<span class="line"><span style="color:#C678DD">3</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">THREE</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> FirstApplicationContextInitializer</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ApplicationContextInitializer</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">ConfigurableApplicationContext</span><span style="color:#ABB2BF">&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> initialize</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ConfigurableApplicationContext</span><span style="color:#E06C75;font-style:italic"> context</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#61AFEF">        putProperty</span><span style="color:#ABB2BF">(context, </span><span style="color:#98C379">"1"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"ONE"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>利用 SpringBoot 的自动装配机制</p>
</blockquote>
<p>创建 <code>META-INF/spring.factories</code> 文件，在该文件中添加 <code>ApplicationContextInitializer</code> 的实现类信息：</p>
<figure class="highlight properties line-numbers" data-language="PROPERTIES">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">org.springframework.context.ApplicationContextInitializer</span><span style="color:#ABB2BF"> =</span><span style="color:#98C379"> \</span></span>
<span class="line"><span style="color:#98C379">  indi.mofan.summary.a01.A01ExtensionPoint.FirstApplicationContextInitializer</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>读取配置文件信息</p>
</blockquote>
<p>创建 <code>application.properties</code> 配置文件，在配置文件中以 <code>context.initializer.classes</code> 为 Key，添加 <code>ApplicationContextInitializer</code> 的实现类信息：</p>
<figure class="highlight properties line-numbers" data-language="PROPERTIES">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">context.initializer.classes</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">indi.mofan.summary.a01.A01ExtensionPoint.SecondApplicationContextInitializer</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>手动添加初始化器</p>
</blockquote>
<p>创建 <code>SpringApplication</code> 对象，调用其 <code>addInitializers()</code> 方法手动添加初始化器。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2023/5/21 16:58</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A01ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        SpringApplication</span><span style="color:#E06C75"> application</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> SpringApplication</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A01ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        application</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addInitializers</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> ThirdApplicationContextInitializer</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> application</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(args);</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableEnvironment</span><span style="color:#E06C75"> environment</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getEnvironment</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">environment</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1"</span><span style="color:#ABB2BF">)); </span><span style="color:#7F848E;font-style:italic">// ONE</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">environment</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2"</span><span style="color:#ABB2BF">)); </span><span style="color:#7F848E;font-style:italic">// TWO</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">environment</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3"</span><span style="color:#ABB2BF">)); </span><span style="color:#7F848E;font-style:italic">// THREE</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="1-3-实例化与执行"><a class="header-anchor" href="#1-3-实例化与执行"></a>1.3 实例化与执行</h2>
<blockquote>
<p>实例化</p>
</blockquote>
<p>在 SpringBoot 中，构造 <code>SpringApplication</code> 对象时会调用 <code>setInitializers()</code> 方法添加所有 <code>ApplicationContextInitializer</code> 实例。见：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#61AFEF"> SpringApplication</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ResourceLoader</span><span style="color:#E06C75"> resourceLoader</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#ABB2BF">...</span><span style="color:#E5C07B"> primarySources</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">resourceLoader</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> resourceLoader</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">notNull</span><span style="color:#ABB2BF">(primarySources, </span><span style="color:#98C379">"PrimarySources must not be null"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">primarySources</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashSet</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(primarySources)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">webApplicationType</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> WebApplicationType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">deduceFromClasspath</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">bootstrapRegistryInitializers</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#61AFEF">        getSpringFactoriesInstances</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">BootstrapRegistryInitializer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 实例化时机</span></span>
<span class="line"><span style="color:#61AFEF">    setInitializers</span><span style="color:#E06C75">((Collection) </span><span style="color:#61AFEF">getSpringFactoriesInstances</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ApplicationContextInitializer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    setListeners</span><span style="color:#E06C75">((Collection) </span><span style="color:#61AFEF">getSpringFactoriesInstances</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ApplicationListener</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">mainApplicationClass</span><span style="color:#56B6C2"> =</span><span style="color:#61AFEF"> deduceMainApplicationClass</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>执行</p>
</blockquote>
<p>调用 <code>SpringApplication</code> 对象的 <code>run()</code> 方法时，在执行 <code>refreshContext()</code> 方法前调用 <code>prepareContext()</code> 方法，在该方法中调用 <code>applyInitializers()</code> 方法执行上一步添加的所有 <code>ApplicationContextInitializer</code> 实例的 <code>initialize()</code> 方法。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">// org.springframework.boot.SpringApplication#prepareContext()</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> prepareContext</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">DefaultBootstrapContext</span><span style="color:#E06C75"> bootstrapContext</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                            ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                            ConfigurableEnvironment</span><span style="color:#E06C75"> environment</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                            SpringApplicationRunListeners</span><span style="color:#E06C75"> listeners</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                            ApplicationArguments</span><span style="color:#E06C75"> applicationArguments</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                            Banner</span><span style="color:#E06C75"> printedBanner) {</span></span>
<span class="line"><span style="color:#E5C07B">    context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setEnvironment</span><span style="color:#ABB2BF">(environment);</span></span>
<span class="line"><span style="color:#61AFEF">    postProcessApplicationContext</span><span style="color:#E06C75">(context)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    addAotGeneratedInitializerIfNecessary</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">initializers</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 执行时机</span></span>
<span class="line"><span style="color:#61AFEF">    applyInitializers</span><span style="color:#E06C75">(context)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    listeners</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contextPrepared</span><span style="color:#ABB2BF">(context);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="1-4-内置实现"><a class="header-anchor" href="#1-4-内置实现"></a>1.4 内置实现</h2>
<blockquote>
<p><code>DelegatingApplicationContextInitializer</code></p>
</blockquote>
<p>实例化 <code>ApplicationContextInitializer</code> 时，是通过 <code>SpringFactoriesLoader.loadFactoryNames()</code> 方法获取 <code>META-INF/spring.factories</code> 文件中的实现类信息，而配置文件中的实现类信息是通过 <code>DelegatingApplicationContextInitializer</code> 得到的。</p>
<p>该实现类信息被 SpringBoot 默认添加到 <code>META-INF/spring.factories</code> 文件中，因此能够直接获取到其实例。</p>
<p>而后在执行 <code>DelegatingApplicationContextInitializer</code> 的 <code>initialize()</code> 方法时，获取配置文件中的 <code>ApplicationContextInitializer</code> 实现类信息，构造它们的实例并执行 <code>initialize()</code> 方法。</p>
<blockquote>
<p><code>ContextIdApplicationContextInitializer</code></p>
</blockquote>
<p>该实现类用于设置应用上下文 ID，如果配置文件中未显示指定 <code>spring.application.name</code> 的值，那么默认的应用上下文 ID 为 <code>application</code>。</p>
<blockquote>
<p>其他内置实现</p>
</blockquote>
<ul>
<li>
<p><code>ConfigurationWarningsApplicationContextInitializer</code>：添加后置处理器 <code>ConfigurationWarningsPostProcessor</code> 到 Spring 容器中，用于打印添加 Bean 时产生的警告信息；</p>
</li>
<li>
<p><code>ServerPortInfoApplicationContextInitializer</code>：该实现类也实现了 <code>ApplicationListener</code> 接口，其 <code>initialize()</code> 方法就是将自身添加到 Spring 容器中，用于监听 <code>WebServerInitializedEvent</code>；</p>
</li>
<li>
<p>还有一些其他内置实现，其功能要么是添加后置处理器、要么是添加监听器，作用都大差不差。</p>
</li>
</ul>
<h1 id="2-Bean-工厂后置处理器"><a class="header-anchor" href="#2-Bean-工厂后置处理器"></a>2. Bean 工厂后置处理器</h1>
<h2 id="2-1-拓展点的作用"><a class="header-anchor" href="#2-1-拓展点的作用"></a>2.1 拓展点的作用</h2>
<p>Bean 工厂后置处理器，即：<code>BeanFactoryPostProcessor</code>，它也并非 SpringBoot 提供，而是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">FunctionalInterface</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    void</span><span style="color:#61AFEF"> postProcessBeanFactory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#E06C75;font-style:italic"> beanFactory</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 Spring 生命周期内，<code>BeanFactoryPostProcessor</code> 实例的 <code>postProcessBeanFactory()</code> 方法 <strong>只会</strong> 执行一次；在容器读取到所有的 <code>BeanDefinition</code> 后，但 Bean 尚未初始化前，读取 <code>BeanDefinition</code> 信息，对其中的属性进行修改或添加。</p>
<p><strong><code>BeanFactoryPostProcessor</code> 接口常用于修改应用程序上下文中系统管理员的自定义配置文件绑定的 Bean 属性信息，比如在读取配置文件中加密的敏感信息时，对这些信息进行解密。</strong></p>
<h2 id="2-2-使用方式"><a class="header-anchor" href="#2-2-使用方式"></a>2.2 使用方式</h2>
<p>实现 <code>BeanFactoryPostProcessor</code> 接口，重写 <code>postProcessBeanFactory()</code> 方法，并 <strong>将实现类交由 Spring 管理。</strong></p>
<p><code>postProcessBeanFactory()</code> 方法的执行时机实在 Spring 容器读取到所有 <code>BeanDefinition</code> 后，因此将实现类交由 Spring 管理即可在对应时机执行 <code>postProcessBeanFactory()</code> 方法。</p>
<p>比如容器中已经存在名为 <code>dog</code> 的 Bean：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(</span><span style="color:#98C379">"dog"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Dog</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "旺财"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Integer</span><span style="color:#E06C75"> age </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 2</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>现在需要修改该 Bean 的 <code>name</code> 信息，就需要使用到 <code>BeanFactoryPostProcessor</code> 接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanFactoryPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> postProcessBeanFactory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#E06C75;font-style:italic"> beanFactory</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ScannedGenericBeanDefinition</span><span style="color:#E06C75"> definition</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (ScannedGenericBeanDefinition) </span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"dog"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        MutablePropertyValues</span><span style="color:#E06C75"> properties</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPropertyValues</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"name"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"小黑"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A02ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A02ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        Dog</span><span style="color:#E06C75"> dog</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Dog</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">dog</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">dog</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAge</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>小黑
2
</pre>
<h2 id="2-3-执行入口"><a class="header-anchor" href="#2-3-执行入口"></a>2.3 执行入口</h2>
<p>还是从调用 <code>SpringApplication</code> 对象的 <code>run()</code> 方法入手：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> ConfigurableApplicationContext</span><span style="color:#61AFEF"> run</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">...</span><span style="color:#E5C07B"> args</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#61AFEF">        prepareContext</span><span style="color:#E06C75">(bootstrapContext</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> environment</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E06C75">                       listeners</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> applicationArguments</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> printedBanner)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 在这个方法里执行</span></span>
<span class="line"><span style="color:#61AFEF">        refreshContext</span><span style="color:#E06C75">(context)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">        afterRefresh</span><span style="color:#E06C75">(context</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> applicationArguments)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> refreshContext</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ConfigurableApplicationContext</span><span style="color:#E06C75"> context) {</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">registerShutdownHook</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        shutdownHook</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerApplicationContext</span><span style="color:#ABB2BF">(context);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 继续调用 refresh() 方法</span></span>
<span class="line"><span style="color:#61AFEF">    refresh</span><span style="color:#E06C75">(context)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> refresh</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ConfigurableApplicationContext</span><span style="color:#E06C75"> applicationContext) {   </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 调用 applicationContext 的 refresh() 方法</span></span>
<span class="line"><span style="color:#E5C07B">    applicationContext</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">refresh</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>ConfigurableApplicationContext</code> 有三种实现类，但直接的实现类只有 <code>AbstractApplicationContext</code> 一种，另外两种实现类又会继承 <code>AbstractApplicationContext</code>，因此重点分析 <code>AbstractApplicationContext#refresh()</code> 方法。</p>
<p><mark><code>AbstractApplicationContext#refresh()</code> 方法很重要，后续还会讲到。</mark></p>
<p>在 <code>refresh()</code> 方法中调用了 <code>invokeBeanFactoryPostProcessors()</code> 方法，也是在这个方法中完成对所有 <code>BeanFactoryPostProcessor</code> 实例的 <code>postProcessBeanFactory()</code> 方法的调用。</p>
<p><code>invokeBeanFactoryPostProcessors()</code> 方法只是一个入口，真正的实现是：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">support</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">PostProcessorRegistrationDelegate</span><span style="color:#E06C75">#</span><span style="color:#61AFEF">invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beans</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factory</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">config</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> java</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">util</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">List</span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B">org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beans</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factory</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">config</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">)</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这个方法除了接收 <code>ConfigurableListableBeanFactory</code> 对象外，还接收了 <code>BeanFactoryPostProcessor</code> 实例列表。</p>
<h2 id="2-4-第二个参数的来源"><a class="header-anchor" href="#2-4-第二个参数的来源"></a>2.4 第二个参数的来源</h2>
<p><code>BeanFactoryPostProcessor</code> 实例列表是从哪来的呢？</p>
<p><code>BeanFactoryPostProcessor</code> 实例不应该直接从 BeanFactory 中获取吗？这里传入的又是什么呢？</p>
<p>传入的 <code>BeanFactoryPostProcessor</code> 实例列表是 <code>AbstractApplicationContext</code> 中的一个成员变量 <code>beanFactoryPostProcessors</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> beanFactoryPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>提供了通过 <code>addBeanFactoryPostProcessor()</code> 方法作为修改的方式：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> addBeanFactoryPostProcessor</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#E06C75"> postProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B">   Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">notNull</span><span style="color:#ABB2BF">(postProcessor, </span><span style="color:#98C379">"BeanFactoryPostProcessor must not be null"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">   this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanFactoryPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(postProcessor);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>调用该方法的地方共有两处：</p>
<ul>
<li><code>org.springframework.boot.SpringApplication#prepareContext()</code></li>
<li><code>org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer#initialize()</code></li>
</ul>
<p>前者会在 <code>SpringApplication#run()</code> 方法中、在 <code>refreshContext()</code> 方法调用前被调用，因此在执行 <code>refresh()</code> 方法时能够拿到添加的 <code>BeanFactoryPostProcessor</code> 实例；后者的 <code>ConfigurationWarningsApplicationContextInitializer</code> 是先前介绍的 <code>ApplicationContextInitializer</code> 的一个实现类，其 <code>initialize()</code> 方法会在 <code>prepareContext()</code> 方法中被调用，也能够在后续执行时拿到被添加的 <code>BeanFactoryPostProcessor</code> 实例。</p>
<h2 id="2-5-执行的逻辑"><a class="header-anchor" href="#2-5-执行的逻辑"></a>2.5 执行的逻辑</h2>
<p>又回到 <code>PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> 方法，源码里先是一大段注释，简单来说就是 <strong>不要瞎重构这个方法来减少多个循环和多个列表的使用</strong>，因为那是故意为之的，具体来说是不能通过调用 <code>getBean()</code> 方法获取某些 <code>BeanFactoryPostProcessor</code>，这会到导致 <code>BeanFactoryPostProcessor</code> 提前被实例化，或者以错误的顺序在 ApplicationContext 中注册 <code>BeanFactoryPostProcessor</code>，最后甚至还给出了「<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22">耻辱墙</a>」，里面过滤出所有被拒绝的相关 PR。😂</p>
<p>源码中充满了注释，像极了工作中写满注释不让同事乱动的样子。🤣</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">    ConfigurableListableBeanFactory</span><span style="color:#E06C75"> beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> List</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">BeanFactoryPostProcessor</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanFactoryPostProcessors) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 首先执行 BeanDefinitionRegistryPostProcessors，如果有。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // processedBeans 里存储了已经处理过的 Bean 的 name</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> processedBeans </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> HashSet</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 判断 beanFactory 是否是 BeanDefinitionRegistry，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 通常是 DefaultListableBeanFactory，因此满足条件</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (beanFactory </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> BeanDefinitionRegistry</span><span style="color:#E06C75"> registry) {</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> regularPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // BeanDefinitionRegistryPostProcessor 是 BeanFactoryPostProcessor 的子类</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> registryProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 对直接传入的 BeanFactoryPostProcessor 进行分类并执行</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#E06C75"> postProcessor </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> beanFactoryPostProcessors) {</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (postProcessor </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> BeanDefinitionRegistryPostProcessor</span><span style="color:#E06C75"> registryProcessor) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 直接执行 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#E5C07B">                registryProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">postProcessBeanDefinitionRegistry</span><span style="color:#ABB2BF">(registry);</span></span>
<span class="line"><span style="color:#E5C07B">                registryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(registryProcessor);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">                regularPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(postProcessor);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 不初始化 FactoryBeans，需要保证所有常规 Bean 未被初始化，以便让</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // BeanFactoryPostProcessor 处理他们。将 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 分成三类，分别是实现了 PriorityOrdered、实现了 Ordered 和其他的。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 这里分类的是 BeanFactory 中的 BeanDefinitionRegistryPostProcessor</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> currentRegistryProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 首先执行实现了 PriorityOrdered 的 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75">[] postProcessorNames </span><span style="color:#56B6C2">=</span></span>
<span class="line"><span style="color:#E5C07B">            beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanNamesForType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">PriorityOrdered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                currentRegistryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">                processedBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 排个序</span></span>
<span class="line"><span style="color:#61AFEF">        sortPostProcessors</span><span style="color:#E06C75">(currentRegistryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 放到存放 BeanDefinitionRegistryPostProcessor 的总集合里</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 里面不仅有 BeanFactory 中的，还有直接传入的</span></span>
<span class="line"><span style="color:#E5C07B">        registryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addAll</span><span style="color:#ABB2BF">(currentRegistryProcessors);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 执行</span></span>
<span class="line"><span style="color:#61AFEF">        invokeBeanDefinitionRegistryPostProcessors</span><span style="color:#E06C75">(currentRegistryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> registry</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getApplicationStartup</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 清空下，方便后续使用</span></span>
<span class="line"><span style="color:#E5C07B">        currentRegistryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 接下来执行实现了 Ordered 的 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#E06C75">        postProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanNamesForType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">processedBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(ppName)</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">Ordered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                currentRegistryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">                processedBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#61AFEF">        sortPostProcessors</span><span style="color:#E06C75">(currentRegistryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        registryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addAll</span><span style="color:#ABB2BF">(currentRegistryProcessors);</span></span>
<span class="line"><span style="color:#61AFEF">        invokeBeanDefinitionRegistryPostProcessors</span><span style="color:#E06C75">(currentRegistryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> registry</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getApplicationStartup</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        currentRegistryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 前面在执行 BeanDefinitionRegistryPostProcessors、或者后续执行其他的</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // BeanDefinitionRegistryPostProcessors 时，可能会一些添加 </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // BeanDefinitionRegistryPostProcessors 的 BeanDefinition，因此要不断执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // BeanDefinitionRegistryPostProcessors，直到不再出现其他处理器为止</span></span>
<span class="line"><span style="color:#C678DD">        boolean</span><span style="color:#E06C75"> reiterate </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        while</span><span style="color:#E06C75"> (reiterate) {</span></span>
<span class="line"><span style="color:#E06C75">            reiterate </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            postProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanNamesForType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">            for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">processedBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(ppName)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                    currentRegistryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">                    processedBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">                    reiterate </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#61AFEF">            sortPostProcessors</span><span style="color:#E06C75">(currentRegistryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">            registryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addAll</span><span style="color:#ABB2BF">(currentRegistryProcessors);</span></span>
<span class="line"><span style="color:#61AFEF">            invokeBeanDefinitionRegistryPostProcessors</span><span style="color:#E06C75">(currentRegistryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> registry</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getApplicationStartup</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">            currentRegistryProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 前面已经把 BeanDefinitionRegistryPostProcessors 执行了</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 接下来执行每个 BeanFactoryPostProcessor，也是先执行 BeanDefinitionRegistryPostProcessors</span></span>
<span class="line"><span style="color:#61AFEF">        invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(registryProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">        invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(regularPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 调用在上下文实例中注册的 BeanFactoryPostProcessor，也就是直接传进来的</span></span>
<span class="line"><span style="color:#61AFEF">        invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(beanFactoryPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 这里也不初始化 FactoryBeans，要保证所有的常规 Bean 未被初始化，以便让 BeanFactoryPostProcessor 处理他们</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] postProcessorNames </span><span style="color:#56B6C2">=</span></span>
<span class="line"><span style="color:#E5C07B">        beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanNamesForType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 接下来同样是分类，将 BeanFactoryPostProcessors 分成三类，分别是实现了 PriorityOrdered、</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 实现了 Ordered 和其他的。</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> priorityOrderedPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> orderedPostProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> nonOrderedPostProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">processedBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(ppName)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 在前面处理过的，直接跳过</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">PriorityOrdered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            priorityOrderedPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">Ordered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 这里没有直接通过 getBean() 获取，因为 getBean() 会导致 Bean 提前初始化</span></span>
<span class="line"><span style="color:#E5C07B">            orderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">            nonOrderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 首先执行实现了 PriorityOrdered 的 BeanFactoryPostProcessors</span></span>
<span class="line"><span style="color:#61AFEF">    sortPostProcessors</span><span style="color:#E06C75">(priorityOrderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(priorityOrderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 接下来执行实现了 Ordered 的 BeanFactoryPostProcessors</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> orderedPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">orderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> postProcessorName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        orderedPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(postProcessorName, </span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#61AFEF">    sortPostProcessors</span><span style="color:#E06C75">(orderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(orderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 最后执行其他的 BeanFactoryPostProcessors</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> nonOrderedPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">nonOrderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> postProcessorName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        nonOrderedPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(postProcessorName, </span><span style="color:#E5C07B">BeanFactoryPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#61AFEF">    invokeBeanFactoryPostProcessors</span><span style="color:#E06C75">(nonOrderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 清除合并的 BeanDefinition，因为后置处理器中可能已经修改了原始元数据，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 比如替换 value 中的占位符</span></span>
<span class="line"><span style="color:#E5C07B">    beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clearMetadataCache</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors()</code> 方法不仅处理了 <code>BeanFactoryPostProcessor</code>，还处理了 <code>BeanDefinitionRegistryPostProcessor</code>，后者被称为「Bean 定义注册表后置处理器」，是一种容器级的后置处理器，那它又是什么呢？</p>
<h1 id="3-Bean-定义注册表后置处理器"><a class="header-anchor" href="#3-Bean-定义注册表后置处理器"></a>3. Bean 定义注册表后置处理器</h1>
<h2 id="3-1-拓展点的作用"><a class="header-anchor" href="#3-1-拓展点的作用"></a>3.1 拓展点的作用</h2>
<p>Bean 定义注册表后置处理器，即：<code>BeanDefinitionRegistryPostProcessor</code>，它同样并非 SpringBoot 提供，也是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> BeanDefinitionRegistryPostProcessor</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> postProcessBeanDefinitionRegistry</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanDefinitionRegistry</span><span style="color:#E06C75;font-style:italic"> registry</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>它是容器级别的后置处理器，将在 Spring 容器初始化后、<code>refresh</code> 前（即 Bean 被抽象成 <code>BeanDefinition</code> 后、未实例化前）执行。</p>
<p>提供了 <code>postProcessBeanDefinitionRegistry()</code> 方法，使用 <code>BeanDefinitionRegistry</code> 能够对 BeanDefinition 进行增删改查。</p>
<p>该接口继承了 <code>BeanFactoryPostProcessor</code> 接口，是它的一个拓展，通过前文的介绍可知它们都是在同一个方法中被执行的，只不过 <code>BeanDefinitionRegistryPostProcessor</code> 较 <code>BeanFactoryPostProcessor</code> <strong>更先</strong> 执行，因此 <strong>可以使用 <code>BeanDefinitionRegistryPostProcessor</code> 可以用来注册 <code>BeanFactoryPostProcessor</code> 的 BeanDefinition</strong>。</p>
<h2 id="3-2-使用方式"><a class="header-anchor" href="#3-2-使用方式"></a>3.2 使用方式</h2>
<p>实现 <code>BeanDefinitionRegistryPostProcessor</code> 接口，重写 <code>postProcessBeanDefinitionRegistry()</code> 方法，并 <strong>将实现类交由 Spring 管理。</strong></p>
<p>比如存在 <code>Cat</code> 类，它并未交由 Spring 管理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Cat</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写实现类，实现 <code>BeanDefinitionRegistryPostProcessor</code> 接口，尝试注册 <code>Cat</code> 类型的 BeanDefinition：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanDefinitionRegistryPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanDefinitionRegistryPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> postProcessBeanDefinitionRegistry</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanDefinitionRegistry</span><span style="color:#E06C75;font-style:italic"> beanDefinitionRegistry</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        RootBeanDefinition</span><span style="color:#E06C75"> beanDefinition</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> RootBeanDefinition</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        beanDefinition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setBeanClass</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Cat</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        PropertyValue</span><span style="color:#E06C75"> name</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> PropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"name"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"大橘"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        PropertyValue</span><span style="color:#E06C75"> age</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> PropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"age"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        MutablePropertyValues</span><span style="color:#E06C75"> propertyValues</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> MutablePropertyValues</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(name, age));</span></span>
<span class="line"><span style="color:#E5C07B">        beanDefinition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setPropertyValues</span><span style="color:#ABB2BF">(propertyValues);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 手动注册</span></span>
<span class="line"><span style="color:#E5C07B">        beanDefinitionRegistry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"cat"</span><span style="color:#ABB2BF">, beanDefinition);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> postProcessBeanFactory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#E06C75;font-style:italic"> beanFactory</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        RootBeanDefinition</span><span style="color:#E06C75"> beanDefinition</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (RootBeanDefinition) </span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"cat"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        MutablePropertyValues</span><span style="color:#E06C75"> propertyValues</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> beanDefinition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPropertyValues</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"原始年龄是: "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> propertyValues</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"age"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 添加名为 age 的 property，但已经存在同名的 property，会以新加的为准</span></span>
<span class="line"><span style="color:#E5C07B">        propertyValues</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"age"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在重写的 <code>postProcessBeanDefinitionRegistry()</code> 方法中手动注册 <code>Cat</code> 类型、名为 <code>cat</code> 的 BeanDefinition，并添加了名为 <code>age</code> 的 property；在重写的 <code>postProcessBeanFactory()</code> 方法中获取名为 <code>cat</code> 的 BeanDefinition，然后添加同名的 property，新值将覆盖旧值。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A03ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A03ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        Cat</span><span style="color:#E06C75"> cat</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Cat</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">cat</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">cat</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAge</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>原始年龄是: 1
大橘
2
</pre>
<h2 id="3-3-相关的几个类"><a class="header-anchor" href="#3-3-相关的几个类"></a>3.3 相关的几个类</h2>
<p><code>BeanDefinition</code> 是什么？</p>
<p><code>postProcessBeanDefinitionRegistry()</code> 方法的入参 <code>BeanDefinitionRegistry</code> 是什么？</p>
<p><code>postProcessBeanFactory()</code> 方法的入参 <code>ConfigurableListableBeanFactory</code> 又是什么？</p>
<p>理解这些类的含义有助于更好地理解 Spring 拓展点。</p>
<blockquote>
<p><code>BeanDefinition</code></p>
</blockquote>
<p><code>BeanDefinition</code> 意为「Bean 定义」，是用来定义 Bean 的。</p>
<p>Spring 容器中 Bean 的来源有多种，Bean 的类型又有多种，如何将这些不同来源、不同类型的 Bean 使用同一种方式注册到 Spring 容器中就成了个问题。</p>
<p>定义 <code>BeanDefinition</code> 类，它将不同的 Bean 信息进行抽象成 <code>BeanDefinition</code> 对象，在不同时机根据 <code>BeanDefinition</code> 对象对 Bean 进行实例化。</p>
<blockquote>
<p><code>BeanDefinitionRegistry</code></p>
</blockquote>
<p><code>BeanDefinitionRegistry</code> 意为「Bean 定义注册器」，是用来注册 <code>BeanDefinition</code> 的。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> BeanDefinitionRegistry</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> AliasRegistry</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 注册 BeanDefinition</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> registerBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">BeanDefinition</span><span style="color:#E06C75;font-style:italic"> beanDefinition</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">         throws</span><span style="color:#E5C07B"> BeanDefinitionStoreException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 删除 BeanDefinition</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> removeBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> NoSuchBeanDefinitionException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 获取 BeanDefinition</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#E5C07B">   BeanDefinition</span><span style="color:#61AFEF"> getBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> NoSuchBeanDefinitionException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 判断指定名称的 BeanDefinition 是否已经被注册</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   boolean</span><span style="color:#61AFEF"> containsBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 获取所有 BeanDefinition 的名称</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#E5C07B">   String</span><span style="color:#61AFEF">[] getBeanDefinitionNames</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 注册的 BeanDefinition 的数量</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   int</span><span style="color:#61AFEF"> getBeanDefinitionCount</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 确定给定的 Bean 名称是否已在注册器中使用，即是否有本地 Bean 或别名在此名称下注册。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   boolean</span><span style="color:#61AFEF"> isBeanNameInUse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>AliasRegistry</code> 用于管理别名，作为 <code>BeanDefinitionRegistry</code> 的父类。</p>
<blockquote>
<p><code>ConfigurableListableBeanFactory</code></p>
</blockquote>
<p><code>ConfigurableListableBeanFactory</code> 意为「可配置的列表 Bean 工厂」。所谓 Spring 容器，指的就是 <code>BeanFactory</code>，它提供了多种重载的 <code>getBean()</code> 方法用于获取 Bean，而 <code>ConfigurableListableBeanFactory</code> 是 <code>BeanFactory</code> 的一个子接口，可以认为它就是 Spring 容器。</p>
<p>在 Spring 中，其默认实现是 <code>DefaultListableBeanFactory</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/DefaultListableBeanFactory%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="DefaultListableBeanFactory的类图"></p>
<p>它继承了很多接口，包括 <code>ConfigurableListableBeanFactory</code>、<code>BeanDefinitionRegistry</code> 等等。</p>
<h2 id="3-4-实例化与执行"><a class="header-anchor" href="#3-4-实例化与执行"></a>3.4 实例化与执行</h2>
<p>参考【2.3 实例化与执行】即可。</p>
<h2 id="3-5-内置实现"><a class="header-anchor" href="#3-5-内置实现"></a>3.5 内置实现</h2>
<p><code>BeanDefinitionRegistryPostProcessor</code> 在 Spring 和 SpringBoot 中有众多内置实现，它们的大致逻辑都差不多，都是注册了一些特殊的 <code>BeanDefinition</code>。</p>
<p>在 Spring 中有一个名为 <code>ConfigurationClassPostProcessor</code> 的实现类，用于解析 <code>@Configuration</code> 注解，可以参考 <a href="../Configuration-Annotation/">@Configuration 注解的那些事</a> 一文。</p>
<h1 id="4-Bean-后置处理器"><a class="header-anchor" href="#4-Bean-后置处理器"></a>4. Bean 后置处理器</h1>
<h2 id="4-1-拓展点的作用"><a class="header-anchor" href="#4-1-拓展点的作用"></a>4.1 拓展点的作用</h2>
<p>Bean 后置处理器，即：<code>BeanPostProcessor</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 初始化前执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">   @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 初始化后执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">   @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>它是 Bean 级别的后置处理器，在 Bean 实例化后执行。单例 Bean 被实例化后，最终会被缓存到 <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#singletonObjects</code> 中，在实例化之后会进行初始化过程，包括属性填充、自定义初始化方法等，<code>BeanPostProcessor</code> 就是对这个阶段进行的拓展。</p>
<p>注意实例化和初始化的区别，实例化指的是 <code>new</code> 出一个对象，初始化指的是给 <code>new</code> 出的对象进行属性填充等操作。</p>
<p><code>BeanPostProcessor</code> 提供了两个方法，分别是 <code>postProcessBeforeInitialization()</code> 和 <code>postProcessAfterInitialization()</code>，前者将在 Bean 实例化后、初始化前执行，后者将在初始化后、自定义初始方法后执行。</p>
<p><code>BeanPostProcessor</code> 与先前的所有拓展点都不同，并不是只执行一次，而是会作用于 Spring 管理的每个 Bean。</p>
<h2 id="4-2-使用方式"><a class="header-anchor" href="#4-2-使用方式"></a>4.2 使用方式</h2>
<p>实现 <code>BeanPostProcessor</code> 接口，重写抽象方法，并 <strong>将实现类交由 Spring 管理。</strong></p>
<p>比如存在 <code>Fish</code> 类，采用配置类的方式将其交由 Spring 管理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Fish</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> InitializingBean</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Double</span><span style="color:#E06C75"> weight</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Double</span><span style="color:#E06C75"> price</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Fish</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. 执行了无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> afterPropertiesSet</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3. 执行了 afterPropertiesSet() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> init</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"4. 执行了 init() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A04Configuration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "fish"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> initMethod</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "init"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Fish</span><span style="color:#61AFEF"> fish</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Fish</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写 <code>BeanPostProcessor</code> 的实现类，重写其中的抽象方法，当遇到名为 <code>fish</code> 的 Bean 时，执行一些特殊操作：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#98C379">"fish"</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. 执行了 postProcessBeforeInitialization() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#98C379">"fish"</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"5. 执行了 postProcessAfterInitialization() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A04ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A04ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. 执行了无参构造
2. 执行了 postProcessBeforeInitialization() 方法
3. 执行了 afterPropertiesSet() 方法
4. 执行了 init() 方法
5. 执行了 postProcessAfterInitialization() 方法
</pre>
<h2 id="4-3-注册与执行"><a class="header-anchor" href="#4-3-注册与执行"></a>4.3 注册与执行</h2>
<p>前文中已经介绍过 <code>AbstractApplicationContext#refresh()</code> 方法了，<code>BeanPostProcessor</code> 的注册与执行也将围绕这个方法。</p>
<blockquote>
<p>注册</p>
</blockquote>
<p>在 <code>AbstractApplicationContext#refresh()</code> 方法中调用了 <code>registerBeanPostProcessors()</code> 方法，见名之意，该方法完成了 <code>BeanPostProcessor</code> 的注册。</p>
<p>它只是一个入口，真正的实现是：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">support</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">PostProcessorRegistrationDelegate</span><span style="color:#E06C75">#</span><span style="color:#61AFEF">registerBeanPostProcessors</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beans</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factory</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">config</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">support</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">AbstractApplicationContext</span><span style="color:#E06C75">)</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>PostProcessorRegistrationDelegate</code> 很熟悉，<code>BeanFactoryPostProcessor</code> 与 <code>BeanDefinitionRegistryPostProcessor</code> 的执行也是使用的这个类中的方法。</p>
<p><code>registerBeanPostProcessors()</code> 与前文介绍的 <code>invokeBeanFactoryPostProcessors()</code> 方法很类似，内部充满了注释，也告诉想要提交 PR 的开发者不要瞎重构。😂</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerBeanPostProcessors</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableListableBeanFactory</span><span style="color:#E06C75"> beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> AbstractApplicationContext</span><span style="color:#E06C75"> applicationContext) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 首先获取所有 BeanPostProcessor 在 Spring 容器中的名称</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] postProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanNamesForType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 注册 BeanPostProcessorChecker，当一个 Bean 在 BeanPostProcessor 实例化过程</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 中被创建时，即一个 Bean 不符合所有 BeanPostProcessor 的处理条件时，会记录一条日志</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 简单来说就是注册 BeanPostProcessorChecker 用来打印日志</span></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> beanProcessorTargetCount </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanPostProcessorCount</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> +</span><span style="color:#D19A66"> 1</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> postProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addBeanPostProcessor</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> BeanPostProcessorChecker</span><span style="color:#ABB2BF">(beanFactory, beanProcessorTargetCount));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将 BeanPostProcessor 分为三类，分别是实现了 PriorityOrdered、实现了</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Ordered 和其他的</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> priorityOrderedPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 存放 MergedBeanDefinitionPostProcessor，它是 BeanPostProcessor 的一个子类</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> internalPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> orderedPostProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> nonOrderedPostProcessorNames </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> postProcessorNames) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">PriorityOrdered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            BeanPostProcessor</span><span style="color:#E06C75"> pp </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            priorityOrderedPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pp);</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (pp </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B">                internalPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pp);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">Ordered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            orderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">            nonOrderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(ppName);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 首先注册实现了 PriorityOrdered 的 BeanPostProcessors</span></span>
<span class="line"><span style="color:#61AFEF">    sortPostProcessors</span><span style="color:#E06C75">(priorityOrderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    registerBeanPostProcessors</span><span style="color:#E06C75">(beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> priorityOrderedPostProcessors)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 接下来注册实现了 Ordered 的 BeanPostProcessors</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> orderedPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">orderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> orderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        BeanPostProcessor</span><span style="color:#E06C75"> pp </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        orderedPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pp);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (pp </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B">            internalPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pp);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#61AFEF">    sortPostProcessors</span><span style="color:#E06C75">(orderedPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    registerBeanPostProcessors</span><span style="color:#E06C75">(beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> orderedPostProcessors)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 然后执行所有常规的 BeanPostProcessors.</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> nonOrderedPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">nonOrderedPostProcessorNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> ppName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> nonOrderedPostProcessorNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        BeanPostProcessor</span><span style="color:#E06C75"> pp </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(ppName, </span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        nonOrderedPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pp);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (pp </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> MergedBeanDefinitionPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B">            internalPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pp);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#61AFEF">    registerBeanPostProcessors</span><span style="color:#E06C75">(beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> nonOrderedPostProcessors)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 最后，重新注册所有内部 BeanPostProcessors</span></span>
<span class="line"><span style="color:#61AFEF">    sortPostProcessors</span><span style="color:#E06C75">(internalPostProcessors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanFactory)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">    registerBeanPostProcessors</span><span style="color:#E06C75">(beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> internalPostProcessors)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 重新注册后置处理器，以便将内部 Bean 检测为 ApplicationListeners，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将其移到处理器链的末端（用于拾取代理等）。</span></span>
<span class="line"><span style="color:#E5C07B">    beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addBeanPostProcessor</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> ApplicationListenerDetector</span><span style="color:#ABB2BF">(applicationContext));</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>简单来说就是先获取容器中的所有 <code>BeanPostProcessor</code>，然后按照优先级分成三类再依次注册。</p>
<p>注册的逻辑采用 <code>registerBeanPostProcessors()</code> 方法实现：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerBeanPostProcessors</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">    ConfigurableListableBeanFactory</span><span style="color:#E06C75"> beanFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#E06C75"> extends BeanPostProcessor</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> postProcessors) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (beanFactory </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> AbstractBeanFactory</span><span style="color:#E06C75"> abstractBeanFactory) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Bulk addition is more efficient against our CopyOnWriteArrayList there</span></span>
<span class="line"><span style="color:#E5C07B">        abstractBeanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addBeanPostProcessors</span><span style="color:#ABB2BF">(postProcessors);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#E06C75"> postProcessor </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> postProcessors) {</span></span>
<span class="line"><span style="color:#E5C07B">            beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addBeanPostProcessor</span><span style="color:#ABB2BF">(postProcessor);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>调用 <code>beanFactory</code> 的 <code>addBeanPostProcessor()</code> 方法完成 <code>BeanPostProcessor</code> 的注册，最终由 <code>AbstractBeanFactory#addBeanPostProcessor()</code> 实现真正的逻辑：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> beanPostProcessors </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanPostProcessorCacheAwareList</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> addBeanPostProcessor</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#E06C75"> beanPostProcessor) {</span></span>
<span class="line"><span style="color:#E5C07B">   Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">notNull</span><span style="color:#ABB2BF">(beanPostProcessor, </span><span style="color:#98C379">"BeanPostProcessor must not be null"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">   synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanPostProcessors</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // Remove from old position, if any</span></span>
<span class="line"><span style="color:#E5C07B">      this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanPostProcessor);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // Add to end of list</span></span>
<span class="line"><span style="color:#E5C07B">      this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanPostProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(beanPostProcessor);</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>执行</p>
</blockquote>
<p><code>BeanPostProcessor</code> 将在 Bean 实例化后，初始化前后执行，也就是说只要找到 Bean 实例化的位置，那 <code>BeanPostProcessor</code> 的执行时机也就在那附近了。</p>
<p>在 <code>refresh()</code> 方法中调用了 <code>finishBeanFactoryInitialization()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">// Instantiate all remaining (non-lazy-init) singletons.</span></span>
<span class="line"><span style="color:#61AFEF">finishBeanFactoryInitialization</span><span style="color:#E06C75">(beanFactory)</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其上的注释：实例化所有剩余的非懒加载单例 Bean。</p>
<p>也就是说，这个方法将完成 Bean 的实例化。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> finishBeanFactoryInitialization</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#E06C75"> beanFactory) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 初始化上下文的 conversion service</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">containsBean</span><span style="color:#ABB2BF">(CONVERSION_SERVICE_BEAN_NAME)</span><span style="color:#56B6C2"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E5C07B">        beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTypeMatch</span><span style="color:#ABB2BF">(CONVERSION_SERVICE_BEAN_NAME, </span><span style="color:#E5C07B">ConversionService</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setConversionService</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E5C07B">            beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(CONVERSION_SERVICE_BEAN_NAME, </span><span style="color:#E5C07B">ConversionService</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果之前没有注册任何 BeanFactoryPostProcessor，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 比如 PropertySourcesPlaceholderConfigurer，那么注册默认的</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 嵌入值解析器用于注解属性值的解析</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasEmbeddedValueResolver</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addEmbeddedValueResolver</span><span style="color:#ABB2BF">(strVal </span><span style="color:#C678DD">-&gt;</span><span style="color:#61AFEF"> getEnvironment</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">resolvePlaceholders</span><span style="color:#ABB2BF">(strVal));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 尽早初始化 LoadTimeWeaverAware 以便尽早注册它们的转换器</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] weaverAwareNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanNamesForType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">LoadTimeWeaverAware</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> weaverAwareName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> weaverAwareNames) {</span></span>
<span class="line"><span style="color:#61AFEF">        getBean</span><span style="color:#E06C75">(weaverAwareName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 停止使用临时 ClassLoader 进行类型匹配</span></span>
<span class="line"><span style="color:#E5C07B">    beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setTempClassLoader</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 允许缓存所有 BeanDefinition 元数据，不期待进一步更改</span></span>
<span class="line"><span style="color:#E5C07B">    beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">freezeConfiguration</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 实例化所有剩余的非懒加载单例 Bean</span></span>
<span class="line"><span style="color:#E5C07B">    beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">preInstantiateSingletons</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>显然，重点是最后调用 <code>beanFactory</code> 的 <code>preInstantiateSingletons()</code> 方法。</p>
<p>其默认实现是 <code>DefaultListableBeanFactory</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> preInstantiateSingletons</span><span style="color:#E06C75">() throws BeansException {</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTraceEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Pre-instantiating singletons in "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 对 copy 副本进行遍历，以允许 init 方法反过来注册新的 BeanDefinition</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 虽然这可能不是常规工厂启动的一部分，但在其他方面运行良好</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> beanNames </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanDefinitionNames</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 触发所有非懒加载单例 Bean 的初始化</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> beanNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        RootBeanDefinition</span><span style="color:#E06C75"> bd </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getMergedLocalBeanDefinition</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">bd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isAbstract</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> bd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">bd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isLazyInit</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">isFactoryBean</span><span style="color:#E06C75">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">                Object</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getBean</span><span style="color:#E06C75">(FACTORY_BEAN_PREFIX </span><span style="color:#56B6C2">+</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> SmartFactoryBean</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> smartFactoryBean </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#E5C07B"> smartFactoryBean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEagerInit</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#61AFEF">                    getBean</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#61AFEF">                getBean</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 为所有适用的 Bean 触发后置初始化回调</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> beanNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> singletonInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getSingleton</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (singletonInstance </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> SmartInitializingSingleton</span><span style="color:#E06C75"> smartSingleton) {</span></span>
<span class="line"><span style="color:#E5C07B">            StartupStep</span><span style="color:#E06C75"> smartInitialize </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getApplicationStartup</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">start</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"spring.beans.smart-initialize"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">tag</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"beanName"</span><span style="color:#ABB2BF">, beanName);</span></span>
<span class="line"><span style="color:#E5C07B">            smartSingleton</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">afterSingletonsInstantiated</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            smartInitialize</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">end</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>总体来说分成两部分：</p>
<ol>
<li>触发所有非懒加载单例 Bean 的初始化，使用 <code>getBean()</code> 实现</li>
<li>为所有适用的 Bean 触发后置初始化回调，即调用 <code>SmartInitializingSingleton</code> 的 <code>afterSingletonsInstantiated()</code> 方法（这个拓展点在后续会讲到）</li>
</ol>
<p><code>getBean()</code> 的流程很长，也不是本文的重点， <strong>后续另开一文详细分析，</strong> 此处仅着重分析要点：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> name) throws BeansException {</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#61AFEF"> doGetBean</span><span style="color:#E06C75">(name</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> false</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>调用了 <code>doGetBean()</code> 方法，这个方法贼长，重点是调用的 <code>createBean()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#56B6C2"> &lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> T</span><span style="color:#61AFEF"> doGetBean</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> requiredType</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> typeCheckOnly) throws BeansException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 创建 Bean 实例</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        sharedInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getSingleton</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> () </span><span style="color:#C678DD">-&gt;</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#61AFEF"> createBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeansException</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#61AFEF">                destroySingleton</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#E06C75"> ex</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        })</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        beanInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getObjectForBeanInstance</span><span style="color:#E06C75">(sharedInstance</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其默认实现是 <code>AbstractAutowireCapableBeanFactory#createBean()</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> createBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args)</span></span>
<span class="line"><span style="color:#E06C75">    throws BeanCreationException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> beanInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> doCreateBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbdToUse</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTraceEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Finished creating instance of bean '"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> beanName </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "'"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>重点是调用的 <code>doCreateBean()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> doCreateBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                              RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">                              @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args) throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Instantiate the bean.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 实例化 Bean</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 允许后置处理器修改合并的 BeanDefinition</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 尽快缓存单例 Bean，以便触发生命周期接口（像 BeanFactoryAware）时也能解决循环依赖</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 初始化 Bean 实例</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> exposedObject </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#61AFEF">        populateBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> instanceWrapper)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        exposedObject </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> initializeBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> exposedObject</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在这个方法中完成了 Bean 的实例和初始化，初始化操作由 <code>initializeBean()</code> 方法完成。<code>BeanPostProcessor</code> 会在 Bean 初始化前后执行，不妨大胆猜测就是在 <code>initializeBean()</code> 方法中完成 <code>BeanPostProcessor</code> 的执行：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> initializeBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                Object</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 执行一些 Aware 方法 </span></span>
<span class="line"><span style="color:#61AFEF">    invokeAwareMethods</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> bean)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> wrappedBean </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> ||</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 应用 BeanPostProcessor 的 postProcessBeforeInitialization() 方法</span></span>
<span class="line"><span style="color:#E06C75">        wrappedBean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> applyBeanPostProcessorsBeforeInitialization</span><span style="color:#E06C75">(wrappedBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 执行初始化方法</span></span>
<span class="line"><span style="color:#61AFEF">        invokeInitMethods</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> wrappedBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E06C75">            (mbd </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#C678DD"> ?</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getResourceDescription</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> :</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ex</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMessage</span><span style="color:#ABB2BF">(),</span><span style="color:#E06C75"> ex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> ||</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 应用 BeanPostProcessor 的 postProcessAfterInitialization</span></span>
<span class="line"><span style="color:#E06C75">        wrappedBean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> applyBeanPostProcessorsAfterInitialization</span><span style="color:#E06C75">(wrappedBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> wrappedBean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>查看源码后也是验证了猜想，选取 <code>applyBeanPostProcessorsBeforeInitialization()</code> 方法进行解析：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> applyBeanPostProcessorsBeforeInitialization</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75"> existingBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                                          String</span><span style="color:#E06C75"> beanName)</span></span>
<span class="line"><span style="color:#E06C75">    throws BeansException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> existingBean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#E06C75"> processor </span><span style="color:#C678DD">:</span><span style="color:#61AFEF"> getBeanPostProcessors</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> current </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> processor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">postProcessBeforeInitialization</span><span style="color:#ABB2BF">(result, beanName);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (current </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> result</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">        result </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> current</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> result</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>逻辑很简单，获取所有 <code>BeanPostProcessor</code> 后进行遍历，依次执行它们的 <code>postProcessBeforeInitialization()</code> 方法。那 <code>BeanPostProcessor</code> 是怎么获取的呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> List</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">BeanPostProcessor</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> getBeanPostProcessors</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanPostProcessors</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>调用的是 <code>AbstractBeanFactory#getBeanPostProcessors()</code> 方法，直接返回成员变量 <code>beanPostProcessors</code> 的值，这里和前文中注册 <code>BeanPostProcessor</code> 的逻辑串联了起来。</p>
<h2 id="4-4-内置实现与使用场景"><a class="header-anchor" href="#4-4-内置实现与使用场景"></a>4.4 内置实现与使用场景</h2>
<blockquote>
<p>内置实现举例</p>
</blockquote>
<p>SpringBoot 进行参数校验时会使用到 <code>BeanValidationPostProcessor</code>，它也是 <code>BeanPostProcessor</code> 的一种内置实现。</p>
<blockquote>
<p>更多使用场景</p>
</blockquote>
<p>有时可能会编写一些自定义注解将它们标记到相应的类上，希望在对应的 Bean 实例化后，根据标记的自定义注解执行特定的逻辑，此时就可以通过实现 <code>BeanPostProcessor</code> 完成。</p>
<h2 id="4-5-更多思考"><a class="header-anchor" href="#4-5-更多思考"></a>4.5 更多思考</h2>
<p><code>BeanPostProcessor</code> 能够在 Bean 初始化前后被调用，那如果要在 Bean 实例化前后进行拓展应该怎么办呢？</p>
<h1 id="5-实例化感知-Bean-后置处理器"><a class="header-anchor" href="#5-实例化感知-Bean-后置处理器"></a>5. 实例化感知 Bean 后置处理器</h1>
<h2 id="5-1-拓展点的作用"><a class="header-anchor" href="#5-1-拓展点的作用"></a>5.1 拓展点的作用</h2>
<p>实例化感知 Bean 后置处理器，即：<code>InstantiationAwareBeanPostProcessor</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> InstantiationAwareBeanPostProcessor</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * Bean 实例化前执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">   @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInstantiation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * Bean 实例化后执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> postProcessAfterInstantiation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 实例化完成后，属性注入时（准确地说是属性注入前）执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">   @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> PropertyValues</span><span style="color:#61AFEF"> postProcessProperties</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">PropertyValues</span><span style="color:#E06C75;font-style:italic"> pvs</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">         throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#ABB2BF"> pvs;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>可以看到，<code>InstantiationAwareBeanPostProcessor</code> 继承了 <code>BeanPostProcessor</code>，并额外提供了三个方法，能够分别在 Bean 实例化前、实例化后、属性注入阶段进行拓展。</p>
<p><code>InstantiationAwareBeanPostProcessor</code> 与 <code>BeanPostProcessor</code> 类似，会作用于 Spring 管理的每个 Bean。</p>
<h2 id="5-2-使用方法"><a class="header-anchor" href="#5-2-使用方法"></a>5.2 使用方法</h2>
<p>实现 <code>InstantiationAwareBeanPostProcessor</code> 接口，重写抽象方法，并 <strong>将实现类交由 Spring 管理。</strong></p>
<p>比如存在 <code>Dependence</code> 和 <code>Example</code> 类，将t它们交由 Spring 管理，并在 <code>Example</code> 中注入 <code>Dependence</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Example</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> str </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "example"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Dependence</span><span style="color:#E06C75"> dependence</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setDependence</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Dependence</span><span style="color:#E06C75;font-style:italic"> dependence</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"6. Example 注入 dependence"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependence</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> dependence;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setStr</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> str</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"7. Example 注入 str"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">str</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> str;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Example</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3. 执行了 Example 的无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> init</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"9. 执行了 init() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A05Configuration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">initMethod</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "init"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> value</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> EXAMPLE_BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Example</span><span style="color:#61AFEF"> example</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Example</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Dependence</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Dependence</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. 执行了 Dependence 的无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写 <code>InstantiationAwareBeanPostProcessor</code> 的实现类，重写其中所有抽象方法（包括父接口 <code>BeanPostProcessor</code> 中的方法），当遇到名为 <code>a05-example</code> 的 Bean 时，执行一些特殊操作：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyInstantiationAwareBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> InstantiationAwareBeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInstantiation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. 执行了 postProcessBeforeInstantiation() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 是否返回其他 Bean 实例？可以返回代理对象，阻止默认实例化</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> postProcessAfterInstantiation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"4. 执行了 postProcessAfterInstantiation() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 是否需要依赖注入，如果返回 false，则不再执行 postProcessProperties() 方法；</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> PropertyValues</span><span style="color:#61AFEF"> postProcessProperties</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">PropertyValues</span><span style="color:#E06C75;font-style:italic"> pvs</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"5. 执行了 postProcessProperties() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            MutablePropertyValues</span><span style="color:#E06C75"> propertyValues</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (MutablePropertyValues) pvs;</span></span>
<span class="line"><span style="color:#E5C07B">            propertyValues</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"str"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"str"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> pvs;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"8. 执行了 postProcessBeforeInitialization() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"10. 执行了 postProcessAfterInitialization() 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A05ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> EXAMPLE_BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "a05-example"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A05ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Example</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">getStr</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"str"</span><span style="color:#ABB2BF">), </span><span style="color:#98C379">""</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Example</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">getDependence</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Dependence</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)), </span><span style="color:#98C379">""</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. 执行了 Dependence 的无参构造
2. 执行了 postProcessBeforeInstantiation() 方法
3. 执行了 Example 的无参构造
4. 执行了 postProcessAfterInstantiation() 方法
5. 执行了 postProcessProperties() 方法
6. Example 注入 dependence
7. Example 注入 str
8. 执行了 postProcessBeforeInitialization() 方法
9. 执行了 init() 方法
10. 执行了 postProcessAfterInitialization() 方法
</pre>
<p><code>InstantiationAwareBeanPostProcessor</code> 之于 <code>BeanPostProcessor</code>，就好比 <code>BeanDefinitionRegistryPostProcessor</code> 之于 <code>BeanFactoryPostProcessor</code>，这里的比较主要是在执行时机上。</p>
<p><code>InstantiationAwareBeanPostProcessor</code> 将在 <code>BeanPostProcessor</code> 前执行，对于增加的三个方法有：</p>
<ul>
<li><code>postProcessBeforeInstantiation()</code>：该方法将在 Bean 实例化前被执行。该方法有 <code>Object</code> 类型的返回值，可以自定义 Bean 替换原有的 Bean（比如进行了动态代理），在替换原有 Bean 后，将执行 <code>postProcessAfterInstantiation()</code>，其他拓展点将不再触发；</li>
<li><code>postProcessAfterInstantiation()</code>：该方法将在 Bean 实例化后被执行。该方法有 <code>boolean</code> 类型的返回值，它表示是否需要依赖注入，如果返回 <code>false</code>，将不再执行 <code>InstantiationAwareBeanPostProcessor</code> 实例中的其他任何拓展方法（包括父类 <code>BeanPostProcessor</code> 中的方法）；</li>
<li><code>postProcessProperties()</code>：该方法将在 Bean 实例化后、属性注入前执行。在此方法中可以对注入的属性值进行更改，或替换原来的属性值。默认情况下直接返回传入的 <code>PropertyValues</code>，如果返回 <code>null</code> 将跳过后续的属性填充。</li>
</ul>
<h2 id="5-3-注册"><a class="header-anchor" href="#5-3-注册"></a>5.3 注册</h2>
<p><code>InstantiationAwareBeanPostProcessor</code> 是 <code>BeanPostProcessor</code> 的子接口，因此它的注册方式与 <code>BeanPostProcessor</code> 的注册方式一样，参考【4.3 注册与执行】。</p>
<h2 id="5-4-执行"><a class="header-anchor" href="#5-4-执行"></a>5.4 执行</h2>
<blockquote>
<p><code>postProcessBeforeInstantiation()</code></p>
</blockquote>
<p><code>InstantiationAwareBeanPostProcessor</code> 的第一个方法 <code>postProcessBeforeInstantiation()</code> 将在 Bean 实例化前执行，结合上一节的内容，可以猜到这个方法的执行与 <code>refresh()</code> 方法中调用的 <code>finishBeanFactoryInitialization()</code> 方法有关。</p>
<p>大致流程与上一节类似，跟随相同的流程来到 <code>AbstractAutowireCapableBeanFactory#createBean()</code> 方法中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> createBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args)</span></span>
<span class="line"><span style="color:#E06C75">    throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 让 BeanPostProcessors 有机会返回代理而不是目标 Bean 实例</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> resolveBeforeInstantiation</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbdToUse)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 如果返回的值不为 null，直接返回，后续操作不再执行</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (bean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 上一节中分析过的方法</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> beanInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> doCreateBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbdToUse</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTraceEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Finished creating instance of bean '"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> beanName </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "'"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在这个方法中调用了 <code>resolveBeforeInstantiation()</code> 方法，这个方法能够在 Bean 实例化前做一些操作：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> resolveBeforeInstantiation</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd) {</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 对应的 BeanDefinition 还未执行过实例化前的操作</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">Boolean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FALSE</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beforeInstantiationResolved</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 确保 Bean 在这一点上得到了真正的解析</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#61AFEF"> hasInstantiationAwareBeanPostProcessors</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 确定给定的 BeanDefinition 的模板类型</span></span>
<span class="line"><span style="color:#E5C07B">            Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> targetType </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> determineTargetType</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (targetType </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 获取所有 InstantiationAwareBeanPostProcessor，一一遍历执行实例化前的操作</span></span>
<span class="line"><span style="color:#E06C75">                bean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> applyBeanPostProcessorsBeforeInstantiation</span><span style="color:#E06C75">(targetType</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (bean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 如果上一步返回的不是 null，直接执行实例化后的操作</span></span>
<span class="line"><span style="color:#E06C75">                    bean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> applyBeanPostProcessorsAfterInitialization</span><span style="color:#E06C75">(bean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E5C07B">        mbd</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beforeInstantiationResolved</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> (bean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>当 <code>postProcessBeforeInstantiation()</code> 方法返回非 <code>null</code> 的值时，会立即执行 <code>postProcessAfterInstantiation()</code> 方法，而在 <code>AbstractAutowireCapableBeanFactory#createBean()</code> 方法中，<code>resolveBeforeInstantiation()</code> 方法返回的值不为 <code>null</code> 时，将直接返回，不再执行后续的 <code>doCreateBean()</code> 方法，也就是不再执行其他拓展点，Spring 将 Bean 实例化及其以后的所有操作都交给实现者。</p>
<p><code>applyBeanPostProcessorsBeforeInstantiation()</code> 方法的实现也有点意思：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> applyBeanPostProcessorsBeforeInstantiation</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName) {</span></span>
<span class="line"><span style="color:#C678DD">   for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">InstantiationAwareBeanPostProcessor</span><span style="color:#E06C75"> bp </span><span style="color:#C678DD">:</span><span style="color:#61AFEF"> getBeanPostProcessorCache</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">instantiationAware</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">      Object</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> bp</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">postProcessBeforeInstantiation</span><span style="color:#ABB2BF">(beanClass, beanName);</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#E06C75"> (result </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">         return</span><span style="color:#E06C75"> result</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>获取 <code>InstantiationAwareBeanPostProcessor</code> 的方式通过 <code>getBeanPostProcessorCache().instantiationAware</code> 完成，<code>getBeanPostProcessorCache()</code> 返回了 <code>BeanPostProcessor</code> 实例的缓存（还分了类），以便多次重复获取 <code>BeanPostProcessor</code>。</p>
<blockquote>
<p><code>postProcessAfterInstantiation()</code> 与 <code>postProcessProperties()</code></p>
</blockquote>
<p>这个方法将会在 Bean <strong>实例化之后</strong> 执行，大胆猜测很有可能在 <code>doCreateBean()</code> 方法中执行，这在前文已经分析过一部分：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> doCreateBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                              RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">                              @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args) throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Instantiate the bean.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 实例化 Bean</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 允许后置处理器修改合并的 BeanDefinition</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 尽快缓存单例 Bean，以便触发生命周期接口（像 BeanFactoryAware）时也能解决循环依赖</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 初始化 Bean 实例</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> exposedObject </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#61AFEF">        populateBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> instanceWrapper)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        exposedObject </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> initializeBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> exposedObject</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>前文分析的是其中的 <code>initializeBean()</code> 方法，这个方法完成了 Bean 的初始化。</p>
<p>在计算机的英语表述中，<code>populate</code> 常被翻译为「填充」，<code>populateBean()</code> 方法将使用 <code>BeanDefinition</code> 中的属性值填充 <code>BeanWrapper</code> 中的 Bean 实例。</p>
<p>也就是说，这个方法会被 Bean 实例进行一些操作，点进去看看：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> populateBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                            RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">                            @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> BeanWrapper</span><span style="color:#E06C75"> bw) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 在设置属性前，让任何 InstantiationAwareBeanPostProcessors 都有机会修改 Bean，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 这样使用后，可以用于支持字段注入</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#61AFEF"> hasInstantiationAwareBeanPostProcessors</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">InstantiationAwareBeanPostProcessor</span><span style="color:#E06C75"> bp </span><span style="color:#C678DD">:</span><span style="color:#61AFEF"> getBeanPostProcessorCache</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">instantiationAware</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">bp</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">postProcessAfterInstantiation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">bw</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getWrappedInstance</span><span style="color:#ABB2BF">(), beanName)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 如果返回的是 false，直接返回，不再执行后续逻辑</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">hasInstantiationAwareBeanPostProcessors</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (pvs </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">            pvs </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPropertyValues</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取所有 InstantiationAwareBeanPostProcessor，一一遍历执行属性注入前的操作</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">InstantiationAwareBeanPostProcessor</span><span style="color:#E06C75"> bp </span><span style="color:#C678DD">:</span><span style="color:#61AFEF"> getBeanPostProcessorCache</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">instantiationAware</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            PropertyValues</span><span style="color:#E06C75"> pvsToUse </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> bp</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">postProcessProperties</span><span style="color:#ABB2BF">(pvs, </span><span style="color:#E5C07B">bw</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getWrappedInstance</span><span style="color:#ABB2BF">(), beanName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 如果返回 null，直接返回，跳过后续的属性填充</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (pvsToUse </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">            pvs </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> pvsToUse</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在这个方法中，执行了 <code>InstantiationAwareBeanPostProcessor</code> 中的第二、第三个拓展方法，这些拓展方法返回特殊的返回值时，会跳过后续逻辑的执行。</p>
<h2 id="5-5-内置实现"><a class="header-anchor" href="#5-5-内置实现"></a>5.5 内置实现</h2>
<p><code>InstantiationAwareBeanPostProcessor</code> 的实现十分有用，在 Spring 中也一个名为 <code>AutowiredAnnotationBeanPostProcessor</code> 的实现：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/AutowiredAnnotationBeanPostProcessor%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="AutowiredAnnotationBeanPostProcessor的类图"></p>
<p><code>AutowiredAnnotationBeanPostProcessor</code> 用于解析 Bean 属性注入的相关注解，比如 <code>@Autowired</code> 和 <code>@Value</code> 注解的解析。</p>
<p>Bean 中的字段被 <code>@Autowired</code> 注解标记后，可以将 Spring 容器中对应类型的 Bean 注入到当前 Bean 中，其实现逻辑就在重写的 <code>postProcessProperties()</code> 方法中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> PropertyValues</span><span style="color:#61AFEF"> postProcessProperties</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">PropertyValues</span><span style="color:#E06C75"> pvs</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                            Object</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取注入元数据 </span></span>
<span class="line"><span style="color:#E5C07B">    InjectionMetadata</span><span style="color:#E06C75"> metadata </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> findAutowiringMetadata</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">(),</span><span style="color:#E06C75"> pvs)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 根据解析出的元数据完成注入</span></span>
<span class="line"><span style="color:#E5C07B">        metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">inject</span><span style="color:#ABB2BF">(bean, beanName, pvs);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanCreationException</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#E06C75"> ex</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#98C379"> "Injection of autowired dependencies failed"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> pvs</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>AutowiredAnnotationBeanPostProcessor</code> 实现了 <code>SmartInstantiationAwareBeanPostProcessor</code> 接口，后者则继承了 <code>InstantiationAwareBeanPostProcessor</code>，那 <code>SmartInstantiationAwareBeanPostProcessor</code> 又是何方神圣？</p>
<h1 id="6-智能实例化感知-Bean-后置处理器"><a class="header-anchor" href="#6-智能实例化感知-Bean-后置处理器"></a>6. 智能实例化感知 Bean 后置处理器</h1>
<h2 id="6-1-拓展点的作用"><a class="header-anchor" href="#6-1-拓展点的作用"></a>6.1 拓展点的作用</h2>
<p>智能实例化感知 Bean 后置处理器，即：<code>SmartInstantiationAwareBeanPostProcessor</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> SmartInstantiationAwareBeanPostProcessor</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> InstantiationAwareBeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 预测从该处理器的 postProcessBeforeInstantiation() 回调中最终返回的 Bean 类型</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 默认返回 null。具体实现应尽量预测已知、已缓存的 Bean 类型，而无需额外的处理步骤。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * </span><span style="color:#C678DD;font-style:italic">@return</span><span style="color:#7F848E;font-style:italic"> Bean 的类型，如果无法预测就返回 null</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">   @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> predictBeanType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 确定从该处理器的 postProcessBeforeInstantiation() 回调中最终返回的 Bean 类型</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 默认实现会按原样返回给定的 Bean 类。具体实现应全面评估其处理步骤，以便预先创建、初</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 始化潜在的代理类。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * </span><span style="color:#C678DD;font-style:italic">@return</span><span style="color:#7F848E;font-style:italic"> Bean 的类型，永不为 null</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * </span><span style="color:#C678DD;font-style:italic">@since</span><span style="color:#7F848E;font-style:italic"> 6.0</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> determineBeanType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#ABB2BF"> beanClass;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 确定创建给定 Bean 时使用的候选构造方法，默认实现返回 null。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * </span><span style="color:#C678DD;font-style:italic">@return</span><span style="color:#7F848E;font-style:italic"> 候选的构造器，如果没特殊指定，则返回 null，采用默认构造器</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">   @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Constructor</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF">[] determineCandidateConstructors</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">         throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 返回一个引用，以便尽早访问指定的 Bean，这个方法通常用于解决循环引用。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 此回调为后置处理器提供了提前暴露 wrapper 的机会，即在目标 Bean 实例完全初始化之前。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 暴露的对象应等同于 postProcessBeforeInitialization() 或 postProcessAfterInitialization()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 所暴露的对象。请注意，除非后置处理器从上述回调中返回不同的 wrapper，否则</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 此方法返回的对象将用作 Bean 引用。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 默认实现是按原样返回给定的 Bean。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   default</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getEarlyBeanReference</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>可以看到，<code>SmartInstantiationAwareBeanPostProcessor</code> 继承了 <code>InstantiationAwareBeanPostProcessor</code>，并额外提供了四个方法，其中 <code>determineBeanType()</code> 方法是在 Spring 6.0 中新增的。</p>
<p>在类注释上有一段 NOTE，简单来说就是：<code>SmartInstantiationAwareBeanPostProcessor</code> 接口是一个专用接口，主要在框架内部使用。一般情况下，日常开发中实现 <code>BeanPostProcessor</code> 接口即可。</p>
<h2 id="6-2-使用方式"><a class="header-anchor" href="#6-2-使用方式"></a>6.2 使用方式</h2>
<p>存在名为 <code>Student</code> 的类，它依赖了 <code>Teacher</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> STUDENT_BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Student</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "mofan"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Teacher</span><span style="color:#E06C75"> teacher</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Student</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Student 的无参数构造方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Student</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> name;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Student 的有参数构造方法(name)被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Student</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Teacher</span><span style="color:#E06C75;font-style:italic"> teacher</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">teacher</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> teacher;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Student 的有参数构造方法(teacher)被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Student</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Teacher</span><span style="color:#E06C75;font-style:italic"> teacher</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> name;</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">teacher</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> teacher;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Student 的有参数构造方法(name,teacher)被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setTeacher</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Teacher</span><span style="color:#E06C75;font-style:italic"> teacher</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"----student中的setTeacher方法被调用"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">teacher</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> teacher;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>存在名为 <code>Teacher</code> 的类，它内部依赖了 <code>Student</code>，构成了循环依赖：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Teacher</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "Mr.Chen"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Student</span><span style="color:#E06C75"> student</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Teacher</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Teacher 的无参数构造方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setStudent</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Student</span><span style="color:#E06C75;font-style:italic"> student</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Teacher 中的 setStudent 方法被调用"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">student</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> student;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>实现 <code>SmartInstantiationAwareBeanPostProcessor</code> 接口，选择性重写其中的方法，并将实现类交由 Spring 管理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MySmartInstantiationAwareBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> SmartInstantiationAwareBeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> predictBeanType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">STUDENT_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"predictBeanType 方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E5C07B"> Student</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> determineBeanType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">STUDENT_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"determineBeanType 方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> beanClass;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Constructor</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF">[] determineCandidateConstructors</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">STUDENT_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 四个构造方法，选默认构造方法</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 选(name)时会报错，选(teacher)时会有循环依赖，并且是 Spring 无法解决的循环依赖</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 选(name, teacher)时也会报错</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"determineCandidateConstructors 方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> Constructor</span><span style="color:#ABB2BF">[]{</span><span style="color:#E5C07B">beanClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getConstructors</span><span style="color:#ABB2BF">()[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">]};</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getEarlyBeanReference</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">STUDENT_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"getEarlyBeanReference 方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInstantiation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">beanClass</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">STUDENT_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"postProcessBeforeInstantiation 方法被执行"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A06ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> STUDENT_BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "a06-student"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A06ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Teacher</span><span style="color:#E06C75"> teacher</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Teacher</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">teacher</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        Student</span><span style="color:#E06C75"> student</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Student</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">student</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>predictBeanType 方法被执行
postProcessBeforeInstantiation 方法被执行
determineCandidateConstructors 方法被执行
Student 的无参数构造方法被执行
predictBeanType 方法被执行
Teacher 的无参数构造方法被执行
predictBeanType 方法被执行
predictBeanType 方法被执行
getEarlyBeanReference 方法被执行
</pre>
<p>省略了许多 <code>predictBeanType 方法被执行</code> 的打印。</p>
<h2 id="6-3-注册"><a class="header-anchor" href="#6-3-注册"></a>6.3 注册</h2>
<p><code>SmartInstantiationAwareBeanPostProcessor</code> 是 <code>BeanPostProcessor</code> 的子接口，因此它的注册方式与 <code>BeanPostProcessor</code> 的注册方式一样，参考【4.3 注册与执行】。</p>
<h2 id="6-4-执行"><a class="header-anchor" href="#6-4-执行"></a>6.4 执行</h2>
<p>此处只介绍 <code>determineCandidateConstructors()</code> 方法的执行时间，该方法用于确定候选构造器，在实例化 Bean 使用。</p>
<p>在前文的介绍中可知，在 <code>getBean()</code> 方法里会对 Bean 进行实例化。跟随前文的步骤，来到 <code>AbstractAutowireCapableBeanFactory#doCreateBean()</code> 方法中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> doCreateBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                              RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">                              @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args) throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Instantiate the bean.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 实例化 Bean</span></span>
<span class="line"><span style="color:#E5C07B">    BeanWrapper</span><span style="color:#E06C75"> instanceWrapper </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        instanceWrapper </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factoryBeanInstanceCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (instanceWrapper </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        instanceWrapper </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> createBeanInstance</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> instanceWrapper</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getWrappedInstance</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> beanType </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> instanceWrapper</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getWrappedClass</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (beanType </span><span style="color:#56B6C2">!=</span><span style="color:#E5C07B"> NullBean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        mbd</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">resolvedTargetType</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> beanType</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 允许后置处理器修改合并的 BeanDefinition</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 尽快缓存单例 Bean，以便触发生命周期接口（像 BeanFactoryAware）时也能解决循环依赖</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 初始化 Bean 实例</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Initialize the bean instance.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>首先就是实例化 Bean，其中调用了 <code>createBeanInstance()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> BeanWrapper</span><span style="color:#61AFEF"> createBeanInstance</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                         RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">                                         @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Candidate constructors for autowiring?</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Autowired 使用的构造器</span></span>
<span class="line"><span style="color:#E5C07B">    Constructor</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">[] ctors </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> determineConstructorsFromBeanPostProcessors</span><span style="color:#E06C75">(beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (ctors </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> ||</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getResolvedAutowireMode</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ==</span><span style="color:#E06C75"> AUTOWIRE_CONSTRUCTOR </span><span style="color:#56B6C2">||</span></span>
<span class="line"><span style="color:#E5C07B">        mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasConstructorArgumentValues</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ||</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">ObjectUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">(args)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> autowireConstructor</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ctors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Preferred constructors for default construction?</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 默认构造的首选构造器</span></span>
<span class="line"><span style="color:#E06C75">    ctors </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPreferredConstructors</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (ctors </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> autowireConstructor</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ctors</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // No special handling: simply use no-arg constructor.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 没有特殊处理：简单使用无参构造器</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#61AFEF"> instantiateBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>调用了 <code>determineConstructorsFromBeanPostProcessors()</code> 方法，如果存在被 <code>@Autowired</code> 注解标记的构造器时，就使用这个构造器来实例化 Bean。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Constructor</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">determineConstructorsFromBeanPostProcessors</span><span style="color:#E06C75">(</span><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName)</span></span>
<span class="line"><span style="color:#E06C75">      throws BeansException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">   if</span><span style="color:#E06C75"> (beanClass </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#61AFEF"> hasInstantiationAwareBeanPostProcessors</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#C678DD">      for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">SmartInstantiationAwareBeanPostProcessor</span><span style="color:#E06C75"> bp </span><span style="color:#C678DD">:</span><span style="color:#61AFEF"> getBeanPostProcessorCache</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">smartInstantiationAware</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">         Constructor</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">[] ctors </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> bp</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">determineCandidateConstructors</span><span style="color:#ABB2BF">(beanClass, beanName);</span></span>
<span class="line"><span style="color:#C678DD">         if</span><span style="color:#E06C75"> (ctors </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> ctors</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">         }</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>可以看到，就是在此处调用了 <code>determineCandidateConstructors()</code> 方法。</p>
<h2 id="6-5-内置实现"><a class="header-anchor" href="#6-5-内置实现"></a>6.5 内置实现</h2>
<p>以 <code>AutowiredAnnotationBeanPostProcessor</code> 为例。</p>
<blockquote>
<p><code>predictBeanType()</code></p>
</blockquote>
<p>在 <code>AutowiredAnnotationBeanPostProcessor</code> 中并未重写 <code>predictBeanType()</code> 方法。</p>
<p>在 Spring AOP 中，<code>AbstractAutoProxyCreator</code> 重写了 <code>predictBeanType()</code> 方法，这与 AOP 的实现有关，此处不再深究， <strong>后续另开一文详细分析</strong>。</p>
<blockquote>
<p><code>determineBeanType()</code></p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> determineBeanType</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName) throws BeanCreationException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 检查被 @Lookup 注解标记的方法</span></span>
<span class="line"><span style="color:#61AFEF">    checkLookupMethods</span><span style="color:#E06C75">(beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Pick up subclass with fresh lookup method override from above</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 根据上述子类重写 @Lookup 标记的方法</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanFactory</span><span style="color:#C678DD"> instanceof</span><span style="color:#E5C07B"> AbstractAutowireCapableBeanFactory</span><span style="color:#E06C75"> aacBeanFactory) {</span></span>
<span class="line"><span style="color:#E5C07B">        RootBeanDefinition</span><span style="color:#E06C75"> mbd </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (RootBeanDefinition) </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMergedBeanDefinition</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 没有工厂方法，但是制定了 Bean 的 Class</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFactoryMethodName</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasBeanClass</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 获取给定 Bean 的实际 Class</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E5C07B"> aacBeanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getInstantiationStrategy</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getActualBeanClass</span><span style="color:#ABB2BF">(mbd, beanName, aacBeanFactory);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p><code>determineCandidateConstructors()</code></p>
</blockquote>
<p>重写的 <code>determineCandidateConstructors()</code> 方法很长，简单来说就是遍历类中所有构造器，然后选取出候选构造器。该方法中有这样一段：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Constructor</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">determineCandidateConstructors</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#C678DD">                                                       final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName)</span></span>
<span class="line"><span style="color:#E06C75">    throws BeanCreationException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Constructor</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> candidate </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> rawCandidates) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取构造器上与 Autowired 有关的注解</span></span>
<span class="line"><span style="color:#E5C07B">        MergedAnnotation</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> ann </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> findAutowiredAnnotation</span><span style="color:#E06C75">(candidate)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (ann </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 处理注解信息为 null 的情况</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (ann </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 第一次走到这时 requiredConstructor 等于 null</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (requiredConstructor </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 必需的构造器只能有一个，否则抛出异常</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 确定被标记的构造方法是否是必需的</span></span>
<span class="line"><span style="color:#C678DD">            boolean</span><span style="color:#E06C75"> required </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> determineRequiredStatus</span><span style="color:#E06C75">(ann)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (required) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 只能有一个，多个就抛异常</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">candidates</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                    throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 确定必需的构造器</span></span>
<span class="line"><span style="color:#E06C75">                requiredConstructor </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> candidate</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 添加到候选项列表中</span></span>
<span class="line"><span style="color:#E5C07B">            candidates</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(candidate);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">candidate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getParameterCount</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ==</span><span style="color:#D19A66"> 0</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">            defaultConstructor </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> candidate</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">candidateConstructors</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> &gt;</span><span style="color:#D19A66"> 0</span><span style="color:#C678DD"> ?</span><span style="color:#E06C75"> candidateConstructors </span><span style="color:#C678DD">:</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>遍历构造器时，使用 <code>findAutowiredAnnotation()</code> 方法查看构造器上是否有指定注解，如果有指定注解，并且使用 <code>determineRequiredStatus()</code> 方法求得注解标记的构造器是必需的，那么当前构造器就是必需的构造器。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> MergedAnnotation</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> findAutowiredAnnotation</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">AccessibleObject</span><span style="color:#E06C75"> ao) {</span></span>
<span class="line"><span style="color:#E5C07B">    MergedAnnotations</span><span style="color:#E06C75"> annotations </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> MergedAnnotations</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(ao);</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Annotation</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> type </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">autowiredAnnotationTypes</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        MergedAnnotation</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> annotation </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> annotations</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(type);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">annotation</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isPresent</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> annotation</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对构造器而言，遍历 <code>this.autowiredAnnotationTypes</code> 的值，查看构造器是否被这些注解标记。<code>this.autowiredAnnotationTypes</code> 的值在构造 <code>AutowiredAnnotationBeanPostProcessor</code> 实例时被指定，默认有以下四个值：</p>
<ul>
<li><code>@org.springframework.beans.factory.annotation.Autowired</code></li>
<li><code>@org.springframework.beans.factory.annotation.Value</code></li>
<li><code>@jakarta.inject.Inject</code></li>
<li><code>@javax.inject.Inject</code></li>
</ul>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> determineRequiredStatus</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">MergedAnnotation</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> ann) {</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">ann</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getValue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">requiredParameterName</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ||</span></span>
<span class="line"><span style="color:#E5C07B">         this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">requiredParameterValue</span><span style="color:#56B6C2"> ==</span><span style="color:#E5C07B"> ann</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBoolean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">requiredParameterName</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>该方法用于判断给定注解是否配置了 <code>require</code>。比如以 <code>@Autowired</code> 注解，该注解有 <code>require</code> 属性，同时该属性值为 <code>true</code> 时，<code>determineRequiredStatus()</code> 方法返回 <code>true</code>；以 <code>@Value</code> 注解来说，它不含 <code>require</code> 或 <code>optional</code> 属性，<code>determineRequiredStatus()</code> 方法也返回 <code>true</code>。</p>
<blockquote>
<p><code>getEarlyBeanReference()</code></p>
</blockquote>
<p>在 <code>AutowiredAnnotationBeanPostProcessor</code> 中并未重写 <code>getEarlyBeanReference()</code> 方法。</p>
<p>在 Spring AOP 中，<code>AbstractAutoProxyCreator</code> 重写了 <code>predictBeanType()</code> 方法，这与 AOP 的实现有关，此处不再深究， <strong>后续另开一文详细分析</strong>。</p>
<h1 id="7-应用上下文感知"><a class="header-anchor" href="#7-应用上下文感知"></a>7. 应用上下文感知</h1>
<h2 id="7-1-拓展点的作用"><a class="header-anchor" href="#7-1-拓展点的作用"></a>7.1 拓展点的作用</h2>
<p>应用上下文感知，即：<code>ApplicationContextAware</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ApplicationContextAware</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Aware</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 获取 ApplicationContext，这通常用于设置某个 Bean 中 ApplicationContext 类型的字段值</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> setApplicationContext</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationContext</span><span style="color:#E06C75;font-style:italic"> applicationContext</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>该接口实现了 <code>Aware</code> 接口，提供了 <code>setApplicationContext()</code> 方法，用于获取 <code>ApplicationContext</code>，通常用于设置某个 Bean 中 <code>ApplicationContext</code> 类型的字段值。</p>
<p><code>Aware</code> 接口是一个标记接口，Spring 中提供了众多的 Aware 接口，这些接口中都有以 <code>set</code> 开头的方法，用于获取特定的对象。比如：</p>
<ul>
<li><code>EnvironmentAware</code>：获取 <code>Environment</code> 对象，该对象可用于获得系统内所有的参数，也可以通过注入的方式获取该对象；</li>
<li><code>EmbeddedValueResolverAware</code>：获取 <code>StringValueResolver</code> 对象，该对象可用于获取 <code>String</code> 类型的 property，也可以通过 <code>@Value</code> 注解获取 <code>String</code> 类型的 property；</li>
<li><code>ResourceLoaderAware</code>：获取 <code>ResourceLoader</code> 对象，该对象可用于获取 <code>classpath</code> 下的所有资源；</li>
<li><code>ApplicationEventPublisherAware</code>：获取 <code>ApplicationEventPublisher</code> 对象，该对象可用于发送事件，也可以通过注入的方式获取该对象；</li>
<li><code>MessageSourceAware</code>：获取 <code>MessageSource</code> 对象，该对象可用于获取国际化信息；</li>
<li><code>ApplicationStartupAware</code>：获取 <code>ApplicationStartup</code> 对象，该对象可用于获取 Spring 启动期间各个步骤的信息。</li>
</ul>
<p><code>Aware</code> 的子接口其实有很多，那为什么只列举上面那些呢？</p>
<p>因为 <strong>上面这些 <code>Aware</code> 接口都由 <code>ApplicationContextAwareProcessor</code> 处理。</strong></p>
<h2 id="7-2-使用方式"><a class="header-anchor" href="#7-2-使用方式"></a>7.2 使用方式</h2>
<p>以 <code>ApplicationContextAware</code> 接口为例，实现 <code>ApplicationContextAware</code> 接口，重写 <code>setApplicationContext()</code> 方法，并将实现类交由 Spring 管理。</p>
<p>除此之外，<code>ApplicationContext</code> 对象还可以通过注入获取：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * &lt;p&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 类似的接口还有：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * &lt;ul&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *     &lt;li&gt;EnvironmentAware&lt;/li&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *     &lt;li&gt;EmbeddedValueResolverAware&lt;/li&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *     &lt;li&gt;ResourceLoaderAware&lt;/li&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *     &lt;li&gt;ApplicationEventPublisherAware&lt;/li&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *     &lt;li&gt;MessageSourceAware&lt;/li&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *     &lt;li&gt;ApplicationStartupAware&lt;/li&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * &lt;/ul&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * &lt;/p&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyApplicationContextAware</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ApplicationContextAware</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ApplicationContext</span><span style="color:#E06C75"> applicationContext</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setApplicationContext</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationContext</span><span style="color:#E06C75;font-style:italic"> applicationContext</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">applicationContext</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> applicationContext;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. Spring 上下文 ApplicationContext 被注入"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyApplicationContext</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ApplicationContext</span><span style="color:#E06C75"> applicationContext</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setApplicationContext</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationContext</span><span style="color:#E06C75;font-style:italic"> applicationContext</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">applicationContext</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> applicationContext;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. 使用 @Autowired 注入 ApplicationContext"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A07ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A07ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. 使用 @Autowired 注入 ApplicationContext
2. Spring 上下文 ApplicationContext 被注入
</pre>
<p>可以看到，相比于通过 <code>ApplicationContextAware</code> 获取 <code>ApplicationContext</code> 对象，直接注入 <code>ApplicationContext</code> 会更早执行。</p>
<h2 id="7-3-注册与执行"><a class="header-anchor" href="#7-3-注册与执行"></a>7.3 注册与执行</h2>
<p>可以使用 <code>ApplicationContextAware</code> 获取 <code>ApplicationContext</code> 对象，也可以直接注入 <code>ApplicationContext</code>，它们有什么区别呢？</p>
<p><code>ApplicationContextAware</code> 接口由 <code>ApplicationContextAwareProcessor</code> 处理，后者实现了 <code>BeanPostProcessor</code> 接口并重写 <code>postProcessBeforeInitialization()</code> 方法，在 Bean 初始化前处理继承了 <code>ApplicationContextAware</code> 接口的 Bean，但 <code>ApplicationContextAwareProcessor</code> 并未被 <code>@Component</code> 等注解标记，那它是怎么添加到 Spring 容器中的呢？</p>
<p>这些问题在 <a href="../Get-ApplicationContext/">获取 ApplicationContext</a> 一文中可以获得准确答案，此处不再赘述。</p>
<h2 id="7-4-一个重要的细节"><a class="header-anchor" href="#7-4-一个重要的细节"></a>7.4 一个重要的细节</h2>
<blockquote>
<p><code>ApplicationContextAwareProcessor</code> 被加载的时机</p>
</blockquote>
<p><code>ApplicationContextAwareProcessor</code> 将在准备 BeanFactory 时被加载，也就在 <code>refresh()</code> 方法中的 <code>prepareBeanFactory()</code> 方法中被加载：</p>
<pre><code class="highlight mermaid">flowchart TD
1("SpringApplication#refresh()")
2("AbstractApplicationContext#refresh()")
3("AbstractApplicationContext#prepareBeanFactory()")

1 --&gt; 2 --&gt; 3</code></pre>
<p><strong>这一步是十分靠前的。</strong></p>
<blockquote>
<p>其他 <code>BeanPostProcessor</code> 相比于 <code>ApplicationContextAwareProcessor</code> 的注册时机</p>
</blockquote>
<p><code>ApplicationContextAwareProcessor</code> 实现了 <code>BeanPostProcessor</code> 接口，重写了其中的 <code>postProcessBeforeInitialization()</code> 方法， <strong>会在 Bean 实例化后、初始化前执行。</strong></p>
<p>回忆 <code>BeanPostProcessor</code> 的注册时机，它是在 <code>refresh()</code> 方法中的 <code>registerBeanPostProcessors()</code> 方法中被注册的。<code>refresh()</code> 方法中的部分流程如下：</p>
<pre><code class="highlight mermaid">flowchart TD
1("prepareRefresh()")
2("obtainFreshBeanFactory")
subgraph 3 ["prepareBeanFactory()"]
3.1("加载 ApplicationContextAwareProcessor")
end
4("postProcessBeanFactory()")
subgraph 5 ["invokeBeanFactoryPostProcessors()"]
5.1("执行 BeanFactoryPostProcessor")
end
subgraph 6 ["registerBeanPostProcessors()"]
6.1("注册 BeanPostProcessor")
end
7("...")

1 --&gt; 2 --&gt; 3 --&gt; 4 --&gt; 5 --&gt; 6 --&gt; 7</code></pre>
<p>在注册其他 <code>BeanPostProcessor</code> 前，容器中已经存在了 <code>ApplicationContextAwareProcessor</code> 类型的 <code>BeanPostProcessor</code>。</p>
<blockquote>
<p>直接注入 <code>ApplicationContext</code> 的实现</p>
</blockquote>
<p>注入 <code>ApplicationContext</code> 时会使用 <code>@Autowired</code> 或 <code>@Resource</code> 注解，前者由 <code>AutowiredAnnotationBeanPostProcessor</code> 实现，后者由 <code>CommonAnnotationBeanPostProcessor</code> 实现，它们都是 <code>BeanPostProcessor</code> 的实现， <strong>它们实例化的时机是在 <code>registerBeanPostProcessors()</code> 方法中，相比于 <code>ApplicationContextAwareProcessor</code> 的实例化时机更加靠后。</strong></p>
<p>这说明了什么呢？</p>
<p><mark>也就是说，如果想要在 <code>registerBeanPostProcessors()</code> 方法前创建的 Bean 中拿到 <code>ApplicationContext</code> 实例，只能通过实现 <code>ApplicationContextAware</code> 接口完成，而不能通过注入 <code>ApplicationContext</code> 获取，因为那时还没加载用于解析相关注解的 <code>BeanPostProcessor</code>。</mark></p>
<p>比如在 <code>BeanFactoryPostProcessor</code> 的实现类中获取 <code>ApplicationContext</code> 实例：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyFirstBeanFactoryPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> postProcessBeanFactory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#E06C75;font-style:italic"> beanFactory</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isNull</span><span style="color:#ABB2BF">(context, </span><span style="color:#98C379">"依赖注入的 ApplicationContext 不是 null"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MySecondBeanFactoryPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanFactoryPostProcessor</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ApplicationContextAware</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> postProcessBeanFactory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ConfigurableListableBeanFactory</span><span style="color:#E06C75;font-style:italic"> beanFactory</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">notNull</span><span style="color:#ABB2BF">(context, </span><span style="color:#98C379">"使用 ApplicationContextAware 注入的 ApplicationContext 为 null"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setApplicationContext</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationContext</span><span style="color:#E06C75;font-style:italic"> applicationContext</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">context</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> applicationContext;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>BeanFactoryPostProcessor</code> 将在 <code>invokeBeanFactoryPostProcessors()</code> 方法中完成实例化与执行，实例化是通过 <code>getBean()</code> 方法完成的，如果容器中存在指定名称的 Bean，就直接获取，否则先创建再获取，这在前文已经说过了。</p>
<p>在通过 <code>getBean()</code> 实例化 <code>BeanFactoryPostProcessor</code> 前，会获取当前容器中的所有 <code>BeanPostProcessor</code> 实例，并执行它们的 <code>postProcessBeforeInitialization()</code> 方法，此时容器中存在 <code>ApplicationContextAwareProcessor</code> 类型的 <code>BeanPostProcessor</code>，使得实现 <code>ApplicationContextAware</code> 接口的 Bean 能够拿到 <code>ApplicationContext</code> 实例，而利用注入方式获取的 <code>ApplicationContext</code> 实例，由于还未加载相关的解析类，因此注入是无效的。</p>
<h2 id="7-5-另一个-Aware"><a class="header-anchor" href="#7-5-另一个-Aware"></a>7.5 另一个 Aware</h2>
<p>除了使用 <code>ApplicationContextAwareProcessor</code> 处理的一众 <code>Aware</code> 外，还有一个名为 <code>BeanNameAware</code> 的接口，它提供了获取某个 Bean 的 name 的能力：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> BeanNameAware</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Aware</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> setBeanName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>使用方式</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A14ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span></span>
<span class="line"><span style="color:#E5C07B">                SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A14ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        MyBean</span><span style="color:#E06C75"> myBean</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">MyBean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">myBean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanName</span><span style="color:#ABB2BF">), </span><span style="color:#98C379">"Bean 的 name 不相等"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "A Yi A Yi A"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBean</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanNameAware</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setBeanName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">beanName</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> name;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#E5C07B"> MyBean</span><span style="color:#61AFEF"> myBean</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> MyBean</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>执行</p>
</blockquote>
<p>它将在 Bean 初始化之前被执行，在 <code>AbstractAutowireCapableBeanFactory#initializeBean()</code> 方法的首行调用了 <code>invokeAwareMethods()</code> 方法，此方法完成了 <code>BeanNameAware</code> 等多个 <code>Aware</code> 的执行：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> invokeAwareMethods</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75"> bean) {</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> Aware) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> BeanNameAware</span><span style="color:#E06C75"> beanNameAware) {</span></span>
<span class="line"><span style="color:#E5C07B">            beanNameAware</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setBeanName</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> BeanClassLoaderAware</span><span style="color:#E06C75"> beanClassLoaderAware) {</span></span>
<span class="line"><span style="color:#E5C07B">            ClassLoader</span><span style="color:#E06C75"> bcl </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getBeanClassLoader</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (bcl </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                beanClassLoaderAware</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setBeanClassLoader</span><span style="color:#ABB2BF">(bcl);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> BeanFactoryAware</span><span style="color:#E06C75"> beanFactoryAware) {</span></span>
<span class="line"><span style="color:#E5C07B">            beanFactoryAware</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setBeanFactory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">AbstractAutowireCapableBeanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>至于到 <code>initializeBean()</code> 的具体流程，可以参考前文【Bean 后置处理器】的执行逻辑。</p>
<h1 id="8-PostConstruct"><a class="header-anchor" href="#8-PostConstruct"></a>8. @PostConstruct</h1>
<h2 id="8-1-拓展点的作用"><a class="header-anchor" href="#8-1-拓展点的作用"></a>8.1 拓展点的作用</h2>
<p>该注解的全限定类名是 <code>@javax.annotation.PostConstruct</code>，它并非 Spring 提供，但 Spring 为其提供了实现：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Documented</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Retention</span><span style="color:#E06C75"> (RUNTIME)</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Target</span><span style="color:#E06C75">(METHOD)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#ABB2BF"> @</span><span style="color:#C678DD">interface</span><span style="color:#E5C07B"> PostConstruct</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 JDK8 之前，该注解可以直接使用；JDK9 之后引入模块系统，将该注解剔除了 JDK，因此需要引入额外的依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;jakarta.annotation&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;jakarta.annotation-api&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;2.1.1&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>@PostConstruct</code> 只能作用于方法上， <strong>在依赖注入完成后，执行一次被 <code>@PostConstruct</code> 注解标记的方法。</strong></p>
<p><strong>在一个类中，被 <code>@PostConstruct</code> 注解标记的方法只能有一个。</strong></p>
<p>被 <code>@PostConstruct</code> 注解标记的方法必须满足以下条件：</p>
<ul>
<li>
<p>该方法不能有任何参数，除非是拦截器，在这种情况下，需要一个由拦截器规范定义的 <code>InvocationContext</code> 对象；</p>
</li>
<li>
<p>在拦截器类或拦截器类的超类上定义的方法必须具有以下签名之一：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>void &lt;METHOD&gt;(InvocationContext)</span></span>
<span class="line"><span>Object &lt;METHOD&gt;(InvocationContext) throws Exception</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>注意：<code>@PostConstruct</code> 标记的拦截方法不得抛出应用程序异常，但如果在同一个拦截方法中除了生命周期事件外还对业务或超时方法进行了拦截，则可以通过 <code>throws</code> 抛出包括 <code>java.lang.Exception</code> 在内的受检异常。如果 <code>@PostConstruct</code> 标记的拦截方法有返回值，容器会忽略该值；</p>
</li>
<li>
<p>在非拦截器类上定义的方法必须具有以下签名：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>void &lt;METHOD&gt;()</span></span></code></pre></td></tr></tbody></table>
      </figure>
</li>
<li>
<p>被 <code>@PostConstruct</code> 注解标记的方法可以是 <code>public</code>、<code>protected</code>、<code>package private</code> 或 <code>private</code>；</p>
</li>
<li>
<p>除应用程序客户端外，该方法不能是静态方法；</p>
</li>
<li>
<p>该方法不能是 <code>final</code> 的；</p>
</li>
<li>
<p>如果该方法抛出一个非受检异常，则该类不会投入使用，除非该异常被拦截器处理。</p>
</li>
</ul>
<h2 id="8-2-使用方式"><a class="header-anchor" href="#8-2-使用方式"></a>8.2 使用方式</h2>
<p>比如存在 <code>A07Example</code> 类，将其交由 Spring 管理，内部依赖了 <code>A07Dependence</code> 类型的 Bean：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "a07Example"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A07Dependence</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> A07Dependence</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. 执行了 A07Dependence 的无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A07Example</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> A07Dependence</span><span style="color:#E06C75"> dependence</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> A07Example</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A07Dependence</span><span style="color:#E06C75;font-style:italic"> dependence</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. 执行了 A07Example 的无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setDependence</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A07Dependence</span><span style="color:#E06C75;font-style:italic"> dependence</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependence</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> dependence;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3. A07Example 注入 dependence"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">PostConstruct</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> init</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"5. 执行了 @PostConstruct 标记的方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再提供一个 <code>BeanPostProcessor</code> 的实现类，用于确定被 <code>@PostConstruct</code> 注解标记的方法是什么时候执行的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"4. 执行了 postProcessBeforeInitialization 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"6. 执行了 postProcessAfterInitialization 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A08ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A08ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. 执行了 A07Dependence 的无参构造
2. 执行了 A07Example 的无参构造
3. A07Example 注入 dependence
4. 执行了 postProcessBeforeInitialization 方法
5. 执行了 @PostConstruct 标记的方法
6. 执行了 postProcessAfterInitialization 方法
</pre>
<p><code>A07Example</code> 还实现了 <code>InitializingBean</code> 接口，这会在下一节讲到。</p>
<p>可以看到，被 <code>@PostConstruct</code> 标记的方法会在依赖注入后、<code>postProcessBeforeInitialization()</code> 方法后、<code>postProcessAfterInitialization()</code> 方法前执行。</p>
<h2 id="8-3-执行"><a class="header-anchor" href="#8-3-执行"></a>8.3 执行</h2>
<p>被 <code>@PostConstruct</code> 标记的方法是什么时候执行的呢？</p>
<p>前文的使用示例可以确定大致范围，如果需要确定准确的时间点，最好的方式还是在被 <code>@PostConstruct</code> 标记的方法里打一个断点，通过方法调用栈进行追踪：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/%E6%96%AD%E7%82%B9%E8%A2%AB@PostConstruct%E6%A0%87%E8%AE%B0%E7%9A%84%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88.png" alt="断点被@PostConstruct标记的方法的调用栈"></p>
<p>在调用栈中可以看到熟悉的 <code>AbstractAutowireCapableBeanFactory#doCreateBean()</code> 方法，最终来到 <code>AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInitialization()</code> 方法中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> applyBeanPostProcessorsBeforeInitialization</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75"> existingBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                                          String</span><span style="color:#E06C75"> beanName)</span></span>
<span class="line"><span style="color:#E06C75">    throws BeansException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> existingBean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanPostProcessor</span><span style="color:#E06C75"> processor </span><span style="color:#C678DD">:</span><span style="color:#61AFEF"> getBeanPostProcessors</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> current </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> processor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">postProcessBeforeInitialization</span><span style="color:#ABB2BF">(result, beanName);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (current </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> result</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">        result </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> current</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> result</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这个方法很熟悉，在前文介绍 <code>BeanPostProcessor</code> 中方法的执行时机时进行了讲解，难道说 <code>@PostConstruct</code> 注解会由 <code>BeanPostProcessor</code> 的一个实现类进行解析？</p>
<p>定位到那一步，查看遍历的 <code>processor</code> 是何许人也：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/%E4%BD%BF%E7%94%A8CommonAnnotationBeanPostProcessor%E8%A7%A3%E6%9E%90@PostConstruct%E6%B3%A8%E8%A7%A3.png" alt="使用CommonAnnotationBeanPostProcessor解析@PostConstruct注解"></p>
<p>引出了一个新类：<code>CommonAnnotationBeanPostProcessor</code>。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/CommonAnnotationBeanPostProcessor%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="CommonAnnotationBeanPostProcessor的类图"></p>
<p><code>CommonAnnotationBeanPostProcessor</code> 并未直接实现 <code>BeanPostProcessor</code> 接口，而是继承了 <code>InitDestroyAnnotationBeanPostProcessor</code>，后者实现了 <code>BeanPostProcessor</code> 的子接口，重写的 <code>postProcessBeforeInitialization()</code> 方法也在这个类中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInitialization</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName) throws BeansException {</span></span>
<span class="line"><span style="color:#E5C07B">    LifecycleMetadata</span><span style="color:#E06C75"> metadata </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> findLifecycleMetadata</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invokeInitMethods</span><span style="color:#ABB2BF">(bean, beanName);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // catch 异常并处理</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>一共就两部：</p>
<ol>
<li>先找到生命周期元数据，即：<code>LifecycleMetadata</code>；</li>
<li>然后根据 <code>LifecycleMetadata</code> 执行初始化方法。</li>
</ol>
<blockquote>
<p><code>InitDestroyAnnotationBeanPostProcessor#findLifecycleMetadata()</code></p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> LifecycleMetadata</span><span style="color:#61AFEF"> findLifecycleMetadata</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass) {</span></span>
<span class="line"><span style="color:#C678DD">   if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleMetadataCache</span><span style="color:#56B6C2"> ==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // Happens after deserialization, during destruction...</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#61AFEF"> buildLifecycleMetadata</span><span style="color:#E06C75">(beanClass)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Quick check on the concurrent map first, with minimal locking.</span></span>
<span class="line"><span style="color:#E5C07B">   LifecycleMetadata</span><span style="color:#E06C75"> metadata </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleMetadataCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(beanClass);</span></span>
<span class="line"><span style="color:#C678DD">   if</span><span style="color:#E06C75"> (metadata </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">      synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleMetadataCache</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">         metadata </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleMetadataCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(beanClass);</span></span>
<span class="line"><span style="color:#C678DD">         if</span><span style="color:#E06C75"> (metadata </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">            metadata </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> buildLifecycleMetadata</span><span style="color:#E06C75">(beanClass)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleMetadataCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(beanClass, metadata);</span></span>
<span class="line"><span style="color:#E06C75">         }</span></span>
<span class="line"><span style="color:#C678DD">         return</span><span style="color:#E06C75"> metadata</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#E06C75"> metadata</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>重点是其中的 <code>buildLifecycleMetadata()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> LifecycleMetadata</span><span style="color:#61AFEF"> buildLifecycleMetadata</span><span style="color:#E06C75">(</span><span style="color:#C678DD">final</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass) {</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">AnnotationUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isCandidateClass</span><span style="color:#ABB2BF">(beanClass, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">initAnnotationTypes</span><span style="color:#ABB2BF">)</span><span style="color:#56B6C2"> &amp;&amp;</span></span>
<span class="line"><span style="color:#56B6C2">        !</span><span style="color:#E5C07B">AnnotationUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isCandidateClass</span><span style="color:#ABB2BF">(beanClass, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">destroyAnnotationTypes</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">emptyLifecycleMetadata</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 后续无非是通过反射获取 beanClass 中的所有方法，</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 收集目标方法后包装成 LifecycleMetadata，然后返回</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>重点是 <code>AnnotationUtils.isCandidateClass()</code> 方法，这里调用了两次，如果都返回 <code>false</code> 则直接返回 <code>emptyLifecycleMetadata</code>。</p>
<p>除此之外，<code>initAnnotationTypes</code> 和 <code>destroyAnnotationTypes</code> 应该是目标注解类型，那它们的值是什么呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Annotation</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> initAnnotationTypes </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashSet</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#D19A66">2</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Annotation</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> destroyAnnotationTypes </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashSet</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#D19A66">2</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>以 <code>initAnnotationTypes</code> 为例，提供了 <code>addInitAnnotationType()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> addInitAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#E06C75"> extends Annotation</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> initAnnotationType) {</span></span>
<span class="line"><span style="color:#C678DD">   if</span><span style="color:#E06C75"> (initAnnotationType </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">      this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">initAnnotationTypes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(initAnnotationType);</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>该方法在 <code>CommonAnnotationBeanPostProcessor</code> 的构造函数中被调用，利用 <code>loadAnnotationType()</code> 加载指定全限定类名的注解：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#61AFEF"> CommonAnnotationBeanPostProcessor</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#61AFEF">   setOrder</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Ordered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">LOWEST_PRECEDENCE</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66"> 3</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Jakarta EE 9 set of annotations in jakarta.annotation package</span></span>
<span class="line"><span style="color:#61AFEF">   addInitAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#61AFEF">loadAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#98C379">"jakarta.annotation.PostConstruct"</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">   addDestroyAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#61AFEF">loadAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#98C379">"jakarta.annotation.PreDestroy"</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Tolerate legacy JSR-250 annotations in javax.annotation package</span></span>
<span class="line"><span style="color:#61AFEF">   addInitAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#61AFEF">loadAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#98C379">"javax.annotation.PostConstruct"</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#61AFEF">   addDestroyAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#61AFEF">loadAnnotationType</span><span style="color:#E06C75">(</span><span style="color:#98C379">"javax.annotation.PreDestroy"</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // java.naming module present on JDK 9+?</span></span>
<span class="line"><span style="color:#C678DD">   if</span><span style="color:#E06C75"> (jndiPresent) {</span></span>
<span class="line"><span style="color:#E5C07B">      this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">jndiFactory</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> SimpleJndiBeanFactory</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>至于 <code>loadAnnotationType()</code> 的实现逻辑，无非是对 <code>Class.forName()</code> 的包装，这不是重点。</p>
<p>再回到 <code>AnnotationUtils.isCandidateClass()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isCandidateClass</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> clazz</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Collection</span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#E06C75"> extends Annotation</span><span style="color:#56B6C2">&gt;&gt;</span><span style="color:#E06C75"> annotationTypes) {</span></span>
<span class="line"><span style="color:#C678DD">   for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Annotation</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> annotationType </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> annotationTypes) {</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">isCandidateClass</span><span style="color:#E06C75">(clazz</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> annotationType)) {</span></span>
<span class="line"><span style="color:#C678DD">         return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>内部调用了 <code>isCandidateClass()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isCandidateClass</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> clazz</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#E06C75"> extends Annotation</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> annotationType) {</span></span>
<span class="line"><span style="color:#C678DD">   return</span><span style="color:#E06C75"> (annotationType </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#61AFEF"> isCandidateClass</span><span style="color:#E06C75">(clazz</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> annotationType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>又调用重载的 <code>isCandidateClass()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isCandidateClass</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> clazz</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> annotationName) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 注解以 `java.` 开头，直接返回 true</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">annotationName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"java."</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">AnnotationsScanner</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasPlainJavaAnnotationsOnly</span><span style="color:#ABB2BF">(clazz)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后调用了 <code>AnnotationsScanner.hasPlainJavaAnnotationsOnly()</code> 方法，如果它返回 <code>true</code>，最终返回 <code>false</code>，否则最终返回 <code>true</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> hasPlainJavaAnnotationsOnly</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> type) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果目标类的全限定类名以 `java.` 开头，或者是 Ordered 的子类，就返回 true</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">type</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"java."</span><span style="color:#ABB2BF">)</span><span style="color:#56B6C2"> ||</span><span style="color:#E06C75"> type </span><span style="color:#56B6C2">==</span><span style="color:#E5C07B"> Ordered</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>分析了半天，好像并没有什么有意思的东西… 😅</p>
<blockquote>
<p><code>InitDestroyAnnotationBeanPostProcessor.LifecycleMetadata#invokeInitMethods()</code></p>
</blockquote>
<p>回到 <code>invokeInitMethods()</code> 方法，看看是怎么执行目标方法的，多半是遍历每个目标方法然后利用反射去执行：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> invokeInitMethods</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75"> target</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName) throws Throwable {</span></span>
<span class="line"><span style="color:#E5C07B">   Collection</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">LifecycleMethod</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> checkedInitMethods </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">checkedInitMethods</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">   Collection</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">LifecycleMethod</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> initMethodsToIterate </span><span style="color:#56B6C2">=</span></span>
<span class="line"><span style="color:#E06C75">         (checkedInitMethods </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#C678DD"> ?</span><span style="color:#E06C75"> checkedInitMethods </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">initMethods</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">   if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">initMethodsToIterate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">      for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">LifecycleMethod</span><span style="color:#E06C75"> lifecycleMethod </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> initMethodsToIterate) {</span></span>
<span class="line"><span style="color:#C678DD">         if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTraceEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Invoking init method on bean '"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> beanName </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "': "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> lifecycleMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethod</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">         }</span></span>
<span class="line"><span style="color:#E5C07B">         lifecycleMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(target);</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>又是遍历，然后执行了 <code>InitDestroyAnnotationBeanPostProcessor.LifecycleMethod#invoke()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> invoke</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75"> target) throws Throwable {</span></span>
<span class="line"><span style="color:#E5C07B">   ReflectionUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">makeAccessible</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">   this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(target);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>果不其然，印证了前面的猜想。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p>执行逻辑很简单，概括后就两步：</p>
<ol>
<li>遍历目标类中的每个方法，收集被指定注解标记的方法；</li>
<li>反射执行被指定注解标记的方法</li>
</ol>
<h1 id="9-初始化-Bean"><a class="header-anchor" href="#9-初始化-Bean"></a>9. 初始化 Bean</h1>
<h2 id="9-1-拓展点的作用"><a class="header-anchor" href="#9-1-拓展点的作用"></a>9.1 拓展点的作用</h2>
<p>初始化 Bean，即：<code>InitializingBean</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> InitializingBean</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 属性注入后执行</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> afterPropertiesSet</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中仅有一个无参无返回值的 <code>afterPropertiesSet()</code>，根据方法名称可知，这个方法很有可能在属性注入后执行。</p>
<h2 id="9-2-使用方式"><a class="header-anchor" href="#9-2-使用方式"></a>9.2 使用方式</h2>
<p>实现 <code>InitializingBean</code> 接口并重写 <code>afterPropertiesSet()</code> 方法，将实现类交由 Spring 管理，并且在类中使用 <code>@PostConstruct</code> 注解标记：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> EXAMPLE_BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "a08-example"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A08Dependence</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A08Example</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> InitializingBean</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> A08Dependence</span><span style="color:#E06C75"> dependence</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setDependence</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A08Dependence</span><span style="color:#E06C75;font-style:italic"> dependence</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependence</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> dependence;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. A08Example 注入 dependence"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> afterPropertiesSet</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"4. 执行了 afterPropertiesSet 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">PostConstruct</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> init</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3. 执行了 init 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> initMethod</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"5. 执行了 init-method"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> initMethod</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "initMethod"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> A08Example</span><span style="color:#61AFEF"> a08Example</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> A08Example</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>同样提供一个 <code>BeanPostProcessor</code> 的实现类，用于确定 <code>afterPropertiesSet()</code> 方法是什么时候执行的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessBeforeInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. 执行了 postProcessBeforeInitialization 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">EXAMPLE_BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"5. 执行了 postProcessAfterInitialization 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A09ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A09ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. A08Example 注入 dependence
2. 执行了 postProcessBeforeInitialization 方法
3. 执行了 init 方法
4. 执行了 afterPropertiesSet 方法
5. 执行了 init-method
6. 执行了 postProcessAfterInitialization 方法
</pre>
<p>可以看到，<code>afterPropertiesSet()</code> 方法在 <code>postProcessAfterInitialization()</code> 方法前执行，同时还在 <code>init-method</code> 方法前执行。</p>
<h2 id="9-3-执行"><a class="header-anchor" href="#9-3-执行"></a>9.3 执行</h2>
<p>前文的使用示例可以确定大致范围，要确定准确的范围也可以利用断点查看方法调用栈：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/%E6%96%AD%E7%82%B9afterPropertiesSet%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88.png" alt="断点afterPropertiesSet方法的调用栈"></p>
<p>又见熟悉的 <code>doCreateBean()</code> 方法，之后进入 <code>initializeBean()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> initializeBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd) {</span></span>
<span class="line"><span style="color:#61AFEF">    invokeAwareMethods</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> bean)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> wrappedBean </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> ||</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        wrappedBean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> applyBeanPostProcessorsBeforeInitialization</span><span style="color:#E06C75">(wrappedBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#61AFEF">        invokeInitMethods</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> wrappedBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E06C75">            (mbd </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#C678DD"> ?</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getResourceDescription</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> :</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ex</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMessage</span><span style="color:#ABB2BF">(),</span><span style="color:#E06C75"> ex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> ||</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        wrappedBean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> applyBeanPostProcessorsAfterInitialization</span><span style="color:#E06C75">(wrappedBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> wrappedBean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>而后调用 <code>invokeInitMethods()</code> 方法，根据调用方法栈可知，在调用 <code>invokeInitMethods()</code> 方法后，就执行了重写的 <code>afterPropertiesSet()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> invokeInitMethods</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                 Object</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">                                 @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd) throws Throwable {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果当前的 Bean 也是 InitializingBean 实例</span></span>
<span class="line"><span style="color:#C678DD">    boolean</span><span style="color:#E06C75"> isInitializingBean </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> InitializingBean)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (isInitializingBean </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 不含名为 afterPropertiesSet 的外部管理初始方法</span></span>
<span class="line"><span style="color:#E06C75">        (mbd </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> ||</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasAnyExternallyManagedInitMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"afterPropertiesSet"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 省略打印日志</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 执行 afterPropertiesSet 方法</span></span>
<span class="line"><span style="color:#E06C75">        ((InitializingBean) bean)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">afterPropertiesSet</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> !=</span><span style="color:#E5C07B"> NullBean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取所有初始方法名</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75">[] initMethodNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getInitMethodNames</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (initMethodNames </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 遍历初始化方法名</span></span>
<span class="line"><span style="color:#C678DD">            for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> initMethodName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> initMethodNames) {</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasLength</span><span style="color:#ABB2BF">(initMethodName)</span><span style="color:#56B6C2"> &amp;&amp;</span></span>
<span class="line"><span style="color:#56B6C2">                    !</span><span style="color:#E06C75">(isInitializingBean </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#98C379"> "afterPropertiesSet"</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(initMethodName)</span><span style="color:#E06C75">) </span><span style="color:#56B6C2">&amp;&amp;</span></span>
<span class="line"><span style="color:#56B6C2">                    !</span><span style="color:#E5C07B">mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasAnyExternallyManagedInitMethod</span><span style="color:#ABB2BF">(initMethodName)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 利用反射执行自定义初始方法</span></span>
<span class="line"><span style="color:#61AFEF">                    invokeCustomInitMethod</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> initMethodName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在第一个 <code>if</code> 判断中执行了 <code>InitializingBean</code> 的 <code>afterPropertiesSet()</code> 方法。</p>
<p>如果对使用示例的 <code>initMethod()</code> 方法进行断点，则会进入第二个 <code>if</code> 分支，在内部调用 <code>invokeCustomInitMethod()</code> 方法利用反射执行 <code>initMethod()</code> 方法。</p>
<h2 id="9-4-内置实现"><a class="header-anchor" href="#9-4-内置实现"></a>9.4 内置实现</h2>
<p>利用 <code>InitializingBean</code> 接口可以修改默认设置的属性值、添加额外的属性值，或者对某些属性值进行校验，在 Spring MVC 中有个名为 <code>RequestMappingHandlerMapping</code> 的类，用于实现 Controller 与 URL 的映射。它也实现了 <code>InitializingBean</code> 接口：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/RequestMappingHandlerMapping%E7%9A%84%E7%B1%BB%E5%9B%BE.png" alt="RequestMappingHandlerMapping的类图"></p>
<h1 id="10-智能初始化单例"><a class="header-anchor" href="#10-智能初始化单例"></a>10. 智能初始化单例</h1>
<h2 id="10-1-拓展点的作用"><a class="header-anchor" href="#10-1-拓展点的作用"></a>10.1 拓展点的作用</h2>
<p>智能初始化单例，即：<code>SmartInitializingSingleton</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> SmartInitializingSingleton</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 在单例 Bean 预实例化阶段结束后调用，保证已经创建了所有常规的单例 Bean。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 在此方法中调用 `ListableBeanFactory.getBeansOfType()` 方法不会在启动过程中</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 触发意外的副作用。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 注意：对于懒加载的单例 Bean 和多例 Bean，在 BeanFactory 启动后，不会触发</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 此回调。请谨慎使用，仅用于具有预期启动含义的 Bean。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> afterSingletonsInstantiated</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中仅有一个无参无返回值的 <code>afterSingletonsInstantiated()</code>，根据方法名称可知，这个方法很有可能在 Bean 初始化后执行。</p>
<p><mark>注意：</mark> 是在所有单例 Bean 初始化完成后执行，对懒加载单例 Bean 和多例 Bean 则没要求。</p>
<h2 id="10-2-使用方式"><a class="header-anchor" href="#10-2-使用方式"></a>10.2 使用方式</h2>
<p>实现 <code>SmartInitializingSingleton</code> 接口，重写 <code>afterSingletonsInstantiated()</code> 方法，并将实现类交由 Spring 管理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "myBean"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MySmartInitializingSingleton</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> InitializingBean</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> SmartInitializingSingleton</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> afterPropertiesSet</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. 执行了 afterPropertiesSet 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> afterSingletonsInstantiated</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3. 执行了 afterSingletonsInstantiated 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>同样提供一个 <code>BeanPostProcessor</code> 的实现类，只重写 <code>postProcessAfterInitialization()</code> 方法，用于确定 <code>afterSingletonsInstantiated()</code> 方法是什么时候执行的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">BEAN_NAME</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. 执行了 postProcessAfterInitialization 方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A10ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A10ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. 执行了 afterPropertiesSet 方法
2. 执行了 postProcessAfterInitialization 方法
3. 执行了 afterSingletonsInstantiated 方法
</pre>
<p>可以看到，<code>afterSingletonsInstantiated()</code> 会在 <code>postProcessAfterInitialization()</code> 方法后执行，确实是在 Bean 初始化完成后执行。</p>
<h2 id="10-3-执行"><a class="header-anchor" href="#10-3-执行"></a>10.3 执行</h2>
<p>至于执行时机，其实在【4.3 注册与执行】中介绍 <code>BeanPostProcessor</code> 的执行时机时已经介绍过。</p>
<p>目前已知的情报是会在单例 Bean 初始化完成后执行 <code>afterSingletonsInstantiated()</code> 方法。</p>
<p>以 <code>AbstractApplicationContext#refresh()</code> 方法为入口：</p>
<pre><code class="highlight mermaid">flowchart TD
1("AbstractApplicationContext#refresh()")
2("AbstractApplicationContext#finishBeanFactoryInitialization()")
3("DefaultListableBeanFactory#preInstantiateSingletons()")
1 --&gt; 2 --&gt; 3</code></pre>
<p>在 <code>preInstantiateSingletons()</code> 方法中有：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> preInstantiateSingletons</span><span style="color:#E06C75">() throws BeansException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Trigger initialization of all non-lazy singleton beans...</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 触发所有非懒加载单例 Bean 的初始化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Trigger post-initialization callback for all applicable beans...</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> beanNames) {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> singletonInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getSingleton</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (singletonInstance </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> SmartInitializingSingleton</span><span style="color:#E06C75"> smartSingleton) {</span></span>
<span class="line"><span style="color:#E5C07B">            StartupStep</span><span style="color:#E06C75"> smartInitialize </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getApplicationStartup</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">start</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"spring.beans.smart-initialize"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">tag</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"beanName"</span><span style="color:#ABB2BF">, beanName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 执行 afterSingletonsInstantiated() 方法</span></span>
<span class="line"><span style="color:#E5C07B">            smartSingleton</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">afterSingletonsInstantiated</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            smartInitialize</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">end</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>执行过程很简单，几步就走到了 <code>afterSingletonsInstantiated()</code> 的执行点。</p>
<h1 id="11-两个运行器"><a class="header-anchor" href="#11-两个运行器"></a>11. 两个运行器</h1>
<h2 id="11-1-拓展点的作用"><a class="header-anchor" href="#11-1-拓展点的作用"></a>11.1 拓展点的作用</h2>
<p>本节拓展点的名字并不是真的叫「两个运行器」，😂 而是将在本节介绍两个拓展点，它们以 <code>Runner</code> 结尾，翻译成运行器也没啥问题。</p>
<p>这两个运行器分别是 <code>CommandLineRunner</code> 和 <code>ApplicationRunner</code>。</p>
<p>为什么要在本节一起介绍，是因为它们很类似，执行时间点也很靠近，它们都拥有名为 <code>run()</code> 的方法，只是参数不同：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">FunctionalInterface</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> CommandLineRunner</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">... </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">FunctionalInterface</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ApplicationRunner</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationArguments</span><span style="color:#E06C75;font-style:italic"> args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>前面介绍的拓展点都是在 Spring 中本身就存在的，而不是 SpringBoot 单独提供的，而本节的这两个运行器则是由 SpringBoot 提供。</p>
<p><code>ApplicationRunner</code> 会早于 <code>CommandLineRunner</code> 执行，它们都将在 Spring 容器、Web 容器启动后，正式处理业务请求前（即项目启动的最后一步）执行。</p>
<p>这两个接口可用于正式处理业务请求前预加载热点数据、清除临时文件、读取自定义配置信息等。</p>
<p>在一个应用程序上下文中可以定义多个 <code>ApplicationRunner</code> 或 <code>CommandLineRunner</code>，此时可以使用 <code>Ordered</code> 接口或 <code>@Order</code> 注解对这些运行器的执行顺序进行排序。</p>
<h2 id="11-2-使用方式"><a class="header-anchor" href="#11-2-使用方式"></a>11.2 使用方式</h2>
<p>分别实现 <code>ApplicationRunner</code> 和 <code>CommandLineRunner</code> 接口，重写其中的 <code>run()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> COMMAND_LINE_BEAN </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "command-line-bean"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> APPLICATION_BEAN </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "application-bean"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(COMMAND_LINE_BEAN)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyCommandLineRunner</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> CommandLineRunner</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">... </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行 CommandLineRunner"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(APPLICATION_BEAN)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyApplicationRunner</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ApplicationRunner</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationArguments</span><span style="color:#E06C75;font-style:italic"> args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行 ApplicationRunner"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再次提供一个 <code>BeanPostProcessor</code> 的实现类，只重写 <code>postProcessAfterInitialization()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> BEAN_NAMES </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">(COMMAND_LINE_BEAN, APPLICATION_BEAN);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyBeanPostProcessor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> BeanPostProcessor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> postProcessAfterInitialization</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> bean</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> beanName</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> BeansException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">BEAN_NAMES</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(beanName)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"检测到指定 Bean:[%s] 的 postProcessAfterInitialization 方法%n"</span><span style="color:#ABB2BF">, beanName);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> bean;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A11ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A11ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>检测到指定 Bean:[application-bean] 的 postProcessAfterInitialization 方法
检测到指定 Bean:[command-line-bean] 的 postProcessAfterInitialization 方法
执行 ApplicationRunner
执行 CommandLineRunner
</pre>
<p>根据使用示例可知 <code>ApplicationRunner</code> 确实会早于 <code>CommandLineRunner</code> 执行。</p>
<h2 id="11-3-执行"><a class="header-anchor" href="#11-3-执行"></a>11.3 执行</h2>
<p>前文中许多拓展点都与 <code>refresh()</code> 方法有关，<code>refresh</code> 一词可译为「刷新」，表示刷新上下文，其中最重要的就是将 Bean 添加到 Spring 容器（Spring 容器是 Spring 上下文的一部分）中。从使用示例可知，本节的两个拓展点会在 Bean 初始化之后执行，那么很有可能不会在 <code>refresh()</code> 方法中执行。</p>
<p>从 Spring 主启动类出发：</p>
<pre><code class="highlight mermaid">flowchart TD
1("SpringApplication#run(java.lang.Class&lt;?&gt;, java.lang.String...)")
2("SpringApplication#run(java.lang.Class&lt;?&gt;[], java.lang.String[])")
3("SpringApplication#run(java.lang.String...)")

1 --&gt; 2 --&gt; 3</code></pre>
<p>执行时机既不在 <code>refreshContext()</code> 中，也不在 <code>afterRefresh()</code> 中，而是在最后的 <code>callRunners()</code> 中，这方法名称也很明确——调用运行器：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> callRunners</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ApplicationArguments</span><span style="color:#E06C75"> args) {</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> runners </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 从容器中获取两种运行器</span></span>
<span class="line"><span style="color:#E5C07B">    runners</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addAll</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeansOfType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationRunner</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">values</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    runners</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addAll</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeansOfType</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">CommandLineRunner</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">values</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 对他们排个序</span></span>
<span class="line"><span style="color:#E5C07B">    AnnotationAwareOrderComparator</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">sort</span><span style="color:#ABB2BF">(runners);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 遍历并一一执行</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75"> runner </span><span style="color:#C678DD">:</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashSet</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(runners)) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (runner </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> ApplicationRunner</span><span style="color:#E06C75"> applicationRunner) {</span></span>
<span class="line"><span style="color:#61AFEF">            callRunner</span><span style="color:#E06C75">(applicationRunner</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (runner </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> CommandLineRunner</span><span style="color:#E06C75"> commandLineRunner) {</span></span>
<span class="line"><span style="color:#61AFEF">            callRunner</span><span style="color:#E06C75">(commandLineRunner</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> args)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="12-工厂-Bean"><a class="header-anchor" href="#12-工厂-Bean"></a>12. 工厂 Bean</h1>
<h2 id="12-1-拓展点的作用"><a class="header-anchor" href="#12-1-拓展点的作用"></a>12.1 拓展点的作用</h2>
<p>工厂 Bean，即：<code>FactoryBean</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> FactoryBean</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> OBJECT_TYPE_ATTRIBUTE </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "factoryBeanObjectType"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#E5C07B">    T</span><span style="color:#61AFEF"> getObject</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> getObjectType</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    default</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>FactoryBean</code> 其实并不能认为是拓展点，它是创建复杂 Bean 的一种方式。</p>
<p>在 Spring 中有一个类似的接口，名为 <code>BeanFactory</code>，有一道常见的面试题：<code>BeanFactory</code> 与 <code>FactoryBean</code> 有什么异同？</p>
<p>它们之间的异倒是很大，至于同就只有名字长得比较相似了。<code>BeanFactory</code> 译为「Bean 工厂」，即生产存储 Bean 的地方，也就是常说的 Spring 容器；<code>FactoryBean</code> 译为「工厂 Bean」，是创建 Bean 的一种方式，就像设计模式中的工厂模式一样。</p>
<p><code>FactoryBean</code> 中有三个方法：</p>
<ul>
<li><code>getObject()</code>：获取 Bean 对象，用于创建一些难以使用常规方式创建的 Bean；</li>
<li><code>getObjectType()</code>：用于获取返回 Bean 的类型；</li>
<li><code>isSingleton()</code>：创建的 Bean 是否是单例 Bean，默认 <code>true</code>。</li>
</ul>
<h2 id="12-2-使用方式"><a class="header-anchor" href="#12-2-使用方式"></a>12.2 使用方式</h2>
<p>假设存在名为 <code>Owl</code> 的「复杂类」，尽管并不复杂：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Owl</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Owl</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行了无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Owl</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> name;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行了有参(name)构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写 <code>FactoryBean</code> 的实现类，重写其中的抽象方法，其中的 <code>getObject()</code> 方法返回 <code>Owl</code> 实例，并将实现类交由 Spring 管理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> OWL_BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "owl"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span><span style="color:#E06C75">(OWL_BEAN_NAME)</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> OwlFactoryBean</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> FactoryBean</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Owl</span><span style="color:#ABB2BF">&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> OwlFactoryBean</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行了 OwlFactoryBean 的无参构造"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Owl</span><span style="color:#61AFEF"> getObject</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行 getObject--start"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Owl</span><span style="color:#E06C75"> owl</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Owl</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"执行 getObject--end"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> owl;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> getObjectType</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Owl</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A12ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span></span>
<span class="line"><span style="color:#E5C07B">            SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A12ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 通过 bean 的 name 获取</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> bean</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(OWL_BEAN_NAME);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isInstanceOf</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Owl</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, bean);</span></span>
<span class="line"><span style="color:#ABB2BF">        bean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BeanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FACTORY_BEAN_PREFIX</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> OWL_BEAN_NAME);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isInstanceOf</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">OwlFactoryBean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, bean);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>执行了 OwlFactoryBean 的无参构造
执行 getObject--start
执行了无参构造
执行 getObject--end
</pre>
<p>从容器中按照名称获取与 <code>OwlFactoryBean</code> 同名的 Bean 时，得到的 Bean 的类型并不是 <code>OwlFactoryBean</code>，而是 <code>Owl</code> 类型的，如果要获取原始类型，则需要在名称前添加 <code>&amp;</code>（有点 C 语言的味道）。</p>
<h2 id="12-3-注册"><a class="header-anchor" href="#12-3-注册"></a>12.3 注册</h2>
<p>在注册 <code>FactoryBean</code> 类型的 Bean 时，按照给定的 Bean 名称或者默认规则进行注册，在 Spring 容器中只会存在 <code>FactoryBean</code> 类型的 Bean，不会存在 <code>getObjectType()</code> 返回的类型、 <code>getObject()</code> 返回的对象的 Bean。</p>
<p>通过 <code>getBean()</code> 方法按照注册的 <code>FactoryBean</code> 类型的 Bean 的名称在 Spring 容器中获取 Bean 时，获取到的是 <code>getObject()</code> 返回的对象，能够获取到这样的对象是 <code>getBean()</code> 方法中的细节，而不是在 Spring 容器中真实存在的。</p>
<h2 id="12-4-执行"><a class="header-anchor" href="#12-4-执行"></a>12.4 执行</h2>
<p>名称的细微差别能够通过 <code>getBean()</code> 方法获取到不同的 Bean 对象，那么就看看 <code>getBean()</code> 中的细节吧。</p>
<pre><code class="highlight mermaid">flowchart TD
1("AbstractBeanFactory#getBean(java.lang.String)")
2("AbstractBeanFactory#doGetBean()")

1 --&gt; 2</code></pre>
<p>来到 <code>doGetBean()</code> 方法后，不会像前文分析的那样来到 <code>createBean()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#56B6C2"> &lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> T</span><span style="color:#61AFEF"> doGetBean</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> requiredType</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> typeCheckOnly) throws BeansException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> beanName </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> transformedBeanName</span><span style="color:#E06C75">(name)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 检查单例缓存总是否有手动创建的单例 Bean</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 以 owl 为例，获取到的是 FactoryBean 对象</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> sharedInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getSingleton</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (sharedInstance </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E06C75"> args </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 打印了些日志</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取给定 Bean 实例的对象，可以是 Bean 实例本身，也可以是 FactoryBean 创建的对象</span></span>
<span class="line"><span style="color:#E06C75">        beanInstance </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getObjectForBeanInstance</span><span style="color:#E06C75">(sharedInstance</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>而是会进入 <code>getObjectForBeanInstance()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getObjectForBeanInstance</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> currentlyCreatedBean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">currentlyCreatedBean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (currentlyCreatedBean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#61AFEF">        registerDependentBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> currentlyCreatedBean)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> super</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getObjectForBeanInstance</span><span style="color:#ABB2BF">(beanInstance, name, beanName, mbd);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后调用父类的 <code>getObjectForBeanInstance()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getObjectForBeanInstance</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> RootBeanDefinition</span><span style="color:#E06C75"> mbd) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Don't let calling code try to dereference the factory if the bean isn't a factory.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果 bean 不是工厂，则不要让调用代码尝试取消引用工厂</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果 name 以 &amp; 开头</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanFactoryUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isFactoryDereference</span><span style="color:#ABB2BF">(name)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (beanInstance </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> NullBean) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E06C75">(beanInstance </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> FactoryBean)) {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanIsNotAFactoryException</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> beanInstance</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            mbd</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">isFactoryBean</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 如果 name 以 &amp; 开头，直接返回 FactoryBean 对象</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Now we have the bean instance, which may be a normal bean or a FactoryBean.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // If it's a FactoryBean, we use it to create a bean instance, unless the</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // caller actually wants a reference to the factory.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 现在我们已经有了 Bean 实例，它可能是一个普通的 Bean 或 FactoryBean</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果是 FactoryBean，就用它创建一个 Bean 实例，除非调用者实际想要的是工厂的引用</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E06C75">(beanInstance </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> FactoryBean</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> factoryBean)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取到的 Bean 实例不是 FactoryBean 类型，name 也不以 &amp; 开头</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 证明是普通 Bean，那么返回即可</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E06C75"> beanInstance</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        mbd</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">isFactoryBean</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 从缓存中获取 Bean</span></span>
<span class="line"><span style="color:#E06C75">        object </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getCachedObjectForFactoryBean</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (object </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Return bean instance from factory.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 从 factory 中返回 bean 实例</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Caches object obtained from FactoryBean if it is a singleton.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 如果 FactoryBean 是单例，则缓存从 FactoryBean 获取的对象</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#61AFEF"> containsBeanDefinition</span><span style="color:#E06C75">(beanName)) {</span></span>
<span class="line"><span style="color:#E06C75">            mbd </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getMergedLocalBeanDefinition</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        boolean</span><span style="color:#E06C75"> synthetic </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (mbd </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 从 FactoryBean 中获取 Bean</span></span>
<span class="line"><span style="color:#E06C75">        object </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getObjectFromFactoryBean</span><span style="color:#E06C75">(factoryBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#56B6C2"> !</span><span style="color:#E06C75">synthetic)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后调用 <code>getObjectFromFactoryBean()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getObjectFromFactoryBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">FactoryBean</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> factory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                                          String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> shouldPostProcess) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // FactoryBean 返回的 Bean 是单例的，beanName 在 singletonObjects 中存在</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">factory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#61AFEF"> containsSingleton</span><span style="color:#E06C75">(beanName)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 锁住 singletonObjects</span></span>
<span class="line"><span style="color:#C678DD">        synchronized</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">getSingletonMutex</span><span style="color:#E06C75">()) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 从缓存中获取</span></span>
<span class="line"><span style="color:#E5C07B">            Object</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factoryBeanObjectCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (object </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 获取不到，直接通过 factory 的 getObject() 方法获取对象</span></span>
<span class="line"><span style="color:#E06C75">                object </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> doGetObjectFromFactoryBean</span><span style="color:#E06C75">(factory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // Only post-process and store if not put there already during getObject() call above</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // (e.g. because of circular reference processing triggered by custom getBean calls)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 如果在上面的 getObject() 调用期间还没有放在那里，则只进行后期处理和存储</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // （例如，因为自定义getBean调用触发了循环引用处理）</span></span>
<span class="line"><span style="color:#E5C07B">                Object</span><span style="color:#E06C75"> alreadyThere </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factoryBeanObjectCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (alreadyThere </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">                    object </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> alreadyThere</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#C678DD">                else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // BeanDefinition 不是合成的，就要进行后置处理</span></span>
<span class="line"><span style="color:#C678DD">                    if</span><span style="color:#E06C75"> (shouldPostProcess) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 获取的单例是否正在创建</span></span>
<span class="line"><span style="color:#C678DD">                        if</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">isSingletonCurrentlyInCreation</span><span style="color:#E06C75">(beanName)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // Temporarily return non-post-processed object, not storing it yet..</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // 暂时返回未经后处理的对象，暂不存储</span></span>
<span class="line"><span style="color:#C678DD">                            return</span><span style="color:#E06C75"> object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                        }</span></span>
<span class="line"><span style="color:#61AFEF">                        beforeSingletonCreation</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">                        try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // 后置处理 Bean</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // 调用 BeanPostProcessor 的 postProcessAfterInitialization()</span></span>
<span class="line"><span style="color:#E06C75">                            object </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> postProcessObjectFromFactoryBean</span><span style="color:#E06C75">(object</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                        }</span></span>
<span class="line"><span style="color:#C678DD">                        catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                                                            "Post-processing of FactoryBean's singleton object failed"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                        }</span></span>
<span class="line"><span style="color:#C678DD">                        finally</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#61AFEF">                            afterSingletonCreation</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                        }</span></span>
<span class="line"><span style="color:#E06C75">                    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 给定的 beanName 在 singletonObjects 中存在</span></span>
<span class="line"><span style="color:#C678DD">                    if</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">containsSingleton</span><span style="color:#E06C75">(beanName)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 更新 factoryBeanObjectCache，下次就不用再次获取，直接从缓存中拿</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 这样的话能够保证始终获取到的是同一个对象</span></span>
<span class="line"><span style="color:#E5C07B">                        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">factoryBeanObjectCache</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(beanName, object);</span></span>
<span class="line"><span style="color:#E06C75">                    }</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 不是单例，或者 beanName 在 singletonObjects 中不存在</span></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 再次调用 FactoryBean 的 getObject() 获取 Bean</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> doGetObjectFromFactoryBean</span><span style="color:#E06C75">(factory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (shouldPostProcess) {</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 同样进行后置处理</span></span>
<span class="line"><span style="color:#E06C75">                object </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> postProcessObjectFromFactoryBean</span><span style="color:#E06C75">(object</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#98C379"> "Post-processing of FactoryBean's object failed"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E06C75"> object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>概括一下：</p>
<ul>
<li>如果是单例的，先尝试从 <code>factoryBeanObjectCache</code> 中获取，保证每次获取到的都是同一个对象；如果在缓存中不存在，那么调用 <code>getObject()</code> 方法拿到 Bean，并进行后置处理，最后存储到 <code>factoryBeanObjectCache</code> 中；</li>
<li>如果不是单例、或者在 <code>beanName</code> 在 <code>singletonObjects</code> 中不存在，每次调用 <code>getObject()</code> 方法拿到新的 Bean，同样进行后置处理。</li>
</ul>
<h1 id="13-可销毁-Bean"><a class="header-anchor" href="#13-可销毁-Bean"></a>13. 可销毁 Bean</h1>
<h2 id="13-1-拓展点的作用"><a class="header-anchor" href="#13-1-拓展点的作用"></a>13.1 拓展点的作用</h2>
<p>可销毁 Bean，即：<code>DisposableBean</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> DisposableBean</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">   void</span><span style="color:#61AFEF"> destroy</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>接口内部只有一个无参无返回值的 <code>destroy()</code> 方法，为 Spring Bean 提供了一种释放资源的方式，能够在 Spring 容器关闭，销毁所有 Bean 时回调。</p>
<p><code>DisposableBean</code> 接口与 <code>InitializingBean</code> 接口有些类似，但触发时机不同。</p>
<h2 id="13-2-使用方式"><a class="header-anchor" href="#13-2-使用方式"></a>13.2 使用方式</h2>
<p>实现 <code>DisposableBean</code> 接口并重写 <code>destroy()</code> 方法，将实现类交由 Spring 管理，还提供 <code>ApplicationRunner</code> 的实现类，作为对比：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyRunner</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ApplicationRunner</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ApplicationArguments</span><span style="color:#E06C75;font-style:italic"> args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"1. [%s]: 执行了 ApplicationRunner 方法</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A13DisposableBean</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> DisposableBean</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> destroy</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"4. [%s]: 执行了 destroy 方法</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">PreDestroy</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> preDestroy</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"3. [%s]: 执行了 @preDestroy 方法</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> destroyMethod</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"5. [%s]: 执行了 destroy-method</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">destroyMethod</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "destroyMethod"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> A13DisposableBean</span><span style="color:#61AFEF"> a13DisposableBean</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> A13DisposableBean</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A13ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">SneakyThrows</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A13ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2. [%s]: main 方法执行完毕，准备关闭容器</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        TimeUnit</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SECONDS</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">sleep</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 可以不直接关闭容器，而是通过 `System.exit(0)` 关闭，此时会触发 shutdown hooks；</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 或者是在 IDEA 中，手动停止程序，也会触发 shutdown hooks</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         */</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getCurrentThreadName</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Thread</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">currentThread</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>1. [main]: 执行了 ApplicationRunner 方法
2. [main]: main 方法执行完毕，准备关闭容器
3. [main]: 执行了 @preDestroy 方法
4. [main]: 执行了 destroy 方法
5. [main]: 执行了 destroy-method
</pre>
<p>对于 Bean 的初始化来说，有三个类似的拓展点，并 <strong>按顺序依次执行：</strong></p>
<ul>
<li><code>@PostConstruct</code></li>
<li><code>InitializingBean#afterPropertiesSet()</code></li>
<li><code>@Bean</code> 注解的 <code>initMethod</code> 属性</li>
</ul>
<p>而对于 Bean 的销毁来说，也有三个类似的拓展点，也 <strong>按顺序依次执行：</strong></p>
<ul>
<li><code>@PreDestroy</code></li>
<li><code>DisposableBean#destroy()</code></li>
<li><code>@Bean</code> 注解的 <code>destroyMethod</code> 属性</li>
</ul>
<blockquote>
<p>调用的线程</p>
</blockquote>
<p><code>destroy()</code> 方法会在 <code>main</code> 线程中被调用。</p>
<p>如果去掉 <code>context.close()</code> 方法，而是手动或者通过 <code>System.exit(0);</code> 关闭程序，<strong>销毁方法们</strong> 则会在 <code>SpringApplicationShutdownHook</code> 线程中被调用。在这种情况下，运用了多线程技术，异步执行销毁方法，这涉及到 <a href="../SpringBoot-Shutdown-Hook/">SpringBoot Shutdown Hook</a>， 本节依旧以 <code>context.close()</code> 方法为入口进行探索。</p>
<h2 id="13-3-执行"><a class="header-anchor" href="#13-3-执行"></a>13.3 执行</h2>
<p>以 <code>context.close()</code> 方法为入口，来到 <code>AbstractApplicationContext#close()</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> close</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">   synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">startupShutdownMonitor</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#61AFEF">      doClose</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // If we registered a JVM shutdown hook, we don't need it anymore now:</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // We've already explicitly closed the context.</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">shutdownHook</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">         try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">            Runtime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRuntime</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">removeShutdownHook</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">shutdownHook</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">         }</span></span>
<span class="line"><span style="color:#C678DD">         catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">IllegalStateException</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // ignore - VM is already shutting down</span></span>
<span class="line"><span style="color:#E06C75">         }</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">   }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>重点在 <code>doClose()</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> doClose</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Check whether an actual close attempt is necessary...</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 检查是否有必要进行实际的关闭尝试</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">active</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">closed</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">compareAndSet</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isDebugEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">debug</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Closing "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // Publish shutdown event.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 发布 shutdown 事件</span></span>
<span class="line"><span style="color:#61AFEF">            publishEvent</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> ContextClosedEvent</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">warn</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Exception thrown from ApplicationListener handling ContextClosedEvent"</span><span style="color:#ABB2BF">, ex);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Stop all Lifecycle beans, to avoid delays during individual destruction.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 停止所有 Lifecycle Bean，以避免在单个销毁过程中出现延迟。</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">                this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">onClose</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">warn</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Exception thrown from LifecycleProcessor on context close"</span><span style="color:#ABB2BF">, ex);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Destroy all cached singletons in the context's BeanFactory.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 销毁所有在上下文的 BeanFactory 缓存的单例</span></span>
<span class="line"><span style="color:#61AFEF">        destroyBeans</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Close the state of this context itself.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 关闭上下文本身的状态</span></span>
<span class="line"><span style="color:#61AFEF">        closeBeanFactory</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Let subclasses do some final clean-up if they wish...</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 如果可以，让子类做一些最后的清理</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 比如 ServletWebServerApplicationContext 会实现该勾子函数关闭内嵌的 WebServer(Tomcat)</span></span>
<span class="line"><span style="color:#61AFEF">        onClose</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Reset common introspection caches to avoid class reference leaks.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 重置常用自省缓存，避免类引用泄漏</span></span>
<span class="line"><span style="color:#61AFEF">        resetCommonCaches</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Reset local application listeners to pre-refresh state.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 将本地应用程序监听器重置为刷新前状态</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">earlyApplicationListeners</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">applicationListeners</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">applicationListeners</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addAll</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">earlyApplicationListeners</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Switch to inactive.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 切换到 inactive</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">active</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">set</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中的 <code>destroyBeans()</code> 方法用于销毁 Spring 容器中缓存的单例，在这个方法前会执行两件应用关闭前的操作，它们都类似一种通知机制，但在使用场景上也有区别：</p>
<ul>
<li><code>ContextClosedEvent</code> 是应用级别的事件，监听该事件可以做一些全局性的行为；</li>
<li><code>Lifecycle</code> 是 Bean 级别的通知，更适用于特定 Bean 的行为。</li>
</ul>
<p>回到 <code>destroyBeans()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> destroyBeans</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#61AFEF">   getBeanFactory</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">destroySingletons</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再来到 <code>destroySingletons()</code>，方法有两个实现，主要的实现是 <code>DefaultSingletonBeanRegistry#destroySingletons()</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> destroySingletons</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTraceEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Destroying singletons in "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">singletonObjects</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">singletonsCurrentlyInDestruction</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] disposableBeanNames</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">disposableBeans</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取已经缓存的需要被销毁的 Bean 的 name</span></span>
<span class="line"><span style="color:#E06C75">        disposableBeanNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toStringArray</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">disposableBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">keySet</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> disposableBeanNames</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">&gt;=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i</span><span style="color:#ABB2BF">--</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 逆序遍历，一一销毁</span></span>
<span class="line"><span style="color:#61AFEF">        destroySingleton</span><span style="color:#E06C75">(disposableBeanNames[i])</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 清除当前类用到的一些缓存</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">containedBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependentBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependenciesForBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clear</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 清除单例缓存</span></span>
<span class="line"><span style="color:#61AFEF">    clearSingletonCache</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后几步清除了当前类中用到的一些缓存包括：</p>
<ul>
<li><code>containedBeanMap</code></li>
<li><code>dependentBeanMap</code></li>
<li><code>dependenciesForBeanMap</code></li>
</ul>
<blockquote>
<p>插播一下：几个 <code>Map</code> 的含义</p>
</blockquote>
<p>对于 <code>dependentBeanMap</code> 与 <code>dependenciesForBeanMap</code> 来说：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/** Map between dependent bean names: bean name to Set of dependent bean names. */</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> dependentBeanMap </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ConcurrentHashMap</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#D19A66">64</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/** Map between depending bean names: bean name to Set of bean names for the bean's dependencies. */</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> dependenciesForBeanMap </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ConcurrentHashMap</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#D19A66">64</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<ul>
<li><code>dependentBeanMap</code>：Bean 名称和所有依赖于它的 Bean 的名称的映射关系</li>
<li><code>dependenciesForBeanMap</code>：Bean 名称和它依赖的 Bean 的名称的映射关系</li>
</ul>
<pre><code class="highlight mermaid">flowchart TD
1("A")
2("B")
3("C")
1 --&gt; 2
1 --&gt; 3</code></pre>
<p>在上图中，A 依赖了 B（<code>A --&gt; B</code>），A 依赖了 C（<code>A --&gt; C</code>），则：</p>
<ul>
<li><code>dependentBeanMap</code>：<code>&lt;B, [A]&gt;</code> 和 <code>&lt;C, [A]&gt;</code></li>
<li><code>dependenciesForBeanMap</code>：<code>&lt;A, [B, C]&gt;</code></li>
</ul>
<p>至于 <code>containedBeanMap</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/** Map between containing bean names: bean name to Set of bean names that the bean contains. */</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> containedBeanMap </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ConcurrentHashMap</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#D19A66">16</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>它表示 Bean 名称与它包含的 Bean 的名称的映射关系。这似乎与 <code>dependenciesForBeanMap</code> 很类似，也确实很类似，但它是在 XML 配置中使用的，在当前流行基于注解的 Spring 配置的环境下，它的使用场景越来越小。比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Foo</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Bar</span><span style="color:#E06C75"> bar</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Foo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Bar</span><span style="color:#E06C75;font-style:italic"> bar</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">bar</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> bar;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Bar</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>Foo</code> 类中依赖了 <code>Bar</code>，那么基于 XML 的配置有：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">bean</span><span style="color:#D19A66"> id</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">"foo"</span><span style="color:#D19A66"> class</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">"com.example.demo.Foo"</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">constructor-arg</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">bean</span><span style="color:#D19A66"> class</span><span style="color:#ABB2BF">=</span><span style="color:#98C379">"com.example.demo.Bar"</span><span style="color:#ABB2BF">/&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">constructor-arg</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">bean</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这是不是就相当于 <code>Foo</code> 包含了 <code>Bar</code>？这仅供了解，现在几乎没有使用场景。</p>
<blockquote>
<p>再插播下：<code>disposableBeans</code> 的初始化</p>
</blockquote>
<p><code>disposableBeans</code> 的初始化是在熟悉的 <code>doCreateBean()</code> 方法中最后完成：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> doCreateBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> </span></span>
<span class="line"><span style="color:#E5C07B">                              RootBeanDefinition</span><span style="color:#E06C75"> mbd</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75">[] args)</span></span>
<span class="line"><span style="color:#E06C75">    throws BeanCreationException {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Instantiate the bean.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Allow post-processors to modify the merged bean definition.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Eagerly cache singletons to be able to resolve circular references</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Initialize the bean instance.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Register bean as disposable.</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 在这进行注册，不再深入分析</span></span>
<span class="line"><span style="color:#61AFEF">        registerDisposableBeanIfNecessary</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> bean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mbd)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">BeanDefinitionValidationException</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanCreationException</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#E5C07B">            mbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getResourceDescription</span><span style="color:#ABB2BF">(),</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#98C379"> "Invalid destruction signature"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> exposedObject</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>回到主线</p>
</blockquote>
<p>查看 <code>destroySingleton()</code> 方法，如何根据 Bean 的 name 来进行销毁：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> destroySingleton</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Remove a registered singleton of the given name, if any.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果有，删除已注册的给定名称的单例 Bean</span></span>
<span class="line"><span style="color:#61AFEF">    removeSingleton</span><span style="color:#E06C75">(beanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Destroy the corresponding DisposableBean instance.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 销毁相应的 DisposableBean 实例</span></span>
<span class="line"><span style="color:#E5C07B">    DisposableBean</span><span style="color:#E06C75"> disposableBean</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">disposableBeans</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        disposableBean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">disposableBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#61AFEF">    destroyBean</span><span style="color:#E06C75">(beanName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> disposableBean)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>removeSingleton()</code> 方法从多个 <code>Map</code> 中移除即可，<code>DisposableBean</code> 已经被缓存了一份，先删除再销毁也没啥问题。</p>
<p>销毁的主要逻辑在 <code>destroyBean()</code> 中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> destroyBean</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> DisposableBean</span><span style="color:#E06C75"> bean) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 首先触发依赖了当前 Bean 的 Bean 的销毁（dependentBeanMap）</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> dependencies</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependentBeanMap</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Within full synchronization in order to guarantee a disconnected Set</span></span>
<span class="line"><span style="color:#E06C75">        dependencies </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependentBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (dependencies </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 省略日志的打印</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> dependentBeanName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> dependencies) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 递归销毁</span></span>
<span class="line"><span style="color:#61AFEF">            destroySingleton</span><span style="color:#E06C75">(dependentBeanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 现在销毁自己</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (bean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">            bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">destroy</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 触发当前 Bean 包含的 Bean 的销毁（containedBeanMap）</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> containedBeans</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">containedBeanMap</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Within full synchronization in order to guarantee a disconnected Set</span></span>
<span class="line"><span style="color:#E06C75">        containedBeans </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">containedBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (containedBeans </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> containedBeanName </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> containedBeans) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 同样递归销毁</span></span>
<span class="line"><span style="color:#61AFEF">            destroySingleton</span><span style="color:#E06C75">(containedBeanName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Remove destroyed bean from other beans' dependencies.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将已销毁的 Bean 从其他 Bean 的依赖关系中移除</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 也就是移除其他 Bean 对已销毁 Bean 的依赖（dependentBeanMap） </span></span>
<span class="line"><span style="color:#C678DD">    synchronized</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependentBeanMap</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Iterator</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Map</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Entry</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;&gt;&gt;</span><span style="color:#E06C75"> it </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependentBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">entrySet</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">iterator</span><span style="color:#ABB2BF">();</span><span style="color:#E5C07B"> it</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasNext</span><span style="color:#ABB2BF">();</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            Map</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Entry</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> entry </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> it</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> dependenciesToClean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> entry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getValue</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            dependenciesToClean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">dependenciesToClean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                it</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Remove destroyed bean's prepared dependency information.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 删除已销毁 Bean 的准备好的依赖关系信息（dependenciesForBeanMap）</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">dependenciesForBeanMap</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>逻辑分为几步：</p>
<ol>
<li>首先在 <code>dependentBeanMap</code> 中移除 <strong>（一个递归操作）</strong> 其他 Bean 对目标 Bean 的依赖，依赖的都没了，那它自己也该被销毁；</li>
<li><strong>执行目标 Bean 的销毁（<code>DisposableBean</code> 的执行时机）；</strong></li>
<li>在 <code>containedBeanMap</code> 中移除当前 Bean 包含的 Bean；</li>
<li>从其他 Bean 的依赖项中删除销毁的目标 Bean；</li>
<li>最终删除目标 Bean 对其他 Bean 的依赖关系信息。</li>
</ol>
<h1 id="14-智能生命周期"><a class="header-anchor" href="#14-智能生命周期"></a>14. 智能生命周期</h1>
<h2 id="14-1-拓展点的作用"><a class="header-anchor" href="#14-1-拓展点的作用"></a>14.1 拓展点的作用</h2>
<p>智能生命周期，即：<code>SmartLifecycle</code>，它并非 SpringBoot 提供，是在 Spring 中就存在的：</p>
<pre><code class="highlight mermaid">classDiagram
direction BT
class Lifecycle {
&lt;&lt;Interface&gt;&gt;
  + stop() void
  + isRunning() boolean
  + start() void
}
class Phased {
&lt;&lt;Interface&gt;&gt;
  + getPhase() int
}
class SmartLifecycle {
&lt;&lt;Interface&gt;&gt;
  + getPhase() int
  + stop(Runnable) void
  + isAutoStartup() boolean
}

SmartLifecycle  --&gt;  Lifecycle 
SmartLifecycle  --&gt;  Phased 
</code></pre>
<p>它继承了 <code>Lifecycle</code> 接口和 <code>Phased</code> 接口，一共定义了六个方法：</p>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>start()</code></td>
<td style="text-align:center">Spring 刷新上下文的最后一步，Bean 初始化完成后，执行该方法</td>
</tr>
<tr>
<td style="text-align:center"><code>stop()</code></td>
<td style="text-align:center">Spring 容器关闭时，执行 <code>Lifecycle</code> 的 <code>stop()</code> 方法</td>
</tr>
<tr>
<td style="text-align:center"><code>isRunning()</code></td>
<td style="text-align:center">判断当前组件是否在运行</td>
</tr>
<tr>
<td style="text-align:center"><code>getPhase()</code></td>
<td style="text-align:center">存在多个组件时的回调顺序。值越大，越先执行 <code>start()</code> 方法，越晚执行 <code>stop()</code> 方法</td>
</tr>
<tr>
<td style="text-align:center"><code>isAutoStartup()</code></td>
<td style="text-align:center">判断是否需要执行 <code>start()</code> 方法，返回 <code>true</code> 才执行</td>
</tr>
<tr>
<td style="text-align:center"><code>stop(Runnable callback)</code></td>
<td style="text-align:center">Spring 容器关闭时，执行 <code>SmartLifecycle</code> 的 <code>stop(Runnable callback)</code> 方法</td>
</tr>
</tbody>
</table>
<p>对于 <code>SmartLifecycle</code> 来说，在容器关闭时，<strong>只会</strong> 执行它的 <code>stop(Runnable callback)</code> 方法，<strong>不会</strong> 执行 <code>stop()</code> 方法。</p>
<p>和 <code>DisposableBean</code> 的 <code>destroy()</code> 方法类似，两个 <code>stop()</code> 方法也与 SpringBoot Shutdown Hook 有关。</p>
<h2 id="14-2-Lifecycle"><a class="header-anchor" href="#14-2-Lifecycle"></a>14.2 Lifecycle</h2>
<p>先从 <code>Lifecycle</code> 入手，它提供了三个抽象方法，重写它们并将实现类交由 Spring 管理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyLifecycle</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Lifecycle</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> running </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> start</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: lifecycle start</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stop</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: lifecycle stop</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isRunning</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getCurrentThreadName</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> Thread</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">currentThread</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>直接使用 <code>close()</code> 方法关闭 Spring 容器：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A15ExtensionPoint</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ConfigurableApplicationContext</span><span style="color:#E06C75"> context</span><span style="color:#56B6C2"> =</span></span>
<span class="line"><span style="color:#E5C07B">            SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">A15ExtensionPoint</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.exit(0);</span></span>
<span class="line"><span style="color:#E5C07B">        context</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>[main]: lifecycle stop
</pre>
<p>在容器启动时并没有执行 <code>start()</code> 方法，但在容器关闭时执行了 <code>close()</code> 方法。</p>
<p>这是因为在 SpringBoot 应用启动过程中并没有 <strong>显式</strong> 调用 <code>AbstractApplicationContext#start()</code>，而是调用 <code>AbstractApplicationContext#finishRefresh()</code>，但在应用退出（Spring 容器关闭）时会执行 <code>Lifecycle#isRunning()</code> 方法判断组件是否正在运行，如果返回 <code>true</code> 则会调用 <code>Lifecycle#stop()</code> 方法，这些在后续源码分析中介绍。</p>
<p>那么问题来了，要显式调用 <code>AbstractApplicationContext#start()</code> 才会执行 <code>Lifecycle</code> 的 <code>start()</code> 方法，但 SpringBoot 在容器启动时并不会显式调用，那 <code>start()</code> 方法岂不是很尴尬？</p>
<p>此时需要一个更「智能」的类，也就是 <code>SmartLifecycle</code>。</p>
<h2 id="14-3-SmartLifecycle"><a class="header-anchor" href="#14-3-SmartLifecycle"></a>14.3 SmartLifecycle</h2>
<p>它继承了 <code>Lifecycle</code> 和 <code>Phased</code>，相比于 <code>Lifecycle</code>，<code>SmartLifecycle</code> 提供了自动执行 <code>start()</code> 方法的能力，并且具有执行编排（存在多个 <code>SmartLifecycle</code> 时能够控制对应方法的执行顺序）的能力：</p>
<ul>
<li>重写 <code>isAutoStartup()</code> 方法，并返回 <code>true</code>，使得在容器刷新完成后 <strong>自动</strong> 执行 <code>start()</code> 方法；</li>
<li>重写 <code>getPhase()</code> 方法，根据返回值的大小编排多个 <code>SmartLifecycle</code> 的执行顺序，值越大，越先执行 <code>start()</code> 方法，越靠后执行 <code>stop()</code> 方法；</li>
</ul>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> FirstSmartLifecycle</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> SmartLifecycle</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> running </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> start</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: first start</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stop</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 非 SmartLifecycle 的子类才执行</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: first stop</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isRunning</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stop</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Runnable</span><span style="color:#E06C75;font-style:italic"> callback</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: first stop(Runnable)</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 显式调用 callback</span></span>
<span class="line"><span style="color:#E5C07B">        callback</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> getPhase</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> SecondSmartLifecycle</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> SmartLifecycle</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> running </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> start</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: second start</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stop</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: second stop</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isRunning</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stop</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Runnable</span><span style="color:#E06C75;font-style:italic"> callback</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"[%s]: second stop(Runnable)</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getCurrentThreadName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        callback</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> getPhase</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> 2</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<pre>[main]: first start
[main]: second start
[main]: second stop(Runnable)
[main]: first stop(Runnable)
</pre>
<p>对于 <code>SmartLifecycle</code> 来说，在容器关闭时不会执行父类 <code>Lifecycle</code> 的 <code>stop()</code> 方法，而是执行自身提供的 <code>stop(Runnable callback)</code> 方法。</p>
<h2 id="14-4-容器启动时"><a class="header-anchor" href="#14-4-容器启动时"></a>14.4 容器启动时</h2>
<p>在熟悉的 <code>AbstractApplicationContext#refresh()</code> 方法中，所有单例 Bean 都实例化完成后，会执行 <code>finishRefresh()</code> 方法，源码中的注释表明这是 refresh 的最后一步，发布相关的事件：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">// Last step: publish corresponding event.</span></span>
<span class="line"><span style="color:#61AFEF">finishRefresh</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>进入该方法内部：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> finishRefresh</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Clear context-level resource caches (such as ASM metadata from scanning).</span></span>
<span class="line"><span style="color:#61AFEF">   clearResourceCaches</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Initialize lifecycle processor for this context.</span></span>
<span class="line"><span style="color:#61AFEF">   initLifecycleProcessor</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Propagate refresh to lifecycle processor first.</span></span>
<span class="line"><span style="color:#61AFEF">   getLifecycleProcessor</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">onRefresh</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   // Publish the final event.</span></span>
<span class="line"><span style="color:#61AFEF">   publishEvent</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> ContextRefreshedEvent</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>重点放在中间的两步，它们一个用于初始化 <code>Lifecycle</code> 处理器，一个用于调用 <code>Lifecycle</code> 处理器的 <code>onRefresh()</code> 方法。</p>
<blockquote>
<p><code>initLifecycleProcessor()</code></p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Nullable</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> LifecycleProcessor</span><span style="color:#E06C75"> lifecycleProcessor</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> LIFECYCLE_PROCESSOR_BEAN_NAME </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "lifecycleProcessor"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">// --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> initLifecycleProcessor</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    ConfigurableListableBeanFactory</span><span style="color:#E06C75"> beanFactory </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getBeanFactory</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">containsLocalBean</span><span style="color:#ABB2BF">(LIFECYCLE_PROCESSOR_BEAN_NAME)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#56B6C2"> =</span></span>
<span class="line"><span style="color:#E5C07B">            beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(LIFECYCLE_PROCESSOR_BEAN_NAME, </span><span style="color:#E5C07B">LifecycleProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        DefaultLifecycleProcessor</span><span style="color:#E06C75"> defaultProcessor </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> DefaultLifecycleProcessor</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        defaultProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setBeanFactory</span><span style="color:#ABB2BF">(beanFactory);</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> defaultProcessor</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        beanFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerSingleton</span><span style="color:#ABB2BF">(LIFECYCLE_PROCESSOR_BEAN_NAME, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>方法内部逻辑比较简单，首先获取 <code>BeanFactory</code>，判断容器中是否存在名为 <code>lifecycleProcessor</code> 的 Bean：</p>
<ul>
<li>如果存在，就获取这个 Bean，并将其赋值给成员变量 <code>this.lifecycleProcessor</code>；</li>
<li>如果不存在，自行实例化 <code>DefaultLifecycleProcessor</code>，将其赋值给成员变量 <code>this.lifecycleProcessor</code>，然后再把这个对象注册到 Spring 容器中。</li>
</ul>
<p>现在已经拿到了 <code>LifecycleProcessor</code>，接下来就是调用它的 <code>onRefresh()</code> 方法了。</p>
<blockquote>
<p><code>getLifecycleProcessor().onRefresh()</code></p>
</blockquote>
<p>来到 <code>DefaultLifecycleProcessor#onRefresh()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onRefresh</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#61AFEF">   startBeans</span><span style="color:#E06C75">(</span><span style="color:#D19A66">true</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">   this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再进入 <code>startBeans()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> startBeans</span><span style="color:#E06C75">(</span><span style="color:#C678DD">boolean</span><span style="color:#E06C75"> autoStartupOnly) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取所有 Lifecycle 类型的 Bean，key 为 Bean 的 name</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Lifecycle</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lifecycleBeans </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getLifecycleBeans</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // LifecycleGroup 是对一组 Lifecycle 的封装，可以看成是 List&lt;Lifecycle&gt;</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> LifecycleGroup</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> phases </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> TreeMap</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 遍历这些 Bean</span></span>
<span class="line"><span style="color:#E5C07B">    lifecycleBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forEach</span><span style="color:#ABB2BF">((beanName, bean) </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // autoStartupOnly == true</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 判断 Bean 是否是 SmartLifecycle 类型，并且其 isAutoStartup() 方法是否返回 true</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 这里只针对 SmartLifecycle 进行了判断，这也是没有执行 Lifecycle#start() 方法的原因 </span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#56B6C2">!</span><span style="color:#ABB2BF">autoStartupOnly </span><span style="color:#56B6C2">||</span><span style="color:#ABB2BF"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> SmartLifecycle</span><span style="color:#ABB2BF"> smartLifecycle </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#E5C07B"> smartLifecycle</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isAutoStartup</span><span style="color:#ABB2BF">())) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 获取 phase 值，SmartLifecycle 继承了 Phased，实现类可以设置 phase 值</span></span>
<span class="line"><span style="color:#C678DD">            int</span><span style="color:#E06C75"> phase</span><span style="color:#56B6C2"> =</span><span style="color:#61AFEF"> getPhase</span><span style="color:#ABB2BF">(bean);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 将相同 phase 值的 Bean 分在一组</span></span>
<span class="line"><span style="color:#E5C07B">            phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">computeIfAbsent</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#ABB2BF">                phase,</span></span>
<span class="line"><span style="color:#ABB2BF">                p </span><span style="color:#C678DD">-&gt;</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> LifecycleGroup</span><span style="color:#ABB2BF">(phase, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">timeoutPerShutdownPhase</span><span style="color:#ABB2BF">, lifecycleBeans, autoStartupOnly)</span></span>
<span class="line"><span style="color:#ABB2BF">            ).</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(beanName, bean);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    });</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 执行每组 SmartLifecycle 的 start 方法</span></span>
<span class="line"><span style="color:#E5C07B">        phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">values</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">forEach</span><span style="color:#ABB2BF">(LifecycleGroup</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">start);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>获取到所有 <code>Lifecycle</code> 后，对它们进行过滤并分组，然后执行它们的 <code>start()</code> 方法。执行逻辑由 <code>LifecycleGroup#start()</code> 完成：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> start</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // this.members 就是每组 Lifecycle</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 只不过将 Bean 的 name 和 Bean 实例又包成了 LifecycleGroupMember 对象</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">members</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isDebugEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">debug</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Starting beans in phase "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">phase</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // LifecycleGroupMember 实现了 Comparable 接口，按 phased 值升序排序</span></span>
<span class="line"><span style="color:#E5C07B">    Collections</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">sort</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">members</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">LifecycleGroupMember</span><span style="color:#E06C75"> member </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">members</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 执行 start() 方法</span></span>
<span class="line"><span style="color:#61AFEF">        doStart</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleBeans</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> member</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">autoStartupOnly</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对每组 <code>Lifecycle</code> 按 <code>phased</code> 值升序排序，排序完成后依次调用 <code>doStart()</code> 方法。Spring 中喜欢将真正执行逻辑的方法名以 <code>do</code> 开头，可以断定此处的 <code>doStart()</code> 方法是真的用来执行 <code>Lifecycle#start()</code> 方法的：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> doStart</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Map</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> ?</span><span style="color:#E06C75"> extends Lifecycle</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> lifecycleBeans</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> autoStartupOnly) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 先从集合中移除要执行 start() 方法的 Lifecycle</span></span>
<span class="line"><span style="color:#E5C07B">    Lifecycle</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> lifecycleBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 成功移除，并且移除的不是当前 DefaultLifecycleProcessor 实例</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (bean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">!=</span><span style="color:#E5C07B"> this</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 获取依赖了当前 Bean 的 Bean</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75">[] dependenciesForBean </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getBeanFactory</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDependenciesForBean</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> dependency </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> dependenciesForBean) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 递归调用，优先执行依赖了当前 Bean 的 Bean 的 start() 方法</span></span>
<span class="line"><span style="color:#61AFEF">            doStart</span><span style="color:#E06C75">(lifecycleBeans</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> dependency</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> autoStartupOnly)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Bean 不处于运行状态</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isRunning</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // autoStartupOnly 是 false，但传入的 true，这个条件不满足</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // Bean 不是 SmartLifecycle 实例，这也不满足，这些 Bean 都是 SmartLifecycle 实例</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // SmartLifecycle 的 isAutoStartup() 方法返回 true</span></span>
<span class="line"><span style="color:#E06C75">            (</span><span style="color:#56B6C2">!</span><span style="color:#E06C75">autoStartupOnly </span><span style="color:#56B6C2">||</span><span style="color:#56B6C2"> !</span><span style="color:#E06C75">(bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> SmartLifecycle</span><span style="color:#E06C75"> smartLifecycle) </span><span style="color:#56B6C2">||</span><span style="color:#E5C07B"> smartLifecycle</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isAutoStartup</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 省略日志的打印</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 调用 start() 方法</span></span>
<span class="line"><span style="color:#E5C07B">                bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">start</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 抛了个 ApplicationContextException</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>先获取 Bean 的依赖项，递归调用执行依赖项的 <code>start()</code> 方法，之后才执行 <code>start()</code> 方法。</p>
<h2 id="14-5-容器关闭时"><a class="header-anchor" href="#14-5-容器关闭时"></a>14.5 容器关闭时</h2>
<p>在分析 <code>DisposableBean</code> 的执行逻辑时，调用的 <code>AbstractApplicationContext#close()</code> 方法又会调用 <code>AbstractApplicationContext#doClose()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> doClose</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Check whether an actual close attempt is necessary...</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">active</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">closed</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">compareAndSet</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Stop all Lifecycle beans, to avoid delays during individual destruction.</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">                this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleProcessor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">onClose</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>内部会调用 <code>this.lifecycleProcessor.onClose()</code>，通过前文的分析可知，这里调用的是 <code>DefaultLifecycleProcessor</code> 的 <code>onClose()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onClose</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#61AFEF">   stopBeans</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">   this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">running</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再进入 <code>stopBeans()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stopBeans</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Lifecycle</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lifecycleBeans </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getLifecycleBeans</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> LifecycleGroup</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> phases </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> HashMap</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    lifecycleBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forEach</span><span style="color:#ABB2BF">((beanName, bean) </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> shutdownPhase</span><span style="color:#56B6C2"> =</span><span style="color:#61AFEF"> getPhase</span><span style="color:#ABB2BF">(bean);</span></span>
<span class="line"><span style="color:#E5C07B">        LifecycleGroup</span><span style="color:#E06C75"> group</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(shutdownPhase);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (group </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            group </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> LifecycleGroup</span><span style="color:#ABB2BF">(shutdownPhase, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">timeoutPerShutdownPhase</span><span style="color:#ABB2BF">, lifecycleBeans, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(shutdownPhase, group);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#E5C07B">        group</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(beanName, bean);</span></span>
<span class="line"><span style="color:#ABB2BF">    });</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> keys </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">keySet</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        keys</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">sort</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collections</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">reverseOrder</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Integer</span><span style="color:#E06C75"> key </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> keys) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 执行每组 LifecycleGroup 的 stop() 方法</span></span>
<span class="line"><span style="color:#E5C07B">            phases</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(key).</span><span style="color:#61AFEF">stop</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这里和前文的 <code>startBeans(boolean autoStartupOnly)</code> 方法很类似，对容器中的所有 <code>Lifecycle</code> 按 <code>phased</code> 值进行分组，逆序排序后一一执行。</p>
<p>说句题外话：<code>stopBeans()</code> 的实现其实可以 <code>startBeans()</code> 保持一致，即引入 <code>TreeMap</code>，更简单地使用 <code>Map#computeIfAbsent()</code> 实现分组，但我发现这点并想向 Spring 提交 PR 时，却发现在 4 月已经存在被合并的相关 <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/pull/30361">PR</a>，可惜向 Spring 提交 PR 的计划泡汤了。本文使用的 Spring 版本是此时最新的 6.0.12，不知道修改会在哪个版本上生效呢？👻</p>
<p>回到正题，继续看 <code>LifecycleGroup#stop()</code> 里的逻辑：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> stop</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">members</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 省略日志的打印</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 逆序排序（已经排序，没有意义）</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">members</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">sort</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collections</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">reverseOrder</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 引入 CountDownLatch，数量等于当前 Lifecycle 分组中元素的数量</span></span>
<span class="line"><span style="color:#E5C07B">    CountDownLatch</span><span style="color:#E06C75"> latch </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> CountDownLatch</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">smartMemberCount</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 再引入同步 Set，这玩意其实是用来记录日志的，主要逻辑和它关系不大</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> countDownBeanNames </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Collections</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">synchronizedSet</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#E5C07B"> LinkedHashSet</span><span style="color:#ABB2BF">&lt;&gt;());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 包含当前 Lifecycle 分组中所有 Bean 的 name</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lifecycleBeanNames </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> HashSet</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">keySet</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">LifecycleGroupMember</span><span style="color:#E06C75"> member </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">members</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">lifecycleBeanNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">member</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#61AFEF">            doStop</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lifecycleBeans</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> member</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> latch</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> countDownBeanNames)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">member</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">bean</span><span style="color:#C678DD"> instanceof</span><span style="color:#E06C75"> SmartLifecycle) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // Already removed: must have been a dependent bean from another phase</span></span>
<span class="line"><span style="color:#E5C07B">            latch</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">countDown</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 阻塞下，直到所有 Lifecycle 都执行完或者达到指定超时时间，默认 30 秒</span></span>
<span class="line"><span style="color:#E5C07B">        latch</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">await</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">timeout</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">TimeUnit</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">MILLISECONDS</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">InterruptedException</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        Thread</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">currentThread</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">interrupt</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这个方法内部有两个要点：</p>
<ol>
<li>引入 <code>CountDownLatch</code>；</li>
<li>引入 <code>lifecycleBeanNames</code>，并在遍历每个 <code>Lifecycle</code> 时，执行 <code>contains()</code> 方法。</li>
</ol>
<p>为了提高执行效率，在实现 <code>SmartLifecycle</code> 接口重写 <code>stop(Runnable callback)</code> 方法时，可以开一个线程中执行内部逻辑，使多个 <code>SmartLifecycle</code> 的 <code>stop()</code> 方法并行执行。</p>
<p>当前线程必须等待所有执行 <code>stop()</code> 方法的线程执行完才继续向下执行，因此引入了 <code>CountDownLatch</code>。</p>
<p>假设有两个 Bean 分别叫 A 和 B，A 依赖了 B，但 A 的 <code>phased</code> 小于 B，因此会先执行 B 的 <code>stop()</code> 方法。在执行了 B 的 <code>stop()</code> 方法时，发现 A 依赖了它，于是会更先一步执行 A 的 <code>stop()</code> 方法，之后再执行 B 的 <code>stop()</code> 方法。等到 B 的 <code>stop()</code> 执行完，按照 <code>phased</code> 的大小，接下来应该执行 A 的 <code>stop()</code> 方法，但由于 A 的 <code>stop()</code> 方法在先前已经执行过了，再来一遍肯定是不合适的，因此引入 <code>lifecycleBeanNames</code> 判断 A 不在该集合中，那么直接执行 <code>CountDownLatch#countDown()</code> 即可。这里涉及到 <code>doStop()</code> 方法的分析，它内部有什么奥秘呢？</p>
<p>与 <code>doStart()</code> 方法类似，<code>doStop()</code> 也是用来真正执行 <code>Lifecycle#stop()</code> 的，其处理逻辑也和 <code>doStart()</code> 类似：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> doStop</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Map</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> ?</span><span style="color:#E06C75"> extends Lifecycle</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> lifecycleBeans</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> beanName</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C678DD">                    final</span><span style="color:#E5C07B"> CountDownLatch</span><span style="color:#E06C75"> latch</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Set</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> countDownBeanNames) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 先从集合中移除要执行 stop() 方法的 Lifecycle</span></span>
<span class="line"><span style="color:#E5C07B">    Lifecycle</span><span style="color:#E06C75"> bean </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> lifecycleBeans</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (bean </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 和 doStart() 方法类似，先处理依赖了当前 Bean 的 Bean</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75">[] dependentBeans </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getBeanFactory</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDependentBeans</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> dependentBean </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> dependentBeans) {</span></span>
<span class="line"><span style="color:#61AFEF">            doStop</span><span style="color:#E06C75">(lifecycleBeans</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> dependentBean</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> latch</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> countDownBeanNames)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 如果 Bean 正在运行</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isRunning</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // Bean 还是 SmartLifecycle 类型</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E5C07B"> SmartLifecycle</span><span style="color:#E06C75"> smartLifecycle) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 省略日志的打印</span></span>
<span class="line"><span style="color:#E5C07B">                    countDownBeanNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 执行 SmartLifecycle 的 stop(Runnable) 方法</span></span>
<span class="line"><span style="color:#E5C07B">                    smartLifecycle</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stop</span><span style="color:#ABB2BF">(() </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 内部调用了 CountDownLatch#countDown()</span></span>
<span class="line"><span style="color:#E5C07B">                        latch</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">countDown</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">                        countDownBeanNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">remove</span><span style="color:#ABB2BF">(beanName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 省略日志的打印</span></span>
<span class="line"><span style="color:#ABB2BF">                    });</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#C678DD">                else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 省略日志的打印</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 不是 SmartLifecycle 类型，直接调用 stop() 方法</span></span>
<span class="line"><span style="color:#E5C07B">                    bean</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stop</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (bean </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> SmartLifecycle) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // Don't wait for beans that aren't running...</span></span>
<span class="line"><span style="color:#E5C07B">                latch</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">countDown</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> ex</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 省略日志的打印</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>实现还是比较简单，但有一个重要的注意点：如果 Bean 的类型是 <code>SmartLifecycle</code> 时，传入了一个 <code>Runnable</code>，并且 <strong>在 <code>Runnable</code> 中执行了 <code>CountDownLatch#countDown()</code></strong>，这要求 <mark>在重写 <code>stop(Runnable callback)</code> 方法时一定要在内部调用 <code>callback.run()</code></mark>，否则 <code>CountDownLatch</code> 的计数减不下去，就会在达到设置的超时时间前一直阻塞线程。</p>
<h1 id="15-Spring-生命周期"><a class="header-anchor" href="#15-Spring-生命周期"></a>15. Spring 生命周期</h1>
<p>Spring 的生命周期，其实指的是 Spring Bean 的生命周期，Bean 的生命周期概括起来共三步：</p>
<ol>
<li>将 Java 类抽象为 <code>BeanDefinition</code> 对象；</li>
<li>根据 <code>BeanDefinition</code> 对象完成 Bean 的实例化、初始化和其他拓展操作；</li>
<li>使用 Spring 管理的 Bean，直至销毁。</li>
</ol>
<p>前文花了大量篇幅介绍 SpringBoot 的拓展点，而这些拓展点是贯穿 Bean 的生命周期的，按照执行先后可以绘制出包含大多数拓展点的执行流程图：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SpringBootImages/SpringBoot%E6%8B%93%E5%B1%95%E7%82%B9%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="SpringBoot拓展点流程图"></p>
<h1 id="16-总结"><a class="header-anchor" href="#16-总结"></a>16. 总结</h1>
<p>本文介绍了 BeanFactory 周围、Bean 实例化周围、Bean 初始化周围共十多个拓展点，每个拓展点分为作用、使用方式、实例化（注册）、执行、内置实现等小节，并结合源码进行讲解，最终将这些拓展点汇总指向 Spring Bean 的生命周期。</p>
<p>行文过程中留下了一些坑：</p>
<ul>
<li><code>getBean()</code> 方法源码分析</li>
<li>AOP 源码分析</li>
<li>Spring 循环依赖源码分析</li>
<li><a href="../SpringBoot-Shutdown-Hook">Spring Shutdown Hook</a></li>
</ul>
<p>这些内容慢慢来吧，今年应该能够整完？！ 🤔</p>
</body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/">https://mofan212.github.io/posts/Common-Extension-Points-In-Spring-Boot/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Boot/">Spring-Boot</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg" data-sites="wechat,qq,weibo,facebook,x"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Configuration-Annotation/" title="@Configuration 注解的那些事"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/25.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">@Configuration 注解的那些事</div></div><div class="info-2"><div class="info-item-1">从源码层面介绍 @Configuration 注解的 Full 模式与 Lite 模式。</div></div></div></a><a class="pagination-related" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/141.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">SpringBoot Shutdown Hook</div></div><div class="info-2"><div class="info-item-1">介绍了 System.exit() 方法的源码、SpringBoot 优雅停机等内容。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/From-Callback-To-LambdaSafe/" title="从回调到 LambdaSafe"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/131.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-12</div><div class="info-item-2">从回调到 LambdaSafe</div></div><div class="info-2"><div class="info-item-1">什么是回调？Spring 提供的 LambdaSafe 工具类如何使用？</div></div></div></a><a class="pagination-related" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/154.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-26</div><div class="info-item-2">Spring 配置类的解析</div></div><div class="info-2"><div class="info-item-1">深入理解 ConfigurationClassPostProcessor，理清 Spring 配置类的解析。</div></div></div></a><a class="pagination-related" href="/posts/Principles-Of-SpringBoot/" title="SpringBoot原理"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/23.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-29</div><div class="info-item-2">SpringBoot原理</div></div><div class="info-2"><div class="info-item-1">误人子弟系列，不要看，后续找个时间重写。😶</div></div></div></a><a class="pagination-related" href="/posts/Configuration-Annotation/" title="@Configuration 注解的那些事"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/25.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-23</div><div class="info-item-2">@Configuration 注解的那些事</div></div><div class="info-2"><div class="info-item-1">从源码层面介绍 @Configuration 注解的 Full 模式与 Lite 模式。</div></div></div></a><a class="pagination-related" href="/posts/SpringBoot-Data/" title="SpringBoot与数据库"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/27.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-10</div><div class="info-item-2">SpringBoot与数据库</div></div><div class="info-2"><div class="info-item-1">本文基于 SpringBoot 2.2.4 ，介绍了 SpringBoot 如何整合数据库。</div></div></div></a><a class="pagination-related" href="/posts/SpringBoot-Advanced-Use/" title="SpringBoot进阶应用"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/29.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-13</div><div class="info-item-2">SpringBoot进阶应用</div></div><div class="info-2"><div class="info-item-1">本文介绍了如何使用 Swagger，如何实现异步任务、邮件发送、定时任务，如何整合Dubbo和ZooKeeper。</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a href="./mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0. 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8"><span class="toc-text">1. 应用上下文初始化器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">1.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">1.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">1.3 实例化与执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.4 内置实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Bean-%E5%B7%A5%E5%8E%82%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">2. Bean 工厂后置处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">2.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">2.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3"><span class="toc-text">2.3 执行入口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="toc-text">2.4 第二个参数的来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E6%89%A7%E8%A1%8C%E7%9A%84%E9%80%BB%E8%BE%91"><span class="toc-text">2.5 执行的逻辑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Bean-%E5%AE%9A%E4%B9%89%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">3. Bean 定义注册表后置处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">3.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">3.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%A0%E4%B8%AA%E7%B1%BB"><span class="toc-text">3.3 相关的几个类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">3.4 实例化与执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.5 内置实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Bean-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">4. Bean 后置处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">4.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">4.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">4.3 注册与执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">4.4 内置实现与使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E6%9B%B4%E5%A4%9A%E6%80%9D%E8%80%83"><span class="toc-text">4.5 更多思考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%84%9F%E7%9F%A5-Bean-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">5. 实例化感知 Bean 后置处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">5.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">5.2 使用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%B3%A8%E5%86%8C"><span class="toc-text">5.3 注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%89%A7%E8%A1%8C"><span class="toc-text">5.4 执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.5 内置实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%99%BA%E8%83%BD%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%84%9F%E7%9F%A5-Bean-%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">6. 智能实例化感知 Bean 后置处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">6.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">6.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%B3%A8%E5%86%8C"><span class="toc-text">6.3 注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E6%89%A7%E8%A1%8C"><span class="toc-text">6.4 执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">6.5 内置实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E6%84%9F%E7%9F%A5"><span class="toc-text">7. 应用上下文感知</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">7.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">7.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E6%B3%A8%E5%86%8C%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-text">7.3 注册与执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E4%B8%80%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">7.4 一个重要的细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E5%8F%A6%E4%B8%80%E4%B8%AA-Aware"><span class="toc-text">7.5 另一个 Aware</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-PostConstruct"><span class="toc-text">8. @PostConstruct</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">8.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">8.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">8.3 执行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E5%88%9D%E5%A7%8B%E5%8C%96-Bean"><span class="toc-text">9. 初始化 Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">9.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">9.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">9.3 执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E5%86%85%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">9.4 内置实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%99%BA%E8%83%BD%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8D%95%E4%BE%8B"><span class="toc-text">10. 智能初始化单例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">10.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">10.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">10.3 执行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E4%B8%A4%E4%B8%AA%E8%BF%90%E8%A1%8C%E5%99%A8"><span class="toc-text">11. 两个运行器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">11.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">11.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">11.3 执行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E5%B7%A5%E5%8E%82-Bean"><span class="toc-text">12. 工厂 Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">12.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">12.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3-%E6%B3%A8%E5%86%8C"><span class="toc-text">12.3 注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-4-%E6%89%A7%E8%A1%8C"><span class="toc-text">12.4 执行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E5%8F%AF%E9%94%80%E6%AF%81-Bean"><span class="toc-text">13. 可销毁 Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">13.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">13.2 使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-%E6%89%A7%E8%A1%8C"><span class="toc-text">13.3 执行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-%E6%99%BA%E8%83%BD%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">14. 智能生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-%E6%8B%93%E5%B1%95%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">14.1 拓展点的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-Lifecycle"><span class="toc-text">14.2 Lifecycle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-3-SmartLifecycle"><span class="toc-text">14.3 SmartLifecycle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-4-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E6%97%B6"><span class="toc-text">14.4 容器启动时</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-5-%E5%AE%B9%E5%99%A8%E5%85%B3%E9%97%AD%E6%97%B6"><span class="toc-text">14.5 容器关闭时</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-Spring-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">15. Spring 生命周期</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16-%E6%80%BB%E7%BB%93"><span class="toc-text">16. 总结</span></a></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>SpringBoot 源码剖析</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/From-Callback-To-LambdaSafe/" title="从回调到 LambdaSafe"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/131.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="从回调到 LambdaSafe"></a><div class="content"><a class="title" href="/posts/From-Callback-To-LambdaSafe/" title="从回调到 LambdaSafe">从回调到 LambdaSafe</a><time datetime="2023-03-11T16:00:00.000Z" title="发表于 2023-03-12 00:00:00">2023-03-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Get-ApplicationContext/" title="获取 ApplicationContext"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/139.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="获取 ApplicationContext"></a><div class="content"><a class="title" href="/posts/Get-ApplicationContext/" title="获取 ApplicationContext">获取 ApplicationContext</a><time datetime="2023-09-19T16:00:00.000Z" title="发表于 2023-09-20 00:00:00">2023-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Configuration-Annotation/" title="@Configuration 注解的那些事"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/25.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="@Configuration 注解的那些事"></a><div class="content"><a class="title" href="/posts/Configuration-Annotation/" title="@Configuration 注解的那些事">@Configuration 注解的那些事</a><time datetime="2023-09-22T16:00:00.000Z" title="发表于 2023-09-23 00:00:00">2023-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Common-Extension-Points-In-Spring-Boot/" title="SpringBoot 常用拓展点"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="SpringBoot 常用拓展点"></a><div class="content"><a class="title" href="/posts/Common-Extension-Points-In-Spring-Boot/" title="SpringBoot 常用拓展点">SpringBoot 常用拓展点</a><time datetime="2023-10-02T16:00:00.000Z" title="发表于 2023-10-03 00:00:00">2023-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/141.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="SpringBoot Shutdown Hook"></a><div class="content"><a class="title" href="/posts/SpringBoot-Shutdown-Hook/" title="SpringBoot Shutdown Hook">SpringBoot Shutdown Hook</a><time datetime="2023-10-14T16:00:00.000Z" title="发表于 2023-10-15 00:00:00">2023-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Application-Event/" title="Spring 的事件监听机制"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/151.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Spring 的事件监听机制"></a><div class="content"><a class="title" href="/posts/Spring-Application-Event/" title="Spring 的事件监听机制">Spring 的事件监听机制</a><time datetime="2024-07-13T16:00:00.000Z" title="发表于 2024-07-14 00:00:00">2024-07-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-BeanDefinition/" title="BeanDefinition"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/153.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="BeanDefinition"></a><div class="content"><a class="title" href="/posts/Spring-BeanDefinition/" title="BeanDefinition">BeanDefinition</a><time datetime="2024-08-10T16:00:00.000Z" title="发表于 2024-08-11 00:00:00">2024-08-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/154.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Spring 配置类的解析"></a><div class="content"><a class="title" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析">Spring 配置类的解析</a><time datetime="2024-10-25T16:00:00.000Z" title="发表于 2024-10-26 00:00:00">2024-10-26</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Something-About-Blog/" title="博客搭建与维护"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/42.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="博客搭建与维护"/></a><div class="content"><a class="title" href="/posts/Something-About-Blog/" title="博客搭建与维护">博客搭建与维护</a><time datetime="2026-01-24T16:00:00.000Z" title="更新于 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 内存模型"/></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java 内存模型">Java 内存模型</a><time datetime="2026-01-02T16:00:00.000Z" title="更新于 2026-01-03 00:00:00">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="字节码与类加载"/></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载">字节码与类加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 的类资源加载"/></a><div class="content"><a class="title" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载">Java 的类资源加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/20.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="注解、类的加载、反射"/></a><div class="content"><a class="title" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射">注解、类的加载、反射</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ren-zhi-jue-xing/" title="认知觉醒"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/172.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="认知觉醒"/></a><div class="content"><a class="title" href="/posts/ren-zhi-jue-xing/" title="认知觉醒">认知觉醒</a><time datetime="2025-12-28T16:00:00.000Z" title="更新于 2025-12-29 00:00:00">2025-12-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By 默烦</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://testingcf.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://gcore.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script src="/js/tip_portal.js"></script><script defer="defer" id="ribbon" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://testingcf.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>