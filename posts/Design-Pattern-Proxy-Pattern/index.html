<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【设计模式】代理模式 | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文对 Java 设计模式中的代理模式进行了介绍，重点介绍了 JDK 动态代理模式和 CGLib 动态代理模式。">
<meta property="og:type" content="article">
<meta property="og:title" content="【设计模式】代理模式">
<meta property="og:url" content="https://mofan212.github.io/posts/Design-Pattern-Proxy-Pattern/index.html">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="本文对 Java 设计模式中的代理模式进行了介绍，重点介绍了 JDK 动态代理模式和 CGLib 动态代理模式。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/19.png">
<meta property="article:published_time" content="2020-05-27T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-18T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="DesignPattern">
<meta property="article:tag" content="CGLib">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/19.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "【设计模式】代理模式",
  "url": "https://mofan212.github.io/posts/Design-Pattern-Proxy-Pattern/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/19.png",
  "datePublished": "2020-05-27T16:00:00.000Z",
  "dateModified": "2023-09-18T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Design-Pattern-Proxy-Pattern/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const hour = new Date().getHours()
          const isNight = hour <= 6 || hour >= 18
          if (theme === undefined) isNight ? activateDarkMode() : activateLightMode()
          else theme === 'light' ? activateLightMode() : activateDarkMode()
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://fastly.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【设计模式】代理模式',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://cdn.staticfile.net/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/fontsource-noto-sans-sc@4.0.0/index.min.css" /><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://fastly.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">159</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a><a class="nav-page-title" href="/"><span class="site-name">【设计模式】代理模式</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">【设计模式】代理模式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-27T16:00:00.000Z" title="发表于 2020-05-28 00:00:00">2020-05-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-18T16:00:00.000Z" title="更新于 2023-09-19 00:00:00">2023-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DesignPattern/">DesignPattern</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2023-09-19 00:00:00&quot;}" hidden></div><p>封面来源：<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/proxy">代理设计模式 (refactoringguru.cn)</a>，如有侵权，请联系删除。</p>
<p>Java 设计模式学习网站：<a target="_blank" rel="noopener" href="http://c.biancheng.net/design_pattern/">Java设计模式：23种设计模式全面解析（超级详细）</a></p>
<p>菜鸟教程：<a target="_blank" rel="noopener" href="https://www.runoob.com/design-pattern/proxy-pattern.html">代理模式</a></p>
<p>Bilibili 视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV185411477k?p=63">孙哥说Spring5 全部更新完毕 完整笔记、代码看置顶评论链接～学不会Spring? 因为你没找对人</a></p>
<h1 id="1-问题的引入"><a class="header-anchor" href="#1-问题的引入"></a>1. 问题的引入</h1>
<h2 id="1-1-软件开发中的矛盾"><a class="header-anchor" href="#1-1-软件开发中的矛盾"></a>1.1 软件开发中的矛盾</h2>
<p>在 JavaEE 分层开发中，我们一般分成三层，分别是 Controller 层、Service 层和 DAO 层，其中最为重要的是 Service 层。</p>
<p>那么 Service 层中包含了哪些代码？</p>
<p>在 Service 层中主要包含 <strong>核心功能</strong>（几十、上百行代码）和 <strong>额外功能</strong>（一小部分代码）。其中额外功能包括业务运算和 DAO 调用，这也是 Service 层中的重头戏，而额外功能不属于业务，甚至可有可无，因此代码量也很小，比如事务、日志、性能监控的代码都属于额外功能。</p>
<p>那么问题又来了，将 <strong>额外功能</strong> 写在 Service 层中好不好呢？</p>
<p>好不好的讨论得看站在哪个角度。</p>
<p>如果站在 Service 层的调用者（Controller 层）角度来看：就 Controller 层而言，无论 Service 层有没有其他的额外功能，事务的额外功能肯定是要有的，因此对于其调用者而言，额外功能的书写是必要的。</p>
<p>但如果站在软件设计者的角度来看：由于额外功能是可有可无的，当需要额外功能的时候，可以按照需求在 Service 层中编写相关代码，但是当额外功能不需要的时候，难道要到 Service 层中删除额外功能的代码吗？这显然是不行的，因为这样降低了代码的维护性，因此就软件设计者而言，额外功能写在 Service 层中是不好的。</p>
<p>在此，我们能发现一个矛盾：<strong>额外功能对 Controller 层来说是需要的，但对软件设计者来说在 Service 层中书写额外功能又是不好的。</strong></p>
<p>那有没有什么办法能解决这个问题呢？</p>
<h2 id="1-2-现实生活中的解决方案"><a class="header-anchor" href="#1-2-现实生活中的解决方案"></a>1.2 现实生活中的解决方案</h2>
<img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/DesignPatternImages/房客租房.png" alt="房客租房" style="zoom:80%;" />
<p>上图是一个现实生活中很常见的场景：房客如果需要租房，那么就需要找房东租房。这个时候，<strong>房客相当于调用者，而房东相当于 Service。</strong> 房东这个 Service 中拥有一个名为 <strong>出租房屋</strong> 的 Method，在这个 Method 中核心功能是签合同和收钱，这点是毋庸置疑的，而额外功能是投放广告和带房客看房。</p>
<p>假设有一天房东不想干了，房东只想和房客签合同并收钱，不想在到处投放广告、带房客看房了，但这对房客来说现实吗？</p>
<p>对于房客这个调用者来说，额外功能是十分必要的。如果不投放广告，房客怎么知道房东有房源呢？房东不带房客看房，房客又怎么敢和房东签合同，房东又怎么收钱呢？</p>
<p>这个时候也出现了一个矛盾：<strong>额外功能对于调用者来说是必要的，但又不想把额外功能放在 Service 层中。</strong></p>
<img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/DesignPatternImages/租房场景改造.png" alt="租房场景改造" style="zoom: 80%;" />
<p>在现实生活中，为了解决这个矛盾就会引入另一个角色：中介。 <strong>此时房客不会直接向房东租房，而是向中介租房。</strong> 由中介进行投放广告和带房客看房等额外功能，当房客对房源满意后，也是和中介签订合同，只不过中介的出租房屋 Method 内部调用了房东出租房屋，因为中介并没有实际的房产证，是无法签订合同的，只是作为实际房东的代理。</p>
<p><strong>那如果要更换额外功能呢？只需要更换一个中介即可，并不会在原有中介上进行“修改”。</strong></p>
<p><mark>注意：</mark> 中介（代理类）中的方法要和房东（目标类、原始类）中的方法签名一样（实现相同的接口），这样可以“迷惑”房客。新引入的中介（代理类）中既有额外功能，也调用了房东（目标类、原始类）的核心功能。</p>
<h1 id="2-模式的定义与特点"><a class="header-anchor" href="#2-模式的定义与特点"></a>2. 模式的定义与特点</h1>
<p>代理模式（Proxy）：由于某些原因需要给某对象提供一个代理以控制对该对象的访问。这时访问对象不适合或者不能直接引用目标对象，代理对象作为访问对象和目标对象之间的中介。这种类型的设计模式属于结构型模式。</p>
<p>在代理模式中，我们创建具有现有对象的对象，以便向外界提供功能接口。</p>
<blockquote>
<p>优点</p>
</blockquote>
<p>1、代理模式在客户端与目标对象之间起到一个中介作用和保护目标对象的作用；</p>
<p>2、代理对象可以扩展目标对象的功能；</p>
<p>3、代理模式能将客户端与目标对象分离，在一定程度上降低了系统的耦合度，增加了程序的可扩展性。</p>
<blockquote>
<p>缺点</p>
</blockquote>
<p>1、代理模式会造成系统设计中类的数量增加；</p>
<p>2、在客户端和目标对象之间增加一个代理对象，会造成请求处理速度变慢；</p>
<p>3、增加了系统的复杂度。</p>
<blockquote>
<p>代理模式的分类</p>
</blockquote>
<p>根据代理的创建时期，代理模式分为 <strong>静态代理</strong> 和 <strong>动态代理</strong>。</p>
<p>静态代理：由程序员创建代理类或特定工具自动生成源代码再对其编译，在程序运行前代理类的 .class 文件就已经存在了。</p>
<p>动态代理：在程序运行时，运用反射机制动态创建而成。</p>
<p>上述所列举的缺点也是针对 <strong>静态代理</strong> 而言的，<strong>动态代理</strong> 从一定程度上消除了以上缺点。</p>
<blockquote>
<p>与其他模式的区别</p>
</blockquote>
<p>1、与【适配器模式】的区别：适配器模式主要改变所考虑对象的接口，而代理模式不能改变所代理类的接口。</p>
<p>2、与【装饰器模式】的区别：装饰器模式为了增强功能，而代理模式是为了加以控制。</p>
<h1 id="3-模式的应用场景"><a class="header-anchor" href="#3-模式的应用场景"></a>3. 模式的应用场景</h1>
<p>当无法或不想直接引用某个对象或访问某个对象存在困难时，可以通过代理对象来间接访问。使用【代理模式】主要有两个目的：一是保护目标对象，二是增强目标对象。</p>
<p>【代理模式】主要有以下应用场景：</p>
<p>1、远程代理，这种方式通常是为了隐藏目标对象存在于不同地址空间的事实，方便客户端访问。例如，用户申请某些网盘空间时，会在用户的文件系统中建立一个虚拟的硬盘，用户访问虚拟硬盘时实际访问的是网盘空间。</p>
<p>2、虚拟代理，这种方式通常用于要创建的目标对象开销很大时。例如，下载一幅很大的图像需要很长时间，因某种计算比较复杂而短时间无法完成，这时可以先用小比例的虚拟代理替换真实的对象，消除用户对服务器慢的感觉。</p>
<p>3、安全代理，这种方式通常用于控制不同种类客户对真实对象的访问权限。</p>
<p>4、智能指引，主要用于调用目标对象时，代理附加一些额外的处理功能。例如，增加计算真实对象的引用次数的功能，这样当该对象没有被引用时，就可以自动释放它。</p>
<p>5、延迟加载，指为了提高系统的性能，延迟对目标的加载。例如，Hibernate 中就存在属性的延迟加载和关联表的延时加载。</p>
<h1 id="4-代理模式的结构"><a class="header-anchor" href="#4-代理模式的结构"></a>4. 代理模式的结构</h1>
<p>【代理模式】的主要角色如下：</p>
<p>1、抽象主题（Subject）类：通过接口或抽象类声明真实主题和代理对象实现的业务方法。</p>
<p>2、真实主题（Real Subject）类：实现了抽象主题中的具体业务，是代理对象所代表的真实对象，是最终要引用的对象。</p>
<p>3、代理（Proxy）类：提供了与真实主题相同的接口，其内部含有对真实主题的引用，它可以访问、控制或扩展真实主题的功能。</p>
<p>【代理模式】的结构图：</p>
<p><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/DesignPatternImages/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="代理模式的结构图"></p>
<p>在代码中，一般代理会被理解为代码增强，实际上就是在原代码逻辑前后增加一些代码逻辑，而使调用者无感知，因此实际主题和代理都会实现相同的接口。</p>
<h1 id="5-静态代理模式"><a class="header-anchor" href="#5-静态代理模式"></a>5. 静态代理模式</h1>
<p><strong>备注：</strong> 为了能够更切合实际开发，接下来编写的【静态代理模式】代码将模拟实际业务开发，而不会根据上方的结构图进行编写。</p>
<h2 id="5-1-编码前的梳理"><a class="header-anchor" href="#5-1-编码前的梳理"></a>5.1 编码前的梳理</h2>
<p>在编码之前，先声明几个名词的含义：</p>
<p>1、原始类（目标类）：指的是实际业务类，其中包含核心功能（业务运算、DAO 调用等）；</p>
<p>2、目标方法（原始方法）：目标类（原始类）中方法就是目标方法；</p>
<p>3、额外功能（附加功能）：如日志、事务、性能等。</p>
<p>最后梳理一个代理类的核心要素，这些要素是缺一不可的：</p>
<pre>
代理类 = 原始类（目标类）+ 额外功能 + 实现和原始类（目标类）相同的接口
</pre>
<h2 id="5-2-静态代理的编码"><a class="header-anchor" href="#5-2-静态代理的编码"></a>5.2 静态代理的编码</h2>
<p><strong>静态代理：</strong> 需要程序员为每一个原始类（目标类）编写一个代理类，在程序运行前代理类的 .java 和 .class 文件就已经存在了。</p>
<p>一个实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再编写两个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户注册</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 注册的用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 用户密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否登录成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">login</span><span class="params">(String username, String password)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单显示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">showOrder</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为这两个接口编写实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserServiceImpl.register 业务运算 +  DAO 调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">login</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserServiceImpl.login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;OrderServiceImpl.showOrder&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后为实现类编写代理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserServiceImpl 的代理类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:37</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> UserServiceImpl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserServiceImpl</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--- log ---&quot;</span>);</span><br><span class="line">        userService.register(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">login</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--- log ---&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> userService.login(username, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OrderServiceImpl 的代理类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> OrderServiceImpl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">OrderServiceImpl</span> <span class="variable">orderService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--- log ---&quot;</span>);</span><br><span class="line">        orderService.showOrder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后编写一个测试类测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 14:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestProxy</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStaticProxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceProxy</span>();</span><br><span class="line">        userService.register(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        userService.login(<span class="string">&quot;mofan&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">OrderService</span> <span class="variable">orderService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderServiceProxy</span>();</span><br><span class="line">        orderService.showOrder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行测试类后，控制台打印出：</p>
<pre>
--- log ---
UserServiceImpl.register 业务运算 +  DAO 调用
--- log ---
UserServiceImpl.login
<font>=================================</font>
--- log ---
OrderServiceImpl.showOrder
</pre>
<p>代理成功！🎉</p>
<h2 id="5-3-静态代理存在的问题"><a class="header-anchor" href="#5-3-静态代理存在的问题"></a>5.3 静态代理存在的问题</h2>
<p>1、每当一个目标类需要被代理时，就需要为这个目标类编写一个代理类，这样会造成 <strong>代理类数量过多，不利于代码维护管理</strong>。</p>
<p>2、在上述的编码中，UserServiceProxy 和 OrderServiceProxy 中的每个方法的核心功能前都模拟了日志的输出，当我们需要对这些输出日志进行修改时，需要对每个日志输出都行修改。很显然在静态代理模式下的 <strong>额外功能的维护性很差</strong>。</p>
<h1 id="6-JDK-动态代理"><a class="header-anchor" href="#6-JDK-动态代理"></a>6. JDK 动态代理</h1>
<h2 id="6-1-JDK-动态代理分析"><a class="header-anchor" href="#6-1-JDK-动态代理分析"></a>6.1 JDK 动态代理分析</h2>
<p>为了解决静态代理中存在的问题，我们可以使用动态代理来解决，而在 JDK 中已经提供了方法来实现动态代理。</p>
<p>在 JDK 中提供了 <code>Proxy.newProxyInstance()</code> 方法来实现动态代理，查看一下这个方法的参数信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span><br><span class="line"><span class="params">                                      Class&lt;?&gt;[] interfaces,</span></span><br><span class="line"><span class="params">                                      InvocationHandler h)</span></span><br></pre></td></tr></table></figure>
<p><code>Proxy.newProxyInstance()</code> 方法的返回值就是为我们创建的代理对象，那这个方法的参数又代表什么含义呢？</p>
<p>还记得我们前面说的代理类的三要素吗？</p>
<pre>
代理类 = 原始类（目标类）+ 额外功能 + 实现和原始类（目标类）相同的接口
</pre>
<p>原始类（目标类）很好办，有现成的代码无需担心；代理类需要实现和原始类（目标类）相同的接口，这也很好办，很显然 <code>Proxy.newProxyInstance()</code> 的第二个参数 <code>interfaces</code> 就是用来指定实现的接口的，通过原始对象的 <code>getClass().getInterfaces()</code> 方法即可获得相同的接口；那额外功能呢？</p>
<p>额外功能就需要用到 <code>Proxy.newProxyInstance()</code> 的第三个参数：<code>InvocationHandler</code>。</p>
<p><code>InvocationHandler</code> 又是个啥呢？点进源码看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>InvocationHandler</code> 是一个函数式接口，其内部有且仅有一个方法。</p>
<p>针对 <code>InvocationHandler</code> 中的 <code>invoke()</code> 方法，我们需要知道：</p>
<p>① <code>invoke()</code> 方法的作用；</p>
<p>② <code>invoke()</code> 方法参数的作用；</p>
<p>③ <code>invoke()</code> 方法返回什么样的返回值。</p>
<p><code>invoke()</code> 方法的作用很简单，就是用来书写额外功能的，使额外功能运行在原始方法之前、之后、前后乃至抛出异常。</p>
<p><code>invoke()</code> 方法的返回值就是代理方法的返回值。</p>
<p><code>invoke()</code> 方法有三个参数，分别是：proxy、method 和 args。其中 proxy 表示代理对象，也就是说 <code>Proxy.newProxyInstance()</code> 方法创建出的代理对象也会作为 <code>invoke()</code> 方法的参数，我们一般不使用 proxy 参数；第二个参数 method 表示需要被添加额外功能的原始方法，比如我需要给 <code>login()</code> 方法添加额外功能，那么 method 就表示 <code>login()</code> 方法；第三个参数 args 表示需要被添加额外功能的原始方法的参数列表，比如 <code>login()</code> 方法有两个参数，那个 args[0] 就表示其第一个参数，args[1] 表示其第二个参数。</p>
<p>通过对 <code>invoke()</code> 方法的三个参数，我们可以拿到原始方法以及原始方法所需要的参数，这下就直接可以调用原始方法了？这显然是不行了，我们还需要原始对象。因此要想调用原始方法，我们可以：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> method.invoke(原始对象, args);</span><br></pre></td></tr></table></figure>
<p>其中，原始对象可以通过原始类 <code>new</code> 出来，<code>ret</code> 就是原始方法的返回值。<code>method.invoke()</code> 是通过反射来调用方法的，它跟下述两个方式调用方法是一样的，只不过这里的 <code>method</code> 既可以指 <code>login()</code> 也可以指 <code>register()</code>，通过反射来调用方法更加灵活。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object ret = method.invoke(原始对象, args); 等价于</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">bool</span> <span class="operator">=</span> userService.login(<span class="string">&quot;mofan&quot;</span>, <span class="string">&quot;12345&quot;</span>);</span><br><span class="line"><span class="comment">// 或者 </span></span><br><span class="line">userService.register(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br></pre></td></tr></table></figure>
<p><code>Proxy.newProxyInstance()</code> 方法的后两个参数的作用我们已经知道了，那第一个参数 <code>ClassLoader</code> 又有什么用？或者说怎么用呢？</p>
<p>ClassLoader 翻译一下就是 <strong>类加载器</strong>，类加载器有什么作用呢？类加载器有两个作用：</p>
<p>1、类加载器可以把对应类的字节码文件加载进 JVM 中；</p>
<p>2、创建对象时，需要通过类加载器创建类的 Class 对象，进而创建这个类的对象。比方说，当我们需要创建 User 类的 user 对象时，需要先创建 User 类的 Class 对象，然后才能通过 <code>new User()</code> 的方式创建 user 对象。</p>
<p>再来分析一下 <strong>类加载器的运行过程</strong>：</p>
<p>假定我现在需要创建 user 对象，那么我需要先编码完成 User.java 文件，然后通过编译得到 User.class 文件，User.class 文件中存放着 User 类的字节码信息。那么得到 User.class 后可以创建对象了吗？</p>
<p>这显然是不行的，因为我们知道创建对象和运行对象是需要在 Java 虚拟机（JVM）中的。那么我们就需要把字节码文件加载进 JVM 中，而这一步就是通过类加载器来完成的。还没完，还需要创建 User 类的 Class 对象才行，而这一步也是通过类加载器来完成的，得到 Class 对象后就可以创建 user 对象了。</p>
<img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/DesignPatternImages/类加载器的运行过程.png" alt="类加载器的运行过程" style="zoom:80%;" />
<p>很明显，<strong>类加载器</strong> 在创建对象的过程中是十分重要的，那怎么获得类加载器呢？无需担心，<strong>虚拟机会默认为每一个类的 .class 文件自动分配与之对应的类加载器。</strong></p>
<p>那为什么在 JDK 动态代理的 <code>Proxy.newProxyInstance()</code> 方法的第一个参数就需要传递一个类加载器呢？虚拟机不是会默认提供吗？</p>
<p>JDK 动态代理也是<strong>在虚拟机中获得动态代理类，进而创建代理对象。</strong> 那么问题来了，动态代理类有源文件吗？很显然是没有的，动态代理与静态代理的一个区别就是解决了静态代理代理类过多的缺点。既然动态代理类没有源文件，那就没有 .class 文件了。没有 .class 文件，那又是如何获取动态代理类的字节码来创建对象的呢？</p>
<p>动态代理就是通过动态字节码技术来创建字节码并直接写入虚拟机中，也就是说没有字节码加载进 JVM 的过程。使用 <code>Proxy.newProxyInstance()</code> 和这个方法的后两个参数就可以得到动态代理类的字节码并写入虚拟机中。通过前面的分析我们知道，仅仅拥有动态代理类的字节码仍然是不能创建代理对象的，还需要创建 Class 对象才行。创建 Class 对象时需要类加载器的介入，但动态代理类没有与之对应的 .class 文件，也就没有与之对应的类加载器，这咋办？</p>
<p>既然动态代理类没有与之对应的类加载器，那我们就可以 <strong>借一个类加载器来使用</strong>，通过借来的类加载器来创建 Class 对象进而创建动态代理对象，这也是 <code>Proxy.newProxyInstance()</code> 方法的第一个参数就需要传入一个类加载器的原因。</p>
<p>那么借谁的类加载器呢？随便借一个就行，谁有源文件，谁就有 .class 文件及其与之对应的类加载器。比如就可以借用原始类的类加载器。</p>
<h2 id="6-2-JDK-动态代理的编码"><a class="header-anchor" href="#6-2-JDK-动态代理的编码"></a>6.2 JDK 动态代理的编码</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 15:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdkProxy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取原始对象</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">        <span class="comment">// 创建代理对象</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userServiceProxy</span> <span class="operator">=</span> (UserService) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class="line">                userService.getClass().getInterfaces(),</span><br><span class="line">                (proxy, method, params) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;--- start ---&quot;</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> method.invoke(userService, params);</span><br><span class="line">                    System.out.println(<span class="string">&quot;--- end ---&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> ret;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 调用代理对象的代理方法</span></span><br><span class="line">        userServiceProxy.login(<span class="string">&quot;mofan&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        userServiceProxy.register(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行上述代码后，控制台打印出：</p>
<pre>
--- start ---
UserServiceImpl.login
--- end ---
--- start ---
UserServiceImpl.register 业务运算 +  DAO 调用
--- end ---
</pre>
<p>证明我们编写的 JDK 动态代理是没有问题的。</p>
<p>上述代码中，<code>Proxy.newProxyInstance()</code> 方法的 <strong>第一个参数</strong> 使用的是 <code>Thread.currentThread().getContextClassLoader()</code>，当然也可以是其他的，比如 <code>UserService.class.getClassLoader()</code>，或者 <code>JdkProxy.class.getClassLoader()</code>，这些都是没有问题的。</p>
<h1 id="7-CGLib-动态代理"><a class="header-anchor" href="#7-CGLib-动态代理"></a>7. CGLib 动态代理</h1>
<h2 id="7-1-与-JDK-动态代理的区别"><a class="header-anchor" href="#7-1-与-JDK-动态代理的区别"></a>7.1 与 JDK 动态代理的区别</h2>
<p>CGLib 动态代理和 JDK 动态代理的目标是一致的，都是为了规避静态代理的缺点并创建出代理对象。那它们有什么区别呢？</p>
<p>在 JDK 动态代理中，我们需要 <strong>保证动态代理类和原始类实现相同的接口</strong>，其原因如下：</p>
<p>1、保证代理类和原始类的方法一致，用于“迷惑”调用者；</p>
<p>2、代理类可以提供新的实现，即能对原始方法进行拓展，添加额外功能。</p>
<p>但在实际开发过程中很有可能会出现这样一个场景：原始类没有实现任何接口。那怎么为这样的类创建代理类呢？显然使用 JDK 动态代理是不行的了。</p>
<p>这里插一句： <mark>无论原始类是否实现了接口，代理类和原始类要具有共同的方法。</mark></p>
<p>在这种情况下，就可以使用 CGLib 动态代理来解决。</p>
<p>为了满足代理类和原始类具有共同的方法，使用 CGLib 动态代理时，要求 <strong>代理类继承原始类</strong>，因此原始类不能被 <code>final</code> 修饰。</p>
<p>简单来说：JDK 动态代理中，原始类和代理类是“兄弟”关系；在 CGLib 动态代理中，原始类和代理类是父子关系。</p>
<h2 id="7-2-CGLib-动态代理的编码"><a class="header-anchor" href="#7-2-CGLib-动态代理的编码"></a>7.2 CGLib 动态代理的编码</h2>
<blockquote>
<p>依赖的导入</p>
</blockquote>
<p>需要先引入 CGLib 的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/cglib/cglib --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>原始类的准备</p>
</blockquote>
<p>另外创建一个实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 17:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个原始类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 17:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;StudentService.create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;StudentService.delete&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>编码前的分析</p>
</blockquote>
<p>CGLib 动态代理的编码和 JDK 动态代理的编码极其类似，只不过 CGLib 中是使用 <code>Enhancer</code> 对象来创建动态代理类。</p>
<p>创建 <code>Enhancer</code> 对象后需要对其三个属性进行赋值：</p>
<p>1、<code>classLoader</code>：与 JDK 动态代理一样，也需要借用一个类加载器；</p>
<p>2、<code>superclass</code>：与 JDK 动态代理不一样，这里需要填入原始类的 Class 对象，表示代理类继承了原始类；</p>
<p>3、<code>callbacks</code>：自定义的额外功能。</p>
<p>针对 <code>callbacks</code> 属性的赋值，我们使用 <code>setCallback()</code> 方法进行赋值，传入 <code>MethodInterceptor</code> 对象即可。由于 <code>MethodInterceptor</code> 是一个函数式接口，因此接下来的编码中我将使用 Lambda 进行编写。</p>
<p>查看 <code>MethodInterceptor</code> 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MethodInterceptor</span> <span class="keyword">extends</span> <span class="title class_">Callback</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * All generated proxied methods call this method instead of the original method.</span></span><br><span class="line"><span class="comment">     * The original method may either be invoked by normal reflection using the Method object,</span></span><br><span class="line"><span class="comment">     * or by using the MethodProxy (faster).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj &quot;this&quot;, the enhanced object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method intercepted Method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args argument array; primitive types are wrapped</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> proxy used to invoke super (non-intercepted method); may be called</span></span><br><span class="line"><span class="comment">     * as many times as needed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable any exception may be thrown; if so, super method will not be invoked</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> any value compatible with the signature of the proxied method. Method returning void will ignore this value.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> MethodProxy</span></span><br><span class="line"><span class="comment">     */</span>   </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, java.lang.reflect.Method method, Object[] args,</span></span><br><span class="line"><span class="params">                               MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与 JDK 动态代理类似，<code>intercept()</code> 方法的返回值为代理方法的返回值。其参数含义如下：</p>
<p>1、obj 表示由 CGLib 生成的代理类实例（代理对象）；</p>
<p>2、method 表示需要被添加额外功能的原始方法；</p>
<p>3、args 表示参数列表；</p>
<p>4、proxy 表示 CGLib 生成的代理对象中的代理方法，可以根据需要多次执行原始方法。</p>
<p>查看 <code>MethodProxy</code> 的源码，其中的注释是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Classes generated by &#123;<span class="doctag">@link</span> Enhancer&#125; pass this object to the</span></span><br><span class="line"><span class="comment"> * registered &#123;<span class="doctag">@link</span> MethodInterceptor&#125; objects when an intercepted method is invoked. It can</span></span><br><span class="line"><span class="comment"> * be used to either invoke the original method, or call the same method on a different</span></span><br><span class="line"><span class="comment"> * object of the same type.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> $Id: MethodProxy.java,v 1.16 2009/01/11 20:09:48 herbyderby Exp $</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodProxy</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>也就是说，这个类可以用来执行原始方法，也可以用来在同一个类中不同的对象中调用相同的方法。</p>
<p>使用 method 可以通过反射来获取运行时的对象的方法，使用 methodProxy 可以创建一个反射代理类，通过代理类来调用方法。</p>
<p>根据 <code>MethodInterceptor#intercept()</code> 方法的注释可知：为代理类生成的所有代理方法都会调用 <code>intercept()</code> 方法，而不是原始方法。原始方法可以使用 <code>Method</code> 对象通过反射来调用，也可以使用 <code>MethodProxy</code> 对象来调用，而且使用 <code>MethodProxy</code> 的效率更高。</p>
<p>因此在 CGLib 中，调用原始方法有三种方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> method.invoke(studentService, params);</span><br><span class="line"><span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> methodProxy.invoke(studentService, params);</span><br><span class="line"><span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> methodProxy.invokeSuper(o, params);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>CGLib 动态代理编码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 18:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CglibProxy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建原始对象</span></span><br><span class="line">        <span class="type">StudentService</span> <span class="variable">studentService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentService</span>();</span><br><span class="line">        <span class="comment">// 使用 CGLib 创建代理对象</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        enhancer.setClassLoader(Thread.currentThread().getContextClassLoader());</span><br><span class="line">        enhancer.setSuperclass(studentService.getClass());</span><br><span class="line">        enhancer.setCallback((MethodInterceptor) (o, method, params, methodProxy) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;--- cglib start ---&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> method.invoke(studentService, params);</span><br><span class="line"><span class="comment">//            Object ret = methodProxy.invoke(studentService, params);</span></span><br><span class="line"><span class="comment">//            Object ret = methodProxy.invokeSuper(o, params);</span></span><br><span class="line">            System.out.println(<span class="string">&quot;--- cglib end ---&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">StudentService</span> <span class="variable">studentServiceProxy</span> <span class="operator">=</span> (StudentService) enhancer.create();</span><br><span class="line">        <span class="comment">// 调用代理对象的方法</span></span><br><span class="line">        studentServiceProxy.create(<span class="keyword">new</span> <span class="title class_">Student</span>());</span><br><span class="line">        studentServiceProxy.delete(<span class="number">123456789L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行上述代码后，控制台打印出：</p>
<pre>
--- cglib start ---
StudentService.create
--- cglib end ---
--- cglib start ---
StudentService.delete
--- cglib end ---
</pre>
<p>证明我们编写的 CGLib 动态代理是没有问题的。</p>
<h2 id="7-3-创建抽象类的代理对象"><a class="header-anchor" href="#7-3-创建抽象类的代理对象"></a>7.3 创建抽象类的代理对象</h2>
<p>如果一个抽象类没有任何子类，能否为其创建代理对象呢？</p>
<p>答案是可行的，使用 CGLib 即可。</p>
<p>现有这样一个原始抽象类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/10/10 21:38</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractStudentService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;AbstractStudentService.update&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用 CGLib 来创建代理对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAbstractCglibProxy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setClassLoader(Thread.currentThread().getContextClassLoader());</span><br><span class="line">    enhancer.setSuperclass(AbstractStudentService.class);</span><br><span class="line">    enhancer.setCallback((MethodInterceptor) (obj, method, args, proxy) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--- Abstract CGLib ---&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> proxy.invokeSuper(obj, args);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">AbstractStudentService</span> <span class="variable">serviceProxy</span> <span class="operator">=</span> (AbstractStudentService) enhancer.create();</span><br><span class="line">    serviceProxy.update(<span class="keyword">new</span> <span class="title class_">Student</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行上述代码后，控制台打印出：</p>
<pre>
--- Abstract CGLib ---
AbstractStudentService.update
</pre>
<p>证明我们使用 CGLib 为抽象类创建代理对象是没有问题的。</p>
<h2 id="7-4-Callback-的种类"><a class="header-anchor" href="#7-4-Callback-的种类"></a>7.4 Callback 的种类</h2>
<p>前文中使用 <code>Enhancer</code> 创建代理对象时，都会有 <code>enhancer.setCallback()</code> 这一步，要求传入一个 <code>Callback</code> 对象，前文中都是使用的是 <code>MethodInterceptor</code>，但 <code>Callback</code> 的种类并不是只有这一种。</p>
<p>本节中需要使用到的原始类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHelloWorld</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMyName1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mofan&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMyName2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mofan212&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>NoOp</p>
</blockquote>
<p>这个回调很简单，就是什么都不干。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testNoOp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    enhancer.setCallback(NoOp.INSTANCE);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    person.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>Hello</pre>
<blockquote>
<p>LazyLoader</p>
</blockquote>
<p>用于实现懒加载的回调，当代理对象的方法 <strong>首次</strong> 被调用时，就会触发回调，之后每次对方法的调用都是第一次懒加载返回的 Bean 的方法的调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLazyLoader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    enhancer.setCallback((LazyLoader) () -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;prepare loading&quot;</span>);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;mofan&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;after loading&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    System.out.println(<span class="string">&quot;build&quot;</span>);</span><br><span class="line">    System.out.println(person.getName());</span><br><span class="line">    System.out.println(person.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
build
prepare loading
after loading
mofan
mofan
</pre>
<blockquote>
<p>Dispatcher</p>
</blockquote>
<p><code>Dispatcher</code> 和 <code>LazyLoader</code> 的作用很相似，只不过每次对代理对象的方法的调用时都会触发回调。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDispatcher</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    enhancer.setCallback((Dispatcher) () -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;prepare loading&quot;</span>);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;mofan&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;after loading&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    System.out.println(<span class="string">&quot;build&quot;</span>);</span><br><span class="line">    System.out.println(person.getName());</span><br><span class="line">    System.out.println(person.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
build
prepare loading
after loading
mofan
prepare loading
after loading
mofan
</pre>
<blockquote>
<p>InvocationHandler</p>
</blockquote>
<p>CGLib 的 <code>InvocationHandler</code> 和 JDK 的 <code>InvocationHandler</code> 很类似，只不过如果对参数中的 <code>method</code> 再次进行调用时，会重复触发回调。如果要对原始方法进行调用，还是使用 <code>MethodInterceptor</code> 更好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInvocationHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    enhancer.setCallback((InvocationHandler) (obj, method, args) -&gt; &#123;</span><br><span class="line">        <span class="comment">// 如果对参数中的 method 再次调用，会重复进入 InvocationHandler</span></span><br><span class="line">        <span class="keyword">if</span> (method.getReturnType() == <span class="keyword">void</span>.class) &#123;</span><br><span class="line">            <span class="comment">// 没有调用 method，因此不会执行原始方法</span></span><br><span class="line">            System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    person.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>hello world</pre>
<blockquote>
<p>FixedValue</p>
</blockquote>
<p>该回调常用于替换原始方法的返回值为回调方法的返回值，但必须保证返回类型是兼容的，否则会抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFixedValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    enhancer.setCallback((FixedValue) () -&gt; <span class="string">&quot;默烦&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    assertThat(person.getName()).isEqualTo(<span class="string">&quot;默烦&quot;</span>);</span><br><span class="line">    assertThat(person.getMyName1()).isEqualTo(<span class="string">&quot;默烦&quot;</span>);</span><br><span class="line">    assertThat(person.getMyName2()).isEqualTo(<span class="string">&quot;默烦&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-5-CallbackFilter"><a class="header-anchor" href="#7-5-CallbackFilter"></a>7.5 CallbackFilter</h2>
<p>一种  <code>Callback</code> 只能对原始类进行某种增强，如果需要一些定制化操作，比如满足不同的条件进行不同的增强，是无法利用 <code>Callback</code> 实现的，这时 <code>CallbackFilter</code> 就排上用场了。</p>
<p>当通过 <code>CallbackFilter</code> 对原始类进行增强后，原始类中的方法会根据设置的 Filter 与某个特定的 <code>Callback</code> 进行映射，以完成定制化需求。</p>
<blockquote>
<p>基本使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCallbackFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    enhancer.setCallbackFilter(method -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;sayHello&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;sayHelloWorld&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Callback</span> <span class="variable">firstCallback</span> <span class="operator">=</span> (MethodInterceptor) (o, method, objects, methodProxy) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before getMyName1&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">invoke</span> <span class="operator">=</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">        System.out.println(<span class="string">&quot;after getMyName1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">Callback</span> <span class="variable">secondCallback</span> <span class="operator">=</span> (MethodInterceptor) (o, method, objects, methodProxy) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before getMyName2&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">invoke</span> <span class="operator">=</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">        System.out.println(<span class="string">&quot;after getMyName2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    enhancer.setCallbacks(<span class="keyword">new</span> <span class="title class_">Callback</span>[]&#123;firstCallback, secondCallback, NoOp.INSTANCE&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    person.sayHello();</span><br><span class="line">    person.sayHelloWorld();</span><br><span class="line">    assertThat(person.getName()).isNull();</span><br><span class="line">    assertThat(person.getAge()).isNull();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>setCallbackFilter()</code> 时，根据不同的方法名称返回了不同的 <code>int</code> 类型数据，该数据被代理类的各个方法在回调数组 <code>Callback[]</code> （即 <code>setCallbacks()</code> 时传入的数组）中的位置索引。</p>
<p>比如，当方法名称为 <code>sayHello</code> 时，返回 <code>0</code>，那么就会回调 <code>firstCallback</code>。</p>
<p>上述测试方法运行后有：</p>
<pre>
before getMyName1
Hello
after getMyName1
before getMyName2
Hello World
after getMyName2
</pre>
<blockquote>
<p>CallbackHelper</p>
</blockquote>
<p>CGLib 提供了 <code>CallbackHelper</code> 类来简化 <code>CallbackFilter</code> 和 <code>Callback[]</code> 的设置与映射。</p>
<p>创建 <code>CallbackHelper</code> 实例时，需要传入原始类的 <code>Class</code> 和原始类父接口的 <code>Class</code> 数组，根据这两者获取到 <code>Method</code> 集合，然后遍历该集合，调用重写的 <code>getCallback()</code> 方法，获取到每个 <code>Method</code> 对应的 <code>Callback</code> 以建立 <code>Method</code> 与 <code>Callback</code> 的映射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCallbackHelper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    enhancer.setSuperclass(Person.class);</span><br><span class="line">    <span class="type">CallbackHelper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CallbackHelper</span>(Person.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Object <span class="title function_">getCallback</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.getReturnType() == <span class="keyword">void</span>.class) &#123;</span><br><span class="line">                <span class="keyword">return</span> (MethodInterceptor) (obj, method1, args, methodProxy) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">res</span> <span class="operator">=</span> methodProxy.invokeSuper(obj, args);</span><br><span class="line">                    System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getReturnType() == String.class) &#123;</span><br><span class="line">                <span class="keyword">return</span> (FixedValue) () -&gt; <span class="string">&quot;默烦&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">return</span> NoOp.INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    enhancer.setCallbacks(helper.getCallbacks());</span><br><span class="line">    enhancer.setCallbackFilter(helper);</span><br><span class="line"></span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) enhancer.create();</span><br><span class="line">    person.sayHello();</span><br><span class="line">    assertThat(person.getName()).isEqualTo(<span class="string">&quot;默烦&quot;</span>);</span><br><span class="line">    assertThat(person.getAge()).isNull();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
before
Hello
after
</pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Design-Pattern-Proxy-Pattern/">https://mofan212.github.io/posts/Design-Pattern-Proxy-Pattern/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/DesignPattern/">DesignPattern</a><a class="post-meta__tags" href="/tags/CGLib/">CGLib</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/19.png" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://fastly.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/Android-6/" title="Android传感器与LBS（六）"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/6.jpg" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Android传感器与LBS（六）</div></div><div class="info-2"><div class="info-item-1">本文介绍了磁场传感器、加速度传感器、方向传感器的使用，如何实现基于百度地图位置服务。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Combinator-Pattern/" title="Combinator Pattern"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/149.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-28</div><div class="info-item-2">Combinator Pattern</div></div><div class="info-2"><div class="info-item-1">本文介绍了如何在 Java 中使用 Combinator Pattern。</div></div></div></a><a class="pagination-related" href="/posts/Design-Pattern-Mediator-Pattern/" title="【设计模式】中介者模式"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/148.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-03</div><div class="info-item-2">【设计模式】中介者模式</div></div><div class="info-2"><div class="info-item-1">本文主要对 Java 设计模式中的中介者模式进行了介绍。</div></div></div></a><a class="pagination-related" href="/posts/Design-Pattern-Singleton-Pattern/" title="【设计模式】单例模式"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/112.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-10</div><div class="info-item-2">【设计模式】单例模式</div></div><div class="info-2"><div class="info-item-1">本文主要对 Java 设计模式中的单例模式进行了介绍。</div></div></div></a><a class="pagination-related" href="/posts/Design-Pattern-Factory-Pattern/" title="【设计模式】工厂模式"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/88.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-17</div><div class="info-item-2">【设计模式】工厂模式</div></div><div class="info-2"><div class="info-item-1">本文主要对 Java 设计模式中的工厂模式进行了介绍。</div></div></div></a><a class="pagination-related" href="/posts/Design-Pattern-Template-Method-Pattern/" title="【设计模式】模板方法模式"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/94.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-04</div><div class="info-item-2">【设计模式】模板方法模式</div></div><div class="info-2"><div class="info-item-1">本文主要对 Java 设计模式中的模板方法模式进行了介绍。</div></div></div></a><a class="pagination-related" href="/posts/Design-Pattern-Decorator-Pattern/" title="【设计模式】装饰器模式"><img class="cover" src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/93.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-29</div><div class="info-item-2">【设计模式】装饰器模式</div></div><div class="info-2"><div class="info-item-1">本文主要对 Java 设计模式中的装饰器模式进行了介绍，并对其在 JDK 中的应用进行了简单的讲解。</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">159</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a href="./mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-text">1. 问题的引入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E7%9F%9B%E7%9B%BE"><span class="toc-text">1.1 软件开发中的矛盾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%8E%B0%E5%AE%9E%E7%94%9F%E6%B4%BB%E4%B8%AD%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">1.2 现实生活中的解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E7%89%B9%E7%82%B9"><span class="toc-text">2. 模式的定义与特点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">3. 模式的应用场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-text">4. 代理模式的结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-text">5. 静态代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E7%BC%96%E7%A0%81%E5%89%8D%E7%9A%84%E6%A2%B3%E7%90%86"><span class="toc-text">5.1 编码前的梳理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E7%BC%96%E7%A0%81"><span class="toc-text">5.2 静态代理的编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">5.3 静态代理存在的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-JDK-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-text">6. JDK 动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-JDK-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-text">6.1 JDK 动态代理分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-JDK-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E7%BC%96%E7%A0%81"><span class="toc-text">6.2 JDK 动态代理的编码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-CGLib-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-text">7. CGLib 动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E4%B8%8E-JDK-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">7.1 与 JDK 动态代理的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-CGLib-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E7%BC%96%E7%A0%81"><span class="toc-text">7.2 CGLib 动态代理的编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E5%88%9B%E5%BB%BA%E6%8A%BD%E8%B1%A1%E7%B1%BB%E7%9A%84%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-text">7.3 创建抽象类的代理对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-Callback-%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-text">7.4 Callback 的种类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-CallbackFilter"><span class="toc-text">7.5 CallbackFilter</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/154.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Spring 配置类的解析"/></a><div class="content"><a class="title" href="/posts/How-To-Parse-Spring-Configuration-Classes/" title="Spring 配置类的解析">Spring 配置类的解析</a><time datetime="2025-03-25T16:00:00.000Z" title="更新于 2025-03-26 00:00:00">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Lambda-In-Action/" title="Java Lambda In Action"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/159.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java Lambda In Action"/></a><div class="content"><a class="title" href="/posts/Java-Lambda-In-Action/" title="Java Lambda In Action">Java Lambda In Action</a><time datetime="2025-03-18T16:00:00.000Z" title="更新于 2025-03-19 00:00:00">2025-03-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Combinator-Pattern/" title="Combinator Pattern"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/149.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Combinator Pattern"/></a><div class="content"><a class="title" href="/posts/Combinator-Pattern/" title="Combinator Pattern">Combinator Pattern</a><time datetime="2025-03-09T16:00:00.000Z" title="更新于 2025-03-10 00:00:00">2025-03-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Algorithm-Insertion-Sort/" title="【排序算法】插入排序和二分搜索"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/46.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【排序算法】插入排序和二分搜索"/></a><div class="content"><a class="title" href="/posts/Algorithm-Insertion-Sort/" title="【排序算法】插入排序和二分搜索">【排序算法】插入排序和二分搜索</a><time datetime="2025-03-08T16:00:00.000Z" title="更新于 2025-03-09 00:00:00">2025-03-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Common-Extension-Points-In-Spring-Boot/" title="SpringBoot 常用拓展点"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/140.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="SpringBoot 常用拓展点"/></a><div class="content"><a class="title" href="/posts/Common-Extension-Points-In-Spring-Boot/" title="SpringBoot 常用拓展点">SpringBoot 常用拓展点</a><time datetime="2025-03-01T16:00:00.000Z" title="更新于 2025-03-02 00:00:00">2025-03-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/DataStructure-HashMap/" title="数据结构之哈希表"><img src= "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/39.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="数据结构之哈希表"/></a><div class="content"><a class="title" href="/posts/DataStructure-HashMap/" title="数据结构之哈希表">数据结构之哈希表</a><time datetime="2025-02-28T16:00:00.000Z" title="更新于 2025-03-01 00:00:00">2025-03-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 默烦</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://fastly.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://fastly.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://npm.elemecdn.com/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://fastly.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script defer="defer" id="ribbon" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://fastly.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>