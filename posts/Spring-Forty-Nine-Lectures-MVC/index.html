<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【Spring 四十九讲】WebMVC | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Spring 四十九讲中第廿讲到第卅六讲，WebMVC。">
<meta property="og:type" content="article">
<meta property="og:title" content="【Spring 四十九讲】WebMVC">
<meta property="og:url" content="https://mofan212.github.io/posts/Spring-Forty-Nine-Lectures-MVC/">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="Spring 四十九讲中第廿讲到第卅六讲，WebMVC。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/124.jpg">
<meta property="article:published_time" content="2023-01-26T16:00:00.000Z">
<meta property="article:modified_time" content="2023-01-26T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="Spring-Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/124.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "【Spring 四十九讲】WebMVC",
  "url": "https://mofan212.github.io/posts/Spring-Forty-Nine-Lectures-MVC/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/124.jpg",
  "datePublished": "2023-01-26T16:00:00.000Z",
  "dateModified": "2023-01-26T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Spring-Forty-Nine-Lectures-MVC/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://testingcf.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【Spring 四十九讲】WebMVC',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css" /><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://testingcf.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">【Spring 四十九讲】WebMVC</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-26T16:00:00.000Z" title="发表于 2023-01-27 00:00:00">2023-01-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-26T16:00:00.000Z" title="更新于 2023-01-27 00:00:00">2023-01-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/Spring-Boot/">Spring-Boot</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">21.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>98分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2023-01-27 00:00:00&quot;}" hidden></div><p>封面画师：T5-茨舞（微博）     封面ID：104944884</p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1P44y1N7QG">黑马程序员Spring视频教程，全面深度讲解spring5底层原理</a></p>
<p>源码仓库：<a target="_blank" rel="noopener" href="https://github.com/mofan212/advanced-spring">mofan212/advanced-spring (github.com)</a></p>
<h1 id="20-RequestMappingHandlerMapping-与-RequestMappingHandlerAdapter"><a class="header-anchor" href="#20-RequestMappingHandlerMapping-与-RequestMappingHandlerAdapter"></a>20. RequestMappingHandlerMapping 与  RequestMappingHandlerAdapter</h1>
<h2 id="20-1-DispatcherServlet-的初始化"><a class="header-anchor" href="#20-1-DispatcherServlet-的初始化"></a>20.1 DispatcherServlet 的初始化</h2>
<p>选择支持内嵌Tomcat 服务器的 Spring 容器作为 <code>ApplicationContext</code> 的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigServletWebServerApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>(WebConfig.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>WebConfig</code> 作为配置类，向 Spring 容器中添加内嵌 Web 容器工厂、<code>DispatcherServlet</code> 和 <code>DispatcherServlet</code> 注册对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mofan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/22 22:38</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内嵌 Web 容器工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">tomcatServletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 DispatcherServlet</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 DispatcherServlet，Spring MVC 的入口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">dispatcherServletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法，控制台打印出：</p>
<pre>
Tomcat initialized with port(s): 8080 (http)
Root WebApplicationContext: initialization completed in 2132 ms
</pre>
<p>Tomcat 容器初始化成功，Spring 容器初始化成功，但 <code>DispatcherServlet</code> 还未被初始化。</p>
<p>当Tomcat 服务器 <strong>首次</strong> 使用到 <code>DispatcherServlet</code> 时，才会由Tomcat 服务器初始化 <code>DispatcherServlet</code>。</p>
<p>清空控制台信息，使用浏览器访问 <code>localhost:8080</code>，控制台打印出：</p>
<pre>
信息: Initializing Spring DispatcherServlet 'dispatcherServlet'
[INFO ] Initializing Servlet 'dispatcherServlet' 
[TRACE] No MultipartResolver 'multipartResolver' declared 
[TRACE] No LocaleResolver 'localeResolver': using default [AcceptHeaderLocaleResolver] 
[TRACE] No ThemeResolver 'themeResolver': using default [FixedThemeResolver] 
[TRACE] No HandlerMappings declared for servlet 'dispatcherServlet': using default strategies from DispatcherServlet.properties 
[TRACE] No HandlerAdapters declared for servlet 'dispatcherServlet': using default strategies from DispatcherServlet.properties 
[TRACE] No HandlerExceptionResolvers declared in servlet 'dispatcherServlet': using default strategies from DispatcherServlet.properties 
[TRACE] No RequestToViewNameTranslator 'viewNameTranslator': using default [DefaultRequestToViewNameTranslator] 
[TRACE] No ViewResolvers declared for servlet 'dispatcherServlet': using default strategies from DispatcherServlet.properties 
[TRACE] No FlashMapManager 'flashMapManager': using default [SessionFlashMapManager] 
[INFO] Completed initialization in 482 ms 
</pre>
<p>完成 <code>DispatcherServlet</code> 的初始化。</p>
<blockquote>
<p>使用 DEBUG 查看 <code>DispatcherServlet</code> 的初始化时机</p>
</blockquote>
<p>断点 <code>DispatcherServlet</code> 的 <code>onRefresh()</code> 方法中 <code>this.initStrategies(context);</code> 的所在行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRefresh</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.initStrategies(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以 DEBUG 方式重启程序，此时程序尚未执行到断点处。</p>
<p>再次在浏览器中访问 <code>localhost:8080</code>，程序执行到断点处。</p>
<p>查看调用栈可知，是从 <code>GenericServlet</code> 的 <code>init()</code> 方法执行到 <code>onRefresh()</code> 方法的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="built_in">this</span>.config = config;</span><br><span class="line">    <span class="built_in">this</span>.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此 <code>DispatcherServlet</code> 的初始化流程走的是 <code>Servlet</code> 的初始化流程。</p>
<blockquote>
<p>使 <code>DispatcherServlet</code> 在Tomcat 服务器启动时被初始化</p>
</blockquote>
<p>修改添加到 Spring 容器的 <code>DispatcherServlet</code> 注册 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">dispatcherServletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet)</span> &#123;</span><br><span class="line">    <span class="type">DispatcherServletRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置其 <code>loadOnStartup</code> 为一个正数。</p>
<p>当存在多个 <code>DispatcherServlet</code> 需要被注册时，设置的 <code>loadOnStartup</code> 越大，优先级越小，初始化顺序越靠后。</p>
<p>再次重启程序，根据控制台输出的内容可知，不仅完成 Tomcat 和 Spring 容器的初始化，<code>DispatcherServlet</code> 也初始化成功。</p>
<blockquote>
<p>抽取配置信息到配置文件中</p>
</blockquote>
<p>使用 <code>@PropertySource</code> 注解设置配置类需要读取的配置文件，以便后续读取配置文件中的内容。</p>
<p>要读取配置文件中的内容，可以使用 <code>@Value</code> 注解，但该注解一次仅仅能够读取一个值，现实是往往需要从配置文件中读取多个值。</p>
<p>可以使用 <code>@EnableConfigurationProperties</code> 注解完成配置文件信息与对象的绑定，后续使用时作为 <code>@Bean</code> 注解标记的方法的参数直接在方法中使用即可：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.mvc.servlet.load-on-startup</span>=<span class="string">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:application.properties&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;WebMvcProperties.class, ServerProperties.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内嵌 Web 容器工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">tomcatServletWebServerFactory</span><span class="params">(ServerProperties serverProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>(serverProperties.getPort());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 DispatcherServlet</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 DispatcherServlet，Spring MVC 的入口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">dispatcherServletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet,</span></span><br><span class="line"><span class="params">                                                                               WebMvcProperties webMvcProperties)</span> &#123;</span><br><span class="line">        <span class="type">DispatcherServletRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        registrationBean.setLoadOnStartup(webMvcProperties.getServlet().getLoadOnStartup());</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次重启程序，根据控制台输出的内容可知，Tomcat 此时监听的端口是 <code>9090</code>，<code>DispatcherServlet</code> 也在 Tomcat 启动时被初始化。</p>
<blockquote>
<p><code>DispatcherServlet</code> 初始化时执行的操作</p>
</blockquote>
<p>回到 <code>DispatcherServlet</code> 的 <code>onRefresh()</code> 方法，它又调用了 <code>initStrategies()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initStrategies</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.initMultipartResolver(context);</span><br><span class="line">    <span class="built_in">this</span>.initLocaleResolver(context);</span><br><span class="line">    <span class="built_in">this</span>.initThemeResolver(context);</span><br><span class="line">    <span class="built_in">this</span>.initHandlerMappings(context);</span><br><span class="line">    <span class="built_in">this</span>.initHandlerAdapters(context);</span><br><span class="line">    <span class="built_in">this</span>.initHandlerExceptionResolvers(context);</span><br><span class="line">    <span class="built_in">this</span>.initRequestToViewNameTranslator(context);</span><br><span class="line">    <span class="built_in">this</span>.initViewResolvers(context);</span><br><span class="line">    <span class="built_in">this</span>.initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中初始化了一系列组件，见名识意即可，重点介绍：</p>
<ul>
<li><code>initHandlerMappings()</code>：初始化处理器映射器</li>
<li><code>initHandlerAdapters()</code>：初始化处理器适配器</li>
<li><code>initHandlerExceptionResolvers()</code>：初始化异常处理器</li>
</ul>
<p>在所有的初始化方法中都有一个相似的逻辑，首先使用一个布尔值判断是否检测 <strong>所有</strong> 目标组件。</p>
<p>Spring 支持父子容器嵌套，如果判断的布尔值为 <code>true</code>，那么 Spring 不仅会在当前容器中获取目标组件，还会在其所有父级容器中寻找。</p>
<p>以 <code>initHandlerMappings()</code> 为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initHandlerMappings</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.handlerMappings = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.detectAllHandlerMappings) &#123; <span class="comment">// 是否需要检测所有处理器映射器</span></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 无需检测所有处理器映射器时，获取当前容器中的处理器映射器</span></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 当前容器中没有处理器映射器时，设置默认的处理器映射器</span></span><br><span class="line">        <span class="built_in">this</span>.handlerMappings = <span class="built_in">this</span>.getDefaultStrategies(context, HandlerMapping.class);</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="20-2-RequestMappingHandlerMapping"><a class="header-anchor" href="#20-2-RequestMappingHandlerMapping"></a>20.2 RequestMappingHandlerMapping</h2>
<p><code>HandlerMapping</code>，即处理器映射器，用于建立请求路径与控制器方法的映射关系。</p>
<p><code>RequestMappingHandlerMapping</code> 是 <code>HandlerMapping</code> 的一种实现，根据类名可知，它是通过 <code>@RequestMapping</code> 注解来实现路径映射。</p>
<p>当 Spring 容器中没有 <code>HandlerMapping</code> 的实现时，尽管 <code>DispatcherServlet</code> 在初始化时会添加一些默认的实现，但这些实现不会交由 Spring 管理，而是作为 <code>DispatcherServlet</code> 的成员变量。</p>
<p>在配置类中将 <code>RequestMappingHandlerMapping</code> 添加到 Spring 容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RequestMappingHandlerMapping <span class="title function_">requestMappingHandlerMapping</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestMappingHandlerMapping</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义一个控制器类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test1()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/test2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test2</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test2(&#123;&#125;)&quot;</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/test3&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test3</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test3(&#123;&#125;)&quot;</span>, token);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test4&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test4&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;张三&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写 <code>main()</code> 方法，从 Spring 容器中获取 <code>RequestMappingHandlerMapping</code>，再获取请求路径与映射器方法的映射关系，并根据给定请求获取控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">AnnotationConfigServletWebServerApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>(WebConfig.class);</span><br><span class="line">    <span class="comment">// 解析 @RequestMapping 以及派生注解，在初始化时生成路径与控制器方法的映射关系</span></span><br><span class="line">    <span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">    <span class="comment">// 获取映射结果</span></span><br><span class="line">    Map&lt;RequestMappingInfo, HandlerMethod&gt; handlerMethods = handlerMapping.getHandlerMethods();</span><br><span class="line">    handlerMethods.forEach((k, v) -&gt; System.out.println(k + <span class="string">&quot; = &quot;</span> + v));</span><br><span class="line">    <span class="comment">// 根据给定请求获取控制器方法，返回处理器执行链</span></span><br><span class="line">    <span class="type">HandlerExecutionChain</span> <span class="variable">chain</span> <span class="operator">=</span> handlerMapping.getHandler(<span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/test1&quot;</span>));</span><br><span class="line">    System.out.println(chain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
{GET [/test1]} = indi.mofan.a20.Controller1#test1()
{POST [/test2]} = indi.mofan.a20.Controller1#test2(String)
{PUT [/test3]} = indi.mofan.a20.Controller1#test3(String)
{ [/test4]} = indi.mofan.a20.Controller1#test4()
HandlerExecutionChain with [indi.mofan.a20.Controller1#test1()] and 0 interceptors
</pre>
<p><code>getHandler()</code> 方法返回的对象时处理器执行链，不仅包含映射器方法，还包含需要执行的拦截器信息。</p>
<blockquote>
<p><code>MockHttpServletRequest</code> 的使用</p>
</blockquote>
<p>需要导入以下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="20-3-RequestMappingHandlerAdapter"><a class="header-anchor" href="#20-3-RequestMappingHandlerAdapter"></a>20.3 RequestMappingHandlerAdapter</h2>
<p><code>RequestMappingHandlerAdapter</code> 实现了 <code>HandlerAdapter</code> 接口，<code>HandlerAdapter</code> 用于执行控制器方法，而 <code>RequestMapping</code> 表明 <code>RequestMappingHandlerAdapter</code> 用于执行被 <code>@RequestMapping</code> 注解标记的控制器方法。</p>
<p>同样需要在配置类中将 <code>RequestMappingHandlerAdapter</code> 添加到 Spring 容器，但该类中需要测试的方法被 <code>protected</code> 修饰，无法直接使用，因此创建一个子类，将子类添加到 Spring 容器中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRequestMappingHandlerAdapter</span> <span class="keyword">extends</span> <span class="title class_">RequestMappingHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">invokeHandlerMethod</span><span class="params">(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyRequestMappingHandlerAdapter <span class="title function_">myRequestMappingHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyRequestMappingHandlerAdapter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>main()</code> 方法中测试 <code>RequestMappingHandlerAdapter</code> 的 <code>invokeHandlerMethod()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;/test2&quot;</span>);</span><br><span class="line">    request.setParameter(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;mofan&quot;</span>);</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line">    <span class="type">MyRequestMappingHandlerAdapter</span> <span class="variable">handlerAdapter</span> <span class="operator">=</span> context.getBean(MyRequestMappingHandlerAdapter.class);</span><br><span class="line">    handlerAdapter.invokeHandlerMethod(request, response, ((HandlerMethod) handlerMapping.getHandler(request).getHandler()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[DEBUG] indi.mofan.a20.Controller1          - test2(mofan) 
</pre>
<p>实现控制器方法的调用很简单，但如何将请求参数与方法参数相绑定的呢？</p>
<p>显然是需要解析 <code>@RequestParam</code> 注解。</p>
<p>Spring 支持许多种类的控制器方法参数，不同种类的参数使用不同的解析器，使用 <code>MyRequestMappingHandlerAdapter</code> 的 <code>getArgumentResolvers()</code> 方法获取所有参数解析器。</p>
<p>Spring 也支持许多种类的控制器方法返回值类型，使用 <code>MyRequestMappingHandlerAdapter</code> 的 <code>getReturnValueHandlers()</code> 方法获取所有返回值处理器。</p>
<blockquote>
<p>自定义参数解析器</p>
</blockquote>
<p>假如经常需要使用到请求头中的 Token 信息，自定义 <code>@Token</code> 注解，使用该注解标记控制器方法的哪个参数来获取 Token 信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.PARAMETER)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Token &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使 <code>test3()</code> 控制器方法参数被 <code>@Token</code> 标记：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/test3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test3</span><span class="params">(<span class="meta">@Token</span> String token)</span> &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;test3(&#123;&#125;)&quot;</span>, token);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义参数解析器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parameter.getParameterAnnotation(Token.class) != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter,</span></span><br><span class="line"><span class="params">                                  ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                                  NativeWebRequest webRequest,</span></span><br><span class="line"><span class="params">                                  WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> webRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将参数解析器添加到 <code>HandlerAdapter</code> 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyRequestMappingHandlerAdapter <span class="title function_">myRequestMappingHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">TokenArgumentResolver</span> <span class="variable">tokenArgumentResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenArgumentResolver</span>();</span><br><span class="line">    <span class="type">MyRequestMappingHandlerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRequestMappingHandlerAdapter</span>();</span><br><span class="line">    adapter.setCustomArgumentResolvers(Collections.singletonList(tokenArgumentResolver));</span><br><span class="line">    <span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试执行 <code>test3()</code> 控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">tokenRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>(<span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;/test3&quot;</span>);</span><br><span class="line">    tokenRequest.addHeader(<span class="string">&quot;token&quot;</span>, <span class="string">&quot;token info&quot;</span>);</span><br><span class="line">    handlerAdapter.invokeHandlerMethod(tokenRequest, response, ((HandlerMethod) handlerMapping.getHandler(tokenRequest).getHandler()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[DEBUG] indi.mofan.a20.Controller1          - test3(token info) 
</pre>
<blockquote>
<p>自定义返回值处理器</p>
</blockquote>
<p>当 <code>@ResponseBody</code> 标记了控制器方法时，方法的返回值会转换成 JSON 写入响应体中。</p>
<p>自定义 <code>@Yml</code> 注解，被 <code>@Yml</code> 注解标记的控制器方法的返回值会转换成 YAML 写入响应体中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Yml &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使 <code>test4()</code> 控制器方法被 <code>@Yml</code> 注解标记：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test4&quot;)</span></span><br><span class="line"><span class="meta">@Yml</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;test4&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;张三&quot;</span>, <span class="number">18</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义返回值处理器将返回值转换成 YAML：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YmlReturnValueHandler</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodReturnValueHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsReturnType</span><span class="params">(MethodParameter returnType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> returnType.getMethodAnnotation(Yml.class) != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(Object returnValue,</span></span><br><span class="line"><span class="params">                                  MethodParameter returnType,</span></span><br><span class="line"><span class="params">                                  ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                                  NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 转换返回结果为 YAML</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>().dump(returnValue);</span><br><span class="line">        <span class="comment">// 将 YAML 字符串写入响应体</span></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> webRequest.getNativeResponse(HttpServletResponse.class);</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/plain;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().print(str);</span><br><span class="line">        <span class="comment">// 设置请求已经处理完毕</span></span><br><span class="line">        mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将返回值处理器添加到 <code>HandlerAdapter</code> 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MyRequestMappingHandlerAdapter <span class="title function_">myRequestMappingHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MyRequestMappingHandlerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRequestMappingHandlerAdapter</span>();</span><br><span class="line">    <span class="type">YmlReturnValueHandler</span> <span class="variable">ymlReturnValueHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YmlReturnValueHandler</span>();</span><br><span class="line">    adapter.setCustomReturnValueHandlers(Collections.singletonList(ymlReturnValueHandler));</span><br><span class="line">    <span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试执行 <code>test4()</code> 控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">test4Req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/test4&quot;</span>);</span><br><span class="line">    handlerAdapter.invokeHandlerMethod(test4Req, response, ((HandlerMethod) handlerMapping.getHandler(test4Req).getHandler()));</span><br><span class="line">    <span class="type">byte</span>[] content = response.getContentAsByteArray();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(content, StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[DEBUG] indi.mofan.a20.Controller1          - test4 
!!indi.mofan.a20.Controller1$User {age: 18, name: 张三}
</pre>
<h1 id="21-参数解析器"><a class="header-anchor" href="#21-参数解析器"></a>21. 参数解析器</h1>
<p>Spring 提供了许多种类的控制器方法参数解析器，定义一个包含多个不同种类参数的控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;name1&quot;)</span> String name1, // name1=张三</span></span><br><span class="line"><span class="params">            String name2, // name2=李四</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;age&quot;)</span> <span class="type">int</span> age, // age=<span class="number">18</span></span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(name = &quot;home&quot;, defaultValue = &quot;$&#123;JAVA_HOME&#125;&quot;)</span> String home1, // spring 获取数据</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, // 上传文件</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id, //  /test/<span class="number">124</span>   /test/&#123;id&#125;</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestHeader(&quot;Content-Type&quot;)</span> String header,</span></span><br><span class="line"><span class="params">            <span class="meta">@CookieValue(&quot;token&quot;)</span> String token,</span></span><br><span class="line"><span class="params">            <span class="meta">@Value(&quot;$&#123;JAVA_HOME&#125;&quot;)</span> String home2, // spring 获取数据  $&#123;&#125; #&#123;&#125;</span></span><br><span class="line"><span class="params">            HttpServletRequest request, // request, response, session ...</span></span><br><span class="line"><span class="params">            <span class="meta">@ModelAttribute(&quot;abc&quot;)</span> User user1, // name=zhang&amp;age=<span class="number">18</span></span></span><br><span class="line"><span class="params">            User user2, // name=zhang&amp;age=<span class="number">18</span></span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> User user3 // json</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将控制器方法封装成 <code>HandlerMethod</code> 并打印方法中每个参数的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 控制器方法封装成 HandlerMethod</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> Controller.class.getMethod(<span class="string">&quot;test&quot;</span>, String.class, String.class,</span><br><span class="line">            <span class="type">int</span>.class, String.class, MultipartFile.class,</span><br><span class="line">            <span class="type">int</span>.class, String.class, String.class,</span><br><span class="line">            String.class, HttpServletRequest.class, User.class,</span><br><span class="line">            User.class, User.class);</span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller</span>(), method);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">annotations</span> <span class="operator">=</span> Arrays.stream(parameter.getParameterAnnotations())</span><br><span class="line">                .map(i -&gt; i.annotationType().getSimpleName()).collect(Collectors.joining());</span><br><span class="line">        <span class="type">String</span> <span class="variable">appendAt</span> <span class="operator">=</span> annotations.length() &gt; <span class="number">0</span> ? <span class="string">&quot;@&quot;</span> + annotations + <span class="string">&quot; &quot;</span> : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置参数名解析器</span></span><br><span class="line">        parameter.initParameterNameDiscovery(<span class="keyword">new</span> <span class="title class_">DefaultParameterNameDiscoverer</span>());</span><br><span class="line">        System.out.println(<span class="string">&quot;[&quot;</span> + parameter.getParameterIndex() + <span class="string">&quot;] &quot;</span> + appendAt +</span><br><span class="line">                parameter.getParameterType().getSimpleName() + <span class="string">&quot; &quot;</span> + parameter.getParameterName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1
[1] String name2
[2] @RequestParam int age
[3] @RequestParam String home1
[4] @RequestParam MultipartFile file
[5] @PathVariable int id
[6] @RequestHeader String header
[7] @CookieValue String token
[8] @Value String home2
[9] HttpServletRequest request
[10] @ModelAttribute User user1
[11] User user2
[12] @RequestBody User user3
</pre>
<h2 id="21-2-RequestParam"><a class="header-anchor" href="#21-2-RequestParam"></a>21.2 @RequestParam</h2>
<p><code>@RequestParam</code> 注解的解析需要使用到 <code>RequestParamMethodArgumentResolver</code> 参数解析器。构造时需要两个参数：</p>
<ul>
<li><code>beanFactory</code>：Bean 工厂对象。需要解析 <code>$&#123;&#125;</code> 时，就需要指定 Bean 工厂对象</li>
<li><code>useDefaultResolution</code>：布尔类型参数。为 <code>false</code> 表示只解析添加了 <code>@RequestParam</code> 注解的参数，为 <code>true</code> 针对未添加 <code>@RequestParam</code> 注解的参数也使用该参数解析器进行解析。</li>
</ul>
<p><code>RequestParamMethodArgumentResolver</code> 利用 <code>resolveArgument()</code> 方法完成参数的解析，该方法需要传递四个参数：</p>
<ul>
<li><code>parameter</code>：参数对象</li>
<li><code>mavContainer</code>：<code>ModelAndView</code> 容器，用来存储中间的 Model 结果</li>
<li><code>webRequest</code>：由 <code>ServletWebRequest</code> 封装后的请求对象</li>
<li><code>binderFactory</code>：数据绑定工厂，用于完成对象绑定和类型转换，比如将字符串类型的 <code>18</code> 转换成整型</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> mockRequest();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 控制器方法封装成 HandlerMethod</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> Controller.class.getMethod(<span class="string">&quot;test&quot;</span>, String.class, String.class,</span><br><span class="line">            <span class="type">int</span>.class, String.class, MultipartFile.class,</span><br><span class="line">            <span class="type">int</span>.class, String.class, String.class,</span><br><span class="line">            String.class, HttpServletRequest.class, User.class,</span><br><span class="line">            User.class, User.class);</span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller</span>(), method);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备对象绑定与类型转换</span></span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">binderFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备 ModelAndViewContainer 用来存储中间的 Model 结果</span></span><br><span class="line">    <span class="type">ModelAndViewContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">        <span class="type">RequestParamMethodArgumentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">annotations</span> <span class="operator">=</span> Arrays.stream(parameter.getParameterAnnotations())</span><br><span class="line">                .map(i -&gt; i.annotationType().getSimpleName()).collect(Collectors.joining());</span><br><span class="line">        <span class="type">String</span> <span class="variable">appendAt</span> <span class="operator">=</span> annotations.length() &gt; <span class="number">0</span> ? <span class="string">&quot;@&quot;</span> + annotations + <span class="string">&quot; &quot;</span> : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置参数名解析器</span></span><br><span class="line">        parameter.initParameterNameDiscovery(<span class="keyword">new</span> <span class="title class_">DefaultParameterNameDiscoverer</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">paramInfo</span> <span class="operator">=</span> <span class="string">&quot;[&quot;</span> + parameter.getParameterIndex() + <span class="string">&quot;] &quot;</span> + appendAt +</span><br><span class="line">                parameter.getParameterType().getSimpleName() + <span class="string">&quot; &quot;</span> + parameter.getParameterName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resolver.supportsParameter(parameter)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">v</span> <span class="operator">=</span> resolver.resolveArgument(parameter, container, <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request), binderFactory);</span><br><span class="line">            System.out.println(Objects.requireNonNull(v).getClass());</span><br><span class="line">            System.out.println(paramInfo + <span class="string">&quot; -&gt; &quot;</span> + v);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(paramInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
class java.lang.String
[0] @RequestParam String name1 -> zhangsan
class java.lang.String
[1] String name2 -> lisi
class java.lang.Integer
[2] @RequestParam int age -> 18
class java.lang.String
[3] @RequestParam String home1 -> D:\environment\JDK1.8
class org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@f2ff811
<font style="color:red">Exception in thread "main" java.lang.IllegalStateException: Optional int parameter 'id' is present but cannot be translated into a null value due to being declared as a primitive type. Consider declaring it as object wrapper for the corresponding primitive type.</font>
</pre>
<p>控制器方法 <code>test()</code> 的前 5 个参数解析成功，但在解析第 6 个参数时产生了异常。</p>
<p>这是因为在构造 <code>RequestParamMethodArgumentResolver</code> 对象时，将 <code>useDefaultResolution</code> 设置为 <code>true</code>，针对未添加 <code>@RequestParam</code> 注解的参数都使用该参数解析器进行解析。第 6 个参数需要的 <code>id</code> 信息使用该解析器解析得到的结果是 <code>null</code>，无法将 <code>null</code> 值赋值给基本类型 <code>int</code>，显然第 6 个及其以后的参数应该使用其他参数解析器进行解析。</p>
<blockquote>
<p>多个参数解析器的组合 - 组合模式</p>
</blockquote>
<p>不同种类的参数需要不同的参数解析器，当前使用的参数解析器不支持当前参数的解析时，就应该换一个参数解析器进行解析。</p>
<p>可以将所有参数解析器添加到一个集合中，然后遍历这个集合，实现上述需求。</p>
<p>Spring 提供了名为 <code>HandlerMethodArgumentResolverComposite</code> 的类，对上述逻辑进行封装。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">                <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (composite.supportsParameter(parameter)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">v</span> <span class="operator">=</span> composite.resolveArgument(parameter, container, <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request), binderFactory);</span><br><span class="line">            System.out.println(paramInfo + <span class="string">&quot; -&gt; &quot;</span> + v);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(paramInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="21-2-PathVariable"><a class="header-anchor" href="#21-2-PathVariable"></a>21.2 @PathVariable</h2>
<p><code>@PathVariable</code> 注解的解析需要使用到 <code>PathVariableMethodArgumentResolver</code> 参数解析器。构造时无需传入任何参数。</p>
<p>使用该解析器需要一个 <code>Map</code> 集合，该 <code>Map</code> 集合是 <code>@RequestMapping</code> 注解上指定的路径和实际 URL 路径进行匹配后，得到的路径上的参数与实际路径上的值的关系（获取这个 <code>Map</code> 并将其设置给 <code>request</code> 作用域由 <code>HandlerMapping</code> 完成）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>RequestParamMethodArgumentResolver</code> 参数解析器的构造，将 <code>useDefaultResolution</code> 设置为 <code>false</code>，让程序 <strong>暂时</strong> 不抛出异常。</p>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@11c9af63
[5] @PathVariable int id -> 123
</pre>
<h2 id="21-3-RequestHeader"><a class="header-anchor" href="#21-3-RequestHeader"></a>21.3 @RequestHeader</h2>
<p><code>@RequestHeader </code> 注解的解析需要使用到 <code>RequestHeaderMethodArgumentResolver</code> 参数解析器。构造时需要传入一个Bean 工厂对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@3943a2be
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
</pre>
<h2 id="21-4-CookieValue"><a class="header-anchor" href="#21-4-CookieValue"></a>21.4 @CookieValue</h2>
<p><code>@CookieValue</code> 注解的解析需要使用到 <code>ServletCookieValueMethodArgumentResolver</code> 参数解析器。构造时需要传入一个Bean 工厂对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @CookieValue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletCookieValueMethodArgumentResolver</span>(beanFactory)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@1329eff
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
[7] @CookieValue String token -> 123456
</pre>
<h2 id="21-5-Value"><a class="header-anchor" href="#21-5-Value"></a>21.5 @Value</h2>
<p><code>@Value</code> 注解的解析需要使用到 <code>ExpressionValueMethodArgumentResolver</code> 参数解析器。构造时需要传入一个Bean 工厂对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @CookieValue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletCookieValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @Value</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ExpressionValueMethodArgumentResolver</span>(beanFactory)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@46fa7c39
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
[7] @CookieValue String token -> 123456
[8] @Value String home2 -> D:\environment\JDK1.8
</pre>
<h2 id="21-6-HttpServletRequest"><a class="header-anchor" href="#21-6-HttpServletRequest"></a>21.6 HttpServletRequest</h2>
<p><code>HttpServletRequest</code> 类型的参数的解析需要使用到 <code>ServletRequestMethodArgumentResolver</code> 参数解析器。构造时无需传入任何参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @CookieValue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletCookieValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @Value</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ExpressionValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 HttpServletRequest</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletRequestMethodArgumentResolver</span>()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@5f683daf
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
[7] @CookieValue String token -> 123456
[8] @Value String home2 -> D:\environment\JDK1.8
[9] HttpServletRequest request -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@152aa092
</pre>
<p><code>ServletRequestMethodArgumentResolver</code> 参数解析器不仅可以解析 <code>HttpServletRequest</code> 类型的参数，还支持许多其他类型的参数，其支持的参数类型可在 <code>supportsParameter()</code> 方法中看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line">    <span class="keyword">return</span> (WebRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">            ServletRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">            MultipartRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">            HttpSession.class.isAssignableFrom(paramType) ||</span><br><span class="line">            (pushBuilder != <span class="literal">null</span> &amp;&amp; pushBuilder.isAssignableFrom(paramType)) ||</span><br><span class="line">            (Principal.class.isAssignableFrom(paramType) &amp;&amp; !parameter.hasParameterAnnotations()) ||</span><br><span class="line">            InputStream.class.isAssignableFrom(paramType) ||</span><br><span class="line">            Reader.class.isAssignableFrom(paramType) ||</span><br><span class="line">            HttpMethod.class == paramType ||</span><br><span class="line">            Locale.class == paramType ||</span><br><span class="line">            TimeZone.class == paramType ||</span><br><span class="line">            ZoneId.class == paramType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="21-7-ModelAttribute"><a class="header-anchor" href="#21-7-ModelAttribute"></a>21.7 @ModelAttribute</h2>
<p><code>@ModelAttribute</code> 注解的解析需要使用到 <code>ServletModelAttributeMethodProcessor</code> 参数解析器。构造时需要传入一个布尔类型的值。为 <code>false</code> 时，表示 <code>@ModelAttribute</code> 不是不必须的，即是必须的。</p>
<p>针对 <code>@ModelAttribute(&quot;abc&quot;) User user1</code> 和 <code>User user2</code> 两种参数来说，尽管后者没有使用 <code>@ModelAttribute</code> 注解，但它们使用的是同一种解析器。</p>
<p>添加两个 <code>ServletModelAttributeMethodProcessor</code> 参数解析器，先解析带 <code>@ModelAttribute</code> 注解的参数，再解析不带 <code>@ModelAttribute</code> 注解的参数。</p>
<p>通过 <code>ServletModelAttributeMethodProcessor</code> 解析得到的数据还会被存入 <code>ModelAndViewContainer</code> 中。存储的数据结构是一个 <code>Map</code>，其 key 为 <code>@ModelAttribute</code> 注解指定的 value 值，在未显式指定的情况下，默认为对象类型的首字母小写对应的字符串。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(</span></span><br><span class="line"><span class="params">        // 指定 value</span></span><br><span class="line"><span class="params">        <span class="meta">@ModelAttribute(&quot;abc&quot;)</span> User user1, // name=zhang&amp;age=<span class="number">18</span></span></span><br><span class="line"><span class="params">        User user2, // name=zhang&amp;age=<span class="number">18</span></span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> User user3 // json</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @CookieValue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletCookieValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @Value</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ExpressionValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 HttpServletRequest</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletRequestMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @ModelAttribute，且不能省略</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">false</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (composite.supportsParameter(parameter)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">v</span> <span class="operator">=</span> composite.resolveArgument(parameter, container, <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request), binderFactory);</span><br><span class="line">            System.out.println(paramInfo + <span class="string">&quot; -&gt; &quot;</span> + v);</span><br><span class="line">            <span class="comment">// 打印模型数据</span></span><br><span class="line">            <span class="type">ModelMap</span> <span class="variable">modelMap</span> <span class="operator">=</span> container.getModel();</span><br><span class="line">            <span class="keyword">if</span> (MapUtils.isNotEmpty(modelMap)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;模型数据: &quot;</span> + modelMap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(paramInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@2beee7ff
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
[7] @CookieValue String token -> 123456
[8] @Value String home2 -> D:\environment\JDK1.8
[9] HttpServletRequest request -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@5fa07e12
[10] @ModelAttribute User user1 -> A21.User(name=张三, age=18)
模型数据: {abc=A21.User(name=张三, age=18), org.springframework.validation.BindingResult.abc=org.springframework.validation.BeanPropertyBindingResult: 0 errors}
[11] User user2 -> A21.User(name=张三, age=18)
模型数据: {abc=A21.User(name=张三, age=18), org.springframework.validation.BindingResult.abc=org.springframework.validation.BeanPropertyBindingResult: 0 errors, user=A21.User(name=张三, age=18), org.springframework.validation.BindingResult.user=org.springframework.validation.BeanPropertyBindingResult: 0 errors}
[12] @RequestBody User user3 -> A21.User(name=李四, age=20)
模型数据: {abc=A21.User(name=张三, age=18), org.springframework.validation.BindingResult.abc=org.springframework.validation.BeanPropertyBindingResult: 0 errors, user=A21.User(name=张三, age=18), org.springframework.validation.BindingResult.user=org.springframework.validation.BeanPropertyBindingResult: 0 errors}
</pre>
<p><code>@RequestBody User user3</code> 参数也被 <code>ServletModelAttributeMethodProcessor</code> 解析了，如果想使其数据通过 JSON 数据转换而来，则需要使用另一个参数解析器。</p>
<h2 id="21-8-RequestBody"><a class="header-anchor" href="#21-8-RequestBody"></a>21.8 @RequestBody</h2>
<p><code>@RequestBody</code> 注解的解析需要使用到 <code>RequestResponseBodyMethodProcessor</code> 参数解析器。构造时需要传入一个消息转换器列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @CookieValue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletCookieValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @Value</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ExpressionValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 HttpServletRequest</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletRequestMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @ModelAttribute，且不能省略</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">false</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>())),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@5e17553a
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
[7] @CookieValue String token -> 123456
[8] @Value String home2 -> D:\environment\JDK1.8
[9] HttpServletRequest request -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@13bc8645
[10] @ModelAttribute User user1 -> A21.User(name=张三, age=18)
[11] User user2 -> A21.User(name=张三, age=18)
[12] @RequestBody User user3 -> A21.User(name=李四, age=20)
</pre>
<p><code>@RequestBody User user3</code> 参数数据通过 JSON 数据得到，与上一节的解析进行区分。</p>
<p>除此之外，添加的参数解析器顺序也影响着解析结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">false</span>),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>())),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>先添加解析 <code>@ModelAttribute</code> 注解的解析器，再添加解析 <code>@RequestBody</code> 注解的解析器，最后添加解析省略了 <code>@ModelAttribute</code> 注解的解析器。如果更换最后两个解析器的顺序，那么 <code>@RequestBody User user3</code> 将会被 <code>ServletModelAttributeMethodProcessor</code> 解析，而不是 <code>RequestResponseBodyMethodProcessor</code>。</p>
<p>因此 <code>String name2</code> 参数也能通过添加同种参数但不同构造参数的解析器进行解析，注意添加的解析器的顺序，先处理对象，再处理单个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析每个参数值</span></span><br><span class="line">    <span class="keyword">for</span> (MethodParameter parameter : handlerMethod.getMethodParameters()) &#123;</span><br><span class="line">        <span class="comment">// 多个参数解析器的组合</span></span><br><span class="line">        <span class="type">HandlerMethodArgumentResolverComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodArgumentResolverComposite</span>();</span><br><span class="line">        composite.addResolvers(</span><br><span class="line">            <span class="comment">// useDefaultResolution 为 false 表示必须添加 @RequestParam 注解</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">false</span>),</span><br><span class="line">            <span class="comment">// 解析 @PathVariable</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathVariableMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @RequestHeader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestHeaderMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @CookieValue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletCookieValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 @Value</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ExpressionValueMethodArgumentResolver</span>(beanFactory),</span><br><span class="line">            <span class="comment">// 解析 HttpServletRequest</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletRequestMethodArgumentResolver</span>(),</span><br><span class="line">            <span class="comment">// 解析 @ModelAttribute，且不能省略</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">false</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>())),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">true</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RequestParamMethodArgumentResolver</span>(beanFactory, <span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[0] @RequestParam String name1 -> zhangsan
[1] String name2 -> lisi
[2] @RequestParam int age -> 18
[3] @RequestParam String home1 -> D:\environment\JDK1.8
[4] @RequestParam MultipartFile file -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@5e17553a
[5] @PathVariable int id -> 123
[6] @RequestHeader String header -> application/json
[7] @CookieValue String token -> 123456
[8] @Value String home2 -> D:\environment\JDK1.8
[9] HttpServletRequest request -> org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@13bc8645
[10] @ModelAttribute User user1 -> A21.User(name=张三, age=18)
[11] User user2 -> A21.User(name=张三, age=18)
[12] @RequestBody User user3 -> A21.User(name=李四, age=20)
</pre>
<h1 id="22-获取参数名"><a class="header-anchor" href="#22-获取参数名"></a>22. 获取参数名</h1>
<p>在项目的 <code>src</code> 目录外创建一个 <code>Bean2.java</code> 文件，使其不会被 IDEA 自动编译：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> indi.mofan.a22;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将命令行切换到 <code>Bean2.java</code> 文件所在目录的位置，执行 <code>javac .\Bean2.java</code> 命令手动编译 <code>Bean2.java</code>。查看 <code>Bean2.class</code> 文件的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> indi.mofan.a22;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Bean2</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(String var1, <span class="type">int</span> var2)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译生成的 <code>class</code> 文件中的 <code>foo()</code> 方法的参数名称不再是 <code>name</code> 和 <code>age</code>，也就是说直接使用 <code>javac</code> 命令进行编译得到的字节码文件不会保存方法的参数名称。</p>
<p>执行 <code>javac -parameters .\Bean2.java</code> 再次编译 <code>Bean2.java</code>，并查看得到的 <code>Bean2.class</code> 文件内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> indi.mofan.a22;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Bean2</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>foo()</code> 方法的参数名称得以保留。</p>
<p>还可以使用 <code>javap -c -v  .\Bean2.class</code> 命令反编译 <code>Bean2.class</code>，<code>foo()</code> 方法的反编译结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void foo(java.lang.String, int);</span><br><span class="line">  descriptor: (Ljava/lang/String;I)V</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=0, locals=3, args_size=3</span><br><span class="line">       0: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 6: 0</span><br><span class="line">  MethodParameters:</span><br><span class="line">    Name                           Flags</span><br><span class="line">    name</span><br><span class="line">    age</span><br></pre></td></tr></table></figure>
<p><code>foo()</code> 方法的参数信息被保存在 <code>MethodParameters</code> 中，可以使用 <strong>反射</strong> 获取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 反射获取参数名</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">foo</span> <span class="operator">=</span> Bean2.class.getMethod(<span class="string">&quot;foo&quot;</span>, String.class, <span class="type">int</span>.class);</span><br><span class="line">    <span class="keyword">for</span> (Parameter parameter : foo.getParameters()) &#123;</span><br><span class="line">        System.out.println(parameter.getName());       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
name
age
</pre>
<p>使用 <code>javac -g .\Bean2.java</code> 命令进行编译也会保留方法的参数信息。再次使用 <code>javap</code> 反编译 <code>Bean2.class</code>，<code>foo()</code> 方法的反编译结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(java.lang.String, <span class="type">int</span>)</span>;</span><br><span class="line">  descriptor: (Ljava/lang/String;I)V</span><br><span class="line">  flags: ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=<span class="number">0</span>, locals=<span class="number">3</span>, args_size=<span class="number">3</span></span><br><span class="line">       <span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line <span class="number">6</span>: <span class="number">0</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>  <span class="built_in">this</span>   Lindi/mofan/a22/Bean2;</span><br><span class="line">          <span class="number">0</span>       <span class="number">1</span>     <span class="number">1</span>  name   Ljava/lang/String;</span><br><span class="line">          <span class="number">0</span>       <span class="number">1</span>     <span class="number">2</span>   age   I</span><br></pre></td></tr></table></figure>
<p><code>foo()</code> 方法的参数信息被保存在 <code>LocalVariableTable</code> 中，不能使用反射获取，但可以使用 ASM 获取，使用 Spring 封装的解析工具：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 反射获取参数名</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">foo</span> <span class="operator">=</span> Bean2.class.getMethod(<span class="string">&quot;foo&quot;</span>, String.class, <span class="type">int</span>.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基于 LocalVariableTable 本地变量表获取</span></span><br><span class="line">    <span class="type">LocalVariableTableParameterNameDiscoverer</span> <span class="variable">discoverer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalVariableTableParameterNameDiscoverer</span>();</span><br><span class="line">    String[] parameterNames = discoverer.getParameterNames(foo);</span><br><span class="line">    System.out.println(Arrays.toString(parameterNames));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>[name, age]</pre>
<p>在【21. 参数解析器】中并没有使用 <code>LocalVariableTableParameterNameDiscoverer</code>，而是使用的是 <code>DefaultParameterNameDiscoverer</code>。<code>DefaultParameterNameDiscoverer</code> 将两种实现进行了统一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultParameterNameDiscoverer</span> <span class="keyword">extends</span> <span class="title class_">PrioritizedParameterNameDiscoverer</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">DefaultParameterNameDiscoverer</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (KotlinDetector.isKotlinReflectPresent() &amp;&amp; !NativeDetector.inNativeImage()) &#123;</span><br><span class="line">         addDiscoverer(<span class="keyword">new</span> <span class="title class_">KotlinReflectionParameterNameDiscoverer</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      addDiscoverer(<span class="keyword">new</span> <span class="title class_">StandardReflectionParameterNameDiscoverer</span>());</span><br><span class="line">      addDiscoverer(<span class="keyword">new</span> <span class="title class_">LocalVariableTableParameterNameDiscoverer</span>());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>javac -g</code> 的局限性</p>
</blockquote>
<p>假设有这样一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> indi.mofan.a22;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(String name, <span class="type">int</span> age)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用 <code>javac -g .\Bean1.java</code> 命令进行编译后，再利用 <code>javap</code> 查看 <code>foo()</code> 方法的反编译结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public abstract void foo(java.lang.String, int);</span><br><span class="line">  descriptor: (Ljava/lang/String;I)V</span><br><span class="line">  flags: ACC_PUBLIC, ACC_ABSTRACT</span><br></pre></td></tr></table></figure>
<p>并没有记录抽象方法 <code>foo()</code> 的参数信息。</p>
<p>如果使用 <code>javac -parameters .\Bean1.java</code> 呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public abstract void foo(java.lang.String, int);</span><br><span class="line">  descriptor: (Ljava/lang/String;I)V</span><br><span class="line">  flags: ACC_PUBLIC, ACC_ABSTRACT</span><br><span class="line">  MethodParameters:</span><br><span class="line">    Name                           Flags</span><br><span class="line">    name</span><br><span class="line">    age</span><br></pre></td></tr></table></figure>
<p>参数信息得以保留。</p>
<h1 id="23-对象绑定与类型转换"><a class="header-anchor" href="#23-对象绑定与类型转换"></a>23. 对象绑定与类型转换</h1>
<h2 id="23-1-三种转换接口"><a class="header-anchor" href="#23-1-三种转换接口"></a>23.1 三种转换接口</h2>
<blockquote>
<p>底层第一套转换接口与实现</p>
</blockquote>
<pre><code class="highlight mermaid">classDiagram

Formatter --|&gt; Printer
Formatter --|&gt; Parser

class Converters &#123;
   Set~GenericConverter~
&#125;
class Converter

class ConversionService
class FormattingConversionService

ConversionService &lt;|-- FormattingConversionService
FormattingConversionService o-- Converters

Printer --&gt; Adapter1
Adapter1 --&gt; Converters
Parser --&gt; Adapter2
Adapter2 --&gt; Converters
Converter --&gt; Adapter3
Adapter3 --&gt; Converters

&lt;&lt;interface&gt;&gt; Formatter
&lt;&lt;interface&gt;&gt; Printer
&lt;&lt;interface&gt;&gt; Parser
&lt;&lt;interface&gt;&gt; Converter
&lt;&lt;interface&gt;&gt; ConversionService</code></pre>
<ul>
<li><code>Printer</code> 把其它类型转为 <code>String</code></li>
<li><code>Parser</code> 把 <code>String</code> 转为其它类型</li>
<li><code>Formatter</code> 综合 <code>Printer</code> 与 <code>Parser</code> 的功能</li>
<li><code>Converter</code> 把类型 <code>S</code> 转为类型 <code>T</code></li>
<li><code>Printer</code>、<code>Parser</code>、<code>Converter</code> 经过适配转换成 <code>GenericConverter</code> 放入 <code>Converters</code> 集合</li>
<li><code>FormattingConversionService</code> 利用其它接口实现转换</li>
</ul>
<blockquote>
<p>底层第二套转换接口</p>
</blockquote>
<p>由 JDK 提供，而不是 Spring。</p>
<pre><code class="highlight mermaid">classDiagram

PropertyEditorRegistry o-- &quot;多&quot; PropertyEditor

&lt;&lt;interface&gt;&gt; PropertyEditorRegistry
&lt;&lt;interface&gt;&gt; PropertyEditor</code></pre>
<ul>
<li><code>PropertyEditor</code> 将 <code>String</code> 与其它类型相互转换</li>
<li><code>PropertyEditorRegistry</code> 可以注册多个 <code>PropertyEditor</code> 对象</li>
<li>可以通过 <code>FormatterPropertyEditorAdapter</code> 与第一套接口进行适配</li>
</ul>
<blockquote>
<p>高层转换接口与实现</p>
</blockquote>
<pre><code class="highlight mermaid">classDiagram
TypeConverter &lt;|-- SimpleTypeConverter
TypeConverter &lt;|-- BeanWrapperImpl
TypeConverter &lt;|-- DirectFieldAccessor
TypeConverter &lt;|-- ServletRequestDataBinder

SimpleTypeConverter --&gt; TypeConverterDelegate
BeanWrapperImpl --&gt; TypeConverterDelegate
DirectFieldAccessor --&gt; TypeConverterDelegate
ServletRequestDataBinder --&gt; TypeConverterDelegate

TypeConverterDelegate --&gt; ConversionService
TypeConverterDelegate --&gt; PropertyEditorRegistry

&lt;&lt;interface&gt;&gt; TypeConverter
&lt;&lt;interface&gt;&gt; ConversionService
&lt;&lt;interface&gt;&gt; PropertyEditorRegistry</code></pre>
<ul>
<li>它们都实现了 <code>TypeConverter</code> 高层转换接口，在转换时会用到 <code>TypeConverterDelegate</code> 委派<code>ConversionService</code> 与 <code>PropertyEditorRegistry</code> 真正执行转换（使用 Facade 门面模式）
<ul>
<li>首先查看是否存在实现了 <code>PropertyEditorRegistry</code> 的自定义转换器，<code>@InitBinder</code> 注解实现的就是自定义转换器（用了适配器模式把 <code>Formatter</code> 转为需要的 <code>PropertyEditor</code>）</li>
<li>再查看是否存在 <code>ConversionService</code> 实现</li>
<li>再利用默认的 <code>PropertyEditor</code> 实现</li>
<li>最后有一些特殊处理</li>
</ul>
</li>
<li><code>SimpleTypeConverter</code> 仅做类型转换</li>
<li><code>BeanWrapperImpl</code> 利用 <code>Property</code>，即 <code>Getter/Setter</code>，为 Bean 的属性赋值，，必要时进行类型转换</li>
<li><code>DirectFieldAccessor</code> 利用 <code>Field</code>，即字段，为 Bean 的字段赋值，必要时进行类型转换</li>
<li><code>ServletRequestDataBinder</code> 为 Bean 的属性执行绑定，必要时进行类型转换，根据布尔类型成员变量 <code>directFieldAccess</code> 选择利用 <code>Property</code> 还是 <code>Field</code>，还具备校验与获取校验结果功能</li>
</ul>
<h2 id="23-2-使用示例"><a class="header-anchor" href="#23-2-使用示例"></a>23.2 使用示例</h2>
<blockquote>
<p>SimpleTypeConverter</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SimpleTypeConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleTypeConverter</span>();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">number</span> <span class="operator">=</span> converter.convertIfNecessary(<span class="string">&quot;13&quot;</span>, <span class="type">int</span>.class);</span><br><span class="line">    System.out.println(number);</span><br><span class="line">    <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> converter.convertIfNecessary(<span class="string">&quot;1999/03/04&quot;</span>, Date.class);</span><br><span class="line">    System.out.println(date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
13
Thu Mar 04 00:00:00 CST 1999
</pre>
<blockquote>
<p>BeanWrapperImpl</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 利用反射为 bean 的属性赋值</span></span><br><span class="line">    <span class="type">MyBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    <span class="type">BeanWrapperImpl</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWrapperImpl</span>(bean);</span><br><span class="line">    wrapper.setPropertyValue(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">    wrapper.setPropertyValue(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    wrapper.setPropertyValue(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;1999/03/04&quot;</span>);</span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> String b;</span><br><span class="line">    <span class="keyword">private</span> Date c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>TestBeanWrapper.MyBean(a=10, b=hello, c=Thu Mar 04 00:00:00 CST 1999)</pre>
<blockquote>
<p>DirectFieldAccessor</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 利用反射为 bean 的字段赋值</span></span><br><span class="line">    <span class="type">MyBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    <span class="type">DirectFieldAccessor</span> <span class="variable">accessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectFieldAccessor</span>(bean);</span><br><span class="line">    accessor.setPropertyValue(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">    accessor.setPropertyValue(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    accessor.setPropertyValue(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;1999/03/04&quot;</span>);</span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> String b;</span><br><span class="line">    <span class="keyword">private</span> Date c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>TestFieldAccessor.MyBean(a=10, b=hello, c=Thu Mar 04 00:00:00 CST 1999)</pre>
<blockquote>
<p>DataBinder</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 执行数据绑定</span></span><br><span class="line">    <span class="type">MyBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    <span class="type">DataBinder</span> <span class="variable">binder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataBinder</span>(bean);</span><br><span class="line">    <span class="type">MutablePropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>();</span><br><span class="line">    pvs.add(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">    pvs.add(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    pvs.add(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;1999/03/04&quot;</span>);</span><br><span class="line">    binder.bind(pvs);</span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> String b;</span><br><span class="line">    <span class="keyword">private</span> Date c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>TestDataBinder.MyBean(a=10, b=hello, c=Thu Mar 04 00:00:00 CST 1999)</pre>
<p>如果 <code>MyBean</code> 没有提供 <code>Getter/Setter</code> 方法，可以调用 <code>DataBinder</code> 的 <code>initDirectFieldAccess()</code> 方法使数据绑定逻辑走字段赋值，而不是属性赋值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 执行数据绑定</span></span><br><span class="line">    <span class="type">MyBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    <span class="type">DataBinder</span> <span class="variable">binder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataBinder</span>(bean);</span><br><span class="line">    binder.initDirectFieldAccess();</span><br><span class="line">    <span class="type">MutablePropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>();</span><br><span class="line">    pvs.add(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">    pvs.add(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    pvs.add(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;1999/03/04&quot;</span>);</span><br><span class="line">    binder.bind(pvs);</span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> String b;</span><br><span class="line">    <span class="keyword">private</span> Date c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>TestDataBinder.MyBean(a=10, b=hello, c=Thu Mar 04 00:00:00 CST 1999)</pre>
<blockquote>
<p>Web 环境下的数据绑定</p>
</blockquote>
<p>Web 环境下的数据绑定需要使用 <code>DataBinder</code> 的子类 <code>ServletRequestDataBinder</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// web 环境下的数据绑定</span></span><br><span class="line">    <span class="type">MyBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line">    <span class="type">DataBinder</span> <span class="variable">dataBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinder</span>(bean);</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    request.setParameter(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;10&quot;</span>);</span><br><span class="line">    request.setParameter(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    request.setParameter(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;1999/03/04&quot;</span>);</span><br><span class="line"></span><br><span class="line">    dataBinder.bind(<span class="keyword">new</span> <span class="title class_">ServletRequestParameterPropertyValues</span>(request));</span><br><span class="line"></span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> String b;</span><br><span class="line">    <span class="keyword">private</span> Date c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>TestServletDataBinder.MyBean(a=10, b=hello, c=Thu Mar 04 00:00:00 CST 1999)</pre>
<h2 id="23-3-绑定器工厂"><a class="header-anchor" href="#23-3-绑定器工厂"></a>23.3 绑定器工厂</h2>
<p>现有如下两个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 Web 环境下进行数据绑定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    request.setParameter(<span class="string">&quot;birthday&quot;</span>, <span class="string">&quot;1999|01|02&quot;</span>);</span><br><span class="line">    request.setParameter(<span class="string">&quot;address.name&quot;</span>, <span class="string">&quot;成都&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="type">ServletRequestDataBinder</span> <span class="variable">dataBinder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinder</span>(user);</span><br><span class="line"></span><br><span class="line">    dataBinder.bind(<span class="keyword">new</span> <span class="title class_">ServletRequestParameterPropertyValues</span>(request));</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>birthday</code> 和 <code>address.name</code> 都能绑定成功吗？</p>
<pre>TestServletDataBinderFactory.User(birthday=null, address=TestServletDataBinderFactory.Address(name=成都))</pre>
<p><code>birthday</code> 绑定失败，要想使其绑定成功，需要自定义转换器，有两种方式：</p>
<ul>
<li>使用 Spring 提供的 <code>ConversionService</code></li>
<li>使用 JDK 提供的 <code>PropertyEditorRegistry</code></li>
</ul>
<p>创建 <code>DataBinder</code> 的职责交由 <code>DataBinderFactory</code> 完成，以便添加各种选项，拓展不同的自定义转换器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    request.setParameter(<span class="string">&quot;birthday&quot;</span>, <span class="string">&quot;1999|01|02&quot;</span>);</span><br><span class="line">    request.setParameter(<span class="string">&quot;address.name&quot;</span>, <span class="string">&quot;成都&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="type">WebDataBinder</span> <span class="variable">dataBinder</span> <span class="operator">=</span> factory.createBinder(<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request), user, <span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">    dataBinder.bind(<span class="keyword">new</span> <span class="title class_">ServletRequestParameterPropertyValues</span>(request));</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，控制台输出的结果不变。</p>
<blockquote>
<p>利用 <code>@InitBinder</code> 自定义转换器</p>
</blockquote>
<p>声明一个 Controller 类，其中包含一个被 <code>@InitBinder</code> 注解标记的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myMethod</span><span class="params">(WebDataBinder dataBinder)</span> &#123;</span><br><span class="line">        <span class="comment">// 拓展 dataBinder 的转换器</span></span><br><span class="line">        dataBinder.addCustomFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;用 @InitBinder 进行拓展&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以 <code>WebDataBinder</code> 作为方法参数，在方法体类添加自定义转换器 <code>MyDateFormatter</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDateFormatter</span> <span class="keyword">implements</span> <span class="title class_">Formatter</span>&lt;Date&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String desc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyDateFormatter</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">        <span class="comment">// 仅做测试</span></span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">print</span><span class="params">(Date date, Locale locale)</span> &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy|MM|dd&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sdf.format(date);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">parse</span><span class="params">(String text, Locale locale)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; 进入了: &#123;&#125;&quot;</span>, desc);</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy|MM|dd&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sdf.parse(text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在构造 <code>DataBinderFactory</code> 时传入 <code>InvocableHandlerMethod</code> 列表，列表中包含根据 Controller 对象、Controller 类中被 <code>@InitBinder</code> 注解标记的方法对象构造的 <code>InvocableHandlerMethod</code> 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">InvocableHandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvocableHandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">MyController</span>(), MyController.class.getMethod(<span class="string">&quot;myMethod&quot;</span>, WebDataBinder.class));</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(Collections.singletonList(handlerMethod), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次执行 <code>main()</code>，<code>birthday</code> 被成功绑定：</p>
<pre>
[DEBUG] indi.mofan.a23.MyDateFormatter      - >>>>>> 进入了: 用 @InitBinder 进行拓展 
TestServletDataBinderFactory.User(birthday=Sat Jan 02 00:00:00 CST 1999, address=TestServletDataBinderFactory.Address(name=成都))
</pre>
<p>这种方式使用了 JDK 提供的 <code>PropertyEditorRegistry</code>，证据就在 <code>WebDataBinder</code> 的 <code>addCustomFormatter()</code> 方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCustomFormatter</span><span class="params">(Formatter&lt;?&gt; formatter)</span> &#123;</span><br><span class="line">   <span class="type">FormatterPropertyEditorAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FormatterPropertyEditorAdapter</span>(formatter);</span><br><span class="line">   getPropertyEditorRegistry().registerCustomEditor(adapter.getFieldType(), adapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ConversionService</code> 拓展</p>
</blockquote>
<p>选择 <code>FormattingConversionService</code> 作为 <code>ConversionService</code> 的实现，向其中添加自定义转换器 <code>MyDateFormatter</code>。</p>
<p>构造 <code>DataBinderFactory</code> 时传入 <code>WebBindingInitializer</code> 的实现，因此将 <code>FormattingConversionService</code> 封装成 <code>ConfigurableWebBindingInitializer</code> 传入 <code>DataBinderFactory</code> 的构造方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip-- </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 ConversionService 转换</span></span><br><span class="line">    <span class="type">FormattingConversionService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FormattingConversionService</span>();</span><br><span class="line">    service.addFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;用 ConversionService 方式拓展转换功能&quot;</span>));</span><br><span class="line">    <span class="type">ConfigurableWebBindingInitializer</span> <span class="variable">initializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurableWebBindingInitializer</span>();</span><br><span class="line">    initializer.setConversionService(service);</span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(<span class="literal">null</span>, initializer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[DEBUG] indi.mofan.a23.MyDateFormatter      - >>>>>> 进入了: 用 ConversionService 方式拓展转换功能 
TestServletDataBinderFactory.User(birthday=Sat Jan 02 00:00:00 CST 1999, address=TestServletDataBinderFactory.Address(name=成都))
</pre>
<p>如果同时存在 <code>@InitBinder</code> 和 <code>ConversionService</code>，将以 <code>@InitBinder</code> 为主，<code>@InitBinder</code> 实现的转换器属于自定义转换器，自定义转换器的优先级更高：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip-- </span></span><br><span class="line"></span><br><span class="line">    <span class="type">FormattingConversionService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FormattingConversionService</span>();</span><br><span class="line">    service.addFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;用 ConversionService 方式拓展转换功能&quot;</span>));</span><br><span class="line">    <span class="type">ConfigurableWebBindingInitializer</span> <span class="variable">initializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurableWebBindingInitializer</span>();</span><br><span class="line">    initializer.setConversionService(service);</span><br><span class="line">    <span class="type">InvocableHandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvocableHandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">MyController</span>(), MyController.class.getMethod(<span class="string">&quot;myMethod&quot;</span>, WebDataBinder.class));</span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(Collections.singletonList(handlerMethod), initializer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
[DEBUG] indi.mofan.a23.MyDateFormatter      - >>>>>> 进入了: 用 @InitBinder 进行拓展 
TestServletDataBinderFactory.User(birthday=Sat Jan 02 00:00:00 CST 1999, address=TestServletDataBinderFactory.Address(name=成都))
</pre>
<blockquote>
<p>默认的 <code>ConversionService</code></p>
</blockquote>
<p><code>ConversionService</code> 有一个默认实现 <code>DefaultFormattingConversionService</code>，它还是 <code>FormattingConversionService</code> 的子类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip-- </span></span><br><span class="line"></span><br><span class="line">    <span class="type">DefaultFormattingConversionService</span> <span class="variable">conversionService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFormattingConversionService</span>();</span><br><span class="line">    <span class="type">ConfigurableWebBindingInitializer</span> <span class="variable">initializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurableWebBindingInitializer</span>();</span><br><span class="line">    initializer.setConversionService(conversionService);</span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(<span class="literal">null</span>, initializer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，控制台打印出：</p>
<pre>
TestServletDataBinderFactory.User(birthday=null, address=TestServletDataBinderFactory.Address(name=成都))
</pre>
<p><code>birthday</code> 绑定失败，默认的 <code>ConversionService</code> 需要搭配注解 <code>@DateTimeFormat</code> 使用。在目标类的字段上使用该注解标记，并指定被转换的日期格式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy|MM|dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次运行 <code>main()</code> 方法：</p>
<pre>
TestServletDataBinderFactory.User(birthday=Sat Jan 02 00:00:00 CST 1999, address=TestServletDataBinderFactory.Address(name=成都))
</pre>
<p>在 SpringBoot 中还提供了 <code>ApplicationConversionService</code>，它也是 <code>FormattingConversionService</code> 的子类，上述代码将 <code>DefaultFormattingConversionService</code> 换成 <code>ApplicationConversionService</code> 也能达到相同效果。</p>
<h2 id="23-4-Spring-的泛型操作技巧"><a class="header-anchor" href="#23-4-Spring-的泛型操作技巧"></a>23.4 Spring 的泛型操作技巧</h2>
<p>有一基类 <code>BaseDao</code>，接收一个泛型参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseDao</span>&lt;T&gt; &#123;</span><br><span class="line">    T <span class="title function_">findOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>围绕 <code>BaseDao</code> 有如下五个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeDao</span> <span class="keyword">extends</span> <span class="title class_">BaseDao</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentDao</span> <span class="keyword">extends</span> <span class="title class_">BaseDao</span>&lt;Student&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeacherDao</span> <span class="keyword">extends</span> <span class="title class_">BaseDao</span>&lt;Teacher&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试获取 <code>BaseDao</code> 子类泛型参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. java api</span></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// 带有泛型信息的父类信息</span></span><br><span class="line">    <span class="type">Type</span> <span class="variable">teacherDaoType</span> <span class="operator">=</span> TeacherDao.class.getGenericSuperclass();</span><br><span class="line">    System.out.println(<span class="string">&quot;TeacherDao type: &quot;</span> + teacherDaoType);</span><br><span class="line">    System.out.println(<span class="string">&quot;TeacherDao type class: &quot;</span> + teacherDaoType.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="type">Type</span> <span class="variable">employeeDaoType</span> <span class="operator">=</span> EmployeeDao.class.getGenericSuperclass();</span><br><span class="line">    System.out.println(<span class="string">&quot;EmployeeDao type: &quot;</span> + employeeDaoType);</span><br><span class="line">    System.out.println(<span class="string">&quot;EmployeeDao type class: &quot;</span> + employeeDaoType.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有泛型参数的 Type 对象才是 ParameterizedType 类型</span></span><br><span class="line">    <span class="keyword">if</span> (teacherDaoType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        <span class="type">ParameterizedType</span> <span class="variable">parameterizedType</span> <span class="operator">=</span> (ParameterizedType) teacherDaoType;</span><br><span class="line">        System.out.println(parameterizedType.getActualTypeArguments()[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. spring api 1</span></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; t = GenericTypeResolver.resolveTypeArgument(TeacherDao.class, BaseDao.class);</span><br><span class="line">    System.out.println(t);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. spring api 2</span></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">    System.out.println(ResolvableType.forClass(StudentDao.class).getSuperType().getGeneric().resolve());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
<font>>>>>>>>>>>>>>>>>>>>>>>></font>
TeacherDao type: indi.mofan.a23.sub.BaseDao<indi.mofan.a23.sub.Teacher>
TeacherDao type class: class sun.reflect.generics.reflectiveObjects.ParameterizedTypeImpl
EmployeeDao type: class indi.mofan.a23.sub.BaseDao
EmployeeDao type class: class java.lang.Class
class indi.mofan.a23.sub.Teacher
<font>>>>>>>>>>>>>>>>>>>>>>>></font>
class indi.mofan.a23.sub.Teacher
<font>>>>>>>>>>>>>>>>>>>>>>>></font>
class indi.mofan.a23.sub.Student
</pre>
<h1 id="24-ControllerAdvice-之-InitBinder"><a class="header-anchor" href="#24-ControllerAdvice-之-InitBinder"></a>24. ControllerAdvice 之 @InitBinder</h1>
<p><strong>准备 @InitBinder</strong> 在整个 <code>HandlerAdapter</code> 调用过程中所处的位置：</p>
<pre><code class="highlight mermaid">sequenceDiagram
participant adapter as HandlerAdapter
participant bf as WebDataBinderFactory
participant mf as ModelFactory
participant ihm as ServletInvocableHandlerMethod
participant ar as ArgumentResolvers 
participant rh as ReturnValueHandlers
participant container as ModelAndViewContainer
rect rgb(200, 150, 255)
adapter -&gt;&gt; +bf: 准备 @InitBinder
bf --&gt;&gt; -adapter: Void
end
adapter -&gt;&gt; +mf: 准备 @ModelAttribute
mf -&gt;&gt; +container: 添加 Model 数据
container --&gt;&gt; -mf: Void
mf --&gt;&gt; -adapter: Void
adapter -&gt;&gt; +ihm: invokeAndHandle
ihm -&gt;&gt; +ar: 获取 args
ar -&gt;&gt; ar: 有的解析器涉及 RequestBodyAdvice
ar -&gt;&gt; container: 有的解析器涉及数据绑定生成 Model 数据
ar --&gt;&gt; -ihm: args
ihm -&gt;&gt; ihm: method.invoke(bean,args) 得到 returnValue
ihm -&gt;&gt; +rh: 处理 returnValue
rh -&gt;&gt; rh: 有的处理器涉及 ResponseBodyAdvice
rh -&gt;&gt; +container: 添加 Model 数据,处理视图名,是否渲染等
container --&gt;&gt; -rh: Void
rh --&gt;&gt; -ihm: Void
ihm --&gt;&gt; -adapter: Void
adapter -&gt;&gt; +container: 获取 ModelAndView
container --&gt;&gt; -adapter: Void</code></pre>
<p>备注：</p>
<ul>
<li><code>RequestMappingHandlerAdapter</code> 在图中缩写为 <code>HandlerAdapter</code></li>
<li><code>HandlerMethodArgumentResolverComposite</code> 在图中缩写为 <code>ArgumentResolvers</code></li>
<li><code>HandlerMethodReturnValueHandlerComposite</code> 在图中缩写为 <code>ReturnValueHandlers</code></li>
</ul>
<blockquote>
<p>功能与使用</p>
</blockquote>
<p><code>@InitBinder</code> 注解只能作用在方法上，通常搭配 <code>@ControllerAdvice</code> 和 <code>@Controller</code> 以及他们的衍生注解使用。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@ControllerAdvice</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyControllerAdvice</span> &#123;</span><br><span class="line">        <span class="meta">@InitBinder</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">binder3</span><span class="params">(WebDataBinder webDataBinder)</span> &#123;</span><br><span class="line">            webDataBinder.addCustomFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;binder3 转换器&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Controller</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> &#123;</span><br><span class="line">        <span class="meta">@InitBinder</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">binder1</span><span class="params">(WebDataBinder webDataBinder)</span> &#123;</span><br><span class="line">            webDataBinder.addCustomFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;binder1 转换器&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Controller</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller2</span> &#123;</span><br><span class="line">        <span class="meta">@InitBinder</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">binder21</span><span class="params">(WebDataBinder webDataBinder)</span> &#123;</span><br><span class="line">            webDataBinder.addCustomFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;binder21 转换器&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@InitBinder</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">binder22</span><span class="params">(WebDataBinder webDataBinder)</span> &#123;</span><br><span class="line">            webDataBinder.addCustomFormatter(<span class="keyword">new</span> <span class="title class_">MyDateFormatter</span>(<span class="string">&quot;binder22 转换器&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 <code>@InitBinder</code> 作用的方法存在于被 <code>@ControllerAdvice</code> 标记的类里面时，是对 <strong>所有</strong> 控制器都生效的自定义类型转换器。当 <code>@InitBinder</code> 作用的方法存在于被 <code>@Controller</code> 标记的类里面时，是 <strong>只对当前</strong> 控制器生效的自定义类型转换器。</p>
<p><code>@InitBinder</code> 的来源有两个：</p>
<ol>
<li><code>@ControllerAdvice</code> 标记的类中 <code>@InitBinder</code> 标记的方法，由 <code>RequestMappingHandlerAdapter</code> 在初始化时解析并记录</li>
<li><code>@Controller</code> 标记的类中 <code>@InitBinder</code> 标记的方法，由 <code>RequestMappingHandlerAdapter</code> 在控制器方法首次执行时解析并记录</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line">    <span class="type">RequestMappingHandlerAdapter</span> <span class="variable">handlerAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingHandlerAdapter</span>();</span><br><span class="line"></span><br><span class="line">    handlerAdapter.setApplicationContext(context);</span><br><span class="line">    handlerAdapter.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">&quot;1. 刚开始...&quot;</span>);</span><br><span class="line">    showBindMethods(handlerAdapter);</span><br><span class="line"></span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">showBindMethods</span><span class="params">(RequestMappingHandlerAdapter handlerAdapter)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">initBinderAdviceCache</span> <span class="operator">=</span> RequestMappingHandlerAdapter.class.getDeclaredField(<span class="string">&quot;initBinderAdviceCache&quot;</span>);</span><br><span class="line">    initBinderAdviceCache.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    Map&lt;ControllerAdviceBean, Set&lt;Method&gt;&gt; globalMap = (Map&lt;ControllerAdviceBean, Set&lt;Method&gt;&gt;) initBinderAdviceCache.get(handlerAdapter);</span><br><span class="line">    log.debug(<span class="string">&quot;全局的 @InitBinder 方法 &#123;&#125;&quot;</span>,</span><br><span class="line">              globalMap.values().stream()</span><br><span class="line">              .flatMap(ms -&gt; ms.stream().map(m -&gt; m.getName()))</span><br><span class="line">              .collect(Collectors.toList())</span><br><span class="line">             );</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">initBinderCache</span> <span class="operator">=</span> RequestMappingHandlerAdapter.class.getDeclaredField(<span class="string">&quot;initBinderCache&quot;</span>);</span><br><span class="line">    initBinderCache.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; controllerMap = (Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt;) initBinderCache.get(handlerAdapter);</span><br><span class="line">    log.debug(<span class="string">&quot;控制器的 @InitBinder 方法 &#123;&#125;&quot;</span>,</span><br><span class="line">              controllerMap.entrySet().stream()</span><br><span class="line">              .flatMap(e -&gt; e.getValue().stream().map(v -&gt; e.getKey().getSimpleName() + <span class="string">&quot;.&quot;</span> + v.getName()))</span><br><span class="line">              .collect(Collectors.toList())</span><br><span class="line">             );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，控制台打印出：</p>
<pre>
indi.mofan.a24.A24                  - 1. 刚开始... 
indi.mofan.a24.A24                  - 全局的 @InitBinder 方法 [binder3] 
indi.mofan.a24.A24                  - 控制器的 @InitBinder 方法 [] 
</pre>
<p>全局的 <code>@InitBinder</code> 方法被解析并记录，但控制器中被 <code>@InitBinder</code> 标记的方法并没有被解析记录。</p>
<p>模拟调用控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    </span><br><span class="line">    log.debug(<span class="string">&quot;1. 刚开始...&quot;</span>);</span><br><span class="line">    showBindMethods(handlerAdapter);</span><br><span class="line"></span><br><span class="line">    <span class="type">Method</span> <span class="variable">getDataBinderFactory</span> <span class="operator">=</span> RequestMappingHandlerAdapter.class.getDeclaredMethod(<span class="string">&quot;getDataBinderFactory&quot;</span>, HandlerMethod.class);</span><br><span class="line">    getDataBinderFactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;2. 模拟调用 Controller1 的 foo 方法...&quot;</span>);</span><br><span class="line">    getDataBinderFactory.invoke(handlerAdapter, <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">WebConfig</span>.Controller1(), WebConfig.Controller1.class.getMethod(<span class="string">&quot;foo&quot;</span>)));</span><br><span class="line">    showBindMethods(handlerAdapter);</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">&quot;3. 模拟调用 Controller2 的 bar 方法时...&quot;</span>);</span><br><span class="line">    getDataBinderFactory.invoke(handlerAdapter, <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">WebConfig</span>.Controller2(), WebConfig.Controller2.class.getMethod(<span class="string">&quot;bar&quot;</span>)));</span><br><span class="line">    showBindMethods(handlerAdapter);</span><br><span class="line"></span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
1. 刚开始... 
全局的 @InitBinder 方法 [binder3] 
控制器的 @InitBinder 方法 [] 
2. 模拟调用 Controller1 的 foo 方法... 
全局的 @InitBinder 方法 [binder3] 
控制器的 @InitBinder 方法 [Controller1.binder1] 
3. 模拟调用 Controller2 的 bar 方法时... 
全局的 @InitBinder 方法 [binder3] 
控制器的 @InitBinder 方法 [Controller1.binder1, Controller2.binder22, Controller2.binder21] 
</pre>
<p>首次调用控制器中的方法时，控制器中被 <code>@InitBinder</code> 标记方法被解析记录。</p>
<h1 id="25-控制器方法执行流程"><a class="header-anchor" href="#25-控制器方法执行流程"></a>25. 控制器方法执行流程</h1>
<blockquote>
<p><code>ServletInvocableHandlerMethod</code> 的组成</p>
</blockquote>
<pre><code class="highlight mermaid">classDiagram
class ServletInvocableHandlerMethod &#123;
    +invokeAndHandle(ServletWebRequest,ModelAndViewContainer)
&#125;
HandlerMethod &lt;|-- ServletInvocableHandlerMethod
HandlerMethod o-- bean
HandlerMethod o-- method
ServletInvocableHandlerMethod o-- WebDataBinderFactory
ServletInvocableHandlerMethod o-- ParameterNameDiscoverer
ServletInvocableHandlerMethod o-- HandlerMethodArgumentResolverComposite
ServletInvocableHandlerMethod o-- HandlerMethodReturnValueHandlerComposite</code></pre>
<p><code>HandlerMethod</code> 需要：</p>
<ul>
<li><code>bean</code>，即哪个 Controller</li>
<li><code>method</code>，即 Controller 中的哪个方法</li>
</ul>
<p><code>ServletInvocableHandlerMethod</code> 需要：</p>
<ul>
<li><code>WebDataBinderFactory</code>，用于对象绑定、类型转换</li>
<li><code>ParameterNameDiscoverer</code>，用于参数名解析</li>
<li><code>HandlerMethodArgumentResolverComposite</code>，用于解析参数</li>
<li><code>HandlerMethodReturnValueHandlerComposite</code>，用于处理返回值</li>
</ul>
<blockquote>
<p>控制器方法执行流程</p>
</blockquote>
<p>以 <code>RequestMappingHandlerAdapter</code> 为起点，创建 <code>WebDataBinderFactory</code>，添加自定义类型转换器，再创建 <code>ModelFactory</code>，添加 Model 数据：</p>
<pre><code class="highlight mermaid">sequenceDiagram
participant adapter as RequestMappingHandlerAdapter
participant bf as WebDataBinderFactory
participant mf as ModelFactory
participant container as ModelAndViewContainer
adapter -&gt;&gt; +bf: 初始化 advice：解析 @InitBinder
bf --&gt;&gt; -adapter: 添加自定义类型转换器
adapter -&gt;&gt; +mf: 初始化 advice：解析 @ModelAttribute
mf -&gt;&gt; +container: 添加 Model 数据
container --&gt;&gt; -mf: Void
mf --&gt;&gt; -adapter: Void</code></pre>
<p>接下来调用 <code>ServletInvocableHandlerMethod</code>，主要完成三件事：</p>
<ol>
<li>准备参数</li>
<li>反射调用控制器方法</li>
<li>处理返回值</li>
</ol>
<pre><code class="highlight mermaid">sequenceDiagram
participant adapter as RequestMappingHandlerAdapter
participant ihm as ServletInvocableHandlerMethod
participant ar as HandlerMethodArgumentResolverComposite
participant rh as HandlerMethodReturnValueHandlerComposite
participant container as ModelAndViewContainer

adapter -&gt;&gt; +ihm: invokeAndHandle
ihm -&gt;&gt; +ar: 获取 args
ar -&gt;&gt; ar: 有的解析器涉及 RequestBodyAdvice
ar -&gt;&gt; container: 有的解析器涉及数据绑定生成模型数据
container --&gt;&gt; ar: Void
ar --&gt;&gt; -ihm: args
ihm -&gt;&gt; ihm: method.invoke(bean,args) 得到 returnValue
ihm -&gt;&gt; +rh: 处理 returnValue
rh -&gt;&gt; rh: 有的处理器涉及 ResponseBodyAdvice
rh -&gt;&gt; +container: 添加Model数据,处理视图名,是否渲染等
container --&gt;&gt; -rh: Void
rh --&gt;&gt; -ihm: Void
ihm --&gt;&gt; -adapter: Void 
adapter -&gt;&gt; +container: 获取 ModelAndView
container --&gt;&gt; -adapter: Void</code></pre>
<blockquote>
<p>代码演示</p>
</blockquote>
<p>提供配置类 <code>WebConfig</code>，其中包含一个控制器 <code>Controller1</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Controller</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> &#123;</span><br><span class="line">        <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">        <span class="keyword">public</span> ModelAndView <span class="title function_">foo</span><span class="params">(User user)</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 @ResponseStatus 注解，咋不考虑返回值的处理</span></span><br><span class="line">            System.out.println(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@ToString</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建 Spring 容器，Mock 请求，创建 <code>HandlerMethod</code> 对象指定需要执行的控制器方法，创建 <code>DataBinderFactory</code> 数据绑定工厂。向创建的 <code>HandlerMethod</code> 对象中添加数据绑定工厂、参数名称解析器、参数解析器（暂不考虑返回值的处理），最后创建模型视图容器，调用 <code>HandlerMethod</code> 的 <code>invokeAndHandle</code> 方法执行控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    request.setParameter(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;mofan&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletInvocableHandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServletInvocableHandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">WebConfig</span>.Controller1(), WebConfig.Controller1.class.getMethod(<span class="string">&quot;foo&quot;</span>, WebConfig.User.class));</span><br><span class="line">    <span class="type">ServletRequestDataBinderFactory</span> <span class="variable">binderFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    handlerMethod.setDataBinderFactory(binderFactory);</span><br><span class="line">    handlerMethod.setParameterNameDiscoverer(<span class="keyword">new</span> <span class="title class_">DefaultParameterNameDiscoverer</span>());</span><br><span class="line">    <span class="comment">// getArgumentResolvers() 组装了一系列参数解析器，省略具体实现</span></span><br><span class="line">    handlerMethod.setHandlerMethodArgumentResolvers(getArgumentResolvers(context));</span><br><span class="line">    <span class="comment">// 暂不考虑返回值的处理</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ModelAndViewContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();</span><br><span class="line">    handlerMethod.invokeAndHandle(<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request), container);</span><br><span class="line">    System.out.println(container.getModel());</span><br><span class="line"></span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
foo
{user=WebConfig.User(name=mofan), org.springframework.validation.BindingResult.user=org.springframework.validation.BeanPropertyBindingResult: 0 errors}
</pre>
<h1 id="26-ControllerAdvice-之-ModelAttribute"><a class="header-anchor" href="#26-ControllerAdvice-之-ModelAttribute"></a>26. ControllerAdvice 之 @ModelAttribute</h1>
<p><strong>准备 @ModelAttribute</strong> 在整个 HandlerAdapter 调用过程中所处的位置：</p>
<pre><code class="highlight mermaid">sequenceDiagram
participant adapter as HandlerAdapter
participant bf as WebDataBinderFactory
participant mf as ModelFactory
participant ihm as ServletInvocableHandlerMethod
participant ar as ArgumentResolvers 
participant rh as ReturnValueHandlers
participant container as ModelAndViewContainer

adapter -&gt;&gt; +bf: 准备 @InitBinder
bf --&gt;&gt; -adapter: Void
rect rgb(200, 150, 255)
adapter -&gt;&gt; +mf: 准备 @ModelAttribute
mf -&gt;&gt; +container: 添加 Model 数据
container --&gt;&gt; -mf: Void
mf --&gt;&gt; -adapter: Void
end
adapter -&gt;&gt; +ihm: invokeAndHandle
ihm -&gt;&gt; +ar: 获取 args
ar -&gt;&gt; ar: 有的解析器涉及 RequestBodyAdvice
ar -&gt;&gt; container: 有的解析器涉及数据绑定生成 Model 数据
ar --&gt;&gt; -ihm: args
ihm -&gt;&gt; ihm: method.invoke(bean,args) 得到 returnValue
ihm -&gt;&gt; +rh: 处理 returnValue
rh -&gt;&gt; rh: 有的处理器涉及 ResponseBodyAdvice
rh -&gt;&gt; +container: 添加 Model 数据,处理视图名,是否渲染等
container --&gt;&gt; -rh: Void
rh --&gt;&gt; -ihm: Void
ihm --&gt;&gt; -adapter: Void
adapter -&gt;&gt; +container: 获取 ModelAndView
container --&gt;&gt; -adapter: Void</code></pre>
<blockquote>
<p>功能与使用</p>
</blockquote>
<p><code>@ModelAttribute</code> 可以作用在参数上和方法上。</p>
<p>当其作用在参数上时，会将请求中的参数信息 <strong>按名称</strong> 注入到指定对象中，并将这个对象信息自动添加到 ModelMap 中。当未指定 <code>@ModelAttribute</code> 的 <code>value</code> 时，添加到 ModelMap 中的 key 是对象类型首字母小写对应的字符串。此时的 <code>@ModelAttribute</code> 注解由 <code>ServletModelAttributeMethodProcessor</code> 解析。</p>
<p>当其作用在方法上时：</p>
<ul>
<li>如果该方法在被 <code>@Controller</code> 注解标记的类中，会在当前控制器中每个控制器方法执行前执行被 <code>@ModelAttribute</code> 标记的方法，如果该方法有返回值，自动将返回值添加到 ModelMap 中。当未指定 <code>@ModelAttribute</code> 的 <code>value</code> 时，添加到 ModelMap 中的 key 是返回值类型首字母小写对应的字符串。</li>
<li>如果该方法在被 <code>@ControllerAdvice</code> 注解标记的类中，会在所有控制器方法执行前执行该方法。</li>
</ul>
<p>作用在方法上的 <code>@ModelAttribute</code> 注解由 <code>RequestMappingHandlerAdapter</code> 解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> &#123;</span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">foo</span><span class="params">(<span class="meta">@ModelAttribute(&quot;u&quot;)</span> User user)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用 @ResponseStatus 注解，咋不考虑返回值的处理</span></span><br><span class="line">        System.out.println(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyControllerAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@ModelAttribute(&quot;a&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">aa</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;aa&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先不使用 <code>RequestMappingHandlerAdapter</code> 对作用在方法上的 <code>@ModelAttribute</code> 注解进行解析，沿用【25. 控制器方法执行流程】中的 <code>main()</code> 方法：</p>
<pre>
foo
{u=WebConfig.User(name=mofan), org.springframework.validation.BindingResult.u=org.springframework.validation.BeanPropertyBindingResult: 0 errors}
</pre>
<p>再解析方法上的 <code>@ModelAttribute</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">RequestMappingHandlerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingHandlerAdapter</span>();</span><br><span class="line">    adapter.setApplicationContext(context);</span><br><span class="line">    adapter.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    request.setParameter(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;mofan&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取模型工厂</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">getModelFactory</span> <span class="operator">=</span> RequestMappingHandlerAdapter.class.getDeclaredMethod(<span class="string">&quot;getModelFactory&quot;</span>, HandlerMethod.class, WebDataBinderFactory.class);</span><br><span class="line">    getModelFactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ModelFactory</span> <span class="variable">modelFactory</span> <span class="operator">=</span> (ModelFactory) getModelFactory.invoke(adapter, handlerMethod, binderFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化模型数据</span></span><br><span class="line">    modelFactory.initModel(<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request), container, handlerMethod);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
foo
{a=aa, u=WebConfig.User(name=mofan), org.springframework.validation.BindingResult.u=org.springframework.validation.BeanPropertyBindingResult: 0 errors}
</pre>
<p><code>&#123;a=aa&#125;</code> 也被放入到 <code>ModelAndViewContainer</code> 中。</p>
<h1 id="27-返回值处理器"><a class="header-anchor" href="#27-返回值处理器"></a>27. 返回值处理器</h1>
<blockquote>
<p>含有多种返回值的控制器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test1()&quot;</span>);</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mav</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;view1&quot;</span>);</span><br><span class="line">        mav.addObject(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mav;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test2()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ModelAttribute</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test3()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;李四&quot;</span>, <span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test4()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;王五&quot;</span>, <span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HttpEntity&lt;User&gt; <span class="title function_">test5</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test5()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;赵六&quot;</span>, <span class="number">40</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HttpHeaders <span class="title function_">test6</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test6()&quot;</span>);</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">test7</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;test7()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;钱七&quot;</span>, <span class="number">50</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试渲染视图需要用到的配置</p>
</blockquote>
<p>为测试对视图的渲染，采用 Freemarker 进行测试，先导入 Freemarker 依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-freemarker&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>Freemarker 配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FreeMarkerConfigurer <span class="title function_">freeMarkerConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FreeMarkerConfigurer</span> <span class="variable">configurer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FreeMarkerConfigurer</span>();</span><br><span class="line">        configurer.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        configurer.setTemplateLoaderPath(<span class="string">&quot;classpath:templates&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> configurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FreeMarkerView 在借助 Spring 初始化时，会要求在 web 环境才会走 setConfiguration, 这里想办法去掉了 web 环境的约束</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FreeMarkerViewResolver <span class="title function_">viewResolver</span><span class="params">(FreeMarkerConfigurer configurer)</span> &#123;</span><br><span class="line">        <span class="type">FreeMarkerViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FreeMarkerViewResolver</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> AbstractUrlBasedView <span class="title function_">instantiateView</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">FreeMarkerView</span> <span class="variable">view</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FreeMarkerView</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isContextRequired</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                view.setConfiguration(configurer.getConfiguration());</span><br><span class="line">                <span class="keyword">return</span> view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        resolver.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        resolver.setPrefix(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        resolver.setSuffix(<span class="string">&quot;.ftl&quot;</span>);</span><br><span class="line">        resolver.setExposeSpringMacroHelpers(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>渲染视图使用的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">renderView</span><span class="params">(ApplicationContext context, ModelAndViewContainer container,</span></span><br><span class="line"><span class="params">                               ServletWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; 渲染视图&quot;</span>);</span><br><span class="line">    <span class="type">FreeMarkerViewResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> context.getBean(FreeMarkerViewResolver.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> container.getViewName() != <span class="literal">null</span> ? container.getViewName() : <span class="keyword">new</span> <span class="title class_">DefaultRequestToViewNameTranslator</span>().getViewName(webRequest.getRequest());</span><br><span class="line">    log.debug(<span class="string">&quot;没有获取到视图名, 采用默认视图名: &#123;&#125;&quot;</span>, viewName);</span><br><span class="line">    <span class="comment">// 每次渲染时, 会产生新的视图对象, 它并非被 Spring 所管理, 但确实借助了 Spring 容器来执行初始化</span></span><br><span class="line">    <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> resolver.resolveViewName(viewName, Locale.getDefault());</span><br><span class="line">    view.render(container.getModel(), webRequest.getRequest(), webRequest.getResponse());</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(((MockHttpServletResponse) webRequest.getResponse()).getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>提供构造 <code>HandlerMethodReturnValueHandlerComposite</code> 对象的方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HandlerMethodReturnValueHandlerComposite <span class="title function_">getReturnValueHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">HandlerMethodReturnValueHandlerComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodReturnValueHandlerComposite</span>();</span><br><span class="line">    composite.addHandlers(Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ModelAndViewMethodReturnValueHandler</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ViewNameMethodReturnValueHandler</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">false</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HttpEntityMethodProcessor</span>(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>())),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HttpHeadersReturnValueHandler</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>())),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">true</span>)</span><br><span class="line">    ));</span><br><span class="line">    <span class="keyword">return</span> composite;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试返回值处理器的方法 <code>testReturnValueProcessor()</code></p>
</blockquote>
<p>利用两个函数式接口 <code>Comsumer</code>，对 Mock 的请求进行补充，或者在请求处理完毕后，输出 Mock 的响应信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testReturnValueProcessor</span><span class="params">(ApplicationContext context, String methodName,</span></span><br><span class="line"><span class="params">                                             Consumer&lt;MockHttpServletRequest&gt; requestConsumer,</span></span><br><span class="line"><span class="params">                                             Consumer&lt;MockHttpServletResponse&gt; responseConsumer)</span> &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> Controller.class.getMethod(methodName);</span><br><span class="line">    <span class="type">Controller</span> <span class="variable">controller</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Controller</span>();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> method.invoke(controller);</span><br><span class="line"></span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(context, method);</span><br><span class="line">    <span class="type">ModelAndViewContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">HandlerMethodReturnValueHandlerComposite</span> <span class="variable">composite</span> <span class="operator">=</span> getReturnValueHandler();</span><br><span class="line">    <span class="type">MethodParameter</span> <span class="variable">returnType</span> <span class="operator">=</span> handlerMethod.getReturnType();</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    Optional.ofNullable(requestConsumer).ifPresent(i -&gt; i.accept(request));</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line">    <span class="type">ServletWebRequest</span> <span class="variable">webRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response);</span><br><span class="line">    <span class="keyword">if</span> (composite.supportsReturnType(returnType)) &#123;</span><br><span class="line">        composite.handleReturnValue(returnValue, returnType, container, webRequest);</span><br><span class="line">        System.out.println(container.getModel());</span><br><span class="line">        System.out.println(container.getViewName());</span><br><span class="line">        <span class="keyword">if</span> (!container.isRequestHandled()) &#123;</span><br><span class="line">            <span class="comment">// 渲染视图</span></span><br><span class="line">            renderView(context, container, webRequest);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Optional.ofNullable(responseConsumer).ifPresent(i -&gt; i.accept(response));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="27-1-ModelAndView"><a class="header-anchor" href="#27-1-ModelAndView"></a>27.1 ModelAndView</h2>
<p><code>ModelAndView</code> 类型的返回值由 <code>ModelAndViewMethodReturnValueHandler</code> 处理，构造时无需传入任何参数。</p>
<p>解析 <code>ModelAndView</code> 时，将其中的视图和模型数据分别提取出来，放入 <code>ModelAndViewContainer</code> 中，之后根据视图信息找到对应的模板页面，再将模型数据填充到模板页面中，完成视图的渲染。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line">    test1(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    testReturnValueProcessor(context, <span class="string">&quot;test1&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的模板页面 <code>view1.ftl</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=&quot;zh&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;view1&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello! $&#123;name&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test1() 
{name=张三}
view1
indi.mofan.a27.A27                  - >>>>>> 渲染视图 
indi.mofan.a27.A27                  - 没有获取到视图名, 采用默认视图名: view1 
indi.mofan.a27.WebConfig$1$1        - View name 'view1', model {name=张三} 
indi.mofan.a27.WebConfig$1$1        - Rendering [/view1.ftl] 
&lt;!doctype html&gt;
&lt;html lang="zh"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;view1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello! 张三&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<h2 id="27-2-字符串类型"><a class="header-anchor" href="#27-2-字符串类型"></a>27.2 字符串类型</h2>
<p>控制器方法的返回值是字符串类型时，返回的字符串即为视图的名称。与 <code>ModelAndView</code> 类型的返回值相比，不包含模型数据。</p>
<p>此种类型的返回值由 <code>ViewNameMethodReturnValueHandler</code> 处理，构造时无需传入任何参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    testReturnValueProcessor(context, <span class="string">&quot;test2&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的模板页面 <code>view2.ftl</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=&quot;zh&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;view2&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello!&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test2() 
{}
view2
indi.mofan.a27.A27                  - >>>>>> 渲染视图 
indi.mofan.a27.A27                  - 没有获取到视图名, 采用默认视图名: view2 
indi.mofan.a27.WebConfig$1$1        - View name 'view2', model {} 
indi.mofan.a27.WebConfig$1$1        - Rendering [/view2.ftl] 
&lt;!doctype html&gt;
&lt;html lang="zh"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;view2&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<h2 id="27-3-ModelAttribute"><a class="header-anchor" href="#27-3-ModelAttribute"></a>27.3 @ModelAttribute</h2>
<p><code>@ModelAttribute</code> 的用法在【26. ControllerAdvice 之 @ModelAttribute】中已经介绍过，简单来说，当 <code>@ModelAttribute</code> 注解作用在方法上时，会将方法的返回值作为模型数据添加到 <code>ModelAndViewContainer</code> 中。</p>
<p><code>@ModelAttribute</code> 标记的方法的返回值由 <code>ServletModelAttributeMethodProcessor</code> 解析，构造时需要传入一个布尔类型数据 <code>annotationNotRequired</code>，表示 <code>@ModelAttribute</code> 注解是否不是必须的。</p>
<p>模型数据已经有了，但视图名称又是什么呢？</p>
<p>在实际开发场景中，控制器方法需要被 <code>@RequestMapping</code> 标记，并指定请求地址，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ModelAttribute</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;test3()&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;李四&quot;</span>, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当未找到视图名称时，默认以请求路径作为视图名称。</p>
<p>但在本节测试中省略了路径映射这一步，因此需要通过编程的方式将请求路径解析后的结果放入 request 作用域中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Consumer&lt;MockHttpServletRequest&gt; <span class="title function_">mockHttpServletRequestConsumer</span><span class="params">(String methodName)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> req -&gt; &#123;</span><br><span class="line">        req.setRequestURI(<span class="string">&quot;/&quot;</span> + methodName);</span><br><span class="line">        UrlPathHelper.defaultInstance.resolveAndCacheLookupPath(req);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;test3&quot;</span>;</span><br><span class="line">    testReturnValueProcessor(context, methodName, </span><br><span class="line">                             mockHttpServletRequestConsumer(methodName), <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的模板页面 <code>test3.ftl</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=&quot;zh&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;test3&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello! $&#123;user.name&#125; $&#123;user.age&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test3() 
{user=A27.User(name=李四, age=20)}
null
indi.mofan.a27.A27                  - >>>>>> 渲染视图 
indi.mofan.a27.A27                  - 没有获取到视图名, 采用默认视图名: test3 
indi.mofan.a27.WebConfig$1$1        - View name 'test3', model {user=A27.User(name=李四, age=20)} 
indi.mofan.a27.WebConfig$1$1        - Rendering [/test3.ftl] 
&lt;!doctype html&gt;
&lt;html lang="zh"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;test3&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello! 李四 20&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>针对控制器方法 <code>test4()</code> 也可以按照相同方式测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;test4&quot;</span>;</span><br><span class="line">    testReturnValueProcessor(context, methodName, mockHttpServletRequestConsumer(methodName), <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的模板页面 <code>test4.ftl</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=&quot;zh&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;test4&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello! $&#123;user.name&#125; $&#123;user.age&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test4() 
{user=A27.User(name=王五, age=30)}
null
indi.mofan.a27.A27                  - >>>>>> 渲染视图 
indi.mofan.a27.A27                  - 没有获取到视图名, 采用默认视图名: test4 
indi.mofan.a27.WebConfig$1$1        - View name 'test4', model {user=A27.User(name=王五, age=30)} 
indi.mofan.a27.WebConfig$1$1        - Rendering [/test4.ftl] 
&lt;!doctype html&gt;
&lt;html lang="zh"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;test4&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello! 王五 30&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>与解析参数类似，返回值处理器的执行顺序也有严格要求。</p>
<h2 id="27-4-HttpEntity"><a class="header-anchor" href="#27-4-HttpEntity"></a>27.4 HttpEntity</h2>
<p><code>HttpEntity</code> 类型的返回值由 <code>HttpEntityMethodProcessor</code> 处理，构造时需要传入一个消息转换器列表。</p>
<p>这种类型的返回值表示响应完成，无需经过视图的解析、渲染流程再生成响应。可在处理器的 <code>handleReturnValue()</code> 方法中得以论证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                              ModelAndViewContainer mavContainer, </span></span><br><span class="line"><span class="params">                              NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 一进入方法就设置请求处理完毕</span></span><br><span class="line">    mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>HttpEntity</code> 中包含了状态码、响应体信息和响应头信息。</p>
<p>尝试在请求处理完毕后，输出响应体信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Consumer&lt;MockHttpServletResponse&gt; RESPONSE_CONSUMER = resp -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (String name : resp.getHeaderNames()) &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot; = &quot;</span> + resp.getHeader(name));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(resp.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test5</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    testReturnValueProcessor(context, <span class="string">&quot;test5&quot;</span>, <span class="literal">null</span>, RESPONSE_CONSUMER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test5() 
{}
null
Content-Type = application/json
{"name":"赵六","age":40}
</pre>
<h2 id="27-5-HttpHeaders"><a class="header-anchor" href="#27-5-HttpHeaders"></a>27.5 HttpHeaders</h2>
<p>与 <code>HttpEntity</code> 相比，<code>HttpHeaders</code> 只包含响应头信息，<code>HttpHeaders</code> 类型的返回值由 <code>HttpHeadersReturnValueHandler</code> 处理，构造时无需传入任何参数。</p>
<p>与 <code>HttpEntity</code> 一样，这种类型的返回值也表示响应完成，无需经过视图的解析、渲染流程再生成响应，也可在处理器的 <code>handleReturnValue()</code> 方法中得以论证（省略源码）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test6</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    testReturnValueProcessor(context, <span class="string">&quot;test6&quot;</span>, <span class="literal">null</span>, RESPONSE_CONSUMER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test6() 
{}
null
Content-Type = text/html
<br/>
</pre>
<h2 id="27-6-ResponseBody"><a class="header-anchor" href="#27-6-ResponseBody"></a>27.6 @ResponseBody</h2>
<p><code>@ResponseBody</code> 标记的方法的返回值由 <code>RequestResponseBodyMethodProcessor</code> 处理，构造时需要传入一个消息转换器列表。</p>
<p>这样的返回值也表示响应完成，无需经过视图的解析、渲染流程再生成响应，也可在处理器的 <code>handleReturnValue()</code> 方法中得以论证（省略源码）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test7</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    testReturnValueProcessor(context, <span class="string">&quot;test7&quot;</span>, <span class="literal">null</span>, RESPONSE_CONSUMER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
indi.mofan.a27.A27$Controller       - test7() 
{}
null
Content-Type = application/json
{"name":"钱七","age":50}
</pre>
<h1 id="28-消息转换器"><a class="header-anchor" href="#28-消息转换器"></a>28. 消息转换器</h1>
<p>在构造参数解析器 <code>RequestResponseBodyMethodProcessor</code>、返回值解析器 <code>HttpEntityMethodProcessor</code> 和 <code>HttpEntityMethodProcessor</code> 时，都需要传入消息转换器列表。</p>
<p>消息转换器的基类是 <code>HttpMessageConverter</code>。</p>
<p>介绍两个常见的消息转换器的实现：</p>
<ul>
<li>
<p><code>MappingJackson2HttpMessageConverter</code></p>
</li>
<li>
<p><code>MappingJackson2XmlHttpMessageConverter</code></p>
</li>
</ul>
<p>一个 <code>User</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(<span class="meta">@JsonProperty(&quot;name&quot;)</span> String name, <span class="meta">@JsonProperty(&quot;age&quot;)</span> <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>User</code> 对象转换成 JSON 格式的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MockHttpOutputMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpOutputMessage</span>();</span><br><span class="line">    <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 判断能否将对象转换成目标消息格式</span></span><br><span class="line">    <span class="keyword">if</span> (converter.canWrite(User.class, MediaType.APPLICATION_JSON)) &#123;</span><br><span class="line">        converter.write(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;张三&quot;</span>, <span class="number">18</span>), MediaType.APPLICATION_JSON, message);</span><br><span class="line">        System.out.println(message.getBodyAsString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;张三&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>将 <code>User</code> 对象转换成 XML 格式的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MockHttpOutputMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpOutputMessage</span>();</span><br><span class="line">    <span class="type">MappingJackson2XmlHttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>();</span><br><span class="line">    <span class="keyword">if</span> (converter.canWrite(User.class, MediaType.APPLICATION_XML)) &#123;</span><br><span class="line">        converter.write(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;李四&quot;</span>, <span class="number">20</span>), MediaType.APPLICATION_XML, message);</span><br><span class="line">        System.out.println(message.getBodyAsString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>MappingJackson2XmlHttpMessageConverter</code> 时，需要额外导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">User</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>李四<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">age</span>&gt;</span>20<span class="tag">&lt;/<span class="name">age</span>&gt;</span><span class="tag">&lt;/<span class="name">User</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将 JSON 格式的数据转换成 <code>User</code> 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//language=JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;name\&quot;: \&quot;李四\&quot;,\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  \&quot;age\&quot;: 20\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="type">MockHttpInputMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpInputMessage</span>(json.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line">    <span class="keyword">if</span> (converter.canRead(User.class, MediaType.APPLICATION_JSON)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">read</span> <span class="operator">=</span> converter.read(User.class, message);</span><br><span class="line">        System.out.println(read);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>
A28.User(name=李四, age=20)
</pre>
<p>如果存在多个消息转换器呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line">    <span class="type">ServletWebRequest</span> <span class="variable">webRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response);</span><br><span class="line"></span><br><span class="line">    request.addHeader(HttpHeaders.ACCEPT, MimeTypeUtils.APPLICATION_XML_VALUE);</span><br><span class="line">    response.setContentType(MimeTypeUtils.APPLICATION_JSON_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="type">RequestResponseBodyMethodProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>()</span><br><span class="line">    ));</span><br><span class="line">    processor.handleReturnValue(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;张三&quot;</span>, <span class="number">18</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MethodParameter</span>(A28.class.getMethod(<span class="string">&quot;user&quot;</span>), -<span class="number">1</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>(),</span><br><span class="line">        webRequest</span><br><span class="line">    );</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">user</span> <span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将以添加的消息转换器顺序为主，比如此处会将 <code>User</code> 对象转换成 JSON 格式的数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;张三&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>调换添加的消息转换器顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">RequestResponseBodyMethodProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>()</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这下会将 <code>User</code> 对象转换成 XML 格式的数据：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">User</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">age</span>&gt;</span>18<span class="tag">&lt;/<span class="name">age</span>&gt;</span><span class="tag">&lt;/<span class="name">User</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>再将添加的消息转换器顺序还原，在请求头中添加 <code>Accept</code> 信息，指定数据格式为 XML：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    request.addHeader(HttpHeaders.ACCEPT, MimeTypeUtils.APPLICATION_XML_VALUE);</span><br><span class="line">    <span class="type">RequestResponseBodyMethodProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>()</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尽管转换成 JSON 的转换器在前，但会以请求头中指定的 <code>Accept</code> 信息为主：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">User</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">age</span>&gt;</span>18<span class="tag">&lt;/<span class="name">age</span>&gt;</span><span class="tag">&lt;/<span class="name">User</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在上文基础上，在指定响应的 <code>Content-Type</code> 为 <code>application/json</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    request.addHeader(HttpHeaders.ACCEPT, MimeTypeUtils.APPLICATION_XML_VALUE);</span><br><span class="line">    response.setContentType(MimeTypeUtils.APPLICATION_JSON_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="type">RequestResponseBodyMethodProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(Arrays.asList(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>()</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时又会以 <code>Content-Type</code> 的信息为主：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;张三&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>总结</p>
</blockquote>
<p><code>@ResponseBody</code> 注解由 <code>RequestResponseBodyMethodProcessor</code> 解析，但涉及到的数据格式转换由消息转换器完成。</p>
<p>当存在多个消息转换器时，如果选择 <code>MediaType</code>：</p>
<ul>
<li>首先看 <code>@RequestMapping</code> 注解的 <code>produces</code> 为主，相当于设置了响应的 <code>Content-Type</code>，比如：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping(produces = MimeTypeUtils.APPLICATION_JSON_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">user</span> <span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>再看请求头中的 <code>Accept</code> 是否指定了目标格式</li>
<li>最后按照消息转换器的添加顺序进行转换</li>
</ul>
<h1 id="29-ControllerAdvice-之-ResponseBodyAdvice"><a class="header-anchor" href="#29-ControllerAdvice-之-ResponseBodyAdvice"></a>29. ControllerAdvice 之 ResponseBodyAdvice</h1>
<p><strong>ResponseBodyAdvice 增强</strong> 在整个 HandlerAdapter 调用过程中所处的位置：</p>
<pre><code class="highlight mermaid">sequenceDiagram
participant adapter as HandlerAdapter
participant bf as WebDataBinderFactory
participant mf as ModelFactory
participant ihm as ServletInvocableHandlerMethod
participant ar as ArgumentResolvers 
participant rh as ReturnValueHandlers
participant container as ModelAndViewContainer

adapter -&gt;&gt; +bf: 准备 @InitBinder
bf --&gt;&gt; -adapter: Void
adapter -&gt;&gt; +mf: 准备 @ModelAttribute
mf -&gt;&gt; +container: 添加 Model 数据
container --&gt;&gt; -mf: Void
mf --&gt;&gt; -adapter: Void
adapter -&gt;&gt; +ihm: invokeAndHandle
ihm -&gt;&gt; +ar: 获取 args
ar -&gt;&gt; ar: 有的解析器涉及 RequestBodyAdvice
ar -&gt;&gt; container: 有的解析器涉及数据绑定生成 Model 数据
ar --&gt;&gt; -ihm: args
ihm -&gt;&gt; ihm: method.invoke(bean,args) 得到 returnValue
ihm -&gt;&gt; +rh: 处理 returnValue
rect rgb(200, 150, 255)
rh -&gt;&gt; rh: 有的处理器涉及 ResponseBodyAdvice
end
rh -&gt;&gt; +container: 添加 Model 数据,处理视图名,是否渲染等
container --&gt;&gt; -rh: Void
rh --&gt;&gt; -ihm: Void
ihm --&gt;&gt; -adapter: Void
adapter -&gt;&gt; +container: 获取 ModelAndView
container --&gt;&gt; -adapter: Void</code></pre>
<p><code>ResponseBodyAdvice</code> 是一个接口，对于实现了这个接口并被 <code>@ControllerAdvice</code> 标记的类来说，能够在调用每个控制器方法返回结果前，调用重写的 <code>ResponseBodyAdvice</code> 接口中的 <code>beforeBodyWrite()</code> 方法对返回值进行增强。</p>
<p>现有一个控制器类与内部使用到的 <code>User</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;王五&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用控制器方法，并输出响应数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletInvocableHandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletInvocableHandlerMethod</span>(</span><br><span class="line">        context.getBean(WebConfig.MyController.class),</span><br><span class="line">        WebConfig.MyController.class.getMethod(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    handlerMethod.setDataBinderFactory(<span class="keyword">new</span> <span class="title class_">ServletRequestDataBinderFactory</span>(Collections.emptyList(), <span class="literal">null</span>));</span><br><span class="line">    handlerMethod.setParameterNameDiscoverer(<span class="keyword">new</span> <span class="title class_">DefaultParameterNameDiscoverer</span>());</span><br><span class="line">    <span class="comment">// 设置参数解析器（省略源码）</span></span><br><span class="line">    handlerMethod.setHandlerMethodArgumentResolvers(getArgumentResolvers(context));</span><br><span class="line">    <span class="comment">// 设置返回值处理器（省略源码）</span></span><br><span class="line">    handlerMethod.setHandlerMethodReturnValueHandlers(getReturnValueHandlers(context));</span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line">    <span class="type">ModelAndViewContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndViewContainer</span>();</span><br><span class="line">    handlerMethod.invokeAndHandle(<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response), container);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，控制台输出：</p>
<pre>
{"name":"王五","age":18}
</pre>
<p>在实际开发场景中常常需要对返回的数据类型进行统一，比如都返回 <code>Result</code> 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Result</span><span class="params">(<span class="meta">@JsonProperty(&quot;code&quot;)</span> <span class="type">int</span> code, <span class="meta">@JsonProperty(&quot;data&quot;)</span> Object data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Result</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">ok</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="number">200</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">ok</span><span class="params">(Object data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="number">200</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">error</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="number">500</span>, <span class="string">&quot;服务器内部错误:&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了直接让控制器方法返回 <code>Result</code> 外，还可以使用 <code>ResponseBodyAdvice</code> 进行增强：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyControllerAdvice</span> <span class="keyword">implements</span> <span class="title class_">ResponseBodyAdvice</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(MethodParameter returnType,</span></span><br><span class="line"><span class="params">                            Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 满足条件才转换</span></span><br><span class="line"><span class="comment">         * 1. 控制器方法被 @ResponseBody 注解标记</span></span><br><span class="line"><span class="comment">         * 2. 控制器方法所在类被 @ResponseBody 注解或包含 @ResponseBody 注解的注解标记</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> returnType.getMethodAnnotation(ResponseBody.class) != <span class="literal">null</span></span><br><span class="line">            || AnnotationUtils.findAnnotation(returnType.getContainingClass(), ResponseBody.class) != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">beforeBodyWrite</span><span class="params">(Object body,</span></span><br><span class="line"><span class="params">                                  MethodParameter returnType,</span></span><br><span class="line"><span class="params">                                  MediaType selectedContentType,</span></span><br><span class="line"><span class="params">                                  Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType,</span></span><br><span class="line"><span class="params">                                  ServerHttpRequest request,</span></span><br><span class="line"><span class="params">                                  ServerHttpResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Result) &#123;</span><br><span class="line">            <span class="keyword">return</span> body;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行上述增强后，再运行 <code>main()</code> 方法， <strong>输出结果不变，</strong> 这是因为没有将实现的 <code>ResponseBodyAdvice</code> 添加到返回值处理器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HandlerMethodReturnValueHandlerComposite <span class="title function_">getReturnValueHandlers</span><span class="params">(AnnotationConfigApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="comment">// 添加 advice</span></span><br><span class="line">    List&lt;ControllerAdviceBean&gt; annotatedBeans = ControllerAdviceBean.findAnnotatedBeans(context);</span><br><span class="line">    List&lt;Object&gt; responseBodyAdviceList = annotatedBeans.stream()</span><br><span class="line">        .filter(b -&gt; b.getBeanType() != <span class="literal">null</span> </span><br><span class="line">                &amp;&amp; ResponseBodyAdvice.class.isAssignableFrom(b.getBeanType()))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="type">HandlerMethodReturnValueHandlerComposite</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethodReturnValueHandlerComposite</span>();</span><br><span class="line">    <span class="comment">// 省略其他返回值处理器的添加</span></span><br><span class="line">    composite.addHandler(<span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(</span><br><span class="line">        Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>()),</span><br><span class="line">        responseBodyAdviceList</span><br><span class="line">    ));</span><br><span class="line">    composite.addHandler(<span class="keyword">new</span> <span class="title class_">ServletModelAttributeMethodProcessor</span>(<span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">return</span> composite;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次运行 <code>main()</code> 方法，控制台输出：</p>
<pre>
{"code":200,"data":{"name":"王五","age":18}}
</pre>
<p>如果将控制器方法修改成以下形式，也能输出相同的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;王五&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;王五&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="30-异常处理"><a class="header-anchor" href="#30-异常处理"></a>30. 异常处理</h1>
<p><code>DispatcherServlet</code> 中对异常处理的核心方法是 <code>processHandlerException()</code>，在这个方法中会对所有异常解析器进行遍历，然后使用每个异常解析器对异常信息进行处理。</p>
<p>存放异常解析器的是 <code>DispatcherServlet</code> 中泛型为 <code>HandlerExceptionResolver</code>、名为 <code>handlerExceptionResolvers</code> 的列表成员变量。</p>
<p><code>HandlerExceptionResolver</code> 是一个接口，本节讲解解析 <code>@ExceptionHandler</code> 注解的异常解析器 <code>ExceptionHandlerExceptionResolver</code>。</p>
<p>四个控制器类，测试异常处理方法被 <code>@ResponseBody</code> 注解标记、异常处理方法返回 <code>ModelAndView</code>、嵌套异常和对异常处理方法的参数处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">handle</span><span class="params">(ArithmeticException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handler</span><span class="params">(ArithmeticException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;test2&quot;</span>, Collections.singletonMap(<span class="string">&quot;error&quot;</span>, e.getMessage()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">handle</span><span class="params">(IOException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">handle</span><span class="params">(Exception e, HttpServletRequest request)</span> &#123;</span><br><span class="line">        System.out.println(request);</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExceptionHandlerExceptionResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionHandlerExceptionResolver</span>();</span><br><span class="line">    resolver.setMessageConverters(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>()));</span><br><span class="line">    <span class="comment">// 调用该方法，添加默认的参数解析器和返回值处理器</span></span><br><span class="line">    resolver.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller1</span>(), Controller1.class.getMethod(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArithmeticException</span>(<span class="string">&quot;除以零&quot;</span>);</span><br><span class="line">    resolver.resolveException(request, response, handlerMethod, e);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    handlerMethod = <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller2</span>(), Controller2.class.getMethod(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> resolver.resolveException(request, response, handlerMethod, e);</span><br><span class="line">    System.out.println(modelAndView.getModel());</span><br><span class="line">    System.out.println(modelAndView.getViewName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 嵌套异常</span></span><br><span class="line">    handlerMethod = <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller3</span>(), Controller3.class.getMethod(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    e = <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;e1&quot;</span>, <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;e2&quot;</span>, <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;e3&quot;</span>)));</span><br><span class="line">    resolver.resolveException(request, response, handlerMethod, e);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常处理方法参数处理</span></span><br><span class="line">    handlerMethod = <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller4</span>(), Controller4.class.getMethod(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    e = <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;e4&quot;</span>);</span><br><span class="line">    resolver.resolveException(request, response, handlerMethod, e);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，控制台打印出：</p>
<pre>
{"error":"除以零"}
{error=除以零}
test2
{"error":"除以零"}{"error":"e3"}
org.springframework.mock.web.MockHttpServletRequest@7c1e2a9e
{"error":"除以零"}{"error":"e3"}{"error":"e4"}
</pre>
<h1 id="31-ControllerAdvice-之-ExceptionHandler"><a class="header-anchor" href="#31-ControllerAdvice-之-ExceptionHandler"></a>31. ControllerAdvice  之 @ExceptionHandler</h1>
<p>控制器中被 <code>@ExceptionHandler</code> 标记的异常处理方法只会在当前控制器中生效，如果想要某个异常处理方法全局生效，则需要将异常处理方法编写在被 <code>@ControllerAdvice</code> 注解标记的类中。</p>
<p>一个“朴素”的控制器类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当不存在任何异常处理方法时，调用控制器中的 <code>foo()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">ExceptionHandlerExceptionResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionHandlerExceptionResolver</span>();</span><br><span class="line">    resolver.setMessageConverters(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>()));</span><br><span class="line">    resolver.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller1</span>(), Controller1.class.getMethod(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    <span class="type">Exception</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;e1&quot;</span>);</span><br><span class="line">    resolver.resolveException(request, response, handlerMethod, exception);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>main()</code> 方法运行后，控制台不输出任何信息。</p>
<p>编写配置类，向 Spring 容器中添加 <code>ExceptionHandlerExceptionResolver</code>，并声明全局异常处理方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@ControllerAdvice</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyControllerAdvice</span> &#123;</span><br><span class="line">        <span class="meta">@ExceptionHandler</span></span><br><span class="line">        <span class="meta">@ResponseBody</span></span><br><span class="line">        <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">handle</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ExceptionHandlerExceptionResolver <span class="title function_">resolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ExceptionHandlerExceptionResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExceptionHandlerExceptionResolver</span>();</span><br><span class="line">        resolver.setMessageConverters(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>()));</span><br><span class="line">        <span class="comment">// 无需调用 resolver.afterPropertiesSet(); 方法，这是 Spring 的提供的内置拓展，会在 Spring 生命周期中自动执行</span></span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ExceptionHandlerExceptionResolver</code> 不再直接通过 <code>new</code> 关键词构造，而是从 Spring 容器中获取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">    <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletResponse</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(WebConfig.class);</span><br><span class="line">    <span class="type">ExceptionHandlerExceptionResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> context.getBean(ExceptionHandlerExceptionResolver.class);</span><br><span class="line"></span><br><span class="line">    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerMethod</span>(<span class="keyword">new</span> <span class="title class_">Controller1</span>(), Controller1.class.getMethod(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    <span class="type">Exception</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;e1&quot;</span>);</span><br><span class="line">    resolver.resolveException(request, response, handlerMethod, exception);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(response.getContentAsByteArray(), StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="32-Tomcat-异常处理"><a class="header-anchor" href="#32-Tomcat-异常处理"></a>32. Tomcat 异常处理</h1>
<p>可以利用 <code>@ExceptionHandler</code> 和 <code>@ControllerAdvice</code> 注解全局对控制器方法中抛出的异常进行处理，但针对诸如 <code>filter</code> 中不在控制器方法中的异常就变得无能为力了。</p>
<p>因此需要一个更上层的“异常处理者”，这个“异常处理者”就是 Tomcat 服务器。</p>
<h2 id="32-1-Tomcat-的错误页处理"><a class="header-anchor" href="#32-1-Tomcat-的错误页处理"></a>32.1 Tomcat 的错误页处理</h2>
<p>首先将“老三样”利用配置类添加到 Spring 容器中，还要将 <code>RequestMappingHandlerMapping</code> 和 <code>RequestMappingHandlerAdapter</code> 也添加到 Spring 容器中。</p>
<p>必要的控制器也不能少，控制器方法手动制造异常，但不提供使用 <code>@ExceptionHandler</code> 实现的异常处理方法，将产生的异常交由 Tomcat 处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">servletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">servletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet)</span> &#123;</span><br><span class="line">        <span class="type">DispatcherServletRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestMappingHandlerMapping <span class="title function_">requestMappingHandlerMapping</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 解析 @RequestMapping</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestMappingHandlerMapping</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestMappingHandlerAdapter <span class="title function_">requestMappingHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RequestMappingHandlerAdapter</span> <span class="variable">handlerAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingHandlerAdapter</span>();</span><br><span class="line">        <span class="comment">// 注意默认的 RequestMappingHandlerAdapter 不会带 jackson 转换器</span></span><br><span class="line">        handlerAdapter.setMessageConverters(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>()));</span><br><span class="line">        <span class="keyword">return</span> handlerAdapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Controller</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">        <span class="meta">@RequestMapping(&quot;test&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> ModelAndView <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用 <code>AnnotationConfigServletWebServerApplicationContext</code> 创建 Spring Web 容器，并输出所有的路径映射信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigServletWebServerApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>(WebConfig.class);</span><br><span class="line">    <span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">    handlerMapping.getHandlerMethods().forEach((k, v) -&gt; System.out.println(<span class="string">&quot;映射路径: &quot;</span> + k + <span class="string">&quot;\t方法信息: &quot;</span> + v));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，控制台只输出一条路径映射信息：</p>
<pre>映射路径: { [/test]}	方法信息: indi.mofan.a32.WebConfig$MyController#test()</pre>
<p>在浏览器中访问 <code>http://localhost:8080/test</code> 地址：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMImages/Tomcat%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E9%A1%B5.png" alt="Tomcat错误处理页"></p>
<p>显示 Tomcat 的错误处理页，并在页面中输出了错误信息。</p>
<p>Tomcat 默认提供的错误处理方式返回的是 HTML 格式的数据，但需要返回 JSON 格式的数据又该怎么自定义呢？</p>
<p>修改 Tomcat 默认的错误处理路径，并添加后置处理器进行注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改了 Tomcat 服务器默认错误地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ErrorPageRegistrar <span class="title function_">errorPageRegistrar</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ErrorPageRegistrar 由 SpringBoot 提供，TomcatServletWebServerFactory 也实现了该接口</span></span><br><span class="line"><span class="comment">     * 出现错误，会使用请求转发 forward 跳转到 error 地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> webServerFactory -&gt; webServerFactory.addErrorPages(<span class="keyword">new</span> <span class="title class_">ErrorPage</span>(<span class="string">&quot;/error&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ErrorPageRegistrarBeanPostProcessor <span class="title function_">errorPageRegistrarBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 在 TomcatServletWebServerFactory 初始化完成前，获取容器中所有的 ErrorPageRegistrar</span></span><br><span class="line"><span class="comment">     * 并将这些 ErrorPageRegistrar 进行注册</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ErrorPageRegistrarBeanPostProcessor</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启程序，再次在浏览器中访问 <code>http://localhost:8080/test</code>，此时页面上不再显示 Tomcat 的默认错误处理页，而是产生了 <code>404</code> 错误。</p>
<p>这是因为整个程序中并没有名称为 <code>error</code> 的页面，或者为 <code>/error</code> 的请求路径。在控制器中添加请求路径为 <code>/error</code> 的控制器方法，该方法被 <code>@ResponseBody</code> 标记，最终返回 JSON 格式的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/error&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">error</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="comment">// tomcat 会将异常对象存储到 request 作用域中，可以直接获取</span></span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">e</span> <span class="operator">=</span> (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line">    <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次重启程序，控制台输出的路径映射信息多了一条：</p>
<pre>
映射路径: { [/error]}	方法信息: indi.mofan.a32.WebConfig$MyController#error(HttpServletRequest)
映射路径: { [/test]}	方法信息: indi.mofan.a32.WebConfig$MyController#test()
</pre>
<p>在浏览器中访问 <code>http://localhost:8080/test</code> ：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMImages/%E8%87%AA%E5%AE%9A%E4%B9%89Tomcat%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E9%A1%B5.png" alt="自定义Tomcat错误处理页"></p>
<h2 id="32-2-BasicErrorController"><a class="header-anchor" href="#32-2-BasicErrorController"></a>32.2 BasicErrorController</h2>
<p><code>BasicErrorController</code> 是由 SpringBoot 提供的类，它也是一个控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&#123;&quot;$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicErrorController</span> <span class="keyword">extends</span> <span class="title class_">AbstractErrorController</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的映射路径会先从配置文件中读取，在未进行任何配置的情况下，默认路径是 <code>/error</code>。</p>
<p>向容器中添加 <code>BasicErrorController</code>，构造 <code>BasicErrorController</code> 时需要传递两个参数：</p>
<ul>
<li><code>errorAttributes</code>：错误属性，可以理解成封装的错误信息对象</li>
<li><code>errorProperties</code>：也可以翻译成错误属性，用于对输出的错误信息进行配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> BasicErrorController <span class="title function_">basicErrorController</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BasicErrorController</span>(<span class="keyword">new</span> <span class="title class_">DefaultErrorAttributes</span>(), <span class="keyword">new</span> <span class="title class_">ErrorProperties</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>移除前文添加的 <code>error()</code> 控制器方法。</p>
<p>再次重启程序，控制台输出的路径映射信息为：</p>
<pre>
映射路径: { [/error]}	方法信息: org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController#error(HttpServletRequest)
映射路径: { [/test]}	方法信息: indi.mofan.a32.WebConfig$MyController#test()
映射路径: { [/error], produces [text/html]}	方法信息: org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController#errorHtml(HttpServletRequest, HttpServletResponse)
</pre>
<p>路径映射信息多了两条，它们的请求路径一样，但根据不同的请求来源返回不同格式的数据。</p>
<blockquote>
<p>使用接口测试工具访问</p>
</blockquote>
<p>如果采用 Postman 等接口测试工具访问 <code>http://localhost:8080/test</code> 路径时，将返回 JSON 格式的数据，比如：</p>
<pre>
{
  "timestamp": 1674736682248,
  "status": 500,
  "error": "Internal Server Error",
  "path": "/test"
}
</pre>
<p><code>timestamp</code>、<code>status</code> 等响应内容就是错误属性 <code>errorAttributes</code> 的中包含的内容。</p>
<p>返回的数据中并没有显示异常信息，可以通过配置文件进行配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.error.include-exception</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<p>也可以在添加 <code>BasicErrorController</code> 到 Spring 容器中时，设置错误属性 <code>errorProperties</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> BasicErrorController <span class="title function_">basicErrorController</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ErrorProperties</span> <span class="variable">errorProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorProperties</span>();</span><br><span class="line">    errorProperties.setIncludeException(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BasicErrorController</span>(<span class="keyword">new</span> <span class="title class_">DefaultErrorAttributes</span>(), errorProperties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启程序，再次使用接口测试工具访问 <code>http://localhost:8080/test</code>：</p>
<pre>
{
  "timestamp": 1674736991768,
  "status": 500,
  "error": "Internal Server Error",
  "exception": "java.lang.ArithmeticException",
  "path": "/test"
}
</pre>
<blockquote>
<p>使用浏览器访问</p>
</blockquote>
<p>如果使用浏览器访问 <code>http://localhost:8080/test</code>，又会回到“解放前”，显示与 Tomcat 的默认错误处理页相同的内容。</p>
<p>这是因为使用浏览器访问时，将调用 <code>BasicErrorController</code> 中的 <code>errorHtml()</code> 控制器方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(</span></span><br><span class="line"><span class="meta">    produces = &#123;&quot;text/html&quot;&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">HttpStatus</span> <span class="variable">status</span> <span class="operator">=</span> <span class="built_in">this</span>.getStatus(request);</span><br><span class="line">    Map&lt;String, Object&gt; model = Collections.unmodifiableMap(<span class="built_in">this</span>.getErrorAttributes(request, <span class="built_in">this</span>.getErrorAttributeOptions(request, MediaType.TEXT_HTML)));</span><br><span class="line">    response.setStatus(status.value());</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="built_in">this</span>.resolveErrorView(request, response, status, model);</span><br><span class="line">    <span class="keyword">return</span> modelAndView != <span class="literal">null</span> ? modelAndView : <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;error&quot;</span>, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法返回 <code>ModelAndView</code>，并且在没有添加新的错误视图的情况下，尝试寻找视图名称为 <code>error</code> 的视图。</p>
<p>这里既没有添加新的错误视图，也没有名称为 <code>error</code> 的视图，因此最终又会交由 Tomcat 进行处理。</p>
<p>尝试向 Spring 容器中添加一个 <code>View</code> 视图，Bean 的名字 <strong>必须</strong> 是 <code>error</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">error</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (model, request, response) -&gt; &#123;</span><br><span class="line">        System.out.println(model);</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;&lt;h3&gt;服务器内部错误&lt;/h3&gt;&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了能够在查找指定名称的视图时按照 <code>View</code> 类型的 Bean 的名称进行匹配，还需要添加一个解析器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ViewResolver <span class="title function_">viewResolver</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// View 类型的 Bean 的名称即为视图名称</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanNameViewResolver</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启程序，使用浏览器访问 <code>http://localhost:8080/test</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/SSMImages/%E4%BD%BF%E7%94%A8BasicErrorController%E8%87%AA%E5%AE%9A%E4%B9%89error%E8%A7%86%E5%9B%BE.png" alt="使用BasicErrorController自定义error视图"></p>
<p>控制台还打印出：</p>
<pre>
{timestamp=Thu Jan 26 21:01:50 CST 2023, status=500, error=Internal Server Error, exception=java.lang.ArithmeticException, path=/test}
</pre>
<h1 id="33-BeanNameUrlHandlerMapping-与-SimpleControllerHandlerAdapter"><a class="header-anchor" href="#33-BeanNameUrlHandlerMapping-与-SimpleControllerHandlerAdapter"></a>33. BeanNameUrlHandlerMapping 与 SimpleControllerHandlerAdapter</h1>
<h2 id="33-1-功能与使用"><a class="header-anchor" href="#33-1-功能与使用"></a>33.1 功能与使用</h2>
<p><code>BeanNameUrlHandlerMapping</code> 与 <code>RequestMappingHandlerMapping</code> 类似，也是用于解析请求路径，只不过 <code>BeanNameUrlHandlerMapping</code> 将根据请求路径在 Spring 容器中寻找同名的 Bean，对请求进行处理，这个 Bean <strong>必须</strong> 以 <code>/</code> 开头。比如：请求路径为 <code>/c1</code>，寻找的 Bean 的名称也是 <code>/c1</code>。</p>
<p><code>SimpleControllerHandlerAdapter</code> 与 <code>RequestMappingHandlerAdapter</code> 也类似，也是用于调用控制器方法，但要求控制器类必须实现 <code>org.springframework.web.servlet.mvc.Controller</code> 接口。</p>
<p>现有三个控制器类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;/c1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller1</span> <span class="keyword">implements</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;this is c1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;/c2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Controller2</span> <span class="keyword">implements</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;this is c2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(&quot;/c3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Controller <span class="title function_">controller3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (request, response) -&gt; &#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;this is c3&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提供配置类 <code>WebConfig</code>，添加 Web 换件下必要的 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">servletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">servletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BeanNameUrlHandlerMapping <span class="title function_">beanNameUrlHandlerMapping</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanNameUrlHandlerMapping</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SimpleControllerHandlerAdapter <span class="title function_">simpleControllerHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleControllerHandlerAdapter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigServletWebServerApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>(WebConfig.class);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，在浏览器中访问 <code>http://localhost:8080/c1</code>，页面上显示 <code>this is c1</code>。更换请求路径为 <code>c2</code>、<code>c3</code> 后，也会出现类似的信息。</p>
<h2 id="33-2-自定义实现"><a class="header-anchor" href="#33-2-自定义实现"></a>33.2 自定义实现</h2>
<p>在配置类 <code>WebConfig</code> 中移除 Spring 提供的 <code>BeanNameUrlHandlerMapping</code> 与 <code>SimpleControllerHandlerAdapter</code>，手动编码实现它们的功能。</p>
<p>为了与前文的测试形成对比，将 <code>Controller2</code> 的 Bean 名称设置为 <code>c2</code>，而不是 <code>/c2</code>，使其不能被解析到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyHandlerMapping</span> <span class="keyword">implements</span> <span class="title class_">HandlerMapping</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="type">Controller</span> <span class="variable">controller</span> <span class="operator">=</span> controllerMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (controller == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HandlerExecutionChain</span>(controller);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Controller&gt; controllerMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        controllerMap = context.getBeansOfType(Controller.class).entrySet().stream()</span><br><span class="line">            .filter(i -&gt; i.getKey().startsWith(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">            .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">HandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> Controller;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                               HttpServletResponse response,</span></span><br><span class="line"><span class="params">                               Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> Controller) &#123;</span><br><span class="line">            ((Controller) handler).handleRequest(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，在浏览器中访问：</p>
<ul>
<li><code>http://localhost:8080/c1</code>，页面上显示 <code>this is c1</code>；</li>
<li><code>http://localhost:8080/c2</code>，页面上显示 <code>404</code>；</li>
<li><code>http://localhost:8080/c3</code>，页面上显示 <code>this is c3</code>。</li>
</ul>
<h1 id="34-RouterFunctionMapping-与-HandlerFunctionAdapter"><a class="header-anchor" href="#34-RouterFunctionMapping-与-HandlerFunctionAdapter"></a>34. RouterFunctionMapping 与 HandlerFunctionAdapter</h1>
<p><code>RouterFunctionMapping</code> 在初始化时，在 Spring 容器中收集所有 <code>RouterFunction</code>，<code>RouterFunction</code> 包括两部分：</p>
<ol>
<li><code>RequestPredicate</code>：设置映射条件</li>
<li><code>HandlerFunction</code>：处理逻辑</li>
</ol>
<p>当请求到达时，根据映射条件找到 <code>HandlerFunction</code>，即 <code>handler</code>，然后使用 <code>HandlerFunctionAdapter</code> 调用 <code>handler</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">servletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">servletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunctionMapping <span class="title function_">routerFunctionMapping</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RouterFunctionMapping</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HandlerFunctionAdapter <span class="title function_">handlerFunctionAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HandlerFunctionAdapter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">r1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> route(GET(<span class="string">&quot;/r1&quot;</span>), req -&gt; ok().body(<span class="string">&quot;this is r1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">r2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> route(GET(<span class="string">&quot;/r2&quot;</span>), req -&gt; ok().body(<span class="string">&quot;this is r2&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigServletWebServerApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>(WebConfig.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>main()</code> 方法后，在浏览器中访问 <code>http://localhost:8080/r1</code>，页面上显示 <code>this is r1</code>，访问 <code>r2</code> 时也类似。</p>
<h1 id="35-SimpleUrlHandlerMapping-与-HttpRequestHandlerAdapter"><a class="header-anchor" href="#35-SimpleUrlHandlerMapping-与-HttpRequestHandlerAdapter"></a>35. SimpleUrlHandlerMapping 与 HttpRequestHandlerAdapter</h1>
<h2 id="35-1-功能与使用"><a class="header-anchor" href="#35-1-功能与使用"></a>35.1 功能与使用</h2>
<p>概括一下，这两个主要用于静态资源处理，<code>SimpleUrlHandlerMapping</code> 用于静态资源映射，而静态资源处理器是 <code>ResourceHttpRequestHandler</code>，<code>HttpRequestHandlerAdapter</code> 用于处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">servletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServlet <span class="title function_">dispatcherServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title function_">servletRegistrationBean</span><span class="params">(DispatcherServlet dispatcherServlet)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServletRegistrationBean</span>(dispatcherServlet, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SimpleUrlHandlerMapping <span class="title function_">simpleUrlHandlerMapping</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">        <span class="type">SimpleUrlHandlerMapping</span> <span class="variable">mapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleUrlHandlerMapping</span>();</span><br><span class="line">        <span class="comment">// 设置静态资源处理器，得到所有映射关系</span></span><br><span class="line">        Map&lt;String, ResourceHttpRequestHandler&gt; map = context.getBeansOfType(ResourceHttpRequestHandler.class);</span><br><span class="line">        mapping.setUrlMap(map);</span><br><span class="line">        <span class="keyword">return</span> mapping;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpRequestHandlerAdapter <span class="title function_">httpRequestHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpRequestHandlerAdapter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;/**&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResourceHttpRequestHandler <span class="title function_">handler1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ResourceHttpRequestHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceHttpRequestHandler</span>();</span><br><span class="line">        <span class="comment">// 以 / 结尾表示目录，否则认为是文件</span></span><br><span class="line">        handler.setLocations(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;static/&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;/img/**&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResourceHttpRequestHandler <span class="title function_">handler2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ResourceHttpRequestHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceHttpRequestHandler</span>();</span><br><span class="line">        handler.setLocations(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;images/&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加的两个 <code>ResourceHttpRequestHandler</code> 类型的 Bean，分别设置了它们处理 ClassPath 路径下哪个目录下的静态资源，那如何将请求路径与静态资源访问路径进行映射呢？</p>
<p>也就是说，当要访问 ClassPath 路径下的 <code>static</code> 目录下的静态资源时，应该通过哪个请求路径呢？</p>
<p>可以利用通配符设置添加的 <code>ResourceHttpRequestHandler</code> 类型的 Bean 的名称。</p>
<p>比如设置 Bean 的名称为 <code>/**</code>，那么在访问 <code>localhost:8080/r1.html</code> 时，就会尝试访问 ClassPath 路径下 <code>static</code> 目录中名为 <code>r1.html</code> 的静态资源；又比如设置 Bean 的名称为 <code>/img/**</code>，那么在访问 <code>localhost:8080/img/1.jpg</code> 时， 就会尝试访问 ClassPath 路径下 <code>images</code> 目录中名为 <code>1.jpg</code> 的静态资源。</p>
<h2 id="35-2-资源解析器"><a class="header-anchor" href="#35-2-资源解析器"></a>35.2 资源解析器</h2>
<p><code>ResourceHttpRequestHandler</code> 用于对静态资源进行处理，但静态资源解析的功能是由 <code>ResourceResolver</code> 完成的。</p>
<p><code>ResourceHttpRequestHandler</code> 实现了 <code>InitializingBean</code> 接口，查看重写的 <code>afterPropertiesSet()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    resolveResourceLocations();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.resourceResolvers.isEmpty()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceResolvers.add(<span class="keyword">new</span> <span class="title class_">PathResourceResolver</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当使用的资源解析器列表为空时，默认添加最基本的资源解析器 <code>PathResourceResolver</code>。</p>
<p>尝试添加额外的资源解析器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(&quot;/**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResourceHttpRequestHandler <span class="title function_">handler1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ResourceHttpRequestHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceHttpRequestHandler</span>();</span><br><span class="line">    <span class="comment">// 以 / 结尾表示目录，否则认为是文件</span></span><br><span class="line">    handler.setLocations(Collections.singletonList(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;static/&quot;</span>)));</span><br><span class="line">    <span class="comment">// 不使用默认的资源解析器，而是使用自行添加的</span></span><br><span class="line">    handler.setResourceResolvers(Arrays.asList(</span><br><span class="line">            <span class="comment">// 读取资源时使用缓存</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CachingResourceResolver</span>(<span class="keyword">new</span> <span class="title class_">ConcurrentMapCache</span>(<span class="string">&quot;cache1&quot;</span>)),</span><br><span class="line">            <span class="comment">// 读取压缩资源</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">EncodedResourceResolver</span>(),</span><br><span class="line">            <span class="comment">// 最基本的：从磁盘上读取静态资源</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PathResourceResolver</span>()</span><br><span class="line">    ));</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加了三个资源解析器：</p>
<ol>
<li><code>CachingResourceResolver</code>：对静态资源进行缓存</li>
<li><code>EncodedResourceResolver</code>：对静态资源进行压缩</li>
<li><code>PathResourceResolver</code>：最基本的资源处理器</li>
</ol>
<p>还要注意添加的顺序，先尝试从缓存中获取，再尝试获取压缩文件，最后才是直接从磁盘上读取。</p>
<p>针对 <code>EncodedResourceResolver</code> 来说，Spring 不会自行对静态资源进行压缩，需要在配置类中提供压缩方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initGzip</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;static&quot;</span>);</span><br><span class="line">    <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> resource.getFile();</span><br><span class="line">    <span class="keyword">for</span> (File file : dir.listFiles(pathname -&gt; pathname.getName().endsWith(<span class="string">&quot;.html&quot;</span>))) &#123;</span><br><span class="line">        System.out.println(file);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">             <span class="type">GZIPOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file.getAbsoluteFile() + <span class="string">&quot;.gz&quot;</span>))) &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span> * <span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = fis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类对应的 Bean 初始化阶段时，将 ClassPath 路径下 <code>static</code> 目录中的静态资源进行压缩。</p>
<p>比如 <code>static</code> 目录下的 <code>r1.html</code> 会被压缩成 <code>r1.html.gz</code>，在访问 <code>r1.html</code> 时，会访问压缩文件 <code>r1.html.gz</code>，由浏览器识别并解压成 <code>r1.html</code> 进行访问，减少网络传输数据量。</p>
<h2 id="35-3-欢迎页处理"><a class="header-anchor" href="#35-3-欢迎页处理"></a>35.3 欢迎页处理</h2>
<p>将访问 <strong>根路径</strong> 的请求，映射到某一欢迎页。这个功能由 <code>WelcomePageHandlerMapping</code> 完成。</p>
<p>设置静态资源欢迎页为 ClassPath 下 <code>static</code> 目录中的 <code>index.html</code> 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title function_">welcomePageHandlerMapping</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> context.getResource(<span class="string">&quot;classpath:static/index.html&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WelcomePageHandlerMapping</span>(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        context,</span><br><span class="line">        resource,</span><br><span class="line">        <span class="string">&quot;/**&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序会根据配置的欢迎页映射器生成一个实现了 <code>Controller</code> 接口的处理器，使用 <code>SimpleControllerHandlerAdapter</code> 执行生成的处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SimpleControllerHandlerAdapter <span class="title function_">simpleControllerHandlerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleControllerHandlerAdapter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启程序，控制台会输出一条如下的日志，表示欢迎页配置成功：</p>
<pre>o.s.b.a.w.s.WelcomePageHandlerMapping - Adding welcome page: class path resource [static/index.html] </pre>
<p>在浏览器上访问 <code>localhost:8080</code> 时，会直接访问静态资源 <code>static/index.html</code> 的内容。</p>
<p><mark>注意：</mark> 如果重启程序后访问 <code>localhost:8080</code> 并没有跳转到配置的欢迎页，可以重新编译项目后在运行。</p>
<blockquote>
<p>总结</p>
</blockquote>
<p><code>WelcomePageHandlerMapping</code> 作为欢迎页映射器，只将根路径，即 <code>/</code> 映射到配置的欢迎页。</p>
<p>它内置了一个处理器，名为 <code>ParameterizableViewController</code>，该处理器不执行逻辑，仅根据固定的视图名 <code>forward:index.html</code> 去寻找视图。</p>
<p><code>SimpleControllerHandlerAdapter</code> 用于调用处理器，根据重定向到根路径的 <code>index.html</code> 页面，执行静态资源处理器，访问 <code>static</code> 目录下的 <code>index.html</code> 文件（在配置类中自行配置的）。</p>
<h2 id="35-4-映射器与适配器总结"><a class="header-anchor" href="#35-4-映射器与适配器总结"></a>35.4 映射器与适配器总结</h2>
<p><code>HandlerMapping</code> 用于建立请求路径与控制器之间的映射关系：</p>
<ul>
<li><code>RequestMappingHandlerMapping</code>：解析 <code>@RequestMapping</code> 及其派生注解，建立请求路径与控制器方法之间的映射关系</li>
<li><code>WelcomePageHandlerMapping</code>：映射 <code>/</code> 根路径，寻找欢迎页</li>
<li><code>BeanNameUrlHandlerMapping</code>：与 Bean 的名称进行匹配，要求名称必须以 <code>/</code> 开头</li>
<li><code>RouterFunctionMapping</code>：将 <code>RequestPredicate</code> 映射到 <code>HandlerFunction</code></li>
<li><code>SimpleUrlHandlerMapping</code>：静态资源映射</li>
</ul>
<p>映射器之间的顺序也是有要求的，SpringBoot 中的映射器按上述顺序排序。</p>
<p><code>HandlerAdapter</code> 用于对各种处理器进行适配调用（<strong>适配器</strong> 模式）：</p>
<ul>
<li><code>RequestMappingHandlerAdapter</code>：执行被 <code>@RequestMapping</code> 标记的控制器方法，内部还会使用参数解析器、返回值处理器对控制器方法的参数、返回值进行处理（<strong>组合</strong> 模式）</li>
<li><code>SimpleControllerHandlerAdapter</code>：执行实现了 <code>Controller</code> 接口的处理器</li>
<li><code>HandlerFunctionAdapter</code>：处理 <code>HandlerFunction</code> 函数式接口</li>
<li><code>HttpRequestHandlerAdapter</code>：处理 <code>HttpRequestHandler</code> 接口，用于静态资源处理</li>
</ul>
<p><code>ResourceHttpRequestHandler</code> 中的 <code>setResourceResolvers()</code>  方法是 <strong>责任链</strong> 模式体现。</p>
<h1 id="36-MVC-处理流程"><a class="header-anchor" href="#36-MVC-处理流程"></a>36. MVC 处理流程</h1>
<p>当浏览器发送一个请求 <code>http://localhost:8080/hello</code> 后，请求到达服务器，其处理流程是：</p>
<blockquote>
<p>服务器提供了 <code>DispatcherServlet</code>，它使用的是标准 Servlet 技术</p>
</blockquote>
<ul>
<li>路径：默认映射路径为 <code>/</code>，即会匹配到所有请求 URL，可作为请求的统一入口，<code>DispatcherServlet</code> 也被称之为 <strong>前控制器</strong>。但也有例外：
<ul>
<li>JSP 不会匹配到 <code>DispatcherServlet</code></li>
<li>其它有路径的 Servlet 匹配优先级也高于 <code>DispatcherServlet</code></li>
</ul>
</li>
<li>创建：在 SpringBoot 中，由自动配置类 <code>DispatcherServletAutoConfiguration</code> 提供 <code>DispatcherServlet</code> 的 Bean</li>
<li>初始化：<code>DispatcherServlet</code> 初始化时会优先到容器里寻找各种组件，作为它的成员变量
<ul>
<li><code>HandlerMapping</code>，初始化时记录映射关系</li>
<li><code>HandlerAdapter</code>，初始化时准备参数解析器、返回值处理器、消息转换器</li>
<li><code>HandlerExceptionResolver</code>，初始化时准备参数解析器、返回值处理器、消息转换器</li>
<li><code>ViewResolver</code></li>
</ul>
</li>
</ul>
<blockquote>
<p><code>DispatcherServlet</code> 利用 <code>RequestMappingHandlerMapping</code> 查找控制器方法</p>
</blockquote>
<p>例如根据 <code>/hello</code> 路径找到被 <code>@RequestMapping(&quot;/hello&quot;)</code> 标记的控制器方法，控制器方法会被封装成 <code>HandlerMethod</code> 对象，并结合 <strong>匹配到的拦截器</strong> 一起返回给 <code>DispatcherServlet</code>。</p>
<p><code>HandlerMethod</code> 和 <strong>拦截器</strong> 合称为 <code>HandlerExecutionChain</code>（调用链）对象。</p>
<blockquote>
<p>DispatcherServlet 接下来会</p>
</blockquote>
<ol>
<li>调用拦截器的 <code>preHandle()</code> 方法，返回一个布尔类型的值。若返回 <code>true</code>，则放行，进行后续调用，反之拦截请求，不进行后续调用；</li>
<li><code>RequestMappingHandlerAdapter</code> 调用处理器方法，准备数据绑定工厂、模型工厂、<code>ModelAndViewContainer</code>、将 <code>HandlerMethod</code> 完善为 <code>ServletInvocableHandlerMethod</code>
<ul>
<li>@ControllerAdvice 全局增强点 1️⃣：利用 <code>@ModelAttribute</code> 补充模型数据</li>
<li>@ControllerAdvice 全局增强点 2️⃣：利用 <code>@InitBinder</code> 补充自定义类型转换器</li>
<li>使用 <code>HandlerMethodArgumentResolver</code> 准备参数
<ul>
<li>@ControllerAdvice 全局增强点 3️⃣：利用 <code>RequestBodyAdvice</code> 接口对请求体增强</li>
</ul>
</li>
<li>调用 <code>ServletInvocableHandlerMethod</code></li>
<li>使用 <code>HandlerMethodReturnValueHandler</code> 处理返回值
<ul>
<li>@ControllerAdvice 全局增强点 4️⃣：利用 <code>RequestBodyAdvice</code> 对响应体增强</li>
</ul>
</li>
<li>根据 <code>ModelAndViewContainer</code> 获取 <code>ModelAndView</code>
<ul>
<li>如果返回的 <code>ModelAndView</code> 为 <code>null</code>，不走第 4 步视图解析及渲染流程。例如返回值处理器调用了 <code>HttpMessageConverter</code> 将结果转换为 JSON，这时 <code>ModelAndView</code> 就为 <code>null</code></li>
<li>如果返回的 <code>ModelAndView</code> 不为 <code>null</code>，会在第 4 步走视图解析及渲染流程</li>
</ul>
</li>
</ul>
</li>
<li>调用拦截器的 <code>postHandle()</code> 方法</li>
<li>处理异常或视图渲染
<ul>
<li>如果 1~3 步中出现异常，使用 <code>ExceptionHandlerExceptionResolver</code> 处理异常流程
<ul>
<li>@ControllerAdvice 全局增强点 5️⃣：利用 <code>@ExceptionHandler</code> 进行统一异常处理</li>
</ul>
</li>
<li>未出现异常时，进行视图解析及渲染流程</li>
</ul>
</li>
<li>调用拦截器的 <code>afterCompletion()</code> 方法</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Spring-Forty-Nine-Lectures-MVC/">https://mofan212.github.io/posts/Spring-Forty-Nine-Lectures-MVC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Boot/">Spring-Boot</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/124.jpg" data-sites="wechat,qq,weibo,facebook,x"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Spring-Forty-Nine-Lectures-AOP/" title="【Spring 四十九讲】AOP"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/123.jpg" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">【Spring 四十九讲】AOP</div></div><div class="info-2"><div class="info-item-1">Spring 四十九讲中第九讲到第十九讲，AOP。</div></div></div></a><a class="pagination-related" href="/posts/Spring-Forty-Nine-Lectures-Spring-Boot/" title="【Spring 四十九讲】SpringBoot"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/125.jpg" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">【Spring 四十九讲】SpringBoot</div></div><div class="info-2"><div class="info-item-1">Spring 四十九讲中第卅七讲到第卌二讲，Spring Boot。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/SpringBoot-Thymeleaf-Development-Process/" title="SpringBoot + Thymeleaf开发流程"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/26.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-09</div><div class="info-item-2">SpringBoot + Thymeleaf开发流程</div></div><div class="info-2"><div class="info-item-1">本文基于 SpringBoot 2.2.4 ，介绍了 SpringBoot 与 Thymeleaf 结合的基础开发流程。</div></div></div></a><a class="pagination-related" href="/posts/Spring-Forty-Nine-Lectures-AOP/" title="【Spring 四十九讲】AOP"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/123.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-21</div><div class="info-item-2">【Spring 四十九讲】AOP</div></div><div class="info-2"><div class="info-item-1">Spring 四十九讲中第九讲到第十九讲，AOP。</div></div></div></a><a class="pagination-related" href="/posts/SpringBoot-Web-Basic-Knowledge/" title="SpringBoot-Web开发须知"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/24.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-05</div><div class="info-item-2">SpringBoot-Web开发须知</div></div><div class="info-2"><div class="info-item-1">本文基于SpringBoot 2.2.4 ，介绍了在使用SpringBoot开发Web项目前应该知晓的知识。</div></div></div></a><a class="pagination-related" href="/posts/Get-ApplicationContext/" title="获取 ApplicationContext"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/139.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-20</div><div class="info-item-2">获取 ApplicationContext</div></div><div class="info-2"><div class="info-item-1">获取 ApplicationContext 有哪些方式、又有哪些区别呢？</div></div></div></a><a class="pagination-related" href="/posts/Spring-BeanDefinition/" title="BeanDefinition"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/153.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-11</div><div class="info-item-2">BeanDefinition</div></div><div class="info-2"><div class="info-item-1">Spring 中绕不开的一个类 —— BeanDefinition。</div></div></div></a><a class="pagination-related" href="/posts/Spring-Application-Event/" title="Spring 的事件监听机制"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/151.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-14</div><div class="info-item-2">Spring 的事件监听机制</div></div><div class="info-2"><div class="info-item-1">浅谈 SpringBoot 3.x 事件监听机制的底层实现。</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a href="./mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#20-RequestMappingHandlerMapping-%E4%B8%8E-RequestMappingHandlerAdapter"><span class="toc-text">20. RequestMappingHandlerMapping 与  RequestMappingHandlerAdapter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#20-1-DispatcherServlet-%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">20.1 DispatcherServlet 的初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-2-RequestMappingHandlerMapping"><span class="toc-text">20.2 RequestMappingHandlerMapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-3-RequestMappingHandlerAdapter"><span class="toc-text">20.3 RequestMappingHandlerAdapter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#21-%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">21. 参数解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-2-RequestParam"><span class="toc-text">21.2 @RequestParam</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-2-PathVariable"><span class="toc-text">21.2 @PathVariable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-3-RequestHeader"><span class="toc-text">21.3 @RequestHeader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-4-CookieValue"><span class="toc-text">21.4 @CookieValue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-5-Value"><span class="toc-text">21.5 @Value</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-6-HttpServletRequest"><span class="toc-text">21.6 HttpServletRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-7-ModelAttribute"><span class="toc-text">21.7 @ModelAttribute</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-8-RequestBody"><span class="toc-text">21.8 @RequestBody</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#22-%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E5%90%8D"><span class="toc-text">22. 获取参数名</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#23-%E5%AF%B9%E8%B1%A1%E7%BB%91%E5%AE%9A%E4%B8%8E%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-text">23. 对象绑定与类型转换</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#23-1-%E4%B8%89%E7%A7%8D%E8%BD%AC%E6%8D%A2%E6%8E%A5%E5%8F%A3"><span class="toc-text">23.1 三种转换接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-text">23.2 使用示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-3-%E7%BB%91%E5%AE%9A%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-text">23.3 绑定器工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-4-Spring-%E7%9A%84%E6%B3%9B%E5%9E%8B%E6%93%8D%E4%BD%9C%E6%8A%80%E5%B7%A7"><span class="toc-text">23.4 Spring 的泛型操作技巧</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#24-ControllerAdvice-%E4%B9%8B-InitBinder"><span class="toc-text">24. ControllerAdvice 之 @InitBinder</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#25-%E6%8E%A7%E5%88%B6%E5%99%A8%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">25. 控制器方法执行流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#26-ControllerAdvice-%E4%B9%8B-ModelAttribute"><span class="toc-text">26. ControllerAdvice 之 @ModelAttribute</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#27-%E8%BF%94%E5%9B%9E%E5%80%BC%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">27. 返回值处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#27-1-ModelAndView"><span class="toc-text">27.1 ModelAndView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-2-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B"><span class="toc-text">27.2 字符串类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-3-ModelAttribute"><span class="toc-text">27.3 @ModelAttribute</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-4-HttpEntity"><span class="toc-text">27.4 HttpEntity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-5-HttpHeaders"><span class="toc-text">27.5 HttpHeaders</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-6-ResponseBody"><span class="toc-text">27.6 @ResponseBody</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#28-%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-text">28. 消息转换器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#29-ControllerAdvice-%E4%B9%8B-ResponseBodyAdvice"><span class="toc-text">29. ControllerAdvice 之 ResponseBodyAdvice</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#30-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">30. 异常处理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#31-ControllerAdvice-%E4%B9%8B-ExceptionHandler"><span class="toc-text">31. ControllerAdvice  之 @ExceptionHandler</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#32-Tomcat-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">32. Tomcat 异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#32-1-Tomcat-%E7%9A%84%E9%94%99%E8%AF%AF%E9%A1%B5%E5%A4%84%E7%90%86"><span class="toc-text">32.1 Tomcat 的错误页处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-2-BasicErrorController"><span class="toc-text">32.2 BasicErrorController</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#33-BeanNameUrlHandlerMapping-%E4%B8%8E-SimpleControllerHandlerAdapter"><span class="toc-text">33. BeanNameUrlHandlerMapping 与 SimpleControllerHandlerAdapter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#33-1-%E5%8A%9F%E8%83%BD%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-text">33.1 功能与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0"><span class="toc-text">33.2 自定义实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#34-RouterFunctionMapping-%E4%B8%8E-HandlerFunctionAdapter"><span class="toc-text">34. RouterFunctionMapping 与 HandlerFunctionAdapter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#35-SimpleUrlHandlerMapping-%E4%B8%8E-HttpRequestHandlerAdapter"><span class="toc-text">35. SimpleUrlHandlerMapping 与 HttpRequestHandlerAdapter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#35-1-%E5%8A%9F%E8%83%BD%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-text">35.1 功能与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#35-2-%E8%B5%84%E6%BA%90%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">35.2 资源解析器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#35-3-%E6%AC%A2%E8%BF%8E%E9%A1%B5%E5%A4%84%E7%90%86"><span class="toc-text">35.3 欢迎页处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#35-4-%E6%98%A0%E5%B0%84%E5%99%A8%E4%B8%8E%E9%80%82%E9%85%8D%E5%99%A8%E6%80%BB%E7%BB%93"><span class="toc-text">35.4 映射器与适配器总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#36-MVC-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">36. MVC 处理流程</span></a></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>黑马程序员 Spring 四十九讲</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Forty-Nine-Lectures-Container-And-Bean/" title="【Spring 四十九讲】容器与 Bean"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/122.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【Spring 四十九讲】容器与 Bean"></a><div class="content"><a class="title" href="/posts/Spring-Forty-Nine-Lectures-Container-And-Bean/" title="【Spring 四十九讲】容器与 Bean">【Spring 四十九讲】容器与 Bean</a><time datetime="2023-01-07T16:00:00.000Z" title="发表于 2023-01-08 00:00:00">2023-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Forty-Nine-Lectures-AOP/" title="【Spring 四十九讲】AOP"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/123.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【Spring 四十九讲】AOP"></a><div class="content"><a class="title" href="/posts/Spring-Forty-Nine-Lectures-AOP/" title="【Spring 四十九讲】AOP">【Spring 四十九讲】AOP</a><time datetime="2023-01-20T16:00:00.000Z" title="发表于 2023-01-21 00:00:00">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Forty-Nine-Lectures-MVC/" title="【Spring 四十九讲】WebMVC"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/124.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【Spring 四十九讲】WebMVC"></a><div class="content"><a class="title" href="/posts/Spring-Forty-Nine-Lectures-MVC/" title="【Spring 四十九讲】WebMVC">【Spring 四十九讲】WebMVC</a><time datetime="2023-01-26T16:00:00.000Z" title="发表于 2023-01-27 00:00:00">2023-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Forty-Nine-Lectures-Spring-Boot/" title="【Spring 四十九讲】SpringBoot"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/125.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【Spring 四十九讲】SpringBoot"></a><div class="content"><a class="title" href="/posts/Spring-Forty-Nine-Lectures-Spring-Boot/" title="【Spring 四十九讲】SpringBoot">【Spring 四十九讲】SpringBoot</a><time datetime="2023-01-28T16:00:00.000Z" title="发表于 2023-01-29 00:00:00">2023-01-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Spring-Forty-Nine-Lectures-Sundry/" title="【Spring 四十九讲】杂项"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/126.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="【Spring 四十九讲】杂项"></a><div class="content"><a class="title" href="/posts/Spring-Forty-Nine-Lectures-Sundry/" title="【Spring 四十九讲】杂项">【Spring 四十九讲】杂项</a><time datetime="2023-02-02T16:00:00.000Z" title="发表于 2023-02-03 00:00:00">2023-02-03</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Something-About-Blog/" title="博客搭建与维护"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/42.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="博客搭建与维护"/></a><div class="content"><a class="title" href="/posts/Something-About-Blog/" title="博客搭建与维护">博客搭建与维护</a><time datetime="2026-01-24T16:00:00.000Z" title="更新于 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 内存模型"/></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java 内存模型">Java 内存模型</a><time datetime="2026-01-02T16:00:00.000Z" title="更新于 2026-01-03 00:00:00">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="字节码与类加载"/></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载">字节码与类加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 的类资源加载"/></a><div class="content"><a class="title" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载">Java 的类资源加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/20.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="注解、类的加载、反射"/></a><div class="content"><a class="title" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射">注解、类的加载、反射</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ren-zhi-jue-xing/" title="认知觉醒"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/172.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="认知觉醒"/></a><div class="content"><a class="title" href="/posts/ren-zhi-jue-xing/" title="认知觉醒">认知觉醒</a><time datetime="2025-12-28T16:00:00.000Z" title="更新于 2025-12-29 00:00:00">2025-12-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By 默烦</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://testingcf.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://gcore.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script src="/js/tip_portal.js"></script><script defer="defer" id="ribbon" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://testingcf.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>