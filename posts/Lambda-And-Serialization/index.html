<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lambda 与序列化 | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="怎么通过方法引用来获取字段名称、Lambda 表达式的序列化又是什么？">
<meta property="og:type" content="article">
<meta property="og:title" content="Lambda 与序列化">
<meta property="og:url" content="https://mofan212.github.io/posts/Lambda-And-Serialization/">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="怎么通过方法引用来获取字段名称、Lambda 表达式的序列化又是什么？">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/104.png">
<meta property="article:published_time" content="2022-07-03T16:00:00.000Z">
<meta property="article:modified_time" content="2024-07-19T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="Java-Lambda">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/104.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lambda 与序列化",
  "url": "https://mofan212.github.io/posts/Lambda-And-Serialization/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/104.png",
  "datePublished": "2022-07-03T16:00:00.000Z",
  "dateModified": "2024-07-19T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Lambda-And-Serialization/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://testingcf.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lambda 与序列化',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css" /><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://testingcf.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lambda 与序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-03T16:00:00.000Z" title="发表于 2022-07-04 00:00:00">2022-07-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-19T16:00:00.000Z" title="更新于 2024-07-20 00:00:00">2024-07-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">14k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>54分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2024-07-20 00:00:00&quot;}" hidden></div>
    <style>
      .highlight-tools {
        background: #262931 !important;
      }
    </style>
    <html><head></head><body><p>封面来源：碧蓝航线 深度回音 活动CG</p>
<p>本文涉及的代码：<a target="_blank" rel="noopener" href="https://github.com/mofan212/java8/tree/master/lambda">java8/lambda</a></p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jb51.net/article/195308.htm">Java8中如何通过方法引用获取属性名详解</a></li>
<li><a target="_blank" rel="noopener" href="https://www.vlts.cn/posts/e18e433c.html">JDK中Lambda表达式的序列化与SerializedLambda的巧妙使用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/HDK2016/p/6838908.html">详解java对象的序列化</a></li>
<li><a target="_blank" rel="noopener" href="https://www.vlts.cn/posts/8dce25c8.html">聊聊Java内省Introspector</a></li>
</ul>
<h1 id="0-前言"><a class="header-anchor" href="#0-前言"></a>0. 前言</h1>
<p>初次见到 Mybatis-Plus 中的 LambdaQuery 时，其使用方法引用获取实体字段名称的方式为我对代码重构的理解提供了新思路，但那时并没有对其进行深究，仅仅是在使用 Mybatis-Plus 时更多地使用 LambdaQuery。</p>
<p>这次就来好好唠唠，如何通过 Java8 的方法引用来获取实体字段名称，以及背后的实现原理。</p>
<p>本文基于 JDK8 编写并在开篇直接给出通过方法引用获取字段名称的具体实现，而后通过对具体实现进行逐行分析完成全文编写。</p>
<h1 id="1-通过方法引用获取字段名称"><a class="header-anchor" href="#1-通过方法引用获取字段名称"></a>1. 通过方法引用获取字段名称</h1>
<h2 id="1-1-具体实现"><a class="header-anchor" href="#1-1-具体实现"></a>1.1 具体实现</h2>
<p>首先需要一个 <strong>可序列化</strong> 的函数式接口，由于 JDK 中并没有提供可序列化的函数式接口，因此需要自行定义一个：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/7 17:07</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> R</span><span style="color:#ABB2BF">&gt;</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Function</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> R</span><span style="color:#ABB2BF">&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后可以通过方法引用获取到实体类的字段名称：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testReflectionUtil</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> function </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> fieldName </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> ReflectionUtil</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFieldName</span><span style="color:#ABB2BF">(function);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"name"</span><span style="color:#ABB2BF">, fieldName);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>那 <code>ReflectionUtil.getFieldName()</code> 又是什么呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/9 16:26</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ReflectionUtil</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> GETTER_PREFIX </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "get"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> BOOLEAN_GETTER_PREFIX </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "is"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> LAMBDA_PREFIX </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "lambda$"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> ?</span><span style="color:#ABB2BF">&gt;,</span><span style="color:#E5C07B"> Field</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> CACHE </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ConcurrentHashMap</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#ABB2BF"> &lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> R</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getFieldName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">R</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">function</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> getField</span><span style="color:#ABB2BF">(function).</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> Field</span><span style="color:#61AFEF"> getField</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">function</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> CACHE</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">computeIfAbsent</span><span style="color:#ABB2BF">(function, ReflectionUtil</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">findField);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> Field</span><span style="color:#61AFEF"> findField</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">function</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Field</span><span style="color:#E06C75"> field</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> fieldName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            Optional</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">serializedLambda</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> LambdaUtil</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSerializedLambda</span><span style="color:#ABB2BF">(function);</span></span>
<span class="line"><span style="color:#E5C07B">            String</span><span style="color:#E06C75"> implMethodName</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> serializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(SerializedLambda</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getImplMethodName).</span><span style="color:#61AFEF">orElse</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">""</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(GETTER_PREFIX) </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#E5C07B"> implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> GETTER_PREFIX</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#ABB2BF">                fieldName </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Introspector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">decapitalize</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">substring</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">GETTER_PREFIX</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">()));</span></span>
<span class="line"><span style="color:#ABB2BF">            } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(BOOLEAN_GETTER_PREFIX) </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#E5C07B"> implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> BOOLEAN_GETTER_PREFIX</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#ABB2BF">                fieldName </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Introspector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">decapitalize</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">substring</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BOOLEAN_GETTER_PREFIX</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">()));</span></span>
<span class="line"><span style="color:#ABB2BF">            } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">implMethodName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(LAMBDA_PREFIX)) {</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> IllegalArgumentException</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"不支持 Lambda 表达式，请使用方法引用"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">            } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> IllegalArgumentException</span><span style="color:#ABB2BF">(implMethodName </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "不是 Getter 方法引用"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#E5C07B">            String</span><span style="color:#E06C75"> implClass</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> serializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(SerializedLambda</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getImplClass).</span><span style="color:#61AFEF">orElse</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">""</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">replace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"/"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"."</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">aClass</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forName</span><span style="color:#ABB2BF">(implClass, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">ClassUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDefaultClassLoader</span><span style="color:#ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 通过 Spring 的 ReflectionUtils 获取 Field 对象</span></span>
<span class="line"><span style="color:#ABB2BF">            field </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> ReflectionUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">findField</span><span style="color:#ABB2BF">(aClass, fieldName);</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> (field </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> field;</span></span>
<span class="line"><span style="color:#ABB2BF">            } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> NoSuchFieldException</span><span style="color:#ABB2BF">(fieldName);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Exception</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> IllegalArgumentException</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"字段信息获取失败 "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMessage</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 <code>findField()</code> 方法开始，首先使用了 <code>LambdaUtil.getSerializedLambda()</code> 获取被 <code>Optional</code> 包装的 <code>SerializedLambda</code> 对象，那 <code>getSerializedLambda()</code> 又是怎么实现的呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LambdaUtil</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getImplClass</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Serializable</span><span style="color:#E06C75;font-style:italic"> serializable</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> getSerializedLambda</span><span style="color:#ABB2BF">(serializable)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(i </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> i</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getImplClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">replace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"/"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"."</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">orElse</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">""</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> Optional</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> getSerializedLambda</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Serializable</span><span style="color:#E06C75;font-style:italic"> serializable</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">aClass</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> serializable</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">aClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSynthetic</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#E5C07B">            Method</span><span style="color:#E06C75"> method</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> aClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"writeReplace"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAccessible</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E5C07B"> Optional</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">((SerializedLambda) </span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(serializable));</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Optional</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">empty</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 <code>ReflectionUtil</code> 中有三个方法：</p>
<p>1、<code>String getFieldName(SFunction&lt;T, R&gt; function)</code>：获取字段名称对应的字符串；</p>
<p>2、<code>Field getField(SFunction&lt;?, ?&gt; function)</code>：获取字段名称对应的 <code>Field</code> 对象。如果缓存中存在则直接从缓存中获取，否则通过反射获取并将其放入缓存中；</p>
<p>3、<code>Field findField(SFunction&lt;?, ?&gt; function)</code>：通过反射获取字段名称对应的 <code>Field</code> 对象。</p>
<h2 id="1-2-问题的抛出"><a class="header-anchor" href="#1-2-问题的抛出"></a>1.2 问题的抛出</h2>
<p>不难看出上述具体实现中的要点就是通过 <code>SerializedLambda</code> 对象获取到使用的方法引用中的信息，而获取 <code>SerializedLambda</code> 对象则是通过反射调用 <code>writeReplace()</code> 方法，那么：</p>
<ul>
<li>
<p><code>SerializedLambda</code> 是什么？</p>
</li>
<li>
<p><code>writeReplace()</code> 方法又是什么？</p>
</li>
</ul>
<p>要回答这两个问题，得先弄清楚 Java 的序列化。</p>
<h1 id="2-Java-的序列化"><a class="header-anchor" href="#2-Java-的序列化"></a>2. Java 的序列化</h1>
<h2 id="2-1-什么是序列化"><a class="header-anchor" href="#2-1-什么是序列化"></a>2.1 什么是序列化</h2>
<p>序列化（Serialization）是将对象的状态信息转换为可以存储或传输的形式的过程。比如将一个对象序列化后可以将它的信息存储到磁盘中的某个文件里，也可以通过反序列化将文件里的信息读取出来并恢复成原来的对象。使用序列化可以让对象脱离程序独立存在。</p>
<p>如果想让某个类能被序列化，那么它 <strong>必须</strong> 实现 <code>Serializable</code> 接口。<code>Serializable</code> 接口只是一个 <strong>标记</strong> 接口，它里面没有任何抽象方法，它仅表示实现它的子类是可序列化的。</p>
<p>所有需要在网络上传输的类都应该是可序列化的，所有需要被保存在磁盘上的类也应该是可序列化的。</p>
<h2 id="2-2-Java-序列化的细节"><a class="header-anchor" href="#2-2-Java-序列化的细节"></a>2.2 Java 序列化的细节</h2>
<p>1、一个对象被序列化时，这个对象的类名、未被 <code>transient</code> 修饰的成员变量都会被序列化，对象的方法、类变量（被 <code>static</code> 修饰的变量）、被 <code>transient</code> 修饰的成员变量不会被序列化；</p>
<p>2、要一个成员变量不被序列化，可以用 <code>transient</code> 关键词修饰它；</p>
<p>3、如果类里面有引用类型的成员变量，那么这个引用类型也 <strong>必须</strong> 是可序列化的（或者使用 <code>transient</code> 修饰），否则这个类不能被序列化；</p>
<p>4、反序列化对象时，<strong>必须</strong> 有目标对象的 Class 文件；</p>
<p>5、通过网络、文件来传输序列化的对象时，<strong>必须</strong> 按照实际写入顺序读取。</p>
<h2 id="2-3-序列化的简单示例"><a class="header-anchor" href="#2-3-序列化的简单示例"></a>2.3 序列化的简单示例</h2>
<p>首先定义一个简单的 <code>People</code> 类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/22 19:46</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> People</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 8209986739933993768L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> People</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"People的无参构造器"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    protected</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> clone</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> CloneNotSupportedException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"People的clone方法"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> super</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clone</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后使用下面的代码创建一个 <code>People</code> 对象并将其保存到 <code>mofan.out</code> 文件中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testSerial</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    People</span><span style="color:#E06C75"> people </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> People</span><span style="color:#E06C75">(</span><span style="color:#98C379">"Mofan"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> 20</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"mofan.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(people);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 判断序列化生成的文件是否存在</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> File</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan.out"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">exists</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后再使用下面的代码从 <code>mofan.out</code> 文件中反序列化生成 <code>People</code> 对象：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testDeSerial</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"mofan.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * 构造 People 对象时，并没有调用它的无参构造方法也没有调用 clone 方法</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     */</span></span>
<span class="line"><span style="color:#E5C07B">    People</span><span style="color:#E06C75"> people </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (People) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Mofan"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">people</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">people</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAge</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>运行上述反序列化的代码后观察 IDEA 控制台的输出会发现并没有输出任何内容，这说明反序列化创建对象时并没有调用目标对象的无参构造方法，也没有调用 <code>clone()</code> 方法，可以认为反序列化创建对象是一种特殊的创建对象的方式。</p>
<p>更多关于如何创建对象的内容可以参考本站《单身狗的福音——如何获得一个对象》一文（好中二的标题 😂）。</p>
<p>如果被序列化对象没有实现 <code>Serializable</code> 接口，那么就会抛出 <code>NotSerializableException</code> 异常。比如定义一个“简单”类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/28 19:33</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Simple</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> stringField</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后实例化“简单”对象，并对这个对象进行序列化：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testNotImplSerializable</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Simple</span><span style="color:#E06C75"> simple </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Simple</span><span style="color:#E06C75">(</span><span style="color:#98C379">"simple"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化时序列化对象未实现序列化接口</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"simple.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(simple);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">fail</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(e </span><span style="color:#C678DD">instanceof</span><span style="color:#ABB2BF"> NotSerializableException);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>简单查看源码，在 <code>ObjectOutputStream</code> 的 <code>writeObject0()</code> 方法中可以看到：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/writeObject0%E6%96%B9%E6%B3%95%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81.png" alt="writeObject0方法部分源码"></p>
<p><strong>如果一个对象不是字符串、数组、枚举，同时也没有实现 <code>Serializable</code> 接口，</strong> 那么就会抛出 <code>NotSerializableException</code> 异常，并且这段代码也证明了 <code>Serializable</code> 接口仅仅是做一个标识，怎么进行序列化并不是由它完成的。</p>
<h2 id="2-4-引用对象的序列化"><a class="header-anchor" href="#2-4-引用对象的序列化"></a>2.4 引用对象的序列化</h2>
<p>在上述简单的示例中，我们定义了 <code>People</code> 类，它含有两个成员变量，类型分别是基本类型 <code>int</code> 和引用类型 <code>String</code>。 观察 <code>String</code> 源码可知，<code>String</code> 也实现了序列化接口。</p>
<p>在【2.2 序列化的细节】中说过：如果类里面有引用类型的成员变量，那么这个引用类型也 <strong>必须</strong> 是可序列化的（或者使用 <code>transient</code> 修饰），否则这个类不能被序列化。</p>
<blockquote>
<p>序列化含有引用类型字段的对象</p>
</blockquote>
<p>例如定义 <code>Company</code> 类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/23 15:24</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Company</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 2033276417972897957L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> companyName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">People</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> employees</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Company</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> companyName</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">People</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">employees</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">companyName</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> companyName;</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">employees</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> employees;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 <code>Company</code> 类中，有两个引用类型的成员变量，并且这两个引用类型对应的类都是可序列化的。</p>
<p>编写简单的测试方法对 <code>Company</code> 对象进行序列化、反序列化测试：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SuppressWarnings</span><span style="color:#E06C75">(</span><span style="color:#98C379">"unchecked"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testSerialReferenceType</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">People</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> list </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> People</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> People</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"MOFAN"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">21</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> People</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"默烦"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">21</span><span style="color:#ABB2BF">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Company</span><span style="color:#E06C75"> hugeCompany </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Company</span><span style="color:#E06C75">(</span><span style="color:#98C379">"大公司"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> list)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Company</span><span style="color:#E06C75"> smallCompany </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Company</span><span style="color:#E06C75">(</span><span style="color:#98C379">"小公司"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> list)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化对象</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"company.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(list);</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(hugeCompany);</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(smallCompany);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 依次反序列化对象</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"company.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">People</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> deSerialList </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">List</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">People</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Company</span><span style="color:#E06C75"> deSerialHugeCompany </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Company) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Company</span><span style="color:#E06C75"> deSerialSmallCompany </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Company) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertSame</span><span style="color:#ABB2BF">(deSerialList, </span><span style="color:#E5C07B">deSerialHugeCompany</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getEmployees</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertSame</span><span style="color:#ABB2BF">(deSerialList, </span><span style="color:#E5C07B">deSerialSmallCompany</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getEmployees</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNotSame</span><span style="color:#ABB2BF">(deSerialHugeCompany, deSerialSmallCompany);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNotSame</span><span style="color:#ABB2BF">(list, deSerialList);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>运行测试方法后，序列化和反序列化都能够成功，并且还发现：序列化前的对象引用关系和反序列化后的对象引用关系是一样的。</p>
<p>比如，序列化前构造的 <code>List</code> 对象、<code>hugeCompany</code> 对象中引用的 <code>List</code> 对象和 <code>smallCompany</code> 对象中引用的 <code>List</code> 对象是同一个对象，而在反序列化后构造的 <code>List</code> 对象、<code>deSerialHugeCompany</code> 对象中引用的 <code>List</code> 对象和 <code>deSerialSmallCompany</code> 对象中引用的 <code>List</code> 对象也是同一个对象。当然了，序列化前的 <code>List</code> 对象和反序列化后 <code>List</code> 对象 <strong>肯定不是</strong> 同一个对象。</p>
<blockquote>
<p>Java 序列化机制细节</p>
</blockquote>
<p>1、所有保存到磁盘中的对象都有一个序列化编号；</p>
<p>2、当程序试图序列化一个对象时，程序将检查该对象是否被序列化过，只有该对象从未被序列化（在本次虚拟机中）过，系统才会将该对象转化为字节序列输出；</p>
<p>3、如果某个对象已经被序列化过了，程序只是输出一个序列化编号，而不是重新序列化该对象。</p>
<blockquote>
<p>序列化含有未实现 <code>Serializable</code> 接口的引用类型字段的对象</p>
</blockquote>
<p>定义一个 <code>Complex</code> 类，在这个类中引用未实现 <code>Serializable</code> 接口的 <code>Simple</code> 类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/28 19:33</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Complex</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 7663091376889314225L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> intField</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Simple</span><span style="color:#E06C75"> simple</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后编写测试方法测试 <code>Complex</code> 对象能否被序列化成功：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testNotImplSerializableFiled</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Simple</span><span style="color:#E06C75"> simple </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Simple</span><span style="color:#E06C75">(</span><span style="color:#98C379">"test"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Complex</span><span style="color:#E06C75"> complex </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Complex</span><span style="color:#E06C75">(</span><span style="color:#D19A66">100</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> simple)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"complex.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(complex);</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">fail</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 抛出 NotSerializableException</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(e </span><span style="color:#C678DD">instanceof</span><span style="color:#ABB2BF"> NotSerializableException);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在执行 <code>oos.writeObject(complex);</code> 时抛出了异常，将其捕获后进行断言，发现抛出了 <code>NotSerializableException</code> 异常，也就是说在序列化含有未实现 <code>Serializable</code> 接口的引用类型字段的对象时将抛出 <code>NotSerializableException</code> 异常。</p>
<blockquote>
<p>使用 <code>transient</code> 修饰不需要被序列化的字段</p>
</blockquote>
<p>当对象中的某些字段不需要被序列化时，可以使用 <code>transient</code> 关键词对这个字段进行修饰。比如可以使用 <code>transient</code> 修饰未实现 <code>Serializable</code> 接口的 <code>Simple</code> 类型的字段：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/28 19:40</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> TransientComplex</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">6616158309969761040L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> string</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> transient</span><span style="color:#E5C07B"> Simple</span><span style="color:#E06C75"> simple</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> bool</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这样的话即使 <code>Simple</code> 未实现序列化接口，在序列化 <code>TransientComplex</code> 对象时也不会抛出异常。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testTransient</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Simple</span><span style="color:#E06C75"> simple </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Simple</span><span style="color:#E06C75">(</span><span style="color:#98C379">"TestString"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    TransientComplex</span><span style="color:#E06C75"> transientComplex </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> TransientComplex</span><span style="color:#E06C75">(</span><span style="color:#98C379">"string"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> simple</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> true</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"transient.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(transientComplex);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"transient.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    TransientComplex</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (TransientComplex) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"string"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">object</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getString</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">object</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isBool</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 虽然 Simple 没有实现序列化接口，但它被 transient 修饰，不会被序列化，因此也不会报错</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNull</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">object</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSimple</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>除了使用 <code>transient</code> 关键词外，也可以使用 <code>static</code> 关键词来使某个字段不被序列化，这很好理解，序列化是为了保存对象的状态，使用 <code>static</code> 修饰字段后，这个字段就变成了类的状态，因此序列化时也就会把它忽略了。只不过并不建议为了使某个字段不被序列化就 <strong>强行</strong> 让 <code>static</code> 修饰它。</p>
<h2 id="2-5-序列化的约束"><a class="header-anchor" href="#2-5-序列化的约束"></a>2.5 序列化的约束</h2>
<p>序列化是将 Java 对象转换为字节序列，而反序列化就是这个过程的逆转，而在序列化或反序列化的过程中，他人对中间的字节流进行了篡改，那么反序列化出的对象将会存在问题。</p>
<p>如果在反序列化时能够对构造出的对象进行校验，那就可以在 <strong>一定程度上</strong> 防止他人篡改数据。在前面的示例中进行反序列化构造对象时都调用了 <code>ObjectInputStream</code> 的 <code>readObject()</code> 方法，而我们也能自定义 <code>readObject()</code> 方法从而约束反序列化构造出的对象。</p>
<p>比如需要对 <code>Student</code> 对象序列化或反序列化，其中的 <code>score</code> 字段值的范围在 0 到 150 之间，为了防止他人将其篡改为非法数据，可以自定义 <code>readObject()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/1 15:51</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Student</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">4539491935997507115L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> score</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> readObject</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ObjectInputStream</span><span style="color:#E06C75;font-style:italic"> ois</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 调用默认的反序列化方法</span></span>
<span class="line"><span style="color:#E5C07B">        ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">defaultReadObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 逻辑判断</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (score </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 0</span><span style="color:#56B6C2"> ||</span><span style="color:#ABB2BF"> score </span><span style="color:#56B6C2">&gt;</span><span style="color:#D19A66"> 150</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> IllegalArgumentException</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"学生分数异常"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后使用一个 <code>score</code> 字段值为 <code>-1</code> 的 <code>Student</code> 对象进行测试：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testReadObject</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Student</span><span style="color:#E06C75"> student </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Student</span><span style="color:#E06C75">(</span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">,</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">1</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"student.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(student);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"student.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">fail</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Exception</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(e </span><span style="color:#C678DD">instanceof</span><span style="color:#ABB2BF"> IllegalArgumentException);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>重写的 <code>readObject()</code> 方法会在反序列化时调用，因此也会在反序列化时抛出 <code>IllegalArgumentException</code> 异常。那问题又来了，为什么会调用自定义的 <code>readObject()</code> 方法呢？</p>
<p>这一切都在 <code>ObjectStreamClass</code> 类（<code>ObjectStreamClass</code> 是序列化和反序列化实现的类描述符）的私有构造方法中：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/ObjectStreamClass%E7%9A%84%E7%A7%81%E6%9C%89%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95.png" alt="ObjectStreamClass的私有构造方法"></p>
<p>不难看出是利用了反射来调用了自定义的 <code>readObject()</code> 方法。</p>
<p>有两个细节：</p>
<p>1、 <strong>如果类是 <code>Externalizable</code> 的子类，那么自定义的 <code>readObject()</code> 方法不会被反射调用。</strong> <code>Externalizable</code> 接口也是一个序列化接口，这后面再说。</p>
<p>2、就算字段被 <code>transient</code> 关键词修饰，只要在自定义的 <code>writeObject()</code> 和 <code>readObject()</code> 方法里显式声明了需要序列化和反序列化被修饰的字段，那么这个字段也会被序列化和反序列化。比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/2 21:27</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">NoArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> User</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">4647801022792976129L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> userName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> transient</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> password</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> writeObject</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ObjectOutputStream</span><span style="color:#E06C75;font-style:italic"> oos</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">defaultWriteObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">password</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> readObject</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ObjectInputStream</span><span style="color:#E06C75;font-style:italic"> ois</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#E5C07B">        ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">defaultReadObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">password</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (String) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>ObjectStreamClass</code> 类的私有构造方法中还提到了 <code>readObjectNoData()</code>、<code>writeReplace()</code> 和 <code>readResolve()</code> 方法，那这些方法又有什么用呢？</p>
<h2 id="2-6-readObjectNoData-方法"><a class="header-anchor" href="#2-6-readObjectNoData-方法"></a>2.6 readObjectNoData 方法</h2>
<p><code>readObjectNoData()</code> 方法用于正确初始化反序列化对象。比如现有 <code>Vip</code> 类定义如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/2 21:38</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Vip</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 5125855385522887545L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> level</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后构建一个 <code>Vip</code> 对象并将其序列化存储到磁盘上：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Vip 还未继承 User</span></span>
<span class="line"><span style="color:#E5C07B">    Vip</span><span style="color:#E06C75"> vip </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Vip</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    vip</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setLevel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"2"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"vip.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(vip);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>假设此时需要 <code>Vip</code> 继承 <code>User</code>，这时对 <code>vip.out</code> 反序列化并构造 <code>Vip</code> 对象，显然构造出的对象中的 <code>userName</code> 和 <code>password</code> 为 <code>null</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testReadObjectNoData</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"vip.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Vip</span><span style="color:#E06C75"> newVip </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Vip) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNull</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">newVip</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getUserName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNull</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">newVip</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPassword</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在实际需求下 <code>null</code> 值数据是非法的，需要为它们设置默认值，这时就可以在 <code>User</code> 类中增加自定义的 <code>readObjectNoData()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> User</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 省略其他内容</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> readObjectNoData</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">userName</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "Unknown"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">password</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "***"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这时再反序列化构造对象就会使未被序列化的字段设置上默认值：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testReadObjectNoData</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"vip.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Vip</span><span style="color:#E06C75"> newVip </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Vip) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Unknown"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">newVip</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getUserName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"***"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">newVip</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPassword</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>当字节信息接收方拓展了发送方发送的字节信息指向的类时，或者字节信息被篡改时，自定义 <code>readObjectNoData()</code> 方法可以保证数据的基本正确性。</p>
<h2 id="2-7-隐藏方法-writeReplace"><a class="header-anchor" href="#2-7-隐藏方法-writeReplace"></a>2.7 隐藏方法 - writeReplace</h2>
<p>实现了 <code>Serializable</code> 接口的类中定义 <code>writeReplace()</code> 方法，其方法签名如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E06C75">ANY</span><span style="color:#56B6C2">-</span><span style="color:#E06C75">ACCESS</span><span style="color:#56B6C2">-</span><span style="color:#E5C07B">MODIFIER</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> writeReplace</span><span style="color:#E06C75">() throws </span><span style="color:#E5C07B">ObjectStreamException</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这是一个隐藏方法，当 JVM 对对象进行序列化时，如果对象中含有此方法，那么 <code>writeReplace()</code> 方法会在 <code>writeObject()</code> <strong>之后</strong> 调用。也就是说，一旦定义了 <code>writeReplace()</code> 方法，那么由 <code>writeObject()</code> 序列化的对象会被完全丢弃，被序列化后存储到磁盘的对象是 <code>writeReplace()</code> 所返回的。</p>
<p>除此之外，<code>writeReplace()</code> 方法 <strong>所返回的对象也必须是可序列化的，</strong> 否则会抛出 <code>NotSerializableException</code> 异常。</p>
<p>定义一个实现了 <code>Serializable</code> 接口的类，并且这个类中含有 <code>writeReplace()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/28 19:58</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> City</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 2376268232459336285L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> area</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#61AFEF"> writeReplace</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ObjectStreamException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 返回的对象必须是可序列化的</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> People</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写测试方法对 <code>City</code> 对象进行序列化：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testWriteReplace</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    City</span><span style="color:#E06C75"> city </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> City</span><span style="color:#E06C75">(</span><span style="color:#98C379">"Chengdu"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> 143</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"chengdu.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(city);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"chengdu.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(object </span><span style="color:#C678DD">instanceof</span><span style="color:#ABB2BF"> People);</span></span>
<span class="line"><span style="color:#E5C07B">    People</span><span style="color:#E06C75"> people </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (People) object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">people</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">people</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAge</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>还可以查看序列化生成的 <code>chengdu.out</code> 文件内容：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/chengdu.out.png" alt="chengdu.out"></p>
<p>虽然这个文件的内容我们难以读懂，但是能看到 <code>indi.mofan.serial.People</code> 和 <code>mofan</code> 等字样，而前者就是 <code>People</code> 类的全限定名称，这也表示被序列化存储到磁盘上的对象信息是 <code>writeReplace()</code> 方法的返回值。</p>
<h2 id="2-8-隐藏方法-readResolve"><a class="header-anchor" href="#2-8-隐藏方法-readResolve"></a>2.8 隐藏方法 - readResolve</h2>
<p>和 <code>writeReplace()</code> 相对的就是 <code>readResolve()</code> 方法，<code>readResolve()</code> 方法会在 <code>readObject()</code> 方法 <strong>之后</strong> 调用。也就是说，一旦定义了 <code>readResolve()</code> 方法，那么由 <code>readObject()</code> 方法反序列化所构造的对象会被完全丢弃，取而代之的是由 <code>readResolve()</code> 方法所返回的对象。</p>
<p>与 <code>writeReplace()</code> 方法不同的是，<code>readResolve()</code> 方法返回的对象 <strong>不一定</strong> 得是可序列化的。</p>
<p>定义一个实现了 <code>Serializable</code> 接口的类，并且这个类中含有 <code>readResolve()</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/28 20:51</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AllArgsConstructor</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Fruit</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 4088817990272523988L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> color</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> double</span><span style="color:#E06C75"> size</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#61AFEF"> readResolve</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ObjectStreamException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 返回的对象不一定是可序列化的</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Simple</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Simple"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写测试方法对 <code>Fruit</code> 对象进行序列化：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testReadResolve</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Fruit</span><span style="color:#E06C75"> fruit </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Fruit</span><span style="color:#E06C75">(</span><span style="color:#98C379">"orange"</span><span style="color:#ABB2BF">,</span><span style="color:#98C379"> "orange"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> 2.12</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"orange.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(fruit);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"orange.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(object </span><span style="color:#C678DD">instanceof</span><span style="color:#ABB2BF"> Simple);</span></span>
<span class="line"><span style="color:#E5C07B">    Simple</span><span style="color:#E06C75"> simple </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Simple) object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Simple"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">simple</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getStringField</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>同样也查看序列化生成的 <code>orange.out</code> 文件内容：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/orange.out.png" alt="orange.out"></p>
<p>在这个文件中可以看到 <code>indi.mofan.serial.Fruit</code> 的字样，这也是 <code>Fruit</code> 类的全限定名称。根据前面的经验可以知道，被序列化存储到磁盘上的对象信息依旧是 <code>Fruit</code> 对象的信息，只不过由于存在的 <code>readResolve()</code> 方法使得反序列化返回的对象是 <code>readResolve()</code> 方法返回的对象。</p>
<blockquote>
<p>单例模式的增强</p>
</blockquote>
<p>反序列化构造对象是一种构造对象的特殊方式，那么这就有可能带来一个问题： <strong>可序列化的单例对象可能并不单例。</strong></p>
<p>采用静态嵌套类方式实现单例模式：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/1 12:53</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Singleton</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 5603073114730981002L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#61AFEF"> Singleton</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> SingletonHolder</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Singleton</span><span style="color:#E06C75"> SINGLETON </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Singleton</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> synchronized</span><span style="color:#E5C07B"> Singleton</span><span style="color:#61AFEF"> getSingleton</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> SingletonHolder</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SINGLETON</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>Singleton</code> 实现了 <code>Serializable</code> 接口，尝试序列化这个单例对象：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testSingleton</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"singleton.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Singleton</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSingleton</span><span style="color:#ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"singleton.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Singleton</span><span style="color:#E06C75"> singleton </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Singleton) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNotSame</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Singleton</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSingleton</span><span style="color:#ABB2BF">(), singleton);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>上方测试方法能够成功通过，通过最后的断言可知，反序列化构造的对象与序列化前的单例对象不是同一个对象。这时就可以利用 <code>readResolve()</code> 方法来解决这个问题，在 <code>Singleton</code> 类中定义 <code>readResolve()</code> 方法，然后返回单例对象即可。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Singleton</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 省略其他实现</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> readResolve</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ObjectStreamException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> getSingleton</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="2-9-Externalizable-接口"><a class="header-anchor" href="#2-9-Externalizable-接口"></a>2.9 Externalizable 接口</h2>
<p>除了实现 <code>Serializable</code> 接口可以让对象具备可序列化的特性外，实现 <code>Externalizable</code> 接口也可以达到同样的效果，只不过这个接口不再是一个标记接口，需要重写它里面的 <code>writeExternal()</code> 和 <code>readExternal()</code> 抽象方法。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/28 20:59</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Animal</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Externalizable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">3303909578015151048L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> type</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Animal</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Externalizable 反序列化时会调用无参构造方法</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Animal 的无参构造器"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Animal</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> type</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> age</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">type</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> type;</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">age</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> age;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> writeExternal</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ObjectOutput</span><span style="color:#E06C75;font-style:italic"> out</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 序列化时使用</span></span>
<span class="line"><span style="color:#E5C07B">        out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">type</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeInt</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">age</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> readExternal</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ObjectInput</span><span style="color:#E06C75;font-style:italic"> in</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 反序列化使用。设置字段值的顺序要和序列化时一致。</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">type</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (String) </span><span style="color:#E5C07B">in</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">age</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> in</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readInt</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编写测试方法对 <code>Animal</code> 对象进行序列化：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testExternalizable</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Animal</span><span style="color:#E06C75"> animal </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Animal</span><span style="color:#E06C75">(</span><span style="color:#98C379">"cat"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> 1</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"cat.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(animal);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反序列化</span></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(</span><span style="color:#98C379">"cat.out"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> object </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Animal</span><span style="color:#E06C75"> cat </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Animal) object</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"cat"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">cat</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getType</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">cat</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAge</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>运行测试方法后，断言能完全通过，并且在控制台打印出：</p>
<pre>Animal 的无参构造器
</pre>
<p>通过控制台打印出来的内容可知， <strong>实现 <code>Externalizable</code> 接口来反序列化时会调用目标对象的无参构造方法，</strong> 然后在 <code>readExternal()</code> 方法中对成员变量赋值，而实现 <code>Serializable</code> 接口进行反序列化时是不会调用任何构造器的。</p>
<p><code>Externalizable</code> 接口中有两个抽象方法，其中序列化时使用 <code>writeExternal()</code>，反序列化时使用 <code>readExternal()</code>。</p>
<p><mark>注意：</mark></p>
<p>1、相比于实现 <code>Serializable</code> 接口，实现 <code>Externalizable</code> 接口时，无参构造方法是 <strong>必要</strong> 的。</p>
<p>2、在 <code>readExternal()</code> 方法中设置字段值的顺序要和 <code>writeExternal()</code> 方法中读取字段值的顺序一致。</p>
<p>3、就算字段被 <code>transient</code> 关键词修饰，只要在重写的方法里显式声明了需要序列化和反序列化被修饰的字段，那么这个字段也会被序列化和反序列化。</p>
<h2 id="2-10-序列化的版本"><a class="header-anchor" href="#2-10-序列化的版本"></a>2.10 序列化的版本</h2>
<p>在实现了序列化接口的类中经常能看到以下一行代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 5125855385522887545L</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>反序列化 Java 对象必须要有该对象的 Class 文件，但随着项目的迭代升级，系统的 Class 文件也在迭代升级，为了保证两个 Class 文件的兼容性，Java 的序列化机制为序列化类 <strong>默认</strong> 提供了一个名为 <code>serialVersionUID</code> 的唯一标识符（可以认为是 Java 类的序列化版本）。如果没有显式声明 <code>serialVersionUID</code> 的值，当类发生迭代升级后，默认提供的 <code>serialVersionUID</code> 值也会发生变化。</p>
<p>当一个类迭代升级后，只要它的 <code>serialVersionUID</code> 值不变，序列化机制就会把它们当成是同一个序列化版本，也就可以反序列化成功，否则抛出 <code>InvalidClassException</code> 异常终止发序列化过程。</p>
<p><strong>因此建议凡是实现了 <code>Serializable</code> 接口的类，都应当显式声明 <code>serialVersionUID</code> 的值。</strong></p>
<h2 id="2-11-serialPersistentFields"><a class="header-anchor" href="#2-11-serialPersistentFields"></a>2.11 serialPersistentFields</h2>
<p>在 JDK 14 中引入了 <code>@Serial</code> 注解，该注解只用于标记，和 <code>@Override</code>、<code>@FunctionalInterface</code> 等注解类似，<code>@Serial</code> 注解用于标记与序列化相关的方法和字段。</p>
<p>与序列化相关的字段除了 <code>serialVersionUID</code> 外，还有 <code>serialPersistentFields</code>。比如在 <code>String</code> 类的源码中可以看到：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">java</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">io</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Serial</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> ObjectStreamField</span><span style="color:#E06C75">[] serialPersistentFields </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ObjectStreamField</span><span style="color:#E06C75">[</span><span style="color:#D19A66">0</span><span style="color:#E06C75">]</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>一个实现了 <code>Serialzable</code> 接口的类，默认情况下所有非 <code>transient</code>、非 <code>static</code> 的字段都会被序列化，但如果定义了 <code>serialPersistentFields</code> 字段，那么只有 <code>serialPersistentFields</code> 里添加的字段才会被序列化。如果一个字段被 <code>transient</code> 修饰，但又被添加到 <code>serialPersistentFields</code> 字段中，这个字段依旧会被序列化。<code>serialPersistentFields</code> 的优先级比 <code>transient</code> 高，而被 <code>static</code> 修饰的字段始终不能被序列化。</p>
<blockquote>
<p>使用细节</p>
</blockquote>
<ul>
<li><code>serialPersistentFields</code> 字段必须是 <code>ObjectStreamField[]</code> 类型，且被 <code>private static final</code> 修饰，否则不生效。</li>
<li>如果 <code>serialPersistentFields</code> 字段值为 <code>null</code>，也不会生效；但如果字段值是空数组，比如 <code>{}</code> 或 <code>new ObjectStreamField[0]</code>，则不会序列化类中的任何字段。</li>
<li>如果声明了类中并不存在的字段，在序列化时抛出 <code>InvalidClassException</code> 异常。</li>
</ul>
<blockquote>
<p>使用示例</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2023/6/15 21:34</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Computer</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Serial</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 455386781881536390L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Serial</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> ObjectStreamField</span><span style="color:#E06C75">[] serialPersistentFields </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">            new</span><span style="color:#61AFEF"> ObjectStreamField</span><span style="color:#E06C75">(</span><span style="color:#98C379">"brand"</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 可以序列化被 transient 字段，但不能序列化 static 字段</span></span>
<span class="line"><span style="color:#C678DD">            new</span><span style="color:#61AFEF"> ObjectStreamField</span><span style="color:#E06C75">(</span><span style="color:#98C379">"price"</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> BigDecimal</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#E06C75">    }</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> brand</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> size</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> transient</span><span style="color:#E5C07B"> BigDecimal</span><span style="color:#E06C75"> price</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> staticStr</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SneakyThrows</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testSerializedComputer</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Computer</span><span style="color:#E06C75"> computer </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> buildComputer</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> filePath </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "./target/rog.out"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    FileOutputStream</span><span style="color:#E06C75"> fos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileOutputStream</span><span style="color:#E06C75">(filePath)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(fos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> (fos</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> oos) {</span></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(computer);</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        Assertions</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">fail</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#61AFEF">    assertThat</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> File</span><span style="color:#E06C75">(filePath))</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">isNotEmpty</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">content</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">doesNotContain</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Republic of Gamers"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    FileInputStream</span><span style="color:#E06C75"> fis </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#E06C75">(filePath)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(fis)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> (fis</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> ois) {</span></span>
<span class="line"><span style="color:#E5C07B">        Computer</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Computer) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#61AFEF">        assertThat</span><span style="color:#E06C75">(result)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">extracting</span><span style="color:#ABB2BF">(Computer</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getBrand, Computer</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getSize, Computer</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getPrice, i </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> Computer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">staticStr</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">containsSequence</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ROG"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> BigDecimal</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"10000.00"</span><span style="color:#ABB2BF">), </span><span style="color:#98C379">"Republic of Gamers"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        Assertions</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">fail</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> Computer</span><span style="color:#61AFEF"> buildComputer</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Computer</span><span style="color:#E06C75"> computer </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Computer</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    computer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setBrand</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ROG"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    computer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setPrice</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> BigDecimal</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"10000.00"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    computer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setSize</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"16 inch"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Computer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">staticStr</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "Republic of Gamers"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> computer</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>序列化的内容就说这么多，也知道了 <code>writeReplace()</code> 方法是干嘛的，但现在又出现了一个问题：虽然定义的函数式接口 <code>SFunction</code> 继承了 <code>Serializable</code> 接口，但并没有像前文讲的那样显式声明 <code>writeReplace()</code> 方法，并且还可以反射调用 <code>writeReplace()</code> 方法获取到 <code>SerializedLambda</code> 对象。这又是为什么呢？</p>
<p>这就不得不说说 Lambda 表达式的序列化了。</p>
<h1 id="3-Lambda-表达式的序列化"><a class="header-anchor" href="#3-Lambda-表达式的序列化"></a>3. Lambda 表达式的序列化</h1>
<h2 id="3-1-LambdaMetafactory"><a class="header-anchor" href="#3-1-LambdaMetafactory"></a>3.1 LambdaMetafactory</h2>
<p>Lambda 表达式或方法引用使用到的自定义的函数式接口 <code>SFunction</code> 以及 Java 中自带的函数式接口虽然只是一个接口，但最终在程序中必定也是一个实现类的实例对象，不然程序怎么能够正常执行呢？这些实例对象的创建肯定是在程序运行时动态创建的，毕竟使用者并没有显式创建它们。</p>
<p>说到这些实例对象的创建就不得不谈到 <code>LambdaMetafactory</code> 类了，光从类名就不难看出这是一个工厂类，而且是和 Lambda 表达式相关的工厂类，那这个工厂类是用来创建什么对象呢？</p>
<p>很显然是用来创建 Lambda 表达式或方法引用的实现类的实例对象。证据可以查看 <code>LambdaMetafactory</code> 的首段注释：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/LambdaMetafactory%E7%9A%84%E9%A6%96%E6%AE%B5%E6%B3%A8%E9%87%8A.png" alt="LambdaMetafactory的首段注释"></p>
<p><code>LambdaMetafactory</code> 的顶部有大量的注释，不妨就从这些注释出发，探索 Lambda 表达式序列化的奥秘。</p>
<p><code>LambdaMetafactory</code> 中有且仅有两个静态方法，分别是 <code>metafactory()</code> 和 <code>altMetafactory()</code>。按照官方给出的注释信息，<code>metafactory()</code> 是构造实例对象的标准版，<code>altMetafactory()</code> 则是备用版，是标准版的概括。备用版对生成的函数对象提供了额外的控制，并且增加了管理函数对象的某些特性的能力，其中有个特性便是 <strong>可序列化性</strong>。</p>
<p>有一段的注释内容如下：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E5%87%BD%E6%95%B0%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8F%AF%E5%BA%8F%E5%88%97%E5%8C%96%E6%80%A7.png" alt="函数对象的可序列化性"></p>
<p>这段文字给出两个信息：</p>
<p>1、生成的函数对象 <strong>默认</strong> 不具备可序列化性，除非被 <code>FLAG_SERIALIZABLE</code> 标记；</p>
<p>2、具备可序列化性的函数对象将以 <code>SerializedLambda</code> 实例的形式进行序列化。</p>
<p><code>FLAG_SERIALIZABLE</code> 是 <code>LambdaMetafactory</code> 中的一个常量，关于它更多的信息在 <code>altMetafactory()</code> 方法的头部注释有这样一段：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/FLAG_SERIALIZABLE%E7%9A%84%E4%BD%9C%E7%94%A8.png" alt="FLAG_SERIALIZABLE的作用"></p>
<p>再简单概括下：被 <code>FLAG_SERIALIZABLE</code> 标记而生成的函数对象会实现 <code>Serializable</code> 接口，并且函数对象将有一个名为 <code>writeReplace()</code> 且返回类型为 <code>SerializedLambda</code> 的方法。调用这些函数对象的方法的类中必须有一个名为 <code>$deserializeLambda$</code> 的方法，如同 <code>SerializedLambda</code> 那样。</p>
<p>这段注释的具体实现可以查看 <code>altMetafactory()</code> 方法的最后几行：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E6%9E%84%E9%80%A0InnerClassLambdaMetafactory%E5%AF%B9%E8%B1%A1%E5%B9%B6%E8%B0%83%E7%94%A8buildCallSite%E6%96%B9%E6%B3%95.png" alt="构造InnerClassLambdaMetafactory对象并调用buildCallSite方法"></p>
<p>在此构造了 <code>InnerClassLambdaMetafactory</code> 对象并调用其 <code>buildCallSite()</code> 方法，调用的 <code>InnerClassLambdaMetafactory</code> 构造方法中有个名为 <code>isSerializable</code> 的局部变量，其定义如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">boolean</span><span style="color:#E06C75"> isSerializable </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> ((flags </span><span style="color:#56B6C2">&amp;</span><span style="color:#E06C75"> FLAG_SERIALIZABLE) </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> 0</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>简单来说就是生成的函数对象是否具备可序列化性。</p>
<p>再看 <code>InnerClassLambdaMetafactory</code> 对象的 <code>buildCallSite()</code> 方法，这个方法 <strong>首行</strong> 调用了名为 <code>spinInnerClass()</code> 的私有方法，这个方法里面有这样一行代码：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E8%B0%83%E7%94%A8generateSerializationFriendlyMethods%E6%96%B9%E6%B3%95.png" alt="调用generateSerializationFriendlyMethods方法"></p>
<p>如果 <strong>具备可序列化性</strong>，那么就调用 <code>generateSerializationFriendlyMethods()</code> 方法，见名识意，这个方法是由来生成序列化方法的，那么 <code>writeReplace()</code> 极有可能就是在此生成的。</p>
<p>查看其源码：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/generateSerializationFriendlyMethods%E6%96%B9%E6%B3%95%E7%9A%84%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81.png" alt="generateSerializationFriendlyMethods方法的部分源码"></p>
<p>猜想正确！🎉</p>
<blockquote>
<p>小总结</p>
</blockquote>
<p>实现了 <code>Serializable</code> 接口的函数式接口生成的函数对象中自动会生成一个名为 <code>writeReplace</code> 且返回值为 <code>SerializedLambda</code> 的方法。</p>
<p>OK，没有显式定义 <code>writeReplace()</code> 方法却能够反射调用 <code>writeReplace()</code> 方法的原因找到了，那 <code>SerializedLambda</code> 又是什么呢？</p>
<h2 id="3-2-SerializedLambda"><a class="header-anchor" href="#3-2-SerializedLambda"></a>3.2 SerializedLambda</h2>
<p>依旧从注释入手：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/SerializedLambda%E7%9A%84%E9%A1%B6%E9%83%A8%E6%B3%A8%E9%87%8A.png" alt="SerializedLambda的顶部注释"></p>
<p>简单概括下：</p>
<p>第一大段：<code>SerializedLambda</code> 是 Lambda 表达式的序列化形式，它存储了 Lambda 表达式的运行时信息。</p>
<p>第二大段：为确保 Lambda 表达式序列化的正确性，编译器或语言类库可以选用的一种方法是确保 <code>writeReplace()</code> 方法返回 <code>SerializedLambda</code> 实例，而不是进行默认的序列化。</p>
<p>第三大段：<code>SerializedLambda</code> 中有一个名为 <code>readResolve()</code> 的方法，<code>readResolve()</code> 调用“捕获类”中一个名为 <code>$deserializeLambda$(SerializedLambda)</code> 的静态方法（可能是私有的），这个静态方法以当前 <code>SerializedLambda</code> 实例作为第一个参数并返回结果。实现 <code>$deserializeLambda$</code> 的 Lambda 类负责验证序列化 Lambda 的属性是否与该类实际捕获的 Lambda 一致。可以理解为反序列化。</p>
<p>在高版本 JDK 中此处注释还有第四大段，其大致含义为：序列化和反序列化产生的函数对象的标识信息是不可预测的，因此不同实现类的函数对象、甚至同一个实现类的不同反序列化结果的敏感标识操作（相等性、对象锁、标识哈希码）都是不同的。</p>
<p>说了这么多，重点还是第一大段讲的 <strong><code>SerializedLambda</code> 存储了拥有可序列化性的 Lambda 表达式的运行时信息。</strong></p>
<p>这些运行时信息保存在 <code>SerializedLambda</code> 的成员变量中，各个含义可以参考 <code>SerializedLambda</code> 的全参构造方法的注释：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/SerializedLambda%E5%85%A8%E5%8F%82%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E7%9A%84%E6%B3%A8%E9%87%8A.png" alt="SerializedLambda全参构造方法的注释"></p>
<p>根据注释，整理出如下表格：</p>
<table>
<thead>
<tr>
<th style="text-align:center">成员变量</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">capturingClass</td>
<td style="text-align:center">捕获类，Lambda 表达式出现的所在类</td>
</tr>
<tr>
<td style="text-align:center">functionalInterfaceClass</td>
<td style="text-align:center">Lambda 表达式对应的函数式接口名称，以 <code>/</code> 分割</td>
</tr>
<tr>
<td style="text-align:center">functionalInterfaceMethodName</td>
<td style="text-align:center">函数式接口的抽象方法名称</td>
</tr>
<tr>
<td style="text-align:center">functionalInterfaceMethodSignature</td>
<td style="text-align:center">函数式接口的抽象方法的签名（使用了泛型则是泛型擦除后的类型）</td>
</tr>
<tr>
<td style="text-align:center">implMethodKind</td>
<td style="text-align:center">实现方法的 <code>Method Handle</code> 类型</td>
</tr>
<tr>
<td style="text-align:center">implClass</td>
<td style="text-align:center">持有该函数式接口抽象方法的 <strong>实现方法</strong> 所在的类名称（实现了函数式接口方法的实现类），以 <code>/</code> 分隔</td>
</tr>
<tr>
<td style="text-align:center">implMethodName</td>
<td style="text-align:center">函数式接口抽象方法的 <strong>实现方法</strong> 名称</td>
</tr>
<tr>
<td style="text-align:center">implMethodSignature</td>
<td style="text-align:center">函数式接口抽象方法的 <strong>实现方法</strong> 签名</td>
</tr>
<tr>
<td style="text-align:center">instantiatedMethodType</td>
<td style="text-align:center">函数式接口对应的实现类中实现方法的签名</td>
</tr>
<tr>
<td style="text-align:center">capturedArgs</td>
<td style="text-align:center">Lambda 表达式捕获的动态参数</td>
</tr>
</tbody>
</table>
<p>有几个要点：</p>
<p>1、<code>implClass</code> 表示 <strong>持有</strong> 实现方法的 Class 名称，注意并不是函数式接口对应的实现类的名称；</p>
<p>2、上表黑体的 <strong>实现方法</strong> 与实现类中的实现方法不是同一概念。</p>
<blockquote>
<p>SerializedLambda 实例</p>
</blockquote>
<p>以一个测试方法为例，并在其 <strong>最后一行打上断点</strong>，查看 Lambda 表达式与方法引用对应的 <code>SerializedLambda</code> 对象的区别，并比较 <code>SerializedLambda</code> 中成员变量值的差异：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">package</span><span style="color:#C678DD"> indi.mofan</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/9 10:47</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LambdaTest</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testSerializedLambda</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">methodReferenceFunc</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> Person</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName;</span></span>
<span class="line"><span style="color:#E5C07B">        Method</span><span style="color:#E06C75"> methodReferenceMethod</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> methodReferenceFunc</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getDeclaredMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"writeReplace"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        methodReferenceMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAccessible</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        SerializedLambda</span><span style="color:#E06C75"> methodReferenceLambda</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (SerializedLambda) </span><span style="color:#E5C07B">methodReferenceMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(methodReferenceFunc);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">lambdaFunc</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (person) </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> person</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        Method</span><span style="color:#E06C75"> lambdaMethod</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> lambdaFunc</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getDeclaredMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"writeReplace"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        lambdaMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAccessible</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        SerializedLambda</span><span style="color:#E06C75"> lambda</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (SerializedLambda) </span><span style="color:#E5C07B">lambdaMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(lambdaFunc);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(); </span><span style="color:#7F848E;font-style:italic">// 此处断点</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E4%B8%8D%E5%90%8CSerializedLambda%E5%AE%9E%E4%BE%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB.png" alt="不同SerializedLambda实例之间的区别"></p>
<p>方法引用 <code>Person::getName</code> 对应的 <code>SerializedLambda</code> 实例相比于 Lambda 表达式 <code>(person) -&gt; person.getName()</code> 对应的 <code>SerializedLambda</code> 实例 <strong>主要</strong> 有以下区别：</p>
<p>1、<code>implClass</code> 不同。前者指向 <code>Person</code> 类，后者指向当前测试类；</p>
<p>2、<code>implMethodName</code> 不同。前者指向 <code>getName</code> 方法，后者指向 Lambda 表达式生成的实现类中的对应的实现方法；</p>
<p>3、<code>implMethodSignature</code> 不同。原因同上。</p>
<p>根据上面三个 <strong>主要区别</strong>，可以使用 <code>implMethodName</code> 的值来判断使用的是方法引用还是 Lambda 表达式。这也是文首 <code>ReflectionUtil.findField()</code> 方法中 <code>implMethodName.startsWith(LAMBDA_PREFIX)</code> 判断的由来。</p>
<blockquote>
<p>Lambda 表达式的序列化</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testSerialLambda</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> methodReferenceFunc </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> methodReferenceClass </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> serial</span><span style="color:#E06C75">(methodReferenceFunc)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lambdaFunc </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (person) </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> person</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lambdaClass </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> serial</span><span style="color:#E06C75">(lambdaFunc)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">();</span><span style="color:#7F848E;font-style:italic"> // 此处断点</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> serial</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Serializable</span><span style="color:#E06C75"> serializable) throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    ByteArrayOutputStream</span><span style="color:#E06C75"> baos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ByteArrayOutputStream</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(baos)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(serializable);</span></span>
<span class="line"><span style="color:#E5C07B">    oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> ByteArrayInputStream</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">baos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toByteArray</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>testSerialLambda()</code> 方法最后一行断点，查看 <code>methodReferenceClass</code> 和 <code>lambdaClass</code> 的信息：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8%E4%B8%8ELambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%BA%A7%E7%94%9F%E7%9A%84Class%E4%BF%A1%E6%81%AF.png" alt="反序列化方法引用与Lambda表达式产生的Class信息"></p>
<blockquote>
<p>另一种获取 SerializedLambda 实例的方式</p>
</blockquote>
<p>前文中 <code>SerializedLambda</code> 实例都是使用反射调用 <code>writeReplace()</code> 方法来获取的，还可以通过序列化与反序列化的方式来获取 <code>SerializedLambda</code> 实例。</p>
<p>反序列化调用的 <code>ObjectInputStream.readObject()</code> 方法会回调 <code>SerializedLambda.readResolve()</code> 方法，致使最终返回的结果是一个新模板类承载的 Lambda 表达式实例，因此需要想办法中断这个调用以提前返回结果。</p>
<p>方法是构造一个和 <code>java.lang.invoke.SerializedLambda</code> 同名的类（可以不同包名），并且这个类里没有 <code>readResolve()</code> 方法，以便绕过 <code>ObjectStreamClass.classNamesEqual()</code> 方法的判断。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * Compares class names for equality, ignoring package names.  Returns true</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * if class names equal, false otherwise.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> classNamesEqual</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> name1</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name2) {</span></span>
<span class="line"><span style="color:#E06C75">    name1 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> name1</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">substring</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">name1</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">lastIndexOf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">'.'</span><span style="color:#ABB2BF">) </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    name2 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> name2</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">substring</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">name2</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">lastIndexOf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">'.'</span><span style="color:#ABB2BF">) </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 只判断类名，并未判断全限定名</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> name1</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(name2);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>自定义的 <code>SerializedLambda</code> 如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">package</span><span style="color:#C678DD"> indi.mofan.lambda</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#E5C07B"> java.io.Serializable</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/3 18:41</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SuppressWarnings</span><span style="color:#E06C75">(</span><span style="color:#98C379">"ALL"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> SerializedLambda</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 8025925345765570181L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> capturingClass</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> functionalInterfaceClass</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> functionalInterfaceMethodName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> functionalInterfaceMethodSignature</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> implClass</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> implMethodName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> implMethodSignature</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD">  int</span><span style="color:#E06C75"> implMethodKind</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> instantiatedMethodType</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B">  Object</span><span style="color:#E06C75">[] capturedArgs</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getCapturingClass</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> capturingClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">replace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">'.'</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">'/'</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getFunctionalInterfaceClass</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> functionalInterfaceClass;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getFunctionalInterfaceMethodName</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> functionalInterfaceMethodName;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getFunctionalInterfaceMethodSignature</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> functionalInterfaceMethodSignature;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getImplClass</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> implClass;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getImplMethodName</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> implMethodName;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getImplMethodSignature</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> implMethodSignature;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> getImplMethodKind</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> implMethodKind;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getInstantiatedMethodType</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> instantiatedMethodType;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> getCapturedArgCount</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> capturedArgs</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getCapturedArg</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> i</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> capturedArgs[i];</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后就是一个简单的测试类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testCreateSerializedLambdaByAnotherWay</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> function </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    indi</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">mofan</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#E06C75"> serializedLambda </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> getSerializedLambda</span><span style="color:#E06C75">(function)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"getName"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">serializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getImplMethodName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> indi</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">mofan</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#61AFEF"> getSerializedLambda</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Serializable</span><span style="color:#E06C75"> serializable) throws Exception {</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">ByteArrayOutputStream</span><span style="color:#E06C75"> baos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ByteArrayOutputStream</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">         ObjectOutputStream</span><span style="color:#E06C75"> oos </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectOutputStream</span><span style="color:#E06C75">(baos)) {</span></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">writeObject</span><span style="color:#ABB2BF">(serializable);</span></span>
<span class="line"><span style="color:#E5C07B">        oos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">flush</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">ObjectInputStream</span><span style="color:#E06C75"> ois </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ObjectInputStream</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> ByteArrayInputStream</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">baos</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toByteArray</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 重写 resolveClass 方法，半路截胡，使反序列化返回的类型为 indi.mofan.lambda.SerializedLambda</span></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            protected</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> resolveClass</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ObjectStreamClass</span><span style="color:#E06C75;font-style:italic"> desc</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">klass</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> super</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">resolveClass</span><span style="color:#ABB2BF">(desc);</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> klass </span><span style="color:#56B6C2">==</span><span style="color:#E5C07B"> java</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lang</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">invoke</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#C678DD"> ?</span><span style="color:#E5C07B"> indi</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">mofan</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#C678DD"> :</span><span style="color:#ABB2BF"> klass;</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#E06C75">        }) {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">indi</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">mofan</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">lambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#E06C75">) </span><span style="color:#E5C07B">ois</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">readObject</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="3-3-隐藏的-deserializeLambda-方法"><a class="header-anchor" href="#3-3-隐藏的-deserializeLambda-方法"></a>3.3 隐藏的 $deserializeLambda$ 方法</h2>
<p>阅读 <code>SerializedLambda</code> 的顶部注释时知道这个类中有个 <code>readResolve()</code> 方法，它会调用“捕获类”中一个名为 <code>$deserializeLambda$(SerializedLambda)</code> 的静态方法。<code>readResolve()</code> 的源码如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> readResolve</span><span style="color:#E06C75">() throws ReflectiveOperationException {</span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Method</span><span style="color:#E06C75"> deserialize </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> AccessController</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">doPrivileged</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#E5C07B"> PrivilegedExceptionAction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Method</span><span style="color:#ABB2BF">&gt;() {</span></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#E5C07B"> Method</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                Method</span><span style="color:#E06C75"> m</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> capturingClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"$deserializeLambda$"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">                m</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAccessible</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> m;</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> deserialize</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">PrivilegedActionException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        Exception</span><span style="color:#E06C75"> cause </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getException</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (cause </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> ReflectiveOperationException)</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#E06C75"> (ReflectiveOperationException) cause</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (cause </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> RuntimeException)</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#E06C75"> (RuntimeException) cause</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        else</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> RuntimeException</span><span style="color:#E06C75">(</span><span style="color:#98C379">"Exception in SerializedLambda.readResolve"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> e)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>根据源码可知，是使用反射调用的 <code>$deserializeLambda$</code> 方法。</p>
<p>根据前文中获取的 <code>SerializedLambda</code> 实例可知，这里的“捕获类”是测试类 <code>indi.mofan.LambdaTest</code> 类，这个类中并没有定义名为 <code>$deserializeLambda$</code> 的方法，那这真的有吗？测试一下。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testGet$deserializeLambda$MethodInfo</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> function </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Method</span><span style="color:#E06C75"> writeReplaceMethod </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> function</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getDeclaredMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"writeReplace"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    writeReplaceMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAccessible</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    SerializedLambda</span><span style="color:#E06C75"> serializedLambda </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (SerializedLambda) </span><span style="color:#E5C07B">writeReplaceMethod</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(function);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 反射获取“捕获类”对应的 Class 对象</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> capturingClassName </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> serializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getCapturingClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">replace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"/"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"."</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">(), capturingClassName);</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> capturingClass </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forName</span><span style="color:#ABB2BF">(capturingClassName);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 调用 Spring 的方法</span></span>
<span class="line"><span style="color:#E5C07B">    ReflectionUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">doWithMethods</span><span style="color:#ABB2BF">(capturingClass, method </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"$deserializeLambda$"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"private static"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Modifier</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getModifiers</span><span style="color:#ABB2BF">()));</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getParameterCount</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">SerializedLambda</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getParameterTypes</span><span style="color:#ABB2BF">()[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getReturnType</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }, method </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> Objects</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">(), </span><span style="color:#98C379">"$deserializeLambda$"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>测试方法通过，在“捕获类”中还真存在一个名为 <code>$deserializeLambda$</code>、参数类型为 <code>SerializedLambda</code>、返回值类型为 <code>Object</code> 的私有静态方法。</p>
<blockquote>
<p>Spring 的 ReflectionUtils.doWithMethods 方法</p>
</blockquote>
<p><code>ReflectionUtils.doWithMethods()</code> 方法的参数与返回值如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> doWithMethods</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> clazz</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ReflectionUtils</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">MethodCallback</span><span style="color:#E06C75"> mc</span><span style="color:#ABB2BF">,</span><span style="color:#ABB2BF"> @</span><span style="color:#E5C07B">Nullable</span><span style="color:#E5C07B"> ReflectionUtils</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">MethodFilter</span><span style="color:#E06C75"> mf){</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 省略具体实现</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>doWithMethods()</code> 方法会遍历 <code>clazz</code> 中的所有方法，对这些方法按照过滤器 <code>mf</code> 进行筛选，过滤得到的方法都将回调 <code>mc</code>。</p>
<hr>
<p>到此，<code>SerializedLambda</code> 类和 <code>writeReplace()</code> 方法的作用都得到了解答，解决了两个最大的问题后并不意味着就结束了，其中依然存在着很多细节。比如：</p>
<ul>
<li>函数式接口对应的实现类是什么？</li>
<li><code>ReflectionUtil</code> 中缓存 <code>CACHE</code> 为什么要以 <code>SFunction</code> 作为 key，这有意义吗？</li>
<li><code>LambdaUtil.getSerializedLambda()</code> 中 <code>aClass.isSynthetic()</code> 是用来判断什么的？</li>
<li><code>ReflectionUtil.findField()</code> 中使用到的 <code>Introspector</code> 类是什么？</li>
<li>Debug 查看 <code>SerializedLambda</code> 对象的信息时，为什么许多信息都以 <code>/</code> 分割，而不是 <code>.</code>？</li>
<li><code>LambdaUtil.getSerializedLambda()</code> 中获取 <code>writeReplace</code> 的 <code>Method</code> 对象时为什么使用了 <code>getDeclaredMethod()</code> 方法，而不是 <code>getMethod()</code>？</li>
</ul>
<h1 id="4-其他细节补充"><a class="header-anchor" href="#4-其他细节补充"></a>4. 其他细节补充</h1>
<h2 id="4-1-函数式接口的实现类"><a class="header-anchor" href="#4-1-函数式接口的实现类"></a>4.1 函数式接口的实现类</h2>
<p>前文说到，程序中 Lambda 表达式或方法引用使用的函数式接口最终必定也是一个实现类的实例对象，那这实现类是什么样子的？有没有什么方式能看到？</p>
<p>还真有，在 Java8 中可以通过如下硬编码形式的属性配置将函数式接口动态生成的 class 文件保存到磁盘上：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"jdk.internal.lambda.dumpProxyClasses"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"."</span><span style="color:#ABB2BF">);</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>由于 Java9 引进的模块化，后续版本的 JDK 只能通过 JVM 参数指定：</p>
<figure class="highlight properties line-numbers" data-language="PROPERTIES">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic"># JDK 11 中指定的参数</span></span>
<span class="line"><span style="color:#98C379">-Djdk.internal.lambda.dumpProxyClasses</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># JDK 21 中指定的参数</span></span>
<span class="line"><span style="color:#98C379">-Djdk.invoke.LambdaMetafactory.dumpProxyClassFiles</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E6%98%BE%E7%A4%BA%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3%E7%94%9F%E6%88%90%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB.png" alt="显示函数式接口生成的实现类"></p>
<p>根据上方的图片可以看出， <strong>代码中多次编写的同一个方法引用会生成多个实现类，它们的实例对象也不会是同一个。</strong></p>
<p>在动态生成的 Class 中还可以看到 <code>writeReplace()</code> 方法：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E7%9A%84Class.png" alt="方法引用动态生成的Class"></p>
<p>既然一个方法创建一个实现类，实现类又对应不同的对象，那么 <code>ReflectionUtil</code> 中将 <code>SFunction</code> 作为缓存的 key 还有意义吗？</p>
<p>答案是肯定的。因为 <strong>同一方法中 <mark>定义</mark> 的 Lambda 表达式或方法引用只会动态创建一次实现类并只实例化一次，</strong> 而被多次调用时就可以利用缓存提供性能。</p>
<p>或许还不明白，那么请看：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testCallSFunction</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> function1 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> function2 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertNotSame</span><span style="color:#ABB2BF">(function1, function2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> list </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 3</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i</span><span style="color:#ABB2BF">++</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        SFunction</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> function </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> Person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(function);</span></span>
<span class="line"><span style="color:#E5C07B">        list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(function);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertSame</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">), </span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertSame</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">), </span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertSame</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">), </span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>或许你以为上述代码将创建 5 个实现类，其实只会创建 3 个。<code>for</code> 循环中的定义的方法引用只会创建 1 个实现类，而不是 3 个，因为它只被定义了一次。这种情况下，不就可以走缓存了吗？</p>
<p>那缓存又为什么不以 <code>SFunction</code> 的 <code>Class</code> 为 key，还要以这种让人疑惑的 <code>SFunction</code> 实例对象为 key 呢？</p>
<p>已经知道无论方法被调用多少次，方法内的方法引用对象始终是同一个，如果采用其 <code>Class</code> 做为缓存 key，每次查询缓存时都需要调用 <code>native</code> 方法<code>getClass()</code>获取其 <code>Class</code>，而这也是一种资源损耗。</p>
<h2 id="4-2-synthetic-class"><a class="header-anchor" href="#4-2-synthetic-class"></a>4.2 synthetic class</h2>
<p>在 <code>Class</code> 类中有这样一个私有常量和方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">&gt;</span><span style="color:#C678DD"> implements</span><span style="color:#E06C75"> java.io.</span><span style="color:#E5C07B">Serializable</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                                GenericDeclaration</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                                Type</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                                AnnotatedElement</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> SYNTHETIC </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0x00001000</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isSynthetic</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> (</span><span style="color:#61AFEF">getModifiers</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">&amp;</span><span style="color:#ABB2BF"> SYNTHETIC) </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>isSynthetic()</code> 用于判断一个 Class 是否是合成的 Class。那什么是合成的 Class？</p>
<p>非基本类型，即复合类型（引用类型）就是合成的 Class？非也。</p>
<p>合成的 Class 是指 <strong>由 JVM 生成，并且在源代码中没有符合的结构将被标记为合成的。不包括默认构造器、类初始化方法（<code>&lt;init&gt;()</code>）、枚举的 values 和 valueOf 方法。</strong></p>
<p>我们已经知道 Lambda 表达式或方法引用在程序运行时会动态生成的 Class，这些 Class 就是合成的。</p>
<p>既然都是合成的，那为什么还要使用 <code>isSynthetic()</code> 进行判断呢？</p>
<p>在 Java8 版本以前，还没有 Lambda 表达式时，经常用匿名内部类代替 Lambda，为了排除这种情况，就需要使用 <code>isSynthetic()</code> 进行判断。比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/6/7 17:37</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> SSupplier</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">&gt;</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Supplier</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">T</span><span style="color:#ABB2BF">&gt;,</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testGetImplClass</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Person</span><span style="color:#E06C75"> person </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Person</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    SSupplier</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> consumer </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> person</span><span style="color:#C678DD">::</span><span style="color:#E06C75">getName</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"indi.mofan.domain.Person"</span><span style="color:#ABB2BF">, </span><span style="color:#61AFEF">getImplClass</span><span style="color:#ABB2BF">(consumer));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    SSupplier</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> supplier </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> SSupplier</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> get</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E5C07B"> person</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 空字符串</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">getImplClass</span><span style="color:#ABB2BF">(supplier).</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="4-3-Introspector"><a class="header-anchor" href="#4-3-Introspector"></a>4.3 Introspector</h2>
<p><code>Introspector</code> 是 <code>java.beans</code> 包下的一个类，它为目标 JavaBean 提供了一种了解原类方法、属性和事件等信息的标准方法。简单来说，可以通过 <code>Introspector</code> 构建一个 <code>BeanInfo</code> 对象，而这个 <code>BeanInfo</code> 对象中包含了目标 JavaBean 中的属性、方法和事件等描述信息，除了获取这些信息外，还可以使用这个 <code>BeanInfo</code> 对象对目标 JavaBean 对象进行相关操作。</p>
<blockquote>
<p>什么是 JavaBean？</p>
</blockquote>
<p>JavaBean 就是一种特殊的、可重用的 Java 类。</p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/jsp/jsp-javabean.html">菜鸟教程关于 JavaBean</a> 是这么描述的：</p>
<p>JavaBean 是特殊的 Java 类，使用 Java 语言书写，并且遵守 JavaBean API 规范。JavaBean 与其它 Java 类相比而言独一无二的特征：</p>
<ul>
<li>提供一个默认的无参构造函数。</li>
<li>需要被序列化并且实现了 Serializable 接口。</li>
<li>可能有一系列可读写属性。</li>
<li>可能有一系列的 getter 或 <strong>setter</strong> 方法。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/JavaBean/529577">百度百科关于 JavaBean</a> 是这么描述的：</p>
<p>JavaBean 是一种 Java 语言写成的可重用组件。为写成 JavaBean，类必须是具体的和公共的，并且具有无参数的构造器。JavaBean  通过提供符合一致性设计模式的公共方法将内部域暴露成员属性，set 和 get 方法获取。众所周知，属性名称符合这种模式，其他 Java 类可以通过自省机制（反射机制）发现和操作这些 JavaBean 的属性。</p>
<p>JavaBean 是一种可重用的 Java 组件，它可以被 Applet、Servlet、JSP 等 Java 应用程序调用．也可以可视化地被 Java 开发工具使用。它包含属性（Properties）、方法（Methods）、事件（Events）等特性。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JavaBeans">维基百科关于 JavaBean</a> 是这么说的：</p>
<p>JavaBeans 是 Java 中一种特殊的类，可以将多个对象封装到一个对象（bean）中。特点是可序列化，提供 public 无参构造器，提供 getter 方法和 setter 方法访问对象的属性。名称中的“Bean”是用于 Java 的可重用软件组件的惯用叫法。</p>
<p>比如，下述的 <code>Person</code> 就是一个 JavaBean：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/3/29 12:24</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Person</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Serializable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> long</span><span style="color:#E06C75"> serialVersionUID </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 8597585718927776100L</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getName</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> name;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> name;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getAge</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> age;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setAge</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> age</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">age</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> age;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>简单的使用</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testIntrospector</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取整个 bean 信息</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">//  BeanInfo personBeanInfo = Introspector.getBeanInfo(Person.class);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 检索到 Object 时停止，可以检索到 JavaBean 的任意父类时停止</span></span>
<span class="line"><span style="color:#E5C07B">    BeanInfo</span><span style="color:#E06C75"> beanInfo </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Introspector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanInfo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Object</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取属性信息</span></span>
<span class="line"><span style="color:#E5C07B">    PropertyDescriptor</span><span style="color:#E06C75">[] propertyDescriptors </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanInfo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPropertyDescriptors</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> beanFieldInfo </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(propertyDescriptors).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(PropertyDescriptor</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName)</span></span>
<span class="line"><span style="color:#ABB2BF">        .</span><span style="color:#61AFEF">collect</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collectors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toList</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> classFieldInfo </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredFields</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Field</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">collect</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collectors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toList</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">classFieldInfo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">containsAll</span><span style="color:#ABB2BF">(beanFieldInfo));</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">beanFieldInfo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 bean 中 public 的方法</span></span>
<span class="line"><span style="color:#E5C07B">    MethodDescriptor</span><span style="color:#E06C75">[] methodInfo </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanInfo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethodDescriptors</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">4</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">methodInfo</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取属性的值</span></span>
<span class="line"><span style="color:#E5C07B">    Person</span><span style="color:#E06C75"> person </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Person</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    person</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> propertyName </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "name"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    PropertyDescriptor</span><span style="color:#E06C75"> nameProperty </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> PropertyDescriptor</span><span style="color:#E06C75">(propertyName</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">nameProperty</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getReadMethod</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(person));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 修改属性的值</span></span>
<span class="line"><span style="color:#E5C07B">    nameProperty</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getWriteMethod</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(person, </span><span style="color:#98C379">"TestName"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"TestName"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">nameProperty</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getReadMethod</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(person));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 原对象也有影响</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"TestName"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">person</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>通常会使用以下两种方式获取 <code>BeanInfo</code> 对象：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> BeanInfo</span><span style="color:#61AFEF"> getBeanInfo</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass) throws </span><span style="color:#E5C07B">IntrospectionException</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> BeanInfo</span><span style="color:#61AFEF"> getBeanInfo</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> stopClass) throws </span><span style="color:#E5C07B">IntrospectionException</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>更建议使用第二种方式来获取 <code>BeanInfo</code> 对象。采用这种方式，将检索到 stopClass 时停止。比如将 stopClass 设置为 <code>Object.class</code>，这样的话可以规避 <code>Object</code> 类中的信息，进而得到更加纯净的目标 JavaBean 信息。</p>
<p>比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testGetAllBeanInfo</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    BeanInfo</span><span style="color:#E06C75"> beanInfo </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Introspector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanInfo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取所有属性</span></span>
<span class="line"><span style="color:#E5C07B">    PropertyDescriptor</span><span style="color:#E06C75">[] propertyDescriptors </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanInfo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPropertyDescriptors</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">3</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">propertyDescriptors</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>Person</code> 中明明只有 <code>name</code> 和 <code>age</code> 两个成员变量，为什么获取到的属性数量是 3 呢？Debug 一下：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84class%E5%B1%9E%E6%80%A7.png" alt="获取到的class属性"></p>
<p>居然有一个 name 为 <code>class</code> 的属性，这是为什么？<code>Person</code> 类中没有，<code>Object</code> 类中也没有，它是哪来的？</p>
<p>要解决这个问题就得说说 Java 类中成员变量 Fields 和属性 Properties 的区别了。</p>
<blockquote>
<p>Java 类中成员变量 Fields 和属性 Properties 的区别</p>
</blockquote>
<p>或许你认为这两个表示同一个意思，其实并不是，以 <code>Person</code> 为例：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/Person%E7%9A%84Fields%E5%92%8CProperties.png" alt="Person的Fields和Properties"></p>
<p>成员变量 Fields 很好理解，就是：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>但属性 Properties 就不是这样了，它指的是 getter/setter 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getName</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setName</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> name) {</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getAge</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> setAge</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> age) {</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">age</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> age</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>使用 IDEA 对类结构进行显示时，在左侧也能清晰地显示成员变量和属性的区别。</p>
<p><strong>属性 Properties 的官方定义：属性是指 get 或者 set 方法名去掉 get 或者 set 后，把剩余的部分首字母改为小写后，即为这个类的属性。</strong> 比如，<code>getName</code> 转换为 <code>name</code>，<code>getname</code> 转换为 <code>name</code>，<code>getURL</code> 转换为 <code>URL</code>。</p>
<p>在 <code>Object</code> 类中有名为 <code>getClass()</code>，因此 <code>class</code> 也是一个属性。正因如此，更推荐使用以下方式获取 <code>BeanInfo</code> 以得到纯净的 JavaBean 信息：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> BeanInfo</span><span style="color:#61AFEF"> getBeanInfo</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> beanClass</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> stopClass) throws </span><span style="color:#E5C07B">IntrospectionException</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>Fields 和 Properties 一般来说时相等的，但也时常会存在不相等的情况，针对这些情况，常用反射来获取 Fields，使用 Introspector 来获取 Properties。比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testGetFieldsAndProperties</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 Fields</span></span>
<span class="line"><span style="color:#E5C07B">    Field</span><span style="color:#E06C75">[] fields </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredFields</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 Properties</span></span>
<span class="line"><span style="color:#E5C07B">    BeanInfo</span><span style="color:#E06C75"> beanInfo </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Introspector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanInfo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Object</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    PropertyDescriptor</span><span style="color:#E06C75">[] properties </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanInfo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPropertyDescriptors</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>还需要注意，由于在 <code>Person</code> 中定义了 <code>serialVersionUID</code>，这也是一个 Field：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E5%90%8D%E4%B8%BAserialVersionUID%E7%9A%84Field.png" alt="名为serialVersionUID的Field"></p>
<blockquote>
<p>内省 Introspector 和反射 Reflection 的区别</p>
</blockquote>
<p>内省 Introspector 和反射 Reflection 很相似，就连使用方法也是如此，Introspector 更多的使用方法自行探索，在此梳理下它们两者的区别。</p>
<p>反射是在运行时获取类的所有信息，包括成员变量、成员方法、构造器等，并且还可以操纵修改对象的字段值、方法、构造器等内容。反射可以理解为类“照镜子”后得到的信息，就像我们现实中照镜子一样，类“照镜子”后得到的信息 <strong>必定是正确的。</strong></p>
<p>内省基于反射实现，常用于操作 <code>JavaBean</code>，基于 <code>JavaBean</code> 的规范对 Bean 信息进行解析，依据于类的 <code>Getter</code> 和 <code>Setter</code> 方法，获取到类的描述符。可以理解为“类的反省”，也和现实中的反省一样，“类的反省”不一定是正确的。如果一个类中的属性没有<code>Setter</code>和<code>Getter</code>方法，无法使用内省。</p>
<blockquote>
<p>可能导致的内存溢出</p>
</blockquote>
<p>如果框架或者程序用到了 <code>Introspector</code>，就相当于启用了一个系统级别的缓存，这个缓存会存放一些曾加载并分析过的 JavaBean 的引用。当 Web 服务器关闭时，由于这个缓存中存放着的 JavaBean 的引用，所以垃圾回收器不能对 Web 容器中的 JavaBean 对象进行回收，导致内存越来越大。</p>
<p>清除 <code>Introspector</code> 缓存的唯一方式是刷新整个缓存缓冲区，这是因为 JDK 没法判断哪些是属于当前的应用的引用，而刷新整个 <code>Introspector</code> 缓存缓冲区又会导致把服务器上所有应用的 <code>Introspector</code> 缓存都删掉。对此 Spring 提供了 <code>org.springframework.web.util.IntrospectorCleanupListener</code> 来解决这个问题，当某个 Web 服务器停止时，就会清理这个服务器下的 <code>Introspector</code> 缓存，使那些 JavaBean 能被垃圾回收器正确回收。</p>
<p>也就是说 JDK 的 Introspector 缓存管理是有一定缺陷的。但如果在 Spring 体系中使用则不会出现这种问题，在 Spring 体系下 <code>Introspector</code> 缓存的管理移交给了 Spring 自身而不是 JDK（或者在 Web 容器销毁后完全不管）。</p>
<p>在 Spring 体系中，为了防止 JDK 对 <code>Introspector</code> 的缓存无法被垃圾回收机制回收导致内存溢出，主要的操作除了可以通过配置 <code>IntrospectorCleanupListener</code> 预防外，还可以通过 <code>CachedIntrospectionResults</code> 类自行管理 <code>Introspector</code> 中的缓存（这种方式才是优雅的方式，这可以避免刷新整个 <code>Introspector</code> 的缓存缓冲区而导致其他应用的 <code>Introspector</code> 也被清空）。</p>
<p>在 SpringBoot 刷新上下文的方法 <code>AbstractApplicationContext#refresh()</code> 中的 <code>finally</code> 代码块中 <code>AbstractApplicationContext#resetCommonCaches();</code> 方法里调用到的 <code>CachedIntrospectionResults#clearClassLoader(getClassLoader())</code> 方法就是清理指定的 <code>ClassLoader</code> 下的所有 <code>Introspector</code> 中的缓存的引用。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/AbstractApplicationContext%E4%B8%AD%E7%9A%84resetCommonCaches%E6%96%B9%E6%B3%95.png" alt="AbstractApplicationContext中的resetCommonCaches方法"></p>
<p><code>resetCommonCaches()</code> 方法的源码如下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> resetCommonCaches</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    ReflectionUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clearCache</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    AnnotationUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clearCache</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    ResolvableType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clearCache</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 清除指定 ClassLoader 下所有 Introspector 的缓存的引用</span></span>
<span class="line"><span style="color:#E5C07B">    CachedIntrospectionResults</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clearClassLoader</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassLoader</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="4-4-Java-描述符"><a class="header-anchor" href="#4-4-Java-描述符"></a>4.4 Java 描述符</h2>
<p>当我们 Debug 查看 <code>SerializedLambda</code> 对象的信息时，许多信息都以 <code>/</code> 分割，而不是印象中的 <code>.</code>。比如：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/%E4%B8%8D%E5%90%8CSerializedLambda%E5%AE%9E%E4%BE%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB.png" alt="不同SerializedLambda实例之间的区别"></p>
<p>具体原因总结下来就四个字：历史原因。重点是看一下它的规则是怎么样的。</p>
<blockquote>
<p>类型描述符</p>
</blockquote>
<p>Java 中的类型分为基本类型和引用类型，基本类型的描述符是单个字母，具体内容可以查看 <code>sun.invoke.util.Wrapper</code> 中的内容：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JavaImages/sun.invoke.util.Wrapper%E6%9E%9A%E4%B8%BE%E9%A1%B9.png" alt="sun.invoke.util.Wrapper枚举项"></p>
<p>根据上图所示，<code>boolean</code> 的类型描述符是 <code>Z</code>，<code>byte</code> 的类型描述符是 <code>B</code>，针对基本类型，可以得到如下对照表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">基本类型</th>
<th style="text-align:center">类型描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">boolean</td>
<td style="text-align:center">Z</td>
</tr>
<tr>
<td style="text-align:center">byte</td>
<td style="text-align:center">B</td>
</tr>
<tr>
<td style="text-align:center">short</td>
<td style="text-align:center">S</td>
</tr>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">C</td>
</tr>
<tr>
<td style="text-align:center">int</td>
<td style="text-align:center">I</td>
</tr>
<tr>
<td style="text-align:center">long</td>
<td style="text-align:center">J</td>
</tr>
<tr>
<td style="text-align:center">float</td>
<td style="text-align:center">F</td>
</tr>
<tr>
<td style="text-align:center">double</td>
<td style="text-align:center">D</td>
</tr>
<tr>
<td style="text-align:center">void</td>
<td style="text-align:center">V</td>
</tr>
</tbody>
</table>
<p><mark>注意：</mark> <code>java.lang.Object</code> 的类型描述符并不是 <code>L</code>，而是 <code>Ljava/lang/Object;</code>。</p>
<p>基本类型有了，再来看看引用类型。引用类型的类型描述符格式是以 <code>L</code> 开头，紧跟上以 <code>/</code> 分割的类全限定名，最后以 <code>;</code> 结尾，就像前面说的 <code>java.lang.Object</code> 的类型描述符一样。一个数组类型的描述符是一个 <code>[</code> 后跟上该数组元素类型的描述符，并且是几维数组，就有几个 <code>[</code> 在开头。针对引用类型，可以得到如下对照参考表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">基本类型</th>
<th style="text-align:center">类型描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Object</td>
<td style="text-align:center">Ljava/lang/Object;</td>
</tr>
<tr>
<td style="text-align:center">int[]</td>
<td style="text-align:center">[I</td>
</tr>
<tr>
<td style="text-align:center">Object[][]</td>
<td style="text-align:center">[[Ljava/lang/Object;</td>
</tr>
<tr>
<td style="text-align:center">String</td>
<td style="text-align:center">Ljava/lang/String;</td>
</tr>
</tbody>
</table>
<blockquote>
<p>方法描述符</p>
</blockquote>
<p>方法描述符的格式为：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>(参数类型描述符们)返回值类型描述符</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>如果有多个参数，按照参数列表依次写出它们的类型描述符即可，之间也不需要任何分隔符。比如：</p>
<table>
<thead>
<tr>
<th style="text-align:center">方法的声明</th>
<th style="text-align:center">方法描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">void m(int i, float f)</td>
<td style="text-align:center">(IF)V</td>
</tr>
<tr>
<td style="text-align:center">int m(Object o)</td>
<td style="text-align:center">(Ljava/lang/Object;)I</td>
</tr>
<tr>
<td style="text-align:center">int[] m(int i,String s)</td>
<td style="text-align:center">(ILjava/lang/String;)[I</td>
</tr>
<tr>
<td style="text-align:center">Object m(int[] i)</td>
<td style="text-align:center">([I)Ljava/lang/Object;</td>
</tr>
</tbody>
</table>
<blockquote>
<p>获取描述符信息</p>
</blockquote>
<p>要获取描述符信息，可以使用 <code>ASM</code> 中的方法，首先导入依赖：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#56B6C2">&gt;</span></span>
<span class="line"><span style="color:#56B6C2">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B">org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">ow2</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">asm</span><span style="color:#56B6C2">&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#56B6C2">&gt;</span></span>
<span class="line"><span style="color:#56B6C2">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">asm</span><span style="color:#56B6C2">&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#56B6C2">&gt;</span></span>
<span class="line"><span style="color:#56B6C2">    &lt;</span><span style="color:#E06C75">version</span><span style="color:#56B6C2">&gt;</span><span style="color:#D19A66">9.3</span><span style="color:#56B6C2">&lt;/</span><span style="color:#E06C75">version</span><span style="color:#56B6C2">&gt;</span></span>
<span class="line"><span style="color:#56B6C2">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#56B6C2">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>简单测试一下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testGetModifierInfo</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"java/lang/String"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getInternalName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"java/util/Map"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getInternalName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Map</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Ljava/lang/String;"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDescriptor</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"I"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">INT_TYPE</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDescriptor</span><span style="color:#ABB2BF">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Method</span><span style="color:#E06C75"> setNameMethod </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Person</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"setName"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"(Ljava/lang/String;)V"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethodDescriptor</span><span style="color:#ABB2BF">(setNameMethod));</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="4-5-Declared-修饰的方法"><a class="header-anchor" href="#4-5-Declared-修饰的方法"></a>4.5 Declared 修饰的方法</h2>
<p>在 <code>LambdaUtil.getSerializedLambda()</code> 方法中使用了 <code>getDeclaredMethod()</code> 方法，而不是 <code>getMethod()</code> 方法，并且查看 <code>Class</code> 类中的方法，发现有很多类似这样的一组方法，一个被 Declared 修饰，而另一个又没被修饰。那么它们之间有什么区别呢？</p>
<p>通过一个测试类来讲解他们之间的关系。先定义一个父类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/4 18:15</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Parent</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> privateParentField</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> publicParentField</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后定义一个接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/4 18:17</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> SimpleInterface</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * 接口中的变量都是常量</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     */</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> CONSTANT </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "constant"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#61AFEF"> add</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> a</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> b</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再定义一个子类，这个子类继承父类并实现接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2022/7/4 18:16</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Child</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Parent</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> SimpleInterface</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> privateChildField</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> publicChildField</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> add</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> a</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> b</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> a </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> b;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后利用子类和父类的 Class 进行测试：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Test</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> testDeclared</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Parent</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> parentClass </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Parent</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Child</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> childClass </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Child</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类及其父类中所有 public 的字段</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFields</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFields</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">allMatch</span><span style="color:#ABB2BF">(i </span><span style="color:#C678DD">-&gt;</span><span style="color:#98C379"> "publicParentField"</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">i</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">())));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类中所有的字段</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> parentFieldNameList </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"privateParentField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"publicParentField"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentFieldNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredFields</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredFields</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Field</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">allMatch</span><span style="color:#ABB2BF">(parentFieldNameList</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">contains));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类及其父类中所有 public 的字段</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> childPublicFieldNameList </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"publicChildField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"publicParentField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"CONSTANT"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childPublicFieldNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFields</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFields</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Field</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">allMatch</span><span style="color:#ABB2BF">(childPublicFieldNameList</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">contains));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类中所有的字段（实现的接口中的常量不在其中）</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> childFiledNameList </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"privateChildField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"publicChildField"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childFiledNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredFields</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredFields</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Field</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">allMatch</span><span style="color:#ABB2BF">(childFiledNameList</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">contains));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类及其父类中所有 public 的方法（因此包含 Object 类中 public 的方法）</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> parentPublicMethodNameList </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"setPrivateParentField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"getPublicParentField"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">            "getPrivateParentField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"setPublicParentField"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> &gt;</span><span style="color:#D19A66"> 4</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> +</span><span style="color:#D19A66"> 4</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Method</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">collect</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collectors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toList</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">containsAll</span><span style="color:#ABB2BF">(parentPublicMethodNameList));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类中所有的方法</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentPublicMethodNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethods</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Method</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">allMatch</span><span style="color:#ABB2BF">(parentPublicMethodNameList</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">contains));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类及其父类中所有 public 的方法</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> childPublicMethodNameList </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"add"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"setPublicChildField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"getPublicChildField"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">            "setPrivateChildField"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"getPrivateChildField"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> &gt;</span><span style="color:#E5C07B"> childPublicMethodNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">parentClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> childPublicMethodNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Method</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">collect</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collectors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toList</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">containsAll</span><span style="color:#ABB2BF">(childPublicMethodNameList));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当前类中所有的方法</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertEquals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childPublicMethodNameList</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">size</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethods</span><span style="color:#ABB2BF">().</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">assertTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">childClass</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethods</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">(Method</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">getName).</span><span style="color:#61AFEF">allMatch</span><span style="color:#ABB2BF">(childPublicMethodNameList</span><span style="color:#C678DD">::</span><span style="color:#ABB2BF">contains));</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>上述测试方法能够通过，对此不难得出：</p>
<p>1、<code>getFields()</code> 方法可以获取当前类及其父类中所有 <code>public</code> 的成员变量；<code>getDeclaredFields()</code> 方法可以获取当前类中所有的成员变量。</p>
<p>2、<code>getMethods()</code> 方法可以获取当前类及其父类中所有 <code>public</code> 的方法；<code>getDeclaredMethods()</code> 方法可以获取当前类中所有的方法。</p>
<h1 id="5-结语"><a class="header-anchor" href="#5-结语"></a>5. 结语</h1>
<p>以上就是《Lambda 与序列化》一文中的全部内容，本文不仅仅讲述了如何通过 Java8 的方法引用来获取字段名称，还围绕着具体实现进行展开，介绍了 Java 的序列化、Lambda 表达式的序列化以及具体实现中的其他细节。</p>
<p>最近这一个多月工作都比较忙，经常加班，就连周六都不例外，因此本文从构思到最终完成竟然用了足足一个月，但幸运的是过程中学到了很多不曾了解的知识点，也算是收获颇多。依我看来，这篇文章或许能成为我今年的代表作，当然也希望在今年剩下的几个月中能写出深度、广度跟本文一样，甚至超越本文的篇章。</p>
<p>最后向本文所有参考文章的作者致以诚挚的谢意。</p>
</body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Lambda-And-Serialization/">https://mofan212.github.io/posts/Lambda-And-Serialization/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java-Lambda/">Java-Lambda</a><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/104.png" data-sites="wechat,qq,weibo,facebook,x"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Java 的类资源加载</div></div><div class="info-2"><div class="info-item-1">本文以 Mockito 中静态方法的 mock 为引，介绍了 SPI 机制的应用与源码剖析。</div></div></div></a><a class="pagination-related" href="/posts/DQL-Of-MySQL/" title="【MySQL 一】DQL"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/105.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">【MySQL 一】DQL</div></div><div class="info-2"><div class="info-item-1">本文介绍了 MySQL 中查询语句的用法与示例，包括多表查询、单行函数、聚合函数、子查询等内容。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/Method-Handle/" title="方法句柄"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/142.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="info-item-2">方法句柄</div></div><div class="info-2"><div class="info-item-1">Java 中 MethodHandle 的使用。</div></div></div></a><a class="pagination-related" href="/posts/Combinator-Pattern/" title="Combinator Pattern"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/149.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-28</div><div class="info-item-2">Combinator Pattern</div></div><div class="info-2"><div class="info-item-1">本文介绍了如何在 Java 中使用 Combinator Pattern。</div></div></div></a><a class="pagination-related" href="/posts/Java-Lambda-Expression-And-Functional-Programming/" title="Lambda 表达式与函数式编程"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/152.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-20</div><div class="info-item-2">Lambda 表达式与函数式编程</div></div><div class="info-2"><div class="info-item-1">本文介绍了 Java 中的闭包与柯里化，浅谈 Lambda 表达式的执行原理。</div></div></div></a><a class="pagination-related" href="/posts/Using-Java-To-Manipulate-Excel/" title="使用 Java 操作 Excel"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/80.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-24</div><div class="info-item-2">使用 Java 操作 Excel</div></div><div class="info-2"><div class="info-item-1">本文介绍了如何使用 Java 来操作 Excel 以实现数据的读取与报表的导出。</div></div></div></a><a class="pagination-related" href="/posts/Java-IO-Stream/" title="Java IO 流基础"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/59.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-13</div><div class="info-item-2">Java IO 流基础</div></div><div class="info-2"><div class="info-item-1">本文介绍了 Java 中的 IO 流基础知识。</div></div></div></a><a class="pagination-related" href="/posts/Design-Pattern-Builder-Pattern/" title="【设计模式】建造者模式"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/81.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-03</div><div class="info-item-2">【设计模式】建造者模式</div></div><div class="info-2"><div class="info-item-1">本文主要对 Java 设计模式中的建造者模式进行了介绍，同时也介绍了 Lombok 中 @Builder 注解的使用。</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a href="./mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0. 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E9%80%9A%E8%BF%87%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8%E8%8E%B7%E5%8F%96%E5%AD%97%E6%AE%B5%E5%90%8D%E7%A7%B0"><span class="toc-text">1. 通过方法引用获取字段名称</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.1 具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E9%97%AE%E9%A2%98%E7%9A%84%E6%8A%9B%E5%87%BA"><span class="toc-text">1.2 问题的抛出</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Java-%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">2. Java 的序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">2.1 什么是序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Java-%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">2.2 Java 序列化的细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="toc-text">2.3 序列化的简单示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%BC%95%E7%94%A8%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">2.4 引用对象的序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%BA%A6%E6%9D%9F"><span class="toc-text">2.5 序列化的约束</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-readObjectNoData-%E6%96%B9%E6%B3%95"><span class="toc-text">2.6 readObjectNoData 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E9%9A%90%E8%97%8F%E6%96%B9%E6%B3%95-writeReplace"><span class="toc-text">2.7 隐藏方法 - writeReplace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-%E9%9A%90%E8%97%8F%E6%96%B9%E6%B3%95-readResolve"><span class="toc-text">2.8 隐藏方法 - readResolve</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-Externalizable-%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.9 Externalizable 接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-10-%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-text">2.10 序列化的版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-11-serialPersistentFields"><span class="toc-text">2.11 serialPersistentFields</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">3. Lambda 表达式的序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-LambdaMetafactory"><span class="toc-text">3.1 LambdaMetafactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-SerializedLambda"><span class="toc-text">3.2 SerializedLambda</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E9%9A%90%E8%97%8F%E7%9A%84-deserializeLambda-%E6%96%B9%E6%B3%95"><span class="toc-text">3.3 隐藏的 $deserializeLambda$ 方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%85%B6%E4%BB%96%E7%BB%86%E8%8A%82%E8%A1%A5%E5%85%85"><span class="toc-text">4. 其他细节补充</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-text">4.1 函数式接口的实现类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-synthetic-class"><span class="toc-text">4.2 synthetic class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-Introspector"><span class="toc-text">4.3 Introspector</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Java-%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-text">4.4 Java 描述符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-Declared-%E4%BF%AE%E9%A5%B0%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">4.5 Declared 修饰的方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%BB%93%E8%AF%AD"><span class="toc-text">5. 结语</span></a></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>Java Lambda Expression</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Lambda-And-Serialization/" title="Lambda 与序列化"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/104.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Lambda 与序列化"></a><div class="content"><a class="title" href="/posts/Lambda-And-Serialization/" title="Lambda 与序列化">Lambda 与序列化</a><time datetime="2022-07-03T16:00:00.000Z" title="发表于 2022-07-04 00:00:00">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Reduce-Functions/" title="Reduce Functions"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/137.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Reduce Functions"></a><div class="content"><a class="title" href="/posts/Reduce-Functions/" title="Reduce Functions">Reduce Functions</a><time datetime="2023-08-26T16:00:00.000Z" title="发表于 2023-08-27 00:00:00">2023-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Method-Handle/" title="方法句柄"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/142.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="方法句柄"></a><div class="content"><a class="title" href="/posts/Method-Handle/" title="方法句柄">方法句柄</a><time datetime="2023-10-28T16:00:00.000Z" title="发表于 2023-10-29 00:00:00">2023-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Using-Lambda-Expressions-To-Refactor-Backtracking/" title="使用 Lambda 表达式重构成回溯"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/143.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="使用 Lambda 表达式重构成回溯"></a><div class="content"><a class="title" href="/posts/Using-Lambda-Expressions-To-Refactor-Backtracking/" title="使用 Lambda 表达式重构成回溯">使用 Lambda 表达式重构成回溯</a><time datetime="2023-11-11T16:00:00.000Z" title="发表于 2023-11-12 00:00:00">2023-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Lambda-Expression-And-Functional-Programming/" title="Lambda 表达式与函数式编程"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/152.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Lambda 表达式与函数式编程"></a><div class="content"><a class="title" href="/posts/Java-Lambda-Expression-And-Functional-Programming/" title="Lambda 表达式与函数式编程">Lambda 表达式与函数式编程</a><time datetime="2024-07-19T16:00:00.000Z" title="发表于 2024-07-20 00:00:00">2024-07-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Lambda-In-Action/" title="Java Lambda In Action"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/159.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java Lambda In Action"></a><div class="content"><a class="title" href="/posts/Java-Lambda-In-Action/" title="Java Lambda In Action">Java Lambda In Action</a><time datetime="2025-03-18T16:00:00.000Z" title="发表于 2025-03-19 00:00:00">2025-03-19</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Git/" title="Git理论与使用"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/3.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Git理论与使用"/></a><div class="content"><a class="title" href="/posts/Git/" title="Git理论与使用">Git理论与使用</a><time datetime="2026-01-26T16:00:00.000Z" title="更新于 2026-01-27 00:00:00">2026-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Something-About-Blog/" title="博客搭建与维护"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/42.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="博客搭建与维护"/></a><div class="content"><a class="title" href="/posts/Something-About-Blog/" title="博客搭建与维护">博客搭建与维护</a><time datetime="2026-01-24T16:00:00.000Z" title="更新于 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 内存模型"/></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java 内存模型">Java 内存模型</a><time datetime="2026-01-02T16:00:00.000Z" title="更新于 2026-01-03 00:00:00">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="字节码与类加载"/></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载">字节码与类加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 的类资源加载"/></a><div class="content"><a class="title" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载">Java 的类资源加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/20.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="注解、类的加载、反射"/></a><div class="content"><a class="title" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射">注解、类的加载、反射</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By 默烦</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.4</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://testingcf.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://gcore.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script src="/js/tip_portal.js"></script><script defer="defer" id="ribbon" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://testingcf.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>