<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LangChain4j 快速入门 | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content=".highlight-tools {         background: #262931 !important;       }          封面来源：由博主个人绘制，如需使用请联系博主。 参考链接：尚硅谷 LangChain4j 实战 LangChain4J 官网：LangChain4j 源码仓库：mofan212&#x2F;langchain4j-demo 1. 开工前">
<meta property="og:type" content="article">
<meta property="og:title" content="LangChain4j 快速入门">
<meta property="og:url" content="https://mofan212.github.io/posts/Quick-Start-With-LangChain4j/">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content=".highlight-tools {         background: #262931 !important;       }          封面来源：由博主个人绘制，如需使用请联系博主。 参考链接：尚硅谷 LangChain4j 实战 LangChain4J 官网：LangChain4j 源码仓库：mofan212&#x2F;langchain4j-demo 1. 开工前">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/163.png">
<meta property="article:published_time" content="2025-07-20T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-20T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="LangChain4j">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/163.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LangChain4j 快速入门",
  "url": "https://mofan212.github.io/posts/Quick-Start-With-LangChain4j/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/163.png",
  "datePublished": "2025-07-20T16:00:00.000Z",
  "dateModified": "2025-07-20T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Quick-Start-With-LangChain4j/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://testingcf.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LangChain4j 快速入门',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css" /><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://testingcf.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">LangChain4j 快速入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-20T16:00:00.000Z" title="发表于 2025-07-21 00:00:00">2025-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-20T16:00:00.000Z" title="更新于 2025-07-21 00:00:00">2025-07-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/">AI</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/LangChain4j/">LangChain4j</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">14.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>57分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2025-07-21 00:00:00&quot;}" hidden></div>
    <style>
      .highlight-tools {
        background: #262931 !important;
      }
    </style>
    <html><head></head><body><p>封面来源：由博主个人绘制，如需使用请联系博主。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1mX3NzrEu6">尚硅谷 LangChain4j 实战</a></p>
<p>LangChain4J 官网：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/">LangChain4j</a></p>
<p>源码仓库：<a target="_blank" rel="noopener" href="https://github.com/mofan212/langchain4j-demo">mofan212/langchain4j-demo</a></p>
<h1 id="1-开工前的准备"><a class="header-anchor" href="#1-开工前的准备"></a>1. 开工前的准备</h1>
<h2 id="1-1-前置约定"><a class="header-anchor" href="#1-1-前置约定"></a>1.1 前置约定</h2>
<p><strong>以阿里百炼平台（通义千问）为主，并辅以 DeepSeek 模型。</strong></p>
<p><strong>涉及的所有调用均基于 OpenAI 协议标准或者 SpringBoot 官方推荐整合规则，</strong> 实现一致的接口设计与规范，确保多模型切换的便利性，提供高度可扩展的开发支持。</p>
<h2 id="1-2-三件套准备"><a class="header-anchor" href="#1-2-三件套准备"></a>1.2 三件套准备</h2>
<p>阿里百炼平台：<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/">大模型服务平台百炼控制台</a></p>
<p>三件套是什么？</p>
<ol>
<li>获得 API-KEY</li>
<li>获得模型名</li>
<li>获得 base_url 开发地址</li>
</ol>
<blockquote>
<p>获得 API-KEY</p>
</blockquote>
<p>登录控制台后，创建自己的 API-KEY：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84API-KEY.png" alt="创建自己的API-KEY"></p>
<blockquote>
<p>获得模型名</p>
</blockquote>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E9%80%89%E6%8B%A9%E9%9C%80%E8%A6%81%E7%9A%84%E6%A8%A1%E5%9E%8B%E5%B9%B6%E6%9F%A5%E7%9C%8B%E8%AF%A6%E6%83%85.png" alt="选择需要的模型并查看详情"></p>
<p>「模型名」是模型对应的 Code，而不是模型名称：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E6%A8%A1%E5%9E%8B%E5%90%8D%E6%98%AF%E6%A8%A1%E5%9E%8BCode.png" alt="模型名是模型Code"></p>
<blockquote>
<p>获得 base_url 开发地址</p>
</blockquote>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E6%9F%A5%E7%9C%8B%E9%98%BF%E9%87%8C%E4%BA%91%E7%99%BE%E7%82%BCAPI%E5%8F%82%E8%80%83.png" alt="查看阿里云百炼API参考"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E4%BD%BF%E7%94%A8SDK%E8%B0%83%E7%94%A8%E6%97%B6%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AE%E7%9A%84base_url.png" alt="使用SDK调用时需要配置的base_url"></p>
<h1 id="2-入门案例"><a class="header-anchor" href="#2-入门案例"></a>2. 入门案例</h1>
<h2 id="2-1-Hello-World"><a class="header-anchor" href="#2-1-Hello-World"></a>2.1 Hello World</h2>
<p>父工程内需要的配置与依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">properties</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">java.version</span><span style="color:#ABB2BF">&gt;21&lt;/</span><span style="color:#E06C75">java.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">maven.compiler.source</span><span style="color:#ABB2BF">&gt;21&lt;/</span><span style="color:#E06C75">maven.compiler.source</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">maven.compiler.target</span><span style="color:#ABB2BF">&gt;21&lt;/</span><span style="color:#E06C75">maven.compiler.target</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">project.build.sourceEncoding</span><span style="color:#ABB2BF">&gt;UTF-8&lt;/</span><span style="color:#E06C75">project.build.sourceEncoding</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">project.reporting.outputEncoding</span><span style="color:#ABB2BF">&gt;UTF-8&lt;/</span><span style="color:#E06C75">project.reporting.outputEncoding</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    &lt;!-- Spring Boot --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">spring-boot.version</span><span style="color:#ABB2BF">&gt;3.5.0&lt;/</span><span style="color:#E06C75">spring-boot.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    &lt;!-- langchain4j --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">langchain4j.version</span><span style="color:#ABB2BF">&gt;1.0.1&lt;/</span><span style="color:#E06C75">langchain4j.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    &lt;!--langchain4j-community 引入阿里云百炼平台依赖管理清单--&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">langchain4j-community.version</span><span style="color:#ABB2BF">&gt;1.0.1-beta6&lt;/</span><span style="color:#E06C75">langchain4j-community.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    &lt;!-- maven plugin --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">maven-deploy-plugin.version</span><span style="color:#ABB2BF">&gt;3.1.1&lt;/</span><span style="color:#E06C75">maven-deploy-plugin.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">flatten-maven-plugin.version</span><span style="color:#ABB2BF">&gt;1.3.0&lt;/</span><span style="color:#E06C75">flatten-maven-plugin.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">maven-compiler-plugin.version</span><span style="color:#ABB2BF">&gt;3.8.1&lt;/</span><span style="color:#E06C75">maven-compiler-plugin.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">properties</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependencyManagement</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependencies</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        &lt;!-- Spring Boot --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.springframework.boot&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;spring-boot-dependencies&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${spring-boot.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;pom&lt;/</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;import&lt;/</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        &lt;!--</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            langchain4j 的依赖清单，加载BOM后所有 langchain4j 版本号可以被统一管理起来</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            https://docs.langchain4j.dev/get-started</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-bom&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${langchain4j.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;pom&lt;/</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;import&lt;/</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        &lt;!--</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            引入阿里云百炼平台依赖管理清单</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            https://docs.langchain4j.dev/integrations/language-models/dashscope</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-community-bom&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${langchain4j-community.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;pom&lt;/</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;import&lt;/</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependencies</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependencyManagement</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">build</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">plugins</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.springframework.boot&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;spring-boot-maven-plugin&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${spring-boot.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.apache.maven.plugins&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;maven-deploy-plugin&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${maven-deploy-plugin.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">configuration</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;</span><span style="color:#E06C75">skip</span><span style="color:#ABB2BF">&gt;true&lt;/</span><span style="color:#E06C75">skip</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;/</span><span style="color:#E06C75">configuration</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.apache.maven.plugins&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;maven-compiler-plugin&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${maven-compiler-plugin.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">configuration</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;</span><span style="color:#E06C75">release</span><span style="color:#ABB2BF">&gt;${java.version}&lt;/</span><span style="color:#E06C75">release</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;</span><span style="color:#E06C75">compilerArgs</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">compilerArg</span><span style="color:#ABB2BF">&gt;-parameters&lt;/</span><span style="color:#E06C75">compilerArg</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;/</span><span style="color:#E06C75">compilerArgs</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;/</span><span style="color:#E06C75">configuration</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.codehaus.mojo&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;flatten-maven-plugin&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${flatten-maven-plugin.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">inherited</span><span style="color:#ABB2BF">&gt;true&lt;/</span><span style="color:#E06C75">inherited</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">executions</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;</span><span style="color:#E06C75">execution</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;flatten&lt;/</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">phase</span><span style="color:#ABB2BF">&gt;process-resources&lt;/</span><span style="color:#E06C75">phase</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">goals</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                        &lt;</span><span style="color:#E06C75">goal</span><span style="color:#ABB2BF">&gt;flatten&lt;/</span><span style="color:#E06C75">goal</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;/</span><span style="color:#E06C75">goals</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">configuration</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                        &lt;</span><span style="color:#E06C75">updatePomFile</span><span style="color:#ABB2BF">&gt;true&lt;/</span><span style="color:#E06C75">updatePomFile</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                        &lt;</span><span style="color:#E06C75">flattenMode</span><span style="color:#ABB2BF">&gt;ossrh&lt;/</span><span style="color:#E06C75">flattenMode</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                        &lt;</span><span style="color:#E06C75">pomElements</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                            &lt;</span><span style="color:#E06C75">distributionManagement</span><span style="color:#ABB2BF">&gt;remove&lt;/</span><span style="color:#E06C75">distributionManagement</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                            &lt;</span><span style="color:#E06C75">dependencyManagement</span><span style="color:#ABB2BF">&gt;remove&lt;/</span><span style="color:#E06C75">dependencyManagement</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                            &lt;</span><span style="color:#E06C75">repositories</span><span style="color:#ABB2BF">&gt;remove&lt;/</span><span style="color:#E06C75">repositories</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                            &lt;</span><span style="color:#E06C75">scm</span><span style="color:#ABB2BF">&gt;keep&lt;/</span><span style="color:#E06C75">scm</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                            &lt;</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;keep&lt;/</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                            &lt;</span><span style="color:#E06C75">organization</span><span style="color:#ABB2BF">&gt;resolve&lt;/</span><span style="color:#E06C75">organization</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                        &lt;/</span><span style="color:#E06C75">pomElements</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;/</span><span style="color:#E06C75">configuration</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;/</span><span style="color:#E06C75">execution</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;</span><span style="color:#E06C75">execution</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;flatten.clean&lt;/</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">phase</span><span style="color:#ABB2BF">&gt;clean&lt;/</span><span style="color:#E06C75">phase</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;</span><span style="color:#E06C75">goals</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                        &lt;</span><span style="color:#E06C75">goal</span><span style="color:#ABB2BF">&gt;clean&lt;/</span><span style="color:#E06C75">goal</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                    &lt;/</span><span style="color:#E06C75">goals</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">                &lt;/</span><span style="color:#E06C75">execution</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;/</span><span style="color:#E06C75">executions</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">plugin</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">plugins</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">build</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">repositories</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">repository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;spring-milestones&lt;/</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;Spring Milestones&lt;/</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;https://repo.spring.io/milestone&lt;/</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">snapshots</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;false&lt;/</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">snapshots</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">repository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">repository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;spring-snapshots&lt;/</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;Spring Snapshots&lt;/</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;https://repo.spring.io/snapshot&lt;/</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">releases</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;false&lt;/</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">releases</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">repository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">repository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;aliyunmaven&lt;/</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;aliyun&lt;/</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;https://maven.aliyun.com/repository/public&lt;/</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">repository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">repositories</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">pluginRepositories</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">pluginRepository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;public&lt;/</span><span style="color:#E06C75">id</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;aliyun nexus&lt;/</span><span style="color:#E06C75">name</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;https://maven.aliyun.com/repository/public&lt;/</span><span style="color:#E06C75">url</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">releases</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;true&lt;/</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">releases</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">snapshots</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">            &lt;</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;false&lt;/</span><span style="color:#E06C75">enabled</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;/</span><span style="color:#E06C75">snapshots</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">pluginRepository</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">pluginRepositories</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>子工程内引入以下依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependencies</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.springframework.boot&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;spring-boot-starter-web&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    &lt;!--    https://docs.langchain4j.dev/get-started    --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-open-ai&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.projectlombok&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;lombok&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">optional</span><span style="color:#ABB2BF">&gt;true&lt;/</span><span style="color:#E06C75">optional</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.springframework.boot&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;spring-boot-starter-test&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;test&lt;/</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependencies</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>API-Key 配置到环境变量</p>
</blockquote>
<p>复制在阿里云百炼中配置的 API-Key，将其配置到系统环境变量中，名称任意，比如：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E9%85%8D%E7%BD%AEAPI-Key%E5%88%B0%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" alt="配置API-Key到环境变量"></p>
<p>本文使用 <code>AliQwen_Key</code> 作为环境变量名称。</p>
<p><mark>配置完环境变量后，务必重启 IDEA，避免运行时无法成功读取到环境变量！</mark></p>
<p>创建配置类，设置 API-Key、模型名称和调用地址：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2025/7/10 0:00</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModelQwen</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 从环境变量中获取配置的 API-Key（配置环境变量后，记得重启 IDEA，否则可能获取不到！）</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-plus"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>使用 <code>ChatModel#chat()</code> 方法调用大模型：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2025/7/10 0:05</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Slf4j</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> HelloLangChain4JController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Autowired</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/langchain4j/hello"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> hello</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "question"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "你是谁"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> question</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(question);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>启动服务，浏览器访问 <code>http://localhost:9001/langchain4j/hello</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/LangChain4J%E7%9A%84Hello-World%E7%A4%BA%E4%BE%8B.png" alt="LangChain4J的Hello-World示例"></p>
<h2 id="2-2-多模型共存"><a class="header-anchor" href="#2-2-多模型共存"></a>2.2 多模型共存</h2>
<p>如果需要配置多个模型，只需在配置类中定义不同名称、<code>ChatModel</code> 类型的 Bean 即可：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "qwen"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModelQwen</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-plus"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * &lt;a href="https://platform.deepseek.com/usage"&gt;DeepSeek 开放平台&lt;/a&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * &lt;a href="https://api-docs.deepseek.com/zh-cn/"&gt;DeepSeek API 文档&lt;/a&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     */</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "deepseek"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModelDeepSeek</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"DeepSeek_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"deepseek-chat"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://api.deepseek.com/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>按需注入对应的 Bean 即可完成调用：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Slf4j</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MultiModelController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "qwen"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModelQwen</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "deepseek"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModelDeepSeek</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/multi-model/qwen"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> qwenCall</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "你是谁"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatModelQwen</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/multi-model/deepseek"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> deepseekCall</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "你是谁"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatModelDeepSeek</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="3-整合-SpringBoot"><a class="header-anchor" href="#3-整合-SpringBoot"></a>3. 整合 SpringBoot</h1>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/spring-boot-integration">Spring Boot Integration</a></p>
<p>LangChain4J 有 <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/intro#2-levels-of-abstraction">两种抽象级别</a>：</p>
<ol>
<li>低阶。在这个级别，你可以最自由地访问所有底层组件，比如 <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/chat-and-language-models/"><code>ChatModel</code></a>、<code>UserMessage</code>、<code>AiMessage</code>、<code>EmbeddingStore</code>、<code>Embedding</code> 等等。这些是由 LLM 驱动的应用程序的「原语」（primitives）。你可以完全控制如何组合它们，但需要编写更多的胶水代码。</li>
<li>高阶。在这个级别，你可以使用高级 API（如 <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/ai-services/">AI Services</a>）与 LLM 进行交互，从而隐藏所有复杂性和样板代码。你仍可以以声明式的方式对模型进行微调。</li>
</ol>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/langchain4j-components.png" alt="LangChain4J-Components"></p>
<p>导入以下两个依赖，分别对应低级和高级抽象级别的使用：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">&lt;!--    普通 Starter    --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-open-ai-spring-boot-starter&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">&lt;!--    在普通 Starter 的基础上，增加更多自动配置    --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-spring-boot-starter&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>可以在 <code>.yaml</code> 文件中配置大模型的必要信息（也可以使用配置类）：</p>
<figure class="highlight yaml line-numbers" data-language="YAML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E06C75">langchain4j</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  open-ai</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    chat-model</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      api-key</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">${AliQwen_Key}</span></span>
<span class="line"><span style="color:#E06C75">      model-name</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">qwen-plus</span></span>
<span class="line"><span style="color:#E06C75">      base-url</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">https://dashscope.aliyuncs.com/compatible-mode/v1</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>使用低级抽象级别</p>
</blockquote>
<p>和先前的使用方式不变，注入 <code>ChatModel</code> 即可：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> PopularIntegrationController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/lc4j/boot/chat"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "你是谁"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>使用高级抽象级别</p>
</blockquote>
<p>使用声明式 AI Service 时，需要定义一个被 <code>@AiService</code> 注解标记的接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">AiService</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> userMessage</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后注入并使用即可：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> DeclarativeAIServiceController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#E06C75"> chatAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/lc4j/boot/declarative"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> declarative</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "who are you?"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="4-低阶和高阶-API"><a class="header-anchor" href="#4-低阶和高阶-API"></a>4. 低阶和高阶 API</h1>
<h2 id="4-1-低阶-API"><a class="header-anchor" href="#4-1-低阶-API"></a>4.1 低阶 API</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/chat-and-language-models">Chat and Language Models</a></p>
<p>LLM 目前有两种 API 类型：</p>
<ol>
<li><code>LanguageModel</code>：它们的 API 非常简单，接收一个字符串入参，并返回一个字符串出参。这种 API 目前已经过时，取而代之的是 chat API（接下来的第二章 API 类型）；</li>
<li><code>ChatModel</code>：接收多种 <code>ChatMessage</code> 作为入参，并返回一个 <code>AiMessage</code> 作为出参。<code>ChatMessage</code> 通常包含文本，但一些 LLM 也支持其他模态的输入（图片，音频等），比如 OpenAI 的 <code>gpt-4o-mini</code> 和谷歌的 <code>gemini-1.5-pro</code>。</li>
</ol>
<p>LangChain4J 不再拓展对 <code>LanguageModel</code> 的支持，因此在所有新特新中，都将使用 <code>ChatModel</code>。</p>
<p><code>ChatModel</code> 是 LangChain4J 中与 LLM 进行交互的低阶 API，提供了强大的功能和灵活性。</p>
<p>除 <code>ChatModel</code> 外，<code>UserMessage</code>、<code>AiMessage</code>、<code>EmbeddingStore</code>、<code>Embedding</code> 等也属于低阶 API。</p>
<h2 id="4-2-高阶-API"><a class="header-anchor" href="#4-2-高阶-API"></a>4.2 高阶 API</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/ai-services">AI Services</a></p>
<p>使用低阶 API 可以自由组合各个组件，但需要编写更多的胶水代码。由 LLM 驱动的应用程序不仅需要单个组件，通常需要多个组件相互协同工作，编排它们也变得更加繁琐。</p>
<p>为了更专注于业务逻辑，而不是低阶实现细节，为此 LangChain4J 提供了 AI Services 和 Chains 两个高级概念。其中的 Chain 被官方认定为过时的，而 AI Services 是专为 Java 量身定制的解决方案。</p>
<p>使用高阶 API 时，需要自行定义接口，调用 <code>AiServices</code> 类中的方法进行实现，不仅减少了代码的复杂性，也可以进行灵活的微调（见文档：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/ai-services#simplest-ai-service">Simplest AI Service</a>）。</p>
<blockquote>
<p>使用示例</p>
</blockquote>
<p>定义接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> userMessage</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>定义配置：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "qwen"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModelQwen</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-plus"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#61AFEF"> chatAssistant</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">Qualifier</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModelQwen</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, chatModelQwen);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后使用：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> HighApiController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#E06C75"> chatAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/highapi/highapi"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> highApi</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "你是谁"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 Web 开发中，定义一个 Service 后，需要定义其对应的实现类。现在使用高阶 API 定义接口后，不用再定义实现类，LangChain4J 会帮你完成。</p>
<p>注意与前文使用案例的区分，创建 <code>Assistant</code> 接口后，并没有使用 <code>@AiService</code> 标记它，因为 <code>@AiService</code> 是与 SpringBoot 集成所需要的。</p>
<blockquote>
<p>工作原理</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/ai-services#how-does-it-work">How does it work?</a></p>
<p>简单来说，将接口的 <code>Class</code> 对象和低阶组件（<code>ChatModel</code>）传给 <code>AiServices</code> 后，会使用反射创建接口的代理对象。</p>
<h2 id="4-3-Token"><a class="header-anchor" href="#4-3-Token"></a>4.3 Token</h2>
<p>参考 DeepSeek API 文档中的 <a target="_blank" rel="noopener" href="https://api-docs.deepseek.com/zh-cn/quick_start/token_usage">介绍</a>：</p>
<p>token 是模型用来表示自然语言文本的基本单位，也是我们的计费单元，可以直观的理解为「字」或「词」；通常 1 个中文词语、1 个英文单词、1 个数字或 1 个符号计为 1 个 token。</p>
<p>一般情况下模型中 token 和字数的换算比例大致如下：</p>
<ul>
<li>1 个英文字符 ≈ 0.3 个 token。</li>
<li>1 个中文字符 ≈ 0.6 个 token。</li>
</ul>
<p>但因为不同模型的分词不同，所以换算比例也存在差异，每一次实际处理 token 数量以模型返回为准，您可以从返回结果的 <code>usage</code> 中查看。</p>
<p>Token 一词在 Web 开发中也很常见。在 Web 开发中，token 通常指的是用于认证和授权的一种加密字符串。它被用来确保用户身份的安全验证，比如 JWT。这类 token 由服务器生成，并发给客户端保存（比如存储在浏览器的本地存储或 Cookie 中），之后每次请求都需要携带这个 token 来证明用户的身份。</p>
<p>使用低阶 API 获取 token 用量：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Resource</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "deepseek"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModelDeepSeek</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * Token 用量计算的底层 API 演示验证案例</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/lowapi/api02"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getTokenUsage</span><span style="color:#E06C75">(</span><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "你是谁"</span><span style="color:#E06C75">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> prompt) {</span></span>
<span class="line"><span style="color:#E5C07B">    ChatResponse</span><span style="color:#E06C75"> response </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> chatModelDeepSeek</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">UserMessage</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(prompt));</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">aiMessage</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">text</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"调用大模型的返回结果: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> result);</span></span>
<span class="line"><span style="color:#E5C07B">    TokenUsage</span><span style="color:#E06C75"> tokenUsage </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">tokenUsage</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"本次调用消耗的 token: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> tokenUsage);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "</span><span style="color:#56B6C2">\t\n</span><span style="color:#98C379">"</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> tokenUsage</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="5-模型参数"><a class="header-anchor" href="#5-模型参数"></a>5. 模型参数</h1>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/model-parameters">Model Parameters</a></p>
<p>在与 SpringBoot 进行整合时，可以在配置文件中配置模型参数，参考：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/language-models/open-ai/#spring-boot-1">Spring Boot</a></p>
<blockquote>
<p>日志</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/logging">Logging</a></p>
<p>在配置类中添加 <code>ChatModel</code> 类型的 Bean 时调用 <code>logRequests(true)</code> 和 <code>logResponses(true)</code> 方法：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">logRequests</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">logResponses</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>然后添加日志依赖，比如：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;ch.qos.logback&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;logback-classic&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${logback.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>不需要在配置文件里设置日志级别为 DEBUG。</p>
<blockquote>
<p>监听</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/observability">Observability</a></p>
<p>整合了 SpringBoot 时，可以在配置类中进行监听的配置：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/spring-boot-integration#observability">Observability | Spring Boot Integration</a></p>
<p>实现 <code>ChatModelListener</code> 接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Slf4j</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> TestChatModelListener</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ChatModelListener</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onRequest</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModelRequestContext</span><span style="color:#E06C75;font-style:italic"> requestContext</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> uuid</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> UUID</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">randomUUID</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        requestContext</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">attributes</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"TraceId"</span><span style="color:#ABB2BF">, uuid);</span></span>
<span class="line"><span style="color:#E5C07B">        log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">info</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"请求参数 requestContext: {}"</span><span style="color:#ABB2BF">, requestContext </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "</span><span style="color:#56B6C2">\t</span><span style="color:#98C379">"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> uuid);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModelResponseContext</span><span style="color:#E06C75;font-style:italic"> responseContext</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> traceId</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> responseContext</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">attributes</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"TraceId"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">info</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"返回结果 responseContext: {}"</span><span style="color:#ABB2BF">, responseContext </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "</span><span style="color:#56B6C2">\t</span><span style="color:#98C379">"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> traceId);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onError</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModelErrorContext</span><span style="color:#E06C75;font-style:italic"> errorContext</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">error</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"请求异常 errorContext: {}"</span><span style="color:#ABB2BF">, errorContext);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>构造 <code>ChatModel</code> 时，添加监听器：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">listeners</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">List</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> TestChatModelListener</span><span style="color:#ABB2BF">()))</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>以 <code>ChatModel#chat()</code> 方法与大模型进行交互时，且存在监听器时，整个流程如下：</p>
<pre><code class="highlight mermaid">flowchart TD
    A("ChatModelListener#onRequest()")
    B("ChatModel#chat()")
    C{"是否出现异常"}
    D("ChatModelListener#onResponse()")
    E("ChatModelListener#onError()")

    A --&gt; B --&gt; C
    C -- 是 --&gt; E
    C -- 否 --&gt; D</code></pre>
<blockquote>
<p>重试</p>
</blockquote>
<p>默认重试 3 次。</p>
<p>可以在构造 <code>ChatModel</code> 时调用 <code>maxRetries()</code> 方法进行配置，在与 SpringBoot 进行整合时，也可以在配置文件中以下方形式进行配置：</p>
<figure class="highlight yaml line-numbers" data-language="YAML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E06C75">langchain4j</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  open-ai</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    chat-model</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      max-retries</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">3</span></span></code></pre></td></tr></tbody></table>
      </figure>
<blockquote>
<p>超时</p>
</blockquote>
<p>向大模型发送请求时，如果在制定时间内没有收到响应，该请求会被终端，并提示超时。</p>
<p>同样的，既可以在构造 <code>ChatModel</code> 时调用对应方法进行配置：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // --snip--</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">timeout</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Duration</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ofSeconds</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>与 SpringBoot 进行整合时，也可以在配置文件中以下方形式配置：</p>
<figure class="highlight yaml line-numbers" data-language="YAML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E06C75">langchain4j</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  open-ai</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    chat-model</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      timeout</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">2s</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="6-多模态视觉理解"><a class="header-anchor" href="#6-多模态视觉理解"></a>6. 多模态视觉理解</h1>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/chat-and-language-models#multimodality">Multimodality</a></p>
<p><code>UserMessage</code> 不仅仅可以包含文本，还可以包含其他类型的内容。<code>UserMessage</code> 包含一个 <code>List&lt;Content&gt; contents</code>。</p>
<p><code>Content</code> 是一个接口，有下列实现：</p>
<ul>
<li><code>TextContent</code></li>
<li><code>ImageContent</code></li>
<li><code>AudioContent</code></li>
<li><code>VideoContent</code></li>
<li><code>PdfFileContent</code></li>
</ul>
<p>可以从 <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/language-models/">这个表</a> 中查看哪些 LLM 提供商提供了哪些输入模式。</p>
<h2 id="6-1-解读图片"><a class="header-anchor" href="#6-1-解读图片"></a>6.1 解读图片</h2>
<p>本节选用 <a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?tab=model#/model-market/detail/qwen-vl-max?modelGroup=qwen-vl-max">通义千问VL-Max</a> 作为使用的模型。</p>
<p>相应地需要调整配置类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "qwen"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModelQwen</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-vl-max"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>需要将图片转换成 Base64 字符串作为提示词：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ImageModelController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Value</span><span style="color:#E06C75">(</span><span style="color:#98C379">"classpath:static/images/mi.jpg"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">core</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">io</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Resource</span><span style="color:#E06C75"> resource</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">SneakyThrows</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"image/call"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> readImageContent</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 1. 通过 Base64 编码将图片转化为字符串</span></span>
<span class="line"><span style="color:#C678DD">        byte</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75">byteArray</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> resource</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getContentAsByteArray</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> base64Data</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Base64</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getEncoder</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">encodeToString</span><span style="color:#ABB2BF">(byteArray);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 2. 指定提示词</span></span>
<span class="line"><span style="color:#E5C07B">        UserMessage</span><span style="color:#E06C75"> userMessage</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> UserMessage</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E5C07B">                TextContent</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"从下面图片中获取来源网站名称、股价走势和 5 月 30 日的股价"</span><span style="color:#ABB2BF">),</span></span>
<span class="line"><span style="color:#E5C07B">                ImageContent</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(base64Data, </span><span style="color:#98C379">"image/jpg"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 3. api 调用</span></span>
<span class="line"><span style="color:#E5C07B">        ChatResponse</span><span style="color:#E06C75"> response</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> chatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(userMessage);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 4. 解析与输出</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">aiMessage</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">text</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="6-2-接入三方平台"><a class="header-anchor" href="#6-2-接入三方平台"></a>6.2 接入三方平台</h2>
<p>以接入 DashScope(Qwen) 为例，按 <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/language-models/dashscope#maven-dependency">官网</a> 说明，父工程新增 Maven 配置（最开始其实已经导入）：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependencyManagement</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-community-bom&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${langchain4j-community.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;pom&lt;/</span><span style="color:#E06C75">type</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">        &lt;</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;import&lt;/</span><span style="color:#E06C75">scope</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependencyManagement</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在子工程导入接入 DashScope 需要的依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-community-dashscope-spring-boot-starter&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>使用 <code>wanx2.1-t2i-turbo</code> 模型完成文生图：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 使用通义万相实现图片生成</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> WanxImageModel</span><span style="color:#61AFEF"> wanxImageModel</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> WanxImageModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 已经指定了使用通义万相，因此不再需要配置 baseUrl</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"wanx2.1-t2i-turbo"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="7-流式输出"><a class="header-anchor" href="#7-流式输出"></a>7. 流式输出</h1>
<h2 id="7-1-基本概念"><a class="header-anchor" href="#7-1-基本概念"></a>7.1 基本概念</h2>
<p>流式输出（StreamingOutput）是一种逐步返回大模型生成结果的技术，允许服务器将响应内容分批次实时传输给客户端，而不是等待全部内容生成完毕后再一次性返回。</p>
<p>这种机制能显著提升用户体验，尤其适用于大模型响应较慢的场景（如生成长文本或复杂推理结果）。</p>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/response-streaming">Response Streaming</a></p>
<p>LLM 一次生成一个 token，因此大多数 LLM 提供商都提供了逐个 token 流式输出的方式，而不是等待整个文本生成完成后才输出。这极大地改善了用户的体验，用户无需再等待未知的时间，可以立即开始阅读 LLM 的输出内容。</p>
<p>与 <code>ChatModel</code> 对应，其流式输出接口是 <code>StreamingChatModel</code>，它接收一个 <code>StreamingChatResponseHandler</code> 接口的实现作为参数。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> StreamingChatResponseHandler</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    void</span><span style="color:#61AFEF"> onPartialResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> partialResponse</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    void</span><span style="color:#61AFEF"> onCompleteResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatResponse</span><span style="color:#E06C75;font-style:italic"> completeResponse</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    void</span><span style="color:#61AFEF"> onError</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> error</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>通过实现 <code>StreamingChatResponseHandler</code> 接口，可以为下列事件定义操作：</p>
<ul>
<li>当下一部分响应生成时，将调用 <code>onPartialResponse()</code> 方法，这部分响应可以包含一个和多个 token，你可以将这些 token 直接发送给 UI；</li>
<li>当 LLM 完成内容生成时，将调用 <code>onCompleteResponse()</code> 方法。<code>ChatResponse</code> 对象包含完整的响应（<code>AiMessage</code>）以及响应元数据（<code>ChatResponseMetadata</code>）；</li>
<li>当发生错误时，<code>onError()</code> 方法将被执行。</li>
</ul>
<p>与 <code>ChatModel</code> 一样，<code>StreamingChatModel</code> 只是流式输出的低阶 API，使用高阶 API AI Service 时，将 <code>TokenStream</code> 作为返回类型就可以实现流式输出。</p>
<p>除此之外，还可以使用 <code>Flux&lt;String&gt;</code> 作为返回类型，但这时需要额外引入 Maven 坐标：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-reactor&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;${langchain4j.version}&lt;/</span><span style="color:#E06C75">version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="7-2-编码实战"><a class="header-anchor" href="#7-2-编码实战"></a>7.2 编码实战</h2>
<p>Maven 中引入 <code>langchain4j-reactor</code>，在配置文件中添加以下信息：</p>
<figure class="highlight yaml line-numbers" data-language="YAML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E06C75">server</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  # 设置响应的字符编码，避免流式返回输出乱码</span></span>
<span class="line"><span style="color:#E06C75">  servlet</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    encoding</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      charset</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">utf-8</span></span>
<span class="line"><span style="color:#E06C75">      enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span></span>
<span class="line"><span style="color:#E06C75">      force</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>定义 AI Service 接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    Flux</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> chatFlux</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在配置类中完成对 <code>StreamingChatModel</code> 的配置：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> StreamingChatModel</span><span style="color:#61AFEF"> streamingChatModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiStreamingChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-plus"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#61AFEF"> chatAssistant</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">StreamingChatModel</span><span style="color:#E06C75;font-style:italic"> streamingChatModel</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, streamingChatModel);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后是一份简单的食用指南：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Slf4j</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> StreamChatModelController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> StreamingChatModel</span><span style="color:#E06C75"> streamingChatModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#E06C75"> chatAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-stream/chat"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> simpleChat</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "成都有什么吃的？"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        streamingChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt, </span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> StreamingChatResponseHandler</span><span style="color:#ABB2BF">() {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onPartialResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> s</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(s);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onCompleteResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatResponse</span><span style="color:#E06C75;font-style:italic"> chatResponse</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"-- response over: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chatResponse);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onError</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> throwable</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">error</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">throwable</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMessage</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        });</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-stream/chat-flux"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Flux</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> chatFlux</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "重庆有什么好吃的？"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Flux</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(i </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> streamingChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(prompt, </span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> StreamingChatResponseHandler</span><span style="color:#ABB2BF">() {</span></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onPartialResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> s</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                i</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">(s);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onCompleteResponse</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatResponse</span><span style="color:#E06C75;font-style:italic"> chatResponse</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                i</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">complete</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">            @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> onError</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> throwable</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                i</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">error</span><span style="color:#ABB2BF">(throwable);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        }));</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-stream/high-level-chat-flux"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Flux</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> highLevelChatFlux</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "prompt"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">defaultValue</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "浙江有什么好吃的？"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatFlux</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="8-Chat-Memory"><a class="header-anchor" href="#8-Chat-Memory"></a>8. Chat Memory</h1>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/chat-memory">Chat Memory</a></p>
<p>Chat Memory  是聊天系统中的重要组件，用于存储和管理对话的上下文信息。它的主要作用是让 AI 助手能够「记住」之前的对话内容，从而提供连贯和个性化的回复。</p>
<p>手动维护和管理 <code>ChatMessage</code> 非常麻烦，因此 LangChain4J 提供了一个 <code>ChatMemory</code> 抽象以及多种开箱即用的实现。<code>ChatMemory</code> 既可以作为独立的底层组件使用，也可以作为 AI Service 等高级组件的一部分使用。</p>
<p><code>ChatMemory</code> 作为 <code>ChatMessage</code> 的容器（由 <code>List</code> 支持），并具有以下附加功能：</p>
<ul>
<li>驱逐策略</li>
<li>持久性</li>
<li><code>SystemMessage</code> 的特殊处理</li>
<li><code>tool messages</code> 的特殊处理</li>
</ul>
<h2 id="8-1-Memory-vs-History"><a class="header-anchor" href="#8-1-Memory-vs-History"></a>8.1 Memory vs History</h2>
<p>「memory」和「history」是既相似但又不同的概念：</p>
<ul>
<li>「history」完整地保存了用户和 AI 之间的所有信息。「history」是用户在 UI 中看到的内容，代表实际说过的话。</li>
<li>「memory」会保留一些信息，这些信息被呈现给 LLM，使其表现得好像「记住」了对话。「memory」和「history」截然不同。根据使用的不同「memory」算法，可以以各种方式修改「history」：驱逐一些消息、汇总多条消息、汇总单独的消息、删除消息中不重要的细节、向消息中注入额外的信息（如 RAG）或指令（如结构化输出）等等。</li>
</ul>
<p>LangChain4J 目前只提供「memory」，不提供「history」，如果需要保存整个「history」，请手动操作。</p>
<h2 id="8-2-驱逐策略"><a class="header-anchor" href="#8-2-驱逐策略"></a>8.2 驱逐策略</h2>
<p>出于以下几个原因，驱逐策略是必要的：</p>
<ul>
<li>适应 LLM 的上下文窗口。LLM 一次可以处理的 token 数量是有限的，某些时候可能会超过这个限制。在这种情况下，一些消息应该被驱逐。通常情况下，最旧的消息会被驱逐，但如果需要，也可以实现更复杂的算法。</li>
<li>控制成本。每个 token 都是有成本的，这使得每次调用 LLM 的成本逐渐增加，删除不必要的消息可以降低成本。</li>
<li>控制延迟。发送给 LLM 的 token 越多，处理它们的时间就越长。</li>
</ul>
<p>目前 LangChain4J 提供了两种开箱即用的实现：</p>
<ol>
<li>其中简单的是 <code>MessageWindowChatMemory</code>，它作为一个滑动窗口，保留 <code>N</code> 条最新的消息，删除不再适用的旧消息。</li>
<li>更为复杂的是 <code>TokenWindowChatMemory</code>，它也作为一个滑动窗口，但在保留 <code>N</code> 条最新的消息时，根据需要删除旧消息。消息是不可分割的。如果一条消息不再适用，它会被完全驱逐。<code>TokenWindowChatMemory</code> 需要 <code>TokenCountEstimator</code> 来计算每个 <code>ChatMessage</code> 中的 token。</li>
</ol>
<h2 id="8-3-编码实现"><a class="header-anchor" href="#8-3-编码实现"></a>8.3 编码实现</h2>
<p>定义 AI Service 接口 <code>ChatMemoryAssistant</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ChatMemoryAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chatWithChatMemory</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">MemoryId</span><span style="color:#E5C07B"> Long</span><span style="color:#E06C75;font-style:italic"> userId</span><span style="color:#ABB2BF">, @</span><span style="color:#E5C07B">UserMessage</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75;font-style:italic"> prompt</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>注意标注 <code>@MemoryId</code> 和 <code>@UserMessage</code>。</p>
<p>这次选用 <code>qwen-long</code> 模型，编写配置类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> streamingChatModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-long"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "chatMessageWindowChatMemory"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatMemoryAssistant</span><span style="color:#61AFEF"> chatMessageWindowChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModel</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatMemoryAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatModel</span><span style="color:#ABB2BF">(chatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatMemoryProvider</span><span style="color:#ABB2BF">(i </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> MessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                        .</span><span style="color:#61AFEF">id</span><span style="color:#ABB2BF">(i)</span></span>
<span class="line"><span style="color:#ABB2BF">                        .</span><span style="color:#61AFEF">maxMessages</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">100</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                        .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "chatTokenWindowChatMemory"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatMemoryAssistant</span><span style="color:#61AFEF"> chatTokenWindowChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModel</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatMemoryAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatModel</span><span style="color:#ABB2BF">(chatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatMemoryProvider</span><span style="color:#ABB2BF">(i </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> TokenWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                        .</span><span style="color:#61AFEF">id</span><span style="color:#ABB2BF">(i)</span></span>
<span class="line"><span style="color:#ABB2BF">                        .</span><span style="color:#61AFEF">maxTokens</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1000</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> OpenAiTokenCountEstimator</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"gpt-4"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                        .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在使用时注入对应的 AI Service 接口即可：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Resource</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "chatMessageWindowChatMemory"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> ChatMemoryAssistant</span><span style="color:#E06C75"> chatMessageWindowChatMemory</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Resource</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "chatTokenWindowChatMemory"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> ChatMemoryAssistant</span><span style="color:#E06C75"> chatTokenWindowChatMemory</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-memory/message-window"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> chatMessageWindow</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    chatMessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"你好，我的名字是张三"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> ans01 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> chatMessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"我的名字是什么？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ans01 的返回结果是: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> ans01);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    chatMessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">100L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"你好，我的名字是李四"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> ans02 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> chatMessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">100L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"我的名字是什么？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ans02 的返回结果是: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> ans02);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#98C379"> "chatMessageWindow success: "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> +</span><span style="color:#98C379"> "&lt;br /&gt;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> ans01: "</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> ans01 </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "&lt;br /&gt;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> ans02: "</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> ans02</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-memory/token-window"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> chatTokenWindow</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    chatTokenWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"你好，我的名字是张三"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> ans01 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> chatTokenWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"我的名字是什么？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ans01 的返回结果是: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> ans01);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    chatTokenWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">100L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"你好，我的名字是李四"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> ans02 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> chatTokenWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chatWithChatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">100L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"我的名字是什么？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ans02 的返回结果是: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> ans02);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#98C379"> "chatMessageWindow success: "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> +</span><span style="color:#98C379"> "&lt;br /&gt;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> ans01: "</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> ans01 </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "&lt;br /&gt;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> ans02: "</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> ans02</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="9-提示词工程"><a class="header-anchor" href="#9-提示词工程"></a>9. 提示词工程</h1>
<h2 id="9-1-多种-ChatMessage"><a class="header-anchor" href="#9-1-多种-ChatMessage"></a>9.1 多种 ChatMessage</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/chat-and-language-models#types-of-chatmessage">Types of ChatMessage</a></p>
<p><code>ChatMessage</code> 是 LangChain4J 提供的一个接口，内置了 5 种默认实现，这在 <code>ChatMessageType</code> 枚举中也能发现：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> enum</span><span style="color:#E5C07B"> ChatMessageType</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#D19A66">    SYSTEM</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">SystemMessage</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#D19A66">    USER</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">UserMessage</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#D19A66">    AI</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">AiMessage</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#D19A66">    TOOL_EXECUTION_RESULT</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ToolExecutionResultMessage</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#D19A66">    CUSTOM</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">CustomMessage</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>根据官网的描述：</p>
<ul>
<li><code>UserMessage</code>：来自用户的消息。这里的用户可以是应用程序的终端用户（人类），也可以是应用程序本身。根据 LLM 支持的多模态，<code>UserMessage</code> 可以只包含文本，也可以包含其他模态（比如图片、音频、视频、PDF）。</li>
<li><code>AiMessage</code>：AI 生成的消息，通常是对 <code>UserMessage</code> 的响应。在先前的使用案例中，调用 <code>ChatModel</code> 中接收 <code>UserMessage</code> 的 <code>chat()</code> 方法时，会返回一个 <code>ChatResponse</code> 对象，其内部就存在一个 <code>AiMessage</code> 对象。<code>AiMessage</code> 可以包含文本响应（<code>String</code>）和执行工具（Tool）的请求（<code>ToolExecutionRequest</code>），关于 Tool 将在后续介绍。</li>
<li><code>ToolExecutionResultMessage</code>：<code>ToolExecutionRequest</code> 的结果。</li>
<li><code>SystemMessage</code>：来自系统的消息。开发人员通常会定义该消息的内容。开发人员需要在这里写下 LLM 在本次对话中的角色、应该如何表现、以什么风格回答等指示。LLM 被训练成相比于其他类型的消息，更关注 <code>SystemMessage</code>，所以要小心，最好不要让终端用户自由定义或向 <code>SystemMessage</code> 注入一些内容。通常情况下，<code>SystemMessage</code> 位于对话的开头。</li>
<li><code>CustomMessage</code>：包含任意属性的自定义消息。此消息只能在支持它的 <code>ChatModel</code> 实现上使用，目前只有 Ollama。</li>
</ul>
<p>有这么多种 <code>ChatMessage</code>，如何在对话中将它们结合起来呢？</p>
<p>在最简单的情况下，我们可以在 <code>chat</code> 方法中提供一个单一的 <code>UserMessage</code> 实例。这与 <code>ChatModel#chat(String)</code> 很类似，只不过 <code>chat(ChatMessage)</code> 不再返回字符串，而是 <code>ChatResponse</code>。<code>ChatResponse</code> 内部不仅包含 <code>AiMessage</code>，还有 <code>ChatResponseMetadata</code>。<code>ChatResponseMetadata</code> 是封装了响应的元数据，包括 <code>TokenUsage</code>，它统计了输入（提供给 <code>generate</code> 方法的所有 <code>ChatMessage</code> ）包含多少 token、输出（在 <code>AiMessage</code>）生成了多少 token，以及 token 总量。你可以根据这些信息计算调用 LLM 的成本。<code>ChatResponseMetadata</code> 还包含一个 <code>FinishReason</code> 枚举，定义了停止生成的各种原因。通常情况下，如果 LLM 自行决定停止生成，枚举值为 <code>FinishReason.STOP</code>。</p>
<p>根据内容的不同，有多种创建 <code>UserMessage</code> 的方式。最简单的是 <code>new UserMessage("Hi")</code> 或 <code>UserMessage.from("Hi")</code>。</p>
<h2 id="9-2-提示词的演化"><a class="header-anchor" href="#9-2-提示词的演化"></a>9.2 提示词的演化</h2>
<p>提示词的演化分为三个历程：</p>
<pre><code class="highlight mermaid">flowchart TD
    A("简单纯文本提问")
    B("占位符(Prompt Template)")
    C("多角色消息")

    A --&gt; B --&gt; C</code></pre>
<p>最初的提示词（Prompt）只是简单的文本字符串，后续引入占位符 <code>{{it}}</code> 以动态插入内容，如今将消息分为不同角色（如用户、助手、系统等），设置功能边界，增强交互的复杂性和上下文感知能力。</p>
<h2 id="9-3-编码实现"><a class="header-anchor" href="#9-3-编码实现"></a>9.3 编码实现</h2>
<p>定义一个模板类 <code>LawPrompt</code>，以便后续以面向对象的方式定义提示词：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Getter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Setter</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">StructuredPrompt</span><span style="color:#E06C75">(</span><span style="color:#98C379">"根据中国{{legal}}法律，解答以下问题: {{question}}"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LawPrompt</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> legal</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> question</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>新建 AI Service 接口 <code>LawAssistant</code>，使用 <code>@SystemMessage</code>、<code>@UserMessage</code> 和 <code>@V</code> 注解定义各种提示词：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> LawAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">SystemMessage</span><span style="color:#E06C75">(</span><span style="color:#98C379">"""</span></span>
<span class="line"><span style="color:#98C379">            你是一位专业的中国法律顾问，只回答与中国法律相关的问题。</span></span>
<span class="line"><span style="color:#98C379">            输出限制：对于其他领域的问题禁止回答，直接返回'抱歉，我只能回答中国法律相关的问题'。</span></span>
<span class="line"><span style="color:#98C379">            """</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">UserMessage</span><span style="color:#E06C75">(</span><span style="color:#98C379">"请回答以下法律问题：{{question}}，字数控制在 {{length}} 以内。"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">V</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"question"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> question</span><span style="color:#ABB2BF">, @</span><span style="color:#E5C07B">V</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"length"</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> length</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">SystemMessage</span><span style="color:#E06C75">(</span><span style="color:#98C379">"""</span></span>
<span class="line"><span style="color:#98C379">            你是一位专业的中国法律顾问，只回答与中国法律相关的问题。</span></span>
<span class="line"><span style="color:#98C379">            输出限制：对于其他领域的问题禁止回答，直接返回'抱歉，我只能回答中国法律相关的问题'。</span></span>
<span class="line"><span style="color:#98C379">            """</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">LawPrompt</span><span style="color:#E06C75;font-style:italic"> lawPrompt</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在配置类中创建 Bean：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> streamingChatModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> LawAssistant</span><span style="color:#61AFEF"> lawAssistant</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModel</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">LawAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, chatModel);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后就是「酣畅淋漓」的使用：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ChatPromptController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> LawAssistant</span><span style="color:#E06C75"> lawAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#E06C75"> chatModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-prompt/test1"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> test1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat1</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> lawAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"什么是知识产权？"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2000</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat1);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat2</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> lawAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"什么是 Java？"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2000</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat3</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> lawAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"介绍下西瓜和芒果？"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2000</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat3);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat4</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> lawAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"飞机发动机原理？"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2000</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat4);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#98C379"> "success : "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "&lt;br /&gt; </span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> chat1: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chat1</span></span>
<span class="line"><span style="color:#56B6C2">               +</span><span style="color:#98C379"> "&lt;br /&gt; </span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> chat2: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chat2</span></span>
<span class="line"><span style="color:#56B6C2">               +</span><span style="color:#98C379"> "&lt;br /&gt; </span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> chat3: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chat3</span></span>
<span class="line"><span style="color:#56B6C2">               +</span><span style="color:#98C379"> "&lt;br /&gt; </span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> chat4: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chat4;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-prompt/test2"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> test2</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        LawPrompt</span><span style="color:#E06C75"> lawPrompt</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> LawPrompt</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        lawPrompt</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setLegal</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"知识产权"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        lawPrompt</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setQuestion</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"TRIPS协议"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> lawAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(lawPrompt);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#98C379"> "success : "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "&lt;br /&gt; </span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> chat: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chat;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-prompt/test3"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> test3</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> role</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "外科医生"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> question</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "牙疼"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        PromptTemplate</span><span style="color:#E06C75"> template</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> PromptTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"你是一个{{it}}助手，{{question}}怎么办？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Prompt</span><span style="color:#E06C75"> prompt</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> template</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">apply</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Map</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"it"</span><span style="color:#ABB2BF">, role, </span><span style="color:#98C379">"question"</span><span style="color:#ABB2BF">, question));</span></span>
<span class="line"><span style="color:#E5C07B">        UserMessage</span><span style="color:#E06C75"> userMessage</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> prompt</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toUserMessage</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        ChatResponse</span><span style="color:#E06C75"> response</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> chatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(userMessage);</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> text</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">aiMessage</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">text</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#98C379"> "success : "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "&lt;br /&gt; </span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379"> chat: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> text;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="10-持久化"><a class="header-anchor" href="#10-持久化"></a>10. 持久化</h1>
<h2 id="10-1-官方介绍"><a class="header-anchor" href="#10-1-官方介绍"></a>10.1 官方介绍</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/chat-memory#persistence">Persistence</a></p>
<p>默认情况下，<code>ChatMemory</code> 将 <code>ChatMessage</code> 存储在内存中。</p>
<p>如果需要持久化，可以自定义 <code>ChatMemoryStore</code> 实现，将 <code>ChatMessage</code> 存储到选择的持久化存储区中：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> PersistentChatMemoryStore</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ChatMemoryStore</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">ChatMessage</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> getMessages</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // TODO: 通过 memory ID 从持久化存储区中获取所有信息</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // ChatMessageDeserializer.messageFromJson(String) 和 </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // ChatMessageDeserializer.messagesFromJson(String) 辅助方法可以轻松地</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 将 JSON 反序列化为 chat message</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> updateMessages</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">ChatMessage</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">messages</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // TODO: 通过 message ID 在持久化存储区中更新所有信息</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // ChatMessageSerializer.messageToJson(ChatMessage) 和 </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // ChatMessageSerializer.messagesToJson(List&lt;ChatMessage&gt;) 辅助方法可以轻松地</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 将 chat message 序列化为 JSON</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> deleteMessages</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // TODO: 通过 message ID 在持久化存储区中删除所有信息</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">ChatMemory</span><span style="color:#E06C75"> chatMemory </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> MessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">id</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"12345"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">maxMessages</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">chatMemoryStore</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> PersistentChatMemoryStore</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#ABB2BF">    .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>每当新的 <code>ChatMessage</code> 被添加到 <code>ChatMemory</code> 中时，就会调用 <code>updateMessages()</code> 方法。在每次与 LLM 交互时，这通常会发生两次：一次是添加新的 <code>UserMessage</code>，另一次是添加新的 <code>AiMessage</code>。<code>updateMessages()</code> 方法将更新与给定 memory ID 相关的所有信息。<code>ChatMessage</code> 既可以单独存储（例如每条信息对应一条记录、一行、一个对象），也可以一起存储（例如整个 <code>ChatMemory</code> 对应一条记录、一行、一个对象）。</p>
<p>请注意，从 <code>ChatMemory</code> 中驱逐的消息也会从 <code>ChatMemoryStore</code> 中驱逐。当消息被驱逐时，<code>updateMessages()</code> 方法会被调用，且传入的消息列表中不包含被驱逐的消息。</p>
<p>每当 <code>ChatMemory</code> 的用户请求所有消息时，就会调用 <code>getMessages()</code> 方法。在每次与 LLM 交互时，这通常会发生一次。参数 <code>memoryId</code> 对象的值与创建 <code>ChatMemory</code> 时指定的 id 相对应，它被用于区分多个用户或多个对话。<code>getMessages()</code> 方法会返回与给定 memory id 相关联的所有信息。</p>
<p>每当调用 <code>ChatMemory.clear()</code> 时，就会调用 <code>deleteMessages()</code> 方法。如果不使用这个功能，可以将此方法留空。</p>
<h2 id="10-2-编码实现"><a class="header-anchor" href="#10-2-编码实现"></a>10.2 编码实现</h2>
<p>将客户和大模型的对话回答保存进 Redis，进行持久化记忆留存。</p>
<p>额外引入 Redis 依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.springframework.boot&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;spring-boot-starter-data-redis&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>新建 AI Service 接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ChatPersistenceAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">MemoryId</span><span style="color:#E5C07B"> Long</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">, @</span><span style="color:#E5C07B">UserMessage</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75;font-style:italic"> message</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>由于需要将消息持久化到 Redis 中，配置 Redis Key-Value 的序列化策略：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> RedisConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> RedisTemplate</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> redisTemplate</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">RedisConnectionFactory</span><span style="color:#E06C75;font-style:italic"> redisConnectionFactory</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        RedisTemplate</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Object</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">redisTemplate</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> RedisTemplate</span><span style="color:#ABB2BF">&lt;&gt;();</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setConnectionFactory</span><span style="color:#ABB2BF">(redisConnectionFactory);</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setKeySerializer</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> StringRedisSerializer</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setValueSerializer</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> GenericJackson2JsonRedisSerializer</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setHashKeySerializer</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> StringRedisSerializer</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setHashValueSerializer</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> GenericJackson2JsonRedisSerializer</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">afterPropertiesSet</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> redisTemplate;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>自定义 <code>ChatMemoryStore</code> 实现类，定义持久化策略：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> RedisChatMemoryStore</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> ChatMemoryStore</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> CHAT_MEMORY_PREFIX </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "CHAT_MEMORY:"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> RedisTemplate</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> redisTemplate</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">ChatMessage</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> getMessages</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> value</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">opsForValue</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(CHAT_MEMORY_PREFIX </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> memoryId);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> ChatMessageDeserializer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">messagesFromJson</span><span style="color:#ABB2BF">(value);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> updateMessages</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">ChatMessage</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">messages</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">opsForValue</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">set</span><span style="color:#ABB2BF">(CHAT_MEMORY_PREFIX </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> memoryId, </span><span style="color:#E5C07B">ChatMessageSerializer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">messagesToJson</span><span style="color:#ABB2BF">(messages));</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> deleteMessages</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> memoryId</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        redisTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">delete</span><span style="color:#ABB2BF">(CHAT_MEMORY_PREFIX </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> memoryId);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>定义 LLM 配置类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> RedisChatMemoryStore</span><span style="color:#E06C75"> redisChatMemoryStore</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatPersistenceAssistant</span><span style="color:#61AFEF"> chatPersistenceAssistant</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModel</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ChatMemoryProvider</span><span style="color:#E06C75"> provider</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> memoryId </span><span style="color:#C678DD">-&gt;</span><span style="color:#E5C07B"> MessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">id</span><span style="color:#ABB2BF">(memoryId)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">maxMessages</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1000</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatMemoryStore</span><span style="color:#ABB2BF">(redisChatMemoryStore)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatPersistenceAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatModel</span><span style="color:#ABB2BF">(chatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatMemoryProvider</span><span style="color:#ABB2BF">(provider)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后又是「酣畅淋漓」的使用：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ChatPersistenceController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatPersistenceAssistant</span><span style="color:#E06C75"> chatPersistenceAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-persistence/redis"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        chatPersistenceAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"你好，我的名字是 redis"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        chatPersistenceAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"你好，我的名字是 nacos"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat1</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> chatPersistenceAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"我的名字是什么？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat1);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat2</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> chatPersistenceAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2L</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"我的名字是什么？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat2);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#98C379"> "success: "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="11-Tools-Function-Calling"><a class="header-anchor" href="#11-Tools-Function-Calling"></a>11. Tools (Function Calling)</h1>
<h2 id="11-1-官方介绍"><a class="header-anchor" href="#11-1-官方介绍"></a>11.1 官方介绍</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/tools">Tools (Function Calling)</a></p>
<p>一些 LLM （并非所有）除了生成文本外，还可以触发操作。</p>
<p>有一个被称为「tools（工具）」或「function calling（函数调用）」的概念。它允许 LLM 在必要时调用一个或多个由开发者定义、可用的工具。这个工具可以是任何东西：网络搜索、调用外部 API 或执行特定的代码等等。LLM 自身并不能调用工具，而是在响应中表达调用特定工具的意图（不是以纯文本的形式回答）。作为开发者，我们应该用提供的参数执行这个工具，并报告工具的执行结果。</p>
<p>例如，我们知道 LLM 自身并不擅长数学计算。如果你的用例偶尔涉及到数学计算，你可能需要为 LLM 提供一个「数学工具」。通过在向 LLM 的请求中声明一个或多个工具，LLM 可以决定调用一个它认为合适的工具。给定一个数学问题和一系列「数学工具」，LLM 为了正确地回答问题，它应该首先调用提供的数学工具。</p>
<p>简单来说，就是给 LLM 配一个调用的外部工具类。</p>
<p>LLM 不仅仅是文本生成的能手，它们还能触发并调用第三方函数，比如微信查询、快递单号查询等等。使用 Tools，可以将 LLM 的智能与外部工具或 API 无缝衔接。注意，LLM 本身并不执行函数，它只指示应该如何调用函数。</p>
<p>那咋使用呢？</p>
<p>LangChain4J 提供了关于使用 tools 的两个抽象级别：</p>
<ul>
<li>低阶：使用 <code>ChatModel</code> 和 <code>ToolSpecification</code></li>
<li>高阶：使用 AI Service 和带有 <code>@Tools</code> 注解的 Java 方法</li>
</ul>
<h2 id="11-2-低阶-API"><a class="header-anchor" href="#11-2-低阶-API"></a>11.2 低阶 API</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/tools#low-level-tool-api">Low Level Tool API</a></p>
<p>定义 AI Service 接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> FunctionAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> message</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在配置类中手动指定工具说明、执行工具的业务逻辑：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // --snip--</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> FunctionAssistant</span><span style="color:#61AFEF"> functionAssistant</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModel</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 工具说明</span></span>
<span class="line"><span style="color:#E5C07B">        ToolSpecification</span><span style="color:#E06C75"> toolSpecification</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> ToolSpecification</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">name</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"开具发票助手"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">description</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"根据用户提供的开票信息，开具发票"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">parameters</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E5C07B">                        JsonObjectSchema</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                                .</span><span style="color:#61AFEF">addStringProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"companyName"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"公司名称"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                                .</span><span style="color:#61AFEF">addStringProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"dutyNumber"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"税号序列"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                                .</span><span style="color:#61AFEF">addStringProperty</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"amount"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"开票金额，保留两位有效数字"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                )</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 业务逻辑</span></span>
<span class="line"><span style="color:#E5C07B">        ToolExecutor</span><span style="color:#E06C75"> toolExecutor</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (req, memoryId) </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">req</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">id</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">req</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">name</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">            String</span><span style="color:#E06C75"> args</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> req</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">arguments</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"args: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> args);</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#98C379"> "开具成功"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FunctionAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatModel</span><span style="color:#ABB2BF">(chatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">tools</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Map</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">(toolSpecification, toolExecutor))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后是「紧张刺激」的测试：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ChatFunctionCallingController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> FunctionAssistant</span><span style="color:#E06C75"> functionAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-function/test"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> chat</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> functionAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"开张发票，公司：啥都有小卖部 税号：everything666 金额：888"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(chat);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#98C379"> "success: "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> LocalDateTime</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">now</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "&lt;br /&gt;"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> chat;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="11-3-高阶-API"><a class="header-anchor" href="#11-3-高阶-API"></a>11.3 高阶 API</h2>
<p>使用 <code>@Tools</code> 注解可以更方便地集成函数调用，只需用 <code>@Tools</code> 标记 Java 方法，LangChain4J 就可以自动地将其转换为 <code>ToolSpecification</code>。</p>
<p>需求：查询某地实时的天气预报。</p>
<p>不再手动创建 <code>ToolSpecification</code> 对象，而是使用 <code>@Tool</code> 和 <code>@P</code> 注解完成。</p>
<p>新增 <code>WeatherAssistant</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> WeatherAssistant</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> message</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>定义 <code>WeatherTools</code> 类，用于获取某地的实时天气预报：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> WeatherTools</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * 一个免费、免注册的天气 API，有使用频率限制，但测试够了</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     */</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> BASE_URL </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "https://cn.apihz.cn/api/tianqi/tqyb.php?id=88888888&amp;key=88888888&amp;sheng=%s&amp;place=%s"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Tool</span><span style="color:#E06C75">(</span><span style="color:#98C379">"返回给定省、市的天气预报"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getWeather</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">P</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"省"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> sheng</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">                             @</span><span style="color:#E5C07B">P</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"市"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> place</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> getRealWeather</span><span style="color:#ABB2BF">(sheng, place);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getRealWeather</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> sheng</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> place</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> url</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> String</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">format</span><span style="color:#ABB2BF">(BASE_URL, sheng, place);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 用 JDK 自带的</span></span>
<span class="line"><span style="color:#E5C07B">        HttpRequest</span><span style="color:#E06C75"> request</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> HttpRequest</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">newBuilder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">uri</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">URI</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(url))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">header</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Content-Type"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"application/json"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">GET</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> weather</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">HttpClient</span><span style="color:#E06C75"> client</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> HttpClient</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">newBuilder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">connectTimeout</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Duration</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ofMillis</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">500</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#E5C07B">            HttpResponse</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">resp</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> client</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">send</span><span style="color:#ABB2BF">(request, </span><span style="color:#E5C07B">HttpResponse</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">BodyHandlers</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ofString</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///  {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "precipitation": 0,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "temperature": 31.8,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "pressure": 945,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "humidity": 67,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "windDirection": "东南风",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "windDirectionDegree": 114,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "windSpeed": 0.4,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "windScale": "微风",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "feelst": 37.3,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "code": 200,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "place": "中国, 四川, 成都",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "weather1": "阵雨",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "weather2": "阵雨",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "weather1img": "https://rescdn.apihz.cn/resimg/tianqi/zhenyu.png",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "weather2img": "https://rescdn.apihz.cn/resimg/tianqi/zhenyu.png",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "uptime": "2025/07/19 16:20",</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            ///     "jieqi": ""</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            /// }</span></span>
<span class="line"><span style="color:#ABB2BF">            weather </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> resp</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">body</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#ABB2BF"> | </span><span style="color:#E5C07B">InterruptedException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> RuntimeException</span><span style="color:#ABB2BF">(e);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> weather;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>创建 <code>WeatherAssistant</code> AI Service 时指定可使用的工具：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> WeatherTools</span><span style="color:#61AFEF"> weatherService</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> WeatherTools</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> WeatherAssistant</span><span style="color:#61AFEF"> weatherAssistant</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75"> chatModel</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> WeatherTools</span><span style="color:#E06C75"> weatherTools) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">WeatherAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">chatModel</span><span style="color:#ABB2BF">(chatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">tools</span><span style="color:#ABB2BF">(weatherTools)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>「震撼人心」的调用：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> WeatherAssistant</span><span style="color:#E06C75"> weatherAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/chat-function/weather"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> getWeather</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> weatherAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"今天成都的天气怎么样？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="12-向量数据库"><a class="header-anchor" href="#12-向量数据库"></a>12. 向量数据库</h1>
<h2 id="12-1-相关概念"><a class="header-anchor" href="#12-1-相关概念"></a>12.1 相关概念</h2>
<blockquote>
<p>Vector</p>
</blockquote>
<p>Vector，向量（数学概念）、矢量（物理概念）。</p>
<p>向量是用于表示具有大小和方向的量。</p>
<p>向量可以在不同的维度空间中定义，最常见的是二维和三维空间中的向量，但理论上也可以有更高维的向量。例如在二维平面上的一个向量可以写作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>，这里 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 分别表示该向量沿两个坐标轴方向上的分量；而在三维空间里，则会有一个额外的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> 坐标，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x,y,z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>。</p>
<blockquote>
<p>向量化</p>
</blockquote>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E5%90%91%E9%87%8F%E5%8C%96.png" alt="向量化"></p>
<p>向量化是将数据转化为向量形式的过程，使得计算机能够更有效地处理和理解复杂信息。</p>
<blockquote>
<p>维度</p>
</blockquote>
<p>维度，Dimensions。</p>
<p>在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x-y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 坐标系中，每个数值向量都有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 坐标（或者在多维系统中的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>…）。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 是这个向量空间的轴，成为维度。</p>
<p>对于想要表示为向量的一些非数值实体，需要先决定其维度，并为每个实体在每个维度分配一个值。</p>
<p>例如在一个交通工具数据集中，可以定义四个维度：</p>
<ol>
<li>轮子数量</li>
<li>是否有发动机</li>
<li>是否可以在地上开动</li>
<li>最大乘客数</li>
</ol>
<p>然后可以将一些交通工具表示为：</p>
<table>
<thead>
<tr>
<th style="text-align:center">item</th>
<th style="text-align:center">number of wheels</th>
<th style="text-align:center">has an engine</th>
<th style="text-align:center">moves on land</th>
<th style="text-align:center">max occupants</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">car</td>
<td style="text-align:center">4</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">bicycle</td>
<td style="text-align:center">2</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">tricycle</td>
<td style="text-align:center">3</td>
<td style="text-align:center">no</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">motorcycle</td>
<td style="text-align:center">2</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">sailboat</td>
<td style="text-align:center">0</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">ship</td>
<td style="text-align:center">0</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
<td style="text-align:center">1000</td>
</tr>
</tbody>
</table>
<p>可以使用向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>4</mn><mo separator="true">,</mo><mi>y</mi><mi>e</mi><mi>s</mi><mo separator="true">,</mo><mi>y</mi><mi>e</mi><mi>s</mi><mo separator="true">,</mo><mn>5</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(4, yes, yes, 5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">yes</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">yes</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">5</span><span class="mclose">)</span></span></span></span> 来表示汽车 car，如果将 yes 设置为 1，no 设置为 0，可以进一步简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>4</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>5</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(4, 1, 1, 5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">5</span><span class="mclose">)</span></span></span></span>。</p>
<p><strong>向量的每个维度代表数据的不同特性，维度越多对事物的描述越精准。</strong></p>
<blockquote>
<p>如何确定最相似？</p>
</blockquote>
<p>在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x-y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 坐标系中的每个向量都有一个长度和方向。例如下图中的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span> 指向了相同的方法，但长度不同。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> 指向相反的方向，但拥有相似的长度。此外还有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span>，长度比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 短一点，方向也不相同，但很接近。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/x-y%E5%9D%90%E6%A0%87%E7%B3%BB%E4%B8%AD%E5%90%91%E9%87%8F%E7%9A%84%E7%9B%B8%E4%BC%BC%E6%80%A7.png" alt="x-y坐标系中向量的相似性"></p>
<p>那么哪一个最接近 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> 呢？</p>
<p>如果「相似」仅仅意味着指向相似的方向，那么 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span> 最接近 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>；如果「相似」仅仅意为着相似的长度，那么 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> 最接近 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>。</p>
<p>由于向量通常用于描述语义，仅仅看长度无法满足需求。</p>
<p><strong>大多数相似度的测量要么仅依赖于方向，要么同时考虑方向和大小。</strong></p>
<h2 id="12-2-Embedding-Model"><a class="header-anchor" href="#12-2-Embedding-Model"></a>12.2 Embedding Model</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#embedding-model">Embedding Model</a></p>
<p><code>EmbeddingModel</code> 接口代表一种特殊类型的模型，可以将文本转换为 Embedding。</p>
<p>目前支持的 Embedding Model：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/category/embedding-models/">Embedding Models</a></p>
<p>使用方式：</p>
<ul>
<li><code>EmbeddingModel.embed(String)</code> 嵌入给定文本</li>
<li><code>EmbeddingModel.embed(TextSegment)</code> 嵌入给定的 <code>TextSegment</code></li>
<li><code>EmbeddingModel.embedAll(List&lt;TextSegment&gt;)</code> 嵌入所有给定的 <code>TextSegment</code></li>
<li><code>EmbeddingModel.dimension()</code> 返回该模型产生的 Embedding 的维度</li>
</ul>
<blockquote>
<p>什么是 Embedding？</p>
</blockquote>
<p>Embedding，嵌入，其工作原理是将文本、图形和视频转换为向量（Vectors）的浮点数数组。这些向量旨在捕捉文本、图像和视频的含义。嵌入数组的长度成为向量的维度（Dimensionality）。</p>
<p>嵌入模型（EmbeddingModel）是嵌入过程中采用的模型。当前 EmbeddingModel 的接口主要用于将文本转换为数值向量，接口的设计主要围绕这两个目标展开：</p>
<ol>
<li>可移植性：该接口确保在各种嵌入模型之间的轻松适配。它允许开发者在不同的嵌入技术或模型之间切换，所需的代码更改最小化，这一设计与 Spring 模块化和互换性的理念一致。</li>
<li>简单性：嵌入模型简化了文本转换为嵌入的过程。通过提供如 <code>embed(String text)</code> 和 <code>embed(Document document)</code> 这样简单的方法，去除处理原始文本数据和嵌入算法的复杂性。这个设计选择使开发者（尤其是那些初次接触 AI 的开发者），更容易在他们的应用程序中使用嵌入，而无需深入了解其底层机制。</li>
</ol>
<h2 id="12-3-Embedding-Store"><a class="header-anchor" href="#12-3-Embedding-Store"></a>12.3 Embedding Store</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#embedding-store">Embedding Store</a></p>
<p><code>EmbeddingStore</code> 接口表示 Embedding 的存储空间，也成为向量数据库。它允许存储和搜索相似的 Embedding。</p>
<p>目前支持的 Embedding Store：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/integrations/embedding-stores">Comparison table of all supported Embedding Stores</a></p>
<p><code>EmbeddingStore</code> 可以单独存储 Embedding，也可以与相应的 <code>TextSegment</code> 一起存储：</p>
<ul>
<li>它只能按 ID 存储 Embedding。原始嵌入数据可以存储在其他地方，并使用 ID 进行关联。</li>
<li>它可以同时存储 Embedding 和已嵌入的原始数据（通常是 <code>TextSegment</code>）。</li>
</ul>
<blockquote>
<p>Vector Store</p>
</blockquote>
<p>向量存储（Vector Store）是一种用于存储和检索高维向量数据的数据库或存储解决方案，它特别适用于处理那些经过嵌入模型转换后的数据。在 Vector Store 中，查询与传统关系型数据库不一样，它们执行相似性搜索，而不是精准匹配。当给定一个向量作为查询时，Vector Store 返回与查询向量「相似」的向量。</p>
<p>Vector Store 用于将您的数据与 AI 模型集成。在使用它们时的第一步是将您的数据加载到矢量数据库中。当用户将查询发送到 AI 模型时，首先检索一组相似文档。这些文档作为用户问题的上下文，并与用户的查询一起发送到 AI 模型。这种技术也被称为检索增强生成（Retrieval Augmented Generation，RAG）。</p>
<blockquote>
<p>EmbeddingSearchRequest</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#embeddingsearchrequest">EmbeddingSearchRequest</a></p>
<p><code>EmbeddingSearchRequest</code> 表示在 <code>EmbeddingStore</code> 中进行搜索的请求。它具有以下属性：</p>
<ul>
<li><code>Embedding queryEmbedding</code>：用作参考的 Embedding</li>
<li><code>int maxResults</code>：返回结果的最大数量。这是一个可选参数。默认值 <code>3</code></li>
<li><code>double minScore</code>：最小分数，范围 0 到 1（包括 1）。只有得分不小于 <code>minScore</code> 的 Embedding 才会被返回。这也是一个可选参数。默认值 <code>0</code></li>
<li><code>Filter filter</code>：用于搜索 <code>Metadata</code> 的过滤器。只有 <code>Metadata</code> 符合该 <code>Filter</code> 的 <code>TextSegment</code> 才会被返回。</li>
</ul>
<h2 id="12-4-特征点总结"><a class="header-anchor" href="#12-4-特征点总结"></a>12.4 特征点总结</h2>
<p>向量数据库能够：</p>
<ol>
<li>捕捉复杂的词汇关系（语义相似性、同义词、多义词）</li>
<li>超越传统词袋模型的简单计数方式</li>
<li>动态嵌入模型（如 BERT）可根据上下文生成不同的词向量</li>
<li>向量嵌入为现代搜索和检索增强生成（RAG）应用程序提供支持</li>
</ol>
<p>即：将文本映射到高维空间中的点，使语义相似的文本在这个空间中距离接近。</p>
<h2 id="12-5-编码实现"><a class="header-anchor" href="#12-5-编码实现"></a>12.5 编码实现</h2>
<p>本次选用 <a target="_blank" rel="noopener" href="https://qdrant.tech/">Qdrant</a> 作为使用的向量数据库。</p>
<p>Qdrant 是一个高性能的向量数据库，用于存储 Embedding 并进行快速的向量搜索。</p>
<p>安装 Qdrant：</p>
<figure class="highlight shell line-numbers" data-language="SHELL">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#61AFEF">docker</span><span style="color:#98C379"> run</span><span style="color:#D19A66"> -p</span><span style="color:#98C379"> 6333:6333</span><span style="color:#D19A66"> -p</span><span style="color:#98C379"> 6334:6334</span><span style="color:#98C379"> qdrant/qdrant</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中：</p>
<ul>
<li><code>6333</code> 端口用于 HTTP API，浏览器 Web 界面</li>
<li><code>6334</code> 端口用于 gRPC API</li>
</ul>
<p>在浏览器中访问 <code>http://localhost:6333/</code>，如果出现类似以下信息，则证明启动成功：</p>
<figure class="highlight json line-numbers" data-language="JSON">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#E06C75">    "title"</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">"qdrant - vector search engine"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E06C75">    "version"</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">"1.15.0"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E06C75">    "commit"</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">"137b6c1e4a91320e4658987d47f235078fb0ab11"</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>访问 <code>http://localhost:6333/dashboard#/collections</code>  时能够进入 Qdrant 的后台。</p>
<p>工程中引入 Qdrant 相关依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-qdrant&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>更换模型为 <code>text-embedding-v3</code> 并在配置类完成 Qdrant 的相关配置：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> EmbeddingModel</span><span style="color:#61AFEF"> embeddingModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiEmbeddingModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 更换模型名称</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"text-embedding-v3"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * 创建 Qdrant 客户端</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     */</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> QdrantClient</span><span style="color:#61AFEF"> qdrantClient</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        QdrantGrpcClient</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#ABB2BF"> builder</span></span>
<span class="line"><span style="color:#56B6C2">                =</span><span style="color:#E5C07B"> QdrantGrpcClient</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">newBuilder</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"127.0.0.1"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">6334</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">false</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> QdrantClient</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> EmbeddingStore</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> embeddingStore</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> QdrantEmbeddingStore</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">host</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"127.0.0.1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">port</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">6334</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">collectionName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"test-qdrant"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>先测试下文本向量化：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> EmbeddingModel</span><span style="color:#E06C75"> embeddingModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 文本向量化测试，查看形成向量后的文本</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/embedding/embed"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> embed</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> prompt </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> """</span></span>
<span class="line"><span style="color:#98C379">               咏鸡</span></span>
<span class="line"><span style="color:#98C379">            鸡鸣破晓光，</span></span>
<span class="line"><span style="color:#98C379">            红冠映朝阳。</span></span>
<span class="line"><span style="color:#98C379">            金羽披霞彩，</span></span>
<span class="line"><span style="color:#98C379">            昂首步高岗。</span></span>
<span class="line"><span style="color:#98C379">            """</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Response</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Embedding</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> embeddingResponse </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> embeddingModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">embed</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> embeddingResponse</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">content</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>存储向量时，需要先创建数据库实例：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> QdrantClient</span><span style="color:#E06C75"> qdrantClient</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 新增向量数据库实例和创建索引：test-qdrant</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 类似于 MySQL `CREATE DATABASE test-qdrant`</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "/embedding/create-collection"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> createCollection</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">    var</span><span style="color:#E06C75"> vectorParams </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Collections</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">VectorParams</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">newBuilder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">setDistance</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collections</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Distance</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Cosine</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">setSize</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1024</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    qdrantClient</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">createCollectionAsync</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"test-qdrant"</span><span style="color:#ABB2BF">, vectorParams);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>向向量数据库中添加信息：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 往向量数据库新增文本记录</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "/embedding/add"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> add</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> prompt </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> """</span></span>
<span class="line"><span style="color:#98C379">               咏鸡</span></span>
<span class="line"><span style="color:#98C379">            鸡鸣破晓光，</span></span>
<span class="line"><span style="color:#98C379">            红冠映朝阳。</span></span>
<span class="line"><span style="color:#98C379">            金羽披霞彩，</span></span>
<span class="line"><span style="color:#98C379">            昂首步高岗。</span></span>
<span class="line"><span style="color:#98C379">            """</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    TextSegment</span><span style="color:#E06C75"> segment </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> TextSegment</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(prompt);</span></span>
<span class="line"><span style="color:#E5C07B">    segment</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">metadata</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"author"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"mofan"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Embedding</span><span style="color:#E06C75"> embedding </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> embeddingModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">embed</span><span style="color:#ABB2BF">(segment).</span><span style="color:#61AFEF">content</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> embeddingStore</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(embedding, segment);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>最后再测试：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "/embedding/query1"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> query1</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Embedding</span><span style="color:#E06C75"> queryEmbedding </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> embeddingModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">embed</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"咏鸡说的是什么"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">content</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    EmbeddingSearchRequest</span><span style="color:#E06C75"> req </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> EmbeddingSearchRequest</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">queryEmbedding</span><span style="color:#ABB2BF">(queryEmbedding)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">maxResults</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    EmbeddingSearchResult</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> embeddingStore</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">search</span><span style="color:#ABB2BF">(req);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> result</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">matches</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getFirst</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">embedded</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">text</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "/embedding/query2"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> query2</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Embedding</span><span style="color:#E06C75"> queryEmbedding </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> embeddingModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">embed</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"咏鸡"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">content</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    EmbeddingSearchRequest</span><span style="color:#E06C75"> req </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> EmbeddingSearchRequest</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">queryEmbedding</span><span style="color:#ABB2BF">(queryEmbedding)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">filter</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">MetadataFilterBuilder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">metadataKey</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"author"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">isEqualTo</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"mofan212"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">maxResults</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    EmbeddingSearchResult</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> embeddingStore</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">search</span><span style="color:#ABB2BF">(req);</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">EmbeddingMatch</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> list </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> result</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">matches</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#98C379"> "未查询到指定内容"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getFirst</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">embedded</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">text</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="13-RAG"><a class="header-anchor" href="#13-RAG"></a>13. RAG</h1>
<h2 id="13-1-相关概念"><a class="header-anchor" href="#13-1-相关概念"></a>13.1 相关概念</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag">RAG </a></p>
<p>LLM 的知识仅限于训练数据。如果想要让 LLM 了解特定领域的知识或专有数据，可以：</p>
<ul>
<li>使用 RAG</li>
<li>使用您的数据微调大模型</li>
<li>结合 RAG 和微调</li>
</ul>
<blockquote>
<p>什么是 RAG</p>
</blockquote>
<p>RAG，Retrieval-Augmented Generation，检索增强生成。</p>
<p>简单来说，RAG 是在将提示词发送给 LLM 前，从给定数据中找到相关信息并注入到提示词中的方式。这样 LLM 就能够获取到相关信息，并使用这些信息进行回复，从而降低出现「幻觉」的概率。</p>
<p>可以使用各种信息检索方式找到相关信息，最常用的方法有：</p>
<ul>
<li>全文（关键词）检索</li>
<li>向量（矢量）检索</li>
<li>混合检索（全文 + 向量）</li>
</ul>
<p>前面提到的「幻觉」又是什么呢？</p>
<ul>
<li>已读乱回</li>
<li>已读不回</li>
<li>似是而非</li>
</ul>
<p>RAG 给 LLM 装上了「实时百科大脑」，为了让 LLM 获取足够的上下文，以便获取到更广泛的信息源，通过先查资料再回答的机制，让 LLM 摆脱「知识遗忘和幻觉回复」的困境。</p>
<h2 id="13-2-RAG-Stages"><a class="header-anchor" href="#13-2-RAG-Stages"></a>13.2 RAG Stages</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#rag-stages">RAG Stages</a></p>
<p>RAG 过程分为两个明确的阶段：索引和检索。LangChain4j 为这两个阶段都提供了工具。</p>
<blockquote>
<p>Indexing（索引）</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#indexing">Indexing</a></p>
<p>在索引阶段会对给定文档进行预处理，以便在检索阶段进行高效地搜索。</p>
<p>这一过程会根据使用的信息检索方式发生变化。对于向量搜索，这通常包括清理文档、用附加数据和元数据补充文档、将文档分割成更小的片段（分块）、嵌入（embedding）这些片段，最后将它们存储到向量数据库中。</p>
<p>索引阶段通常是离线进行的，这意味着终端用户无需等待索引完成。例如，可以每周末定时对公司内部文档进行一次索引操作。负责检索的代码可以是一个只处理索引任务的单个应用程序。</p>
<p>然而在某些情况下，终端用户可能希望上传自己的定制文档，以便 LLM 能够访问这些文件。在这种情况下，索引应该在线进行，并成为主应用程序的一部分。</p>
<p>下面是索引阶段的简化流程图：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E7%B4%A2%E5%BC%95%E9%98%B6%E6%AE%B5%E7%AE%80%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="索引阶段简化流程图"></p>
<blockquote>
<p>Retrieval（检索）</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#retrieval">Retrieval</a></p>
<p>检索阶段通常是在线进行的，当用户提交一个问题时，将使用索引的文档给出答案。</p>
<p>这一过程会根据使用的信息检索方式发生变化。对于向量搜索，这通常包括嵌入（embedding）用户的查询（问题），并在向量数据库中执行相似性搜索，最后将相关片段（原始文档中的片段）注入到提示词中并发送给 LLM。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/%E6%A3%80%E7%B4%A2%E9%98%B6%E6%AE%B5%E7%AE%80%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="检索阶段简化流程图"></p>
<h2 id="13-3-核心-API"><a class="header-anchor" href="#13-3-核心-API"></a>13.3 核心 API</h2>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#core-rag-apis">Core RAG APIs</a></p>
<blockquote>
<p>Embedding Store Ingestor</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#embedding-store-ingestor">Embedding Store Ingestor</a></p>
<p>LangChain4j 中存在名为 <code>EmbeddingStoreIngestor</code> 的类，其内部有 5 个成员变量：</p>
<ol>
<li><code>DocumentTransformer documentTransformer</code>：文档转换</li>
<li><code>DocumentSplitter documentSplitter</code>：文档分割</li>
<li><code>TextSegmentTransformer textSegmentTransformer</code>：转换单个文本段（用于标准化或清理）</li>
<li><code>EmbeddingModel embeddingModel</code>：文本段向量化</li>
<li><code>EmbeddingStore&lt;TextSegment&gt; embeddingStore</code>：存储生成的嵌入向量及其对应的文本段</li>
</ol>
<blockquote>
<p>Document Loader</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#document-loader">Document Loader</a></p>
<p>可以根据一个 <code>String</code> 创建一个 <code>Document</code> 对象，但更简单的方式是通过 LangChain4j 中内置的文档加载器创建，比如：</p>
<ul>
<li><code>FileSystemDocumentLoader</code>：从文档系统中加载</li>
<li><code>UrlDocumentLoader</code>：从 URL 中加载</li>
<li><code>AmazonS3DocumentLoader</code>：从 Amazon S3 中加载</li>
<li><code>AzureBlobStorageDocumentLoader</code>：从 Azure BLOB 中加载</li>
<li><code>GitHubDocumentLoader</code>：从 GitHub 中加载</li>
<li><code>TencentCosDocumentLoader</code>：从腾讯云中加载</li>
</ul>
<blockquote>
<p>Document Parser</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#document-parser">Document Parser</a></p>
<p><code>Document</code> 代表各种格式的文件，比如 PDF、DOC、TXT 等等。为了解析这些格式，LangChain4j 提供了 <code>DocumentParser</code> 接口及多种实现：</p>
<ul>
<li><code>TextDocumentParser</code>：解析纯文本格式的文档，比如 TXT、HTML、MD 等等</li>
<li><code>ApachePdfBoxDocumentParser</code>：解析 PDF</li>
<li><code>ApachePoiDocumentParser</code>：解析 MS Office 格式的文档，比如 DOC、DOCX、PPT、PPTX、XLS、XLSX 等等</li>
<li><code>ApacheTikaDocumentParser</code>：自动检测并解析几乎所有格式的文档 😲</li>
</ul>
<blockquote>
<p>Document Transformer</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#document-transformer">Document Transformer </a></p>
<p>对文档执行各种转换，包括清理、过滤、增强或总结。</p>
<p>没有通用的解决方案，需要根据需求自行实现 <code>DocumentTransformer</code>。</p>
<blockquote>
<p>Document Splitter</p>
</blockquote>
<p>官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#document-splitter">Document Splitter</a></p>
<p>LangChain4j 提供了 <code>DocumentSplitter</code> 接口，及多种开箱即用的实现：</p>
<ul>
<li><code>DocumentByParagraphSplitter</code>：按段落拆分</li>
<li><code>DocumentBySentenceSplitter</code>：按句子拆分</li>
<li><code>DocumentByWordSplitter</code>：按单词拆分</li>
<li><code>DocumentByCharacterSplitter</code>：按字符拆分</li>
<li><code>DocumentByRegexSplitter</code>：按正则拆分</li>
</ul>
<blockquote>
<p>构建 RAG 一般步骤</p>
</blockquote>
<ol>
<li>加载文档：使用适当的 <code>DocumentLoader</code> 和 <code>DocumentParser</code> 加载文档</li>
<li>转换文档：使用 <code>DocumentTransformer</code> 清理或增强文档（可选）</li>
<li>拆分文档：使用 <code>DocumentSplitter</code> 将文档拆分为更小的片段（可选）</li>
<li>嵌入文档：使用 <code>EmbeddingModel</code> 将文档片段转换为嵌入向量</li>
<li>存储嵌入：使用 <code>EmbeddingStoreIngestor</code> 存储嵌入向量</li>
<li>检索相关内容：根据用户查询，从 <code>EmbeddingStore</code> 检索最相关的文档片段</li>
<li>生成响应：将检索到的相关内容与用户查询一起提供给语言模型，生成最终响应</li>
</ol>
<h2 id="13-4-简单实现"><a class="header-anchor" href="#13-4-简单实现"></a>13.4 简单实现</h2>
<p>本节只做最简单的 <a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/rag#easy-rag">Easy RAG</a> 演示。</p>
<p>引入依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-easy-rag&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>不使用向量数据库，简单起见，在内存中存储 Embeddding：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> LLMConfig</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatModel</span><span style="color:#61AFEF"> chatModel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> OpenAiChatModel</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">apiKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"AliQwen_Key"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">modelName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"qwen-plus"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">baseUrl</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     * 为了简单起见，现在将使用内存中的嵌入存储</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">     */</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> InMemoryEmbeddingStore</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> embeddingStore</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> InMemoryEmbeddingStore</span><span style="color:#ABB2BF">&lt;&gt;();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#61AFEF"> assistant</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatModel</span><span style="color:#E06C75;font-style:italic"> chatModel</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">EmbeddingStore</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75;font-style:italic">embeddingStore</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ChatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatModel</span><span style="color:#ABB2BF">(chatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">chatMemory</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">MessageWindowChatMemory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">withMaxMessages</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">contentRetriever</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">EmbeddingStoreContentRetriever</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(embeddingStore))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>简单测试下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> RAGController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> InMemoryEmbeddingStore</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">TextSegment</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> embeddingStore</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> ChatAssistant</span><span style="color:#E06C75"> chatAssistant</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/rag/add"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> MalformedURLException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // about me</span></span>
<span class="line"><span style="color:#E5C07B">        URI</span><span style="color:#E06C75"> uri</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> URI</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"https://mofan212.github.io/mine/"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Document</span><span style="color:#E06C75"> document</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> UrlDocumentLoader</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">load</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E5C07B">                uri</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toURL</span><span style="color:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#C678DD">                new</span><span style="color:#61AFEF"> ApacheTikaDocumentParser</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">        );</span></span>
<span class="line"><span style="color:#E5C07B">        EmbeddingStoreIngestor</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ingest</span><span style="color:#ABB2BF">(document, embeddingStore);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> chatAssistant</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"如何联系默烦？"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="14-MCP"><a class="header-anchor" href="#14-MCP"></a>14. MCP</h1>
<h2 id="14-1-相关概念"><a class="header-anchor" href="#14-1-相关概念"></a>14.1 相关概念</h2>
<p>LangChain4j 官方介绍：<a target="_blank" rel="noopener" href="https://docs.langchain4j.dev/tutorials/mcp">Model Context Protocol (MCP)</a></p>
<p>MCP 官方介绍：<a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/introduction">Introduction - Model Context Protocol</a></p>
<p>MCP，Model Context Protocol，模型上下文协议。</p>
<p>MCP 是一种开放协议，它规范了应用程序向 LLM 提供上下文的方式。把 MCP 想象成 AI 应用程序的 USB-C 接口，就像 USB-C 接口提供了将设备连接到各种外设和配件，MCP 也提供了将 AI 模型连接到不同数据源和工具（Tool）的标准化方式。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/AIImages/MCP%E6%9E%B6%E6%9E%84%E5%9B%BE%E7%A4%BA.png" alt="MCP架构图示"></p>
<p>MCP 协议规定了两种传输类型，这在 LangChain4j 中都得到了支持：</p>
<ul>
<li><code>HTTP</code>：客户端请求 SSE 通道接收来自服务器的事件，然后通过 HTTP POST 请求发送命令。</li>
<li><code>stdio</code>：客户端可以将 MCP 服务器作为本地子进程运行，并通过标准输入/输出与之直接通信。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">特新</th>
<th style="text-align:center">SSE</th>
<th style="text-align:center">STDIO</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">传输协议</td>
<td style="text-align:center">HTTP（长连接）</td>
<td style="text-align:center">操作系统级文件描述符</td>
</tr>
<tr>
<td style="text-align:center">方向</td>
<td style="text-align:center">服务器到客户端（单向传输）</td>
<td style="text-align:center">双向流（stdin，stdout）</td>
</tr>
<tr>
<td style="text-align:center">保持连接</td>
<td style="text-align:center">长连接（Connection: keep-alive）</td>
<td style="text-align:center">不保证长时间打开，取决于进程生命周期</td>
</tr>
<tr>
<td style="text-align:center">数据格式</td>
<td style="text-align:center">文本流（EventStream 格式）</td>
<td style="text-align:center">原始字节流</td>
</tr>
<tr>
<td style="text-align:center">异常处理</td>
<td style="text-align:center">可通过 HTTP 状态码或重连机制</td>
<td style="text-align:center">进程退出或管道断裂</td>
</tr>
</tbody>
</table>
<p>MCP 可以类比于 OpenFeign，前者用于大模型之间的通讯，后者用于微服务之间的通讯。</p>
<p>MCP 是比 Tools(Function Calling) 更高一级的抽象，也是实现智能体 Agent 的基础。</p>
<p>访问 <a target="_blank" rel="noopener" href="https://mcp.so/">MCP.so</a> 选择调用的 MCP Server。</p>
<h2 id="14-2-通用架构"><a class="header-anchor" href="#14-2-通用架构"></a>14.2 通用架构</h2>
<p>官方链接：<a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/introduction#general-architecture">General architecture</a></p>
<p>MCP 遵循客户端-服务器架构，其中主机应用程序可以连接到多个服务器：</p>
<pre><code class="highlight mermaid">flowchart LR
    subgraph "Your Computer"
        Host["Host with MCP Client&lt;br/&gt;(Claude, IDEs, Tools)"]
        S1["MCP Server A"]
        S2["MCP Server B"]
        D1[("Local&lt;br/&gt;Data Source A")]
        Host &lt;--&gt;|"MCP Protocol"| S1
        Host &lt;--&gt;|"MCP Protocol"| S2
        S1 &lt;--&gt; D1
    end
    subgraph "Internet"
        S3["MCP Server C"]
        D2[("Remote&lt;br/&gt;Service B")]
        D3[("Remote&lt;br/&gt;Service C")]
        S2 &lt;--&gt;|"Web APIs"| D2
        S3 &lt;--&gt;|"Web APIs"| D3
    end
    Host &lt;--&gt;|"MCP Protocol"| S3</code></pre>
<ul>
<li>MCP Hosts（MCP 主机）：发起请求的 AI 应用程序，比如聊天机器人、AI 驱动的 IDE 等</li>
<li>MCP Clients（MCP 客户端）：在主机程序内部，与 MCP 服务器保持 1:1 的链接</li>
<li>MCP Servers（MCP 服务器）：为 MCP 客户端提供上下文、工具和提示信息</li>
<li>Local Data Sources（本地数据源）：本地计算机中可供 MCP 服务器安全访问的资源，如文件、数据库</li>
<li>Remote Services（远程服务）：MCP 服务器可以连接到的远程资源，如通过 API 提供的数据</li>
</ul>
<h2 id="14-3-简单使用"><a class="header-anchor" href="#14-3-简单使用"></a>14.3 简单使用</h2>
<p>选择 <a target="_blank" rel="noopener" href="https://mcp.so/zh/server/baidu-map/baidu-maps">Baidu Map</a> 作为本次 MCP Server。</p>
<p>预先安装 Node.js。</p>
<p>进入 <a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/">百度地图开发平台</a>，创建应用，获取「访问应用 (AK)」并将其配置到系统环境变量，可以参考百度地图 MCP Server 的介绍，同样以 <code>BAIDU_MAP_API_KEY</code> 作为环境变量名称。</p>
<p>配置完环境变量后，记得重启 IDEA！</p>
<p>引入依赖：</p>
<figure class="highlight xml line-numbers" data-language="XML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-reactor&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-community-dashscope-spring-boot-starter&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;dev.langchain4j&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;langchain4j-mcp&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>修改配置文件：</p>
<figure class="highlight yaml line-numbers" data-language="YAML">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E06C75">server</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  port</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">9994</span></span>
<span class="line"><span style="color:#E06C75">  servlet</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    encoding</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      charset</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">UTF-8</span></span>
<span class="line"><span style="color:#E06C75">      enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span></span>
<span class="line"><span style="color:#E06C75">      force</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">spring</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  application</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    name</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">langchain4j-14chat-mcp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">langchain4j</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  community</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    dashscope</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      streaming-chat-model</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">        api-key</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">${AliQwen_Key}</span></span>
<span class="line"><span style="color:#E06C75">        model-name</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">qwen-plus</span></span>
<span class="line"><span style="color:#E06C75">      chat-model</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">        api-key</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">${AliQwen_Key}</span></span>
<span class="line"><span style="color:#E06C75">        model-name</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">qwen-plus</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>创建 AI Service 接口：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> McpService</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    Flux</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> question</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>先尝试在 cmd 中执行 <code>npx -y @baidumap/mcp-server-baidu-map</code> 命令，查看 MCP 服务端是否能够正常启动。如果不能正常启动，需要查看错误信息并解决。我在此遇到问题，错误信息是「请求 npm 淘宝源下的 baidu map mcp server 失败，原因是证书过期」，于是我将 npm 镜像源又切回默认，然后再尝试执行，提示 <code>Baidu Map MCP Server running on stdio</code>，正常启动 MCP 服务端。</p>
<p>激动人心的测试：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RestController</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> McpCallServerController</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Resource</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> StreamingChatModel</span><span style="color:#E06C75"> streamingChatModel</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/mcp/chat"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Flux</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> chat</span><span style="color:#ABB2BF">(@</span><span style="color:#E5C07B">RequestParam</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"question"</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> question</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        /*</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1. 构建 McpTransport 协议</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1.1 cmd：启动 Windows 命令行解释器。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1.2 /c：告诉 cmd 执行完后面的命令后关闭自身。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1.3 npx：npx = npm execute package，Node.js 的一个工具，用于执行 npm 包中的可执行文件。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1.4 -y 或 --yes：自动确认操作（类似于默认接受所有提示）</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1.5 @baidumap/mcp-server-baidu-map：要通过 npx 执行的 npm 包名</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 1.6 BAIDU_MAP_API_KEY 是访问百度地图开放平台 API 的 AK</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 先尝试在 cmd 中执行 `npx -y @baidumap/mcp-server-baidu-map` 命令，查看 MCP 服务端是否能够正常启动</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 如果不能正常启动，需要查看错误信息并解决。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 我在此遇到问题，错误信息是：请求 npm 淘宝源下的 baidu map mcp server 失败，原因是证书过期</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         * 于是我将 npm 镜像源又切回默认，然后再尝试执行，提示 `Baidu Map MCP Server running on stdio`，正常启动 MCP 服务端</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">         */</span></span>
<span class="line"><span style="color:#E5C07B">        McpTransport</span><span style="color:#E06C75"> transport</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#ABB2BF"> StdioMcpTransport.</span><span style="color:#61AFEF">Builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">command</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">List</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"cmd"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"/c"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"npx"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"-y"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"@baidumap/mcp-server-baidu-map"</span><span style="color:#ABB2BF">))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">environment</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Map</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">of</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"BAIDU_MAP_API_KEY"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getenv</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"BAIDU_MAP_API_KEY"</span><span style="color:#ABB2BF">)))</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 2. 构建 McpClient 客户端</span></span>
<span class="line"><span style="color:#E5C07B">        McpClient</span><span style="color:#E06C75"> mcpClient</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#ABB2BF"> DefaultMcpClient.</span><span style="color:#61AFEF">Builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">transport</span><span style="color:#ABB2BF">(transport)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 3. 创建工具集和原生的 FunctionCalling 类似</span></span>
<span class="line"><span style="color:#E5C07B">        ToolProvider</span><span style="color:#E06C75"> toolProvider</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> McpToolProvider</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">mcpClients</span><span style="color:#ABB2BF">(mcpClient)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 4. 通过 AiServices 给自定义接口 McpService 构建实现类并将工具集和大模型赋值给 AiService</span></span>
<span class="line"><span style="color:#E5C07B">        McpService</span><span style="color:#E06C75"> mcpService</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> AiServices</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">McpService</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">streamingChatModel</span><span style="color:#ABB2BF">(streamingChatModel)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">toolProvider</span><span style="color:#ABB2BF">(toolProvider)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 5.调用定义的接口，通过大模型对百度 MCP Server 进行调用</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E5C07B"> mcpService</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">chat</span><span style="color:#ABB2BF">(question);</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">finally</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            mcpClient</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
</body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Quick-Start-With-LangChain4j/">https://mofan212.github.io/posts/Quick-Start-With-LangChain4j/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AI/">AI</a><a class="post-meta__tags" href="/tags/LangChain4j/">LangChain4j</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/163.png" data-sites="wechat,qq,weibo,facebook,x"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/Functors-Applicatives-And-Monads-In-Pictures/" title="Functors, Applicatives and Monads In Pictures"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/162.webp" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Functors, Applicatives and Monads In Pictures</div></div><div class="info-2"><div class="info-item-1">图解 Functors, Applicatives 和 Monads。</div></div></div></a><a class="pagination-related" href="/posts/Docker-Desktop/" title="Docker Desktop"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/164.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Docker Desktop</div></div><div class="info-2"><div class="info-item-1">开发者和团队首选的容器化软件，利用 Docker Desktop 的容器工具简化开发过程。</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a href="./mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%BC%80%E5%B7%A5%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-text">1. 开工前的准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%89%8D%E7%BD%AE%E7%BA%A6%E5%AE%9A"><span class="toc-text">1.1 前置约定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%B8%89%E4%BB%B6%E5%A5%97%E5%87%86%E5%A4%87"><span class="toc-text">1.2 三件套准备</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">2. 入门案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Hello-World"><span class="toc-text">2.1 Hello World</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%A4%9A%E6%A8%A1%E5%9E%8B%E5%85%B1%E5%AD%98"><span class="toc-text">2.2 多模型共存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%95%B4%E5%90%88-SpringBoot"><span class="toc-text">3. 整合 SpringBoot</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BD%8E%E9%98%B6%E5%92%8C%E9%AB%98%E9%98%B6-API"><span class="toc-text">4. 低阶和高阶 API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E4%BD%8E%E9%98%B6-API"><span class="toc-text">4.1 低阶 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E9%AB%98%E9%98%B6-API"><span class="toc-text">4.2 高阶 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-Token"><span class="toc-text">4.3 Token</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%A8%A1%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-text">5. 模型参数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E5%A4%9A%E6%A8%A1%E6%80%81%E8%A7%86%E8%A7%89%E7%90%86%E8%A7%A3"><span class="toc-text">6. 多模态视觉理解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E8%A7%A3%E8%AF%BB%E5%9B%BE%E7%89%87"><span class="toc-text">6.1 解读图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E6%8E%A5%E5%85%A5%E4%B8%89%E6%96%B9%E5%B9%B3%E5%8F%B0"><span class="toc-text">6.2 接入三方平台</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E6%B5%81%E5%BC%8F%E8%BE%93%E5%87%BA"><span class="toc-text">7. 流式输出</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">7.1 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E7%BC%96%E7%A0%81%E5%AE%9E%E6%88%98"><span class="toc-text">7.2 编码实战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Chat-Memory"><span class="toc-text">8. Chat Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-Memory-vs-History"><span class="toc-text">8.1 Memory vs History</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E9%A9%B1%E9%80%90%E7%AD%96%E7%95%A5"><span class="toc-text">8.2 驱逐策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">8.3 编码实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B"><span class="toc-text">9. 提示词工程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%A4%9A%E7%A7%8D-ChatMessage"><span class="toc-text">9.1 多种 ChatMessage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E6%BC%94%E5%8C%96"><span class="toc-text">9.2 提示词的演化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">9.3 编码实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">10. 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E5%AE%98%E6%96%B9%E4%BB%8B%E7%BB%8D"><span class="toc-text">10.1 官方介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">10.2 编码实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-Tools-Function-Calling"><span class="toc-text">11. Tools (Function Calling)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E5%AE%98%E6%96%B9%E4%BB%8B%E7%BB%8D"><span class="toc-text">11.1 官方介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E4%BD%8E%E9%98%B6-API"><span class="toc-text">11.2 低阶 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E9%AB%98%E9%98%B6-API"><span class="toc-text">11.3 高阶 API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">12. 向量数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">12.1 相关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2-Embedding-Model"><span class="toc-text">12.2 Embedding Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3-Embedding-Store"><span class="toc-text">12.3 Embedding Store</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-4-%E7%89%B9%E5%BE%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-text">12.4 特征点总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-5-%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">12.5 编码实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-RAG"><span class="toc-text">13. RAG</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">13.1 相关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-RAG-Stages"><span class="toc-text">13.2 RAG Stages</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-%E6%A0%B8%E5%BF%83-API"><span class="toc-text">13.3 核心 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-4-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text">13.4 简单实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-MCP"><span class="toc-text">14. MCP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">14.1 相关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-%E9%80%9A%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">14.2 通用架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-3-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-text">14.3 简单使用</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Git/" title="Git理论与使用"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/3.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Git理论与使用"/></a><div class="content"><a class="title" href="/posts/Git/" title="Git理论与使用">Git理论与使用</a><time datetime="2026-01-26T16:00:00.000Z" title="更新于 2026-01-27 00:00:00">2026-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Something-About-Blog/" title="博客搭建与维护"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/42.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="博客搭建与维护"/></a><div class="content"><a class="title" href="/posts/Something-About-Blog/" title="博客搭建与维护">博客搭建与维护</a><time datetime="2026-01-24T16:00:00.000Z" title="更新于 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 内存模型"/></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java 内存模型">Java 内存模型</a><time datetime="2026-01-02T16:00:00.000Z" title="更新于 2026-01-03 00:00:00">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="字节码与类加载"/></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载">字节码与类加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 的类资源加载"/></a><div class="content"><a class="title" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载">Java 的类资源加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/20.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="注解、类的加载、反射"/></a><div class="content"><a class="title" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射">注解、类的加载、反射</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By 默烦</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.4</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://testingcf.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://testingcf.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (false) {
      await btf.getScript('https://testingcf.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://gcore.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script src="/js/tip_portal.js"></script><script defer="defer" id="ribbon" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://testingcf.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>