<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>字节码与类加载 | Mofan</title><meta name="author" content="默烦,cy.mofan@foxmail.com"><meta name="copyright" content="默烦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="JVM 快速入门第三部分：字节码与类加载。">
<meta property="og:type" content="article">
<meta property="og:title" content="字节码与类加载">
<meta property="og:url" content="https://mofan212.github.io/posts/Java-Bytecode-And-Class-Loading/">
<meta property="og:site_name" content="Mofan">
<meta property="og:description" content="JVM 快速入门第三部分：字节码与类加载。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png">
<meta property="article:published_time" content="2026-01-01T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-01T16:00:00.000Z">
<meta property="article:author" content="默烦">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "字节码与类加载",
  "url": "https://mofan212.github.io/posts/Java-Bytecode-And-Class-Loading/",
  "image": "https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png",
  "datePublished": "2026-01-01T16:00:00.000Z",
  "dateModified": "2026-01-01T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "默烦",
      "url": "https://mofan212.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/favicon.png"><link rel="canonical" href="https://mofan212.github.io/posts/Java-Bytecode-And-Class-Loading/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')

          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 默烦","link":"链接: ","source":"来源: Mofan","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  infinitegrid: {
    js: 'https://testingcf.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '字节码与类加载',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="referrer" content="no-referrer-when-downgrade" /><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/css/myStyle.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css" /><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" /><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Mofan" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources/css/minimal.min.css"/><script src="https://testingcf.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/post_top_img.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Mofan</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-book-reader"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/schedule/"><i class="fa-fw fas fa-list-alt"></i><span> 计划</span></a></div><div class="menus_item"><a class="site-page" href="/update/"><i class="fa-fw fas fa-tools"></i><span> 维护</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fa fa-heart"></i><span> 关于</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于本站</span></a></li><li><a class="site-page child" href="/mine/"><i class="fa-fw fa fa-id-card"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw fa-solid fa-coins"></i><span> 赞助</span></a></li><li><a class="site-page child" href="/milestones/"><i class="fa-fw fa-solid fa-monument"></i><span> 里程碑</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">字节码与类加载</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-01T16:00:00.000Z" title="发表于 2026-01-02 00:00:00">2026-01-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JVM/">JVM</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">15k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;距离本文上次更新已经过去&quot;,&quot;messageNext&quot;:&quot;天，请注意时效性。&quot;,&quot;postUpdate&quot;:&quot;2026-01-02 00:00:00&quot;}" hidden></div>
    <style>
      .highlight-tools {
        background: #262931 !important;
      }
    </style>
    <html><head></head><body><p>封面来源：由博主个人绘制，如需使用请联系博主。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP/">黑马程序员JVM快速入门</a></p>
<p>本文涉及的代码：<a target="_blank" rel="noopener" href="https://github.com/mofan212/jvm-demo">mofan212/jvm-demo</a></p>
<blockquote>
<p>除特别注明外，本文内容都基于 JDK 1.8</p>
</blockquote>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%8A%80%E6%9C%AF%E6%B6%89%E5%8F%8A%E7%9A%84%E7%BB%84%E4%BB%B6.svg" alt="类加载与字节码技术涉及的组件"></p>
<h1 id="1-类文件结构"><a class="header-anchor" href="#1-类文件结构"></a>1. 类文件结构</h1>
<p>Oracle Java 8 JVM 规范 <code>class</code> 文件格式：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">The class File Format</a></p>
<p>存在 <code>HelloWorld.java</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> HelloWorld</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Hello World"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>使用 <code>javac -parameters -d . HelloWorld.java</code> 命令编译并保留方法中的参数信息。</p>
<p>再使用 <code>od -t xC HelloWorld.class</code> （这是 Linux 环境下的命令，在 Windows 环境下可以用 Git 里执行）查看字节码文件内容：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09 </span></span>
<span class="line"><span>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07 </span></span>
<span class="line"><span>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29 </span></span>
<span class="line"><span>0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e </span></span>
<span class="line"><span>0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63 </span></span>
<span class="line"><span>0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01 </span></span>
<span class="line"><span>0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63 </span></span>
<span class="line"><span>0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f </span></span>
<span class="line"><span>0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16 </span></span>
<span class="line"><span>0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 </span></span>
<span class="line"><span>0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13 </span></span>
<span class="line"><span>0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 </span></span>
<span class="line"><span>0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61 </span></span>
<span class="line"><span>0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46 </span></span>
<span class="line"><span>0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</span></span>
<span class="line"><span>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e </span></span>
<span class="line"><span>0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64 </span></span>
<span class="line"><span>0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74 </span></span>
<span class="line"><span>0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c </span></span>
<span class="line"><span>0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61 </span></span>
<span class="line"><span>0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61 </span></span>
<span class="line"><span>0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f </span></span>
<span class="line"><span>0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72 </span></span>
<span class="line"><span>0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76 </span></span>
<span class="line"><span>0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d </span></span>
<span class="line"><span>0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a </span></span>
<span class="line"><span>0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b </span></span>
<span class="line"><span>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01 </span></span>
<span class="line"><span>0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01 </span></span>
<span class="line"><span>0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00 </span></span>
<span class="line"><span>0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00 </span></span>
<span class="line"><span>0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00 </span></span>
<span class="line"><span>0001000 0f 00 02 00 09 00 00 00 37 00 02 00 01 00 00 00 </span></span>
<span class="line"><span>0001020 09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a </span></span>
<span class="line"><span>0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b </span></span>
<span class="line"><span>0001060 00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00 </span></span>
<span class="line"><span>0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00 </span></span>
<span class="line"><span>0001120 00 00 02 00 14</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>根据 JVM 规范，类文件结构如下：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>ClassFile {</span></span>
<span class="line"><span>    u4 			   magic</span></span>
<span class="line"><span>    u2             minor_version;    </span></span>
<span class="line"><span>    u2             major_version;    </span></span>
<span class="line"><span>    u2             constant_pool_count;    </span></span>
<span class="line"><span>    cp_info        constant_pool[constant_pool_count-1];    </span></span>
<span class="line"><span>    u2             access_flags;    </span></span>
<span class="line"><span>    u2             this_class;    </span></span>
<span class="line"><span>    u2             super_class;   </span></span>
<span class="line"><span>    u2             interfaces_count;    </span></span>
<span class="line"><span>    u2             interfaces[interfaces_count];   </span></span>
<span class="line"><span>    u2             fields_count;    </span></span>
<span class="line"><span>    field_info     fields[fields_count];   </span></span>
<span class="line"><span>    u2             methods_count;    </span></span>
<span class="line"><span>    method_info    methods[methods_count];    </span></span>
<span class="line"><span>    u2             attributes_count;    </span></span>
<span class="line"><span>    attribute_info attributes[attributes_count];</span></span>
<span class="line"><span>}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="1-1-魔数"><a class="header-anchor" href="#1-1-魔数"></a>1.1 魔数</h2>
<p>0~3 字节，表示是否是 <code>class</code> 类型的文件。</p>
<pre>0000000 <font style="color:red">ca fe ba be</font> 00 00 00 34 00 23 0a 00 06 00 15 09
</pre>
<h2 id="1-2-版本"><a class="header-anchor" href="#1-2-版本"></a>1.2 版本</h2>
<p>4~7 字节，表示类的版本。</p>
<pre>0000000 ca fe ba be <font style="color:red">00 00 00 34</font> 00 23 0a 00 06 00 15 09
</pre>
<p><code>34</code> 是十六进制，对应十进制 <code>52</code>，表示类的版本是 Java 8。</p>
<h2 id="1-3-常量池"><a class="header-anchor" href="#1-3-常量池"></a>1.3 常量池</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Constant Type</th>
<th style="text-align:center">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>CONSTANT_Class</code></td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Fieldref</code></td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Methodref</code></td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_InterfaceMethodref</code></td>
<td style="text-align:center">11</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_String</code></td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Integer</code></td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Float</code></td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Long</code></td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Double</code></td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_NameAndType</code></td>
<td style="text-align:center">12</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_Utf8</code></td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_MethodHandle</code></td>
<td style="text-align:center">15</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_MethodType</code></td>
<td style="text-align:center">16</td>
</tr>
<tr>
<td style="text-align:center"><code>CONSTANT_InvokeDynamic</code></td>
<td style="text-align:center">18</td>
</tr>
</tbody>
</table>
<p>8~9 字节，表示常量池长度：</p>
<pre>0000000 ca fe ba be 00 00 00 34 <font style="color:red">00 23</font> 0a 00 06 00 15 09
</pre>
<p><code>23</code> 十进制对应 <code>35</code>，表示常量池有 <code>#1 ~ #34</code> 项，<code>#0</code> 项不计入，也没有值。</p>
<blockquote>
<p><code>#1</code></p>
</blockquote>
<p><code>#1</code> 项 <code>0a</code> 对应十进制 <code>10</code>，根据上表查询得知，表示 <code>CONSTANT_Methodref</code>，即方法信息。<code>00 06</code> 和 <code>00 15(21)</code> 表示它引用了常量池中 <code>#6</code> 和 <code>#21</code> 项来获取这个方法的所属类和方法名：</p>
<pre>0000000 ca fe ba be 00 00 00 34 00 23 <font style="color:red">0a 00 06 00 15</font> 09
</pre>
<p><code>00 06</code> 对应第 <code>#6</code> 项，表示 Class 信息，然后它又引用了第 <code>#28</code> 项，指明具体的 Class 是 <code>java/lang/Object</code>。</p>
<p><code>00 15</code> 对应第 <code>#21</code> 项，表示方法名、参数类型和返回值类型。它分别引用 <code>#7</code> 项表名方法名是 <code>&lt;init&gt;</code>，即构造方法；然后又引用 <code>#8</code> 项，指定方法描述符为 <code>()V</code>，即无参无返回值。</p>
<blockquote>
<p><code>#6</code></p>
</blockquote>
<p><code>#6</code> 项 <code>07</code> 表示一个 Class 信息，<code>00 1c(28)</code> 表示它引用了常量池中 <code>#28</code> 项：</p>
<pre>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b <font style="color:red">07</font> 
0000040 <font style="color:red">00 1c</font> 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29
</pre>
<p><code>#28</code> 项 <code>01</code> 表示一个 utf8 串，<code>00 10(16)</code> 表示长度，指 <code>java/lang/Object</code>：</p>
<pre>0000460 6f 57 6f 72 6c 64 <font style="color:red">01 00 10 6a 61 76 61 2f 6c 61</font>
0000500 <font style="color:red">6e 67 2f 4f 62 6a 65 63 74</font> 01 00 10 6a 61 76 61 
</pre>
<blockquote>
<p><code>#21</code></p>
</blockquote>
<p><code>#21</code> 项 <code>0c</code> 表示名和类型，<code>00 07 00 08</code> 又引用了常量池的 <code>#7</code> 和 <code>#8</code> 项：</p>
<pre>0000360 2e 6a 61 76 61 <font style="color:red">0c 00 07 00 08</font> 07 00 1d 0c 00 1e
</pre>
<p><code>#7</code> 项 <code>01</code> 表示一个 utf8 串，<code>00 06</code> 是长度，<code>3c 69 6e 69 74 3e</code> 表示 <code>&lt;init&gt;</code>（构造方法）：</p>
<pre>0000040 00 1c <font style="color:red">01 00 06 3c 69 6e 69 74 3e</font> 01 00 03 28 29
</pre>
<p><code>#8</code> 项 <code>01</code> 表示一个 utf8 串，<code>00 03</code> 是长度，<code>28 29 56</code> 表示 <code>()V</code>，即无参、无返回值：</p>
<pre>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e <font style="color:red">01 00 03 28 29</font>
0000060 <font style="color:red">56</font> 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e
</pre>
<p>后续常量池字节码内容继续按照此方式进行分析即可，建议：</p>
<ul>
<li>参考中文 JVM 圣经，周志明老师的《深入理解 Java 虚拟机》</li>
<li>查看字节码文件使用 IDEA 插件 jClassLib</li>
</ul>
<h2 id="1-4-访问标识与继承信息"><a class="header-anchor" href="#1-4-访问标识与继承信息"></a>1.4 访问标识与继承信息</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Flag Name</th>
<th style="text-align:center">Value</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>ACC_PUBLIC</code></td>
<td style="text-align:center">0x0001</td>
<td style="text-align:center">Declared <code>public</code>; may be accessed from outside its package.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_FINAL</code></td>
<td style="text-align:center">0x0010</td>
<td style="text-align:center">Declared <code>final</code>; no subclasses allowed.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_SUPER</code></td>
<td style="text-align:center">0x0020</td>
<td style="text-align:center">Treat superclass methods specially when invoked by the <em>invokespecial</em> instruction.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_INTERFACE</code></td>
<td style="text-align:center">0x0200</td>
<td style="text-align:center">Is an interface, not a class.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_ABSTRACT</code></td>
<td style="text-align:center">0x0400</td>
<td style="text-align:center">Declared <code>abstract</code>; must not be instantiated.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_SYNTHETIC</code></td>
<td style="text-align:center">0x1000</td>
<td style="text-align:center">Declared synthetic; not present in the source code.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_ANNOTATION</code></td>
<td style="text-align:center">0x2000</td>
<td style="text-align:center">Declared as an annotation type.</td>
</tr>
<tr>
<td style="text-align:center"><code>ACC_ENUM</code></td>
<td style="text-align:center">0x4000</td>
<td style="text-align:center">Declared as an <code>enum</code> type.</td>
</tr>
</tbody>
</table>
<p><code>00 21</code> （由上表中的 <code>0x0001</code> 和 <code>0x0020</code> 相加获得）表示该 <code>class</code> 是一个公共的类：</p>
<pre>0000660 29 56 <font style="color:red">00 21</font> 00 05 00 06 00 00 00 00 00 02 00 01 
</pre>
<p><code>00 05</code> 表示根据常量池中的 <code>#5</code> 项找到 <strong>本类</strong> 的全限定名：</p>
<pre>0000660 29 56 00 21 <font style="color:red">00 05</font> 00 06 00 00 00 00 00 02 00 01 
</pre>
<p><code>00 06</code> 表示根据常量池中的 <code>#6</code> 找到 <strong>父类</strong> 的全限定名：</p>
<pre>0000660 29 56 00 21 00 05 <font style="color:red">00 06</font> 00 00 00 00 00 02 00 01 
</pre>
<p><code>00 00</code> 表示该类实现的接口数量，此处为 0：</p>
<pre>0000660 29 56 00 21 00 05 00 06 <font style="color:red">00 00</font> 00 00 00 02 00 01 
</pre>
<h2 id="1-5-Field-信息"><a class="header-anchor" href="#1-5-Field-信息"></a>1.5 Field 信息</h2>
<p><code>00 00</code> 表示成员变量数量，此处为 0：</p>
<pre>0000660 29 56 00 21 00 05 00 06 00 00 <font style="color:red">00 00</font> 00 02 00 01 
</pre>
<table>
<thead>
<tr>
<th style="text-align:center"><em>FieldType</em> term</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>B</code></td>
<td style="text-align:center"><code>byte</code></td>
<td style="text-align:center">signed byte</td>
</tr>
<tr>
<td style="text-align:center"><code>C</code></td>
<td style="text-align:center"><code>char</code></td>
<td style="text-align:center">Unicode character code point in the Basic Multilingual Plane, encoded with UTF-16</td>
</tr>
<tr>
<td style="text-align:center"><code>D</code></td>
<td style="text-align:center"><code>double</code></td>
<td style="text-align:center">double-precision floating-point value</td>
</tr>
<tr>
<td style="text-align:center"><code>F</code></td>
<td style="text-align:center"><code>float</code></td>
<td style="text-align:center">single-precision floating-point value</td>
</tr>
<tr>
<td style="text-align:center"><code>I</code></td>
<td style="text-align:center"><code>int</code></td>
<td style="text-align:center">integer</td>
</tr>
<tr>
<td style="text-align:center"><code>J</code></td>
<td style="text-align:center"><code>long</code></td>
<td style="text-align:center">long integer</td>
</tr>
<tr>
<td style="text-align:center"><code>L</code> <em>ClassName</em> <code>;</code></td>
<td style="text-align:center"><code>reference</code></td>
<td style="text-align:center">an instance of class <em>ClassName</em></td>
</tr>
<tr>
<td style="text-align:center"><code>S</code></td>
<td style="text-align:center"><code>short</code></td>
<td style="text-align:center">signed short</td>
</tr>
<tr>
<td style="text-align:center"><code>Z</code></td>
<td style="text-align:center"><code>boolean</code></td>
<td style="text-align:center"><code>true</code> or <code>false</code></td>
</tr>
<tr>
<td style="text-align:center"><code>[</code></td>
<td style="text-align:center"><code>reference</code></td>
<td style="text-align:center">one array dimension</td>
</tr>
</tbody>
</table>
<h2 id="1-6-Method-信息"><a class="header-anchor" href="#1-6-Method-信息"></a>1.6 Method 信息</h2>
<p><code>00 02</code> 表示方法数量，本类为 2（默认无参构造方法与 <code>main</code> 方法）：</p>
<pre>0000660 29 56 00 21 00 05 00 06 00 00 00 00 <font style="color:red">00 02</font> 00 01 
</pre>
<p>一个方法由访问修饰符、名称、参数描述、方法属性数量、方法属性组成。</p>
<blockquote>
<p>构造方法</p>
</blockquote>
<pre>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 <font style="color:red">00 01</font>
0000700 <font style="color:blue">00 07</font> <font style="color:green">00 08</font> <font style="color:gold">00 01</font> <font style="color:red">00 09 00 00 00 2f 00 01 00 01</font> 
0000720 <font style="color:red">00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00</font>
0000740 <font style="color:red">00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00</font>
0000760 <font style="color:red">01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00</font>
</pre>
<ul>
<li>红色代表访问修饰符 <code>public</code></li>
<li>蓝色代表引用了常量池 <code>#07</code> 项作为方法名称，对应 <code>&lt;init&gt;</code></li>
<li>绿色代表引用了常量池 <code>#08</code> 项作为方法参数描述，对应 <code>()V</code>，即无参无返回</li>
<li>黄色代表方法属性数量，本方法是 1</li>
<li>红色代表方法属性，其中：
<ul>
<li><code>00 09</code> 表示引用了常量池 <code>#09</code> 项，是 Code 属性</li>
<li><code>00 00 00 2f</code> 表示此属性的长度是 47</li>
<li><code>00 01</code> 表示 <strong>操作数栈</strong> 的最大深度</li>
<li><code>00 01</code> 表示 <strong>局部变量表</strong> 最大槽（slot）数</li>
<li><code>00 00 00 05</code> 表示字节码长度，本例是 5</li>
<li><code>2a b7 00 01 b1</code> 是字节码指令</li>
<li><code>00 00 00 02</code> 表示方法细节属性数量，本例是 2</li>
<li><code>00 0a</code> 表示引用了常量池 <code>#10</code> 项，对应 <code>LineNumberTable</code> 属性（字节码行号与 Java 代码行号对应，方便调试）
<ul>
<li><code>00 00 00 06</code> 表示此属性的总长度，本例是 6</li>
<li><code>00 01</code> 表示 <code>LineNumberTable</code> 长度</li>
<li><code>00 00</code> 表示字节码行号，对应 Java 源码行号 <code>00 04</code></li>
</ul>
</li>
<li><code>00 0b</code> 表示引用了常量池 <code>#11</code> 项，对应 <code>LocalVariableTable</code> 属性（局部变量表）
<ul>
<li><code>00 00 00 0c</code> 表示此属性的总长度，本例是 12</li>
<li><code>00 01</code> 表示 <code>LocalVariableTable</code> 长度</li>
<li><code>00 00</code> 表示局部变量生命周期开始，相对于字节码的偏移量</li>
<li><code>00 05</code> 表示局部变量覆盖的长度范围</li>
<li><code>00 0c</code> 表示局部变量名称，本例引用了常量池 <code>#12</code> 项，对应 <code>this</code></li>
<li><code>00 0d</code> 表示局部变量的类型，本例引用了常量池 <code>#13</code> 项，即 <code>this</code> 类型，当前类的类型</li>
<li><code>00 00</code> 表示局部变量占有的槽位（slot）编号，本例是 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><code>main</code> 方法</p>
</blockquote>
<p><code>main</code> 方法分析方式与构造方法一致，不再赘述。</p>
<h2 id="1-7-附加属性"><a class="header-anchor" href="#1-7-附加属性"></a>1.7 附加属性</h2>
<pre>0001100 00 12 00 00 00 05 01 00 10 00 00 <font style="color:red">00 01 00 13 00</font> 
0001120 <font style="color:red">00 00 02 00 14</font>
</pre>
<ul>
<li><code>00 01</code> 表示附加属性数量</li>
<li><code>00 13</code> 表示引用了常量池 <code>#19</code> 项，即 SourceFile，表示字节码文件对应的 Java 源文件名称</li>
<li><code>00 00 00 02</code> 表示此属性长度</li>
<li><code>00 14</code> 表示引用了常量池 <code>#20</code> 项，即 <code>HelloWorld.java</code></li>
</ul>
<h1 id="2-字节码指令"><a class="header-anchor" href="#2-字节码指令"></a>2. 字节码指令</h1>
<p>Oracle Java 8 JVM 规范指令集：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5">The Java Virtual Machine Instruction Set</a></p>
<h2 id="2-1-入门"><a class="header-anchor" href="#2-1-入门"></a>2.1 入门</h2>
<blockquote>
<p>调用父类 <code>Object</code> 的构造方法</p>
</blockquote>
<p>对应字节码指令：</p>
<pre>2a b7 00 01 b1
</pre>
<ul>
<li>查询 JVM 规范得知，<code>2a</code> 表示 <code>aload_0</code>，即加载 slot 0 的局部变量（加载到操作数栈），对应 <code>this</code>，作为后续执行 <code>invokespecial</code> 构造方法调用的参数</li>
<li><code>b7</code> 表示 <code>invokespecial</code>，预备调用构造方法</li>
<li><code>00 01</code> 表示需要调用的构造方法，查询常量池 <code>#1</code> 项，得到调用的构造方法信息</li>
<li><code>b1</code> 表示返回</li>
</ul>
<blockquote>
<p>调用 <code>main</code> 方法</p>
</blockquote>
<p>对应字节码指令：</p>
<pre>b2 00 02 12 03 b6 00 04 b1</pre>
<ul>
<li>查询 JVM 规范得知，<code>b2</code> 对应 <code>getstatic</code>，用于加载静态变量</li>
<li><code>00 02</code> 引用常量池中 <code>#2</code> 项，表示 <code>getstatic</code> 需要加载的静态变量信息，简单来说是 <code>System.out</code></li>
<li><code>12</code> 对应 <code>ldc</code>（load constant），用于加载参数</li>
<li><code>03</code> 引用常量池中 <code>#3</code> 项，即字符串常量 <code>Hello World</code></li>
<li><code>b6</code> 对应 <code>invokevirtual</code>，预备调用成员方法</li>
<li><code>00 04</code> 引用常量池中 <code>#4</code> 项，即 <code>println</code> 方法</li>
<li><code>b1</code> 表示返回</li>
</ul>
<h2 id="2-2-javap-工具"><a class="header-anchor" href="#2-2-javap-工具"></a>2.2 javap 工具</h2>
<p>Oracle 提供了 <code>javap</code> 工具来反编译 class 文件：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>javap -v HelloWorld.class</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>-v</code> 参数表示输出 class 文件的详细信息。</p>
<h2 id="2-3-图解方法执行流程"><a class="header-anchor" href="#2-3-图解方法执行流程"></a>2.3 图解方法执行流程</h2>
<p>有如下 Java 代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">package</span><span style="color:#C678DD"> indi.mofan</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 演示字节码指令和操作数栈、常量池的关系</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2025/10/4 15:39</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> a</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> b</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Short</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">MAX_VALUE</span><span style="color:#56B6C2"> +</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> c</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> a </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> b;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(c);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译 <code>Demo1</code> 后，使用 <code>javap -v class文件</code> 查看字节码文件。</p>
<blockquote>
<p>常量池载入运行时常量池</p>
</blockquote>
<p>「常量池」指的是 class 文件中的 <code>Constant pool</code>，「运行时常量池」指的是 JVM 内存结构中「方法区」的一部分。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%BD%BD%E5%85%A5%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0.svg" alt="常量池载入运行时常量池"></p>
<p>对于 <code>short</code> 范围内的整数不会存入运行时常量池中，而是与字节码指令一起存放。<code>short</code> 的最大值是 <code>32767</code>，加一后大于最大值，因此 <code>32768</code> 会被存放到运行时常量池中。</p>
<blockquote>
<p>方法字节码载入方法区</p>
</blockquote>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E6%96%B9%E6%B3%95%E5%AD%97%E8%8A%82%E7%A0%81%E8%BD%BD%E5%85%A5%E6%96%B9%E6%B3%95%E5%8C%BA.svg" alt="方法字节码载入方法区"></p>
<blockquote>
<p>main 线程开始运行，分配栈帧内存</p>
</blockquote>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/main%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%A7%8B%E8%BF%90%E8%A1%8C%E5%88%86%E9%85%8D%E6%A0%88%E5%B8%A7%E5%86%85%E5%AD%98.svg" alt="main线程开始运行分配栈帧内存"></p>
<p>通过 <code>javap</code> 命令查看的字节码文件中存在：</p>
<pre>public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=4
</pre>
<ul>
<li><code>stack=2</code> 表示操作数栈的深度是 2</li>
<li><code>locals=4</code> 表示局部变量表有 4 个槽位</li>
</ul>
<blockquote>
<p>执行引擎开始执行字节码</p>
</blockquote>
<p><code>bipush 10</code> 表示将一个 byte 压入操作数栈（由于操作数栈的宽度占 4 个字节，压入内容不足 4 个字节时，会补齐 4 个字节），类似的指令还有：</p>
<ul>
<li><code>sipush</code> 将一个 short 压入操作数栈（其长度会补齐 4 个字节）</li>
<li><code>ldc</code> 将一个 int 压入操作数栈</li>
<li><code>ldc2_w</code> 将一个 long 压入操作数栈（因为 long 是 8 个字节，需要分两次压入）</li>
<li>小数字和字节码指令存放在一起，超过 short 范围的数字会存入常量池</li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/bipush-10.svg" alt="bipush-10"></p>
<p><code>istore_1</code> 表示弹出操作数栈栈顶数据，存入局部变量表的 <code>slot 1</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/istore_1-1.svg" alt="istore_1-1"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/istore_1-2.svg" alt="istore_1-2"></p>
<p><code>ldc #3</code> 表示从运行时常量池中加载 <code>#3</code> 数据到操作数栈。</p>
<p>注意：<code>Short.MAX_VALUE</code> 对应 <code>32767</code>，加一操作能够在编译器确定，因此运行时常量池中直接存放了 <code>32768</code>。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/ldc-10.svg" alt="ldc #10"></p>
<p>根据前面对 <code>istore_1</code> 的讲解，<code>istore_2</code> 表示弹出操作数栈栈顶数据，存入局部变量表的 <code>slot 2</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/istore_2-1.svg" alt="istore_2-1"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/istore_2-2.svg" alt="istore_2-2"></p>
<p>接着从局部变量表里读取参与加法运算的两个数：</p>
<ul>
<li><code>iload_1</code> 表示从局部变量表 <code>slot 1</code> 里读取数据</li>
<li><code>iload_2</code> 表示从局部变量表 <code>slot 2</code> 里读取数据</li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/iload_1.svg" alt="iload_1"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/iload_2.svg" alt="iload_2"></p>
<p>然后执行 <code>iadd</code> 弹出堆操作数栈里的两个整型数据进行相加：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/iadd-1.svg" alt="iadd-1"></p>
<p>再把运算结果压入操作数栈顶：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/iadd-2.svg" alt="iadd-2"></p>
<p><code>istore_3</code> 再弹出操作数栈栈顶数据，存入局部变量表的 <code>slot 3</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/istore_3-1.svg" alt="istore_3-1"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/istore_3-2.svg" alt="istore_3-2"></p>
<p>到此，局部变量 <code>a</code>、<code>b</code>、<code>c</code> 均执行完毕。</p>
<p><code>getstatic #4</code> 从运行时常量池中获取成员变量 <code>System.out</code> 的引用，然后把该对象的 <strong>引用</strong> 添加进操作数栈中：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/getstatic-4-1.svg" alt="getstatic#4-1"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/getstatic-4-2.svg" alt="getstatic#4-2"></p>
<p>在调用 <code>println</code> 方法前，需要先加载所需的参数，使用 <code>iload_3</code> 从局部变量表 <code>slot 3</code> 里读取数据：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/iload_3-1.svg" alt="iload_3-1"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/iload_3-2.svg" alt="iload_3-2"></p>
<p>使用 <code>invokevirtual #5</code> 调用方法打印数据：</p>
<ul>
<li>找到运行时常量池 <code>#5</code> 项</li>
<li>定位到方法区 <code>java/io/PrintStream.println:(I)V</code> 方法</li>
<li>生成新的栈帧（分配 locals、stack 等）</li>
<li>传递参数，执行新栈帧中的字节码</li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/invokevirtual-5.svg" alt="invokevirtual #5"></p>
<p>目标方法执行完毕后，弹出栈帧。</p>
<p>清除 <code>main</code> 操作数栈的内容：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/invokevirtual-5%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95.svg" alt="invokevirtual#5执行完毕"></p>
<p>完成 <code>main</code> 方法调用后，弹出 <code>main</code> 栈帧，程序结束。</p>
<h2 id="2-4-练习-分析-a"><a class="header-anchor" href="#2-4-练习-分析-a"></a>2.4 练习-分析 a++</h2>
<p>目的：从字节码角度分析 <code>a++</code> 相关题目。</p>
<p>源码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 从字节码角度分析 a++ 相关题目。</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2025/10/4 20:22</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> a</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> b</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> a++ </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> ++a </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> a--;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 11</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(a);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 34</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(b);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>得到如下部分字节码：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>public static void main(java.lang.String[]);</span></span>
<span class="line"><span>   descriptor: ([Ljava/lang/String;)V</span></span>
<span class="line"><span>   flags: (0x0009) ACC_PUBLIC, ACC_STATIC</span></span>
<span class="line"><span>   Code:</span></span>
<span class="line"><span>     stack=2, locals=3, args_size=1</span></span>
<span class="line"><span>        0: bipush        10</span></span>
<span class="line"><span>        2: istore_1</span></span>
<span class="line"><span>        3: iload_1</span></span>
<span class="line"><span>        4: iinc          1, 1</span></span>
<span class="line"><span>        7: iinc          1, 1</span></span>
<span class="line"><span>       10: iload_1</span></span>
<span class="line"><span>       11: iadd</span></span>
<span class="line"><span>       12: iload_1</span></span>
<span class="line"><span>       13: iinc          1, -1</span></span>
<span class="line"><span>       16: iadd</span></span>
<span class="line"><span>       17: istore_2</span></span>
<span class="line"><span>       18: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span>       21: iload_1</span></span>
<span class="line"><span>       22: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V</span></span>
<span class="line"><span>       25: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span>
<span class="line"><span>       28: iload_2</span></span>
<span class="line"><span>       29: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V</span></span>
<span class="line"><span>       32: return</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>分析：</p>
<ul>
<li><code>iinc</code> 指令是直接在局部变量 <code>slot</code> 上进行运算的</li>
<li><code>a++</code> 和 <code>++a</code> 的区别是先执行 <code>iload</code> 还是先执行 <code>iinc</code></li>
</ul>
<p><code>a++</code> 会被分解为两条字节码指令：</p>
<ul>
<li><code>iload_1</code></li>
<li><code>iinc 1,1</code></li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%90%86%E8%A7%A3a%2B%2B.svg" alt="从字节码指令理解a++"></p>
<p><code>++a</code> 也会被分解为两条字节码指令，内容也与 <code>a++</code> 一样，但顺序不同：</p>
<ul>
<li>
<p><code>iinc 1,1</code></p>
</li>
<li>
<p><code>iload_1</code></p>
</li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E4%BB%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%90%86%E8%A7%A3a--.svg" alt="从字节码指令理解a--"></p>
<h2 id="2-5-条件判断指令"><a class="header-anchor" href="#2-5-条件判断指令"></a>2.5 条件判断指令</h2>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">助记符</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x99</td>
<td style="text-align:center">ifeq</td>
<td style="text-align:center">判断是否 == 0</td>
</tr>
<tr>
<td style="text-align:center">0x9a</td>
<td style="text-align:center">ifne</td>
<td style="text-align:center">判断是否 != 0</td>
</tr>
<tr>
<td style="text-align:center">0x9b</td>
<td style="text-align:center">iflt</td>
<td style="text-align:center">判断是否 &lt; 0</td>
</tr>
<tr>
<td style="text-align:center">0x9c</td>
<td style="text-align:center">ifge</td>
<td style="text-align:center">判断是否 &gt;= 0</td>
</tr>
<tr>
<td style="text-align:center">0x9d</td>
<td style="text-align:center">ifgt</td>
<td style="text-align:center">判断是否 &gt; 0</td>
</tr>
<tr>
<td style="text-align:center">0x9e</td>
<td style="text-align:center">ifle</td>
<td style="text-align:center">判断是否 &lt;= 0</td>
</tr>
<tr>
<td style="text-align:center">0x9f</td>
<td style="text-align:center">if_icmpeq</td>
<td style="text-align:center">两个 int 是否 ==</td>
</tr>
<tr>
<td style="text-align:center">0xa0</td>
<td style="text-align:center">if_icmpne</td>
<td style="text-align:center">两个 int 是否 !=</td>
</tr>
<tr>
<td style="text-align:center">0xa1</td>
<td style="text-align:center">if_icmplt</td>
<td style="text-align:center">两个 int 是否 &lt;</td>
</tr>
<tr>
<td style="text-align:center">0xa2</td>
<td style="text-align:center">if_icmpge</td>
<td style="text-align:center">两个 int 是否 &gt;=</td>
</tr>
<tr>
<td style="text-align:center">0xa3</td>
<td style="text-align:center">if_icmpgt</td>
<td style="text-align:center">两个 int 是否 &gt;</td>
</tr>
<tr>
<td style="text-align:center">0xa4</td>
<td style="text-align:center">if_icmple</td>
<td style="text-align:center">两个 int 是否 &lt;=</td>
</tr>
<tr>
<td style="text-align:center">0xa5</td>
<td style="text-align:center">if_acmpeq</td>
<td style="text-align:center">两个引用是否 ==</td>
</tr>
<tr>
<td style="text-align:center">0xa6</td>
<td style="text-align:center">if_acmpne</td>
<td style="text-align:center">两个引用是否 !=</td>
</tr>
</tbody>
</table>
<ul>
<li><code>byte</code>、<code>short</code> 和 <code>char</code> 都会按 <code>int</code> 比较，因为操作数栈都是 4 字节</li>
<li><code>goto</code> 用来进行跳转到指定行号的字节码</li>
</ul>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_3</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> a</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (a </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            a </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            a </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre> 0: iconst_0
 1: istore_1
 2: iload_1
 3: ifne          12
 6: bipush        10
 8: istore_1
 9: goto          15
12: bipush        20
14: istore_1
15: return
</pre>
<p>以上比较指令中没有涉及 <code>long</code>、<code>float</code> 和 <code>double</code> 的比较，那应该怎么比较它们呢？</p>
<p>可以参考：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.lcmp">lcmp</a></p>
<h2 id="2-6-循环控制指令"><a class="header-anchor" href="#2-6-循环控制指令"></a>2.6 循环控制指令</h2>
<p>循环控制指令还是先前的条件判断指令，例如 <code>while</code> 循环：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_4</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> a</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        while</span><span style="color:#ABB2BF"> (a </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            a++;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre> 0: iconst_0
 1: istore_1
 2: iload_1
 3: bipush        10
 5: if_icmpge     14
 8: iinc          1, 1
11: goto          2
14: return
</pre>
<p>再比如 <code>do...while</code> 循环：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_5</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> a</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        do</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            a++;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">while</span><span style="color:#ABB2BF"> (a </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre> 0: iconst_0
 1: istore_1
 2: iinc          1, 1
 5: iload_1
 6: bipush        10
 8: if_icmplt     2
11: return
</pre>
<p>最后再看看 for 循环：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_6</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">; i++) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre> 0: iconst_0
 1: istore_1
 2: iload_1
 3: bipush        10
 5: if_icmpge     14
 8: iinc          1, 1
11: goto          2
14: return
</pre>
<p>比较 <code>while</code> 和 <code>for</code> 的字节码，会发现它们是一模一样的，殊途也能同归。</p>
<h2 id="2-7-练习-判断结果"><a class="header-anchor" href="#2-7-练习-判断结果"></a>2.7 练习 - 判断结果</h2>
<p>从字节码角度分析下列代码的运行结果：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_7</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        while</span><span style="color:#ABB2BF"> (i </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            x </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> x++;</span></span>
<span class="line"><span style="color:#ABB2BF">            i++;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 0</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(x);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre> 0: iconst_0
 1: istore_1
 2: iconst_0
 3: istore_2
 4: iload_1
 5: bipush        10
 7: if_icmpge     21
10: iload_2
11: iinc          2, 1
14: istore_2
15: iinc          1, 1
18: goto          4
21: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
24: iload_2
25: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V
28: return
</pre>
<p>执行完前 4 步后，局部变量表 <code>slot 1</code> 存放 <code>i</code>，<code>slot 2</code> 存放 <code>x</code>。</p>
<p>加载局部变量表 <code>slot 1</code> 的数据，压入操作数栈，再执行 <code>bipush 10</code> 将 <code>10</code> 也压入操作数栈，使用 <code>if_icmpge 21</code> 比较前者是否大于等于后者，如果是，调到第 <code>21</code> 步，否则依次执行下一步。</p>
<p>不满足 <code>if_icmpge</code> 时，加载 <code>slot 2</code> 的数据（即 <code>x</code>，此时为 <code>0</code>），局部变量表 <code>slot 2</code> 位置的数据（也是 <code>x</code>，但先前已经加载到操作数栈上的 <code>x</code> 不会受影响，操作数栈上的 <code>x</code> 依旧是 <code>0</code>）加一，弹出操作数栈的栈顶元素，写入 <code>slot 2</code> 的位置，也就是让操作数栈上的 <code>0</code> 覆盖先前在局部变量表上加一的 <code>1</code>，这样操作后，局部变量表 <code>slot 2</code> 的数据并没有发生任何变化。</p>
<p>后续继续循环时，<code>slot 2</code> 的数据最终总是 <code>0</code>，因此最终打印 <code>x</code> 时还是 <code>0</code>。</p>
<h2 id="2-8-构造方法"><a class="header-anchor" href="#2-8-构造方法"></a>2.8 构造方法</h2>
<blockquote>
<p><code>&lt;cinit&gt;()V</code></p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_8_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E06C75">        i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E06C75">        i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 30</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译器会按从上到下的顺序，收集所有 <code>static</code> 静态代码块和静态变量赋值的代码，最终合并成一个特殊的方法 <code>&lt;cinit&gt;()V</code>，对应的部分字节码：</p>
<pre> 0: bipush        10
 2: putstatic     #2                  // Field i:I
 5: bipush        20
 7: putstatic     #2                  // Field i:I
10: bipush        30
12: putstatic     #2                  // Field i:I
15: return
</pre>
<p><code>&lt;cinit&gt;()V</code> 方法会在类加载的初始化阶段被调用。</p>
<p>因此上述代码里 <code>i</code> 最终的值为 <code>30</code>。</p>
<blockquote>
<p><code>&lt;init&gt;()V</code></p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_8_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75"> a </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "s1"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">    {</span></span>
<span class="line"><span style="color:#E06C75">        b </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> b </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">    {</span></span>
<span class="line"><span style="color:#E06C75">        a </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "s2"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Demo1_8_2</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> a</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> b</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">a</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> a;</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">b</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> b;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Demo1_8_2</span><span style="color:#E06C75"> obj</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Demo1_8_2</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"s3"</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">30</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // s3</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">obj</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">a</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 30</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">obj</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">b</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译器会按从上到下的顺序，收集所有 <code>{}</code> 代码块（初始化代码块）和成员变量赋值的代码，形成新的构造方法，但原始构造方法内的代码总是在最后。</p>
<p>对应的部分字节码：</p>
<pre>0: aload_0
1: invokespecial #1                   // super."&lt;init&gt;":()V
4: aload_0
5: ldc           #2                   // &lt;- "s1"
7: putfield      #3                   // -&gt; this.a
10: aload_0
11: bipush        20                  // &lt;- 20
13: putfield      #4                  // -&gt; this.b
16: aload_0
17: bipush        10                  // &lt;- 10
19: putfield      #4                  // -&gt; this.b
22: aload_0 
23: ldc           #5                  // &lt;- "s2"
25: putfield      #3                  // -&gt; this.a
28: aload_0                           // --------------------------------
29: aload_1                           // &lt;- slot 1(a) "s3"              |
30: putfield      #3                  // -&gt; this.a                      |
33: aload_0                                                             |
34: iload_2                           // &lt;- slot 2(b) 30                |
35: putfield      #4                  // -&gt; this.a  ---------------------
38: return
LineNumberTable: ...
LocalVariableTable:
Start  Length  Slot  Name   Signature
0      39     0  this   Lindi/mofan/Demo1_8_2;
0      39     1     a   Ljava/lang/String;
0      39     2     b   I
</pre>
<h2 id="2-9-方法调用"><a class="header-anchor" href="#2-9-方法调用"></a>2.9 方法调用</h2>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_9</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Demo1_9</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test2</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test3</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test4</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Demo1_9</span><span style="color:#E06C75"> obj</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Demo1_9</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        obj</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">test1</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        obj</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">test2</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        obj</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">test3</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        obj</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">test4</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        Demo1_9</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">test4</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre> 0: new           #2                  // class indi/mofan/Demo1_9
 3: dup
 4: invokespecial #3                  // Method "&lt;init&gt;":()V
 7: astore_1
 8: aload_1
 9: invokespecial #4                  // Method test1:()V
12: aload_1
13: invokespecial #5                  // Method test2:()V
16: aload_1
17: invokevirtual #6                  // Method test3:()V
20: aload_1
21: pop
22: invokestatic  #7                  // Method test4:()V
25: invokestatic  #7                  // Method test4:()V
28: return
</pre>
<p>可以发现：</p>
<ul>
<li>调用构造方法、私有方法、<code>final</code> 方法时，使用 <code>invokespecial</code> 指令</li>
<li>调用公共方法时，使用 <code>invokevirtual</code> 指令</li>
<li>调用静态方法时，使用 <code>invokestatic</code> 指令</li>
</ul>
<p>其中，<code>invokespecial</code> 和 <code>invokestatic</code> 属于静态绑定，能够在编译期确定调用的目标方法，性能更高；而 <code>invokevirtual</code> 属于动态绑定，调用的公共方法可能是当前类的、也可能是父类的（方法重写），在运行时才能确定调用的目标方法，性能相对更低。</p>
<blockquote>
<p><code>new</code> 一个对象</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">Demo1_9</span><span style="color:#E06C75"> obj </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Demo1_9</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>上述 Java 代码对应 4 步字节码：</p>
<ol>
<li><code>new</code>：在堆空间为需要创建的对象分配内存，分配成功后把对象引用放入操作数栈</li>
<li><code>dup</code>：复制操作数栈上的栈顶数据（现在操作数栈里有两份相同的引用）</li>
<li><code>invokespecial</code>：弹出操作数栈的栈顶数据（弹出一份引用）并调用构造方法</li>
<li><code>astore_1</code>：弹出操作数栈的栈顶数据（弹出另一份引用），并将其存入局部变量表的 <code>slot 1</code></li>
</ol>
<blockquote>
<p>使用实例对象调用静态方法</p>
</blockquote>
<p>可以直接按照 <code>类名.静态方法名()</code> 的形式去调用静态方法，但使用 <code>实例对象.静态方法名()</code> 来调用静态方法也不会编译报错。</p>
<p>那它们在字节码指令层面上有什么区别吗？</p>
<pre>20: aload_1
21: pop
22: invokestatic  #7                  // Method test4:()V
25: invokestatic  #7                  // Method test4:()V
</pre>
<p>20~22 对应使用 <code>实例对象.静态方法名()</code> 的形式来调用静态方法，25 对应使用 <code>类名.静态方法名()</code> 的形式来调用静态方法。</p>
<p>当使用 <code>实例对象.静态方法名()</code> 来调用静态方法时，先执行 <code>aload_1</code> 从将局部变量表中 <code>slot 1</code> 位置的数据加载到操作数栈中，由于调用静态方法并不需要实例对象，因此紧接着执行 <code>pop</code> 弹出操作数栈的栈顶元素，最后再使用 <code>invokestatic</code> 执行静态方法。</p>
<p>因此在日常编码时 <mark>不</mark> 推荐使用 <code>实例对象.静态方法名()</code> 的形式来调用静态方法，因为这会多出两条冗余的字节码指令。</p>
<h2 id="2-10-多态的原理"><a class="header-anchor" href="#2-10-多态的原理"></a>2.10 多态的原理</h2>
<blockquote>
<p>运行测试代码</p>
</blockquote>
<p>运行代码时添加 JVM 参数 <code>-XX:-UseCompressedOops -XX:-UseCompressedClassPointers</code> 禁用指针压缩：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">package</span><span style="color:#C678DD"> indi.mofan</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * 运行时添加以下 JVM 参数，禁用指针压缩：</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * -XX:-UseCompressedOops -XX:-UseCompressedClassPointers</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2025/10/5 20:03</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_10</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Animal</span><span style="color:#E06C75;font-style:italic"> animal</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        animal</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">eat</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(animal);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#61AFEF">        test</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> Cat</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#61AFEF">        test</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> Dog</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">in</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">read</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> abstract</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Animal</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#C678DD"> abstract</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> eat</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#E5C07B"> String</span><span style="color:#61AFEF"> toString</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#98C379"> "我是"</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClass</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getSimpleName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Dog</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Animal</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> eat</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"啃骨头"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Cat</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Animal</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> eat</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"吃鱼"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在终端使用 <code>jps</code> 命令，查看 Java 进程 id：</p>
<pre>29744 Launcher
21364 Jps
12252 Main
26396 HSDB
29772 Demo1_10
</pre>
<p>目标进程 id 是 <code>29772</code>。</p>
<blockquote>
<p>使用 HSDB 工具</p>
</blockquote>
<p>进入 JDK 安装目录，执行：</p>
<figure class="highlight shell line-numbers" data-language="SHELL">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic"># jdk 8</span></span>
<span class="line"><span style="color:#61AFEF">java</span><span style="color:#D19A66"> -cp</span><span style="color:#98C379"> ./lib/sa-jdi.jar</span><span style="color:#98C379"> sun.jvm.hotspot.HSDB</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># jdk 9 及以上</span></span>
<span class="line"><span style="color:#61AFEF">jhsdb</span><span style="color:#98C379"> hsdb</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>如果在 Windows 平台上运行时出现「‘.’ 不是内部或外部命令，也不是可运行的程序 或批处理文件。」错误，这是在 Windows 系统上使用了 Linux/Unix 风格的路径分隔符，把 <code>/</code> 改成 <code>\</code> 即可：</p>
<figure class="highlight shell line-numbers" data-language="SHELL">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#61AFEF">java</span><span style="color:#D19A66"> -cp</span><span style="color:#98C379"> .</span><span style="color:#56B6C2">\l</span><span style="color:#98C379">ib</span><span style="color:#56B6C2">\s</span><span style="color:#98C379">a-jdi.jar</span><span style="color:#98C379"> sun.jvm.hotspot.HSDB</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>进入 HSDB - HotSpot Debugger 页面，点击右上角 File，再点击「Attach to HotSpot process…」并输入前面通过 <code>jps</code> 命令得到的进程 id：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/Attach-to-HotSpot-process.png" alt="Attach-to-HotSpot-process"></p>
<p>点击 OK，耐心等待：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/HSDB%E6%9F%A5%E7%9C%8BJavaThread.png" alt="HSDB查看JavaThread"></p>
<p>点击 HSDB 工具栏的 Tools，再点击「Find Object by Query」：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/Find-Object-by-Query.png" alt="Find-Object-by-Query"></p>
<p>SOQL 的语法与 SQL 类似，比如现在需要查询 Java 进程中 <code>indi.mofan.Demo1_10.Dog</code> 对象：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>select d from indi.mofan.Demo1_10$Dog d</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E6%9F%A5%E8%AF%A2Dog%E5%AF%B9%E8%B1%A1.png" alt="查询Dog对象"></p>
<p>查询后会返回 <code>Dog</code> 对象的内存地址，点击该内存地址：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/Dog%E5%AF%B9%E8%B1%A1%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF.png" alt="Dog对象详细信息"></p>
<p>前 8 个字节组成 Mark Word，对应上图中的 <code>_mark</code>，其中包含对象的 HashCode、锁标记信息等。</p>
<p>后 8 个字节是对象的类型指针，对象上图中的 <code>_metadata._klass</code>，可以看到该对象的类型是 <code>indi.mofan.Demo1_10$Dog</code>。</p>
<p>如果需要查看这两部分信息在内存中的详细信息，点击 HSDB 工具栏的 Windows，再点击「Console」，输入以下命令：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>mem 0x000001b60bf1d0e8 2</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中 <code>0x000001b60bf1d0e8</code> 是对象地址信息，<code>2</code> 是需要查看几个 Word 信息，这里需要查看全部对象头信息，共两部分，因此键入 <code>2</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/mem-0x000001b60bf1d0e8.png" alt="mem-0x000001b60bf1d0e8"></p>
<p>第一个表示 Mark Word 比较简单。第二个表示复制类型指针信息，即 <code>0x000001b492985550</code>。</p>
<p>点击 HSDB 工具栏的 Tools，再点击「Inspector」，输入刚刚复制的类型指针信息，然后回车：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/Inspector-0x000001b492985550.png" alt="Inspector-0x000001b492985550"></p>
<p>这就是 <code>Dog</code> 类型在 JVM 虚拟机中的形式。</p>
<blockquote>
<p>vtable</p>
</blockquote>
<p>多态方法存在于 <code>vtable</code>（虚方法表）中。</p>
<p><code>vtable</code> 在类结构信息的最后：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/vtable-0x000001b492985550.png" alt="vtable-0x000001b492985550"></p>
<p>可以看到 <code>vtable</code> 没有具体的地址信息，但可以在类的内存偏移地址上加上 <code>1B8</code> 得到：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>0x000001b492985550 + 1B8 = 0x000001B492985708</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>先前对 <code>Dog</code> 对象进行 Inspector 时能够看到 <code>vtable</code> 的长度是 <code>6</code>：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/vtable%E9%95%BF%E5%BA%A6.png" alt="vtable长度"></p>
<p>打开 Command Line，执行：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>mem 0x000001B492985708 6</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中：</p>
<ul>
<li><code>0x000001B492985708</code> 是计算出的 <code>vtable</code> 内存地址</li>
<li><code>6</code> 是 <code>vtable</code> 长度</li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/Dog%E7%B1%BB%E4%B8%AD%E7%9A%84%E5%A4%9A%E6%80%81%E6%96%B9%E6%B3%95%E4%BF%A1%E6%81%AF.png" alt="Dog类中的多态方法信息"></p>
<p>可以看到 <code>Dog</code> 类的 <code>vtable</code> 里有 6 个动态方法。</p>
<p>点击 HSDB 工具栏的 Tools，再点击「Class Browser」查看类信息，确认 <code>Dog</code> 类中的动态方法是来自于哪：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E5%8C%B9%E9%85%8DDog%E7%9A%84eat%E6%96%B9%E6%B3%95.png" alt="匹配Dog的eat方法"></p>
<p><mark>注意：</mark> 如果 <code>Dog</code> 类中的 <code>eat()</code> 方法地址并不在命令行输出的 6 个动态方法中，可以尝试更换 JDK 重试，比如由 Zulu JDK8 更换为 Oracle JDK8，尽量使用 HotSpot JVM。</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E5%8C%B9%E9%85%8DAnimal%E7%9A%84toString%E6%96%B9%E6%B3%95.png" alt="匹配Animal的toString方法"></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/%E5%8C%B9%E9%85%8DObject%E4%B8%AD%E7%9A%84%E5%9B%9B%E4%B8%AA%E6%96%B9%E6%B3%95.png" alt="匹配Object中的四个方法"></p>
<blockquote>
<p>小结</p>
</blockquote>
<p>当执行 <code>invokevirtual</code> 指令时：</p>
<ol>
<li>先通过栈帧中的对象引用找到对象</li>
<li>分析对象头，找到对象的实际 Class</li>
<li>Class 结构中有 <code>vtable</code>（在类加载的链接阶段根据方法的重写规则生成好）</li>
<li>查表得到方法的具体地址</li>
<li>执行目标方法的字节码</li>
</ol>
<h2 id="2-11-异常处理"><a class="header-anchor" href="#2-11-异常处理"></a>2.11 异常处理</h2>
<blockquote>
<p>try-catch</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_11_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Exception</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=3, args_size=1
         0: iconst_0
         1: istore_1
         2: bipush        10
         4: istore_1
         5: goto          12
         8: astore_2
         9: bipush        20
        11: istore_1
        12: return
      Exception table:
         from    to  target type
             2     5     8   Class java/lang/Exception
      LineNumberTable: ...
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            9       3     2     e   Ljava/lang/Exception;
            0      13     0  args   [Ljava/lang/String;
            2      11     1     i   I
      StackMapTable: ...
</pre>
<p>使用 <code>try-catch</code> 块后，生成的字节码会多出一个 <code>Exception table</code> 结构。其中的 <code>[from, to)</code> 是一个前闭后开的检测范围，比如这里的 <code>[2, 5)</code> 表示检测第 <code>2</code> 行字节码到第 <code>5</code> 行字节码（不包括第 <code>5</code> 行），一旦这个范围的字节码执行时出现异常，再判断异常类型是否与 <code>type</code> 匹配，如果匹配，则跳到 <code>target</code> 对应的字节码行号。</p>
<p>第 <code>8</code> 行字节码是 <code>astore_2</code>，表示将异常对象 <code>e</code> 的引用存入局部变量表的 <code>slot 2</code> 位置。</p>
<blockquote>
<p>多个 single-catch 块的情况</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_11_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">ArithmeticException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 30</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">NullPointerException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 40</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Exception</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 50</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=3, args_size=1
         0: iconst_0
         1: istore_1
         2: bipush        10
         4: istore_1
         5: goto          26
         8: astore_2
         9: bipush        30
        11: istore_1
        12: goto          26
        15: astore_2
        16: bipush        40
        18: istore_1
        19: goto          26
        22: astore_2
        23: bipush        50
        25: istore_1
        26: return
      Exception table:
         from    to  target type
             2     5     8   Class java/lang/ArithmeticException
             2     5    15   Class java/lang/NullPointerException
             2     5    22   Class java/lang/Exception
      LineNumberTable: ...
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            9       3     2     e   Ljava/lang/ArithmeticException;
           16       3     2     e   Ljava/lang/NullPointerException;
           23       3     2     e   Ljava/lang/Exception;
            0      27     0  args   [Ljava/lang/String;
            2      25     1     i   I
      StackMapTable: ...
</pre>
<p>多个 <code>catch</code> 块与单个 <code>catch</code> 块类似，只不过由于只能进入 <code>Exception table</code> 中的一个分支，所以局部变量表 <code>slot 2</code> 会被复用。</p>
<blockquote>
<p>multi-catch 的情况</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_11_3</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            Method</span><span style="color:#E06C75"> test</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Demo1_11_3</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"test"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            test</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">NoSuchMethodException</span><span style="color:#ABB2BF"> | </span><span style="color:#E5C07B">IllegalAccessException</span><span style="color:#ABB2BF"> | </span><span style="color:#E5C07B">InvocationTargetException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E5C07B">            e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printStackTrace</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ok"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=3, locals=2, args_size=1
         0: ldc           #2                  // class indi/mofan/Demo1_11_3
         2: ldc           #3                  // String test
         4: iconst_0
         5: anewarray     #4                  // class java/lang/Class
         8: invokevirtual #5                  // Method java/lang/Class.getMethod:(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;
        11: astore_1
        12: aload_1
        13: aconst_null
        14: iconst_0
        15: anewarray     #6                  // class java/lang/Object
        18: invokevirtual #7                  // Method java/lang/reflect/Method.invoke:(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;
        21: pop
        22: goto          30
        25: astore_1
        26: aload_1
        27: invokevirtual #11                 // Method java/lang/ReflectiveOperationException.printStackTrace:()V
        30: return
      Exception table:
         from    to  target type
             0    22    25   Class java/lang/NoSuchMethodException
             0    22    25   Class java/lang/IllegalAccessException
             0    22    25   Class java/lang/reflect/InvocationTargetException
      LineNumberTable: ...
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
           12      10     1  test   Ljava/lang/reflect/Method;
           26       4     1     e   Ljava/lang/ReflectiveOperationException;
            0      31     0  args   [Ljava/lang/String;
      StackMapTable: ...
</pre>
<p>multi-catch 与单个 single-catch、多个 single-catch 类似，只不过在 <code>Exception table</code> 里存在多个 <code>from</code>、<code>to</code> 和 <code>target</code> 相同、但 <code>type</code> 不同的异常信息。</p>
<blockquote>
<p>finally 块</p>
</blockquote>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_11_4</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Exception</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">finally</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 30</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=4, args_size=1
         0: iconst_0
         1: istore_1                // 0 -&gt; i
         2: bipush        10        // try ----------------------------------------
         4: istore_1                // 10 -&gt; i                                    |
         5: bipush        30        // finally                                    |
         7: istore_1                // 30 -&gt; i                                    |
         8: goto          27        // return -------------------------------------
        11: astore_2                // catch Exception -&gt; e -----------------------
        12: bipush        20        //                                            |
        14: istore_1                // 20 -&gt; i                                    |
        15: bipush        30        // finally                                    |
        17: istore_1                // 30 -&gt; i                                    |
        18: goto          27        // return -------------------------------------
        21: astore_3                // catch any -&gt; slot 3 ------------------------
        22: bipush        30        // finally                                    |
        24: istore_1                // 30 -&gt; i                                    |
        25: aload_3                 // &lt;- slot 3                                  |
        26: athrow                  // throw --------------------------------------
        27: return
      Exception table:
         from    to  target type
             2     5    11   Class java/lang/Exception
             2     5    21   any    // 剩余的异常类型，比如 Error
            11    15    21   any    // 剩余的异常类型，比如 Error
      LineNumberTable: ...
      LocalVariableTable: ...
</pre>
<p>根据字节码可知，整个代码分为 3 个分支：</p>
<ol>
<li>先执行 <code>try</code> 块的代码，然后执行 <code>finally</code> 块里的代码</li>
<li>如果执行 <code>try</code> 块里的代码抛出了 <code>Exception</code>，那么会执行 <code>catch</code> 块里的代码，最后再执行 <code>finally</code> 块里的代码</li>
<li>执行 <code>try</code> 块或  <code>catch</code> 块里的代码时还可能抛出与 <code>Exception</code> 同级的错误，比如 <code>Error</code>，它们无法被捕获，但最后也要执行 <code>finally</code> 块里的代码</li>
</ol>
<p>综上，<code>finally</code> 块中的代码被复制了 3 份，分别放入 <code>try</code> 流程、<code>catch</code> 流程以及 <code>catch</code> 剩余的异常类型流程。</p>
<h2 id="2-12-练习-finally-面试题"><a class="header-anchor" href="#2-12-练习-finally-面试题"></a>2.12 练习 - finally 面试题</h2>
<blockquote>
<p><code>finally</code> 出现了 <code>return</code></p>
</blockquote>
<p>运行以下代码，控制台会输出什么呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_12_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">finally</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 20</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">test</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static int test();
    descriptor: ()I
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=2, args_size=0
         0: bipush        10       // &lt;- 10 放入栈顶
         2: istore_0               // 10 -&gt; slot 0 (从栈顶移除)
         3: bipush        20       // &lt;- 20 放入栈顶
         5: ireturn                // 返回栈顶 int(20)
         6: astore_1               // catch any -&gt; slot 1
         7: bipush        20       // &lt;- 20 放入栈顶
         9: ireturn                // 返回栈顶 int(20)
      Exception table:
         from    to  target type
             0     3     6   any
      LineNumberTable: ...
      StackMapTable: ...
</pre>
<ul>
<li>
<p>由于 <code>finally</code> 中的 <code>ireturn</code> 被插入到了所有可能的流程中，因此最终返回结果以 <code>finally</code> 中的为准</p>
</li>
<li>
<p>第 2 行字节码的 <code>istore_0</code> 似乎没什么用，但真的是这样吗？</p>
</li>
<li>
<p>与先前的例子相比，字节码中没有 <code>athrow</code> 命令了，因此：如果在 <code>finally</code> 中出现了 <code>return</code>，会吞掉异常，比如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_12_1_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 始终返回 20，且没有异常</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">test</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span><span style="color:#56B6C2"> /</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">finally</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
</li>
</ul>
<blockquote>
<p><code>finally</code> 对返回值的影响</p>
</blockquote>
<p>运行以下代码，控制台又会输出什么呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_12_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 10</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">test</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 10</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#ABB2BF"> i;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">finally</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">            i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 20</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static int test();
    descriptor: ()I
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=3, args_size=0
         0: bipush        10       // &lt;- 10 放入栈顶
         2: istore_0               // 10 -&gt; i
         3: iload_0                // &lt;- i(10)
         4: istore_1               // 10 -&gt; slot 1，暂存至 slot 1，目的是为了固定返回值
         5: bipush        20       // &lt;- 20 放回栈顶
         7: istore_0               // 20 -&gt; i
         8: iload_1                // &lt;- slot 1(10) 载入 slot 1 暂存的值
         9: ireturn                // 返回栈顶的 int(10)
        10: astore_2
        11: bipush        20
        13: istore_0
        14: aload_2
        15: athrow
      Exception table:
         from    to  target type
             3     5    10   any
      LineNumberTable: ...
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            3      13     0     i   I
      StackMapTable: ...
</pre>
<p><code>finally</code> 块中的数据没有被 <code>return</code>，生成的字节码指令中有 <code>athrow</code> 指令，如果出现异常不会被吞。</p>
<h2 id="2-13-synchronized"><a class="header-anchor" href="#2-13-synchronized"></a>2.13 synchronized</h2>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Demo1_13</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Object</span><span style="color:#E06C75"> lock</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Object</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        synchronized</span><span style="color:#ABB2BF"> (lock) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ok"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>对应的部分字节码：</p>
<pre>public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=4, args_size=1
         0: new           #2                  // new Object
         3: dup
         4: invokespecial #1                  // invokespecial &lt;init&gt;:()V
         7: astore_1                          // lock 引用 -&gt; lock
         8: aload_1                           // &lt;- lock (synchornized 开始)
         9: dup
        10: astore_2                          // lock 引用 -&gt; slot 2
        11: monitorenter                      // monitorenter (lock 引用)
        12: getstatic     #3                  // &lt;- System.out
        15: ldc           #4                  // &lt;- "ok"
        17: invokevirtual #5                  // invokevirtual println:(Ljava/lang/String;)V
        20: aload_2                           // &lt;- slot 2 (lock 引用)
        21: monitorexit                       // monitorexit (lock 引用)
        22: goto          30
        25: astore_3                          // any -&gt; slot 3
        26: aload_2                           // &lt;- slot 2 (lock 引用)
        27: monitorexit                       // monitorexit (lock 引用)
        28: aload_3
        29: athrow
        30: return
      Exception table:
         from    to  target type
            12    22    25   any
            25    28    25   any
      LineNumberTable: ...
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      31     0  args   [Ljava/lang/String;
            8      23     1  lock   Ljava/lang/Object;
      StackMapTable: ...
</pre>
<p><mark>注意：</mark> 方法级别的 <code>synchronized</code> 关键字不会在字节码指令中有所体现。</p>
<h1 id="3-编译期处理"><a class="header-anchor" href="#3-编译期处理"></a>3. 编译期处理</h1>
<p>所谓 <strong>语法糖</strong>，指 Java 编译器把 <code>*.java</code> 源码编译为 <code>*.class</code> 字节码的过程中，自动生成和转换了一些代码，主要是为了减轻开发者的负担，算是 Java 编译器给开发者的一个额外「福利」。</p>
<p><mark>注意，</mark> 本节代码分析将借助 <code>javap</code>、IDEA 的反编译功能、IDEA 的 jClassLib 插件等工具。编译器的转换结果就是 class 字节码，本节为了便于阅读，将给出几乎等价的 Java 源码，这并不表示编译器还会生成中间 Java 源码。</p>
<h2 id="3-1-默认构造器"><a class="header-anchor" href="#3-1-默认构造器"></a>3.1 默认构造器</h2>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 这个无参构造器会由编译器自动加上</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 调用父类的 Object 的无参构造，即 java/lang/Object."&lt;init&gt;":()V</span></span>
<span class="line"><span style="color:#E5C07B">        super</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="3-2-自动拆装箱"><a class="header-anchor" href="#3-2-自动拆装箱"></a>3.2 自动拆装箱</h2>
<p>在 JDK 5 中添加了自动拆装箱特性：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Integer</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> y</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> x;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>以上代码在 JDK 5 之前是无法编译通过的，必须改写为：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[] args) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 基本类型 -&gt; 包装类型：装箱</span></span>
<span class="line"><span style="color:#E5C07B">    Integer</span><span style="color:#E06C75"> x </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Integer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">valueOf</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 包装类型 -&gt; 基本类型：拆箱</span></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> y </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> x</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">intValue</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在 JDK 5 之前，包装类型和基本类型之间的转换需要手动处理（尤其是集合类中操作的都是包装类型），这非常麻烦，JDK 5 引入自动拆装箱后，这些手动处理的代码都可以由编译器在编译阶段完成。</p>
<h2 id="3-3-泛型集合取值"><a class="header-anchor" href="#3-3-泛型集合取值"></a>3.3 泛型集合取值</h2>
<p>泛型也是在 JDK 5 中加入的特性，但 Java 在编译泛型代码后会执行 <strong>泛型擦除</strong> 的动作，即泛型信息在编译为字节码之后就丢失了，实际类型都被当做 <code>Object</code> 类型来处理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy3</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">list</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> ArrayList</span><span style="color:#ABB2BF">&lt;&gt;();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 实际调用的是 List#add(Object e)</span></span>
<span class="line"><span style="color:#E5C07B">        list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 实际调用的是 Object obj = List#get(int index)</span></span>
<span class="line"><span style="color:#E5C07B">        Integer</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>所以在取值时，编译器真正生成的字节码中还要额外做一个类型转换的操作：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">// 将 Object 转换成 Integer</span></span>
<span class="line"><span style="color:#E5C07B">Integer</span><span style="color:#E06C75"> x </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Integer) </span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">);</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>如果前面的 <code>x</code> 变量类型修改为 <code>int</code> 基本类型，编译器还会自动拆箱：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">// 将 Object 转换为 Integer，然后再拆箱</span></span>
<span class="line"><span style="color:#C678DD">int</span><span style="color:#E06C75"> x </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> ((Integer) </span><span style="color:#E5C07B">list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">intValue</span><span style="color:#ABB2BF">();</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>擦除的是字节码上的泛型信息，可以看到 LocalVariableTypeTable 中仍然保留了方法参数泛型信息：</p>
<pre> public indi.mofan.candy.Candy3();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
         4: return
      LineNumberTable:
        line 11: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lindi/mofan/candy/Candy3;<br>
  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=1
         0: new           #2                  // class java/util/ArrayList
         3: dup
         4: invokespecial #3                  // Method java/util/ArrayList."&lt;init&gt;":()V
         7: astore_1
         8: aload_1
         9: bipush        10
        11: invokestatic  #4                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
        14: invokeinterface #5,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z
        19: pop
        20: aload_1
        21: iconst_0
        22: invokeinterface #6,  2            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;
        27: checkcast     #7                  // class java/lang/Integer
        30: astore_2
        31: return
      LineNumberTable: ...
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      32     0  args   [Ljava/lang/String;
            8      24     1  list   Ljava/util/List;
           31       1     2     x   Ljava/lang/Integer;
      LocalVariableTypeTable:
        Start  Length  Slot  Name   Signature
            8      24     1  list   Ljava/util/List&lt;Ljava/lang/Integer;&gt;;
</pre>
<p>使用反射，仍然能够获取到这些信息：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Set</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">Integer</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> test</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">List</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> list</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Map</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">Integer</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> Object</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> map) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> parseGenericType</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#E5C07B">    Method</span><span style="color:#E06C75"> test </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> Candy3</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"test"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">List</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Map</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Type</span><span style="color:#E06C75">[] types </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> test</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getGenericParameterTypes</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Type</span><span style="color:#E06C75"> type </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> types) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (type </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> ParameterizedType) {</span></span>
<span class="line"><span style="color:#E5C07B">            ParameterizedType</span><span style="color:#E06C75"> parameterizedType </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (ParameterizedType) type</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"原始类型 - "</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> parameterizedType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawType</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">            Type</span><span style="color:#E06C75">[] arguments </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> parameterizedType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getActualTypeArguments</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">            for</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B"> arguments</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i</span><span style="color:#ABB2BF">++</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"泛型参数[%d] - %s</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, i, arguments[i]);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>输出：</p>
<pre>原始类型 - interface java.util.List
泛型参数[0] - class java.lang.String
原始类型 - interface java.util.Map
泛型参数[0] - class java.lang.Integer
泛型参数[1] - class java.lang.Object
</pre>
<p>可以使用上述方式获取方法参数、返回值的泛型信息。</p>
<h2 id="3-4-可变参数"><a class="header-anchor" href="#3-4-可变参数"></a>3.4 可变参数</h2>
<p>可变参数也是 JDK 5 中添加的新特性。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy4</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> foo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">... </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 可变参数可直接赋值给数组</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75">array</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> args;</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">(array));</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#61AFEF">        foo</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"hello"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"world"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>可变参数 <code>String... args</code> 的本质是 <code>String[] args</code>，Java 编译器会在编译阶段将上述代码转换为：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> foo</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[] args) {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] array </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> args</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">(array));</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[] args) {</span></span>
<span class="line"><span style="color:#61AFEF">    foo</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75">[]{</span><span style="color:#98C379">"hello"</span><span style="color:#ABB2BF">,</span><span style="color:#98C379"> "world"</span><span style="color:#E06C75">})</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>注意，如果调用了 <code>foo()</code> 则等价于 <code>foo(new String[]{})</code>，创建了一个空数组，而不是传入 <code>null</code>。</p>
<h2 id="3-5-foreach-循环"><a class="header-anchor" href="#3-5-foreach-循环"></a>3.5 foreach 循环</h2>
<p>foreach 循环也是 JDK 5 引入的语法糖：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy5_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 数组赋初值的简化写法也是语法糖</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75">array</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> {</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">3</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">4</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">5</span><span style="color:#ABB2BF">};</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> x</span><span style="color:#C678DD"> :</span><span style="color:#ABB2BF"> array) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(x);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy5_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy5_1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75">array</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#C678DD"> int</span><span style="color:#ABB2BF">[]{</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">3</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">4</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">5</span><span style="color:#ABB2BF">};</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B"> array</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">; ++i) {</span></span>
<span class="line"><span style="color:#C678DD">            int</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> array[i];</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(x);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>如果是在集合上使用 foreach 循环呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy5_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">list</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">3</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">4</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">5</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Integer</span><span style="color:#E06C75"> x</span><span style="color:#C678DD"> :</span><span style="color:#ABB2BF"> list) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(x);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>应用于集合的 foreach 循环会被编译期转换为对迭代器的调用，编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy5_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy5_2</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">list</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">3</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">4</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">5</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        Iterator</span><span style="color:#E06C75"> iterator</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> list</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">iterator</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        while</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">iterator</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasNext</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#E5C07B">            Integer</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (Integer) </span><span style="color:#E5C07B">iterator</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(x);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>foreach 循环的写法能够配合数组、实现了 <code>Iterable</code> 接口（提供获取 <code>Iterator</code> 的方式）的集合类一起使用。</p>
<h2 id="3-6-switch-字符串"><a class="header-anchor" href="#3-6-switch-字符串"></a>3.6 switch 字符串</h2>
<p>从 JDK 7 开始，<code>switch</code> 可以作用于字符串和枚举类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy6_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> choose</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> str</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (str) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#98C379"> "hello"</span><span style="color:#C678DD">:</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"h"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#98C379"> "world"</span><span style="color:#C678DD">:</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"w"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy6_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy6_1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> choose</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> str</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        byte</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">str</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hashCode</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 99162322</span><span style="color:#C678DD">:</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">str</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"hello"</span><span style="color:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#ABB2BF">                    x </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">                }</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 113318802</span><span style="color:#C678DD">:</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">str</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"world"</span><span style="color:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#ABB2BF">                    x </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">                }</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (x) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 0</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"h"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 1</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"w"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>在编译生成的字节码中执行了两次 switch，第一次根据字符串的 <code>hashCode</code> 和 <code>equals</code> 将字符串的转换为相应 <code>byte</code> 类型，第二次再利用 <code>byte</code> 进行比较。</p>
<p>为什么第一次时必须既比较 <code>hashCode</code>，又比较 <code>equals</code> 呢？</p>
<p><code>hashCode</code> 是为了提高效率，减少比较次数；<code>equals</code> 是为了防止哈希冲突。</p>
<p>例如 <code>BM</code> 和 <code>C.</code> 两个字符串的 <code>hashCode</code> 值都是 2123：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy6_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> choose</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> str</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (str) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#98C379"> "BM"</span><span style="color:#C678DD">:</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"h"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#98C379"> "C."</span><span style="color:#C678DD">:</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"w"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy6_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy6_2</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> choose</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> str</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        byte</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#56B6C2"> -</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">str</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hashCode</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 2123</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">str</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"C."</span><span style="color:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#ABB2BF">                    x </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">                } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">str</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"BM"</span><span style="color:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#ABB2BF">                    x </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">                }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 没 break</span></span>
<span class="line"><span style="color:#C678DD">            default:</span></span>
<span class="line"><span style="color:#C678DD">                switch</span><span style="color:#ABB2BF"> (x) {</span></span>
<span class="line"><span style="color:#C678DD">                    case</span><span style="color:#D19A66"> 0</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"h"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                        break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">                    case</span><span style="color:#D19A66"> 1</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"w"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">                }</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="3-7-switch-枚举"><a class="header-anchor" href="#3-7-switch-枚举"></a>3.7 switch 枚举</h2>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy7</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> foo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Sex</span><span style="color:#E06C75;font-style:italic"> sex</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (sex) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#ABB2BF"> MALE</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"男"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#ABB2BF"> FEMALE</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"女"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">enum</span><span style="color:#E5C07B"> Sex</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#D19A66">    MALE</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> FEMALE</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy7</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> $MAP</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        static</span><span style="color:#C678DD"> int</span><span style="color:#E06C75">[] map </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#C678DD"> int</span><span style="color:#E06C75">[</span><span style="color:#D19A66">2</span><span style="color:#E06C75">]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E06C75">            map[</span><span style="color:#E5C07B">Sex</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">MALE</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ordinal</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">] </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            map[</span><span style="color:#E5C07B">Sex</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FEMALE</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ordinal</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">] </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 2</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> foo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Sex</span><span style="color:#E06C75;font-style:italic"> sex</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> $MAP</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">map</span><span style="color:#ABB2BF">[</span><span style="color:#E5C07B">sex</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ordinal</span><span style="color:#ABB2BF">()];</span></span>
<span class="line"><span style="color:#C678DD">        switch</span><span style="color:#ABB2BF"> (x) {</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 1</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"男"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            case</span><span style="color:#D19A66"> 2</span><span style="color:#C678DD">:</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"女"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                break</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>$MAP</code> 是一个合成类，仅 JVM 使用，开发者不可见，用来映射枚举的 <code>ordinal</code> 与数组元素的关系。枚举的 <code>ordinal</code> 表示枚举对象的序号，从 0 开始，即 <code>MALE.ordinal() = 0</code>，<code>FEMALE.ordinal() = 1</code>。</p>
<h2 id="3-8-枚举类"><a class="header-anchor" href="#3-8-枚举类"></a>3.8 枚举类</h2>
<p>JDK 7 新增了枚举类，现有如下枚举：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> enum</span><span style="color:#E5C07B"> Sex</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#D19A66">    MALE</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> FEMALE</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> final</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Sex</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> Enum</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Sex</span><span style="color:#ABB2BF">&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Sex</span><span style="color:#E06C75"> MALE</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Sex</span><span style="color:#E06C75"> FEMALE</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> final</span><span style="color:#E5C07B"> Sex</span><span style="color:#E06C75">[] $VALUES</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E06C75">        MALE </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Sex</span><span style="color:#E06C75">(</span><span style="color:#98C379">"MALE"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> 0</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        FEMALE </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Sex</span><span style="color:#E06C75">(</span><span style="color:#98C379">"FEMALE"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> 1</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        $VALUES </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> Sex</span><span style="color:#E06C75">[]{MALE</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> FEMALE}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#61AFEF"> Sex</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> ordinal</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        super</span><span style="color:#ABB2BF">(name, ordinal);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> Sex</span><span style="color:#61AFEF">[] values</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> $VALUES</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clone</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#E5C07B"> Sex</span><span style="color:#61AFEF"> valueOf</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75;font-style:italic"> name</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Enum</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">valueOf</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Sex</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, name);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h2 id="3-9-try-with-resources"><a class="header-anchor" href="#3-9-try-with-resources"></a>3.9 try-with-resources</h2>
<p>JDK 7 新增了对需要关闭的资源处理的特殊语法 <code>try-with-resources</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">try</span><span style="color:#E06C75"> (资源变量 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> 创建资源变量) {</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#E06C75">} </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> ( ) {</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>其中资源对象需要实现 <code>AutoCloseable</code> 接口，例如 <code>InputStream</code>、<code>OutputStream</code>、<code>Connection</code>、<code>Statement</code>、<code>ResultSet</code> 等接口都实现了 <code>AutoCloseable</code>，使用 <code>try-with-resources</code> 可以不用写 <code>finally</code> 语句块，编译器会帮助生成关闭资源代码，例如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy9</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">FileInputStream</span><span style="color:#E06C75"> is</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"d:</span><span style="color:#56B6C2">\\</span><span style="color:#98C379">1.txt"</span><span style="color:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(is);</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E5C07B">            e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printStackTrace</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译后生成的字节码等价于：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy9</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy9</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            InputStream</span><span style="color:#E06C75"> is</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> FileInputStream</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"d:</span><span style="color:#56B6C2">\\</span><span style="color:#98C379">1.txt"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            Throwable</span><span style="color:#E06C75"> t</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(is);</span></span>
<span class="line"><span style="color:#ABB2BF">            } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> e1</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 编写的代码出现异常</span></span>
<span class="line"><span style="color:#ABB2BF">                t </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> e1;</span></span>
<span class="line"><span style="color:#C678DD">                throw</span><span style="color:#ABB2BF"> e1;</span></span>
<span class="line"><span style="color:#ABB2BF">            } </span><span style="color:#C678DD">finally</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 资源不为空</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#ABB2BF"> (is </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 编写的代码有异常</span></span>
<span class="line"><span style="color:#C678DD">                    if</span><span style="color:#ABB2BF"> (t </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">                        try</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                            is</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">                        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> e2</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // 调用 close() 出现异常，作为被压制异常添加</span></span>
<span class="line"><span style="color:#E5C07B">                            t</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addSuppressed</span><span style="color:#ABB2BF">(e2);</span></span>
<span class="line"><span style="color:#ABB2BF">                        }</span></span>
<span class="line"><span style="color:#ABB2BF">                    } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 如果我们代码没有异常，close 出现的异常就是最后 catch 块中的 e</span></span>
<span class="line"><span style="color:#E5C07B">                        is</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">                    }</span></span>
<span class="line"><span style="color:#ABB2BF">                }</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E5C07B">            e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printStackTrace</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>为什么要设计一个 <code>addSuppressed(Throwable e)</code> （添加被压制异常）的方法呢？</p>
<p>为了防止异常信息的丢失。</p>
<p>如果 <code>try-with-resources</code> 生成的 <code>finally</code> 中如果抛出了异常：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy9_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">MyResource</span><span style="color:#E06C75"> resource</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> MyResource</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#C678DD">            int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span><span style="color:#56B6C2"> /</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">catch</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Exception</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E5C07B">            e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printStackTrace</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyResource</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> AutoCloseable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> close</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Exception</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"close 异常"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>输出：</p>
<pre>java.lang.ArithmeticException: / by zero
	at indi.mofan.candy.Candy9_2.main(Candy9_2.java:11)
	Suppressed: java.lang.Exception: close 异常
		at indi.mofan.candy.Candy9_2$MyResource.close(Candy9_2.java:20)
		at indi.mofan.candy.Candy9_2.main(Candy9_2.java:12)
</pre>
<p>可以看到，两个异常信息都不会丢失。</p>
<h2 id="3-10-方法重写时的桥接方法"><a class="header-anchor" href="#3-10-方法重写时的桥接方法"></a>3.10 方法重写时的桥接方法</h2>
<p>方法重写时的返回值有两种情况：</p>
<ul>
<li>
<p>父子类的返回值完全一致</p>
</li>
<li>
<p>子类返回值可以是父类返回值的子类，如：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> A</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Number</span><span style="color:#61AFEF"> m</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> B</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> A</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 子类 m 方法的返回值是 Integer，是父类 m 方法返回值 Number 的子类</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Integer</span><span style="color:#61AFEF"> m</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> 2</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
</li>
</ul>
<p>对于子类，Java 编译器会做以下处理：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> B</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> A</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Integer</span><span style="color:#61AFEF"> m</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> 2</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#E06C75">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 此方法才是真正重写父类的 m 方法</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> synthetic bridge </span><span style="color:#E5C07B">Number</span><span style="color:#61AFEF"> m</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 调用 public Integer m()</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> m</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>桥接方法比较特殊，仅对 Java 虚拟机可见，并且与原来的 <code>public Integer m()</code> 没有命名冲突，可以用下面的反射代码来验证：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[] args) {</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Method</span><span style="color:#E06C75"> method </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> B</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaredMethods</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(method);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>输出：</p>
<pre>public java.lang.Integer indi.mofan.candy.Candy10$B.m()
public java.lang.Number indi.mofan.candy.Candy10$B.m()
</pre>
<h2 id="3-11-匿名内部类"><a class="header-anchor" href="#3-11-匿名内部类"></a>3.11 匿名内部类</h2>
<p>有如下匿名内部类的表现形式：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy11</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Runnable</span><span style="color:#E06C75"> runnable</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Runnable</span><span style="color:#ABB2BF">() {</span></span>
<span class="line"><span style="color:#C678DD">            public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ok"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#ABB2BF">        };</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>转换后的代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">final</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy11$1</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Runnable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy11$1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ok"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy11</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Runnable</span><span style="color:#E06C75"> runnable</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Candy11$1</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>如果匿名内部类里引用了局部变量：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test</span><span style="color:#E06C75">(</span><span style="color:#C678DD">final</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> x) {</span></span>
<span class="line"><span style="color:#E5C07B">    Runnable</span><span style="color:#E06C75"> runnable </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Runnable</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#ABB2BF">        @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">        public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ok"</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> x);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>转换后的代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">final</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy11$1</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> Runnable</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> val$x</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#61AFEF"> Candy11$1</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> val</span><span style="color:#ABB2BF">$</span><span style="color:#E06C75;font-style:italic">x</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">val$x</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> val$x;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> run</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ok"</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">val$x</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Candy11</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">final</span><span style="color:#C678DD"> int</span><span style="color:#E06C75;font-style:italic"> x</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Runnable</span><span style="color:#E06C75"> runnable</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> Candy11$1</span><span style="color:#ABB2BF">(x);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是 <code>final</code> 的：在创建 <code>Candy11$1</code> 对象时，将 <code>x</code> 的值赋值给了 <code>Candy11$1</code> 对象的 <code>val$x</code> 属性，所以 <code>x</code> 不应该再发生变化，如果变化，那么 <code>val$x</code> 属性没有机会再跟着一起变化。</p>
<h1 id="4-类加载阶段"><a class="header-anchor" href="#4-类加载阶段"></a>4. 类加载阶段</h1>
<h2 id="4-1-加载"><a class="header-anchor" href="#4-1-加载"></a>4.1 加载</h2>
<ul>
<li>
<p>将类的字节码载入方法区中，内部采用 C++ 的 <code>instanceKlass</code> 描述 Java 类，其中重要的 field 有：</p>
<ul>
<li>
<p><code>_java_mirror</code> Java 的类镜像，例如对 <code>String</code> 来说，就是 <code>String.class</code>，作用是把 Klass 暴露给Java 使用</p>
</li>
<li>
<p><code>_super</code> 父类</p>
</li>
<li>
<p><code>_fields</code> 成员变量</p>
</li>
<li>
<p><code>_methods</code> 方法</p>
</li>
<li>
<p><code>_constants</code> 常量池</p>
</li>
<li>
<p><code>_class_loader</code> 类加载器</p>
</li>
<li>
<p><code>_vtable</code> 虚方法表</p>
</li>
<li>
<p><code>_itable</code> 接口方法表</p>
</li>
</ul>
</li>
<li>
<p>如果这个类还有父类没加载，则先加载父类</p>
</li>
<li>
<p>加载和链接可能是交替进行的</p>
</li>
</ul>
<p><mark>注意：</mark></p>
<ul>
<li><code>instanceKlass</code> 这样的「元数据」是存储在方法区的（1.8 后的元空间内），但 <code>_java_mirror</code> 是存储在堆中的</li>
<li>可以通过先前介绍的 HSDB 工具进行查看</li>
</ul>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/instanceKlass.svg" alt="instanceKlass"></p>
<h2 id="4-2-链接"><a class="header-anchor" href="#4-2-链接"></a>4.2 链接</h2>
<blockquote>
<p>验证</p>
</blockquote>
<p>验证类是否符合 JVM 规范，进行安全性检查。例如使用 UE 等支持二进制数据显示的编辑器修改一个 <code>class</code> 文件的魔数，执行 <code>java</code> 命令时会出现 <code>ClassFormatError</code> 错误。</p>
<blockquote>
<p>准备：为 <code>static</code> 变量分配空间，设置默认值：</p>
</blockquote>
<ul>
<li><code>static</code> 变量在 JDK7 之前存储于 <code>instanceKlass</code> 末尾，从 JDK7 开始，存储于 <code>_java_mirror</code> 末尾</li>
<li><code>static</code> 变量的分配空间和赋值是两个步骤，分配空间在准备阶段完成，赋值 <strong>通常</strong> 在初始化阶段完成</li>
<li>如果<code> static</code> 变量是 <code>final</code> 的基本类型和字符串字面量，其值在编译阶段就确定了，因此这类变量的赋值会在准备阶段完成</li>
<li>如果 <code>static</code> 变量是 <code>final</code> 的引用类型，赋值就是在初始化阶段完成</li>
</ul>
<blockquote>
<p>解析</p>
</blockquote>
<p>将常量池中的符号引用解析为直接引用。</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">package</span><span style="color:#C678DD"> indi.mofan.load</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#E5C07B"> java.io.IOException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * </span><span style="color:#C678DD;font-style:italic">@author</span><span style="color:#7F848E;font-style:italic"> mofan</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * @date 2026/1/1 21:16</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Load2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ClassLoader</span><span style="color:#E06C75"> loader</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Load2</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassLoader</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // loadClass 方法不会导致类的解析和初始化</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">cClazz</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> loader</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">loadClass</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"indi.mofan.load.C"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // new C();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">in</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">read</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> C</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    D</span><span style="color:#E06C75"> d </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> D</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> D</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>运行上述程序后，执行 <code>jps</code> 命令查看 Java 进程 id：</p>
<figure class="highlight shell line-numbers" data-language="SHELL">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#61AFEF">592</span><span style="color:#98C379"> Main</span></span>
<span class="line"><span style="color:#61AFEF">27812</span><span style="color:#98C379"> Launcher</span></span>
<span class="line"><span style="color:#61AFEF">30424</span><span style="color:#98C379"> Load2</span></span>
<span class="line"><span style="color:#61AFEF">27948</span><span style="color:#98C379"> Jps</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>进入 JDK 安装目录，使用 CMD 执行以下命令打开 HSDB：</p>
<figure class="highlight cmd line-numbers" data-language="CMD">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">.\</span><span style="color:#E06C75">bin</span><span style="color:#ABB2BF">\java.</span><span style="color:#E06C75">exe</span><span style="color:#ABB2BF"> -</span><span style="color:#E06C75">cp</span><span style="color:#ABB2BF"> .\</span><span style="color:#E06C75">lib</span><span style="color:#ABB2BF">\</span><span style="color:#E06C75">sa</span><span style="color:#ABB2BF">-jdi.jar sun.jvm.hotspot.HSDB</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>按照前文中的方式，在「Attach to HotSpot process…」窗口里输入 Java 进程 id，即 <code>30424</code>。</p>
<p>点击 HSDB 中 Tools 菜单下的「Class Browser」，查看对应 Java 进行中有哪些类信息：</p>
<ul>
<li>
<p>有类 <code>C</code>，查看其常量池信息：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/HSDB%E4%B8%8B%E6%9F%A5%E7%9C%8BC%E7%B1%BB%E5%B8%B8%E9%87%8F%E6%B1%A0%E4%BF%A1%E6%81%AF.png" alt="HSDB下查看C类常量池信息"></p>
</li>
<li>
<p>但没有类 <code>D</code></p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/HSDB%E4%B8%8B%E6%9F%A5%E6%89%BED%E7%B1%BB%E4%BF%A1%E6%81%AF.png" alt="HSDB下查找D类信息"></p>
</li>
</ul>
<p>更改先前的示例程序，注释 <code>loadClass()</code> 方法，启用 <code>new C();</code>：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Load2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ClassLoader</span><span style="color:#E06C75"> loader</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Load2</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassLoader</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // loadClass 方法不会导致类的解析和初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Class&lt;?&gt; cClazz = loader.loadClass("indi.mofan.load.C");</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        new</span><span style="color:#61AFEF"> C</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">in</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">read</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>再次查看 C 类的常量池信息，此时可以看到 D 类的信息：</p>
<p><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/JVMImages/HSDB%E4%B8%8B%E5%86%8D%E6%AC%A1%E6%9F%A5%E7%9C%8BC%E7%B1%BB%E5%B8%B8%E9%87%8F%E6%B1%A0%E4%BF%A1%E6%81%AF.png" alt="HSDB下再次查看C类常量池信息"></p>
<h2 id="4-3-初始化"><a class="header-anchor" href="#4-3-初始化"></a>4.3 初始化</h2>
<blockquote>
<p><code>&lt;cinit&gt;()V 方法</code></p>
</blockquote>
<p>初始化，即调用 <code>&lt;cinit&gt;()V</code> 方法（初始化静态变量和静态代码块），虚拟机会保证这个类的「构造方法」的线程安全。</p>
<blockquote>
<p>发生的时机</p>
</blockquote>
<p>概括地说，类初始化是「懒惰的」：</p>
<ul>
<li><code>main()</code> 方法所在的类，总被优先初始化</li>
<li>首次访问这个类的静态变量或静态方法时</li>
<li>子类初始化，如果父类还没初始化，触发父类的初始化，且在子类初始化之前进行初始化</li>
<li>子类访问父类静态变量，只触发父类的初始化，子类不会被初始化</li>
<li>调用 <code>Class.forName()</code></li>
<li>使用 <code>new</code> 关键词</li>
</ul>
<p>不会导致类初始化的情况：</p>
<ul>
<li>访问类的 <code>static final</code> 静态常量（基本类型和字符串）不会触发初始化</li>
<li>使用 <code>类对象.class</code> 不会触发初始化</li>
<li>创建该类的数组不会触发初始化</li>
<li>调用类加载器的 <code>loadClass()</code> 方法加载一个类</li>
<li>调用 <code>Class.forName()</code> 方法，且第二个参数值为 <code>false</code> 时</li>
</ul>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Load3</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"main init"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 1. 静态常量不会触发初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println(B.b);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 2. 类对象.class 不会触发初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println(B.class);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 3. 创建该类的数组不会触发初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println(Arrays.toString(new B[0]));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 4. 不初始化类 B，但会加载 B、A</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // ClassLoader c1 = Thread.currentThread().getContextClassLoader();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // c1.loadClass("indi.mofan.load.B");</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 5. 不初始化类 B，但会加载 B、A</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // ClassLoader c2 = Thread.currentThread().getContextClassLoader();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // Class.forName("indi.mofan.load.B", false, c2);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 1. 首次访问这个类的静态变量或静态方法时会触发初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println(A.a);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 2. 子类初始化，如果父类还没初始化，触发父类的初始化，且在子类初始化之前进行初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println(B.c);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 3. 子类访问父类静态变量，只触发父类的初始化，子类不会被初始化</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println(B.a);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 4. 调用 Class.forName() 方法</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"indi.mofan.load.B"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> A</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> a </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"a init"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> B</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> A</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    final</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> double</span><span style="color:#E06C75"> b </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 5.0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> boolean</span><span style="color:#E06C75"> c </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"b init"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<h1 id="5-类加载器"><a class="header-anchor" href="#5-类加载器"></a>5. 类加载器</h1>
<p>以 JDK8 为例：</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">加载哪的类</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Bootstrap ClassLoader</td>
<td style="text-align:center">JAVA_HOME/jre/lib</td>
<td style="text-align:center">无法直接访问</td>
</tr>
<tr>
<td style="text-align:center">Extension ClassLoader</td>
<td style="text-align:center">JAVA_HOME/jre/lib/ext</td>
<td style="text-align:center">上级为 Bootstrap，显示为 null</td>
</tr>
<tr>
<td style="text-align:center">Application ClassLoader</td>
<td style="text-align:center">classpath</td>
<td style="text-align:center">上级为 Extension</td>
</tr>
<tr>
<td style="text-align:center">自定义类加载器</td>
<td style="text-align:center">自定义</td>
<td style="text-align:center">上级为 Application</td>
</tr>
</tbody>
</table>
<h2 id="5-1-启动类加载器"><a class="header-anchor" href="#5-1-启动类加载器"></a>5.1 启动类加载器</h2>
<p>使用 Bootstrap 类加载器加载类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> F</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"bootstrap F init"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>执行：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Load5_1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">clazz</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"indi.mofan.load.F"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">clazz</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassLoader</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>执行上述代码时不能在 IDEA 内进行，需要使用命令行进入项目的输出目录，在 Maven 项目下就是所在模块的 <code>\target\classes</code> 目录。</p>
<p>使用以下命令执行：</p>
<figure class="highlight plaintext line-numbers" data-language="PLAINTEXT">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span>.\target\classes&gt; java -Xbootclasspath/a:. indi.mofan.load.Load5_1</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>输出：</p>
<pre>bootstrap F init
null
</pre>
<p>输出的类加载器信息为 <code>null</code>，这表明使用了 Bootstrap 类加载器进行了类加载。</p>
<blockquote>
<p><code>-Xbootclasspath/a:.</code> 的解析</p>
</blockquote>
<p><code>-Xbootclasspath</code> 表示设置 bootclasspath。</p>
<p>其中 <code>/a:.</code> 表示将当前目录追加至 bootclasspath 之后。</p>
<p>可以用这个方法替换掉一些核心类：</p>
<ul>
<li><code>java -Xbootclasspath:&lt;new bootclasspath&gt;</code>：使用新路径替换 <code>JAVA_HOME/jre/lib</code> 目录</li>
<li><code>java -Xbootclasspath/a:&lt;追加路径&gt;</code>：进行后追加</li>
<li><code>java -Xbootclasspath/p:&lt;追加路径&gt;</code>：进行前追加</li>
</ul>
<h2 id="5-2-扩展类加载器"><a class="header-anchor" href="#5-2-扩展类加载器"></a>5.2 扩展类加载器</h2>
<p>新建 <code>G</code> 类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> G</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"ext G init"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>编译为 <code>class</code> 文件后，使用以下命令将其打包成 <code>jar</code> 文件：</p>
<figure class="highlight shell line-numbers" data-language="SHELL">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#61AFEF">jar</span><span style="color:#D19A66"> -cvf</span><span style="color:#98C379"> my.jar</span><span style="color:#98C379"> indi</span><span style="color:#56B6C2">\m</span><span style="color:#98C379">ofan</span><span style="color:#56B6C2">\l</span><span style="color:#98C379">oad</span><span style="color:#56B6C2">\G</span><span style="color:#98C379">.class</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>将打包得到的 <code>my.jar</code> 文件放入使用的 JDK 的 <code>/jre/lib/ext</code> 目录下。</p>
<p>修改 <code>G</code> 类，使得 <code>/jre/lib/ext</code> 目录下和当前项目目录下都存在一个 <code>G</code> 类：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> G</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.out.println("ext G init");</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"classpath G init"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>测试下：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Load5_2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> ClassNotFoundException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">clazz</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"indi.mofan.load.G"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">clazz</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassLoader</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>输出：</p>
<pre>ext G init
sun.misc.Launcher$ExtClassLoader@379619aa
</pre>
<p>根据输出信息可以看到，使用拓展类加载器加载了拓展类路径下的 <code>G</code> 类，而非应用程序类路径下的 <code>G</code> 类。</p>
<h2 id="5-3-双亲委派模型"><a class="header-anchor" href="#5-3-双亲委派模型"></a>5.3 双亲委派模型</h2>
<p>参考 <a href="../Annotation-And-Reflection/">注解、类的加载、反射</a>，不再赘述。</p>
<h2 id="5-4-线程上下文类加载器"><a class="header-anchor" href="#5-4-线程上下文类加载器"></a>5.4 线程上下文类加载器</h2>
<p>我们在使用 JDBC 时需要加载 Driver 驱动，但就算没有以下代码也能够让 <code>com.mysql.jdbc.Driver</code> 正确加载，这是为什么呢？</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">Class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forName</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"com.mysql.jdbc.Driver"</span><span style="color:#ABB2BF">);</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>这与 Java 的 SPI 机制有关，参考 <a href="../Class-Resource-Loading-In-Java/">Java 的类资源加载</a>，不再赘述。</p>
<p>而所谓的「线程上下文类加载器」，即使用 <code>Thread.currentThread().getContextClassLoader()</code> 方法获取到的类加载器。在 Java 线程启动时，JVM 默认会将应用程序类加载器设置到该线程的上下文类加载器中。</p>
<h2 id="5-5-自定义类加载器"><a class="header-anchor" href="#5-5-自定义类加载器"></a>5.5 自定义类加载器</h2>
<p>参考 <a target="_blank" rel="noopener" href="https://github.com/mofan212/mofan-demo/tree/master/classloader">mofan-demo/classloader</a>，不再赘述。</p>
<h1 id="6-运行时优化"><a class="header-anchor" href="#6-运行时优化"></a>6. 运行时优化</h1>
<h2 id="6-1-即时编译"><a class="header-anchor" href="#6-1-即时编译"></a>6.1  即时编译</h2>
<blockquote>
<p>分层编译（TieredCompilation）</p>
</blockquote>
<p>有以下代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[] args) {</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i</span><span style="color:#ABB2BF">++</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        long</span><span style="color:#E06C75"> start </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nanoTime</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> j </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> j </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 1000</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> j</span><span style="color:#ABB2BF">++</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            new</span><span style="color:#61AFEF"> Object</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        long</span><span style="color:#E06C75"> end </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nanoTime</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"%d</span><span style="color:#56B6C2">\t</span><span style="color:#98C379">%d</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, i, end </span><span style="color:#56B6C2">-</span><span style="color:#ABB2BF"> start);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>运行程序后在控制台上能发现随着外部循环的执行，内部循环耗费的时间越来越少。</p>
<p>原因是什么呢？</p>
<p>JVM 将执行状态分成了 5 个层次：</p>
<ul>
<li>
<p>0 层，解释执行（Interpreter）</p>
</li>
<li>
<p>1 层，使用 C1 即时编译器编译执行（不带 profiling）</p>
</li>
<li>
<p>2 层，使用 C1 即时编译器编译执行（带基本的 profiling）</p>
</li>
<li>
<p>3 层，使用 C1 即时编译器编译执行（带完全的 profiling）</p>
</li>
<li>
<p>4 层，使用 C2 即时编译器编译执行</p>
</li>
</ul>
<p><code>profiling</code> 是指在运行过程中收集一些程序执行状态的数据，例如「方法的调用次数」，「循环的回边次数」等。</p>
<p>即时编译器（JIT）与解释器的区别：</p>
<ul>
<li>
<p>解释器是将字节码解释为机器码，下次即使遇到相同的字节码，仍会执行重复的解释</p>
</li>
<li>
<p>JIT 是将一些字节码编译为字节码，并存入 Code Cache，下次遇到相同的代码，直接执行，无需再编译</p>
</li>
<li>
<p>解释器是将字节码解释为针对所有平台都通用的机器码</p>
</li>
<li>
<p>JIT 会根据平台类型，生成平台特定的机器码</p>
</li>
</ul>
<p>对于占据大部分的不常用代码，无需耗费时间将其编译成机器码，而是采取解释执行的方式运行；对于仅占据小部分的热点代码，则可以将其编译成机器码，以达到理想的运行速度。在执行效率上进行简单的比较有 Interpreter &lt; C1 &lt; C2，总体目标是发现热点代码（这也是 HotSpot 名称的由来），然后进行优化。</p>
<p>先前示例代码中使用了一种名为「逃逸分析」的优化手段，用于判断新建的对象是否「逃逸」。以这段示例代码为例，简单来说就是判断内部循环新建的对象是否被外部循环使用，然后发现并没有被使用，那干脆就不创建这个对象了，于是随着外层循环的执行，耗费的时间越来越少，甚至出现数量级上的差距。</p>
<p>可以使用 JVM  参数 <code>-XX:-DoEscapeAnalysis</code> 来关闭逃逸分析。</p>
<blockquote>
<p>方法内联（Inlining）</p>
</blockquote>
<p>有以下代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> square</span><span style="color:#E06C75">(</span><span style="color:#C678DD">final</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> i) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">*</span><span style="color:#E06C75"> i</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">square</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">9</span><span style="color:#ABB2BF">));</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>如果发现 <code>square()</code> 是热点代码，并且长度不太长，就会进行内联。所谓内联指的是将方法内的代码拷贝、粘贴到调用者的位置：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">9</span><span style="color:#56B6C2"> *</span><span style="color:#D19A66"> 9</span><span style="color:#ABB2BF">);</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>还能够进行常量折叠（constant folding）的优化：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">81</span><span style="color:#ABB2BF">);</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>看一个示例：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> JIT2</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF"> square</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">final</span><span style="color:#C678DD"> int</span><span style="color:#E06C75;font-style:italic"> i</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> i </span><span style="color:#56B6C2">*</span><span style="color:#ABB2BF"> i;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> x</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 500</span><span style="color:#ABB2BF">; i++) {</span></span>
<span class="line"><span style="color:#C678DD">            long</span><span style="color:#E06C75"> start</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nanoTime</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">            for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> j</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; j </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 1000</span><span style="color:#ABB2BF">; j++) {</span></span>
<span class="line"><span style="color:#ABB2BF">                x </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> square</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">9</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#C678DD">            long</span><span style="color:#E06C75"> end</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nanoTime</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"%d</span><span style="color:#56B6C2">\t</span><span style="color:#98C379">%d</span><span style="color:#56B6C2">\t</span><span style="color:#98C379">%d</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, i, x, end </span><span style="color:#56B6C2">-</span><span style="color:#ABB2BF"> start);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>随着外层循环的执行，耗时居然变成了 0，这是因为进行了「方法内联」和「常量折叠」的优化。</p>
<p>相关 JVM 参数：</p>
<ul>
<li><code>-XX:+UnlockDiagnosticVMOptions</code>：解锁一些诊断性的虚拟机选项（某些高级和诊断性功能是默认禁用的），仅在开发调试使用，不能在生产中使用，会导致 JVM 行为不稳定，甚至影响系统安全性和可靠性。</li>
<li><code> -XX:+PrintInlining</code>：在 JIT 编译过程中打印方法内联的详细信息，需要与 <code>-XX:+UnlockDiagnosticVMOptions</code> 一起使用，否则无法使用该参数。</li>
<li><code>-XX:+PrintCompilation</code>：打印 JIT 编译的时间、方法、编译层级等信息。</li>
<li><code>-XX:CompileCommand=dontinline,*JIT2.square</code>：禁用任意包下 <code>JIT2</code> 类中 <code>square()</code> 方法的方法内联优化</li>
</ul>
<blockquote>
<p>字段优化</p>
</blockquote>
<p>本节需要使用到 JMH，参考 <a href="../JMH/">JMH</a>。</p>
<p>有以下代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Warmup</span><span style="color:#E06C75">(</span><span style="color:#D19A66">iterations</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 2</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> time</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Measurement</span><span style="color:#E06C75">(</span><span style="color:#D19A66">iterations</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 5</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> time</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">State</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Scope</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Benchmark</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Benchmark1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    volatile</span><span style="color:#C678DD"> int</span><span style="color:#E06C75">[] elements </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> randomInts</span><span style="color:#E06C75">(</span><span style="color:#D19A66">1_000</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    private</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> int</span><span style="color:#61AFEF">[] randomInts</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> size</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        ThreadLocalRandom</span><span style="color:#E06C75"> random</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> ThreadLocalRandom</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">current</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75">result</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#C678DD"> int</span><span style="color:#ABB2BF">[size];</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;</span><span style="color:#ABB2BF"> size; i++) {</span></span>
<span class="line"><span style="color:#ABB2BF">            result[i] </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> random</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nextInt</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> result;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Benchmark</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test1</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B"> elements</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">; i++) {</span></span>
<span class="line"><span style="color:#61AFEF">            doSum</span><span style="color:#ABB2BF">(elements[i]);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Benchmark</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test2</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75">local</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">elements</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B"> local</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">; i++) {</span></span>
<span class="line"><span style="color:#61AFEF">            doSum</span><span style="color:#ABB2BF">(local[i]);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Benchmark</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test3</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> element</span><span style="color:#C678DD"> :</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">elements</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#61AFEF">            doSum</span><span style="color:#ABB2BF">(element);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> int</span><span style="color:#E06C75"> sum </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">CompilerControl</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">CompilerControl</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Mode</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">DONT_INLINE</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">    static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> doSum</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75;font-style:italic"> x</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">        sum </span><span style="color:#56B6C2">+=</span><span style="color:#ABB2BF"> x;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> RunnerException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Options</span><span style="color:#E06C75"> opt</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> OptionsBuilder</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">include</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Benchmark1</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSimpleName</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">forks</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        new</span><span style="color:#61AFEF"> Runner</span><span style="color:#ABB2BF">(opt).</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p><code>doSum()</code> 方法未开启方法内联，输出的报告如下：</p>
<pre>Benchmark          Mode  Cnt       Score       Error  Units
Benchmark1.test1  thrpt    5  693704.366 ± 18996.437  ops/s
Benchmark1.test2  thrpt    5  756633.830 ± 23192.219  ops/s
Benchmark1.test3  thrpt    5  754530.966 ± 22909.926  ops/s
</pre>
<p>可以看到，<code>test1()</code> 方法的得分稍低一些。</p>
<p>在上述示例中，<code>doSum()</code> 方法是否内联会影响 <code>elements</code> 成员变量读取的优化。</p>
<p>如果 <code>doSum()</code> 方法内联了，<code>test1()</code> 方法会被优化成类似下面的样子（伪代码）：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Benchmark</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> test1</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // elements.length 首次读取会缓存起来 -&gt; int[] local</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">&lt;</span><span style="color:#E5C07B"> elements</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> i</span><span style="color:#ABB2BF">++</span><span style="color:#E06C75">) { </span><span style="color:#7F848E;font-style:italic">// 后续 999 次求长度不再访问成员变量 &lt;- local</span></span>
<span class="line"><span style="color:#61AFEF">        doSum</span><span style="color:#E06C75">(elements[i])</span><span style="color:#ABB2BF">;</span><span style="color:#7F848E;font-style:italic"> // 1000 次取下标 i 的元素不再访问成员变量 &lt;- local</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>可以节省 1999 次访问成员变量 <code>elements</code> 的操作，但如果 <code>doSum()</code> 方法没有进行内联，则不会进行上述优化。</p>
<h2 id="6-2-反射优化"><a class="header-anchor" href="#6-2-反射优化"></a>6.2 反射优化</h2>
<p>本节需要使用到 Arthas，参考 <a href="../Quick-Start-To-Arthas/">Arthas 快速入门</a>。</p>
<p>存在以下代码：</p>
<figure class="highlight java line-numbers" data-language="JAVA">
        <table style="background-color: #282c34"><tbody><tr><td class="gutter" style="background-color: #282c34"><pre style="background-color: #282c34"><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code" style="background-color: #282c34"><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Reflect1</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> foo</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">println</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"foo..."</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> Exception</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        Method</span><span style="color:#E06C75"> foo</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> Reflect1</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMethod</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"foo"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 17 次反射调用</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> i</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">; i </span><span style="color:#56B6C2">&lt;=</span><span style="color:#D19A66"> 17</span><span style="color:#ABB2BF">; i++) {</span></span>
<span class="line"><span style="color:#C678DD">            long</span><span style="color:#E06C75"> start</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nanoTime</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // System.out.printf("%d\t", i);</span></span>
<span class="line"><span style="color:#E5C07B">            foo</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">invoke</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">            System</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">out</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">printf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"%d</span><span style="color:#56B6C2">\t</span><span style="color:#98C379">%d</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">"</span><span style="color:#ABB2BF">, i, </span><span style="color:#E5C07B">System</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nanoTime</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">-</span><span style="color:#ABB2BF"> start);</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // System.in.read();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span></code></pre></td></tr></tbody></table>
      </figure>
<p>共进行了 17 次反射调用。</p>
<p>观察耗时有：随着调用次数的进行，耗时减少，但在第 16 次的调用中，耗时陡增，第 17 次调用的耗时又恢复正常。</p>
<p>反射调用方法时，如果超过阈值（15），会在运行时生成方法访问器（<code>MethodAccessorImpl</code> 的实现类，可通过 Arthas 的 <code>jad</code> 命令查看），内部将反射的动态调用改为直接调用。</p>
<p>阈值由 <code>ReflectionFactory.inflationThreshold()</code> 方法返回结果控制，默认 15。</p>
<p>通过查看 <code>ReflectionFactory</code> 源码可知：</p>
<ul>
<li>可以通过设置系统属性 <code>sun.reflect.noInflation</code> 为 <code>true</code> 来禁用膨胀，以直接生成 <code>MethodAccessorImpl</code> 的实现类，但首次生成会比较耗时（这也是上述示例代码中第 16 次反射调用的耗时陡增的原因），如果仅反射调用一次，那不划算</li>
<li>可以通过设置系统属性 <code>sun.reflect.inflationThreshold</code> 的值来修改膨胀阈值</li>
</ul>
</body></html></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mofan212.github.io">默烦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mofan212.github.io/posts/Java-Bytecode-And-Class-Loading/">https://mofan212.github.io/posts/Java-Bytecode-And-Class-Loading/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mofan212.github.io" target="_blank">Mofan</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JVM/">JVM</a></div><div class="post-share"><div class="social-share" data-image="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" data-sites="wechat,qq,weibo,facebook,x"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/AliPay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li><li class="reward-item"><a href="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" target="_blank"><img class="post-qr-code-img" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/WeChatPay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/ren-zhi-jue-xing/" title="认知觉醒"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/172.webp" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">认知觉醒</div></div><div class="info-2"><div class="info-item-1">《认知觉醒：开启自我改变的原动力》，周岭著。</div></div></div></a><a class="pagination-related" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="onerror=null;src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Java 内存模型</div></div><div class="info-2"><div class="info-item-1">JVM 快速入门第四部分：Java 内存模型。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/The-Structure-Of-JVM/" title="JVM 内存结构"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/161.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-05</div><div class="info-item-2">JVM 内存结构</div></div><div class="info-2"><div class="info-item-1">JVM 快速入门第一部分：JVM 内存结构。</div></div></div></a><a class="pagination-related" href="/posts/JVM-GC/" title="JVM 垃圾回收"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/165.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-21</div><div class="info-item-2">JVM 垃圾回收</div></div><div class="info-2"><div class="info-item-1">JVM 快速入门第二部分：JVM 垃圾回收。</div></div></div></a><a class="pagination-related" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img class="cover" src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-03</div><div class="info-item-2">Java 内存模型</div></div><div class="info-2"><div class="info-item-1">JVM 快速入门第四部分：Java 内存模型。</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/avatar.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">默烦</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">54</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mofan212"><i class="fab fa-github"></i><span>follow me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:cy.mofan@foxmail.com" target="_blank" title="邮箱"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。<strong><font style="color:red">除特别注明外，</font>如需转载，请在文章头部醒目处附带原文链接并<a href="./mine/" style="color:#49B1F5;text-decoration:underline">告知我</a></strong>你将转载。😊</br><strong><font style="color:red">严禁未遵循规范的转载。</font></strong>😡</br><strong>死去的评论系统复活啦！欢迎到留言板畅所欲言！</strong>当然也可以使用更高效的<a target="_blank" href="https://space.bilibili.com/23658864/dynamic" style="color:#49B1F5;text-decoration:underline"> 哔哩哔哩私信 </a>或<a href="mailto:cy.mofan@foxmail.com" style="color:#49B1F5;text-decoration:underline" target="_blank">邮箱</a>。 😉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">1. 类文件结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E9%AD%94%E6%95%B0"><span class="toc-text">1.1 魔数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%89%88%E6%9C%AC"><span class="toc-text">1.2 版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="toc-text">1.3 常量池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E8%AE%BF%E9%97%AE%E6%A0%87%E8%AF%86%E4%B8%8E%E7%BB%A7%E6%89%BF%E4%BF%A1%E6%81%AF"><span class="toc-text">1.4 访问标识与继承信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-Field-%E4%BF%A1%E6%81%AF"><span class="toc-text">1.5 Field 信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-Method-%E4%BF%A1%E6%81%AF"><span class="toc-text">1.6 Method 信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7-%E9%99%84%E5%8A%A0%E5%B1%9E%E6%80%A7"><span class="toc-text">1.7 附加属性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="toc-text">2. 字节码指令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%85%A5%E9%97%A8"><span class="toc-text">2.1 入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-javap-%E5%B7%A5%E5%85%B7"><span class="toc-text">2.2 javap 工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%9B%BE%E8%A7%A3%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">2.3 图解方法执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E7%BB%83%E4%B9%A0-%E5%88%86%E6%9E%90-a"><span class="toc-text">2.4 练习-分析 a++</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E6%8C%87%E4%BB%A4"><span class="toc-text">2.5 条件判断指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%BE%AA%E7%8E%AF%E6%8E%A7%E5%88%B6%E6%8C%87%E4%BB%A4"><span class="toc-text">2.6 循环控制指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E7%BB%83%E4%B9%A0-%E5%88%A4%E6%96%AD%E7%BB%93%E6%9E%9C"><span class="toc-text">2.7 练习 - 判断结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">2.8 构造方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="toc-text">2.9 方法调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-10-%E5%A4%9A%E6%80%81%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-text">2.10 多态的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-11-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">2.11 异常处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-12-%E7%BB%83%E4%B9%A0-finally-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-text">2.12 练习 - finally 面试题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-13-synchronized"><span class="toc-text">2.13 synchronized</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%BC%96%E8%AF%91%E6%9C%9F%E5%A4%84%E7%90%86"><span class="toc-text">3. 编译期处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E9%BB%98%E8%AE%A4%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-text">3.1 默认构造器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1"><span class="toc-text">3.2 自动拆装箱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%B3%9B%E5%9E%8B%E9%9B%86%E5%90%88%E5%8F%96%E5%80%BC"><span class="toc-text">3.3 泛型集合取值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0"><span class="toc-text">3.4 可变参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-foreach-%E5%BE%AA%E7%8E%AF"><span class="toc-text">3.5 foreach 循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-switch-%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">3.6 switch 字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-switch-%E6%9E%9A%E4%B8%BE"><span class="toc-text">3.7 switch 枚举</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E6%9E%9A%E4%B8%BE%E7%B1%BB"><span class="toc-text">3.8 枚举类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-try-with-resources"><span class="toc-text">3.9 try-with-resources</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10-%E6%96%B9%E6%B3%95%E9%87%8D%E5%86%99%E6%97%B6%E7%9A%84%E6%A1%A5%E6%8E%A5%E6%96%B9%E6%B3%95"><span class="toc-text">3.10 方法重写时的桥接方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-11-%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB"><span class="toc-text">3.11 匿名内部类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%98%B6%E6%AE%B5"><span class="toc-text">4. 类加载阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%8A%A0%E8%BD%BD"><span class="toc-text">4.1 加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E9%93%BE%E6%8E%A5"><span class="toc-text">4.2 链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">4.3 初始化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">5. 类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">5.1 启动类加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%89%A9%E5%B1%95%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">5.2 扩展类加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.3 双亲委派模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">5.4 线程上下文类加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">5.5 自定义类加载器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8C%96"><span class="toc-text">6. 运行时优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91"><span class="toc-text">6.1  即时编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%8F%8D%E5%B0%84%E4%BC%98%E5%8C%96"><span class="toc-text">6.2 反射优化</span></a></li></ol></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>JVM 快速入门</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/The-Structure-Of-JVM/" title="JVM 内存结构"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/161.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="JVM 内存结构"></a><div class="content"><a class="title" href="/posts/The-Structure-Of-JVM/" title="JVM 内存结构">JVM 内存结构</a><time datetime="2025-05-04T16:00:00.000Z" title="发表于 2025-05-05 00:00:00">2025-05-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/JVM-GC/" title="JVM 垃圾回收"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/165.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="JVM 垃圾回收"></a><div class="content"><a class="title" href="/posts/JVM-GC/" title="JVM 垃圾回收">JVM 垃圾回收</a><time datetime="2025-09-20T16:00:00.000Z" title="发表于 2025-09-21 00:00:00">2025-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="字节码与类加载"></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载">字节码与类加载</a><time datetime="2026-01-01T16:00:00.000Z" title="发表于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 内存模型"></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java 内存模型">Java 内存模型</a><time datetime="2026-01-02T16:00:00.000Z" title="发表于 2026-01-03 00:00:00">2026-01-03</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/Something-About-Blog/" title="博客搭建与维护"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/42.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="博客搭建与维护"/></a><div class="content"><a class="title" href="/posts/Something-About-Blog/" title="博客搭建与维护">博客搭建与维护</a><time datetime="2026-01-24T16:00:00.000Z" title="更新于 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Memory-Model/" title="Java 内存模型"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/174.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 内存模型"/></a><div class="content"><a class="title" href="/posts/Java-Memory-Model/" title="Java 内存模型">Java 内存模型</a><time datetime="2026-01-02T16:00:00.000Z" title="更新于 2026-01-03 00:00:00">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/173.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="字节码与类加载"/></a><div class="content"><a class="title" href="/posts/Java-Bytecode-And-Class-Loading/" title="字节码与类加载">字节码与类加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/103.png" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="Java 的类资源加载"/></a><div class="content"><a class="title" href="/posts/Class-Resource-Loading-In-Java/" title="Java 的类资源加载">Java 的类资源加载</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/20.jpg" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="注解、类的加载、反射"/></a><div class="content"><a class="title" href="/posts/Annotation-And-Reflection/" title="注解、类的加载、反射">注解、类的加载、反射</a><time datetime="2026-01-01T16:00:00.000Z" title="更新于 2026-01-02 00:00:00">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ren-zhi-jue-xing/" title="认知觉醒"><img src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/loading.gif" data-lazy-src="https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/ArticleCover/172.webp" onerror="this.onerror=null;this.src='https://mofan-blog-pics.oss-cn-chengdu.aliyuncs.com/myblog/404.jpg'" alt="认知觉醒"/></a><div class="content"><a class="title" href="/posts/ren-zhi-jue-xing/" title="认知觉醒">认知觉醒</a><time datetime="2025-12-28T16:00:00.000Z" title="更新于 2025-12-29 00:00:00">2025-12-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2026 By 默烦</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://testingcf.jsdelivr.net/npm/vanilla-lazyload@latest/dist/lazyload.iife.min.js"></script><script src="https://testingcf.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://testingcf.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (false) {
      await btf.getScript('https://testingcf.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://gcore.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://testingcf.jsdelivr.net/gh/mofan212/blog-static-resources@master/js/mine.min.js"></script><script src="/js/tip_portal.js"></script><script defer="defer" id="ribbon" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script id="click-show-text" src="https://testingcf.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Azathoth,Yog-Sothoth,Shub-Niggurath,Nyarlathotep,Cthulhu,Hastur,Abhoth,Ghroth,Tsathoggua,Cthugha,Deep Ones,Dagon,Chaugnar Faugn,Mordiggian,Shoggoth,Old One,Mi-Go,Great Race of Yith,Flying Polyp,Hounds of Tindalos,Dhole" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://testingcf.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: 'BAFEL7A6K1',
    apiKey: '89fcb5961984c5c054bf04149f345f38',
    indexName: 'mofan212io',
    container: '#docsearch',
    placeholder: '输入关键字进行搜索',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>